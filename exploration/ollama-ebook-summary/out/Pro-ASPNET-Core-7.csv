filename,title,text,len
01-Praises from reviewers of Pro ASP.NET Core 7 Tenth Edition.pdf,01-Praises from reviewers of Pro ASP.NET Core 7 Tenth Edition,"MANNINGAdam FreemanTENTH EDITION\nPraises from reviewers of Pro ASP .NET Core 7, Tenth Edition\nIf you’re looking for breadth and depth coverage of ASP.NET Core development, this is the book for you.\n—Greg White, Software Development Manager, PicoBrew , Inc.\nA must have book for the .NET developer/engineer.\n—Foster Haines, Consultant, Foster’s Website Company\nThe book for web development professionals.\n—Renato Gentile, Solutions Architect, S3K S.p.A.\nThis book guides you as a beginner and will remain your for-ever reference book. \n—Werner Nindl, Partner, Nova Advisory\nAn encyclopedic journey.\n—Richard Young, IT Director, Design Synthesis, Inc\nFrom tiny throw-away sites to large production websites, this book teaches all you need to know.\n—Samuel Bosch, Team Lead, ILVO\nBy the end of this book you should be able to write code for real-world projects.\n—Rich Yonts, Senior Software Engineer, Teradata\nMANNING\nShelter  ISlandPro ASP.NET Core 7\nADAM FREEMANTenth Edition\nFor online information and ordering of this and other Manning books, please visit www.manning.com. \nThe publisher offers discounts on this book when ordered in quantity.\nFor more information, please contact\nSpecial Sales Department\nManning Publications Co.\n20 Baldwin Road\nPO Box 761\nShelter Island, NY 11964\nEmail: orders@manning.com\n©2023 Adam Freeman. All rights reserved.\nNo part of this publication may be reproduced, stored in a retrieval system, or transmitted, in any form \nor by means electronic, mechanical, photocopying, or otherwise, without prior written permission of the \npublisher.\nMany of the designations used by manufacturers and sellers to distinguish their products are claimed \nas trademarks. Where those designations appear in the book, and Manning Publications was aware of a \ntrademark claim, the designations have been printed in initial caps or all caps.\nRecognizing the importance of preserving what has been written, it is Manning’s policy to have the books \nwe publish printed on acid-  free paper, and we exert our best efforts to that end. Recognizing also our \nresponsibility to conserve the resources of our planet, Manning books are printed on paper that is at \nleast 15 percent recycled and processed without the use of elemental chlorine.∞\n Manning Publications Co. \n20 Baldwin Road\nPO Box 761 \nShelter Island, NY 11964\nISBN 9781633437821\nPrinted in the United States of AmericaThe author and publisher have made every effort to ensure that the information in this book was correct \nat press time. The author and publisher do not assume and hereby disclaim any liability to any party for \nany loss, damage, or disruption caused by errors or omissions, whether such errors or omissions result \nfrom negligence, accident, or any other cause, or from any usage of the information herein.\n Development editor:  Marina Michaels\n Technical editor:  Fabio Ferracchiati\n Production editor:  Aleksandar Dragosavljevi Ê\n Copy editor:  Katie Petito\n Typesetter:  Tamara Šveli Ê Sablji Ê\n Cover designer:  Marija Tudor",3071
02-dedication.pdf,02-dedication,"Dedicated to my lovely wife, Jacqui Griffyth. \n(And also to Peanut.)",69
03-contents.pdf,03-contents,"viicontents\npreface  xxvii\nabout this book  xxix\nabout the author  xxxi\nabout the cover illustration  xxxii\n 1 Putting ASP.NET Core in context  1\n 1.1 Understanding the application frameworks  3\nUnderstanding the MVC Framework  3  ■  Understanding \nRazor Pages  4  ■  Understanding Blazor  4  ■  Understanding \nthe utility frameworks  5  ■  Understanding the ASP.NET Core \nplatform  5\n 1.2 Understanding this book  6\nWhat software do I need to follow the examples?  6  ■  What \nplatform do I need to follow the examples?  6  ■  What if I have \nproblems following the examples?  6  ■  What if I find an error in \nthe book?  7  ■  What does this book cover?  7  ■  What doesn’t this \nbook cover?  8  ■  How do I contact the author?  8  ■  What if I \nreally enjoyed this book?  9  ■  What if this book has made me angry \nand I want to complain?  9\n  Summary  9\nviiiviii contents\nPart 1....  .....................................................................11\n 2 Getting started  13\n 2.1 Choosing a code editor  13\nInstalling Visual Studio  14  ■  Installing Visual Studio \nCode  16\n 2.2 Creating an ASP.NET Core project  19\nOpening the project using Visual Studio  20  ■  Opening the \nproject with Visual Studio Code  21\n 2.3 Running the ASP.NET Core application  22\nUnderstanding endpoints  23  ■  Understanding routes  25 \nUnderstanding HTML rendering  25  ■  Putting the pieces \ntogether  30\n  Summary  30\n 3 Your first ASP.NET Core application  31\n 3.1 Setting the scene  31\n 3.2 Creating the project  32\nPreparing the project  32  ■  Adding a data model  34 \nCreating a second action and view  35  ■  Linking action \nmethods  37  ■  Building the form  38  ■  Receiving form \ndata 39  ■  Adding the thanks view  42  ■  Displaying \nresponses  44  ■  Adding validation  46  ■  Styling the \ncontent  51\n  Summary  57\n 4 Using the development tools  58\n 4.1 Creating ASP.NET Core projects  59\nCreating a project using the command line  59\n 4.2 Adding code and content to projects  62\nUnderstanding item scaffolding  64\n 4.3 Building and running projects  64\nUsing the hot reload feature  66\n 4.4 Managing packages  68\nManaging NuGet packages  68  ■  Managing tool packages  69 \nManaging client-side packages  69\n 4.5 Debugging projects  71\n  Summary  72\n ix contents  ix\n 5 Essential C# features  73\n 5.1 Preparing for this chapter  74\nOpening the project  75  ■  Enabling the MVC Framework  75 \nCreating the application components  75  ■  Selecting the HTTP \nport 77  ■  Running the example application  78\n 5.2 Understanding top-level statements  78\n 5.3 Understanding global using statements  79\nUnderstanding implicit using statements  80\n 5.4 Understanding null state analysis  81\nEnsuring fields and properties are assigned values  82 \nProviding a default value for non-nullable types  84 \nUsing nullable types  84  ■  Checking for null values  86 \nOverriding null state analysis  89  ■  Disabling null state \nanalysis warnings  89\n 5.5 Using string interpolation  90\n 5.6 Using object and collection initializers  90\nUsing an index initializer  92\n 5.7 Using target-typed new expressions  93\n 5.8 Pattern Matching  94\nPattern matching in switch statements  94\n 5.9 Using extension methods  95\nApplying extension methods to an interface  97 \nCreating filtering extension methods  99\n 5.10 Using lambda expressions  100\nDefining functions  102  ■  Using lambda expression methods and \nproperties  105\n 5.11 Using type inference and anonymous types  107\nUsing anonymous types  107\n 5.12 Using default implementations in interfaces  109\n 5.13 Using asynchronous methods  111\nWorking with tasks directly  111  ■  Applying the async and await \nkeywords  112  ■  Using an asynchronous enumerable  114\n 5.14 Getting names  117\n  Summary  118\nx contents x\n 6 Testing ASP.NET Core applications  119\n 6.1 Preparing for this chapter  120\nOpening the project  121  ■  Selecting the HTTP port  121 \nEnabling the MVC Framework  122  ■  Creating the application \ncomponents  122  ■  Running the example application  124\n 6.2 Creating a unit test project  124\n 6.3 Writing and running unit tests  125\nRunning tests with the Visual Studio Test Explorer  127 \nRunning tests with Visual Studio Code  128  ■  Running tests \nfrom the command line  128  ■  Correcting the unit test  129 \nIsolating components for unit testing  130  ■  Using a mocking \npackage  135  ■  Creating a mock object  135\n  Summary  137\n 7 SportsStore: A real application  138\n 7.1 Creating the projects  139\nCreating the unit test project  140  ■  Opening the projects  140 \nConfiguring the HTTP port  140  ■  Creating the application \nproject folders  141  ■  Preparing the services and the request \npipeline  142  ■  Configuring the Razor view engine  143 \nCreating the controller and view  144  ■  Starting the data \nmodel  144  ■  Checking and running the application  145\n 7.2 Adding data to the application  145\nInstalling the Entity Framework Core packages  146  ■  Defining \nthe connection string  146  ■  Creating the database context \nclass 147  ■  Configuring Entity Framework Core  148  \n■  Creating a repository  148  ■  Creating the database \nmigration  151  ■  Creating seed data  151\n 7.3 Displaying a list of products  154\nPreparing the controller  154  ■  Updating the view  156 \nRunning the application  157\n 7.4 Adding pagination  157\nDisplaying page links  159  ■  Improving the URLs  167\n 7.5 Styling the content  169\nInstalling the Bootstrap package  169  ■  Applying Bootstrap \nstyles 169  ■  Creating a partial view  172\n  Summary  174\n xi contents  xi\n 8 SportsStore: Navigation and cart  175\n 8.1 Adding navigation controls  175\nFiltering the product list  176  ■  Refining the URL scheme  180 \nBuilding a category navigation menu  184  ■  Correcting the page \ncount  191\n 8.2 Building the shopping cart  194\nConfiguring Razor Pages  194  ■  Creating a Razor Page  196 \nCreating the Add to Cart buttons  197  ■  Enabling sessions  199 \nImplementing the cart feature  200\n  Summary  210\n 9 SportsStore: Completing the cart  211\n 9.1 Refining the cart model with a service  211\nCreating a storage-aware cart class  212  ■  Registering the \nservice  214  ■  Simplifying the cart Razor Page  215\n 9.2 Completing the cart functionality  217\nRemoving items from the cart  217  ■  Adding the cart summary \nwidget  220\n 9.3 Submitting orders  223\nCreating the model class  223  ■  Adding the checkout \nprocess  224  ■  Creating the controller and view  225    \nImplementing order processing  227  ■  Completing the order \ncontroller  230  ■  Displaying validation errors  234     \nDisplaying a summary page  236\n  Summary  237\n 10 SportsStore: Administration  238\n 10.1 Preparing Blazor Server  239\nCreating the imports file  240  ■  Creating the startup Razor \nPage 240  ■  Creating the routing and layout components  241 \nCreating the Razor Components  242  ■  Checking the Blazor \nsetup  242\n 10.2 Managing orders  243\nEnhancing the model  244  ■  Displaying orders to the \nadministrator  245\n 10.3 Adding catalog management  249\nExpanding the repository  249  ■  Applying validation attributes \nto the data model  250  ■  Creating the list component  251\nxii contents xii\nCreating the detail component  253  ■  Creating the editor \ncomponent  254  ■  Deleting products  257\n  Summary  259\n 11 SportsStore: Security and deployment  260\n 11.1 Creating the Identity database  261\nInstalling the Identity package for Entity Framework Core  261 \nCreating the context class  261  ■  Defining the connection \nstring  262  ■  Configuring the application  262  ■  Creating \nand applying the database migration  264  ■  Defining the seed \ndata  264\n 11.2 Adding a conventional administration feature  267\n 11.3 Applying a basic authorization policy  268\n 11.4 Creating the account controller and views  269\n 11.5 Testing the security policy  273\n 11.6 Preparing ASP.NET Core for deployment  274\nConfiguring error handling  274  ■  Creating the production \nconfiguration settings  276  ■  Creating the Docker image  277 \nRunning the containerized application  280\n  Summary  281\nPart 2...  .................................................................... 283\n 12 Understanding the ASP.NET Core platform  285\n 12.1 Preparing for this chapter  286\nRunning the example application  288\n 12.2 Understanding the ASP.NET Core platform  288\nUnderstanding middleware and the request pipeline  288 \nUnderstanding services  289\n 12.3 Understanding the ASP.NET Core project  289\nUnderstanding the entry point  291  ■  Understanding the project \nfile 292\n 12.4 Creating custom middleware  293\nDefining middleware using a class  297  ■  Understanding \nthe return pipeline path  299  ■  Short-Circuiting the request \npipeline  300  ■  Creating pipeline branches  302 \nCreating terminal middleware  304\n xiii contents  xiii\n 12.5 Configuring middleware  306\nUsing the options pattern with class-based middleware  308\n  Summary  310\n 13 Using URL routing  311\n 13.1 Preparing for this chapter  312\nUnderstanding URL routing  315  ■  Adding the routing \nmiddleware and defining an endpoint  316  ■  Simplifying \nthe pipeline configuration  319  ■  Understanding URL \npatterns  321  ■  Using segment variables in URL patterns  322  \nGenerating URLs from routes  326\n 13.2 Managing URL matching  330\nMatching multiple values from a single URL segment  330 \nUsing default values for segment variables  331  ■  Using optional \nsegments in a URL Pattern  333  ■  Using a catchall segment \nvariable  334  ■  Constraining segment matching  336 \nDefining fallback routes  340\n 13.3 Advanced routing features  341\nCreating custom constraints  341  ■  Avoiding ambiguous route \nexceptions  342  ■  Accessing the endpoint in a middleware \ncomponent  344\n  Summary  347\n 14 Using dependency injection  348\n 14.1 Preparing for this chapter  350\nCreating a middleware component and an endpoint  350 \nConfiguring the request pipeline  351\n 14.2 Understanding service location and tight \ncoupling  352\nUnderstanding the service location problem  353 \nUnderstanding the tightly coupled components problem  355\n 14.3 Using dependency injection  357\nUsing a Service with a Constructor Dependency  359 \nGetting services from the HttpContext object  360\n 14.4 Using Service Lifecycles  364\nCreating transient services  365  ■  Avoiding the transient service \nreuse pitfall  366  ■  Using scoped services  369\nxiv contents xiv\n 14.5 Other dependency injection features  374\nCreating dependency chains  374  ■  Accessing services in the \nProgram.cs file  376  ■  Using service factory functions  377 \nCreating services with multiple implementations  379 \nUsing unbound types in services  381\n  Summary  383\n 15 Using the platform features, part 1  384\n 15.1 Preparing for this chapter  385\n 15.2 Using the configuration service  387\nUnderstanding the environment configuration file  387 \nAccessing configuration settings  388  ■  Using the configuration \ndata in the Program.cs file  390  ■  Using configuration data with \nthe options pattern  390  ■  Understanding the launch settings \nfile  392  ■  Using the environment service  397  ■  Storing user \nsecrets  398\n 15.3 Using the logging service  401\nGenerating logging messages  401  ■  Logging messages with \nattributes  405  ■  Configuring minimum logging levels  407 \nLogging HTTP requests and responses  409\n 15.4 Using static content and client-side packages  411\nAdding the static content middleware  412  ■  Using client-side \npackages  415\n  Summary  417\n 16 Using the platform features, part 2  418\n 16.1 Preparing for this chapter  419\n 16.2 Using cookies  420\nEnabling cookie consent checking  422  ■  Managing cookie \nconsent  424\n 16.3 Using sessions  426\nConfiguring the session service and middleware  426 \nUsing session data  429\n 16.4 Working with HTTPS connections  431\nEnabling HTTPS connections  431  ■  Detecting HTTPS \nrequests  433  ■  Enforcing HTTPS requests  434 \nEnabling HTTP strict transport security  435\n 16.5 Using rate limits  437\n xv contents  xv\n 16.6 Handling exceptions and errors  441\nReturning an HTML error response  442  ■  Enriching status code \nresponses  444\n 16.7 Filtering requests using the host header  446\n  Summary  449\n 17 Working with data  450\n 17.1 Preparing for this chapter  452\n 17.2 Caching data  452\nCaching data values  454  ■  Using a shared and persistent data \ncache  457\n 17.3 Caching responses  461\n 17.4 Caching output  464\nDefining a custom cache policy  467\n 17.5 Using Entity Framework Core  469\nInstalling Entity Framework Core  469  ■  Creating the data \nmodel  470  ■  Configuring the database service  471 \nCreating and applying the database migration  473  ■  Seeding \nthe database  473  ■  Using data in an endpoint  476\n  Summary  479\nPart 3...  .................................................................... 481\n 18 Creating the example project  483\n 18.1 Creating the project  484\n 18.2 Adding a data model  485\nAdding NuGet packages to the project  485  ■  Creating the data \nmodel  485  ■  Preparing the seed data  487  ■  Configuring EF \nCore services and middleware  488  ■  Creating and applying the \nmigration  489\n 18.3 Adding the CSS framework  490\n 18.4 Configuring the request pipeline  490\n 18.5 Running the example application  491\n 19 Creating RESTful web services  492\n 19.1 Preparing for this chapter  493\nxvi contents xvi\n 19.2 Understanding RESTful web services  494\nUnderstanding request URLs and methods  494 \nUnderstanding JSON  495\n 19.3 Creating a web service using the minimal API  496\n 19.4 Creating a web service using a controller  498\nEnabling the MVC Framework  499  ■  Creating a \ncontroller  500\n 19.5 Improving the web service  510\nUsing asynchronous actions  511  ■  Preventing over-\nbinding  512  ■  Using action results  514  ■  Validating \ndata  519  ■  Applying the API controller attribute  521  \nOmitting Null properties  523  ■  Applying a rate limit  526\n  Summary  529\n 20 Advanced web service features  530\n 20.1 Preparing for this chapter  531\nDropping the database  532  ■  Running the example \napplication  532\n 20.2 Dealing with related data  533\nBreaking circular references in related data  535\n 20.3 Supporting the HTTP PATCH method  536\nUnderstanding JSON Patch  536  ■  Installing and configuring  \nthe JSON Patch package  537  ■  Defining the action  \nmethod  538\n 20.4 Understanding content formatting  540\nUnderstanding the default content policy  540  ■  Understanding \ncontent negotiation  542  ■  Specifying an action result \nformat  547  ■  Requesting a format in the URL  548    \nRestricting the formats received by an action method  549    \nCaching output  551\n 20.5 Documenting and exploring web services  553\nResolving action conflicts  553  ■  Installing and configuring \nthe Swashbuckle package  554  ■  Fine-Tuning the API \ndescription  556\n  Summary  560\n xvii contents  xvii\n 21 Using controllers with views, part I  561\n 21.1 Preparing for this chapter  562\nDropping the database  563  ■  Running the example \napplication  563\n 21.2 Getting started with views  564\nConfiguring the application  564  ■  Creating an HTML \ncontroller  565  ■  Creating a Razor View  568  ■  Selecting a \nView by name  571\n 21.3 Working with Razor Views  575\nSetting the view model type  578  ■  Understanding the view model \ntype pitfall  584\n 21.4 Understanding the Razor syntax  587\nUnderstanding directives  587  ■  Understanding content \nexpressions  588  ■  Setting element content  589  ■  Setting \nattribute values  590  ■  Using conditional expressions  591 \nEnumerating sequences  594  ■  Using Razor code blocks  596\n  Summary  598\n 22 Using controllers with views, part II  599\n 22.1 Preparing for this chapter  600\nDropping the database  601  ■  Running the example \napplication  601\n 22.2 Using the view bag  602\n 22.3 Using temp data  604\n 22.4 Working with layouts  607\nConfiguring layouts using the view bag  609  ■  Using a view start \nfile  610  ■  Overriding the default layout  612  ■  Using layout \nsections  615\n 22.5 Using partial views  622\nEnabling partial views  622  ■  Creating a partial view  622 \nApplying a partial view  623\n 22.6 Understanding content-encoding  625\nUnderstanding HTML encoding  626  ■  Understanding JSON \nencoding  628\n  Summary  629\nxviii contents xviii\n 23 Using Razor Pages  630\n 23.1 Preparing for this chapter  632\nRunning the example application  632\n 23.2 Understanding Razor Pages  633\nConfiguring Razor Pages  633  ■  Creating a Razor Page  634\n 23.3 Understanding Razor Pages routing  639\nSpecifying a routing pattern in a Razor Page  640 \nAdding routes for a Razor Page  642\n 23.4 Understanding the Page model class  644\nUsing a code-behind class file  644  ■  Understanding action \nresults in Razor Pages  647  ■  Handling multiple HTTP \nmethods  651  ■  Selecting a handler method  653\n 23.5 Understanding the Razor Page view  656\nCreating a layout for Razor Pages  656  ■  Using partial views \nin Razor Pages  658  ■  Creating Razor Pages without page \nmodels  659\n  Summary  661\n 24 Using view components  662\n 24.1 Preparing for this chapter  663\nDropping the database  666  ■  Running the example \napplication  666\n 24.2 Understanding view components  667\n 24.3 Creating and using a view component  667\nApplying a view component  668\n 24.4 Understanding view component results  671\nReturning a partial view  672  ■  Returning HTML \nfragments  675\n 24.5 Getting context data  678\nProviding context from the parent view using arguments  679 \nCreating asynchronous view components  683\n 24.6 Creating view components classes  685\nCreating a hybrid controller class  688\n  Summary  690\n xix contents  xix\n 25 Using tag helpers  691\n 25.1 Preparing for this chapter  692\nDropping the database  694  ■  Running the example \napplication  694\n 25.2 Creating a tag helper  695\nDefining the tag helper class  695  ■  Registering tag helpers  698 \nUsing a tag helper  698  ■  Narrowing the scope of a tag \nhelper  700  ■  Widening the scope of a tag helper  701\n 25.3 Advanced tag helper features  703\nCreating shorthand elements  703  ■  Creating elements \nprogrammatically  706  ■  Prepending and appending content \nand elements  707  ■  Getting view context data  710  ■  Working \nwith model expressions  712  ■  Coordinating between tag \nhelpers  718  ■  Suppressing the output element  720\n 25.4 Using tag helper components  721\nCreating a tag helper component  721  ■  Expanding tag helper \ncomponent element selection  723\n  Summary  725\n 26 Using the built-in tag helpers  726\n 26.1 Preparing for this chapter  727\nAdding an image file  729  ■  Installing a client-side \npackage  729  ■  Dropping the database  730  ■  Running the \nexample application  730\n 26.2 Enabling the built-in tag helpers  730\n 26.3 Transforming anchor elements  731\nUsing anchor elements for Razor Pages  733\n 26.4 Using the JavaScript and CSS tag helpers  735\nManaging JavaScript files  735  ■  Managing CSS \nstylesheets  743\n 26.5 Working with image elements  746\n 26.6 Using the data cache  748\nSetting cache expiry  750\n 26.7 Using the hosting environment tag helper  753\n  Summary  754\nxx contents xx\n 27 Using the forms tag helpers  755\n 27.1 Preparing for this chapter  756\nDropping the database  758  ■  Running the example \napplication  758\n 27.2 Understanding the form handling pattern  758\nCreating a controller to handle forms  759  ■  Creating a Razor \nPage to handle forms  761\n 27.3 Using tag helpers to improve HTML forms  764\nWorking with form elements  764  ■  Transforming form \nbuttons  766\n 27.4 Working with input elements  767\nTransforming the input element type attribute  769  ■  Formatting \ninput element values  771  ■  Displaying values from related data \nin input elements  775\n 27.5 Working with label elements  779\n 27.6 Working with select and option elements  781\nPopulating a select element  783\n 27.7 Working with text areas  785\n 27.8 Using the anti-forgery feature  787\nEnabling the anti-forgery feature in a controller  789  ■  Enabling \nthe anti-forgery feature in a Razor Page  790  ■  Using anti-forgery \ntokens with JavaScript clients  790\n 28 Using model binding  794\n 28.1 Preparing for this chapter  796\nDropping the database  797  ■  Running the example \napplication  797\n 28.2 Understanding model binding  797\n 28.3 Binding simple data types  799\nBinding simple data types in Razor Pages  800  ■  Understanding \ndefault binding values  802\n 28.4 Binding complex types  805\nBinding to a property  807  ■  Binding nested complex \ntypes  809  ■  Selectively binding properties  813\n 28.5 Binding to arrays and collections  816\nBinding to arrays  816  ■  Binding to simple collections  820\n xxi contents  xxi\nBinding to dictionaries  820  ■  Binding to collections of complex \ntypes 822\n 28.6 Specifying a model binding source  824\nSelecting a binding source for a property  827  ■  Using headers \nfor model binding  827  ■  Using request bodies as binding \nsources  829\n 28.7 Manual model binding  830\n 29 Using model validation  833\n 29.1 Preparing for this chapter  835\nDropping the database  836  ■  Running the example \napplication  836\n 29.2 Understanding the need for model validation  837\n 29.3 Validating data  837\nDisplaying validation messages  841  ■  Understanding \nthe implicit validation checks   843  ■  Performing explicit \nvalidation  844  ■  Configuring the default validation \nerror messages  847  ■  Displaying property-level validation \nmessages  850  ■  Displaying model-level messages  851\n 29.4 Explicitly validating data in a Razor Page  854\n 29.5 Specifying validation rules using metadata  857\nCreating a custom property validation attribute  861 \nCreating a custom model validation attribute  862\n 29.6 Performing client-side validation  866\n 29.7 Performing remote validation  869\nPerforming remote validation in Razor Pages  872\n 30 Using filters  875\n 30.1 Preparing for this chapter  876\nEnabling HTTPS Connections  878  ■  Dropping the \ndatabase  879  ■  Running the example application  880\n 30.2 Using filters  880\n 30.3 Understanding filters  885\n 30.4 Creating custom filters  887\nUnderstanding authorization filters  887  ■  Understanding \nresource filters  890  ■  Understanding action filters  894 \nxxii contents xxii\nUnderstanding page filters  899  ■  Understanding result \nfilters  903  ■  Understanding exception filters  908  ■  Creating \nan exception filter  909\n 30.5 Managing the filter lifecycle  911\nCreating filter factories  913  ■  Using dependency injection scopes \nto manage filter lifecycles  915\n 30.6 Creating global filters  916\n 30.7 Understanding and changing filter order  918\n 31 Creating form applications  924\n 31.1 Preparing for this chapter  924\nDropping the database  928  ■  Running the example \napplication  928\n 31.2 Creating an MVC forms application  928\nPreparing the view model and the view  928  ■  Reading \ndata 931  ■  Creating data  933  ■  Editing data  936    \nDeleting data  939\n 31.3 Creating a Razor Pages forms application  940\nCreating common functionality  942  ■  Defining pages for the \nCRUD operations  945\n 31.4 Creating new related data objects  948\nProviding the related data in the same request  948 \nBreaking out to create new data  952\nPart 4....  ................................................................... 959\n 32 Creating the example project  961\n 32.1 Creating the project  962\nAdding NuGet packages to the project  963\n 32.2 Adding a data model  963\nPreparing the seed data  965  ■  Configuring Entity Framework \nCore  966  ■  Creating and applying the migration  967\n 32.3 Adding the Bootstrap CSS framework  967\n 32.4 Configuring the services and middleware  968\n 32.5 Creating a controller and view  969\n 32.6 Creating a Razor Page  971\n 32.7 Running the example application  973\n xxiii contents  xxiii\n 33 Using Blazor Server, part 1  974\n 33.1 Preparing for this chapter  976\n 33.2 Understanding Blazor Server  976\nUnderstanding the Blazor Server advantages  978 \nUnderstanding the Blazor Server disadvantages  978 \nChoosing between Blazor Server and Angular/React/Vue.js  978\n 33.3 Getting started with Blazor  978\nConfiguring ASP.NET Core for Blazor Server  979 \nCreating a Razor Component  981\n 33.4 Understanding the basic Razor Component \nfeatures  986\nUnderstanding Blazor events and data bindings  986 \nWorking with data bindings  994\n 33.5 Using class files to define components  1000\nUsing a code-behind class  1000  ■  Defining a Razor Component \nclass 1002\n 34 Using Blazor Server, part 2  1004\n 34.1 Preparing for this chapter  1005\n 34.2 Combining components  1006\nConfiguring components with attributes  1008  ■  Creating custom \nevents and bindings  1012\n 34.3 Displaying child content in a component  1017\nCreating template components  1019  ■  Using generic type \nparameters in template components  1022  ■  Cascading \nparameters  1028\n 34.4 Handling errors  1031\nHandling connection errors  1031  ■  Handling uncaught \napplication errors  1034  ■  Using error boundaries  1036\n 35 Advanced Blazor features  1042\n 35.1 Preparing for this chapter  1044\n 35.2 Using component routing  1044\nPreparing the Razor Page  1045  ■  Adding routes \nto components  1047  ■  Navigating between routed \nxxiv contents xxiv\ncomponents  1050  ■  Receiving routing data  1053 \nDefining common content using layouts  1055\n 35.3 Understanding the component lifecycle methods  1057\nUsing the lifecycle methods for asynchronous tasks  1060\n 35.4 Managing component interaction  1062\nUsing references to child components  1062  ■  Interacting with \ncomponents from other code  1065  ■  Interacting with components \nusing JavaScript  1070\n 36 Blazor forms and data  1080\n 36.1 Preparing for this chapter  1081\nDropping the database and running the application  1085\n 36.2 Using the Blazor form components  1085\nCreating custom form components  1088  ■  Validating form \ndata 1092  ■  Handling form events  1096\n 36.3 Using Entity Framework Core with Blazor  1098\nUnderstanding the EF Core context scope issue  1098 \nUnderstanding the repeated query issue  1103\n 36.4 Performing CRUD operations  1109\nCreating the list component  1110  ■  Creating the details \ncomponent  1111  ■  Creating the editor component  1113\n 36.5 Extending the Blazor form features  1115\nCreating a custom validation constraint  1116 \nCreating a valid-only submit button component  1119\n 37 Using Blazor WebAssembly  1122\n 37.1 Preparing for this chapter  1123\nDropping the database and running the application  1125\n 37.2 Setting Up Blazor WebAssembly  1126\nCreating the shared project  1126  ■  Creating the Blazor \nWebAssembly project  1126  ■  Preparing the ASP.NET Core \nproject  1127  ■  Adding the solution references  1127 \nOpening the projects  1127  ■  Completing the Blazor \nWebAssembly configuration  1128  ■  Testing the placeholder \ncomponents  1130\n 37.3 Creating a Blazor WebAssembly component  1131\n xxv contents  xxv\nImporting the data model namespace  1131  ■  Creating a \ncomponent  1131  ■  Creating a layout  1136  ■  Defining CSS \nstyles 1137\n 37.4 Completing the Blazor WebAssembly Form \napplication  1138\nCreating the details component  1138  ■  Creating the editor \ncomponent  1139\n 38 Using ASP.NET Core Identity  1143\n 38.1 Preparing for this chapter  1144\n 38.2 Preparing the project for ASP.NET Core Identity   1145\nPreparing the ASP.NET Core Identity database  1146 \nConfiguring the application  1147  ■  Creating and applying the \nIdentity database migration  1148\n 38.3 Creating user management tools  1148\nPreparing for user management tools  1150  ■  Enumerating user \naccounts  1151  ■  Creating users  1152  ■  Editing users  1160 \nDeleting users  1162\n 38.4 Creating role management tools  1163\nPreparing for role management tools  1165  ■  Enumerating and \ndeleting roles  1165  ■  Creating roles  1167  ■  Assigning role \nmembership  1168\n 39 Applying ASP.NET Core Identity  1172\n 39.1 Preparing for this chapter  1173\n 39.2 Authenticating users  1174\nCreating the login feature  1175  ■  Inspecting the ASP.NET Core \nIdentity cookie  1177  ■  Creating a Sign-Out page  1178 \nTesting the authentication feature  1179  ■  Enabling the Identity \nauthentication middleware  1179\n 39.3 Authorizing access to endpoints  1183\nApplying the authorization attribute  1183  ■  Enabling the \nauthorization middleware  1184  ■  Creating the access denied \nendpoint  1184  ■  Creating the seed data  1185  ■  Testing the \nauthentication sequence  1187\n 39.4 Authorizing access to Blazor applications  1188\nPerforming authorization in Blazor components  1190 \nDisplaying content to authorized users  1192\nxxvi contents xxvi\n 39.5 Authenticating and authorizing web services  1194\nBuilding a simple JavaScript client  1196  ■  Restricting access to \nthe web service  1198  ■  Using cookie authentication  1199 \nUsing bearer token authentication  1202  ■  Creating \ntokens  1203  ■  Authenticating with tokens  1206  ■  Restricting \naccess with tokens  1208  ■  Using tokens to request data  1208\n  index  1211",29586
04-preface.pdf,04-preface,"xxviipreface\nThis is the 49th book I have written. I wrote my first book in 1996, and I would \nnot have believed anyone who told me that I would still be writing over a quar-\nter of a century later, or that books would become such an important part of \nmy life. \nI have a bookshelf on which I keep every book I have written. It is an act of \npure self-indulgence, but I am proud of these books and what they represent. \nThey span 2.5 meters on a single shelf (or 8 feet if you prefer) and they mark \nthe chapters of my life: the book I wrote the year I married my beloved wife; the \nbook I was writing when my father died; the book I finished while we moved \nhouse; the book I wrote after I retired. Each book reminds me of people and \nplaces going back 27 years.\nOf all the books I have written, Pro ASP.NET Core is my favourite. This is the \n10th edition, but I almost didn’t write it at all. I had already written a book about \nASP.NET Web Forms and found it to be a frustrating process, so I wasn’t keen \nto write about the MVC framework and Microsoft’s attempt to modernize their \nweb development products. My wife persuaded me to accept the publisher’s \noffer and I have never looked back. ASP.NET has evolved into ASP.NET Core, \nand each edition of this book has been a little bigger and a little more detailed. \nThis is a big and complicated book because ASP.NET Core is big and com-\nplicated. But I put a lot of effort into writing books that are easy to follow, even \nif the topics can be difficult to understand. As I write this preface and I think of \nyou, my future reader, my hope is that the book you hold in your hand helps you \nxxviii preface xxviii\nwith your career, makes your project easier to implement, or helps you move \ninto a new and more exciting role. \nThere is something unique about receiving the first copies of a book, fresh \nfrom the printers. The process of getting a book into print takes just enough \ntime for it to be a surprise when the box arrives at the door. Writing is an abstract \nprocess and writing about software especially so. The finished book feels like an \nidea made real. These days, ebooks are more popular and more convenient, \nbut my heart will always beat with joy for the printed version. As you hold this \nbook, I hope you feel some of that joy, and that this book plays some small part \nin helping you achieve something you will be proud of, whatever that may be.",2453
05-about this book.pdf,05-about this book,,0
06-Who should read this book.pdf,06-Who should read this book,,0
07-About the code.pdf,07-About the code,"xxixabout this book\nPro ASP.NET Core, Tenth Edition  was written to help you build web applications \nusing the latest version of .NET and ASP.NET Core. It begins with setting up \nthe development environment and creating a simple web application, before \nmoving on to creating a simple but realistic online store, and then diving into \nthe detail of important ASP.NET Core features.\nWho should read this book\nThis book is for experienced developers who are new to ASP.NET Core, or who \nare moving from an earlier version of ASP.NET, including legacy Web Forms. \nHow this book is organized: a roadmap\nThe book has four parts. The first part covers setting up the development envi-\nronment, creating a simple web application, and using the development tools. \nThere is also a primer on important C# features for readers who are moving \nfrom an earlier version of ASP.NET or ASP.NET Core. The rest of this part of \nthe book contains the SportsStore example application, which shows how to \ncreate a basic but functional online store, and demonstrates how the many dif-\nferent ASP.NET Core features work together.\nThe second part of the book describes the key features of the ASP.NET Core \nplatform. I explain how HTTP requests are processed, how to create and use \nmiddleware components, how to create routes, how to define and consume ser-\nvices, and how to work with Entity Framework Core. These chapters explain the",1434
08-1 Putting ASP.NET Core in context.pdf,08-1 Putting ASP.NET Core in context,"xxx about  this book xxx\nfoundations of ASP.NET Core, and understanding them is essential for effec-\ntive ASP.NET Core development.\nThe third part of the book focuses on the ASP.NET features you will need \nevery day, including HTTP request handling, creating RESTful web services, \ngenerating HTML responses, and receiving data from users. \nThe final part of this book describes advanced ASP.NET Core features, \nincluding using Blazor to create rich client-side applications, and using ASP.\nNET Core Identity to authenticate users.\nAbout the code \nThis book contains many examples of source code both in numbered listings \nand in line with normal text. In both cases, the source code is formatted in a \nfixed-width font to separate it from ordinary text. Code is also in bold to high-\nlight statements that have changed from previous listings.\nThe source code for every chapter in this book is available at https://github \n.com/manningbooks/pro-asp.net-core-7 . \nliveBook discussion forum\nPurchase of Pro ASP.NET Core 7, Tenth Edition  includes free access to liveBook, \nManning’s online reading platform. Using liveBook’s exclusive discussion fea-\ntures, you can attach comments to the book globally or to specific sections or \nparagraphs. It’s a snap to make notes for yourself, ask and answer technical \nquestions, and receive help from the author and other users. To access the \nforum, go to https://livebook.manning.com/book/pro-aspdotnet-core-7 \n-tenth-edition/discussion . You can also learn more about Manning’s forums \nand the rules of conduct at https://livebook.manning.com/discussion .\nManning’s commitment to our readers is to provide a venue where a mean-\ningful dialogue between individual readers and between readers and the author \ncan take place. It is not a commitment to any specific amount of participation \non the part of the author, whose contribution to the forum remains voluntary \n(and unpaid). We suggest you try asking the author some challenging questions \nlest his interest stray! The forum and the archives of previous discussions will be \naccessible from the publisher’s website as long as the book is in print.\nxxxiabout the author\nAdam Freeman  is an experienced IT professional \nwho started his career a programmer. He has held \nsenior positions in a range of companies, most \nrecently serving as Chief Technology Officer and \nChief Operating Officer of a global bank. He has \nwritten 49 programming books, focusing mostly \non web application development. Now retired, \nhe spends his time writing and trying to make \nfurniture. \nabout  the technical  editor\nFabio Claudio Ferracchiati is a senior consultant and a senior analyst/devel-\noper using Microsoft technologies. He works for TIM ( www.telecomitalia.it ). \nHe is a Microsoft Certified Solution Developer for .NET, a Microsoft Certified \nApplication Developer for .NET, a Microsoft Certified Professional, and a pro-\nlific author and technical reviewer. Over the past ten years, he’s written articles \nfor Italian and international magazines and coauthored more than ten books \non a variety of computer topics.\n\nxxxiiabout the cover illustration\nThe figure on the cover of Pro ASP.NET Core 7, Tenth Edition  is “Turc en habit \nd’hiver,” or “Turk in winter clothes,” taken from a collection by Jacques Grasset \nde Saint-Sauveur, published in 1788. Each illustration is finely drawn and col-\nored by hand. \nIn those days, it was easy to identify where people lived and what their trade \nor station in life was just by their dress. Manning celebrates the inventiveness \nand initiative of the computer business with book covers based on the rich \ndiversity of regional culture centuries ago, brought back to life by pictures from \ncollections such as this one.\n11Putting ASP.NET  \nCore in context\nThis chapter covers\n¡ Putting ASP.NET Core in context\n¡ Understanding the role of the ASP.NET Core  \n platform\n¡ Putting the ASP.NET Core application frame  \n works in context\n¡ Understanding the structure of this book\n¡ Getting support when something doesn’t work\nASP.NET Core is Microsoft’s web development platform. The original ASP.NET was \nintroduced in 2002, and it has been through several reinventions and reincarna-\ntions to become ASP.NET Core 7, which is the topic of this book. \nASP.NET Core consists of a platform for processing HTTP requests, a series of \nprincipal frameworks for creating applications, and secondary utility frameworks \nthat provide supporting features, as illustrated by figure 1.1. \n2 chapter  1 Putting ASP.NET Core in context \nFigure 1.1    The structure of ASP .NET Core \nUnderstanding .NET Core, .NET Framework, and .NET\nIf you have never worked for a large corporation, you might have the impression that \nMicrosoft is a disciplined organization with a clear strategy and an army of programmers \nworking together to deliver complex products like ASP.NET Core.\nIn reality, Microsoft is a chaotic collection of dysfunctional tribes that are constantly \ntrying to undermine each other to get prestige and promotions. Products are released \nduring lulls in the fighting, and successes are often entirely unexpected. This isn’t unique \nto Microsoft—it is true of any large company—but it has a particular bearing on ASP.NET \nCore and the naming confusion that Microsoft has created. \nSeveral years ago, the part of Microsoft responsible for ASP.NET created its own version \nof the .NET platform, allowing ASP.NET to be updated more often than the rest of .NET. \nASP.NET Core  and .NET Core  were created, allowing cross-platform development, and \nusing a subset of the original .NET APIs, many of which were specific to Windows. It was \na painful transition, but it meant that web development could evolve independently of \nthe “legacy” Windows-only development, which would continue under the renamed .NET \nFramework .\nBut no one wants to be in the “legacy” tribe because there is no glory in keeping the lights \non at Microsoft. .NET Core was clearly the future and, one by one, the.NET groups at Mic-\nrosoft argued that their technology and APIs should be part of .NET Core. The .NET Core \nAPIs were gradually expanded, and the result was an incoherent mess, with half-hearted \nattempts to differentiate .NET Core and .NET Framework and standardize the APIs.\nTo clean up the mess, Microsoft has merged .NET Core  and .NET Framework  into .NET , \ndropping the Core  part of the name. “.NET” is a name I like to think was chosen on the \nway out of the office on a holiday weekend but which I suspect is the result of many \nmonths of heated argument. \nThe problem with dropping Core  from the name is that it cannot be carried out consis-\ntently. The name ASP.NET Core  originally denoted the .NET Core version of ASP.NET, and \ngoing back to that name would be even more confusing.",6906
09-1.1 Understanding the application frameworks.pdf,09-1.1 Understanding the application frameworks,,0
10-1.1.2 Understanding Razor Pages.pdf,10-1.1.2 Understanding Razor Pages,"3 Understanding the application frameworks \n(continued)\nThe result is that even Microsoft can’t decide what name to use. You will see the term \nASP.NET Core  in a lot of the developer documentation—and that’s the name I use in this \nbook—but you will also see ASP.NET Core in .NET , especially in press releases and mar-\nketing material. It is not clear which name will win out, but until there is clarity, you should \ntake care to determine whether you are using .NET Framework, .NET Core, or .NET.\n1.1 Understanding the application frameworks \nWhen you start using ASP.NET Core, it can be confusing to find that there are differ-\nent application frameworks available. As you will learn, these frameworks are comple-\nmentary and solve different problems, or, for some features, solve the same problems \nin different ways. Understanding the relationship between these frameworks means \nunderstanding the changing design patterns that Microsoft has supported, as I explain \nin the sections that follow.  \n1.1.1 Understanding the MVC Framework \nThe MVC Framework was introduced in the early ASP.NET, long before .NET Core \nand the newer .NET were introduced. The original ASP.NET relied on a development \nmodel called Web Forms, which re-created the experience of writing desktop applica-\ntions but resulted in unwieldy web projects that did not scale well. The MVC Frame-\nwork was introduced alongside Web Forms with a development model that embraced \nthe character of HTTP and HTML, rather than trying to hide it. \nMVC stands for Model-View-Controller, which is a design pattern that describes the \nshape of an application. The MVC pattern emphasizes separation of concerns , where areas \nof functionality are defined independently, which was an effective antidote to the indis-\ntinct architectures that Web Forms led to.\nEarly versions of the MVC Framework were built on the ASP.NET foundations that \nwere originally designed for Web Forms, which led to some awkward features and work-\narounds. With the move to .NET Core, ASP.NET became ASP.NET Core, and the MVC \nFramework was rebuilt on an open, extensible, and cross-platform foundation. \nThe MVC Framework remains an important part of ASP.NET Core, but the way it is \ncommonly used has changed with the rise of single-page applications (SPAs). In an SPA, \nthe browser makes a single HTTP request and receives an HTML document that deliv-\ners a rich client, typically written in a JavaScript framework such as Angular or React. \nThe shift to SPAs means that the clean separation that the MVC Framework was origi-\nnally intended for is not as important, and the emphasis placed on following the MVC \npattern is no longer essential, even though the MVC Framework remains useful (and is \nused to support SPAs through web services, as described in chapter 19).",2847
11-1.1.4 Understanding the utility frameworks.pdf,11-1.1.4 Understanding the utility frameworks,"4 chapter  1 Putting ASP.NET Core in context \nPutting patterns in their place\nDesign patterns provoke strong reactions, as the emails I receive from readers will tes-\ntify. A substantial proportion of the messages I receive are complaints that I have not \napplied a pattern correctly.  \nPatterns are just other people’s solutions to the problems they encountered in other proj-\nects. If you find yourself facing the same problem, understanding how it has been solved \nbefore can be helpful. But that doesn’t mean you have to follow the pattern exactly, or \nat all, as long as you understand the consequences. If a pattern is intended to make \nprojects manageable, for example, and you choose to deviate from that pattern, then you \nmust accept that your project may be more difficult to manage. But a pattern followed \nslavishly can be worse than no pattern at all, and no pattern is suited to every project.\nMy advice is to use patterns freely, adapt them as necessary, and ignore zealots who \nconfuse patterns with commandments.\n1.1.2 Understanding Razor Pages\nOne drawback of the MVC Framework is that it can require a lot of preparatory work \nbefore an application can start producing content. Despite its structural problems, one \nadvantage of Web Forms was that simple applications could be created in a couple of \nhours.\nRazor Pages takes the development ethos of Web Forms and implements it using the \nplatform features originally developed for the MVC Framework. Code and content are \nmixed to form self-contained pages; this re-creates the speed of Web Forms develop-\nment without some of the underlying technical problems (although scaling up com-\nplex projects can still be an issue). \nRazor Pages can be used alongside the MVC Framework, which is how I tend to use \nthem. I write the main parts of the application using the MVC Framework and use Razor \nPages for the secondary features, such as administration and reporting tools. You can \nsee this approach in chapters 7–11, where I develop a realistic ASP.NET Core applica-\ntion called SportsStore.\n1.1.3 Understanding Blazor \nThe rise of JavaScript client-side frameworks can be a barrier for C# developers, who \nmust learn a different—and somewhat idiosyncratic—programming language. I have \ncome to love JavaScript, which is as fluid and expressive as C#. But it takes time and \ncommitment to become proficient in a new programming language, especially one \nthat has fundamental differences from C#.\nBlazor attempts to bridge this gap by allowing C# to be used to write client-side appli-\ncations. There are two versions of Blazor: Blazor Server and Blazor WebAssembly. Blazor \nServer relies on a persistent HTTP connection to the ASP.NET Core server, where the \napplication’s C# code is executed. Blazor WebAssembly goes one step further and exe-\ncutes the application’s C# code in the browser. Neither version of Blazor is suited for",2942
12-1.2 Understanding this book.pdf,12-1.2 Understanding this book,"5 Understanding the application frameworks \nall situations, as I explain in chapter 33, but they both give a sense of direction for the \nfuture of ASP.NET Core development.\n1.1.4 Understanding the utility frameworks \nTwo frameworks are closely associated with ASP.NET Core but are not used directly \nto generate HTML content or data. Entity Framework Core is Microsoft’s object-rela-\ntional mapping (ORM) framework, which represents data stored in a relational data-\nbase as .NET objects. Entity Framework Core can be used in any .NET application, and \nit is commonly used to access databases in ASP.NET Core applications. \nASP.NET Core Identity is Microsoft’s authentication and authorization framework, \nand it is used to validate user credentials in ASP.NET Core applications and restrict \naccess to application features. \nI describe only the basic features of both frameworks in this book, focusing on the \ncapabilities required by most ASP.NET Core applications. But these are both complex \nframeworks that are too large to describe in detail in what is already a large book about \nASP.NET Core. \nTopics for future editions\nI don’t have space in this book to cover every ASP.NET Core, Entity Framework Core, and \nASP.NET Core Identity feature, so I have focused on those aspects that most projects \nrequire. If there are topics you think I should include in the next edition or in new deep-\ndive books, then please send me your suggestions at adam@adam-freeman.com. \n1.1.5 Understanding the ASP .NET Core platform \nThe ASP.NET Core platform contains the low-level features required to receive and \nprocess HTTP requests and create responses. There is an integrated HTTP server, a \nsystem of middleware components to handle requests, and core features that the appli-\ncation frameworks depend on, such as URL routing and the Razor view engine.  \nMost of your development time will be spent with the application frameworks, but \neffective ASP.NET Core use requires an understanding of the powerful capabilities \nthat the platform provides, without which the higher-level frameworks could not func-\ntion. I demonstrate how the ASP.NET Core platform works in detail in part 2 of this \nbook and explain how the features it provides underpin every aspect of ASP.NET Core \ndevelopment.\nI have not described two notable platform features in this book: SignalR and gRPC. \nSignalR is used to create low-latency communication channels between applications. \nIt provides the foundation for the Blazor Server framework that I describe in part 4 of \nthis book, but SignalR is rarely used directly, and there are better alternatives for those \nfew projects that need low-latency messaging, such as Azure Event Grid or Azure Service \nBus.",2764
13-1.2.1 What software do I need to follow the examples.pdf,13-1.2.1 What software do I need to follow the examples,,0
14-1.2.2 What platform do I need to follow the examples.pdf,14-1.2.2 What platform do I need to follow the examples,,0
15-1.2.4 What if I find an error in the book.pdf,15-1.2.4 What if I find an error in the book,"6 chapter  1 Putting ASP.NET Core in context \ngRPC is an emerging standard for cross-platform remote procedure calls (RPCs) \nover HTTP that was originally created by Google (the g in gRPC) and offers efficiency \nand scalability benefits. gRPC may be the future standard for web services, but it cannot \nbe used in web applications because it requires low-level control of the HTTP messages \nthat it sends, which browsers do not allow. (There is a browser library that allows gRPC \nto be used via a proxy server, but that undermines the benefits of using gRPC.) Until \ngRPC can be used in the browser, its inclusion in ASP.NET Core is of interest only for \nprojects that use it for communication between back-end servers, such as in microser-\nvices development. I may cover gRPC in future editions of this book but not until it can \nbe used in the browser.\n1.2 Understanding this book\nTo get the most from this book, you should be familiar with the basics of web develop-\nment, understand how HTML and CSS work, and have a working knowledge of C#. \nDon’t worry if you haven’t done any client-side development, such as JavaScript. The \nemphasis in this book is on C# and ASP.NET Core, and you will be able to pick up \neverything you need to know as you progress through the chapters. In chapter 5, I sum-\nmarize the most important C# features for ASP.NET Core development.\n1.2.1 What software do I need to follow the examples?\nYou need a code editor (either Visual Studio or Visual Studio Code), the .NET Core \nSoftware Development Kit, and SQL Server LocalDB. All are available for use from \nMicrosoft without charge, and chapter 2 contains instructions for installing everything \nyou need.\n1.2.2 What platform do I need to follow the examples?\nThis book is written for Windows. I used Windows 10 Pro, but any version of Windows \nsupported by Visual Studio, Visual Studio Code, and .NET Core should work. ASP.NET \nCore is supported on other platforms, but the examples in this book rely on the SQL \nServer LocalDB feature, which is specific to Windows. You can contact me at adam \n@adam-freeman.com if you are trying to use another platform, and I will give you some \ngeneral pointers for adapting the examples, albeit with the caveat that I won’t be able \nto provide detailed help if you get stuck. \n1.2.3 What if I have problems following the examples?\nThe first thing to do is to go back to the start of the chapter and begin again. Most \nproblems are caused by missing a step or not fully following a listing. Pay close atten-\ntion to the emphasis in code listings, which highlights the changes that are required.\nNext, check the errata/corrections list, which is included in the book’s GitHub \nrepository. Technical books are complex, and mistakes are inevitable, despite my best \nefforts and those of my editors. Check the errata list for the list of known errors and \ninstructions to resolve them.",2941
16-1.2.6 What doesnt this book cover.pdf,16-1.2.6 What doesnt this book cover,"7 Understanding this book\nIf you still have problems, then download the project for the chapter you are read-\ning from the book’s GitHub repository, https://github.com/manningbooks/pro-asp \n.net-core-7 , and compare it to your project. I create the code for the GitHub repository \nby working through each chapter, so you should have the same files with the same con-\ntents in your project.\nIf you still can’t get the examples working, then you can contact me at adam \n@adam-freeman.com for help. Please make it clear in your email which book you are \nreading and which chapter/example is causing the problem. Please remember that I \nget a lot of emails and that I may not respond immediately. \n1.2.4 What if I find an error in the book?\nYou can report errors to me by email at adam@adam-freeman.com, although I ask \nthat you first check the errata/corrections list for this book, which you can find in the \nbook’s GitHub repository at  https://github.com/manningbooks/pro-asp.net-core-7 , \nin case it has already been reported.  \nI add errors that are likely to cause confusion to readers, especially problems with \nexample code, to the errata/corrections file on the GitHub repository, with a grate-\nful acknowledgment to the first reader who reported them. I also publish a typos list, \nwhich contains less serious issues, which usually means errors in the text surrounding \nexamples that are unlikely to prevent a reader from following or understanding the \nexamples.\nErrata bounty\nManning has agreed to give a free ebook to readers who are the first to report errors \nthat make it onto the GitHub errata list for this book, which is for serious issues that will \ndisrupt a reader’s progress. Readers can select any Manning ebook, not just my books.\nThis is an entirely discretionary and experimental program. Discretionary means that \nonly I decide which errors are listed in the errata and which reader is the first to make a \nreport. Experimental means Manning may decide not to give away any more books at any \ntime for any reason. There are no appeals, and this is not a promise or a contract or any \nkind of formal offer or competition. Or, put another way, this is a nice and informal way \nto say thank you and to encourage readers to report mistakes that I have missed when \nwriting this book. \n1.2.5 What does this book cover?\nI have tried to cover the features that will be required by most ASP.NET Core projects. \nThis book is split into four parts, each of which covers a set of related topics.\npart 1: introducing  asp.net core \nThis part of the book introduces ASP.NET Core. In addition to setting up your devel-\nopment environment and creating your first application, you’ll learn about the most \nimportant C# features for ASP.NET Core development and how to use the ASP.NET",2830
17-1.2.8 What if I really enjoyed this book.pdf,17-1.2.8 What if I really enjoyed this book,"8 chapter  1 Putting ASP.NET Core in context \nCore development tools. Most of part 1 is given over to the development of a project \ncalled SportsStore, through which I show you a realistic development process from \ninception to deployment, touching on all the main features of ASP.NET Core and \nshowing how they fit together—something that can be lost in the deep-dive chapters in \nthe rest of the book.\npart 2: the asp.net core platform  \nThe chapters in this part of the book describe the key features of the ASP.NET Core \nplatform. I explain how HTTP requests are processed, how to create and use middle-\nware components, how to create routes, how to define and consume services, and \nhow to work with Entity Framework Core. These chapters explain the foundations \nof ASP.NET Core, and understanding them is essential for effective ASP.NET Core \ndevelopment.\npart 3: asp.net core applications\nThe chapters in this part of the book explain how to create different types of applica-\ntions, including RESTful web services and HTML applications using controllers and \nRazor Pages. These chapters also describe the features that make it easy to generate \nHTML, including the views, view components, and tag helpers.\npart 4: advanced  asp.net core features\nThe final part of the book explains how to create applications using Blazor Server, \nhow to use the experimental Blazor WebAssembly, and how to authenticate users and \nauthorize access using ASP.NET Core Identity.\n1.2.6 What doesn’t this book cover?\nThis book doesn’t cover basic web development topics, such as HTML and CSS, and \ndoesn’t teach basic C# (although chapter 5 does describe C# features useful for ASP.\nNET Core development that may not be familiar to developers using older versions of \n.NET).\nAs much as I like to dive into the details in my books, not every ASP.NET Core feature \nis useful in mainstream development, and I have to keep my books to a printable size. \nWhen I decide to omit a feature, it is because I don’t think it is important or because the \nsame outcome can be achieved using a technique that I do cover. \nAs noted earlier, I have not described the ASP.NET Core support for SignalR and \ngRPC, and I note other features in later chapters that I don’t describe, either because \nthey are not broadly applicable or because there are better alternatives available. In \neach case, I explain why I have omitted a description and provide a reference to the \nMicrosoft documentation for that topic. \n1.2.7 How do I contact the author?\nYou can email me at adam@adam-freeman.com. It has been a few years since I first \npublished an email address in my books. I wasn’t entirely sure that it was a good idea, \nbut I am glad that I did it. I have received emails from around the world, from readers",2812
18-1.2.9 What if this book has made me angry and I want to complain.pdf,18-1.2.9 What if this book has made me angry and I want to complain,,0
19-Summary.pdf,19-Summary,"9 Summary\nworking or studying in every industry, and—for the most part anyway—the emails are \npositive, polite, and a pleasure to receive.\nI try to reply promptly, but I get a lot of email, and sometimes I get a backlog, espe-\ncially when I have my head down trying to finish writing a book. I always try to help read-\ners who are stuck with an example in the book, although I ask that you follow the steps \ndescribed earlier in this chapter before contacting me. \nWhile I welcome reader emails, there are some common questions for which the \nanswers will always be no. I am afraid that I won’t write the code for your new startup, \nhelp you with your college assignment, get involved in your development team’s design \ndispute, or teach you how to program. \n1.2.8 What if I really enjoyed this book?\nPlease email me at adam@adam-freeman.com and let me know. It is always a delight \nto hear from a happy reader, and I appreciate the time it takes to send those emails. \nWriting these books can be difficult, and those emails provide essential motivation to \npersist at an activity that can sometimes feel impossible.\n1.2.9 What if this book has made me angry and I want to complain?\nYou can still email me at adam@adam-freeman.com, and I will still try to help you. Bear \nin mind that I can only help if you explain what the problem is and what you would like \nme to do about it. You should understand that sometimes the only outcome is to accept \nI am not the writer for you and that we will have closure only when you return this book \nand select another. I’ll give careful thought to whatever has upset you, but after 25 \nyears of writing books, I have come to understand that not everyone enjoys reading the \nbooks I like to write.\nSummary\n¡ ASP.NET Core is a cross-platform framework for creating web applications. \n¡ The ASP.NET Core platform is a powerful foundation on which application \nframeworks have been built.\n¡ The MVC Framework was the original ASP.NET Core framework. It is powerful \nand flexible but takes time to prepare.\n¡ The Razor Pages framework is a newer addition, which requires less initial prepa-\nration but can be more difficult to manage in complex projects.\n¡ Blazor is a framework that allows client-side applications to be written in C#, \nrather than JavaScript. There are versions of Blazor that execute the C# code \nwithin the ASP.NET Core server and entirely within the browser.",2448
20-Part 1.pdf,20-Part 1,Part 1\nXXX,11
21-2 Getting started.pdf,21-2 Getting started,,0
22-2.1.1 Installing Visual Studio.pdf,22-2.1.1 Installing Visual Studio,"132Getting started\nThis chapter covers\n¡ Installing the code editor and SDK required  \n for ASP.NET Core development\n¡ Creating a simple ASP.NET Core project\n¡ Responding to HTTP requests using a  \n combination of code and markup\nThe best way to appreciate a software development framework is to jump right in \nand use it. In this chapter, I explain how to prepare for ASP.NET Core development \nand how to create and run an ASP.NET Core application. \n2.1 Choosing a code editor\nMicrosoft provides a choice of tools for ASP.NET Core development: Visual Stu-\ndio and Visual Studio Code. Visual Studio is the traditional development environ-\nment for .NET applications, and it offers an enormous range of tools and features \nfor developing all sorts of applications. But it can be resource-hungry and slow, \nand some of the features are so determined to be helpful they get in the way of \ndevelopment.\nVisual Studio Code is a lightweight alternative that doesn’t have the bells and whis-\ntles of Visual Studio but is perfectly capable of handling ASP.NET Core development.\nAll the examples in this book include instructions for both editors, and both \nVisual Studio and Visual Studio Code can be used without charge, so you can use \nwhichever suits your development style. \nIf you are new to .NET development, then start with Visual Studio. It provides \nmore structured support for creating the different types of files used in ASP.NET \n14 chapter  2 Getting started\nCore development, which will help ensure you get the expected results from the code \nexamples.\nNOTE     This book describes ASP.NET Core development for Windows. It is pos-\nsible to develop and run ASP.NET Core applications on Linux and macOS, but \nmost readers use Windows, and that is what I have chosen to focus on. Almost all \nthe examples in this book rely on LocalDB, which is a Windows-only feature pro-\nvided by SQL Server that is not available on other platforms. If you want to follow \nthis book on another platform, then you can contact me using the email address \nin chapter 1, and I will try to help you get started.\n2.1.1 Installing Visual Studio\nASP.NET Core 7 requires Visual Studio 2022. I use the free Visual Studio 2022 Commu-\nnity Edition, which can be downloaded from www.visualstudio.com . Run the installer, \nand you will see the prompt shown in figure 2.1.  \nFigure 2.1    Starting the Visual Studio installer  \nClick the Continue button, and the installer will download the installation files, as \nshown in figure 2.2. \nFigure 2.2    Downloading the Visual Studio installer files\n 15 Choosing a code editor\nWhen the installer files have been downloaded, you will be presented with a set of \ninstallation options, grouped into workloads. Ensure that the “ASP.NET and web devel-\nopment” workload is checked, as shown in figure 2.3.\nFigure 2.3    Selecting the workload\nSelect the “Individual components” section at the top of the window and ensure the \nSQL Server Express 2019 LocalDB option is checked, as shown in figure 2.4. This is the \ndatabase component that I will be using to store data in later chapters.  \nFigure 2.4    Ensuring LocalDB is installed \nClick the Install button, and the files required for the selected workload will be down-\nloaded and installed. To complete the installation, a reboot may be required.  \nNOTE    You must also install the SDK, as described in the following section.\ninstalling  the .net sdk\nThe Visual Studio installer will install the .NET Software Development Kit (SDK), \nbut it may not install the version required for the examples in this book. Go to  \nhttps://dotnet.microsoft.com/download/dotnet-core/7.0  and download the installer \nfor version 7.0.0 of the .NET SDK, which is the current release at the time of writing.",3814
23-2.1.2 Installing Visual Studio Code.pdf,23-2.1.2 Installing Visual Studio Code,"16 chapter  2 Getting started\nRun the installer; once the installation is complete, open a new PowerShell command \nprompt from the Windows Start menu and run the command shown in listing 2.1, \nwhich displays a list of the installed .NET SDKs.  \nListing 2.1    Listing the Installed SDKs\ndotnet --list-sdks\nHere is the output from a fresh installation on a Windows machine that has not been \nused for .NET:\n7.0.100 [C:\Program Files\dotnet\sdk]\nIf you have been working with different versions of .NET, you may see a longer list, like \nthis one:\n5.0.100 [C:\Program Files\dotnet\sdk]\n6.0.100 [C:\Program Files\dotnet\sdk]\n6.0.113 [C:\Program Files\dotnet\sdk]\n6.0.202 [C:\Program Files\dotnet\sdk]\n6.0.203 [C:\Program Files\dotnet\sdk]\n7.0.100 [C:\Program Files\dotnet\sdk]\nRegardless of how many entries there are, you must ensure there is one for the 7.0.1xx \nversion, where the last two digits may differ.\n2.1.2 Installing Visual Studio Code \nIf you have chosen to use Visual Studio Code, download the installer from https://\ncode.visualstudio.com . No specific version is required, and you should select the cur-\nrent stable build. Run the installer and ensure you check the Add to PATH option, as \nshown in figure 2.5.  \nFigure 2.5    Configuring the Visual Studio Code installation \ninstalling  the .net sdk\nThe Visual Studio Code installer does not include the .NET SDK, which must be \ninstalled separately. Go to https://dotnet.microsoft.com/download/dotnet-core/7.0 \n 17 Choosing a code editor\nand download the installer for version 7.0.0 of the .NET SDK. Run the installer; once \nthe installation is complete, open a new PowerShell command prompt from the Win-\ndows Start menu and run the command shown in listing 2.2, which displays a list of the \ninstalled .NET SDKs.  \nListing 2.2    Listing the Installed SDKs\ndotnet --list-sdks\nHere is the output from a fresh installation on a Windows machine that has not been \nused for .NET:\n7.0.100 [C:\Program Files\dotnet\sdk]\nIf you have been working with different versions of .NET, you may see a longer list, like \nthis one:\n5.0.100 [C:\Program Files\dotnet\sdk]\n6.0.100 [C:\Program Files\dotnet\sdk]\n6.0.113 [C:\Program Files\dotnet\sdk]\n6.0.202 [C:\Program Files\dotnet\sdk]\n6.0.203 [C:\Program Files\dotnet\sdk]\n7.0.100 [C:\Program Files\dotnet\sdk]\nRegardless of how many entries there are, you must ensure there is one for the 7.0.1xx \nversion, where the last two digits may differ.\ninstalling  sQl server  localdb\nThe database examples in this book require LocalDB, which is a zero-configuration \nversion of SQL Server that can be installed as part of the SQL Server Express edition, \nwhich is available for use without charge from https://www.microsoft.com/en-in/\nsql-server/sql-server-downloads . Download and run the Express edition installer and \nselect the Custom option, as shown in figure 2.6. \nFigure 2.6    Selecting the installation option for SQL Server\n18 chapter  2 Getting started\nOnce you have selected the Custom option, you will be prompted to select a download \nlocation for the installation files. Click the Install button, and the download will begin.\nWhen prompted, select the option to create a new SQL Server installation, as shown \nin figure 2.7.\nFigure 2.7    Selecting an installation option  \nWork through the installation process, selecting the default options as they are pre-\nsented. When you reach the Feature Selection page, ensure that the LocalDB option \nis checked, as shown in figure 2.8. (You may want to uncheck the Machine Learning \nServices option, which is not used in this book and takes a long time to download and \ninstall.)\nFigure 2.8    Selecting the LocalDB feature",3740
24-2.3.1 Understanding endpoints.pdf,24-2.3.1 Understanding endpoints,"19 Creating an ASP.NET Core project\nOn the Instance Configuration page, select the “Default instance” option, as shown in \nfigure 2.9.\nFigure 2.9    Configuring the database\nContinue to work through the installation process, selecting the default values, and \ncomplete the installation.\n2.2 Creating an ASP .NET Core project\nThe most direct way to create a project is to use the command line. Open a new Power-\nShell command prompt from the Windows Start menu, navigate to the folder where \nyou want to create your ASP.NET Core projects, and run the commands shown in list-\ning 2.3.  \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 2.3    Creating a new project \ndotnet new globaljson --sdk-version 7.0.100 --output FirstProject \ndotnet new mvc --no-https --output FirstProject --framework net7.0\ndotnet new sln -o FirstProject\ndotnet sln FirstProject add FirstProject\nThe first command creates a folder named FirstProject  and adds to it a file named \nglobal.json , which specifies the version of .NET that the project will use; this ensures \nyou get the expected results when following the examples. The second command cre-\nates a new ASP.NET Core project. The .NET SDK includes a range of templates for \nstarting new projects, and the mvc template is one of the options available for ASP.NET \nCore applications. This project template creates a project that is configured for the \nMVC Framework, which is one of the application types supported by ASP.NET Core. \nDon’t be intimidated by the idea of choosing a framework, and don’t worry if you have \nnot heard of MVC—by the end of the book, you will understand the features that each \n20 chapter  2 Getting started\noffers and how they fit together. The remaining commands create a solution file, which \nallows multiple projects to be used together.\nNOTE     This is one of a small number of chapters in which I use a project tem-\nplate that contains placeholder content. I don’t like using predefined project \ntemplates because they encourage developers to treat important features, such \nas authentication, as black boxes. My goal in this book is to give you the knowl-\nedge to understand and manage every aspect of your ASP.NET Core applica-\ntions, and that’s why I start with an empty ASP.NET Core project. This chapter is \nabout getting started quickly, for which the mvc template is well-suited.\n2.2.1 Opening the project using Visual Studio\nStart Visual Studio and click the “Open a project or solution” button, as shown in fig-\nure 2.10.\nFigure 2.10    Opening the \nASP .NET Core project\nNavigate to the FirstProject  folder, select the FirstProject.sln  file, and click the \nOpen button. Visual Studio will open the project and display its contents in the Solu-\ntion Explorer window, as shown in figure 2.11. The files in the project were created by \nthe project template.  \nFigure 2.11    \nOpening the project \nin Visual Studio\n 21 Creating an ASP.NET Core project\n2.2.2 Opening the project with Visual Studio Code \nStart Visual Studio Code and select File > Open Folder. Navigate to the FirstProject  \nfolder and click the Select Folder button. Visual Studio Code will open the project and \ndisplay its contents in the Explorer pane, as shown in figure 2.12. (The default dark \ntheme used in Visual Studio Code doesn’t show well on the page, so I have changed to \nthe light theme for the screenshots in this book.)  \nFigure 2.12    Opening the project in Visual Studio Code  \nAdditional configuration is required the first time you open a .NET project in Visual \nStudio Code. The first step is to click the Program.cs  file in the Explorer pane. This \nwill trigger a prompt from Visual Studio Code to install the features required for C# \ndevelopment, as shown in figure 2.13. If you have not opened a C# project before, you \nwill see a prompt that offers to install the required assets, also shown in figure 2.13. \nFigure 2.13    Installing Visual Studio Code C# features\nClick the Install or Yes button, as appropriate, and Visual Studio Code will download \nand install the features required for .NET projects.\n22 chapter  2 Getting started\n2.3 Running the ASP .NET Core application\nVisual Studio and Visual Studio Code can both run projects directly, but I use the com-\nmand line tools throughout this book because they are more reliable and work more \nconsistently, helping to ensure you get the expected results from the examples.\nWhen the project is created, a file named launchSettings.json  is created in the \nProperties  folder, and it is this file that determines which HTTP port ASP.NET Core \nwill use to listen for HTTP requests. Open this file in your chosen editor and change the \nports in the URLs it contains to 5000, as shown in listing 2.4.\nListing 2.4    Setting the Port in the launchSettings.json File in the Properties Folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""FirstProject"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nIt is only the URL in the profiles  section that affects the .NET command-line tools, \nbut I have changed both of them to avoid any problems. Open a new PowerShell com-\nmand prompt from the Windows Start menu; navigate to the FirstProject  project \nfolder, which is the folder that contains the FirstProject.csproj  file; and run the \ncommand shown in listing 2.5.\nListing 2.5    Starting the example application \ndotnet run\nThe dotnet run  command compiles and starts the project. Once the application has \nstarted, open a new browser window and request http://localhost:5000, which will pro-\nduce the response shown in figure 2.14.\n 23 Running the ASP.NET Core application\nFigure 2.14    Running the example project \nWhen you are finished, use Control+C to stop the ASP.NET Core application.\n2.3.1 Understanding endpoints\nIn an ASP.NET Core application, incoming requests are handled by endpoints . The end-\npoint that produced the response in figure 2.14 is an action , which is a method that is \nwritten in C#. An action is defined in a controller , which is a C# class that is derived from \nthe Microsoft.AspNetCore.Mvc.Controller  class, the built-in controller base class. \nEach public method defined by a controller is an action, which means you can invoke \nthe action method to handle an HTTP request. The convention in ASP.NET Core proj-\nects is to put controller classes in a folder named Controllers , which was created by \nthe template used to set up the project.  \nThe project template added a controller to the Controllers  folder to help jump-\nstart development. The controller is defined in the class file named HomeControl-\nler.cs . Controller classes contain a name followed by the word Controller , which \nmeans that when you see a file called HomeController.cs , you know that it contains \na controller called Home , which is the default controller that is used in ASP.NET Core \napplications. \nTIP    Don’t worry if the terms controller  and action  don’t make immediate sense. \nJust keep following the example, and you will see how the HTTP request sent by \nthe browser is handled by C# code.\nFind the HomeController.cs  file in the Solution Explorer or Explorer pane and click \nit to open it for editing. You will see the following code:\nusing System.Diagnostics;\nusing Microsoft.AspNetCore.Mvc;\nusing FirstProject.Models;\nnamespace FirstProject.Controllers;\npublic class HomeController : Controller {\n    private readonly ILogger<HomeController> _logger;\n24 chapter  2 Getting started\n    public HomeController(ILogger<HomeController> logger) {\n        _logger = logger;\n    }\n    public IActionResult Index() {\n        return View();\n    }\n    public IActionResult Privacy() {\n        return View();\n    }\n    [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, \n        NoStore = true)]\n    public IActionResult Error() {\n        return View(new ErrorViewModel { RequestId = Activity.Current?.Id \n            ?? HttpContext.TraceIdentifier });\n    }\n}\nUsing the code editor, replace the contents of the HomeController.cs  file so that it \nmatches listing 2.6. I have removed all but one of the methods, changed the result type \nand its implementation, and removed the using  statements for unused namespaces. \nListing 2.6    Changing the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace FirstProject.Controllers {\n    public class HomeController : Controller {\n        public string Index() {\n            return ""Hello World"";\n        }\n    }\n}\nThe result is that the Home  controller defines a single action, named Index . These \nchanges don’t produce a dramatic effect, but they make for a nice demonstration. I \nhave changed the method named Index  so that it returns the string Hello  World . \nUsing the PowerShell prompt, run the dotnet  run command in the FirstProject  \nfolder again and use the browser to request http://localhost:5000. The configuration \nof the project created by the template in listing 2.3 means the HTTP request will be \nprocessed by the Index  action defined by the Home  controller. Put another way, the \nrequest will be processed by the Index  method defined by the HomeController  class. \nThe string  produced by the Index  method is used as the response to the browser’s \nHTTP request, as shown in figure 2.15.",10177
25-2.3.2 Understanding routes.pdf,25-2.3.2 Understanding routes,,0
26-2.3.3 Understanding HTML rendering.pdf,26-2.3.3 Understanding HTML rendering,"25 Running the ASP.NET Core application\nFigure 2.15    The output from the action method\n2.3.2 Understanding routes\nThe ASP.NET Core routing  system is responsible for selecting the endpoint that will \nhandle an HTTP request. A route is a rule that is used to decide how a request is han-\ndled. When the project was created, a default rule was created to get started. You can \nrequest any of the following URLs, and they will be dispatched to the Index  action \ndefined by the Home  controller:  \n¡ /\n¡ /Home\n¡ /Home/Index\nSo, when a browser requests http://yoursite/ or http://yoursite/Home, it gets back \nthe output from HomeController’s Index method. You can try this yourself by chang-\ning the URL in the browser. At the moment, it will be http://localhost:5000/. If you \nappend /Home  or /Home/Index  to the URL and press Return, you will see the same \nHello  World  result from the application.\n2.3.3 Understanding HTML rendering \nThe output from the previous example wasn’t HTML—it was just the string Hello  \nWorld . To produce an HTML response to a browser request, I need a view, which \ntells ASP.NET Core how to process the result produced by the Index  method into an \nHTML response that can be sent to the browser. \ncreating  and rendering  a view\nThe first thing I need to do is modify my Index  action method, as shown in listing 2.7. \nThe changes are shown in bold, which is a convention I follow throughout this book to \nmake the examples easier to follow.  \nListing 2.7    Rendering a view in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace FirstProject.Controllers {\n    public class HomeController : Controller {\n26 chapter  2 Getting started\n        public ViewResult Index() {\n            return View(""MyView"");\n        }\n    }\n}\nWhen I return a ViewResult  object from an action method, I am instructing ASP.NET \nCore to render  a view. I create the ViewResult  by calling the View  method, specifying \nthe name of the view that I want to use, which is MyView . \nUse Control+C to stop ASP.NET Core and then use the dotnet run  command to \ncompile and start it again. Use the browser to request http://localhost:5000, and you \nwill see ASP.NET Core trying to find the view, as shown by the error message displayed \nin figure 2.16.\nFigure 2.16    Trying to find a view\nThis is a helpful error message. It explains that ASP.NET Core could not find the view \nI specified for the action method and explains where it looked. Views are stored in the \nViews  folder, organized into subfolders. Views that are associated with the Home  con-\ntroller, for example, are stored in a folder called Views/Home . Views that are not spe-\ncific to a single controller are stored in a folder called Views/Shared . The template \nused to create the project added the Home  and Shared  folders automatically and added \nsome placeholder views to get the project started.\nIf you are using Visual Studio, right-click the Views/Home  folder in the Solution \nExplorer and select Add > New Item from the pop-up menu. Visual Studio will pres-\nent you with a list of templates for adding items to the project. Locate the Razor View \n- Empty item, which can be found in the ASP.NET Core > Web > ASP.NET section, as \nshown in figure 2.17. \nFor Visual Studio, you may need to click the Show All Templates button before the \nlist of templates is displayed. Set the name of the new file to MyView.cshtml  and click \nthe Add button. Visual Studio will add a file named MyView.cshtml  to the Views/Home  \nfolder and will open it for editing. Replace the contents of the file with those shown in \nlisting 2.8.\n 27 Running the ASP.NET Core application\nFigure 2.17    Selecting a Visual Studio item template  \nVisual Studio Code doesn’t provide item templates. Instead, right-click the Views/\nHome  folder in the file explorer pane and select New File from the pop-up menu. Set \nthe name of the file to MyView.cshtml  and press Return. The file will be created and \nopened for editing. Add the content shown in listing 2.8.\nTIP    It is easy to end up creating the view file in the wrong folder. If you didn’t \nend up with a file called MyView.cshtml  in the Views/Home  folder, then either \ndrag the file into the correct folder or delete the file and try again.\nListing 2.8    The contents of the MyView.cshtml file in the Views/Home folder \n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Index</title>\n</head>\n<body>\n    <div>\n        Hello World (from the view)\n    </div>\n</body>\n</html>\nThe new contents of the view file are mostly HTML. The exception is the part that \nlooks like this:\n...\n@{\n    Layout = null;\n}\n...\n28 chapter  2 Getting started\nThis is an expression that will be interpreted by Razor, which is the component that \nprocesses the contents of views and generates HTML that is sent to the browser. Razor \nis a view engine , and the expressions in views are known as Razor expressions .\nThe Razor expression in listing 2.8 tells Razor that I chose not to use a layout, which \nis like a template for the HTML that will be sent to the browser (and which I describe in \nchapter 22). To see the effect of creating the view, use Control+C to stop ASP.NET Core \nif it is running and use the dotnet run  command to compile and start the application \nagain. Use a browser to request http://localhost:5000, and you will see the result shown \nin figure 2.18.\nFigure 2.18    Rendering a view\nWhen I first edited the Index  action method, it returned a string  value. This meant \nthat ASP.NET Core did nothing except pass the string value as is to the browser. Now \nthat the Index  method returns a ViewResult , Razor is used to process a view and ren-\nder an HTML response. Razor was able to locate the view because I followed the stan-\ndard naming convention, which is to put view files in a folder whose name matched the \ncontroller that contains the action method. In this case, this meant putting the view file \nin the Views/Home  folder, since the action method is defined by the Home  controller.\nI can return other results from action methods besides strings and ViewResult  \nobjects. For example, if I return a RedirectResult , the browser will be redirected to \nanother URL. If I return an HttpUnauthorizedResult , I can prompt the user to log \nin. These objects are collectively known as action results . The action result system lets you \nencapsulate and reuse common responses in actions. I’ll tell you more about them and \nexplain the different ways they can be used in chapter 19.\nadding  dynamic  output\nThe whole point of a web application is to construct and display dynamic  output. The \njob of the action method is to construct data and pass it to the view so it can be used to \ncreate HTML content based on the data values. Action methods provide data to views \nby passing arguments to the View  method, as shown in listing 2.9. The data provided to \nthe view is known as the view model .\nListing 2.9    Using a view model in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace FirstProject.Controllers {\n    public class HomeController : Controller {\n 29 Running the ASP.NET Core application\n        public ViewResult Index() {\n            int hour = DateTime.Now.Hour;\n            string viewModel = \n                hour < 12 ? ""Good Morning"" : ""Good Afternoon"";\n            return View(""MyView"", viewModel);\n        }\n    }\n}\nThe view model in this example is a string , and it is provided to the view as the second \nargument to the View  method. Listing 2.10 updates the view so that it receives and uses \nthe view model in the HTML it generates.\nListing 2.10    Using a view model in the MyView.cshtml file in the Views/Home folder\n@model string\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Index</title>\n</head>\n<body>\n    <div>\n        @Model World (from the view)\n    </div>\n</body>\n</html>\nThe type of the view model is specified using the @model  expression, with a lowercase m. \nThe view model value is included in the HTML output using the @Model  expression, \nwith an uppercase M. (It can be difficult at first to remember which is lowercase and \nwhich is uppercase, but it soon becomes second nature.)\nWhen the view is rendered, the view model data provided by the action method is \ninserted into the HTML response. Use Control+C to stop ASP.NET Core and use the \ndotnet run  command to build and start it again. Use a browser to request http:// \nlocalhost:5000, and you will see the output shown in figure 2.19 (although you may see \nthe morning greeting if you are following this example before midday).\nFigure 2.19    Generating dynamic content",8984
27-2.3.4 Putting the pieces together.pdf,27-2.3.4 Putting the pieces together,,0
28-3 Your first ASP.NET Core application.pdf,28-3 Your first ASP.NET Core application,"30 chapter  2 Getting started\n2.3.4 Putting the pieces together\nIt is a simple result, but this example reveals all the building blocks you need to cre-\nate a simple ASP.NET Core web application and to generate a dynamic response. \nThe ASP.NET Core platform receives an HTTP request and uses the routing system \nto match the request URL to an endpoint. The endpoint, in this case, is the Index  \naction method defined by the Home  controller. The method is invoked and produces \na ViewResult  object that contains the name of a view and a view model object. The \nRazor view engine locates and processes the view, evaluating the @Model  expression \nto insert the data provided by the action method into the response, which is returned \nto the browser and displayed to the user. There are, of course, many other features \navailable, but this is the essence of ASP.NET Core, and it is worth bearing this simple \nsequence in mind as you read the rest of the book.\nSummary\n¡ ASP.NET Core development can be done with Visual Studio or Visual Studio \nCode, or you can choose your own code editor.\n¡ Most code editors provide integrated code builds, but the most reliable way to get \nconsistent results across tools and platforms is by using the dotnet  command.\n¡ ASP.NET Core relies on endpoints to process HTTP requests. \n¡ Endpoints can be written entirely in C# or use HTML that has been annotated \nwith code expressions.",1438
29-3.2 Creating the project.pdf,29-3.2 Creating the project,"313Your first ASP.NET  \nCore application\nThis chapter covers\n¡ Using ASP.NET Core to create an application  \n that accepts RSVP responses\n¡ Creating a simple data model\n¡ Creating a controller and view that presents  \n and processes a form\n¡ Validating user data and displaying validation  \n errors\n¡ Applying CSS styles to the HTML generated by  \n the application\nNow that you are set up for ASP.NET Core development, it is time to create a simple \napplication. In this chapter, you’ll create a data-entry application using ASP.NET \nCore. My goal is to demonstrate ASP.NET Core in action, so I will pick up the pace \na little and skip over some of the explanations as to how things work behind the \nscenes. But don’t worry; I’ll revisit these topics in-depth in later chapters. \n3.1 Setting the scene\nImagine that a friend has decided to host a New Year’s Eve party and that she has \nasked me to create a web app that allows her invitees to electronically RSVP. She has \nasked for these four key features:",1026
30-3.2.1 Preparing the project.pdf,30-3.2.1 Preparing the project,"32 chapter  3 Your first ASP.NET Core application \n¡ A home page that shows information about the party\n¡ A form that can be used to RSVP\n¡ Validation for the RSVP form, which will display a thank-you page \n¡ A summary page that shows who is coming to the party\nIn this chapter, I create an ASP.NET Core project and use it to create a simple appli-\ncation that contains these features; once everything works, I’ll apply some styling to \nimprove the appearance of the finished application. \n3.2 Creating the project \nOpen a PowerShell command prompt from the Windows Start menu, navigate to a \nconvenient location, and run the commands in listing 3.1 to create a project named \nPartyInvites.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 3.1    Creating a new project \ndotnet new globaljson --sdk-version 7.0.100 --output PartyInvites\ndotnet new mvc --no-https --output PartyInvites --framework net7.0\ndotnet new sln -o PartyInvites\ndotnet sln PartyInvites add PartyInvites\nThese are the same commands I used to create the project in chapter 2. These com-\nmands ensure you get the right project starting point that uses the required version of \n.NET.\n3.2.1 Preparing the project \nOpen the project (by opening the PartyInvites.sln  file with Visual Studio or the \nPartyInvites  folder in Visual Studio Code) and change the contents of the launch-\nSettings.json  file in the Properties  folder, as shown in listing 3.2, to set the port \nthat will be used to listen for HTTP requests.\nListing 3.2    Setting ports in the launchSettings.json file in the Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""PartyInvites"": {\n      ""commandName"": ""Project"",\n 33 Creating the project \n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nReplace the contents of the HomeController.cs  file in the Controllers  folder with \nthe code shown in listing 3.3.\nListing 3.3    The new contents of the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace PartyInvites.Controllers {\n    public class HomeController : Controller {\n        \n        public IActionResult Index() {\n            return View();\n        }\n    }\n}\nThis provides a clean starting point for the new application, defining a single action \nmethod that selects the default view for rendering. To provide a welcome message to \nparty invitees, open the Index.cshtml  file in the Views/Home  folder and replace the \ncontents with those shown in listing 3.4.\nListing 3.4    Replacing the contents of the Index.cshtml file in the Views/Home folder\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Party!</title>\n</head>\n<body>\n    <div>\n        <div>\n            We're going to have an exciting party.<br />\n            (To do: sell it better. Add pictures or something.)",3642
31-3.2.3 Creating a second action and view.pdf,31-3.2.3 Creating a second action and view,"34 chapter  3 Your first ASP.NET Core application \n        </div>\n    </div>\n</body>\n</html>\nRun the command shown in listing 3.5 in the PartyInvites folder to compile and exe-\ncute the project.\nListing 3.5    Compiling and running the project \ndotnet watch\nOnce the project has started, a new browser window will be opened, and you will see \nthe details of the party (well, the placeholder for the details, but you get the idea), as \nshown in figure 3.1.\nFigure 3.1    \nAdding to the \nview HTML\nLeave the dotnet watch  command running. As you make changes to the project, you \nwill see that the code is automatically recompiled and that changes are automatically \ndisplayed in the browser.\nIf you make a mistake following the examples, you may find that the dotnet watch  \ncommand indicates that it can’t automatically update the browser. If that happens, \nselect the option to restart the application. \n3.2.2 Adding a data model\nThe data model is the most important part of any ASP.NET Core application. The \nmodel is the representation of the real-world objects, processes, and rules that define \nthe subject, known as the domain , of the application. The model, often referred to as \na domain model , contains the C# objects (known as domain objects ) that make up the \nuniverse of the application and the methods that manipulate them. In most projects, \nthe job of the ASP.NET Core application is to provide the user with access to the data \nmodel and the features that allow the user to interact with it.\nThe convention for an ASP.NET Core application is that the data model classes are \ndefined in a folder named Models , which was added to the project by the template used \nin listing 3.1.\nI don’t need a complex model for the PartyInvites project because it is such a simple \napplication. I need just one domain class that I will call GuestResponse . This object will \nrepresent an RSVP from an invitee.\nIf you are using Visual Studio, right-click the Models  folder and select Add > Class \nfrom the pop-up menu. Set the name of the class to GuestResponse.cs  and click the \n 35 Creating the project \nAdd button. If you are using Visual Studio Code, right-click the Models  folder, select \nNew File, and enter GuestResponse.cs  as the file name. Use the new file to define the \nclass shown in listing 3.6.\nListing 3.6    The contents of the GuestResponse.cs file in the Models folder\nnamespace PartyInvites.Models {\n    public class GuestResponse {\n        public string? Name { get; set; }\n        public string? Email { get; set; }\n        public string? Phone { get; set; }\n        public bool? WillAttend { get; set; }\n    }\n}\nNotice that all the properties defined by the GuestResponse  class are nullable.  \nI explain why this is important in the “Adding Validation” section later in the chapter.\nRestarting the automatic build\nYou may see a warning produced by the dotnet watch  command telling you that a hot \nreload cannot be applied. The dotnet watch  command can’t cope with every type of \nchange, and some changes cause the automatic rebuild process to fail. You will see this \nprompt at the command line:\nwatch : Do you want to restart your app \n    - Yes (y) / No (n) / Always (a) / Never (v)?\nPress a to always rebuild the project. Microsoft makes frequent improvements to the \ndotnet watch  command and so the actions that trigger this problem change.\n3.2.3 Creating a second action and view\nOne of my application goals is to include an RSVP form, which means I need to define \nan action method that can receive requests for that form. A single controller class can \ndefine multiple action methods, and the convention is to group related actions in the \nsame controller. Listing 3.7 adds a new action method to the Home  controller. Control-\nlers can return different result types, which are explained in later chapters.\nListing 3.7    Adding an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace PartyInvites.Controllers {\n    public class HomeController : Controller {\n        \n        public IActionResult Index() {\n            return View();\n        }\n36 chapter  3 Your first ASP.NET Core application \n        public ViewResult RsvpForm() {\n            return View();\n        }\n    }\n}\nBoth action methods invoke the View  method without arguments, which may seem \nodd, but remember that the Razor view engine will use the name of the action method \nwhen looking for a view file, as explained in chapter 2. That means the result from the \nIndex  action method tells Razor to look for a view called Index.cshtml , while the \nresult from the RsvpForm  action method tells Razor to look for a view called Rsvp-\nForm.cshtml .\nIf you are using Visual Studio, right-click the Views/Home  folder and select Add > \nNew Item from the pop-up menu. Select the Razor View – Empty item, set the name to \nRsvpForm.cshtml , and click the Add button to create the file. Replace the contents \nwith those shown in listing 3.8. \nIf you are using Visual Studio Code, right-click the Views/Home  folder and select \nNew File from the pop-up menu. Set the name of the file to RsvpForm.cshtml  and add \nthe contents shown in listing 3.8.\nListing 3.8    The contents of the RsvpForm.cshtml file in the Views/Home folder\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>RsvpForm</title>\n</head>\n<body>\n    <div>\n        This is the RsvpForm.cshtml View\n    </div>\n</body>\n</html>\nThis content is just static HTML for the moment. Use the browser to request http://\nlocalhost:5000/home/rsvpform. The Razor view engine locates the RsvpForm.cshtml  \nfile and uses it to produce a response, as shown in figure 3.2.\nFigure 3.2    \nRendering a \nsecond view",5896
32-3.2.6 Receiving form data.pdf,32-3.2.6 Receiving form data,"37 Creating the project \n3.2.4 Linking action methods\nI want to be able to create a link from the Index  view so that guests can see the Rsvp-\nForm  view without having to know the URL that targets a specific action method, as \nshown in listing 3.9.\nListing 3.9    Adding a link in the Index.cshtml file in the Views/Home folder\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Party!</title>\n</head>\n<body>\n    <div>\n        <div>\n            We're going to have an exciting party.<br />\n            (To do: sell it better. Add pictures or something.)\n        </div>\n        <a asp-action=""RsvpForm"">RSVP Now</a>\n    </div>\n</body>\n</html>\nThe addition to the listing is an a element that has an asp-action  attribute. The attri-\nbute is an example of a tag helper attribute, which is an instruction for Razor that will \nbe performed when the view is rendered. The asp-action  attribute is an instruction \nto add an href  attribute to the a element that contains a URL for an action method.  \nI explain how tag helpers work in chapters 25–27, but this tag helper tells Razor to \ninsert a URL for an action method defined by the same controller for which the cur-\nrent view is being rendered. \nUse the browser to request http://localhost:5000, and you will see the link that the \nhelper has created, as shown in figure 3.3.\nFigure 3.3    Linking between action methods\nRoll the mouse over the RSVP Now link in the browser. You will see that the link points \nto http://localhost:5000/Home/RsvpForm.\n38 chapter  3 Your first ASP.NET Core application \nThere is an important principle at work here, which is that you should use the features \nprovided by ASP.NET Core to generate URLs, rather than hard-code them into your \nviews. When the tag helper created the href  attribute for the a element, it inspected \nthe configuration of the application to figure out what the URL should be. This allows \nthe configuration of the application to be changed to support different URL formats \nwithout needing to update any views.\n3.2.5 Building the form\nNow that I have created the view and can reach it from the Index  view, I am going to \nbuild out the contents of the RsvpForm.cshtml  file to turn it into an HTML form for \nediting GuestResponse  objects, as shown in listing 3.10.\nListing 3.10    Creating a form view in the RsvpForm.cshtml file in the Views/Home  \nfolder\n@model PartyInvites.Models.GuestResponse\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>RsvpForm</title>\n</head>\n<body>\n    <form asp-action=""RsvpForm"" method=""post"">\n        <div>\n            <label asp-for=""Name"">Your name:</label>\n            <input asp-for=""Name"" />\n        </div>\n        <div>\n            <label asp-for=""Email"">Your email:</label>\n            <input asp-for=""Email"" />\n        </div>\n        <div>\n            <label asp-for=""Phone"">Your phone:</label>\n            <input asp-for=""Phone"" />\n        </div>\n        <div>\n            <label asp-for=""WillAttend"">Will you attend?</label>\n            <select asp-for=""WillAttend"">\n                <option value="""">Choose an option</option>\n                <option value=""true"">Yes, I'll be there</option>\n                <option value=""false"">No, I can't come</option>\n            </select>\n        </div>\n        <button type=""submit"">Submit RSVP</button>\n    </form>\n</body>\n</html>\n 39 Creating the project \nThe @model  expression specifies that the view expects to receive a GuestResponse  \nobject as its view model. I have defined a label  and input  element for each prop-\nerty of the GuestResponse  model class (or, in the case of the WillAttend  property, \na select  element). Each element is associated with the model property using the \nasp-for  attribute, which is another tag helper attribute. The tag helper attributes con-\nfigure the elements to tie them to the view model object. Here is an example of the \nHTML that the tag helpers produce:\n<p>\n    <label for=""Name"">Your name:</label>\n    <input type=""text"" id=""Name"" name=""Name"" value="""">\n</p>\nThe asp-for  attribute on the label  element sets the value of the for attribute. The \nasp-for  attribute on the input  element sets the id and name  elements. This may not \nlook especially useful, but you will see that associating elements with a model property \noffers additional advantages as the application functionality is defined.\nOf more immediate use is the asp-action  attribute applied to the form  element, \nwhich uses the application’s URL routing configuration to set the action  attribute to a \nURL that will target a specific action method, like this:\n<form method=""post"" action=""/Home/RsvpForm"">\nAs with the helper attribute I applied to the a element, the benefit of this approach is \nthat when you change the system of URLs that the application uses, the content gener-\nated by the tag helpers will reflect the changes automatically.\nUse the browser to request http://localhost:5000 and click the RSVP Now link to see \nthe form, as shown in figure 3.4.\nFigure 3.4   Adding an HTML form to the application\n3.2.6 Receiving form data\nI have not yet told ASP.NET Core what I want to do when the form is posted to the \nserver. As things stand, clicking the Submit RSVP button just clears any values you \nhave entered in the form. That is because the form posts back to the RsvpForm  action \nmethod in the Home  controller, which just renders the view again. To receive and pro-\ncess submitted form data, I am going to use an important feature of controllers. I will \nadd a second RsvpForm  action method to create the following:\n40 chapter  3 Your first ASP.NET Core application \n¡ A method that responds to HTTP GET requests: A GET request is what a browser \nissues normally each time someone clicks a link. This version of the action will be \nresponsible for displaying the initial blank form when someone first visits /Home/\nRsvpForm .\n¡ A method that responds to HTTP POST requests: The form element defined in \nlisting 3.10 sets the method attribute to post, which causes the form data to be \nsent to the server as a POST request. This version of the action will be responsible \nfor receiving submitted data and deciding what to do with it.\nHandling GET and POST  requests in separate C# methods helps to keep my controller \ncode tidy since the two methods have different responsibilities. Both action methods \nare invoked by the same URL, but ASP.NET Core makes sure that the appropriate \nmethod is called, based on whether I am dealing with a GET or POST  request. Listing \n3.11 shows the changes to the HomeController  class.\nListing 3.11    Adding a method in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing PartyInvites.Models;\nnamespace PartyInvites.Controllers {\n    public class HomeController : Controller {\n        \n        public IActionResult Index() {\n            return View();\n        }\n        [HttpGet]\n        public ViewResult RsvpForm() {\n            return View();\n        }\n        [HttpPost]\n        public ViewResult RsvpForm(GuestResponse guestResponse) {\n            // TODO: store response from guest\n            return View();\n        }\n    }\n}\nI have added the HttpGet  attribute to the existing RsvpForm  action method, which \ndeclares that this method should be used only for GET requests. I then added an over-\nloaded version of the RsvpForm  method, which accepts a GuestResponse  object.  \nI applied the HttpPost  attribute to this method, which declares it will deal with POST  \nrequests. I explain how these additions to the listing work in the following sections.  \nI also imported the PartyInvites.Models  namespace—this is just so I can refer to \nthe GuestResponse  model type without needing to qualify the class name. \n 41 Creating the project \nunderstanding  model  binding\nThe first overload of the RsvpForm  action method renders the same view as before—\nthe RsvpForm.cshtml  file—to generate the form shown in figure 3.4. The second over-\nload is more interesting because of the parameter, but given that the action method \nwill be invoked in response to an HTTP POST  request and that the GuestResponse  \ntype is a C# class, how are the two connected?\nThe answer is model binding , a useful ASP.NET Core feature whereby incoming data is \nparsed and the key-value pairs in the HTTP request are used to populate properties of \ndomain model types. \nModel binding is a powerful and customizable feature that eliminates the grind of \ndealing with HTTP requests directly and lets you work with C# objects rather than deal-\ning with individual data values sent by the browser. The GuestResponse  object that is \npassed as the parameter to the action method is automatically populated with the data \nfrom the form fields. I dive into the details of model binding in chapter 28.\nTo demonstrate how model binding works, I need to do some preparatory work. One \nof the application goals is to present a summary page with details of who is attending \nthe party, which means that I need to keep track of the responses that I receive. I am \ngoing to do this by creating an in-memory collection of objects. This isn’t useful in a real \napplication because the response data will be lost when the application is stopped or \nrestarted, but this approach will allow me to keep the focus on ASP.NET Core and cre-\nate an application that can easily be reset to its initial state. Later chapters will demon-\nstrate persistent data storage.\nAdd a class file named Repository.cs  to the Models  folder and use it to define the \nclass shown in listing 3.12.\nListing 3.12    The contents of the Repository.cs file in the Models folder\nnamespace PartyInvites.Models {\n    public static class Repository {\n        private static List<GuestResponse> responses = new();\n        public static IEnumerable<GuestResponse> Responses => responses;\n        public static void AddResponse(GuestResponse response) {\n            Console.WriteLine(response);\n            responses.Add(response);\n        }\n    }\n}\nThe Repository  class and its members are static , which will make it easy for me to \nstore and retrieve data from different places in the application. ASP.NET Core pro-\nvides a more sophisticated approach for defining common functionality, called depen-\ndency injection , which I describe in chapter 14, but a static class is a good way to get \nstarted for a simple application like this one.\nIf you are using Visual Studio, saving the contents of the Repository.cs  file will trig-\nger a warning produced by the dotnet watch  command telling you that a hot reload",10896
33-3.2.7 Adding the thanks view.pdf,33-3.2.7 Adding the thanks view,"42 chapter  3 Your first ASP.NET Core application \ncannot be applied, which is the same warning described earlier in the chapter for Visual \nStudio Code users. You will see this prompt at the command line:\nwatch : Do you want to restart your app \n    - Yes (y) / No (n) / Always (a) / Never (v)?\nPress a to always rebuild the project. \nstoring  responses\nNow that I have somewhere to store the data, I can update the action method that \nreceives the HTTP POST requests, as shown in listing 3.13.\nListing 3.13    Updating an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing PartyInvites.Models;\nnamespace PartyInvites.Controllers {\n    public class HomeController : Controller {\n        \n        public IActionResult Index() {\n            return View();\n        }\n        [HttpGet]\n        public ViewResult RsvpForm() {\n            return View();\n        }\n        [HttpPost]\n        public ViewResult RsvpForm(GuestResponse guestResponse) {\n            Repository.AddResponse(guestResponse);\n            return View(""Thanks"", guestResponse);\n        }\n    }\n}\nBefore the POST version of the RsvpForm  method is invoked, the ASP.NET Core \nmodel binding feature extracts values from the HTML form and assigns them to the \nproperties of the GuestResponse  object. The result is used as the argument when the \nmethod is invoked to handle the HTTP request, and all I have to do to deal with the \nform data sent in a request is to work with the GuestResponse  object that is passed \nto the action method—in this case, to pass it as an argument to the Repository.\nAddResponse  method so t hat the response can be stored. \n3.2.7 Adding the Thanks view\nThe call to the View  method in the RsvpForm  action method creates a ViewResult  \nthat selects a view called Thanks  and uses the GuestResponse  object created by the \nmodel binder as the view model. Add a Razor View named Thanks.cshtml  to the \nViews/Home  folder with the content shown in listing 3.14 to present a response to the \nuser.\n 43 Creating the project \nListing 3.14    The contents of the Thanks.cshtml file in the Views/Home folder \n@model PartyInvites.Models.GuestResponse\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Thanks</title>\n</head>\n<body>\n    <div>\n        <h1>Thank you, @Model?.Name!</h1>\n        @if (Model?.WillAttend == true) {\n            @:It's great that you're coming. \n            @:The drinks are already in the fridge!\n        } else {\n            @:Sorry to hear that you can't make it, \n            @:but thanks for letting us know.\n        }\n    </div>\n    Click <a asp-action=""ListResponses"">here</a> to see who is coming.\n</body>\n</html>\nThe HTML produced by the Thanks.cshtml  view depends on the values assigned to \nthe GuestResponse  view model provided by the RsvpForm  action method. To access \nthe value of a property in the domain object, I use an @Model.<PropertyName>  \nexpression. So, for example, to get the value of the Name  property, I use the @Model \n.Name  expression. Don’t worry if the Razor syntax doesn’t make sense—I explain it in \nmore detail in chapter 21. \nNow that I have created the Thanks  view, I have a basic working example of handling \na form. Use the browser to request http://localhost:5000, click the RSVP Now link, add \nsome data to the form, and click the Submit RSVP button. You will see the response \nshown in figure 3.5 (although it will differ if your name is not Joe or you said you could \nnot attend).\nFigure 3.5    The Thanks view",3669
34-3.2.8 Displaying responses.pdf,34-3.2.8 Displaying responses,"44 chapter  3 Your first ASP.NET Core application \n3.2.8 Displaying responses\nAt the end of the Thanks.cshtml  view, I added an a element to create a link to display \nthe list of people who are coming to the party. I used the asp-action  tag helper attri-\nbute to create a URL that targets an action method called ListResponses , like this:\n...\nClick <a asp-action=""ListResponses"" >here</a> to see who is coming.\n...\nIf you hover the mouse over the link that is displayed by the browser, you will see that it \ntargets the /Home/ListResponses  URL. This doesn’t correspond to any of the action \nmethods in the Home  controller, and if you click the link, you will see a 404 Not Found \nerror response. \nTo add an endpoint that will handle the URL, I need to add another action method \nto the Home  controller, as shown in listing 3.15.\nListing 3.15    Adding an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing PartyInvites.Models;\nnamespace PartyInvites.Controllers {\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View();\n        }\n        [HttpGet]\n        public ViewResult RsvpForm() {\n            return View();\n        }\n        [HttpPost]\n        public ViewResult RsvpForm(GuestResponse guestResponse) {\n            Repository.AddResponse(guestResponse);\n            return View(""Thanks"", guestResponse);\n        }\n        public ViewResult ListResponses() {\n            return View(Repository.Responses\n                .Where(r => r.WillAttend == true));\n        }\n    }\n}\nThe new action method is called ListResponses , and it calls the View  method, using \nthe Repository.Responses  property as the argument. This will cause Razor to render \nthe default view, using the action method name as the name of the view file, and to use \nthe data from the repository as the view model. The view model data is filtered using \nLINQ so that only positive responses are provided to the view.\n 45 Creating the project \nAdd a Razor View named ListResponses.cshtml  to the Views/Home  folder with \nthe content shown in listing 3.16.\nListing 3.16    Displaying data in the ListResponses.cshtml file in the Views/Home \nfolder\n@model IEnumerable<PartyInvites.Models.GuestResponse>\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Responses</title>\n</head>\n<body>\n    <h2>Here is the list of people attending the party</h2>\n    <table>\n        <thead>\n            <tr><th>Name</th><th>Email</th><th>Phone</th></tr>\n        </thead>\n        <tbody>\n            @foreach (PartyInvites.Models.GuestResponse r in Model!) {\n                <tr>\n                    <td>@r.Name</td>\n                    <td>@r.Email</td>\n                    <td>@r.Phone</td>\n                </tr>\n            }\n        </tbody>\n    </table>\n</body>\n</html>\nRazor view files have the .cshtml  file extension to denote a mix of C# code and HTML \nelements. You can see this in listing 3.16 where I have used an @foreach  expression \nto process each of the GuestResponse  objects that the action method passes to the \nview using the View  method. Unlike a normal C# foreach  loop, the body of a Razor  \n@foreach  expression contains HTML elements that are added to the response that \nwill be sent back to the browser. In this view, each GuestResponse  object generates a \ntr element that contains td elements populated with the value of an object property.\nUse the browser to request http://localhost:5000, click the RSVP Now link, and fill \nin the form. Submit the form and then click the link to see a summary of the data that \nhas been entered since the application was first started, as shown in figure 3.6. The view \ndoes not present the data in an appealing way, but it is enough for the moment, and I \nwill address the styling of the application later in this chapter.",4011
35-3.2.9 Adding validation.pdf,35-3.2.9 Adding validation,"46 chapter  3 Your first ASP.NET Core application \nFigure 3.6    Showing a list of party attendees\n3.2.9 Adding validation\nI can now add data validation to the application. Without validation, users could enter \nnonsense data or even submit an empty form. In an ASP.NET Core application, valida-\ntion rules are defined by applying attributes to model classes, which means the same \nvalidation rules can be applied in any form that uses that class. ASP.NET Core relies on \nattributes from the System.ComponentModel.DataAnnotations  namespace, which  \nI have applied to the GuestResponse  class in listing 3.17.\nListing 3.17    Applying validation in the GuestResponse.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations;\nnamespace PartyInvites.Models {\n    public class GuestResponse {\n        [Required(ErrorMessage = ""Please enter your name"")]\n        public string? Name { get; set; }\n        [Required(ErrorMessage = ""Please enter your email address"")]\n        [EmailAddress]\n        public string? Email { get; set; }\n        [Required(ErrorMessage = ""Please enter your phone number"")]\n        public string? Phone { get; set; }\n        [Required(ErrorMessage = ""Please specify whether you'll attend"")]\n        public bool? WillAttend { get; set; }\n    }\n}\nASP.NET Core detects the attributes and uses them to validate data during the model-\nbinding process. \nAs noted earlier, I used nullable types to define the GuestResponse  properties. This \nis useful for denoting properties that may not be assigned values, but it has a special \nvalue for the WillAttend  property because it allows the Required  validation attribute \n 47 Creating the project \nto work. If I had used a regular non-nullable bool , the value I received through model-\nbinding could be only true  or false , and I would not be able to tell whether the user \nhad selected a value. A nullable bool  has three possible values: true , false , and null . \nThe value of the WillAttend  property will be null  if the user has not selected a value, \nand this causes the Required  attribute to report a validation error. This is a nice exam-\nple of how ASP.NET Core elegantly blends C# features with HTML and HTTP. \nI check to see whether there has been a validation problem using the ModelState \n.IsValid  property in the action method that receives the form data, as shown in listing \n3.18.\nListing 3.18    Checking for errors in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing PartyInvites.Models;\nnamespace PartyInvites.Controllers {\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View();\n        }\n        [HttpGet]\n        public ViewResult RsvpForm() {\n            return View();\n        }\n        [HttpPost]\n        public ViewResult RsvpForm(GuestResponse guestResponse) {\n            if (ModelState.IsValid) {\n                Repository.AddResponse(guestResponse);\n                return View(""Thanks"", guestResponse);\n            } else {\n                return View();\n            }\n        }\n        public ViewResult ListResponses() {\n            return View(Repository.Responses\n                .Where(r => r.WillAttend == true));\n        }\n    }\n}\nThe Controller  base class provides a property called ModelState  that provides details \nof the outcome of the model binding process. If the ModelState.IsValid  property \nreturns true , then I know that the model binder has been able to satisfy the validation \nconstraints I specified through the attributes on the GuestResponse  class. When this \nhappens, I render the Thanks  view, just as I did previously. \nIf the ModelState.IsValid  property returns false , then I know that there are val-\nidation errors. The object returned by the ModelState  property provides details of \n48 chapter  3 Your first ASP.NET Core application \neach problem that has been encountered, but I don’t need to get into that level of detail \nbecause I can rely on a useful feature that automates the process of asking the user to \naddress any problems by calling the View  method without any parameters. \nWhen it renders a view, Razor has access to the details of any validation errors associ-\nated with the request, and tag helpers can access the details to display validation errors \nto the user. Listing 3.19 shows the addition of validation tag helper attributes to the \nRsvpForm  view.\nListing 3.19    Adding a summary to the RsvpForm.cshtml file in the Views/Home folder\n@model PartyInvites.Models.GuestResponse\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>RsvpForm</title>\n</head>\n<body>\n    <form asp-action=""RsvpForm"" method=""post"">\n        <div asp-validation-summary=""All""></div>\n        <div>\n            <label asp-for=""Name"">Your name:</label>\n            <input asp-for=""Name"" />\n        </div>\n        <div>\n            <label asp-for=""Email"">Your email:</label>\n            <input asp-for=""Email"" />\n        </div>\n        <div>\n            <label asp-for=""Phone"">Your phone:</label>\n            <input asp-for=""Phone"" />\n        </div>\n        <div>\n            <label asp-for=""WillAttend"">Will you attend?</label>\n            <select asp-for=""WillAttend"">\n                <option value="""">Choose an option</option>\n                <option value=""true"">Yes, I'll be there</option>\n                <option value=""false"">No, I can't come</option>\n            </select>\n        </div>\n        <button type=""submit"">Submit RSVP</button>\n    </form>\n</body>\n</html>\n 49 Creating the project \nThe asp-validation-summary  attribute is applied to a div element, and it displays a \nlist of validation errors when the view is rendered. The value for the asp-validation \n-summary  attribute is a value from an enumeration called ValidationSummary , which \nspecifies what types of validation errors the summary will contain. I specified All, \nwhich is a good starting point for most applications, and I describe the other values \nand explain how they work in chapter 29.\nTo see how the validation summary works, run the application, fill out the Name  field, \nand submit the form without entering any other data. You will see a summary of valida-\ntion errors, as shown in figure 3.7.\nFigure 3.7    Displaying validation errors\nThe RsvpForm  action method will not render the Thanks  view until all the validation \nconstraints applied to the GuestResponse  class have been satisfied. Notice that the \ndata entered in the Name  field was preserved and displayed again when Razor rendered \nthe view with the validation summary. This is another benefit of model binding, and it \nsimplifies working with form data.\nhighlighting  invalid  fields\nThe tag helper attributes that associate model properties with elements have a handy \nfeature that can be used in conjunction with model binding. When a model class prop-\nerty has failed validation, the helper attributes will generate slightly different HTML. \nHere is the input  element that is generated for the Phone field when there is no vali-\ndation error:\n<input type=""text"" data-val=""true""  \n    data-val-required=""Please enter your phone number"" id=""Phone""  \n    name=""Phone"" value="""">\nFor comparison, here is the same HTML element after the user has submitted the \nform without entering data into the text field (which is a validation error because I \napplied the Required  attribute to the Phone  property of the GuestResponse  class):\n<input type=""text"" class=""input-validation-error""   \n    data-val=""true"" data-val-required=""Please enter your phone number"" id=""Phone""  \n    name=""Phone"" value="""">\n50 chapter  3 Your first ASP.NET Core application \nI have highlighted the difference: the asp-for  tag helper attribute added the input  \nelement to a class called input-validation-error . I can take advantage of this fea-\nture by creating a stylesheet that contains CSS styles for this class and the others that \ndifferent HTML helper attributes use.\nThe convention in ASP.NET Core projects is that static content is placed into the \nwwwroot  folder and organized by content type so that CSS stylesheets go into the www-\nroot/css  folder, JavaScript files go into the wwwroot/js  folder, and so on. \nTIP    The project template used in listing 3.1 creates a site.css  file in the  \nwwwroot/css  folder. You can ignore this file, which I don’t use in this chapter.\nIf you are using Visual Studio, right-click the wwwroot/css  folder and select Add > \nNew Item from the pop-up menu. Locate the Style Sheet item template, as shown in \nfigure 3.8; set the name of the file to styles.css ; and click the Add button. \nFigure 3.8    Creating a CSS stylesheet\nIf you are using Visual Studio Code, right-click the wwwroot/css  folder, select New File \nfrom the pop-up menu, and use styles.css  as the file name. Regardless of which edi-\ntor you use, replace the contents of the file with the styles shown in listing 3.20.\nListing 3.20    The contents of the styles.css file in the wwwroot/css folder\n.field-validation-error {\n    color: #f00;\n}\n.field-validation-valid {\n    display: none;\n}\n.input-validation-error {\n    border: 1px solid #f00;\n    background-color: #fee;\n}\n.validation-summary-errors {",9441
36-3.2.10 Styling the content.pdf,36-3.2.10 Styling the content,"51 Creating the project \n    font-weight: bold;\n    color: #f00;\n}\n.validation-summary-valid {\n    display: none;\n}\nTo apply this stylesheet, I added a link  element to the head  section of the RsvpForm  \nview, as shown in listing 3.21. \nListing 3.21    Applying a stylesheet in the RsvpForm.cshtml file in the Views/Home \nfolder\n...\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>RsvpForm</title>\n    <link rel=""stylesheet"" href=""/css/styles.css"" />\n</head>\n...\nThe link  element uses the href  attribute to specify the location of the stylesheet. \nNotice that the wwwroot  folder is omitted from the URL. The default configuration for \nASP.NET includes support for serving static content, such as images, CSS stylesheets, \nand JavaScript files, and it maps requests to the wwwroot  folder automatically. With the \napplication of the stylesheet, a more obvious validation error will be displayed when \ndata is submitted that causes a validation error, as shown in figure 3.9.\nFigure 3.9    Automatically highlighted validation errors\n3.2.10  Styling the content\nAll the functional goals for the application are complete, but the overall appearance \nof the application is poor. When you create a project using the mvc template, as I did \nfor the example in this chapter, some common client-side development packages are \n52 chapter  3 Your first ASP.NET Core application \ninstalled. While I am not a fan of using template projects, I do like the client-side librar-\nies that Microsoft has chosen. One of them is called Bootstrap, which is a good CSS \nframework originally developed by Twitter that has become a major open-source proj-\nect and a mainstay of web application development. \nstyling  the welcome  view\nThe basic Bootstrap features work by applying classes to elements that correspond to \nCSS selectors defined in the files added to the wwwroot/lib/bootstrap  folder. You \ncan get full details of the classes that Bootstrap defines from http://getbootstrap.com , \nbut you can see how I have applied some basic styling to the Index.cshtml  view file in \nlisting 3.22.\nListing 3.22    Adding Bootstrap to the Index.cshtml file in the Views/Home folder\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <link rel=""stylesheet"" href=""/lib/bootstrap/dist/css/bootstrap.css"" />\n    <title>Index</title>\n</head>\n<body>\n    <div class=""text-center m-2"">\n        <h3> We're going to have an exciting party!</h3>\n        <h4>And YOU are invited!</h4>\n        <a class=""btn btn-primary"" asp-action=""RsvpForm"">RSVP Now</a>\n    </div>\n</body>\n</html>\nI have added a link  element whose href  attribute loads the bootstrap.css  file from \nthe wwwroot/lib/bootstrap/dist/css  folder. The convention is that third-party \nCSS and JavaScript packages are installed into the wwwroot/lib  folder, and I describe \nthe tool that is used to manage these packages in chapter 4.\nHaving imported the Bootstrap stylesheets, I need to style my elements. This is a \nsimple example, so I need to use only a small number of Bootstrap CSS classes: text-\ncenter , btn, and btn-primary .\nThe text-center  class centers the contents of an element and its children. The \nbtn class styles a button , input , or a element as a pretty button, and the btn-primary \nclass  specifies which of a range of colors I want the button to be. You can see the effect \nby running the application, as shown in figure 3.10.\n 53 Creating the project \nFigure 3.10    \nStyling a view\nIt will be obvious to you that I am not a web designer. In fact, as a child, I was excused \nfrom art lessons on the basis that I had absolutely no talent whatsoever. This had the \nhappy result of making more time for math lessons but meant that my artistic skills \nhave not developed beyond those of the average 10-year-old. For a real project, I would \nseek a professional to help design and style the content, but for this example, I am \ngoing it alone, and that means applying Bootstrap with as much restraint and consis-\ntency as I can muster.\nstyling  the form view\nBootstrap defines classes that can be used to style forms. I am not going to go into \ndetail, but you can see how I have applied these classes in listing 3.23.\nListing 3.23    Adding styles to the RsvpForm.cshtml file in the Views/Home folder\n@model PartyInvites.Models.GuestResponse\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>RsvpForm</title>\n    <link rel=""stylesheet"" href=""/lib/bootstrap/dist/css/bootstrap.css"" />\n    <link rel=""stylesheet"" href=""/css/styles.css"" />\n</head>\n<body>\n    <h5 class=""bg-primary text-white text-center m-2 p-2"">RSVP</h5>\n    <form asp-action=""RsvpForm"" method=""post"" class=""m-2"">\n        <div asp-validation-summary=""All""></div>\n        <div class=""form-group"">\n            <label asp-for=""Name"" class=""form-label"">Your name:</label>\n            <input asp-for=""Name"" class=""form-control"" />\n        </div>\n        <div class=""form-group"">\n            <label asp-for=""Email"" class=""form-label"">Your email:</label>\n            <input asp-for=""Email""  class=""form-control"" />\n        </div>\n        <div class=""form-group"">\n54 chapter  3 Your first ASP.NET Core application \n            <label asp-for=""Phone"" class=""form-label"">Your phone:</label>\n            <input asp-for=""Phone"" class=""form-control"" />\n        </div>\n        <div class=""form-group"">\n            <label asp-for=""WillAttend"" class=""form-label"">\n                Will you attend?\n            </label>\n            <select asp-for=""WillAttend"" class=""form-select"">\n                <option value="""">Choose an option</option>\n                <option value=""true"">Yes, I'll be there</option>\n                <option value=""false"">No, I can't come</option>\n            </select>\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-3"">\n            Submit RSVP\n        </button>\n    </form>\n</body>\n</html>\nThe Bootstrap classes in this example create a header, just to give structure to the lay-\nout. To style the form, I have used the form-group  class, which is used to style the \nelement that contains the label  and the associated input  or select  element, which \nis assigned to the form-control  class. You can see the effect of the styles in figure 3.11.\nFigure 3.11    \nStyling the \nRsvpForm view\nstyling  the thanks  view\nThe next view file to style is Thanks.cshtml , and you can see how I have done this in \nlisting 3.24, using CSS classes that are similar to the ones I used for the other views. To \nmake an application easier to manage, it is a good principle to avoid duplicating code \nand markup wherever possible. ASP.NET Core provides several features to help reduce \nduplication, which I describe in later chapters. These features include Razor layouts \n(Chapter 22), partial views (Chapter 22), and view components (Chapter 24).\n 55 Creating the project \nListing 3.24    Applying styles to the Thanks.cshtml file in the Views/Home folder\n@model PartyInvites.Models.GuestResponse\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Thanks</title>\n        <link rel=""stylesheet"" \n            href=""/lib/bootstrap/dist/css/bootstrap.css"" />\n</head>\n<body class=""text-center"">\n    <div>\n        <h1>Thank you, @Model?.Name!</h1>\n        @if (Model?.WillAttend == true) {\n            @:It's great that you're coming. \n            @:The drinks are already in the fridge!\n        } else {\n            @:Sorry to hear that you can't make it, \n            @:but thanks for letting us know.\n        }\n    </div>\n    Click <a asp-action=""ListResponses"">here</a> to see who is coming.\n</body>\n</html>\nFigure 3.12 shows the effect of the styles.\nFigure 3.12    Styling the Thanks view\nstyling  the list view \nThe final view to style is ListResponses , which presents the list of attendees. Styling \nthe content follows the same approach as used for the other views, as shown in listing \n3.25.\n56 chapter  3 Your first ASP.NET Core application \nListing 3.25    Adding styles to the ListResponses.cshtml file in the Views/Home folder\n@model IEnumerable<PartyInvites.Models.GuestResponse>\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Responses</title>\n    <link rel=""stylesheet"" href=""/lib/bootstrap/dist/css/bootstrap.css"" />\n</head>\n<body>\n    <div class=""text-center p-2"">\n        <h2 class=""text-center"">\n            Here is the list of people attending the party\n        </h2>\n        <table class=""table table-bordered table-striped table-sm"">\n            <thead>\n                <tr><th>Name</th><th>Email</th><th>Phone</th></tr>\n            </thead>\n            <tbody>\n                @foreach (PartyInvites.Models.GuestResponse r in Model!) {\n                    <tr>\n                        <td>@r.Name</td>\n                        <td>@r.Email</td>\n                        <td>@r.Phone</td>\n                    </tr>\n                }\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nFigure 3.13 shows the way that the table of attendees is presented. Adding these styles \nto the view completes the example application, which now meets all the development \ngoals and has an improved appearance. \nFigure 3.13    \nStyling the \nListResponses \nview",9639
37-4.1 Creating ASP.NET Core projects.pdf,37-4.1 Creating ASP.NET Core projects,"57 Summary\nSummary\n¡ ASP.NET Core projects are created with the dotnet new  command.\n¡ Controllers define action methods that are used to handle HTTP requests.\n¡ Views generate HTML content that is used to respond to HTTP requests.\n¡ Views can contain HTML elements that are bound to data model properties.\n¡ Model binding is the process by which request data is parsed and assigned to the \nproperties of objects that are passed to action methods for processing.\n¡ The data in the request can be subjected to validation and errors can be dis-\nplayed to the user within the same HTML form that was used to submit the data.\n¡ The HTML content generated by views can be styled using the same CSS features \nthat are applied to static HTML content.\n584Using the  \ndevelopment tools\nThis chapter covers\n¡ Using command-line tools to create an ASP.NET  \n Core project\n¡ Adding code and content to a project\n¡ Building and running an ASP.NET Core project\n¡ Using the hot reload feature\n¡ Installing NuGet packages\n¡ Installing tool packages\n¡ Installing client-side packages\n¡ Using the debugger\nIn this chapter, I introduce the tools that Microsoft provides for ASP.NET Core \ndevelopment and that are used throughout this book. \nUnlike earlier editions of this book, I rely on the command-line tools provided by \nthe .NET SDK and additional tool packages that Microsoft publishes. In part, I have \ndone this to help ensure you get the expected results from the examples but also \nbecause the command-line tools provide access to all the features required for ASP.\nNET Core development, regardless of which editor/IDE you have chosen.\nVisual Studio—and, to a lesser extent, Visual Studio Code—offers access to some \nof the tools through user interfaces, which I describe in this chapter, but Visual",1822
38-4.1.1 Creating a project using the command line.pdf,38-4.1.1 Creating a project using the command line,"59 Creating ASP.NET Core projects\nStudio and Visual Studio Code don’t support all the features that are required for ASP.\nNET Core development, so there are times that using the command line is inevitable.\nAs ASP.NET Core has evolved, I have gradually moved to using just the command-line \ntools, except for when I need to use a debugger (although, as I explain later in the chap-\nter, this is a rare requirement). Your preferences may differ, especially if you are used to \nworking entirely within an IDE, but my suggestion is to give the command-line tools a \ngo. They are simple, concise, and predictable, which cannot be said for all the equiva-\nlent functionality provided by Visual Studio and Visual Studio Code. Table 4.1 provides \na guide to the chapter.\nTable 4.1    Chapter guide\nProblem Solution Listing\nCreating a project Use the  dotnet new  commands. 1–3\nBuilding and running \nprojectsUse the dotnet build  and dotnet run  \ncommands.4–10\nAdding packages to a \nprojectUse the dotnet add package  command. 11, 12\nInstalling tool commands Use the  dotnet tool  command. 14, 15\nManaging client-side \npackagesUse the libman  command or the Visual Studio \nclient-side package manager.16–19\n4.1 Creating ASP .NET Core projects\nThe .NET SDK includes a set of command-line tools for creating, managing, build-\ning, and running projects. Visual Studio provides integrated support for some of \nthese tasks, but if you are using Visual Studio Code, then the command line is the only \noption.\nI use the command-line tools throughout this book because they are simple and con-\ncise. The Visual Studio integrated support is awkward and makes it easy to uninten-\ntionally create a project with the wrong configuration, as the volume of emails from \nconfused readers of earlier editions of this book has demonstrated.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\n4.1.1 Creating a project using the command line\nThe dotnet  command provides access to the .NET command-line features. The  \ndotnet new  command is used to create a new project, configuration file, or solution \nfile. To see the list of templates available for creating new items, open a PowerShell \ncommand prompt and run the command shown in listing 4.1. \n60 chapter  4 Using the development tools \nListing 4.1    Listing the .NET templates\ndotnet new --list\nEach template has a short name that makes it easier to use. There are many templates \navailable, but table 4.2 describes the ones that are most useful for creating ASP.NET \nCore projects.  \nTable 4.2    Useful ASP .NET Core project templates\nName Description\nweb This template creates a project that is set up with the minimum code \nand content required for ASP.NET Core development. This is the tem -\nplate I use for most of the chapters in this book.\nmvc This template creates an ASP.NET Core project configured to use the \nMVC Framework.\nwebapp This template creates an ASP.NET Core project configured to use Razor \nPages.\nblazorserver This template creates an ASP.NET Core project configured to use \nBlazor Server.\nangular This template creates an ASP.NET Core project that contains cli-\nent-side features using the Angular JavaScript framework.\nreact This template creates an ASP.NET Core project that contains cli-\nent-side features using the React JavaScript framework.\nreactredux This template creates an ASP.NET Core project that contains cli-\nent-side features using the React JavaScript framework and the popu-\nlar Redux library.\nThere are also templates that create commonly required files used to configure proj-\nects, as described in table 4.3.\nUnderstanding the limitations of project templates\nThe project templates described in table 4.2 are intended to help jump-start develop-\nment by taking care of basic configuration settings and adding placeholder content.  \nThese templates can give you a sense of rapid progress, but they contain assumptions \nabout how a project should be configured and developed. If you don’t understand the \nimpact of those assumptions, you won’t be able to get the results you require for the spe -\ncific demands of your project.\nThe web template creates a project with the minimum configuration required for ASP.\nNET Core development. This is the project template I use for most of the examples in this \nbook so that I can explain how each feature is configured and how the features can be \nused together.\nOnce you understand how ASP.NET Core works, the other project templates can be use-\nful because you will know how to adapt them to your needs. But, while you are learning, \nI recommend sticking to the web template, even though it can take a little more effort to \nget results.\n 61 Creating ASP.NET Core projects\nTable 4.3    The configuration item templates\nName Description\nglobaljson This template adds a  global.json  file to a project, \nspecifying the version of .NET that will be used.\nsln This template creates a solution file, which is used to \ngroup multiple projects and is commonly used by Visual \nStudio. The solution file is populated with the  dotnet \nsln add  command, as shown in listing 4.2. \ngitignore This template creates a  .gitignore  file that excludes \nunwanted items from Git source control.\nTo create a project, open a new PowerShell command prompt and run the commands \nshown in listing 4.2.  \nListing 4.2    Creating a new project \ndotnet new globaljson --sdk-version 7.0.100 --output MySolution/MyProject\ndotnet new web --no-https --output MySolution/MyProject --framework net7.0\ndotnet new sln -o MySolution\ndotnet sln MySolution add MySolution/MyProject \nThe first command creates a MySolution/MyProject  folder that contains a global \n.json  file, which specifies that the project will use .NET version 7. The top-level folder, \nnamed MySolution , is used to group multiple projects. The nested MyProject  folder \nwill contain a single project.\nI use the globaljson  template to help ensure you get the expected results when \nfollowing the examples in this book. Microsoft is good at ensuring backward compat-\nibility with .NET releases, but breaking changes do occur, and it is a good idea to add \na global.json  file to projects so that everyone in the development team is using the \nsame version.\nThe second command creates the project using the web template, which I use for \nmost of the examples in this book. As noted in table 4.3, this template creates a project \nwith the minimum content required for ASP.NET Core development. Each template \nhas its own set of arguments that influence the project that is created. The --no-https  \nargument creates a project without support for HTTPS. (I explain how to use HTTPS \nin chapter 16.) The --framework  argument selects the .NET runtime that will be used \nfor the project.\nThe other commands create a solution file that references the new project. Solu-\ntion files are a convenient way of opening multiple related files at the same time.  \nA MySolution.sln  file is created in the MySolution  folder, and opening this file in \nVisual Studio will load the project created with the web template. This is not essential, \nbut it stops Visual Studio from prompting you to create the file when you exit the code \neditor. \nopening  the project  \nTo open the project, start Visual Studio, select Open a Project or Solution, and open \nthe MySolution.sln  file in the MySolution  folder. Visual Studio will open the",7684
39-4.2 Adding code and content to projects.pdf,39-4.2 Adding code and content to projects,"62 chapter  4 Using the development tools \nsolution file, discover the reference to the project that was added by the final com-\nmand in listing 4.2, and open the project as well.  \nVisual Studio Code works differently. Start Visual Studio Code, select File > Open \nFolder, and navigate to the MySolution  folder. Click Select Folder, and Visual Studio \nCode will open the project. \nAlthough Visual Studio Code and Visual Studio are working with the same project, \neach displays the contents differently. Visual Studio Code shows you a simple list of files, \nordered alphabetically, as shown on the left of figure 4.1. Visual Studio hides some files \nand nests others within related file items, as shown on the right of figure 4.1. \nFigure 4.1    Opening a project in Visual Studio Code and Visual Studio\nThere are buttons at the top of the Visual Studio Solution Explorer that disable file \nnesting and show the hidden items in the project. When you open a project for the \nfirst time in Visual Studio Code, you may be prompted to add assets for building and \ndebugging the project. Click the Yes button.\n4.2 Adding code and content to projects\nIf you are using Visual Studio Code, then you add items to the project by right-clicking \nthe folder that should contain the file and selecting New File from the pop-up menu \n(or selecting New Folder if you are adding a folder). \nNOTE    You are responsible for ensuring that the file extension matches the type \nof item you want to add; for example, an HTML file must be added with the \n.html  extension. I give the complete file name and the name of the containing \nfolder for every item added to a project throughout this book, so you will always \nknow exactly what files you need to add.\n 63 Adding code and content to projects\nRight-click the My Project item in the list of files and select New Folder from the pop-up \nmenu. Set the name to wwwroot , which is where static content is stored in ASP.NET \nCore projects. Press Enter, and a folder named wwwroot  will be added to the project. \nRight-click the new wwwroot  folder, select New File, and set the name to demo.html . \nPress Enter to create the HTML file and add the content shown in listing 4.3. \nListing 4.3    The contents of the demo.html file in the wwwroot folder\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=""utf-8"" />\n    <title></title>\n</head>\n<body>\n    <h3>HTML File from MyProject</h3>\n</body>\n</html>\nVisual Studio provides a more comprehensive approach that can be helpful, but only \nwhen used selectively. To create a folder, right-click the MyProject item in the Solution \nExplorer and select Add > New Folder from the pop-up menu. Set the name of the new \nitem to wwwroot  and press Enter; Visual Studio will create the folder. \nRight-click the new wwwroot item in the Solution Explorer and select Add > New \nItem from the pop-up menu. Visual Studio will present you with an extensive selection \nof templates for adding items to the project. These templates can be searched using the \ntext field in the top-right corner of the window or filtered using the categories on the \nleft of the window. The item template for an HTML file is named HTML Page, as shown \nin figure 4.2.\nFigure 4.2    Adding an item to the example project \nEnter demo.html  in the Name field, click the Add button to create the new file, and \nreplace the contents with the element shown in listing 4.3. (If you omit the file exten-\nsion, Visual Studio will add it for you based on the item template you have selected. \nIf you entered just demo  into the Name field when you created the file, Visual Studio",3661
40-4.2.1 Understanding item scaffolding.pdf,40-4.2.1 Understanding item scaffolding,,0
41-4.3 Building and running projects.pdf,41-4.3 Building and running projects,"64 chapter  4 Using the development tools \nwould have created a file with the .html  extension because you had selected the \nHTML Page item template.)\n4.2.1 Understanding item scaffolding\nThe item templates presented by Visual Studio can be useful, especially for C# classes \nwhere it sets the namespace and class name automatically. But Visual Studio also pro-\nvides scaffolded items , which I recommend against using. The Add > New Scaffolded \nItem leads to a selection of items that guide you through a process to add more com-\nplex items. Visual Studio will also offer individual scaffolded items based on the name \nof the folder that you are adding an item to. For example, if you right-click a folder \nnamed Views , Visual Studio will helpfully add scaffolded items to the top of the menu, \nas shown in figure 4.3.  \nFigure 4.3    Scaffolded items in the Add menu\nThe View  and Controller  items are scaffolded, and selecting them will present you \nwith choices that determine the content of the items you create.\nJust like the project templates, I recommend against using scaffolded items, at least \nuntil you understand the content they create. In this book, I use only the Add > New \nItem menu for the examples and change the placeholder content immediately.\n4.3 Building and running projects\nThe simplest way to build and run a project is to use the command-line tools. To \nprepare, add the statement shown in listing 4.4 to the Program.cs  class file in the \nMyProject  folder.  \n 65 Building and running projects\nListing 4.4    Adding a statement in the Program.cs file in the MyProject folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""/"", () => ""Hello World!"");\napp.UseStaticFiles();\napp.Run();\nThis statement adds support for responding to HTTP requests with static content in \nthe wwwroot  folder, such as the HTML file created in the previous section. (I explain \nthis feature in more detail in chapter 15.)\nNext, set the HTTP port that ASP.NET Core will use to receive HTTP requests, as \nshown in listing 4.5.\nListing 4.5    Setting the HTTP port in the launchSettings.json file in the Properties  \n  folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""MyProject"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nTo build the example project, run the command shown in listing 4.6 in the MyProject  \nfolder. \nListing 4.6    Building the project \ndotnet build",3034
42-4.3.1 Using the hot reload feature.pdf,42-4.3.1 Using the hot reload feature,"66 chapter  4 Using the development tools \nYou can build and run the project in a single step by running the command shown in \nlisting 4.7 in the MyProject  folder. \nListing 4.7    Building and running the project \ndotnet run\nThe compiler will build the project and then start the integrated ASP.NET Core HTTP \nserver to listen for HTTP requests on port 5000. You can see the contents of the static \nHTML file added to the project earlier in the chapter by opening a new browser win-\ndow and requesting http://localhost:5000/demo.html, which produces the response \nshown in figure 4.4.\nFigure 4.4    Running the example application  \n4.3.1 Using the hot reload feature \n.NET has an integrated hot reload feature, which compiles and applies updates to \napplications on the fly. For ASP.NET Core applications, this means that changes to the \nproject are automatically reflected in the browser without having to manually stop the \nASP.NET Core application and use the dotnet run  command. Use Control+C to stop \nASP.NET Core if the application is still running from the previous section and run the \ncommand shown in listing 4.8 in the MyProject  folder.\nListing 4.8    Starting the application with hot reload\ndotnet watch\nThe dotnet watch  command opens a new browser window, which it does to ensure \nthat the browser loads a small piece of JavaScript that opens an HTTP connection to \nthe server that is used to handle reloading. (The new browser window can be disabled \nby setting the launchBrowser  property shown in listing 4.5 to false , but you will have \nto perform a manual reload the first time you start or restart ASP.NET Core.) Use \nthe browser to request http://localhost:5000/demo.html, and you will see the output \nshown on the left of figure 4.5.\nThe dotnet watch  command monitors the project for changes. When a change is \ndetected, the project is automatically recompiled, and the browser is reloaded. To see \nthis process in action, make the change shown in listing 4.9 to the demo.html  file in the \nwwwroot  folder.\n 67 Building and running projects\nListing 4.9    Changing the message in the demo.html file in the wwwroot folder\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=""utf-8"" />\n    <title></title>\n</head>\n<body>\n    <h3>New Message</h3>\n</body>\n</html>\nWhen you save the changes to the HTML file, the dotnet watch  tool will detect the \nchange and automatically update the browser, as shown in figure 4.5.\nFigure 4.5    The hot reload feature\nThe dotnet watch  command is a clever feat of engineering, and it has good sup-\nport for ASP.NET Core applications, allowing changes to be easily applied. But not all \nchanges can be handled with a hot reload.\nIf you are using Visual Studio, right-click the MyProject item in the Solution Explorer, \nselect Add > Class from the pop-up menu, and set the name of the new class file to \nMyClass.cs . When Visual Studio opens the file for editing, change the namespace as \nshown in listing 4.10.\nListing 4.10    Changing a namespace in the MyClass.cs file in the MyProject folder\nnamespace MyProject.MyNamespace {\n    public class MyClass {\n    }\n}\nIf you are using Visual Studio Code, add a file named MyClass.cs  to the MyProject  \nfolder with the content shown in listing 4.10. \nRegardless of which editor you use, you will see output similar to the following when \nyou save the class file:\nwatch : File changed: C:\MySolution\MyProject\MyClass.cs.\nwatch : Unable to apply hot reload because of a rude edit.\nThere are some changes that the dotnet watch  command can’t handle with a hot \nreload and the application is restarted instead. You may be prompted to accept the \nrestart. The restart has little effect on the example application, but it means that the \napplication state is lost, which can be frustrating when working on real projects.",3885
43-4.4 Managing packages.pdf,43-4.4 Managing packages,,0
44-4.4.2 Managing tool packages.pdf,44-4.4.2 Managing tool packages,"68 chapter  4 Using the development tools \nBut even though it isn’t perfect, the hot reload feature is useful, especially when it \ncomes to iterative adjustments to the HTML an application produces. I don’t use it in \nmost of the chapters in this book because the examples require many changes that are \nnot handled with hot reloads and that can prevent changes from taking effect, but I do \nuse it for my own non-book related development projects.\n4.4 Managing packages\nMost projects require additional features beyond those set up by the project templates, \nsuch as support for accessing databases or for making HTTP requests, neither of which \nis included in the standard ASP.NET Core packages added to the project by the tem-\nplate used to create the example project. In the sections that follow, I describe the tools \navailable to manage the different types of packages that are used in ASP.NET Core \ndevelopment.\n4.4.1 Managing NuGet packages\n.NET packages are added to a project with the dotnet add package  command. Use \na PowerShell command prompt to run the command shown in listing 4.11 in the \nMyProject  folder to add a package to the example project.  \nListing 4.11    Adding a package to the example project\ndotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 7.0.0\nThis command installs version 7.0.0 of the Microsoft.EntityFrameworkCore \n.SqlServer  package. The package repository for .NET projects is nuget.org , where \nyou can search for the package and see the versions available. The package installed in \nlisting 4.11, for example, is described at https://www.nuget.org/packages/Microsoft \n.EntityFrameworkCore.SqlServer/7.0.0 . You can see the packages installed in a project \nby running the command shown in listing 4.12.  \nTIP    The project file—which is the file with the .csproj  extension—is used \nto keep track of the packages added to a project. You can examine this file by \nopening it for editing in Visual Studio Code or by right-clicking the project item \nin the Visual Studio Solution Explorer and selecting Edit Project File from the \npop-up menu.\nListing 4.12    Listing the packages in a project \ndotnet list package \nThis command produces the following output when it is run in the MyProject  folder, \nshowing the package added in listing 4.11:\nProject 'MyProject' has the following package references\n   [net7.0]:\n   Top-level Package                              Requested   Resolved\n   > Microsoft.EntityFrameworkCore.SqlServer      7.0.0       7.0.0",2548
45-4.4.3 Managing client-side packages.pdf,45-4.4.3 Managing client-side packages,"69 Managing packages\nPackages are removed with the dotnet remove package  command. To remove the \npackage from the example project, run the command shown in listing 4.13 in the \nMyProject  folder. \nListing 4.13    Removing a package from the example project \ndotnet remove package Microsoft.EntityFrameworkCore.SqlServer\n4.4.2 Managing tool packages \nTool packages install commands that can be used from the command line to perform \noperations on .NET projects. One common example is the Entity Framework Core \ntools package that installs commands that are used to manage databases in ASP.NET \nCore projects. Tool packages are managed using the dotnet tool  command. To install \nthe Entity Framework Core tools package, run the commands shown in listing 4.14.  \nListing 4.14    Installing a tool package \ndotnet tool uninstall --global dotnet-ef\ndotnet tool install --global dotnet-ef --version 7.0.0\nThe first command removes the dotnet-ef  package, which is named dotnet-ef . This \ncommand will produce an error if the package has not already been installed, but it \nis a good idea to remove existing versions before installing a package. The dotnet \ntool install  command installs version 7.0.0 of the dotnet-ef  package, which is the \nversion I use in this book. The commands installed by tool packages are used through \nthe dotnet  command. To test the package installed in listing 4.14, run the command \nshown in listing 4.15 in the MyProject  folder.  \nTIP    The --global  arguments in listing 4.14 mean the package is installed for \nglobal use and not just for a specific project. You can install tool packages into \njust one project, in which case the command is accessed with dotnet tool run \n<command> . The tools I use in this book are all installed globally.\nListing 4.15    Running a tool package command \ndotnet ef --help\nThe commands added by this tool package are accessed using dotnet ef , and you will \nsee examples in later chapters that rely on these commands.\n4.4.3 Managing client-side packages \nClient-side packages contain content that is delivered to the client, such as images, CSS \nstylesheets, JavaScript files, and static HTML. Client-side packages are added to ASP.\nNET Core using the Library Manager (LibMan) tool. To install the LibMan tool pack-\nage, run the commands shown in listing 4.16.  \n70 chapter  4 Using the development tools \nListing 4.16    Installing the LibMan tool package \ndotnet tool uninstall --global Microsoft.Web.LibraryManager.Cli\ndotnet tool install --global Microsoft.Web.LibraryManager.Cli  \n    --version 2.1.175\nThese commands remove any existing LibMan package and install the version that is \nused throughout this book. The next step is to initialize the project, which creates the \nfile that LibMan uses to keep track of the client packages it installs. Run the command \nshown in listing 4.17 in the MyProject  folder to initialize the example project.  \nListing 4.17    Initializing the example project \nlibman init -p cdnjs\nLibMan can download packages from different repositories. The -p argument in list-\ning 4.17 specifies the repository at https://cdnjs.com , which is the most widely used. \nOnce the project is initialized, client-side packages can be installed. To install the Boot-\nstrap CSS framework that I use to style HTML content throughout this book, run the \ncommand shown in listing 4.18 in the MyProject  folder.  \nListing 4.18    Installing the Bootstrap CSS framework \nlibman install bootstrap@5.2.3 -d wwwroot/lib/bootstrap\nThe command installs version 5.2.3 of the Bootstrap package, which is known by the \nname bootstrap  on the CDNJS repository. The -d argument specifies the location \ninto which the package is installed. The convention in ASP.NET Core projects is to \ninstall client-side packages into the wwwroot/lib  folder.\nOnce the package has been installed, add the classes shown in listing 4.19 to the ele-\nments in the demo.html  file. This is how the features provided by the Bootstrap pack-\nage are applied.\nNOTE    I don’t get into the details of using the Bootstrap CSS framework in this \nbook. See https://getbootstrap.com  for the Bootstrap documentation.\nListing 4.19    Applying Bootstrap classes in the demo.html file in the wwwroot folder\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=""utf-8"" />\n    <title></title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h3 class=""bg-primary text-white text-center p-2"">New Message</h3>\n</body>\n</html>",4574
46-5.1.1 Opening the project.pdf,46-5.1.1 Opening the project,"71 Debugging projects \nStart ASP.NET Core and request http://localhost:5000/demo.html, and you will see \nthe styled content shown in figure 4.6.\nFigure 4.6    Using a client-side package \n4.5 Debugging projects \nVisual Studio and Visual Studio Code both provide debuggers that can be used to con-\ntrol and inspect the execution of an ASP.NET Core application. Open the Program.cs  \nfile in the MyProject  folder, and click this statement in the code editor:  \n...\napp.MapGet(""/"", () => ""Hello World!"");\n...\nSelect Debug > Toggle Breakpoint in Visual Studio or select Run > Toggle Breakpoint \nin Visual Studio Code. A breakpoint is shown as a red dot alongside the code state-\nment, as shown in figure 4.7, and will interrupt execution and pass control to the user. \nFigure 4.7    Setting a breakpoint\nStart the project by selecting Debug > Start Debugging in Visual Studio or selecting \nRun > Start Debugging in Visual Studio Code. (Choose .NET if Visual Studio Code \nprompts you to select an environment and then select the Start Debugging menu item \nagain.)\nThe application will be started and continue normally until the statement to which \nthe breakpoint is reached, at which point execution is halted. Execution can be con-\ntrolled using the Debug or Run menu or the controls that Visual Studio and Visual \nStudio Code display. Both debuggers are packed with features—more so if you have \n72 chapter  4 Using the development tools \na paid-for version of Visual Studio—and I don’t describe them in depth in this book. \nThe Visual Studio debugger is described at https://docs.microsoft.com/en-us/visual \nstudio/debugger , and the Visual Studio Code debugger is described at https://code \n.visualstudio.com/docs/editor/debugging .\nHow I debug my code\nDebuggers are powerful tools, but I rarely use them. In most situations, I prefer to add \nConsole.WriteLine  statements to my code to figure out what is going on, which I can \neasily do because I use the dotnet run  command to run my projects from the com-\nmand line. This is a rudimentary approach that works for me, not least because most of \nthe errors in my code tend to be where statements are not being called because a con-\ndition in an if statement isn’t effective. If I want to examine an object in detail, I tend to \nserialize it to JSON and pass the result to the WriteLine  method.\nThis may seem like madness if you are a dedicated user of the debugger, but it has the \nadvantage of being quick and simple. When I am trying to figure out why code isn’t work -\ning, I want to explore and iterate quickly, and I find the amount of time taken to start the \ndebugger to be a barrier. My approach is also reliable. The Visual Studio and Visual Stu-\ndio Code debuggers are sophisticated, but they are not always entirely predictable, and \n.NET and ASP.NET Core change too quickly for the debugger features to have entirely set -\ntled down. When I am utterly confused by the behavior of some code, I want the simplest \npossible diagnostic tool, and that, for me, is a message written to the console.\nI am not suggesting that this is the approach you should use, but it can be a good place to \nstart when you are not getting the results you expect and you don’t want to battle with the \ndebugger to figure out why.\nSummary\n¡ ASP.NET Core projects are created with the dotnet new  command.\n¡ There are templates to jumpstart popular project types and to create common \nproject items.\n¡ The dotnet build  command compiles a project.\n¡ The dotnet run  command builds and executes a project.\n¡ The dotnet watch  command builds and executes a project, and performs hot \nreloading when changes are detected.\n¡ Packages are added to a project with the dotnet add package  command.\n¡ Tool packages are installing using the dotnet tool install  command. \n¡ Client-side packages are managed with the libman  tool package.\n735Essential C# features\nThis chapter covers\n¡ Using C# language features for ASP.NET Core  \n development\n¡ Dealing with null values and the null state  \n analysis feature\n¡ Creating objects concisely\n¡ Adding features to classes without directly  \n modifying them\n¡ Expressing functions concisely\n¡ Modifying interfaces without breaking  \n implementation classes\n¡ Defining asynchronous methods\nIn this chapter, I describe C# features used in web application development that are \nnot widely understood or that often cause confusion. This is not a book about C#, \nhowever, so I provide only a brief example for each feature so that you can follow \nthe examples in the rest of the book and take advantage of these features in your \nprojects. Table 5.1 provides a guide to this chapter.\n74 chapter  5 Essential C# features\nTable 5.1    Chapter guide\nProblem Solution Listing\nReducing duplication in  using  \nstatementsUse global or implicit  using  statements. 8–10\nManaging null values Use nullable and non-nullable types, which \nare managed with the null management \noperators.11–20\nMixing static and dynamic values in strings Use string interpolation.  21\nInitializing and populate objects Use the object and collection initializers and \ntarget-typed new expressions.22–26\nAssigning a value for specific types Use pattern matching. 27, 28\nExtending the functionality of a class with-\nout modifying itDefine an extension method. 29–36\nExpressing functions and methods \nconciselyUse lambda expressions. 37–44\nDefining a variable without explicitly declar -\ning its typeUse the var keyword. 45–47\nModifying an interface without requiring \nchanges in its implementation classesDefine a default implementation.  48–52\nPerforming work asynchronously Use tasks or the  async /await  keywords. 53–55\nProducing a sequence of values over time Use an asynchronous enumerable. 56–59\nGetting the name of a class or member Use a  nameof  expression. 60, 61\n5.1 Preparing for this chapter\nTo create the example project for this chapter, open a new PowerShell command \nprompt and run the commands shown in listing 5.1. If you are using Visual Studio \nand prefer not to use the command line, you can create the project using the process \ndescribed in chapter 4.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 5.1    Creating the example project \ndotnet new globaljson --sdk-version 7.0.100 --output LanguageFeatures\ndotnet new web --no-https --output LanguageFeatures --framework net7.0\ndotnet new sln -o LanguageFeatures\ndotnet sln LanguageFeatures add LanguageFeatures",6741
47-5.1.2 Enabling the MVC Framework.pdf,47-5.1.2 Enabling the MVC Framework,,0
48-5.1.3 Creating the application components.pdf,48-5.1.3 Creating the application components,"75 Preparing for this chapter\n5.1.1 Opening the project \nIf you are using Visual Studio, select File > Open > Project/Solution, select the  \nLanguageFeatures.sln  file in the LanguageFeatures  folder, and click the Open \nbutton to open the solution file and the project it references. If you are using Visual \nStudio Code, select File > Open Folder, navigate to the LanguageFeatures  folder, and \nclick the Select Folder button.\n5.1.2 Enabling the MVC Framework\nThe web project template creates a project that contains a minimal ASP.NET Core \nconfiguration. This means the placeholder content that is added by the mvc template \nused in chapter 3 is not available and that extra steps are required to reach the point \nwhere the application can produce useful output. In this section, I make the changes \nrequired to set up the MVC Framework, which is one of the application frameworks \nsupported by ASP.NET Core, as I explained in chapter 1. First, to enable the MVC \nframework, make the changes shown in listing 5.2 to the Program.cs  file. \nListing 5.2    Enabling MVC in the Program.cs file in the LanguageFeatures folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nvar app = builder.Build();\n//app.MapGet( ""/"", () => ""Hello World!"");\napp.MapDefaultControllerRoute();\napp.Run();\nI explain how to configure ASP.NET Core applications in part 2, but the two state-\nments added in listing 5.2 provide a basic MVC framework setup using a default \nconfiguration.\n5.1.3 Creating the application components \nNow that the MVC framework is set up, I can add the application components that  \nI will use to demonstrate important C# language features. As you create these compo-\nnents, you will see that the code editor underlines some expressions to warn you of \npotential problems. These are safe to ignore until the “Understanding Null State Anal-\nysis” section, where I explain their significance.\ncreating  the data model\nI started by creating a simple model class so that I can have some data to work with. \nI added a folder called Models  and created a class file called Product.cs  within it, \nwhich I used to define the class shown in listing 5.3.\n76 chapter  5 Essential C# features\nListing 5.3    The contents of the Product.cs file in the Models folder \nnamespace LanguageFeatures.Models {\n    public class Product {\n        public string Name { get; set; }\n        public decimal? Price { get; set; }\n        public static Product[] GetProducts() {\n            Product kayak = new Product { \n                Name = ""Kayak"", Price = 275M \n            };\n            Product lifejacket = new Product { \n                Name = ""Lifejacket"", Price = 48.95M \n            };\n            return new Product[] { kayak, lifejacket, null };\n        }\n    }\n}\nThe Product  class defines Name  and Price  properties, and there is a static  method \ncalled GetProducts  that returns a Product  array. One of the elements contained \nin the array returned by the GetProducts  method is set to null , which I will use to \ndemonstrate some useful language features later in the chapter. \nThe Visual Studio and Visual Studio Code editors will highlight a problem with the \nName  property. This is a deliberate error that I explain later in the chapter and which \nshould be ignored for now.\ncreating  the controller  and view\nFor the examples in this chapter, I use a simple controller class to demonstrate differ-\nent language features. I created a Controllers  folder and added to it a class file called \nHomeController.cs , the contents of which are shown in listing 5.4. \nListing 5.4    The contents of the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            return View(new string[] { ""C#"", ""Language"", ""Features"" });\n        }\n    }\n}\nThe Index  action method tells ASP.NET Core to render the default view and provides \nit with an array of strings as its view model, which will be included in the HTML sent \nto the client. To create the view, I added a Views/Home  folder (by creating a Views",4270
49-5.1.5 Running the example application.pdf,49-5.1.5 Running the example application,"77 Preparing for this chapter\nfolder and then adding a Home  folder within it) and added a Razor View called Index \n.cshtml , the contents of which are shown in listing 5.5.\nListing 5.5    The contents of the Index.cshtml file in the Views/Home folder \n@model IEnumerable<string>\n@{ Layout = null; }\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Language Features</title>\n</head>\n<body>\n    <ul>\n        @foreach (string s in Model) {\n            <li>@s</li>\n        }\n    </ul>\n</body>\n</html>\nThe code editor will highlight part of this file to denote a warning, which I explain \nshortly.\n5.1.4 Selecting the HTTP port\nChange the HTTP port that ASP.NET Core uses to receive requests, as shown in listing \n5.6.\nListing 5.6    Setting the HTTP port in the launchSettings.json file in the Properties  \n folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""LanguageFeatures"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",",1437
50-5.4.1 Ensuring fields and properties are assigned values.pdf,50-5.4.1 Ensuring fields and properties are assigned values,"78 chapter  5 Essential C# features\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\n5.1.5 Running the example application \nStart ASP.NET Core by running the command shown in listing 5.7 in the Language-\nFeatures  folder.\nListing 5.7    Running the example application \ndotnet run\nThe output from the dotnet run  command will include two build warnings, which I \nexplain in the “Understanding Null State Analysis” section. Once ASP.NET Core has \nstarted, use a web browser to request http://localhost:5000, and you will see the out-\nput shown in figure 5.1.\nFigure 5.1    Running the example application \nSince the output from all the examples in this chapter is text, I will show the messages \ndisplayed by the browser like this:\nC# \nLanguage \nFeatures\n5.2 Understanding top-level statements\nTop-level statements are intended to remove unnecessary code structure from class \nfiles. A project can contain one file that defines code statements outside of a name-\nspace or a file. For ASP.NET Core applications, this feature is used to configure the \napplication in the Program.cs  file. Here is the content of the Program.cs  file in the \nexample application for this chapter:\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\n 79 Understanding global using statements\nvar app = builder.Build();\n//app.MapGet(""/"", () => ""Hello World!"");\napp.MapDefaultControllerRoute();\napp.Run();\nIf you have used earlier versions of ASP.NET Core, you will be familiar with the Startup  \nclass, which was used to configure the application. Top-level statements have allowed \nthis process to be simplified, and all of the configuration statements are now defined \nin the Program.cs  file. \nThe compiler will report an error if there is more than one file in a project with top-\nlevel statements, so the Program.cs  file is the only place you will find them in an ASP.\nNET Core project. \n5.3 Understanding global using statements\nC# supports global using  statements, which allow a using  statement to be defined \nonce but take effect throughout a project. Traditionally, each code file contains a series \nof using  statements that declare dependencies on the namespaces that it requires. \nListing 5.8 adds a using  statement that provides access to the types defined in the \nModels  namespace. (The code editor will highlight part of this code listing, which I \nexplain in the “Understanding Null State Analysis” section.) \nListing 5.8    Adding a statement in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing LanguageFeatures.Models;\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product[] products = Product.GetProducts();\n            return View(new string[] { products[0].Name });\n        }\n    }\n}\nTo access the Product  class, I added a using  statement for the namespace that con-\ntains it, which is LanguageFeatures.Models . The code file already contains a using  \nstatement for the Microsoft.AspNetCore.Mvc  namespace, which provides access to \nthe Controller  class, from which the HomeController  class is derived. \nIn most projects, some namespaces are required throughout the application, such as \nthose containing data model classes. This can result in a long list of using  statements, \nduplicated in every code file. Global using  statements address this problem by allowing \nusing  statements for commonly required namespaces to be defined in a single loca-\ntion. Add a code file named GlobalUsings.cs  to the LanguageFeatures  project with \nthe content shown in listing 5.9.\n80 chapter  5 Essential C# features\nListing 5.9    The contents of the GlobalUsings.cs file in the LanguageFeatures folder\nglobal using LanguageFeatures.Models;\nglobal using Microsoft.AspNetCore.Mvc;\nThe global  keyword is used to denote a global using . The statements in listing 5.9 \nmake the LanguageFeatures.Models  and Microsoft.AspNetCore.Mvc  namespaces \navailable throughout the application, which means they can be removed from the \nHomeController.cs  file, as shown in listing 5.10.\nListing 5.10    Removing statements in the HomeController.cs file in the Controllers folder\n//using Microsoft.AspNetCore.Mvc;\n//using LanguageFeatures.Models;\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product[] products = Product.GetProducts();\n            return View(new string[] { products[0].Name });\n        }\n    }\n}\nIf you run the example, you will see the following results displayed in the browser \nwindow:\nKayak\nYou will receive warnings when compiling the project, which I explain in the “Under-\nstanding Null State Analysis” section. \nNOTE     Global using  statements are a good idea, but I have not used them in \nthis book because I want to make it obvious when I add a dependency to a new \nnamespace.\n5.3.1 Understanding implicit using statements\nThe ASP.NET Core project templates enable a feature named implicit usings , which \ndefine global using  statements for these commonly required namespaces:\n¡ System\n¡ System.Collections.Generic\n¡ System.IO\n¡ System.Linq\n¡ System.Net.Http\n¡ System.Net.Http.Json\n¡ System.Threading\n¡ System.Threading.Tasks\n 81 Understanding null state analysis\n¡ Microsoft.AspNetCore.Builder\n¡ Microsoft.AspNetCore.Hosting\n¡ Microsoft.AspNetCore.Http\n¡ Microsoft.AspNetCore.Routing\n¡ Microsoft.Extensions.Configuration\n¡ Microsoft.Extensions.DependencyInjection\n¡ Microsoft.Extensions.Hosting\n¡ Microsoft.Extensions.Logging\nusing  statements are not required for these namespaces, which are available through-\nout the application. These namespaces don’t cover all of the ASP.NET Core features, \nbut they do cover the basics, which is why no explicit using  statements are required in \nthe Program.cs  file.\n5.4 Understanding null state analysis\nThe editor and compiler warnings shown in earlier sections are produced because \nASP.NET Core project templates enable null state analysis , in which the compiler iden-\ntifies attempts to access references that may be unintentionally null, preventing null \nreference exceptions at runtime.\nOpen the Product.cs  file, and the editor will display two warnings, as shown in fig-\nure 5.2. The figure shows how Visual Studio displays a warning, but Visual Studio Code \nis similar.\nFigure 5.2    A null state analysis warning  \nWhen null state analysis is enabled, C# variables are divided into two groups: nul-\nlable and non-nullable. As their name suggests, nullable variables can be assigned the \n82 chapter  5 Essential C# features\nspecial value null . This is the behavior that most programmers are familiar with, and \nit is entirely up to the developer to guard against trying to use null  references, which \nwill trigger a NullReferenceException .\nBy contrast, non-nullable variables can never be null . When you receive a non-nul-\nlable variable, you don’t have to guard against a null  value because that is not a value \nthat can ever be assigned. \nA question mark (the ? character) is appended to a type to denote a nullable type. \nSo, if a variable’s type is string? , for example, then it can be assigned any value string  \nvalue or null . When attempting to access this variable, you should check to ensure \nthat it isn’t null before attempting to access any of the fields, properties, or methods \ndefined by the string  type. \nIf a variable’s type is string , then it cannot be assigned null  values, which means \nyou can confidently access the features it provides without needing to guard against \nnull  references.\nThe compiler examines the code in the project and warns you when it finds state-\nments that might break these rules. The most common issues are attempting to assign \nnull  to non-nullable variables and attempting to access members defined by nullable \nvariables without checking to see if they are null . In the sections that follow, I explain \nthe different ways that the warnings raised by the compiler in the example application \ncan be addressed.\nNOTE    Getting to grips with nullable and non-nullable types can be frustrating. \nA change in one code file can simply move a warning to another part of the \napplication, and it can feel like you are chasing problems through a project. But \nit is worth sticking with null state analysis because null reference exceptions are \nthe most common runtime error, and few programmers are disciplined enough \nto guard against null values without the compiler analysis feature. \n5.4.1 Ensuring fields and properties are assigned values\nThe first warning in the Product.cs  file is for the Name  field, whose type is string , \nwhich is a non-nullable type (because it hasn’t been annotated with a question mark).\n...\npublic string Name { get; set; }\n...\nOne consequence of using non-nullable types is that properties like Name  must be \nassigned a value when a new instance of the enclosing class is created. If this were not \nthe case, then the Name  property would not be initialized and would be null . And this \nis a problem because we can’t assign null  to a non-nullable property, even indirectly. \nThe required  keyword can be used to indicate that a value is required for a non-nul-\nlable type, as shown in listing 5.11.\n 83 Understanding null state analysis\nListing 5.11    Using the required keyword in the Product.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class Product {\n        public required string Name { get; set; }\n        public decimal? Price { get; set; }\n        public static Product[] GetProducts() {\n            Product kayak = new Product {\n                Name = ""Kayak"", Price = 275M\n            };\n            Product lifejacket = new Product {\n                Name = ""Lifejacket"", Price = 48.95M\n            };\n            return new Product[] { kayak, lifejacket, null };\n        }\n    }\n}\nThe compiler will check to make sure that a value is assigned to the property when a \nnew instance of the containing type is created. The two Product  objects used in the \nlisting are created with a value for the Name  field, which satisfies the demands of the \nrequired  keyword. Listing 5.12 omits the Name  value from one of Product  objects.\nListing 5.12    Omitting a value in the Product.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class Product {\n        public required string Name { get; set; }\n        public decimal? Price { get; set; }\n        public static Product[] GetProducts() {\n            Product kayak = new Product {\n                Name = ""Kayak"", Price = 275M\n            };\n            Product lifejacket = new Product {\n                //Name = ""Lifejacket"", \n                Price = 48.95M\n            };\n            return new Product[] { kayak, lifejacket, null };\n        }\n    }\n}\nIf you run the example, the build process will fail with this error:\nRequired member 'Product.Name' must be set in the object initializer or \nattribute constructor.",11349
51-5.4.2 Providing a default value for non-nullable types.pdf,51-5.4.2 Providing a default value for non-nullable types,,0
52-5.4.3 Using nullable types.pdf,52-5.4.3 Using nullable types,"84 chapter  5 Essential C# features\nThis error—and the corresponding red line in the code editor—tell you that a value \nfor the Name  property is required but has not been provided.\n5.4.2 Providing a default value for non-nullable types \nThe required  keyword is a good way to denote a property that cannot be null , and \nwhich requires a value when an object is created. This approach can become cum-\nbersome in situations where there may not always be a suitable data value available, \nbecause it requires the code wants to create the object to provide a fallback value and \nthere is no good way to enforce consistency.\nFor these situations a default value can be used instead of the required  keyword, as \nshown in listing 5.13.\nListing 5.13    Providing a default value in the Product.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class Product {\n        public string Name { get; set; } = string.Empty;\n        public decimal? Price { get; set; }\n        public static Product[] GetProducts() {\n            Product kayak = new Product {\n                Name = ""Kayak"", Price = 275M\n            };\n            Product lifejacket = new Product {\n                //Name = ""Lifejacket"", \n                Price = 48.95M\n            };\n            return new Product[] { kayak, lifejacket, null };\n        }\n    }\n}\nThe default value in this example is the empty string. This value will be replaced for \nProduct  objects that are created with a Name  value and ensures consistency for objects \nthat are created without one.\n5.4.3 Using nullable types \nThe remaining warning in the Product.cs  file occurs because there is a mismatch \nbetween the type used for the result of the GetProducts  method and the values that \nare used to initialize it:\n...\nreturn new Product[]  { kayak, lifejacket, null };\n...\nThe type of the array that is created is Product[] , which contains non-nullable  \nProduct references. But one of the values used to populate the array is null , which \nisn’t allowed. Listing 5.14 changes the array type so that nullable values are allowed. \n 85 Understanding null state analysis\nListing 5.14    Using a nullable type in the Product.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class Product {\n        public string Name { get; set; } = string.Empty;\n        public decimal? Price { get; set; }\n        public static Product?[] GetProducts() {\n            Product kayak = new Product {\n                Name = ""Kayak"", Price = 275M\n            };\n            Product lifejacket = new Product {\n                //Name = ""Lifejacket"", \n                Price = 48.95M\n            };\n            return new Product?[] { kayak, lifejacket, null };\n        }\n    }\n}\nThe type Product?[]  denotes an array of Product?  references, which means the \nresult can include null . Notice that I had to make the same change to the result type \ndeclared by the GetProducts  method because a Product?[]  array cannot be used \nwhere a Product[]  is expected. \nSelecting the right nullable type\nCare must be taken to apply the question mark correctly, especially when dealing with \narrays and collections. A variable of type Product?[]  denotes an array that can contain \nProduct  or null  values but that won’t be null  itself:\n...\nProduct?[] arr1 = new Product?[] { kayak, lifejacket, null };  // OK\nProduct?[] arr2 = null;                                        // Not OK\n...\nA variable of type Product[]?  is an array that can hold only Product  values and not \nnull  values, but the array itself may be null :\n...\nProduct[]? arr1 = new Product?[] { kayak, lifejacket, null }; // Not OK\nProduct[]? arr2 = null;                                       // OK\n...\nA variable of type Product?[]? is an array that can contain Product  or null  values \nand that can itself be null :\n...\nProduct?[]? arr1 = new Product?[] { kayak, lifejacket, null }; // OK\nProduct?[]? arr2 = null;                                    // Also OK\n...",4069
53-5.4.4 Checking for null values.pdf,53-5.4.4 Checking for null values,"86 chapter  5 Essential C# features\n(continued)\nNull state analysis is a useful feature, but that doesn’t mean it is always easy to \nunderstand.\n5.4.4 Checking for null values \nI explained that dealing with null state analysis warnings can feel like chasing a prob-\nlem through code, and you can see a simple example of this in the HomeController \n.cs file in the Controllers  folder. In listing 5.14, I changed the type returned by the \nGetProducts  method to allow null  values, but that has created a mismatch in the \nHomeController  class, which invokes that method and assigns the result to an array of \nnon-nullable Product  values:\n...\nProduct[]  products = Product.GetProducts();\n...\nThis is easily resolved by changing the type of the products  variable to match the type \nreturned by the GetProducts  method, as shown in listing 5.15. \nListing 5.15    Changing Type in the HomeController.cs File in the Controllers Folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product?[] products = Product.GetProducts();\n            return View(new string[] { products[0].Name });\n        }\n    }\n}\nThis resolves one warning and introduces another, as shown in figure 5.3.\nFigure 5.3    An additional null state analysis warning\n 87 Understanding null state analysis\nThe statement flagged by the compiler attempts to access the Name  field of the element \nat index zero in the array, which might be null  since the array type is Product?[] . \nAddressing this issue requires a check for null  values, as shown in listing 5.16.\nListing 5.16    Guarding against null in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product?[] products = Product.GetProducts();\n            Product? p = products[0];\n            string val;\n            if (p != null) {\n                val = p.Name;\n            } else {\n                val = ""No value"";\n            }\n            return View(new string[] { val });\n        }\n    }\n}\nThis is an especially verbose way of avoiding a null, which I will refine shortly. But it \ndemonstrates an important point, which is that the compiler can understand the effect \nof C# expressions when checking for a null  reference. In listing 5.16, I use an if state-\nment to see if a Product?  variable is not null , and the compiler understands that the \nvariable cannot be null  within the scope of the if clause and doesn’t generate a warn-\ning when I read the name field:\n...\nif (p != null) {\n    val = p.Name;\n} else {\n    val = ""No value"";\n}\n...\nThe compiler has a sophisticated understanding of C# but doesn’t always get it right, \nand I explain what to do when the compiler isn’t able to accurately determine whether \na variable is null  in the “Overriding Null State Analysis” section.\nusing the null conditional  operator  \nThe null conditional operator is a more concise way of avoiding member access for \nnull  values, as shown in listing 5.17.\nListing 5.17    Null conditional operator in the HomeController.cs file in the Controllers   \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n88 chapter  5 Essential C# features\n            Product?[] products = Product.GetProducts();\n            string? val = products[0]?.Name;\n            if (val != null) {\n                return View(new string[] { val });\n            }\n            return View(new string[] { ""No Value"" });\n        }\n    }\n}\nThe null conditional operator is a question mark applied before a member is accessed, \nlike this:\n...\nstring? val = products[0] ?.Name;\n...\nThe operator returns null  if it is applied to a variable that is null . In this case, if \nthe element at index zero of the products array is null , then the operator will return \nnull  and prevent an attempt to access the Name  property, which would cause an excep-\ntion. If products[0]  isn’t null , then the operator does nothing, and the expression \nreturns the value assigned to the Name  property. Applying the null conditional opera-\ntor can return null , and its result must always be assigned to a nullable variable, such \nas the string?  used in this example.\nusing the null-coalescing  operator\nThe null-coalescing operator is two question mark characters ( ??) and is used to pro-\nvide a fallback value, often used in conjunction with the null conditional operator, as \nshown in listing 5.18.\nListing 5.18    Using the null-coalescing operator in the HomeController.cs file in the   \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product?[] products = Product.GetProducts();\n            return View(new string[] { products[0]?.Name ?? ""No Value"" });\n        }\n    }\n}\nThe ?? operator returns the value of its left-hand operand if it isn’t null . If the left-\nhand operand is null , then the ?? operator returns the value of its right-hand operand. \nThis behavior works well with the null conditional operator. If products[0]  is null , \nthen the ? operator will return null , and the ?? operator will return ""No Value"" . If \nproducts[0]  isn’t null , then the result will be the value of its Name  property. This is a \nmore concise way of performing the same null checks shown in earlier examples.",5608
54-5.4.5 Overriding null state analysis.pdf,54-5.4.5 Overriding null state analysis,,0
55-5.5 Using string interpolation.pdf,55-5.5 Using string interpolation,"89 Understanding null state analysis\nNOTE     The ? and ?? operators cannot always be used, and you will see examples \nin later chapters where I use an if statement to check for null  values. One com-\nmon example is when using the await /async  keywords, which are described \nlater in this chapter, and which do not integrate well with the null conditional \noperator. \n5.4.5 Overriding null state analysis \nThe C# compiler has a sophisticated understanding of when a variable can be null , but \nit doesn’t always get it right, and there are times when you have a better understanding \nof whether a null  value can arise than the compiler. In these situations, the null-for-\ngiving operator can be used to tell the compiler that a variable isn’t null , regardless of \nwhat the null state analysis suggests, as shown in listing 5.19.\nListing 5.19    Using the null-forgiving operator in the HomeController.cs file in the \nControllers folder \nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product?[] products = Product.GetProducts();\n            return View(new string[] { products[0]!.Name });\n        }\n    }\n}\nThe null-forgiving operator is an exclamation mark and is used in this example to tell \nthe compiler that products[0]  isn’t null , even though null state analysis has identi-\nfied that it might be. \nWhen using the ! operator, you are telling the compiler that you have better insight \ninto whether a variable can be null , and, naturally, this should be done only when you \nare entirely confident that you are right. \n5.4.6 Disabling null state analysis warnings \nAn alternative to the null-forgiving operator is to disable null state analysis warnings \nfor a particular section of code or a complete code file, as shown in listing 5.20.\nListing 5.20    Disabling warnings in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product?[] products = Product.GetProducts();\n            #pragma warning disable CS8602\n            return View(new string[] { products[0].Name });\n        }\n    }\n}",2271
56-5.6 Using object and collection initializers.pdf,56-5.6 Using object and collection initializers,"90 chapter  5 Essential C# features\nThis listing uses a #pragma directive to suppress warning CS8602 (you can identify \nwarnings in the output from the build process). \nNOTE     .NET includes a set of advanced attributes that can be used to provide the \ncompiler with guidance for null state analysis. These are not widely used and are \nencountered only in chapter 36 of this book because they are used by one part of \nthe ASP.NET Core API. See https://docs.microsoft.com/en-us/dotnet/csharp/\nlanguage-reference/attributes/nullable-analysis  for details.\n5.5 Using string interpolation \nC# supports string interpolation  to create formatted strings, which uses templates with \nvariable names that are resolved and inserted into the output, as shown in listing 5.21.\nListing 5.21    Using string interpolation in the HomeController.cs file in the Controllers \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Product?[] products = Product.GetProducts();\n            return View(new string[] { \n                $""Name: {products[0]?.Name}, Price: { products[0]?.Price }""\n            });\n        }\n    }\n}\nInterpolated strings are prefixed with the $ character and contain holes, which are ref-\nerences to values contained within the { and } characters. When the string is evalu-\nated, the holes are filled in with the current values of the variables or constants that are \nspecified.\nTIP    String interpolation supports the string format specifiers, which can be \napplied within holes, so $""Price:  {price:C2}""  would format the price  value \nas a currency value with two decimal digits, for example.\nStart ASP.NET Core and request http://localhost:5000, and you will see a formatted \nstring:\nName: Kayak, Price: 275\n5.6 Using object and collection initializers\nWhen I create an object in the static GetProducts  method of the Product  class, I use \nan object initializer , which allows me to create an object and specify its property values in \na single step, like this: \n...\nProduct kayak = new Product {\n    Name = ""Kayak"", Price = 275M\n 91 Using object and collection initializers\n};\n...\nThis is another syntactic sugar feature that makes C# easier to use. Without this fea-\nture, I would have to call the Product  constructor and then use the newly created \nobject to set each of the properties, like this:\n...\nProduct kayak = new Product();\nkayak.Name = ""Kayak"";\nkayak.Price = 275M;\n...\nA related feature is the collection initializer , which allows the creation of a collection \nand its contents to be specified in a single step. Without an initializer, creating a string \narray, for example, requires the size of the array and the array elements to be specified \nseparately, as shown in listing 5.22.\nListing 5.22    Initializing an object in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            string[] names = new string[3];\n            names[0] = ""Bob"";\n            names[1] = ""Joe"";\n            names[2] = ""Alice"";\n            return View(""Index"", names);\n        }\n    }\n}\nUsing a collection initializer allows the contents of the array to be specified as part of \nthe construction, which implicitly provides the compiler with the size of the array, as \nshown in listing 5.23.\nListing 5.23    A collection initializer in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            return View(""Index"", new string[] { ""Bob"", ""Joe"", ""Alice"" });\n        }\n    }\n}\nThe array elements are specified between the { and } characters, which allows for a \nmore concise definition of the collection and makes it possible to define a collection \ninline within a method call. The code in listing 5.23 has the same effect as the code in",4074
57-5.8 Pattern Matching.pdf,57-5.8 Pattern Matching,"92 chapter  5 Essential C# features\nlisting 5.22. Restart ASP.NET Core and request http://localhost:5000, and you will see \nthe following output in the browser window:\nBob\nJoe\nAlice\n5.6.1 Using an index initializer \nRecent versions of C# tidy up the way collections that use indexes, such as dictionar-\nies, are initialized. Listing 5.24 shows the Index  action rewritten to define a collection \nusing the traditional C# approach to initializing a dictionary. \nListing 5.24    Initializing a dictionary in the HomeController.cs file in the Controllers \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Dictionary<string, Product> products \n                    = new Dictionary<string, Product> {\n                { \n                    ""Kayak"", \n                    new Product { Name = ""Kayak"", Price = 275M } \n                },\n                { \n                    ""Lifejacket"",  \n                    new Product{ Name = ""Lifejacket"", Price = 48.95M } \n                }\n            };\n            return View(""Index"", products.Keys);\n        }\n    }\n}\nThe syntax for initializing this type of collection relies too much on the { and } charac-\nters, especially when the collection values are created using object initializers. The lat-\nest versions of C# support a more natural approach to initializing indexed collections \nthat is consistent with the way that values are retrieved or modified once the collection \nhas been initialized, as shown in listing 5.25.\nListing 5.25    Using collection initializer syntax in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Dictionary<string, Product> products \n                    = new Dictionary<string, Product> {\n                [""Kayak""] = new Product { Name = ""Kayak"", Price = 275M },\n                [""Lifejacket""] = new Product { Name = ""Lifejacket"", \n 93 Using target-typed new expressions\n                    Price = 48.95M }\n            };\n            return View(""Index"", products.Keys);\n        }\n    }\n}\nThe effect is the same—to create a dictionary whose keys are Kayak  and Lifejacket  \nand whose values are Product  objects—but the elements are created using the index \nnotation that is used for other collection operations. Restart ASP.NET Core and \nrequest http://localhost:5000, and you will see the following results in the browser:\nKayak\nLifejacket\n5.7 Using target-typed new expressions\nThe example in listing 5.25 is still verbose and declares the collection type when defin-\ning the variable and creating an instance with the new keyword:\n...\nDictionary<string, Product>  products = new Dictionary<string, Product>  {\n    [""Kayak""] = new Product { Name = ""Kayak"", Price = 275M },\n    [""Lifejacket""] = new Product { Name = ""Lifejacket"", Price = 48.95M }\n};\n...\nThis can be simplified using a target-typed new expression, as shown in listing 5.26.\nListing 5.26    Using a target-typed new expression in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            Dictionary<string, Product> products = new () {\n                [""Kayak""] = new Product { Name = ""Kayak"", Price = 275M },\n                [""Lifejacket""] = new Product { Name = ""Lifejacket"", \n                    Price = 48.95M }\n            };\n            return View(""Index"", products.Keys);\n        }\n    }\n}\nThe type can be replaced with new()  when the compiler can determine which type is \nrequired and constructor arguments are provided as arguments to the new method. \nCreating instances with the new()  expression works only when the compiler can deter-\nmine which type is required. Restart ASP.NET Core and request http://localhost:5000, \nand you will see the following results in the browser:\nKayak\nLifejacket",4104
58-5.9 Using extension methods.pdf,58-5.9 Using extension methods,"94 chapter  5 Essential C# features\n5.8 Pattern Matching\nOne of the most useful recent additions to C# is support for pattern matching, which \ncan be used to test that an object is of a specific type or has specific characteristics. \nThis is another form of syntactic sugar, and it can dramatically simplify complex blocks \nof conditional statements. The is keyword is used to perform a type test, as demon-\nstrated in listing 5.27. \nListing 5.27    Testing a type in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            object[] data = new object[] { 275M, 29.95M,\n                ""apple"", ""orange"", 100, 10 };\n            decimal total = 0;\n            for (int i = 0; i < data.Length; i++) {\n                if (data[i] is decimal d) {\n                    total += d;\n                }\n            }\n            return View(""Index"", new string[] { $""Total: {total:C2}"" });\n        }\n    }\n}\nThe is keyword performs a type check and, if a value is of the specified type, will assign \nthe value to a new variable, like this:\n...\nif (data[i] is decimal d) {\n...\nThis expression evaluates as true  if the value stored in data[i]  is a decimal . The \nvalue of data[i]  will be assigned to the variable d, which allows it to be used in subse-\nquent statements without needing to perform any type conversions. The is keyword \nwill match only the specified type, which means that only two of the values in the data \narray will be processed (the other items in the array are string  and int values). If you \nrun the application, you will see the following output in the browser window:\nTotal: $304.95\n5.8.1 Pattern matching in switch statements \nPattern matching can also be used in switch  statements, which support the when  key-\nword for restricting when a value is matched by a case  statement, as shown in listing \n5.28. \n 95 Using extension methods\nListing 5.28    Pattern matching in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            object[] data = new object[] { 275M, 29.95M,\n                ""apple"", ""orange"", 100, 10 };\n            decimal total = 0;\n            for (int i = 0; i < data.Length; i++) {\n                switch (data[i]) {\n                    case decimal decimalValue:\n                        total += decimalValue;\n                        break;\n                    case int intValue when intValue > 50:\n                        total += intValue;\n                        break;\n                }\n            }\n            return View(""Index"", new string[] { $""Total: {total:C2}"" });\n        }\n    }\n}\nTo match any value of a specific type, use the type and variable name in the case  state-\nment, like this:\n...\ncase decimal decimalValue:\n...\nThis case  statement matches any decimal  value and assigns it to a new variable called \ndecimalValue . To be more selective, the when  keyword can be included, like this:\n...\ncase int intValue when intValue > 50:\n...\nThis case  statement matches int values and assigns them to a variable called  \nintValue , but only when the value is greater than 50. Restart ASP.NET Core and \nrequest http://localhost:5000, and you will see the following output in the browser \nwindow:\nTotal: $404.95\n5.9 Using extension methods\nExtension methods  are a convenient way of adding methods to classes that you cannot \nmodify directly, typically because they are provided by Microsoft or a third-party pack-\nage. Listing 5.29 shows the definition of the ShoppingCart  class, which I added to the \nModels  folder in a class file called ShoppingCart.cs  and which represents a collec-\ntion of Product  objects. \n96 chapter  5 Essential C# features\nListing 5.29    The contents of the ShoppingCart.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class ShoppingCart {\n        public IEnumerable<Product?>? Products { get; set; }\n    }\n}\nThis is a simple class that acts as a wrapper around a sequence of Product  objects \n(I only need a basic class for this example). Note the type of the Products  prop-\nerty, which denotes a nullable enumerable of nullable Products , meaning that the  \nProducts  property may be null  and that any sequence of elements assigned to the \nproperty may contain null  values.\nSuppose I need to be able to determine the total value of the Product  objects in the \nShoppingCart  class, but I cannot modify the class because it comes from a third party, \nand I do not have the source code. I can use an extension method to add the function-\nality I need. \nAdd a class file named MyExtensionMethods.cs  in the Models  folder and use it to \ndefine the class shown in listing 5.30.\nListing 5.30    The contents of the MyExtensionMethods.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public static class MyExtensionMethods {\n        public static decimal TotalPrices(this ShoppingCart cartParam) {\n            decimal total = 0;\n            if (cartParam.Products != null) {\n                foreach (Product? prod in cartParam.Products) {\n                    total += prod?.Price ?? 0;\n                }\n            }\n            return total;\n        }\n    }\n}\nExtension methods are static  and are defined in static  classes. Listing 5.30 defines \na single extension method named TotalPrices . The this  keyword in front of the \nfirst parameter marks TotalPrices  as an extension method. The first parameter tells \n.NET which class the extension method can be applied to— ShoppingCart  in this case. \nI can refer to the instance of the ShoppingCart  that the extension method has been \napplied to by using the cartParam  parameter. This extension method enumerates the \nProduct objects in the ShoppingCart  and returns the sum of the Product.Price  \nproperty values. Listing 5.31 shows how I apply the extension method in the Home  con-\ntroller’s action method.",6179
59-5.9.1 Applying extension methods to an interface.pdf,59-5.9.1 Applying extension methods to an interface,"97 Using extension methods\nNOTE     Extension methods do not let you break through the access rules that \nclasses define for methods, fields, and properties. You can extend the functional-\nity of a class by using an extension method but only using the class members that \nyou had access to anyway.\nListing 5.31    Applying an extension method in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            ShoppingCart cart \n                = new ShoppingCart { Products = Product.GetProducts()};\n            decimal cartTotal = cart.TotalPrices();\n            return View(""Index"", \n                new string[] { $""Total: {cartTotal:C2}"" });\n        }\n    }\n}\nThe key statement is this one:\n...\ndecimal cartTotal = cart.TotalPrices();\n...\nI call the TotalPrices  method on a ShoppingCart  object as though it were part of the \nShoppingCart  class, even though it is an extension method defined by a different class \naltogether. .NET will find extension classes if they are in the scope of the current class, \nmeaning that they are part of the same namespace or in a namespace that is the subject \nof a using  statement. Restart ASP.NET Core and request http://localhost:5000, which \nwill produce the following output in the browser window:\nTotal: $323.95\n5.9.1 Applying extension methods to an interface\nExtension methods can also be applied to an interface, which allows me to call the \nextension method on all the classes that implement the interface. Listing 5.32 shows \nthe ShoppingCart  class updated to implement the IEnumerable<Product>  interface. \nListing 5.32    Implementing an interface in the ShoppingCart.cs file in the Models folder\nusing System.Collections;\nnamespace LanguageFeatures.Models {\n    public class ShoppingCart : IEnumerable<Product?> {\n        public IEnumerable<Product?>? Products { get; set; }\n        public IEnumerator<Product?> GetEnumerator() => \n                Products?.GetEnumerator()\n                    ?? Enumerable.Empty<Product?>().GetEnumerator();\n98 chapter  5 Essential C# features\n        IEnumerator IEnumerable.GetEnumerator() => GetEnumerator();\n    }\n}\nI can now update the extension method so that it deals with IEnumerable<Product?> , \nas shown in listing 5.33.\nListing 5.33    Updating an extension method in the MyExtensionMethods.cs file in the \nModels folder\nnamespace LanguageFeatures.Models {\n    public static class MyExtensionMethods {\n        public static decimal TotalPrices(\n                this IEnumerable<Product?> products) {\n            decimal total = 0;\n            foreach (Product? prod in products) {\n                total += prod?.Price ?? 0;\n            }\n            return total;\n        }\n    }\n}\nThe first parameter type has changed to IEnumerable<Product?> , which means the \nforeach  loop in the method body works directly on Product?  objects. The change to \nusing the interface means that I can calculate the total value of the Product  objects \nenumerated by any IEnumerable<Product?> , which includes instances of Shopping-\nCart  but also arrays of Product  objects, as shown in listing 5.34.\nListing 5.34    Applying an extension method in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            ShoppingCart cart \n                = new ShoppingCart { Products = Product.GetProducts()};\n            Product[] productArray = {\n                new Product {Name = ""Kayak"", Price = 275M},\n                new Product {Name = ""Lifejacket"", Price = 48.95M}\n            };\n            decimal cartTotal = cart.TotalPrices();\n            decimal arrayTotal = productArray.TotalPrices();\n            return View(""Index"", new string[] {\n                $""Cart Total: {cartTotal:C2}"",\n                $""Array Total: {arrayTotal:C2}"" });\n        }\n    }\n}",4084
60-5.10 Using lambda expressions.pdf,60-5.10 Using lambda expressions,"99 Using extension methods\nRestart ASP.NET Core and request http://localhost:5000, which will produce the fol-\nlowing output in the browser, demonstrating that I get the same result from the exten-\nsion method, irrespective of how the Product  objects are collected:\nCart Total: $323.95\nArray Total: $323.95 \n5.9.2 Creating filtering extension methods\nThe last thing I want to show you about extension methods is that they can be used \nto filter collections of objects. An extension method that operates on an IEnumera-\nble<T>  and that also returns an IEnumerable<T>  can use the yield  keyword to apply \nselection criteria to items in the source data to produce a reduced set of results. Listing \n5.35 demonstrates such a method, which I have added to the MyExtensionMethods  \nclass.\nListing 5.35    A filtering extension method in the MyExtensionMethods.cs file in the \nModels folder\nnamespace LanguageFeatures.Models {\n    public static class MyExtensionMethods {\n        public static decimal TotalPrices(\n                this IEnumerable<Product?> products) {\n            decimal total = 0;\n            foreach (Product? prod in products) {\n                total += prod?.Price ?? 0;\n            }\n            return total;\n        }\n        public static IEnumerable<Product?> FilterByPrice(\n                this IEnumerable<Product?> productEnum, \n                decimal minimumPrice) {\n            foreach (Product? prod in productEnum) {\n                if ((prod?.Price ?? 0) >= minimumPrice) {\n                    yield return prod;\n                }\n            }\n        }\n    }\n}\nThis extension method, called FilterByPrice , takes an additional parameter that \nallows me to filter products so that Product  objects whose Price  property matches or \nexceeds the parameter are returned in the result. Listing 5.36 shows this method being \nused.\n100 chapter  5 Essential C# features\nListing 5.36    Using the filtering extension method in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            ShoppingCart cart \n                = new ShoppingCart { Products = Product.GetProducts()};\n            Product[] productArray = {\n                new Product {Name = ""Kayak"", Price = 275M},\n                new Product {Name = ""Lifejacket"", Price = 48.95M},\n                new Product {Name = ""Soccer ball"", Price = 19.50M},\n                new Product {Name = ""Corner flag"", Price = 34.95M}\n            };\n            decimal arrayTotal = \n                productArray.FilterByPrice(20).TotalPrices();\n            return View(""Index"", \n                new string[] { $""Array Total: {arrayTotal:C2}"" });\n        }\n    }\n}\nWhen I call the FilterByPrice  method on the array of Product  objects, only those \nthat cost more than $20 are received by the TotalPrices  method and used to cal-\nculate the total. If you run the application, you will see the following output in the \nbrowser window:\nTotal: $358.90\n5.10 Using lambda expressions\nLambda expressions are a feature that causes a lot of confusion, not least because the \nfeature they simplify is also confusing. To understand the problem that is being solved, \nconsider the FilterByPrice  extension method that I defined in the previous section. \nThis method is written so that it can filter Product  objects by price, which means I \nmust create a second method if I want to filter by name, as shown in listing 5.37. \nListing 5.37    Adding a filter method in the MyExtensionMethods.cs file in the Models \nfolder\nnamespace LanguageFeatures.Models {\n    public static class MyExtensionMethods {\n        public static decimal TotalPrices(\n                this IEnumerable<Product?> products) {\n            decimal total = 0;\n            foreach (Product? prod in products) {\n                total += prod?.Price ?? 0;\n            }\n 101 Using lambda expressions\n            return total;\n        }\n        public static IEnumerable<Product?> FilterByPrice(\n                this IEnumerable<Product?> productEnum, \n                decimal minimumPrice) {\n            foreach (Product? prod in productEnum) {\n                if ((prod?.Price ?? 0) >= minimumPrice) {\n                    yield return prod;\n                }\n            }\n        }\n        public static IEnumerable<Product?> FilterByName(\n                this IEnumerable<Product?> productEnum, \n                char firstLetter) {\n            foreach (Product? prod in productEnum) {\n                if (prod?.Name?[0] == firstLetter) {\n                    yield return prod;\n                }\n            }\n        }\n    }\n}\nListing 5.38 shows the use of both filter methods applied in the controller to create two \ndifferent totals.\nListing 5.38    Using two filter methods in the HomeController.cs file in the Controllers \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            ShoppingCart cart \n                = new ShoppingCart { Products = Product.GetProducts()};\n            Product[] productArray = {\n                new Product {Name = ""Kayak"", Price = 275M},\n                new Product {Name = ""Lifejacket"", Price = 48.95M},\n                new Product {Name = ""Soccer ball"", Price = 19.50M},\n                new Product {Name = ""Corner flag"", Price = 34.95M}\n            };\n            decimal priceFilterTotal = \n                productArray.FilterByPrice(20).TotalPrices();\n            decimal nameFilterTotal = \n                productArray.FilterByName('S').TotalPrices();\n            return View(""Index"", new string[] {\n                $""Price Total: {priceFilterTotal:C2}"",\n                $""Name Total: {nameFilterTotal:C2}"" });",5923
61-5.10.1 Defining functions.pdf,61-5.10.1 Defining functions,"102 chapter  5 Essential C# features\n        }\n    }\n}\nThe first filter selects all the products with a price of $20 or more, and the second filter \nselects products whose name starts with the letter S. You will see the following output in \nthe browser window if you run the example application:\nPrice Total: $358.90\nName Total: $19.50\n5.10.1  Defining functions\nI can repeat this process indefinitely to create filter methods for every property and \nevery combination of properties that I am interested in. A more elegant approach is \nto separate the code that processes the enumeration from the selection criteria. C# \nmakes this easy by allowing functions to be passed around as objects. Listing 5.39 shows \na single extension method that filters an enumeration of Product  objects but that del-\negates the decision about which ones are included in the results to a separate function. \nListing 5.39    Creating a general filter method in the MyExtensionMethods.cs file in the \nModels folder\nnamespace LanguageFeatures.Models {\n    public static class MyExtensionMethods {\n        public static decimal TotalPrices(\n                this IEnumerable<Product?> products) {\n            decimal total = 0;\n            foreach (Product? prod in products) {\n                total += prod?.Price ?? 0;\n            }\n            return total;\n        }\n        public static IEnumerable<Product?> FilterByPrice(\n                this IEnumerable<Product?> productEnum, \n                decimal minimumPrice) {\n            foreach (Product? prod in productEnum) {\n                if ((prod?.Price ?? 0) >= minimumPrice) {\n                    yield return prod;\n                }\n            }\n        }\n        public static IEnumerable<Product?> Filter(\n                this IEnumerable<Product?> productEnum,\n                Func<Product?, bool> selector) {\n            foreach (Product? prod in productEnum) {\n                if (selector(prod)) {\n                    yield return prod;\n 103 Using lambda expressions\n                }\n            }\n        }\n    }\n}\nThe second argument to the Filter  method is a function that accepts a Product?  \nobject and that returns a bool  value. The Filter  method calls the function for each \nProduct?  object and includes it in the result if the function returns true . To use the \nFilter  method, I can specify a method or create a stand-alone function, as shown in \nlisting 5.40.\nListing 5.40    Using a function to filter objects in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        bool FilterByPrice(Product? p) {\n            return (p?.Price ?? 0) >= 20;\n        }\n        public ViewResult Index() {\n            ShoppingCart cart \n                = new ShoppingCart { Products = Product.GetProducts()};\n            Product[] productArray = {\n                new Product {Name = ""Kayak"", Price = 275M},\n                new Product {Name = ""Lifejacket"", Price = 48.95M},\n                new Product {Name = ""Soccer ball"", Price = 19.50M},\n                new Product {Name = ""Corner flag"", Price = 34.95M}\n            };\n            Func<Product?, bool> nameFilter = delegate (Product? prod) {\n                return prod?.Name?[0] == 'S';\n            };\n            decimal priceFilterTotal = productArray\n                .Filter(FilterByPrice)\n                .TotalPrices();\n            decimal nameFilterTotal = productArray\n                .Filter(nameFilter)\n                .TotalPrices();\n            return View(""Index"", new string[] {\n                $""Price Total: {priceFilterTotal:C2}"",\n                $""Name Total: {nameFilterTotal:C2}"" });\n        }\n    }\n}\nNeither approach is ideal. Defining methods like FilterByPrice  clutters up a class \ndefinition. Creating a Func<Product?,  bool>  object avoids this problem but uses an \nawkward syntax that is hard to read and hard to maintain. It is this issue that lambda \n104 chapter  5 Essential C# features\nexpressions address by allowing functions to be defined in a more elegant and expres-\nsive way, as shown in listing 5.41.\nListing 5.41    Using a lambda expression in the HomeController.cs file in the Controllers \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        //bool FilterByPrice(Product? p) {\n        //    return (p?.Price ?? 0) >= 20;\n        //}\n        public ViewResult Index() {\n            ShoppingCart cart \n                = new ShoppingCart { Products = Product.GetProducts()};\n            Product[] productArray = {\n                new Product {Name = ""Kayak"", Price = 275M},\n                new Product {Name = ""Lifejacket"", Price = 48.95M},\n                new Product {Name = ""Soccer ball"", Price = 19.50M},\n                new Product {Name = ""Corner flag"", Price = 34.95M}\n            };\n            //Func<Product?, bool> nameFilter = delegate (Product? prod) {\n            //    return prod?.Name?[0] == 'S';\n            //};\n            decimal priceFilterTotal = productArray\n                .Filter(p => (p?.Price ?? 0) >= 20)\n                .TotalPrices();\n            decimal nameFilterTotal = productArray\n                .Filter(p => p?.Name?[0] == 'S')\n                .TotalPrices();\n            return View(""Index"", new string[] {\n                $""Price Total: {priceFilterTotal:C2}"",\n                $""Name Total: {nameFilterTotal:C2}"" });\n        }\n    }\n}\nThe lambda expressions are shown in bold. The parameters are expressed without \nspecifying a type, which will be inferred automatically. The => characters are read \naloud as “goes to” and link the parameter to the result of the lambda expression. In \nmy examples, a Product?  parameter called p goes to a bool  result, which will be true  \nif the Price  property is equal or greater than 20 in the first expression or if the Name  \nproperty starts with S in the second expression. This code works in the same way as the \nseparate method and the function delegate but is more concise and is—for most peo-\nple—easier to read.",6214
62-5.10.2 Using lambda expression methods and properties.pdf,62-5.10.2 Using lambda expression methods and properties,"105 Using lambda expressions\nOther Forms for Lambda Expressions\nI don’t need to express the logic of my delegate in the lambda expression. I can as easily \ncall a method, like this: \n...\nprod => EvaluateProduct(prod)\n...\nIf I need a lambda expression for a delegate that has multiple parameters, I must wrap \nthe parameters in parentheses, like this:\n...\n(prod, count) => prod.Price > 20 && count > 0\n...\nFinally, if I need logic in the lambda expression that requires more than one statement,  \nI can do so by using braces ( {}) and finishing with a return  statement, like this:\n...\n(prod, count) => {\n    // ...multiple code statements...\n    return result;\n}\n...\nYou do not need to use lambda expressions in your code, but they are a neat way of \nexpressing complex functions simply and in a manner that is readable and clear. I like \nthem a lot, and you will see them used throughout this book.\n5.10.2  Using lambda expression methods and properties \nLambda expressions can be used to implement constructors, methods, and properties. \nIn ASP.NET Core development, you will often end up with methods that contain a \nsingle statement that selects the data to display and the view to render. In listing 5.42, I \nhave rewritten the Index  action method so that it follows this common pattern. \nListing 5.42    Creating a common action pattern in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            return View(Product.GetProducts().Select(p => p?.Name));\n        }\n    }\n}\nThe action method gets a collection of Product  objects from the static Product \n.GetProducts  method and uses LINQ to project the values of the Name  properties, \n106 chapter  5 Essential C# features\nwhich are then used as the view model for the default view. If you run the application, \nyou will see the following output displayed in the browser window:\nKayak\nThere will be empty list items in the browser window as well because the GetProducts  \nmethod includes a null  reference in its results and one of the Product objects is cre-\nated without a Name  value, but that doesn’t matter for this section of the chapter. \nWhen a constructor or method body consists of a single statement, it can be rewrit-\nten as a lambda expression, as shown in listing 5.43.\nListing 5.43    A lambda action method in the HomeController.cs file in the Controllers \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() => \n            View(Product.GetProducts().Select(p => p?.Name));\n    }\n}\nLambda expressions for methods omit the return  keyword and use => (goes to) to \nassociate the method signature (including its arguments) with its implementation. \nThe Index  method shown in listing 5.43 works in the same way as the one shown in \nlisting 5.42 but is expressed more concisely. The same basic approach can also be used \nto define properties. Listing 5.44 shows the addition of a property that uses a lambda \nexpression to the Product  class.\nListing 5.44    A lambda property in the Product.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class Product {\n        public string Name { get; set; } = string.Empty;\n        public decimal? Price { get; set; }\n        public bool NameBeginsWithS =>  Name.Length > 0 && Name[0] == 'S';\n        public static Product?[] GetProducts() {\n            Product kayak = new Product {\n                Name = ""Kayak"", Price = 275M\n            };\n            Product lifejacket = new Product {\n                //Name = ""Lifejacket"", \n                Price = 48.95M\n            };\n            return new Product?[] { kayak, lifejacket, null };\n        }\n    }\n}",3883
63-5.11 Using type inference and anonymous types.pdf,63-5.11 Using type inference and anonymous types,,0
64-5.11.1 Using anonymous types.pdf,64-5.11.1 Using anonymous types,"107 Using type inference and anonymous types\n5.11 Using type inference and anonymous types\nThe var keyword allows you to define a local variable without explicitly specifying the \nvariable type, as demonstrated by listing 5.45. This is called type inference , or implicit \ntyping . \nListing 5.45    Using type inference in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            var names = new[] { ""Kayak"", ""Lifejacket"", ""Soccer ball"" };\n            return View(names);\n        }\n    }\n}\nIt is not that the names  variable does not have a type; instead, I am asking the com-\npiler to infer the type from the code. The compiler examines the array declaration and \nworks out that it is a string array. Running the example produces the following output:\nKayak\nLifejacket\nSoccer ball\n5.11.1  Using anonymous types\nBy combining object initializers and type inference, I can create simple view model \nobjects that are useful for transferring data between a controller and a view without \nhaving to define a class or struct, as shown in listing 5.46. \nListing 5.46    An anonymous type in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            var products = new[] {\n                new { Name = ""Kayak"", Price = 275M },\n                new { Name = ""Lifejacket"", Price = 48.95M },\n                new { Name = ""Soccer ball"", Price = 19.50M },\n                new { Name = ""Corner flag"", Price = 34.95M }\n            };\n            return View(products.Select(p => p.Name));\n        }\n    }\n}\nEach of the objects in the products  array is an anonymously typed object. This does not \nmean that it is dynamic in the sense that JavaScript variables are dynamic. It just means \nthat the type definition will be created automatically by the compiler. Strong typing is \n108 chapter  5 Essential C# features\nstill enforced. You can get and set only the properties that have been defined in the \ninitializer, for example. Restart ASP.NET Core and request http://localhost:5000, and \nyou will see the following output in the browser window:\nKayak\nLifejacket\nSoccer ball\nCorner flag\nThe C# compiler generates the class based on the name and type of the parameters in \nthe initializer. Two anonymously typed objects that have the same property names and \ntypes defined in the same order will be assigned to the same automatically generated \nclass. This means that all the objects in the products  array will have the same type \nbecause they define the same properties. \nTIP    I have to use the var keyword to define the array of anonymously typed \nobjects because the type isn’t created until the code is compiled, so I don’t know \nthe name of the type to use. The elements in an array of anonymously typed \nobjects must all define the same properties; otherwise, the compiler can’t work \nout what the array type should be.\nTo demonstrate this, I have changed the output from the example in listing 5.47 so \nthat it shows the type name rather than the value of the Name  property.\nListing 5.47    Displaying the type name in the HomeController.cs file in the Controllers \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            var products = new[] {\n                new { Name = ""Kayak"", Price = 275M },\n                new { Name = ""Lifejacket"", Price = 48.95M },\n                new { Name = ""Soccer ball"", Price = 19.50M },\n                new { Name = ""Corner flag"", Price = 34.95M }\n            };\n            return View(products.Select(p => p.GetType().Name));\n        }\n    }\n}\nAll the objects in the array have been assigned the same type, which you can see if \nyou run the example. The type name isn’t user-friendly but isn’t intended to be used \ndirectly, and you may see a different name than the one shown in the following output:\n<>f__AnonymousType0`2\n<>f__AnonymousType0`2\n<>f__AnonymousType0`2\n<>f__AnonymousType0`2",4252
65-5.12 Using default implementations in interfaces.pdf,65-5.12 Using default implementations in interfaces,"109 Using default implementations in interfaces\n5.12 Using default implementations in interfaces\nC# provides the ability to define default implementations for properties and meth-\nods defined by interfaces. This may seem like an odd feature because an interface is \nintended to be a description of features without specifying an implementation, but \nthis addition to C# makes it possible to update interfaces without breaking the existing \nimplementations of them. \nAdd a class file named IProductSelection.cs  to the Models  folder and use it to \ndefine the interface shown in listing 5.48.\nListing 5.48    The contents of the IProductSelection.cs file in the Models folder \nnamespace LanguageFeatures.Models {\n    public interface IProductSelection {\n        IEnumerable<Product>? Products { get; }\n    }\n}\nUpdate the ShoppingCart  class to implement the new interface, as shown in listing \n5.49.\nListing 5.49    Implementing an interface in the ShoppingCart.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class ShoppingCart : IProductSelection {\n        private List<Product> products = new();\n        public ShoppingCart(params Product[] prods) {\n            products.AddRange(prods);\n        }\n        public IEnumerable<Product>? Products { get => products; }\n    }\n}\nListing 5.50 updates the Home  controller so that it uses the ShoppingCart  class.\nListing 5.50    Using an interface in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            IProductSelection cart = new ShoppingCart(\n                new Product { Name = ""Kayak"", Price = 275M },\n                new Product { Name = ""Lifejacket"", Price = 48.95M },\n                new Product { Name = ""Soccer ball"", Price = 19.50M },\n                new Product { Name = ""Corner flag"", Price = 34.95M }\n            );\n            return View(cart.Products?.Select(p => p.Name));\n110 chapter  5 Essential C# features\n        }\n    }\n}\nThis is the familiar use of an interface, and if you restart ASP.NET Core and request \nhttp://localhost:5000, you will see the following output in the browser:\nKayak\nLifejacket\nSoccer ball\nCorner flag\nIf I want to add a new feature to the interface, I must locate and update all the classes \nthat implement it, which can be difficult, especially if an interface is used by other \ndevelopment teams in their projects. This is where the default implementation feature \ncan be used, allowing new features to be added to an interface, as shown in listing 5.51.\nListing 5.51    Adding a feature in the IProductSelection.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public interface IProductSelection {\n        IEnumerable<Product>? Products { get; }\n        IEnumerable<string>? Names => Products?.Select(p => p.Name);\n    }\n}\nThe listing defines a Names  property and provides a default implementation, which \nmeans that consumers of the IProductSelection  interface can use the Names  prop-\nerty even if it isn’t defined by implementation classes, as shown in listing 5.52.\nListing 5.52    Using a default implementation in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            IProductSelection cart = new ShoppingCart(\n                new Product { Name = ""Kayak"", Price = 275M },\n                new Product { Name = ""Lifejacket"", Price = 48.95M },\n                new Product { Name = ""Soccer ball"", Price = 19.50M },\n                new Product { Name = ""Corner flag"", Price = 34.95M }\n            );\n            return View(cart.Names);\n        }\n    }\n}\nThe ShoppingCart  class has not been modified, but the Index  method can use the \ndefault implementation of the Names  property. Restart ASP.NET Core and request \nhttp://localhost:5000, and you will see the following output in the browser:",4094
66-5.13 Using asynchronous methods.pdf,66-5.13 Using asynchronous methods,,0
67-5.13.2 Applying the async and await keywords.pdf,67-5.13.2 Applying the async and await keywords,"111 Using asynchronous methods\nKayak\nLifejacket\nSoccer ball\nCorner flag\n5.13 Using asynchronous methods\nAsynchronous methods perform work in the background and notify you when they \nare complete, allowing your code to take care of other business while the background \nwork is performed. Asynchronous methods are an important tool in removing bottle-\nnecks from code and allow applications to take advantage of multiple processors and \nprocessor cores to perform work in parallel.\nIn ASP.NET Core, asynchronous methods can be used to improve the overall perfor-\nmance of an application by allowing the server more flexibility in the way that requests \nare scheduled and executed. Two C# keywords— async  and await —are used to per-\nform work asynchronously. \n5.13.1  Working with tasks directly \nC# and .NET have excellent support for asynchronous methods, but the code has \ntended to be verbose, and developers who are not used to parallel programming often \nget bogged down by the unusual syntax. To create an example, add a class file called \nMyAsyncMethods.cs  to the Models  folder and add the code shown in listing 5.53. \nListing 5.53    The contents of the MyAsyncMethods.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class MyAsyncMethods {\n        public static Task<long?> GetPageLength() {\n            HttpClient client = new HttpClient();\n            var httpTask = client.GetAsync(""http://manning.com"");\n            return httpTask.ContinueWith((Task<HttpResponseMessage> \n                    antecedent) => {\n                return antecedent.Result.Content.Headers.ContentLength;\n            });\n        }\n    }\n}\nThis method uses a System.Net.Http.HttpClient  object to request the contents \nof the Manning home page and returns its length. .NET represents work that will be \ndone asynchronously as a Task . Task  objects are strongly typed based on the result \nthat the background work produces. So, when I call the HttpClient.GetAsync  \nmethod, what I get back is a Task<HttpResponseMessage> . This tells me that the \nrequest will be performed in the background and that the result of the request will be \nan HttpResponseMessage  object.\nTIP    When I use words like background , I am skipping over a lot of detail to make \njust the key points that are important to the world of ASP.NET Core. The .NET \n112 chapter  5 Essential C# features\nsupport for asynchronous methods and parallel programming is excellent, and I \nencourage you to learn more about it if you want to create truly high-performing \napplications that can take advantage of multicore and multiprocessor hardware. \nYou will see how ASP.NET Core makes it easy to create asynchronous web appli-\ncations throughout this book as I introduce different features.\nThe part that most programmers get bogged down with is the continuation , which is the \nmechanism by which you specify what you want to happen when the task is complete. \nIn the example, I have used the ContinueWith  method to process the HttpResponse -\nMessage  object I get from the HttpClient.GetAsync  method, which I do with a \nlambda expression that returns the value of a property that contains the length of the \ncontent I get from the Manning web server. Here is the continuation code:\n...\nreturn httpTask.ContinueWith((Task<HttpResponseMessage> antecedent) => {\n    return antecedent.Result.Content.Headers.ContentLength;\n});\n...\nNotice that I use the return  keyword twice. This is the part that causes confusion. The \nfirst use of the return  keyword specifies that I am returning a Task<HttpResponse -\nMessage>  object, which, when the task is complete, will return  the length of the \nContentLength  header. The ContentLength  header returns a long?  result (a nullable \nlong value), and this means the result of my GetPageLength  method is Task<long?> , \nlike this:\n...\npublic static Task<long?>  GetPageLength() {\n...\nDo not worry if this does not make sense—you are not alone in your confusion. It is for \nthis reason that Microsoft added keywords to C# to simplify asynchronous methods.\n5.13.2  Applying the async and await keywords\nMicrosoft introduced two keywords to C# that simplify using asynchronous methods \nlike HttpClient.GetAsync . The keywords are async  and await , and you can see how \nI have used them to simplify my example method in listing 5.54. \nListing 5.54    Using the async and await keywords in the MyAsyncMethods.cs file in the \nModels folder\nnamespace LanguageFeatures.Models {\n    public class MyAsyncMethods {\n        public async static Task<long?> GetPageLength() {\n            HttpClient client = new HttpClient();\n            var httpMessage = await client.GetAsync(""http://manning.com"");\n            return httpMessage.Content.Headers.ContentLength;\n        }\n    }\n}\n 113 Using asynchronous methods\nI used the await  keyword when calling the asynchronous method. This tells the C# \ncompiler that I want to wait for the result of the Task  that the GetAsync  method \nreturns and then carry on executing other statements in the same method. \nApplying the await  keyword means I can treat the result from the GetAsync  method \nas though it were a regular method and just assign the HttpResponseMessage  object \nthat it returns to a variable. Even better, I can then use the return  keyword in the \nnormal way to produce a result from another method—in this case, the value of the \nContentLength  property. This is a much more natural technique, and it means I do \nnot have to worry about the ContinueWith  method and multiple uses of the return  \nkeyword.\nWhen you use the await  keyword, you must also add the async  keyword to the \nmethod signature, as I have done in the example. The method result type does not \nchange—my example GetPageLength  method still returns a Task<long?> . This is \nbecause await  and async  are implemented using some clever compiler tricks, mean-\ning that they allow a more natural syntax, but they do not change what is happening in \nthe methods to which they are applied. Someone who is calling my GetPageLength  \nmethod still has to deal with a Task<long?>  result because there is still a background \noperation that produces a nullable  long—although, of course, that programmer can \nalso choose to use the await  and async  keywords.\nThis pattern follows through into the controller, which makes it easy to write asyn-\nchronous action methods, as shown in listing 5.55.\nNOTE    You can also use the async  and await  keywords in lambda expressions, \nwhich I demonstrate in later chapters.\nListing 5.55    An asynchronous action method in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public async Task<ViewResult> Index() {\n            long? length = await MyAsyncMethods.GetPageLength();\n            return View(new string[] { $""Length: {length}"" });\n        }\n    }\n}\nI have changed the result of the Index  action method to Task<ViewResult> , which \ndeclares that the action method will return a Task  that will produce a ViewResult  \nobject when it completes, which will provide details of the view that should be ren-\ndered and the data that it requires. I have added the async  keyword to the method’s \ndefinition, which allows me to use the await  keyword when calling the MyAsync-\nMethods.GetPathLength  method. .NET takes care of dealing with the continuations, \nand the result is asynchronous code that is easy to write, easy to read, and easy to main-\ntain. Restart ASP.NET Core and request http://localhost:5000, and you will see output",7731
68-5.13.3 Using an asynchronous enumerable.pdf,68-5.13.3 Using an asynchronous enumerable,"114 chapter  5 Essential C# features\nsimilar to the following (although with a different length since the content of the Man-\nning website changes often):\nLength: 472922\n5.13.3  Using an asynchronous enumerable\nAn asynchronous enumerable describes a sequence of values that will be generated \nover time. To demonstrate the issue that this feature addresses, listing 5.56 adds a \nmethod to the MyAsyncMethods  class. \nListing 5.56    Adding a method in the MyAsyncMethods.cs file in the Models folder\nnamespace LanguageFeatures.Models {\n    public class MyAsyncMethods {\n        public async static Task<long?> GetPageLength() {\n            HttpClient client = new HttpClient();\n            var httpMessage = await client.GetAsync(""http://manning.com"");\n            return httpMessage.Content.Headers.ContentLength;\n        }\n        public static async Task<IEnumerable<long?>>\n                GetPageLengths(List<string> output, \n                    params string[] urls) {\n            List<long?> results = new List<long?>();\n            HttpClient client = new HttpClient();\n            foreach (string url in urls) {\n                output.Add($""Started request for {url}"");\n                var httpMessage = await client.GetAsync($""http://{url}"");\n                results.Add(httpMessage.Content.Headers.ContentLength);\n                output.Add($""Completed request for {url}"");\n            }\n            return results;\n        }\n    }\n}\nThe GetPageLengths  method makes HTTP requests to a series of websites and gets \ntheir length. The requests are performed asynchronously, but there is no way to feed \nthe results back to the method’s caller as they arrive. Instead, the method waits until all \nthe requests are complete and then returns all the results in one go. In addition to the \nURLs that will be requested, this method accepts a List<string>  to which I add mes-\nsages in order to highlight how the code works. Listing 5.57 updates the Index  action \nmethod of the Home  controller to use the new method.\nListing 5.57    Using the new method in the HomeController.cs file in the Controllers \nfolder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n 115 Using asynchronous methods\n        public async Task<ViewResult> Index() {\n            List<string> output = new List<string>();\n            foreach (long? len in await MyAsyncMethods.GetPageLengths(\n                    output,\n                    ""manning.com"", ""microsoft.com"", ""amazon.com"")) {\n                output.Add($""Page length: { len}"");\n            }\n            return View(output);\n        }\n    }\n}\nThe action method enumerates the sequence produced by the GetPageLengths  \nmethod and adds each result to the List<string>  object, which produces an \nordered sequence of messages showing the interaction between the foreach  loop in \nthe Index  method that processes the results and the foreach  loop in the GetPage-\nLengths  method that generates them. Restart ASP.NET Core and request http://\nlocalhost:5000, and you will see the following output in the browser (which may take \nseveral seconds to appear and may have different page lengths):\nStarted request for manning.com\nCompleted request for manning.com\nStarted request for microsoft.com\nCompleted request for microsoft.com\nStarted request for amazon.com\nCompleted request for amazon.com\nPage length: 26973\nPage length: 199526\nPage length: 357777\nYou can see that the Index  action method doesn’t receive the results until all the HTTP \nrequests have been completed. This is the problem that the asynchronous enumerable \nfeature solves, as shown in listing 5.58.\nListing 5.58    Using an asynchronous enumerable in the MyAsyncMethods.cs file in the \nModels folder \nnamespace LanguageFeatures.Models {\n    public class MyAsyncMethods {\n        public async static Task<long?> GetPageLength() {\n            HttpClient client = new HttpClient();\n            var httpMessage = await client.GetAsync(""http://manning.com"");\n            return httpMessage.Content.Headers.ContentLength;\n        }\n        public static async IAsyncEnumerable<long?>\n                GetPageLengths(List<string> output, \n                    params string[] urls) {\n            HttpClient client = new HttpClient();\n            foreach (string url in urls) {\n                output.Add($""Started request for {url}"");\n                var httpMessage = await client.GetAsync($""http://{url}"");\n116 chapter  5 Essential C# features\n                output.Add($""Completed request for {url}"");\n                yield return httpMessage.Content.Headers.ContentLength;\n            }\n        }\n    }\n}\nThe methods result is IAsyncEnumerable<long?> , which denotes an asynchronous \nsequence of nullable long values. This result type has special support in .NET Core and \nworks with standard yield return  statements, which isn’t otherwise possible because \nthe result constraints for asynchronous methods conflict with the yield  keyword. List-\ning 5.59 updates the controller to use the revised method.\nListing 5.59    Using an asynchronous enumerable in the HomeController.cs file in the \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public async Task<ViewResult> Index() {\n            List<string> output = new List<string>();\n            await foreach (long? len in MyAsyncMethods.GetPageLengths(\n                    output,\n                    ""manning.com"", ""microsoft.com"", ""amazon.com"")) {\n                output.Add($""Page length: { len}"");\n            }\n            return View(output);\n        }\n    }\n}\nThe difference is that the await  keyword is applied before the foreach  keyword and \nnot before the call to the async  method. Restart ASP.NET Core and request http://\nlocalhost:5000; once the HTTP requests are complete, you will see that the order of \nthe response messages has changed, like this:\nStarted request for manning.com\nCompleted request for manning.com\nPage length: 26973\nStarted request for microsoft.com\nCompleted request for microsoft.com\nPage length: 199528\nStarted request for amazon.com\nCompleted request for amazon.com\nPage length: 441398\nThe controller receives the next result in the sequence as it is produced. As I explain in \nchapter 19, ASP.NET Core has special support for using IAsyncEnumerable<T>  results \nin web services, allowing data values to be serialized as the values in the sequence are \ngenerated.",6595
69-6.1.1 Opening the project.pdf,69-6.1.1 Opening the project,"117 Getting names\n5.14 Getting names\nThere are many tasks in web application development in which you need to refer to \nthe name of an argument, variable, method, or class. Common examples include \nwhen you throw an exception or create a validation error when processing input from \nthe user. The traditional approach has been to use a string value hard-coded with the \nname, as shown in listing 5.60. \nListing 5.60    Hard-coding a name in the HomeController.cs file in the Controllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            var products = new[] {\n                new { Name = ""Kayak"", Price = 275M },\n                new { Name = ""Lifejacket"", Price = 48.95M },\n                new { Name = ""Soccer ball"", Price = 19.50M },\n                new { Name = ""Corner flag"", Price = 34.95M }\n            };\n            return View(products.Select(p => \n                $""Name: {p.Name}, Price: {p.Price}""));\n        }\n    }\n}\nThe call to the LINQ Select  method generates a sequence of strings, each of which \ncontains a hard-coded reference to the Name  and Price  properties. Restart ASP.NET \nCore and request http://localhost:5000, and you will see the following output in the \nbrowser window:\nName: Kayak, Price: 275\nName: Lifejacket, Price: 48.95\nName: Soccer ball, Price: 19.50\nName: Corner flag, Price: 34.95\nThis approach is prone to errors, either because the name was mistyped or because the \ncode was refactored and the name in the string isn’t correctly updated. C# supports the \nnameof  expression, in which the compiler takes responsibility for producing a name \nstring, as shown in listing 5.61.\nListing 5.61    Using nameof expressions in the HomeController.cs file in the  \nControllers folder\nnamespace LanguageFeatures.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            var products = new[] {\n                new { Name = ""Kayak"", Price = 275M },\n                new { Name = ""Lifejacket"", Price = 48.95M },\n                new { Name = ""Soccer ball"", Price = 19.50M },\n                new { Name = ""Corner flag"", Price = 34.95M }\n118 chapter  5 Essential C# features\n            };\n            return View(products.Select(p =>\n            $""{nameof(p.Name)}: {p.Name}, {nameof(p.Price)}: {p.Price}""));\n        }\n    }\n}\nThe compiler processes a reference such as p.Name  so that only the last part is included \nin the string, producing the same output as in previous examples. There is Intelli-\nSense support for nameof  expressions, so you will be prompted to select references, \nand expressions will be correctly updated when you refactor code. Since the compiler \nis responsible for dealing with nameof , using an invalid reference causes a compiler \nerror, which prevents incorrect or outdated references from escaping notice.\nSummary\n¡ Top-level statements allow code to be defined outside of a class, which can make \nASP.NET Core configuration more concise.\n¡ Global using  statements take effect throughout a project so that namespaces \ndon’t have to be imported in individual C# files.\n¡ Null state analysis ensures that null values are only assigned to nullable types and \nthat values are read safely.\n¡ String interpolation allows data values to be composed into strings.\n¡ Object initialization patterns simplify the code required to create objects.\n¡ Target-typed expressions omit the type name from the new statement.\n¡ Pattern matching is used to execute code when a value has specific characteristics.\n¡ Extension methods allow new functionality to be added to a type without need-\ning to modify the class file.\n¡ Lambda expressions are a concise way to express functions.\n¡ Interfaces can be defined with default implementations, which means it is possi-\nble to modify the interface without breaking implementation classes.\n¡ The async and await  keywords are used to create asynchronous methods with-\nout needing to work directly with tasks and continuations.\n1196Testing ASP.NET  \nCore applications\nThis chapter covers\n¡ Creating unit tests projects for ASP.NET Core  \n application\n¡ Writing and running unit tests\n¡ Isolating application components for testing\n¡ Simplifying component isolation with a mocking  \n package\nIn this chapter, I demonstrate how to unit test ASP.NET Core applications. Unit \ntesting is a form of testing in which individual components are isolated from the rest \nof the application so their behavior can be thoroughly validated. ASP.NET Core has \nbeen designed to make it easy to create unit tests, and there is support for a wide \nrange of unit testing frameworks. I show you how to set up a unit test project and \ndescribe the process for writing and running tests. Table 6.1 provides a guide to the \nchapter.\nDeciding whether to unit test \nBeing able to easily perform unit testing is one of the benefits of using ASP.NET Core, \nbut it isn’t for everyone, and I have no intention of pretending otherwise. \n120 chapter  6 Testing ASP.NET Core applications \n(continued)\nI like unit testing, and I use it in my own projects, but not all of them and not as consis-\ntently as you might expect. I tend to focus on writing unit tests for features and functions \nthat I know will be hard to write and likely will be the source of bugs in deployment. In \nthese situations, unit testing helps structure my thoughts about how to best implement \nwhat I need. I find that just thinking about what I need to test helps produce ideas about \npotential problems, and that’s before I start dealing with actual bugs and defects.\nThat said, unit testing is a tool and not a religion, and only you know how much testing \nyou require. If you don’t find unit testing useful or if you have a different methodology that \nsuits you better, then don’t feel you need to unit test just because it is fashionable. (How-\never, if you don’t  have a better methodology and you are not testing at all, then you are \nprobably letting users find your bugs, which is rarely ideal . You don’t have  to unit test, but \nyou really should consider doing some  testing of some  kind.) \nIf you have not encountered unit testing before, then I encourage you to give it a try to see \nhow it works. If you are not a fan of unit testing, then you can skip this chapter and move \non to chapter 7, where I start to build a more realistic ASP.NET Core application.\nTable 6.1    Chapter guide\nProblem Solution Listing\nCreating a unit test project Use the  dotnet new  command with \nthe project template for your preferred \ntest framework.8\nCreating an XUnit test Create a class with methods decorated \nwith the Fact  attribute and use the \nAssert  class to inspect the test \nresults.10\nRunning unit tests Use the Visual Studio or Visual Studio \nCode test runners or use the  dotnet \ntest  command.12\nIsolating a component for \ntestingCreate mock implementations of the \nobjects that the component under test \nrequires.13–20\n6.1 Preparing for this chapter\nTo prepare for this chapter, I need to create a simple ASP.NET Core project. Open a \nnew PowerShell command prompt using the Windows Start menu, navigate to a conve-\nnient location, and run the commands shown in listing 6.1. \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.",7632
70-6.1.3 Enabling the MVC Framework.pdf,70-6.1.3 Enabling the MVC Framework,"121 Preparing for this chapter\nListing 6.1    Creating the example project \ndotnet new globaljson --sdk-version 7.0.100 --output Testing/SimpleApp\ndotnet new web --no-https --output Testing/SimpleApp --framework net7.0\ndotnet new sln -o Testing\ndotnet sln Testing add Testing/SimpleApp\nThese commands create a new project named SimpleApp using the web template, \nwhich contains the minimal configuration for ASP.NET Core applications. The project \nfolder is contained within a solution folder also called Testing .\n6.1.1 Opening the project \nIf you are using Visual Studio, select File > Open > Project/Solution, select the  \nTesting.sln file in the Testing folder, and click the Open button to open the solu-\ntion file and the project it references. If you are using Visual Studio Code, select File > \nOpen Folder, navigate to the Testing folder, and click the Select Folder button.\n6.1.2 Selecting the HTTP port\nSet the port on which ASP.NET Core will receive HTTP requests by editing the launch-\nSettings.json  file in the Properties  folder, as shown in listing 6.2.\nListing 6.2    Setting the HTTP port in the launchSettings.json file in the Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""SimpleApp"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}",1860
71-6.1.4 Creating the application components.pdf,71-6.1.4 Creating the application components,"122 chapter  6 Testing ASP.NET Core applications \n6.1.3 Enabling the MVC Framework \nAs I explained in chapter 1, ASP.NET Core supports different application frameworks, \nbut I am going to continue using the MVC Framework in this chapter. I introduce the \nother frameworks in the SportsStore application that I start to build in chapter 7, but \nfor the moment, the MVC Framework gives me a foundation for demonstrating how to \nperform unit testing that is familiar from earlier examples. Add the statements shown \nin listing 6.3 to the Program.cs  file in the SimpleApp  folder.\nListing 6.3    Enabling the MVC Framework in the Program.cs file in the SimpleApp folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nvar app = builder.Build();\n//app.MapGet(""/"", () => ""Hello World!"");\napp.MapDefaultControllerRoute();\napp.Run();\n6.1.4 Creating the application components \nNow that the MVC Framework is set up, I can add the application components that I \nwill use to run tests. \ncreating  the data model\nI started by creating a simple model class so that I can have some data to work with. \nI added a folder called Models  and created a class file called Product.cs  within it, \nwhich I used to define the class shown in listing 6.4. \nListing 6.4    The contents of the Product.cs file in the Models folder\nnamespace SimpleApp.Models {\n    public class Product {\n        public string Name { get; set; } = string.Empty;\n        public decimal? Price { get; set; }\n        public static Product[] GetProducts() {\n            Product kayak = new Product {\n                Name = ""Kayak"", Price = 275M\n            };\n            Product lifejacket = new Product {\n                Name = ""Lifejacket"", Price = 48.95M\n            };\n            return new Product[] { kayak, lifejacket };\n        }\n    }\n}\n 123 Preparing for this chapter\nThe Product  class defines Name  and Price  properties, and there is a static  method \ncalled GetProducts  that returns a Products  array. \ncreating  the controller  and view\nFor the examples in this chapter, I use a simple controller class to demonstrate differ-\nent language features. I created a Controllers  folder and added to it a class file called \nHomeController.cs , the contents of which are shown in listing 6.5. \nListing 6.5    The contents of the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SimpleApp.Models;\nnamespace SimpleApp.Controllers {\n    public class HomeController : Controller {\n        public ViewResult Index() {\n            return View(Product.GetProducts());\n        }\n    }\n}\nThe Index  action method tells ASP.NET Core to render the default view and provides \nit with the Product  objects obtained from the static Product.GetProducts  method. \nTo create the view for the action method, I added a Views/Home  folder (by creating a \nViews  folder and then adding a Home  folder within it) and added a Razor View called \nIndex.cshtml , with the contents shown in listing 6.6.\nListing 6.6    The contents of the Index.cshtml file in the Views/Home folder \n@using SimpleApp.Models\n@model IEnumerable<Product>\n@{ Layout = null; }\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>Simple App</title>\n</head>\n<body>\n    <ul>\n        @foreach (Product p in Model ?? Enumerable.Empty<Product>()) {\n            <li>Name: @p.Name, Price: @p.Price</li>\n        }\n    </ul>\n</body>\n</html>",3552
72-6.1.5 Running the example application.pdf,72-6.1.5 Running the example application,,0
73-6.3 Writing and running unit tests.pdf,73-6.3 Writing and running unit tests,"124 chapter  6 Testing ASP.NET Core applications \n6.1.5 Running the example application \nStart ASP.NET Core by running the command shown in listing 6.7 in the SimpleApp  \nfolder.\nListing 6.7    Running the example application \ndotnet run\nRequest http://localhost:5000, and you will see the output shown in figure 6.1.\nFigure 6.1    Running the example application \n6.2 Creating a unit test project\nFor ASP.NET Core applications, you generally create a separate Visual Studio project \nto hold the unit tests, each of which is defined as a method in a C# class. Using a sep-\narate project means you can deploy your application without also deploying the tests. \nThe .NET Core SDK includes templates for unit test projects using three popular test \ntools, as described in table 6.2.  \nTable 6.2    The unit test project tools\nName Description\nmstest This template creates a project configured for the MS Test \nframework, which is produced by Microsoft.\nnunit This template creates a project configured for the NUnit \nframework.\nxunit This template creates a project configured for the XUnit \nframework.\nThese testing frameworks have largely the same feature set and differ only in how \nthey are implemented and how they integrate into third-party testing environments. I \nrecommend starting with XUnit if you do not have an established preference, largely \nbecause it is the test framework that I find easiest to work with. \nThe convention is to name the unit test project <ApplicationName>.Tests . Run \nthe commands shown in listing 6.8 in the Testing  folder to create the XUnit test proj-\nect named SimpleApp.Tests , add it to the solution file, and create a reference between \nprojects so the unit tests can be applied to the classes defined in the SimpleApp  project.  \n 125 Writing and running unit tests\nListing 6.8    Creating the unit test project \ndotnet new xunit -o SimpleApp.Tests --framework net7.0\ndotnet sln add SimpleApp.Tests\ndotnet add SimpleApp.Tests reference SimpleApp\nIf you are using Visual Studio, you will be prompted to reload the solution, which will \ncause the new unit test project to be displayed in the Solution Explorer, alongside the \nexisting project. You may find that Visual Studio Code doesn’t build the new project. If \nthat happens, select Terminal > Configure Default Build Task, select “build” from the \nlist, and, if prompted, select .NET Core from the list of environments. \nremoving  the default  test class\nThe project template adds a C# class file to the test project, which will confuse the \nresults of later examples. Either delete the UnitTest1.cs  file from the SimpleApp \n.Tests  folder using the Solution Explorer or File Explorer pane or run the command \nshown in listing 6.9 in the Testing  folder.\nListing 6.9    Removing the default test class file\nRemove-Item SimpleApp.Tests/UnitTest1.cs\n6.3 Writing and running unit tests\nNow that all the preparation is complete, I can write some tests. To get started, I added \na class file called ProductTests.cs  to the SimpleApp.Tests  project and used it to \ndefine the class shown in listing 6.10. This is a simple class, but it contains everything \nrequired to get started with unit testing.  \nNOTE    The CanChangeProductPrice  method contains a deliberate error that I \nresolve later in this section.\nListing 6.10    The contents of the ProductTests.cs file in the SimpleApp.Tests folder\nusing SimpleApp.Models;\nusing Xunit;\nnamespace SimpleApp.Tests {\n    public class ProductTests {\n        [Fact]\n        public void CanChangeProductName() {\n            // Arrange\n            var p = new Product { Name = ""Test"", Price = 100M };\n            // Act\n            p.Name = ""New Name"";\n            //Assert\n126 chapter  6 Testing ASP.NET Core applications \n            Assert.Equal(""New Name"", p.Name);\n        }\n        [Fact]\n        public void CanChangeProductPrice() {\n            // Arrange\n            var p = new Product { Name = ""Test"", Price = 100M };\n            // Act\n            p.Price = 200M;\n            //Assert\n            Assert.Equal(100M, p.Price);\n        }\n    }\n}\nThere are two unit tests in the ProductTests  class, each of which tests a behavior of \nthe Product  model class from the SimpleApp  project. A test project can contain many \nclasses, each of which can contain many unit tests. \nConventionally, the name of the test methods describes what the test does, and the \nname of the class describes what is being tested. This makes it easier to structure the tests in \na project and to understand what the results of all the tests are when they are run by Visual \nStudio. The name ProductTests  indicates that the class contains tests for the Product  \nclass, and the method names indicate that they test the ability to change the name and \nprice of a Product  object.\nThe Fact  attribute is applied to each method to indicate that it is a test. Within the \nmethod body, a unit test follows a pattern called arrange, act, assert  (A/A/A). Arrange  \nrefers to setting up the conditions for the test, act refers to performing the test, and \nassert refers to verifying that the result was the one that was expected.\nThe arrange and act sections of these tests are regular C# code, but the assert section \nis handled by xUnit.net, which provides a class called Assert , whose methods are used \nto check that the outcome of an action is the one that is expected. \nTIP    The Fact  attribute and the Assert  class are defined in the Xunit  name-\nspace, for which there must be a using  statement in every test class.\nThe methods of the Assert  class are static and are used to perform different kinds of \ncomparison between the expected and actual results. Table 6.3 shows the commonly \nused Assert  methods.",5831
74-6.3.2 Running tests with Visual Studio Code.pdf,74-6.3.2 Running tests with Visual Studio Code,"127 Writing and running unit tests\nTable 6.3    Commonly used xUnit.net assert methods\nName Description\nEqual(expected, result) This method asserts that the result is equal to the expected \noutcome. There are overloaded versions of this method for \ncomparing different types and for comparing collections. \nThere is also a version of this method that accepts an addi-\ntional argument of an object that implements the  IEqual-\nityComparer<T>  interface for comparing objects.\nNotEqual(expected, result) This method asserts that the result is not equal to the \nexpected outcome.\nTrue(result) This method asserts that the result is  true .\nFalse(result) This method asserts that the result is  false .\nIsType(expected, result) This method asserts that the result is of a specific type.\nIsNotType(expected, result) This method asserts that the result is not a specific type.\nIsNull(result) This method asserts that the result is  null .\nIsNotNull(result) This method asserts that the result is not  null .\nInRange(result, low, high) This method asserts that the result falls between low and \nhigh .\nNotInRange(result, low, high) This method asserts that the result falls outside  low  and \nhigh .\nThrows(exception, expression) This method asserts that the specified expression throws a \nspecific exception type.\nEach Assert  method allows different types of comparison to be made and throws an \nexception if the result is not what was expected. The exception is used to indicate that \na test has failed. In the tests in listing 6.10, I used the Equal  method to determine \nwhether the value of a property has been changed correctly.\n...\nAssert.Equal(""New Name"", p.Name);\n...\n6.3.1 Running tests with the Visual Studio Test Explorer\nVisual Studio includes support for finding and running unit tests through the Test \nExplorer window, which is available through the Test > Test Explorer menu and is \nshown in figure 6.2. \nTIP    Build the solution if you don’t see the unit tests in the Test Explorer win-\ndow. Compilation triggers the process by which unit tests are discovered.\nFigure 6.2    \nThe Visual Studio \nTest Explorer",2159
75-6.3.5 Isolating components for unit testing.pdf,75-6.3.5 Isolating components for unit testing,"128 chapter  6 Testing ASP.NET Core applications \nRun the tests by clicking the Run All Tests button in the Test Explorer window (it is the \nbutton that shows two arrows and is the first button in the row at the top of the win-\ndow). As noted, the CanChangeProductPrice  test contains an error that causes the \ntest to fail, which is clearly indicated in the test results shown in the figure. \n6.3.2 Running tests with Visual Studio Code \nVisual Studio Code detects tests and allows them to be run using the code lens fea-\nture, which displays details about code features in the editor. To run all the tests in the  \nProductTests  class, click Run All Tests in the code editor when the unit test class is \nopen, as shown in figure 6.3.  \nTIP    Close and reopen the Testing  folder in Visual Studio Code if you don’t see \nthe code lens test features.\nFigure 6.3    Running tests with the Visual Studio Code code lens feature\nVisual Studio Code runs the tests using the command-line tools that I describe in the \nfollowing section, and the results are displayed as text in a terminal window.\n6.3.3 Running tests from the command line \nTo run the tests in the project, run the command shown in listing 6.11 in the Testing  \nfolder. \nListing 6.11    Running unit tests \ndotnet test\nThe tests are discovered and executed, producing the following results, which show \nthe deliberate error that I introduced earlier:\nStarting test execution, please wait...\nA total of 1 test files matched the specified pattern.\n[xUnit.net 00:00:00.81]      \n    SimpleApp.Tests.ProductTests.CanChangeProductPrice [FAIL]\n  Failed SimpleApp.Tests.ProductTests.CanChangeProductPrice [4 ms]\n  Error Message:\n   Assert.Equal() Failure\nExpected: 100\nActual:   200\n 129 Writing and running unit tests\n  Stack Trace:\n     at SimpleApp.Tests.ProductTests.CanChangeProductPrice() in \n       C:\Testing\SimpleApp.Tests\ProductTests.cs:line 31\n   at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** \n      arguments, Signature sig, Boolean isConstructor)\n   at System.Reflection.MethodInvoker.Invoke(Object obj, IntPtr* args, \n     BindingFlags invokeAttr)\nFailed!  - Failed:     1, Passed:     1, Skipped:     0,  \n    Total:     2, Duration: 26 ms - SimpleApp.Tests.dll (net7.0)\n6.3.4 Correcting the unit test \nThe problem with the unit test is with the arguments to the Assert.Equal  method, \nwhich compares the test result to the original Price  property value rather than the \nvalue it has been changed to. Listing 6.12 corrects the problem.\nTIP    When a test fails, it is always a good idea to check the accuracy of the test \nbefore looking at the component it targets, especially if the test is new or has \nbeen recently modified.\nListing 6.12    Correcting a test in the ProductTests.cs file in the SimpleApp.Tests folder\nusing SimpleApp.Models;\nusing Xunit;\nnamespace SimpleApp.Tests {\n    public class ProductTests {\n        [Fact]\n        public void CanChangeProductName() {\n            // Arrange\n            var p = new Product { Name = ""Test"", Price = 100M };\n            // Act\n            p.Name = ""New Name"";\n            //Assert\n            Assert.Equal(""New Name"", p.Name);\n        }\n        [Fact]\n        public void CanChangeProductPrice() {\n            // Arrange\n            var p = new Product { Name = ""Test"", Price = 100M };\n            // Act\n            p.Price = 200M;\n            //Assert\n130 chapter  6 Testing ASP.NET Core applications \n            Assert.Equal(200M, p.Price);\n        }\n    }\n}\nRun the tests again, and you will see they all pass. If you are using Visual Studio, you \ncan click the Run Failed Tests button, which will execute only the tests that failed, as \nshown in figure 6.4.\nFigure 6.4    Running only failed tests\n6.3.5 Isolating components for unit testing \nWriting unit tests for model classes like Product  is easy. Not only is the Product  \nclass simple, but it is self-contained, which means that when I perform an action on a  \nProduct  object, I can be confident that I am testing the functionality provided by the \nProduct  class. \nThe situation is more complicated with other components in an ASP.NET Core \napplication because there are dependencies between them. The next set of tests that I \ndefine will operate on the controller, examining the sequence of Product  objects that \nare passed between the controller and the view. \nWhen comparing objects instantiated from custom classes, you will need to use \nthe xUnit.net Assert.Equal  method that accepts an argument that implements the \nIEqualityComparer<T>  interface so that the objects can be compared. My first step \nis to add a class file called Comparer.cs  to the unit test project and use it to define the \nhelper classes shown in listing 6.13.\nListing 6.13    The contents of the Comparer.cs file in the SimpleApp.Tests folder\nusing System;\nusing System.Collections.Generic;\nnamespace SimpleApp.Tests {\n    public class Comparer {\n        public static Comparer<U?> Get<U>(Func<U?, U?, bool> func) {\n            return new Comparer<U?>(func);\n        }\n    }\n 131 Writing and running unit tests\n    public class Comparer<T> : Comparer, IEqualityComparer<T> {\n        private Func<T?, T?, bool> comparisonFunction;\n        public Comparer(Func<T?, T?, bool> func) {\n            comparisonFunction = func;\n        }\n        public bool Equals(T? x, T? y) {\n            return comparisonFunction(x, y);\n        }\n        public int GetHashCode(T obj) {\n            return obj?.GetHashCode() ?? 0;\n        }\n    }\n}\nThese classes will allow me to create IEqualityComparer<T>  objects using lambda \nexpressions rather than having to define a new class for each type of comparison that I \nwant to make. This isn’t essential, but it will simplify the code in my unit test classes and \nmake them easier to read and maintain.\nNow that I can easily make comparisons, I can illustrate the problem of \ndependencies between components in the application. I added a new class called \nHomeControllerTests.cs  to the SimpleApp.Tests  folder and used it to define the \nunit test shown in listing 6.14.\nListing 6.14    The HomeControllerTests.cs file in the SimpleApp.Tests folder\nusing Microsoft.AspNetCore.Mvc;\nusing System.Collections.Generic;\nusing SimpleApp.Controllers;\nusing SimpleApp.Models;\nusing Xunit;\nnamespace SimpleApp.Tests {\n    public class HomeControllerTests {\n        [Fact]\n        public void IndexActionModelIsComplete() {\n            // Arrange\n            var controller = new HomeController();\n            Product[] products = new Product[]  {\n                new Product { Name = ""Kayak"", Price = 275M },\n                new Product { Name = ""Lifejacket"", Price = 48.95M}\n            };\n            // Act\n            var model = (controller.Index() as ViewResult)?.ViewData.Model\n                as IEnumerable<Product>;\n            // Assert\n            Assert.Equal(products, model,\n                Comparer.Get<Product>((p1, p2) => p1?.Name == p2?.Name\n132 chapter  6 Testing ASP.NET Core applications \n                    && p1?.Price == p2?.Price));\n        }\n    }\n}\nThe unit test creates an array of Product  objects and checks that they correspond to \nthe ones the Index  action method provides as the view model. (Ignore the act section \nof the test for the moment; I explain the ViewResult  class in chapters 21 and 22. For \nthe moment, it is enough to know that I am getting the model data returned by the \nIndex  action method.)\nThe test passes, but it isn’t a useful result because the Product  data that I am testing \nis coming from the hardwired objects’ Product  class. I can’t write a test to make sure \nthat the controller behaves correctly when there are more than two Product  objects, \nfor example, or if the Price  property of the first object has a decimal fraction. The \noverall effect is that I am testing the combined behavior of the HomeController  and \nProduct  classes and only for the specific hardwired objects. \nUnit tests are effective when they target small parts of an application, such as an indi-\nvidual method or class. What I need is the ability to isolate the Home  controller from the \nrest of the application so that I can limit the scope of the test and rule out any impact \ncaused by the repository.\nisolating  a component\nThe key to isolating components is to use C# interfaces. To separate the controller \nfrom the repository, I added a new class file called IDataSource.cs  to the Models  \nfolder and used it to define the interface shown in listing 6.15.\nListing 6.15    The contents of the IDataSource.cs file in the SimpleApp/Models folder\nnamespace SimpleApp.Models {\n    public interface IDataSource {\n        IEnumerable<Product> Products { get; }\n    }\n}\nIn listing 6.16, I have removed the static method from the Product  class and created a \nnew class that implements the IDataSource  interface.\nListing 6.16    A data source in the Product.cs file in the SimpleApp/Models folder\nnamespace SimpleApp.Models {\n    public class Product {\n        public string Name { get; set; } = string.Empty;\n        public decimal? Price { get; set; }\n        //public static Product[] GetProducts() {\n        //    Product kayak = new Product {\n        //        Name = ""Kayak"", Price = 275M\n 133 Writing and running unit tests\n        //    };\n        //    Product lifejacket = new Product {\n        //        Name = ""Lifejacket"", Price = 48.95M\n        //    };\n        //    return new Product[] { kayak, lifejacket };\n        //}\n    }\n    public class ProductDataSource : IDataSource {\n        public IEnumerable<Product> Products =>\n            new Product[] {\n                new Product { Name = ""Kayak"", Price = 275M },\n                new Product { Name = ""Lifejacket"", Price = 48.95M }\n            };\n    }\n}\nThe next step is to modify the controller so that it uses the ProductDataSource  class \nas the source for its data, as shown in listing 6.17.\nTIP    ASP.NET Core supports a more elegant approach for solving this prob-\nlem, known as dependency injection , which I describe in chapter 14. Dependency \ninjection often causes confusion, so I isolate components in a simpler and more \nmanual way in this chapter.\nListing 6.17    Adding a property in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SimpleApp.Models;\nnamespace SimpleApp.Controllers {\n    public class HomeController : Controller {\n        public IDataSource dataSource = new ProductDataSource();\n        public ViewResult Index() {\n            return View(dataSource.Products);\n        }\n    }\n}\nThis may not seem like a significant change, but it allows me to change the data source \nthe controller uses during testing, which is how I can isolate the controller. In list-\ning 6.18, I have updated the controller unit tests so they use a special version of the \nrepository.\nListing 6.18    Isolating the controller in the HomeControllerTests.cs file in the \nSimpleApp.Tests folder\nusing Microsoft.AspNetCore.Mvc;\nusing System.Collections.Generic;\nusing SimpleApp.Controllers;\nusing SimpleApp.Models;\n134 chapter  6 Testing ASP.NET Core applications \nusing Xunit;\nnamespace SimpleApp.Tests {\n    public class HomeControllerTests {\n        class FakeDataSource : IDataSource {\n            public FakeDataSource(Product[] data) => Products = data;\n            public IEnumerable<Product> Products { get; set; }\n        }\n        [Fact]\n        public void IndexActionModelIsComplete() {\n            // Arrange\n            Product[] testData = new Product[] {\n                new Product { Name = ""P1"", Price = 75.10M },\n                new Product { Name = ""P2"", Price = 120M },\n                new Product { Name = ""P3"", Price = 110M }\n            };\n            IDataSource data = new FakeDataSource(testData);\n            var controller = new HomeController();\n            controller.dataSource = data;\n            // Act\n            var model = (controller.Index() as ViewResult)?.ViewData.Model\n                as IEnumerable<Product>;\n            // Assert\n            Assert.Equal(data.Products, model,\n                Comparer.Get<Product>((p1, p2) => p1?.Name == p2?.Name\n                    && p1?.Price == p2?.Price));\n        }\n    }\n}\nI have defined a fake implementation of the IDataSource interface that lets me use \nany test data with the controller.\nUnderstanding test-driven development\nI have followed the most commonly used unit testing style in this chapter, in which an \napplication feature is written and then tested to make sure it works as required. This is \npopular because most developers think about application code first and testing comes \nsecond (this is certainly the category that I fall into).\nThis approach is that it tends to produce unit tests that focus only on the parts of the \napplication code that were difficult to write or that needed some serious debugging, leav -\ning some aspects of a feature only partially tested or untested altogether.\nAn alternative approach is Test-Driven Development  (TDD). There are lots of variations on \nTDD, but the core idea is that you write the tests for a feature before implementing the \nfeature itself. Writing the tests first makes you think more carefully about the specifica -\ntion you are implementing and how you will know that a feature has been implemented \ncorrectly. Rather than diving into the implementation detail, TDD makes you consider \nwhat the measures of success or failure will be in advance.",13746
76-6.3.6 Using a mocking package.pdf,76-6.3.6 Using a mocking package,,0
77-6.3.7 Creating a mock object.pdf,77-6.3.7 Creating a mock object,"135 Writing and running unit tests\n(continued)\nThe tests that you write will all fail initially because your new feature will not be imple-\nmented. But as you add code to the application, your tests will gradually move from red to \ngreen, and all your tests will pass by the time that the feature is complete. TDD requires \ndiscipline, but it does produce a more comprehensive set of tests and can lead to more \nrobust and reliable code.\n \n6.3.6 Using a mocking package \nIt was easy to create a fake implementation for the IDataSource  interface, but most \nclasses for which fake implementations are required are more complex and cannot be \nhandled as easily.\nA better approach is to use a mocking package, which makes it easy to create fake—\nor mock—objects for tests. There are many mocking packages available, but the one I \nuse (and have for years) is called Moq. To add Moq to the unit test project, run the com-\nmand shown in listing 6.19 in the Testing folder.  \nNOTE     The Moq package is added to the unit testing project and not the project \nthat contains the application to be tested.\nListing 6.19    Installing the mocking package \ndotnet add SimpleApp.Tests package Moq --version 4.18.4\n6.3.7 Creating a mock object\nI can use the Moq framework to create a fake IDataSource  object without having to \ndefine a custom test class, as shown in listing 6.20.  \nListing 6.20    Creating a mock object in the HomeControllerTests.cs file in the \nSimpleApp.Tests folder\nusing Microsoft.AspNetCore.Mvc;\nusing System.Collections.Generic;\nusing SimpleApp.Controllers;\nusing SimpleApp.Models;\nusing Xunit;\nusing Moq;\nnamespace SimpleApp.Tests {\n    public class HomeControllerTests {\n        //class FakeDataSource : IDataSource {\n        //    public FakeDataSource(Product[] data) => Products = data;\n        //    public IEnumerable<Product> Products { get; set; }\n        //}\n136 chapter  6 Testing ASP.NET Core applications \n        [Fact]\n        public void IndexActionModelIsComplete() {\n            // Arrange\n            Product[] testData = new Product[] {\n                new Product { Name = ""P1"", Price = 75.10M },\n                new Product { Name = ""P2"", Price = 120M },\n                new Product { Name = ""P3"", Price = 110M }\n            };\n            var mock = new Mock<IDataSource>();\n            mock.SetupGet(m => m.Products).Returns(testData);\n            var controller = new HomeController();\n            controller.dataSource = mock.Object;\n            // Act\n            var model = (controller.Index() as ViewResult)?.ViewData.Model\n                as IEnumerable<Product>;\n            // Assert\n            Assert.Equal(testData, model,\n                Comparer.Get<Product>((p1, p2) => p1?.Name == p2?.Name\n                    && p1?.Price == p2?.Price));\n            mock.VerifyGet(m => m.Products, Times.Once);\n        }\n    }\n}\nThe use of Moq has allowed me to remove the fake implementation of the IData-\nSource interface and replace it with a few lines of code. I am not going to go into \ndetail about the different features that Moq supports, but I will explain the way that I \nused Moq in the examples. (See https://github.com/Moq/moq4  for examples and \ndocumentation for Moq. There are also examples in later chapters as I explain how to \nunit test different types of components.)\nThe first step is to create a new instance of the Mock  object, specifying the interface \nthat should be implemented, like this:\n...\nvar mock = new Mock<IDataSource>();\n...\nThe Mock  object I created will fake the IDataSource  interface. To create an imple-\nmentation of the Product  property, I use the SetUpGet  method, like this:\n...\nmock.SetupGet (m => m.Products).Returns(testData);\n... \nThe SetupGet  method is used to implement the getter for a property. The argument \nto this method is a lambda expression that specifies the property to be implemented, \nwhich is Products  in this example. The Returns  method is called on the result of the \nSetupGet  method to specify the result that will be returned when the property value \nis read.",4150
78-7.1.1 Creating the unit test project.pdf,78-7.1.1 Creating the unit test project,"137 Summary\nThe Mock  class defines an Object  property, which returns the object that imple-\nments the specified interface with the behaviors that have been defined. I used the \nObject  property to set the dataSource  field defined by the HomeController , like this:\n...\ncontroller.dataSource = mock.Object;\n...\nThe final Moq feature I used was to check that the Products  property was called once, \nlike this:\n...\nmock.VerifyGet(m => m.Products, Times.Once);\n...\nThe VerifyGet  method is one of the methods defined by the Mock  class to inspect \nthe state of the mock object when the test has completed. In this case, the VerifyGet  \nmethod allows me to check the number of times that the Products  property method \nhas been read. The Times.Once  value specifies that the VerifyGet  method should \nthrow an exception if the property has not been read exactly once, which will cause \nthe test to fail. (The Assert  methods usually used in tests work by throwing an excep-\ntion when a test fails, which is why the VerifyGet  method can be used to replace an \nAssert  method when working with mock objects.)\nThe overall effect is the same as my fake interface implementation, but mocking is \nmore flexible and more concise and can provide more insight into the behavior of the \ncomponents under test.\nSummary\n¡ Unit tests are typically defined within a dedicated unit test project.\n¡ A test framework simplifies writing unit tests by providing common features, \nsuch as assertions.\n¡ Unit tests typically follow the arrange/act/assert pattern.\n¡ Tests can be run within Visual Studio/Visual Studio Code or using the dotnet \ntest  command.\n¡ Effective unit tests isolate and test individual components.\n¡ Isolating components is simplified by mocking packages, such as Moq.\n1387SportsStore:  \nA real application\nThis chapter covers\n¡ Creating the SportsStore ASP.NET Core project\n¡ Adding a data model and support for a   \n database\n¡ Displaying a basic product catalog\n¡ Paginating data\n¡ Styling content \nIn the previous chapters, I built quick and simple ASP.NET Core applications. I \ndescribed ASP.NET Core patterns, the essential C# features, and the tools that good \nASP.NET Core developers require. Now it is time to put everything together and \nbuild a simple but realistic e-commerce application.\nMy application, called SportsStore, will follow the classic approach taken by online \nstores everywhere. I will create an online product catalog that customers can browse \nby category and page, a shopping cart where users can add and remove products, \nand a checkout where customers can enter their shipping details. I will also create an \nadministration area that includes create, read, update, and delete (CRUD) facilities \nfor managing the catalog, and I will protect it so that only logged-in administrators \ncan make changes.\nMy goal in this chapter and those that follow is to give you a sense of what real \nASP.NET Core development is by creating as realistic an example as possible. I \nwant to focus on ASP.NET Core, of course, so I have simplified the integration with \nexternal systems, such as the database, and omitted others entirely, such as payment \nprocessing.\n 139 Creating the projects\nYou might find the going a little slow as I build up the levels of infrastructure I need, \nbut the initial investment will result in maintainable, extensible, well-structured code \nwith excellent support for unit testing. \nUnit testing \nI include sections on unit testing different components in the SportsStore application \nthroughout the development process, demonstrating how to isolate and test different \nASP.NET Core components. \nI know that unit testing is not embraced by everyone. If you do not want to unit test, that \nis fine with me. To that end, when I have something to say that is purely about testing, I \nput it in a sidebar like this one. If you are not interested in unit testing, you can skip right \nover these sections, and the SportsStore application will work just fine. You do not need \nto do any kind of unit testing to get the technology benefits of ASP.NET Core, although, of \ncourse, support for testing is a key reason for adopting ASP.NET Core in many projects.\nMost of the features I use for the SportsStore application have their own chapters later \nin the book. Rather than duplicate everything here, I tell you just enough to make sense \nof the example application and point you to another chapter for in-depth information. \nI will call out each step needed to build the application so that you can see how the \nASP.NET Core features fit together. You should pay particular attention when I create \nviews. You will get some odd results if you do not follow the examples closely. \n7.1 Creating the projects\nI am going to start with a minimal ASP.NET Core project and add the features I require \nas they are needed. Open a new PowerShell command prompt from the Windows Start \nmenu and run the commands shown in listing 7.1 to get started. \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 7.1    Creating the SportsStore project\ndotnet new globaljson --sdk-version 7.0.100 --output SportsSln/SportsStore\ndotnet new web --no-https --output SportsSln/SportsStore --framework net7.0\ndotnet new sln -o SportsSln \ndotnet sln SportsSln add SportsSln/SportsStore\nThese commands create a SportsSln  solution folder that contains a SportsStore  \nproject folder created with the web project template. The SportsSln  folder also con-\ntains a solution file, to which the SportsStore  project is added. \nI am using different names for the solution and project folders to make the examples \neasier to follow, but if you create a project with Visual Studio, the default is to use the",6005
79-7.1.2 Opening the projects.pdf,79-7.1.2 Opening the projects,,0
80-7.1.7 Creating the controller and view.pdf,80-7.1.7 Creating the controller and view,"140 chapter  7 SportsStore: A real application \nsame name for both folders. There is no “right” approach, and you can use whatever \nnames suit your project.\n7.1.1 Creating the unit test project\nTo create the unit test project, run the commands shown in listing 7.2 in the same loca-\ntion you used for the commands shown in listing 7.1.\nListing 7.2    Creating the unit test project \ndotnet new xunit -o SportsSln/SportsStore.Tests --framework net7.0\ndotnet sln SportsSln add SportsSln/SportsStore.Tests\ndotnet add SportsSln/SportsStore.Tests reference SportsSln/SportsStore\nI am going to use the Moq package to create mock objects. Run the command shown \nin listing 7.3 to install the Moq package into the unit testing project. Run this com-\nmand from the same location as the commands in listing 7.2.\nListing 7.3     Installing the Moq package \ndotnet add SportsSln/SportsStore.Tests package Moq --version 4.18.4\n7.1.2 Opening the projects\nIf you are using Visual Studio Code, select File > Open Folder, navigate to the \nSportsSln  folder, and click the Select Folder button. Visual Studio Code will open the \nfolder and discover the solution and project files. When prompted, as shown in figure \n7.1, click Yes to install the assets required to build the projects. Select SportsStore if \nVisual Studio Code prompts you to select the project to run.\nIf you are using Visual Studio, click the “Open a project or solution” button on the \nsplash screen or select File > Open > Project/Solution. Select the SportsSln.sln  file \nin the SportsSln  folder and click the Open button to open the project.\nFigure 7.1    Adding assets in Visual Studio Code \n7.1.3 Configuring the HTTP port \nTo configure the HTTP port that ASP.NET Core will use to listen for HTTP requests, \nmake the changes shown in listing 7.4 to the launchSettings.json  file in the \nSportsStore/Properties  folder.\n 141 Creating the projects\nListing 7.4    Setting the HTTP Port in the launchSettings.json File in the SportsStore/   \n Properties Folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""SportsStore"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\n7.1.4 Creating the application project folders\nThe next step is to create folders that will contain the application’s components. Right-\nclick the SportsStore item in the Visual Studio Solution Explorer or Visual Studio Code \nExplorer pane and select Add > New Folder or New Folder to create the set of folders \ndescribed in table 7.1. \nTable 7.1 The application project folders \nName Description\nModels This folder will contain the data model and the classes that provide \naccess to the data in the application’s database.\nControllers This folder will contain the controller classes that handle HTTP \nrequests.\nViews This folder will contain all the Razor files, grouped into separate \nsubfolders.\nViews/Home This folder will contain Razor files that are specific to the Home con -\ntroller, which I create in the “Creating the Controller and View” section.\nViews/Shared This folder will contain Razor files that are common to all controllers.\n142 chapter  7 SportsStore: A real application \n7.1.5 Preparing the services and the request pipeline\nThe Program.cs  file is used to configure the ASP.NET Core application. Apply the \nchanges shown in listing 7.5 to the Program.cs  file in the SportsStore  project to con-\nfigure the basic application features.\nNOTE     The Program.cs  file is an important ASP.NET Core feature. I describe it \nin detail in part 2.\nListing 7.5    Configuring the application in the Program.cs file in the SportsStore folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nvar app = builder.Build();\n//app.MapGet(""/"", () => ""Hello World!"");\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.Run();\nThe builder.Services  property is used to set up objects, known as services , that can \nbe used throughout the application and that are accessed through a feature called \ndependency injection , which I describe in chapter 14. The AddControllersWithViews  \nmethod sets up the shared objects required by applications using the MVC Framework \nand the Razor view engine. \nASP.NET Core receives HTTP requests and passes them along a request pipeline , which \nis populated with middleware components registered using the app property. Each \nmiddleware component is able to inspect requests, modify them, generate a response, \nor modify the responses that other components have produced. The request pipeline is \nthe heart of ASP.NET Core, and I describe it in detail in chapter 12, where I also explain \nhow to create custom middleware components. \nThe UseStaticFiles  method enables support for serving static content from the \nwwwroot  folder and will be created later in the chapter. \nOne especially important middleware component provides the endpoint routing \nfeature, which matches HTTP requests to the application features—known as end-\npoints —able to produce responses for them, a process I describe in detail in chapter 13. \nThe endpoint routing feature is added to the request pipeline automatically, and the \nMapDefaultControllerRoute  registers the MVC Framework as a source of endpoints \nusing a default convention for mapping requests to classes and methods.\n 143 Creating the projects\n7.1.6 Configuring the Razor view engine\nThe Razor view engine is responsible for processing view files, which have the .cshtml  \nextension, to generate HTML responses. Some initial preparation is required to con-\nfigure Razor to make it easier to create views for the application.\nAdd a Razor View Imports file named _ViewImports.cshtml  in the Views  folder \nwith the content shown in listing 7.6. \nCAUTION     Pay close attention to the contents of this file. It is easy to make a mis-\ntake that causes the application to generate incorrect HTML content.\nListing 7.6    The contents of the _ViewImports.cshtml file in the SportsStore/ \n Views folder\n@using SportsStore.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\nThe @using  statement will allow me to use the types in the SportsStore.Models  \nnamespace in views without needing to refer to the namespace. The @addTagHelper  \nstatement enables the built-in tag helpers, which I use later to create HTML elements \nthat reflect the configuration of the SportsStore application and which I describe in \ndetail in chapter 15. (You may see a warning or error displayed by the code editor for \nthe contents of this file, but this will be resolved shortly and can be ignored.)\nAdd a Razor View Start file named _ViewStart.cshtml  to the SportsStore/Views  \nfolder with the content shown in listing 7.7. (The file will already contain this expres-\nsion if you create the file using the Visual Studio item template.)\nListing 7.7    The contents of the _ViewStart.cshtml file in the SportsStore/Views folder\n@{\n    Layout = ""_Layout"";\n}\nThe Razor View Start file tells Razor to use a layout file in the HTML that it generates, \nreducing the amount of duplication in views. To create the view, add a Razor layout named \n_Layout.cshtml  to the Views/Shared  folder, with the content shown in listing 7.8.\nListing 7.8    The contents of the _Layout.cshtml file in the SportsStore/Views/Shared   \n folder\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>SportsStore</title>\n</head>\n<body>\n    <div>\n        @RenderBody()\n    </div>\n</body>\n</html>",8146
81-7.1.9 Checking and running the application.pdf,81-7.1.9 Checking and running the application,"144 chapter  7 SportsStore: A real application \nThis file defines a simple HTML document into which the contents of other views will \nbe inserted by the @RenderBody  expression. I explain how Razor expressions work in \ndetail in chapter 21.\n7.1.7 Creating the controller and view \nAdd a class file named HomeController.cs  in the SportsStore/Controllers  folder \nand use it to define the class shown in listing 7.9. This is a minimal controller that con-\ntains just enough functionality to produce a response.\nListing 7.9    The contents of the HomeController.cs file in the SportsStore/Controllers   \n folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace SportsStore.Controllers {\n    public class HomeController: Controller {\n        public IActionResult Index() => View();\n    }\n}\nThe MapDefaultControllerRoute  method used in listing 7.5 tells ASP.NET Core \nhow to match URLs to controller classes. The configuration applied by that method \ndeclares that the Index  action method defined by the Home  controller will be used to \nhandle requests.\nThe Index  action method doesn’t do anything useful yet and just returns the result \nof calling the View  method, which is inherited from the Controller  base class. This \nresult tells ASP.NET Core to render the default view associated with the action method. \nTo create the view, add a Razor View file named Index.cshtml  to the Views/Home  \nfolder with the content shown in listing 7.10.\nListing 7.10    The contents of the Index.cshtml file in the SportsStore/Views/Home \nfolder\n<h4>Welcome to SportsStore</h4>\n7.1.8 Starting the data model\nAlmost all projects have a data model of some sort. Since this is an e-commerce appli-\ncation, the most obvious model I need is for a product. Add a class file named Product \n.cs to the Models  folder and use it to define the class shown in listing 7.11. \nListing 7.11    The contents of the Product.cs file in the SportsStore/Models folder \nusing System.ComponentModel.DataAnnotations.Schema;\nnamespace SportsStore.Models {\n    public class Product {",2076
82-7.2.1 Installing the Entity Framework Core packages.pdf,82-7.2.1 Installing the Entity Framework Core packages,"145 Adding data to the application \n        public long? ProductID { get; set; }\n        public string Name { get; set; } = String.Empty;\n        public string Description { get; set; } = String.Empty;\n        [Column(TypeName = ""decimal(8, 2)"")]\n        public decimal Price { get; set; }\n        public string Category { get; set; } = String.Empty;\n    }\n}\nThe Price  property has been decorated with the Column  attribute to specify the SQL \ndata type that will be used to store values for this property. Not all C# types map neatly \nonto SQL types, and this attribute ensures the database uses an appropriate type for \nthe application data.\n7.1.9 Checking and running the application \nBefore going any further, it is a good idea to make sure the application builds and runs \nas expected. Run the command shown in listing 7.12 in the SportsStore  folder.\nListing 7.12    Running the example application \ndotnet run\nRequest http://localhost:5000, and you will see the response shown in figure 7.2.\nFigure 7.2    Running the example application  \n7.2 Adding data to the application \nNow that the SportsStore contains some basic setup and can produce a simple \nresponse, it is time to add some data so that the application has something more useful \nto display. The SportsStore application will store its data in a SQL Server LocalDB data-\nbase, which is accessed using Entity Framework Core. Entity Framework Core is the \nMicrosoft object-to-relational mapping (ORM) framework, and it is the most widely \nused method of accessing databases in ASP.NET Core projects.\nCAUTION    If you did not install LocalDB when you prepared your development \nenvironment in chapter 2, you must do so now. The SportsStore application will \nnot work without its database.",1784
83-7.2.4 Configuring Entity Framework Core.pdf,83-7.2.4 Configuring Entity Framework Core,"146 chapter  7 SportsStore: A real application \n7.2.1 Installing the Entity Framework Core packages \nThe first step is to add Entity Framework Core to the project. Use a PowerShell com-\nmand prompt to run the command shown in listing 7.13 in the SportsStore  folder.  \nIf you receive an error asking you to specify a project, then delete the SportsStore - \nBackup.csproj  file in the SportsStore folder and try again.\nListing 7.13    Adding the Entity Framework Core packages to the SportsStore project \ndotnet add package Microsoft.EntityFrameworkCore.Design --version 7.0.0\ndotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 7.0.0\nThese packages install Entity Framework Core and the support for using SQL Server. \nEntity Framework Core also requires a tools package, which includes the command-line \ntools required to prepare and create databases for ASP.NET Core applications. Run \nthe commands shown in listing 7.14 to remove any existing version of the tools pack-\nage, if there is one, and install the version used in this book. (Since this package is \ninstalled globally, you can run these commands in any folder.)\nListing 7.14    Installing the Entity Framework Core tool package\ndotnet tool uninstall --global dotnet-ef\ndotnet tool install --global dotnet-ef --version 7.0.0\n7.2.2 Defining the connection string\nConfiguration settings, such as database connection strings, are stored in JSON con-\nfiguration files. To describe the connection to the database that will be used for the \nSportsStore data, add the entries shown in listing 7.15 to the appsettings.json  file in \nthe SportsStore  folder.\nThe project also contains an appsettings.Development.json  file that contains \nconfiguration settings that are used only in development. This file is displayed as \nnested within the appsettings.json  file by Solution Explorer but is always visible in \nVisual Studio Code. I use only the appsettings.json  file for the development of the  \nSportsStore project, but I explain the relationship between the files and how they are \nboth used in detail in chapter 15. \nTIP    Connection strings must be expressed as a single unbroken line, which is \nfine in the code editor but doesn’t fit on the printed page and is the cause of \nthe awkward formatting in listing 7.15. When you define the connection string \nin your own project, make sure that the value of the SportsStoreConnection  \nitem is on a single line.\nListing 7.15    Adding a configuration setting in the appsettings.json file in the  \nSportsStore folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n 147 Adding data to the application \n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""ConnectionStrings"": {\n    ""SportsStoreConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database= \n‰SportsStore;MultipleActiveResultSets=true""\n  }\n}\nThis configuration string specifies a LocalDB database called SportsStore  and \nenables the multiple active result set (MARS) feature, which is required for some of \nthe database queries that will be made by the SportsStore application using Entity \nFramework Core.\nPay close attention when you add the configuration setting. JSON data must be \nexpressed exactly as shown in the listing, which means you must ensure you correctly \nquote the property names and values. You can download the configuration file from the \nGitHub repository if you have difficulty.\nTIP    Each database server requires its own connection string format. A helpful \nsite for formulating connection strings is https://www.connectionstrings.com .\n7.2.3 Creating the database context class\nEntity Framework Core provides access to the database through a context class. Add \na class file named StoreDbContext.cs  to the Models  folder and use it to define the \nclass shown in listing 7.16.\nListing 7.16    The contents of the StoreDbContext.cs file in the SportsStore/Models \nfolder\nusing Microsoft.EntityFrameworkCore;\nnamespace SportsStore.Models {\n    public class StoreDbContext : DbContext {\n        public StoreDbContext(DbContextOptions<StoreDbContext> options)\n            : base(options) { }\n        public DbSet<Product> Products => Set<Product>();\n    }\n}\nThe DbContext  base class provides access to the Entity Framework Core’s underlying \nfunctionality, and the Products  property will provide access to the Product  objects \nin the database. The StoreDbContext  class is derived from DbContext  and adds the \nproperties that will be used to read and write the application’s data. There is only one \nproperty for now, which will provide access to Product  objects.",4691
84-7.2.5 Creating a repository.pdf,84-7.2.5 Creating a repository,"148 chapter  7 SportsStore: A real application \n7.2.4 Configuring Entity Framework Core \nEntity Framework Core must be configured so that it knows the type of database to \nwhich it will connect, which connection string describes that connection, and which \ncontext class will present the data in the database. Listing 7.17 shows the required \nchanges to the Program.cs  file.\nListing 7.17    Configuring Entity Framework Core in the Program.cs file in the  \nSportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.Run();\nThe IConfiguration  interface provides access to the ASP.NET Core configuration sys-\ntem, which includes the contents of the appsettings.json  file and which I describe \nin detail in chapter 15. Access to the configuration data is through the builder  \n.­ Configuration  property, which allows the database connection string to be obtained. \nEntity Framework Core is configured with the AddDbContext  method, which regis-\nters the database context class and configures the relationship with the database. The \nUseSQLServer  method declares that SQL Server is being used.\n7.2.5 Creating a repository\nThe next step is to create a repository interface and implementation class. The reposi-\ntory pattern is one of the most widely used, and it provides a consistent way to access the \nfeatures presented by the database context class. Not everyone finds a repository useful, \nbut my experience is that it can reduce duplication and ensures that operations on the \ndatabase are performed consistently. Add a class file named IStoreRepository.cs  to \nthe Models  folder and use it to define the interface shown in listing 7.18. \nListing 7.18    The contents of the IStoreRepository.cs file in the SportsStore/Models \nfolder\nnamespace SportsStore.Models {\n    public interface IStoreRepository {\n 149 Adding data to the application \n        IQueryable<Product> Products { get; }\n    }\n}\nThis interface uses IQueryable<T>  to allow a caller to obtain a sequence of \nProduct  objects. The IQueryable<T>  interface is derived from the more familiar \nIEnumerable<T>  interface and represents a collection of objects that can be queried, \nsuch as those managed by a database. \nA class that depends on the IStoreRepository  interface can obtain Product  \nobjects without needing to know the details of how they are stored or how the imple-\nmentation class will deliver them. \nUnderstanding IEnumerable<T> and IQueryable<T> interfaces\nThe IQueryable<T>  interface is useful because it allows a collection of objects to be \nqueried efficiently. Later in this chapter, I add support for retrieving a subset of Product  \nobjects from a database, and using the IQueryable<T>  interface allows me to ask the \ndatabase for just the objects that I require using standard LINQ statements and without \nneeding to know what database server stores the data or how it processes the query. \nWithout the IQueryable<T>  interface, I would have to retrieve all of the Product  \nobjects from the database and then discard the ones that I don’t want, which becomes \nan expensive operation as the amount of data used by an application increases. \nIt is for this reason that the IQueryable<T>  interface is typically used instead of \nIEnumerable<T>  in database repository interfaces and classes.\nHowever, care must be taken with the IQueryable<T>  interface because each time \nthe collection of objects is enumerated, the query will be evaluated again, which means \nthat a new query will be sent to the database. This can undermine the efficiency gains of \nusing IQueryable<T> . In such situations, you can convert the IQueryable<T>  inter-\nface to a more predictable form using the ToList  or ToArray  extension method.\nTo create an implementation of the repository interface, add a class file named \nEFStoreRepository.cs  in the Models  folder and use it to define the class shown in \nlisting 7.19.\nListing 7.19    The contents of the EFStoreRepository.cs file in the SportsStore/Models \nfolder\nnamespace SportsStore.Models {\n    public class EFStoreRepository : IStoreRepository {\n        private StoreDbContext context;\n        public EFStoreRepository(StoreDbContext ctx) {\n            context = ctx;\n        }\n        public IQueryable<Product> Products => context.Products;\n    }\n}\n150 chapter  7 SportsStore: A real application \nI’ll add additional functionality as I add features to the application, but for the \nmoment, the repository implementation just maps the Products  property defined \nby the IStoreRepository  interface onto the Products  property defined by the \nStoreDbContext  class. The Products  property in the context class returns a DbSet \n<Product>  object, which implements the IQueryable<T>  interface and makes it easy \nto implement the repository interface when using Entity Framework Core. \nEarlier in the chapter, I explained that ASP.NET Core supports services that allow \nobjects to be accessed throughout the application. One benefit of services is they allow \nclasses to use interfaces without needing to know which implementation class is being \nused. I explain this in detail in chapter 14, but for the SportsStore chapters, it means \nthat application components can access objects that implement the IStoreRepository  \ninterface without knowing that it is the EFStoreRepository  implementation class \nthey are using. This makes it easy to change the implementation class the application \nuses without needing to make changes to the individual components. Add the \nstatement shown in listing 7.20 to the Program.cs  file to create a service for the \nIStoreRepository  interface that uses EFStoreRepository  as the implementation \nclass. \nTIP    Don’t worry if this doesn’t make sense right now. This topic is one of the \nmost confusing aspects of working with ASP.NET Core, and it can take a while to \nunderstand.\nListing 7.20    Creating the repository service in the Program.cs file in the SportsStore \nfolder \nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.Run();\nThe AddScoped  method creates a service where each HTTP request gets its own repos-\nitory object, which is the way that Entity Framework Core is typically used.",7053
85-7.2.6 Creating the database migration.pdf,85-7.2.6 Creating the database migration,,0
86-7.2.7 Creating seed data.pdf,86-7.2.7 Creating seed data,"151 Adding data to the application \n7.2.6 Creating the database migration \nEntity Framework Core can generate the schema for the database using the data \nmodel classes through a feature called migrations . When you prepare a migration, \nEntity Framework Core creates a C# class that contains the SQL commands required \nto prepare the database. If you need to modify your model classes, then you can create \na new migration that contains the SQL commands required to reflect the changes. In \nthis way, you don’t have to worry about manually writing and testing SQL commands \nand can just focus on the C# model classes in the application. \nEntity Framework Core commands are performed from the command line. Open \na PowerShell command prompt and run the command shown in listing 7.21 in the \nSportsStore  folder to create the migration class that will prepare the database for its \nfirst use.\nListing 7.21    Creating the database migration \ndotnet ef migrations add Initial\nWhen this command has finished, the SportsStore project will contain a Migrations  \nfolder. This is where Entity Framework Core stores its migration classes. One of the file \nnames will be a timestamp followed by _Initial.cs , and this is the class that will be \nused to create the initial schema for the database. If you examine the contents of this \nfile, you can see how the Product  model class has been used to create the schema.\n7.2.7 Creating seed data\nTo populate the database and provide some sample data, I added a class file called \nSeedData.cs  to the Models  folder and defined the class shown in listing 7.22.\nListing 7.22    The contents of the SeedData.cs file in the SportsStore/Models folder\nusing Microsoft.EntityFrameworkCore;\nnamespace SportsStore.Models {\n    public static class SeedData {\n        public static void EnsurePopulated(IApplicationBuilder app) {\n            StoreDbContext context = app.ApplicationServices\n                .CreateScope().ServiceProvider\n                .GetRequiredService<StoreDbContext>();\n            if (context.Database.GetPendingMigrations().Any()) {\n                context.Database.Migrate();\n            }\n            if (!context.Products.Any()) {\n                context.Products.AddRange(\n                    new Product {\n                        Name = ""Kayak"", Description = \n                            ""A boat for one person"",\n152 chapter  7 SportsStore: A real application \n                        Category = ""Watersports"", Price = 275\n                    },\n                    new Product {\n                        Name = ""Lifejacket"",\n                        Description = ""Protective and fashionable"",\n                        Category = ""Watersports"", Price = 48.95m\n                    },\n                    new Product {\n                        Name = ""Soccer Ball"",\n                        Description = ""FIFA-approved size and weight"",\n                        Category = ""Soccer"", Price = 19.50m\n                    },\n                    new Product {\n                        Name = ""Corner Flags"",\n                        Description = \n                          ""Give your playing field a professional touch"",\n                        Category = ""Soccer"", Price = 34.95m\n                    },\n                    new Product {\n                        Name = ""Stadium"",\n                        Description = ""Flat-packed 35,000-seat stadium"",\n                        Category = ""Soccer"", Price = 79500\n                    },\n                    new Product {\n                        Name = ""Thinking Cap"",\n                        Description = ""Improve brain efficiency by 75%"",\n                        Category = ""Chess"", Price = 16\n                    },\n                    new Product {\n                        Name = ""Unsteady Chair"",\n                        Description = \n                          ""Secretly give your opponent a disadvantage"",\n                        Category = ""Chess"", Price = 29.95m\n                    },\n                    new Product {\n                        Name = ""Human Chess Board"",\n                        Description = ""A fun game for the family"",\n                        Category = ""Chess"", Price = 75\n                    },\n                    new Product {\n                        Name = ""Bling-Bling King"",\n                        Description = ""Gold-plated, diamond-studded King"",\n                        Category = ""Chess"", Price = 1200\n                    }\n                );\n                context.SaveChanges();\n            }\n        }\n    }\n}\nThe static EnsurePopulated  method receives an IApplicationBuilder  argument, \nwhich is the interface used in the Program.cs  file to register middleware components \nto handle HTTP requests. IApplicationBuilder  also provides access to the applica-\ntion’s services, including the Entity Framework Core database context service.\n 153 Adding data to the application \nThe EnsurePopulated  method obtains a StoreDbContext  object through the \nIApplicationBuilder  interface and calls the Database.Migrate  method if there are \nany pending migrations, which means that the database will be created and prepared so \nthat it can store Product  objects. Next, the number of Product  objects in the database \nis checked. If there are no objects in the database, then the database is populated using \na collection of Product  objects using the AddRange  method and then written to the \ndatabase using the SaveChanges  method. \nThe final change is to seed the database when the application starts, which I have \ndone by adding a call to the EnsurePopulated  method from the Program.cs  file, as \nshown in listing 7.23.\nListing 7.23    Seeding the database in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\nSeedData.EnsurePopulated(app);\napp.Run();\nResetting the database\nIf you need to reset the database, then run this command in the SportsStore  folder:\n...\ndotnet ef database drop --force --context StoreDbContext\n...\nStart ASP.NET Core, and the database will be re-created and seeded with data.",6623
87-7.3 Displaying a list of products.pdf,87-7.3 Displaying a list of products,,0
88-7.3.1 Preparing the controller.pdf,88-7.3.1 Preparing the controller,"154 chapter  7 SportsStore: A real application \n7.3 Displaying a list of products\nAs you have seen, the initial preparation work for an ASP.NET Core project can take \nsome time. But the good news is that once the foundation is in place, the pace improves, \nand features are added more rapidly. In this section, I am going to create a controller \nand an action method that can display details of the products in the repository. \nUsing the Visual Studio scaffolding\nAs I noted in chapter 4, Visual Studio supports scaffolding to add items to a project. \nI don’t use scaffolding in this book. The code and markup that the scaffolding generates \nare so generic as to be all but useless, and the scenarios that are supported are narrow \nand don’t address common development problems. My goal in this book is not only to \nmake sure you know how to create ASP.NET Core applications but also to explain how \neverything works behind the scenes, and that is harder to do when responsibility for cre-\nating components is handed to the scaffolding. \nIf you are using Visual Studio, add items to the project by right-clicking a folder in the \nSolution Explorer, selecting Add > New Item from the pop-up menu, and then choosing an \nitem template from the Add New Item window. \nYou may find your development style to be different from mine, and you may find that \nyou prefer working with the scaffolding in your own projects. That’s perfectly reasonable, \nalthough I recommend you take the time to understand what the scaffolding does so you \nknow where to look if you don’t get the results you expect.\n7.3.1 Preparing the controller \nAdd the statements shown in listing 7.24 to prepare the controller to display the list of \nproducts.\nListing 7.24    Preparing the controller in the HomeController.cs file in the SportsStore/\nControllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nnamespace SportsStore.Controllers {\n    public class HomeController : Controller {\n        private IStoreRepository repository;\n        public HomeController(IStoreRepository repo) {\n            repository = repo;\n        }\n        public IActionResult Index() => View(repository.Products);\n    }\n}\nWhen ASP.NET Core needs to create a new instance of the HomeController  class \nto handle an HTTP request, it will inspect the constructor and see that it requires \nan object that implements the IStoreRepository  interface. To determine what \n 155 Displaying a list of products\nimplementation class should be used, ASP.NET Core consults the configuration cre-\nated in the Program.cs  file, which tells it that EFStoreRepository  should be used \nand that a new instance should be created for every request. ASP.NET Core creates a \nnew EFStoreRepository  object and uses it to invoke the HomeController  construc-\ntor to create the controller object that will process the HTTP request.\nThis is known as dependency injection , and its approach allows the HomeController  \nobject to access the application’s repository through the IStoreRepository  interface \nwithout knowing which implementation class has been configured. I could reconfigure \nthe service to use a different implementation class—one that doesn’t use Entity Frame-\nwork Core, for example—and dependency injection means that the controller will con-\ntinue to work without changes.\nNOTE     Some developers don’t like dependency injection and believe it makes \napplications more complicated. That’s not my view, but if you are new to depen-\ndency injection, then I recommend you wait until you have read chapter 14 \nbefore you make up your mind. \nUnit test: repository access\nI can unit test that the controller is accessing the repository correctly by creating a mock \nrepository, injecting it into the constructor of the HomeController  class, and then call-\ning the Index  method to get the response that contains the list of products. I then com-\npare the Product  objects I get to what I would expect from the test data in the mock \nimplementation. See chapter 6 for details of how to set up unit tests. Here is the unit test \nI created for this purpose, in a class file called HomeControllerTests.cs  that I added \nto the SportsStore.Tests  project:\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing Microsoft.AspNetCore.Mvc;\nusing Moq;\nusing SportsStore.Controllers;\nusing SportsStore.Models;\nusing Xunit;\nnamespace SportsStore.Tests {\n    public class HomeControllerTests {\n        [Fact]\n        public void Can_Use_Repository() {\n            // Arrange\n            Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n            mock.Setup(m => m.Products).Returns((new Product[] {\n                new Product {ProductID = 1, Name = ""P1""},\n                new Product {ProductID = 2, Name = ""P2""}\n            }).AsQueryable<Product>());\n            HomeController controller = new HomeController(mock.Object);",4980
89-7.3.3 Running the application.pdf,89-7.3.3 Running the application,"156 chapter  7 SportsStore: A real application \n(continued)\n            // Act\n            IEnumerable<Product>? result =\n                (controller.Index() as ViewResult)?.ViewData.Model\n                     as IEnumerable<Product>;\n            // Assert\n            Product[] prodArray = result?.ToArray() \n                ?? Array.Empty<Product>();\n            Assert.True(prodArray.Length == 2);\n            Assert.Equal(""P1"", prodArray[0].Name);\n            Assert.Equal(""P2"", prodArray[1].Name);\n        }\n    }\n}\nIt is a little awkward to get the data returned from the action method. The result is a \nViewResult  object, and I have to cast the value of its ViewData.Model  property to \nthe expected data type. I explain the different result types that can be returned by action \nmethods and how to work with them in part 2.\n7.3.2 Updating the view\nThe Index  action method in listing 7.24 passes the collection of Product  objects from \nthe repository to the View  method, which means these objects will be the view model \nthat Razor uses when it generates HTML content from the view. Make the changes \nto the view shown in listing 7.25 to generate content using the Product  view model \nobjects.\nListing 7.25    Using the product data in the Index.cshtml file in the SportsStore/\nViews/Home folder\n@model IQueryable<Product>\n@foreach (var p in Model ?? Enumerable.Empty<Product>()) {\n    <div>\n        <h3>@p.Name</h3>\n        @p.Description\n        <h4>@p.Price.ToString(""c"")</h4>\n    </div>\n}\nThe @model  expression at the top of the file specifies that the view expects to receive \na sequence of Product  objects from the action method as its model data. I use an  \n@foreach  expression to work through the sequence and generate a simple set of \nHTML elements for each Product  object that is received. \nThere is a quirk in the way that Razor Views work that means the model data is \nalways nullable, even when the type specified by the @model  expression is not. For this \nreason, I use the null-coalescing operator in the @foreach  expression with an empty \nenumeration.",2127
90-7.4 Adding pagination.pdf,90-7.4 Adding pagination,"157 Adding pagination\nThe view doesn’t know where the Product  objects came from, how they were \nobtained, or whether they represent all the products known to the application. Instead, \nthe view deals only with how details of each Product  are displayed using HTML \nelements.\nT I P     I converted the Price  property to a string using the ToString(""c"")  \nmethod, which renders numerical values as currency according to the culture \nsettings that are in effect on your server. For example, if the server is set up as \nen-US , then (1002.3).ToString(""c"")  will return $1,002.30 , but if the server \nis set to en-GB , then the same method will return £1,002.30 . \n7.3.3 Running the application\nStart ASP.NET Core and request http://localhost:5000 to see the list of products, \nwhich is shown in figure 7.3. This is the typical pattern of development for ASP.NET \nCore. An initial investment of time setting everything up is necessary, and then the \nbasic features of the application snap together quickly.\nFigure 7.3    \nDisplaying a list \nof products\n7.4 Adding pagination\nYou can see from figure 7.3 that the Index.cshtml  view displays the products in the \ndatabase on a single page. In this section, I will add support for pagination so that the \nview displays a smaller number of products on a page and so the user can move from \npage to page to view the overall catalog. To do this, I am going to add a parameter to \nthe Index  method in the Home controller, as shown in listing 7.26. \nListing 7.26    Adding pagination in the HomeController.cs file in the SportsStore/\nControllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nnamespace SportsStore.Controllers {\n    public class HomeController : Controller {\n        private IStoreRepository repository;\n158 chapter  7 SportsStore: A real application \n        public int PageSize = 4;\n        public HomeController(IStoreRepository repo) {\n            repository = repo;\n        }\n        public ViewResult Index(int productPage = 1)\n            => View(repository.Products\n                .OrderBy(p => p.ProductID)\n                .Skip((productPage - 1) * PageSize)\n                .Take(PageSize));\n    }\n}\nThe PageSize  field specifies that I want four products per page. I have added an \noptional parameter to the Index  method, which means that if the method is called \nwithout a parameter, the call is treated as though I had supplied the value specified in \nthe parameter definition, with the effect that the action method displays the first page \nof products when it is invoked without an argument. Within the body of the action \nmethod, I get the Product  objects, order them by the primary key, skip over the prod-\nucts that occur before the start of the current page, and take the number of products \nspecified by the PageSize  field. \nUnit test: pagination\nI can unit test the pagination feature by mocking the repository, requesting a specific \npage from the controller, and making sure I get the expected subset of the data. Here is \nthe unit test I created for this purpose and added to the HomeControllerTests.cs  \nfile in the SportsStore.Tests  project:\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing Microsoft.AspNetCore.Mvc;\nusing Moq;\nusing SportsStore.Controllers;\nusing SportsStore.Models;\nusing Xunit;\nnamespace SportsStore.Tests {\n    public class HomeControllerTests {\n        [Fact]\n        public void Can_Use_Repository() {\n            // ...statements omitted for brevity...\n        }\n        [Fact]\n        public void Can_Paginate() {\n            // Arrange\n            Mock<IStoreRepository> mock = new Mock<IStoreRepository>();",3736
91-7.4.1 Displaying page links.pdf,91-7.4.1 Displaying page links,"159 Adding pagination\n(continued)\n            mock.Setup(m => m.Products).Returns((new Product[] {\n                new Product {ProductID = 1, Name = ""P1""},\n                new Product {ProductID = 2, Name = ""P2""},\n                new Product {ProductID = 3, Name = ""P3""},\n                new Product {ProductID = 4, Name = ""P4""},\n                new Product {ProductID = 5, Name = ""P5""}\n            }).AsQueryable<Product>());\n            HomeController controller = new HomeController(mock.Object);\n            controller.PageSize = 3;\n            // Act\n            IEnumerable<Product> result =\n                (controller.Index(2) as ViewResult)?.ViewData.Model\n                    as IEnumerable<Product> \n                         ?? Enumerable.Empty<Product>();\n            // Assert\n            Product[] prodArray = result.ToArray();\n            Assert.True(prodArray.Length == 2);\n            Assert.Equal(""P4"", prodArray[0].Name);\n            Assert.Equal(""P5"", prodArray[1].Name);\n        }\n    }\n}\nYou can see the new test follows the pattern of the existing one, relying on Moq to provide \na known set of data with which to work.\n7.4.1 Displaying page links\nRestart ASP.NET Core and request http://localhost:5000, and you will see that there \nare now four items shown on the page, as shown in figure 7.4. If you want to view \nanother page, you can append query string parameters to the end of the URL, like this:\nhttp://localhost:5000/ ?productPage=2\nFigure 7.4    \nPaging through \ndata\n160 chapter  7 SportsStore: A real application \nUsing these query strings, you can navigate through the catalog of products. There is \nno way for customers to figure out that these query string parameters exist, and even \nif there were, customers are not going to want to navigate this way. Instead, I need to \nrender some page links at the bottom of each list of products so that customers can \nnavigate between pages. To do this, I am going to create a tag helper , which generates \nthe HTML markup for the links I require.\nadding  the view model\nTo support the tag helper, I am going to pass information to the view about the num-\nber of pages available, the current page, and the total number of products in the repos-\nitory. The easiest way to do this is to create a view model class, which is used specifically \nto pass data between a controller and a view. Create a Models/ViewModels  folder in \nthe SportsStore  project, add to it a class file named PagingInfo.cs , and define the \nclass shown in listing 7.27.\nListing 7.27    The contents of the PagingInfo.cs file in the SportsStore/Models/\nViewModels folder\nnamespace SportsStore.Models.ViewModels {\n    public class PagingInfo {\n        public int TotalItems { get; set; }\n        public int ItemsPerPage { get; set; }\n        public int CurrentPage { get; set; }\n        public int TotalPages => \n            (int)Math.Ceiling((decimal)TotalItems / ItemsPerPage);\n    }\n}\nadding  the tag helper  class\nNow that I have a view model, it is time to create a tag helper class. Create a folder \nnamed Infrastructure  in the SportsStore project and add to it a class file called \nPageLinkTagHelper.cs , with the code shown in listing 7.28. Tag helpers are a big \npart of ASP.NET Core development, and I explain how they work and how to use and \ncreate them in chapters 25–27. \nTIP    The Infrastructure  folder is where I put classes that deliver the plumb-\ning for an application but that are not related to the application’s main function-\nality. You don’t have to follow this convention in your own projects. \nListing 7.28    The contents of the PageLinkTagHelper.cs file in the SportsStore/\nInfrastructure folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.Routing;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\n 161 Adding pagination\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nusing SportsStore.Models.ViewModels;\nnamespace SportsStore.Infrastructure {\n    [HtmlTargetElement(""div"", Attributes = ""page-model"")]\n    public class PageLinkTagHelper : TagHelper {\n        private IUrlHelperFactory urlHelperFactory;\n        public PageLinkTagHelper(IUrlHelperFactory helperFactory) {\n            urlHelperFactory = helperFactory;\n        }\n        [ViewContext]\n        [HtmlAttributeNotBound]\n        public ViewContext? ViewContext { get; set; }\n        public PagingInfo? PageModel { get; set; }\n        public string? PageAction { get; set; }\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            if (ViewContext != null && PageModel != null) {\n                IUrlHelper urlHelper \n                    = urlHelperFactory.GetUrlHelper(ViewContext);\n                TagBuilder result = new TagBuilder(""div"");\n                for (int i = 1; i <= PageModel.TotalPages; i++) {\n                    TagBuilder tag = new TagBuilder(""a"");\n                    tag.Attributes[""href""] = urlHelper.Action(PageAction,\n                       new { productPage = i });\n                    tag.InnerHtml.Append(i.ToString());\n                    result.InnerHtml.AppendHtml(tag);\n                }\n                output.Content.AppendHtml(result.InnerHtml);\n            }\n        }\n    }\n}\nThis tag helper populates a div element with a elements that correspond to pages \nof products. I am not going to go into detail about tag helpers now; it is enough to \nknow that they are one of the most useful ways that you can introduce C# logic into \nyour views. The code for a tag helper can look tortured because C# and HTML don’t \nmix easily. But using tag helpers is preferable to including blocks of C# code in a view \nbecause a tag helper can be easily unit tested. \nMost ASP.NET Core components, such as controllers and views, are discovered auto-\nmatically, but tag helpers have to be registered. In listing 7.29, I have added a statement \nto the _ViewImports.cshtml  file in the Views  folder that tells ASP.NET Core to look \nfor tag helper classes in the SportsStore project. I also added an @using  expression so \nthat I can refer to the view model classes in views without having to qualify their names \nwith the namespace.\n162 chapter  7 SportsStore: A real application \nListing 7.29    Registering a tag helper in the _ViewImports.cshtml file in the  \nSportsStore/Views folder\n@using SportsStore.Models\n@using SportsStore.Models.ViewModels\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@addTagHelper *, SportsStore\nUnit test: creating page links\nTo test the PageLinkTagHelper  tag helper class, I call the Process  method with test \ndata and provide a TagHelperOutput  object that I inspect to see the HTML that is gen-\nerated, as follows, which I defined in a new PageLinkTagHelperTests.cs  file in the \nSportsStore.Tests  project:\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.Routing;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nusing Moq;\nusing SportsStore.Infrastructure;\nusing SportsStore.Models.ViewModels;\nusing Xunit;\nnamespace SportsStore.Tests {\n    public class PageLinkTagHelperTests {\n        [Fact]\n        public void Can_Generate_Page_Links() {\n            // Arrange\n            var urlHelper = new Mock<IUrlHelper>();\n            urlHelper.SetupSequence(x => \n                     x.Action(It.IsAny<UrlActionContext>()))\n                .Returns(""Test/Page1"")\n                .Returns(""Test/Page2"")\n                .Returns(""Test/Page3"");\n            var urlHelperFactory = new Mock<IUrlHelperFactory>();\n            urlHelperFactory.Setup(f =>\n                    f.GetUrlHelper(It.IsAny<ActionContext>()))\n                        .Returns(urlHelper.Object);\n            var viewContext = new Mock<ViewContext>();\n            PageLinkTagHelper helper =\n                    new PageLinkTagHelper(urlHelperFactory.Object) {\n                        PageModel = new PagingInfo {\n                            CurrentPage = 2,\n                            TotalItems = 28,\n                            ItemsPerPage = 10\n                        },\n 163 Adding pagination\n(continued)\n                        ViewContext = viewContext.Object,\n                        PageAction = ""Test""\n                    };\n            TagHelperContext ctx = new TagHelperContext(\n                new TagHelperAttributeList(),\n                new Dictionary<object, object>(), """");\n            var content = new Mock<TagHelperContent>();\n            TagHelperOutput output = new TagHelperOutput(""div"",\n                new TagHelperAttributeList(),\n                (cache, encoder) => Task.FromResult(content.Object));\n            // Act\n            helper.Process(ctx, output);\n            // Assert\n            Assert.Equal(@""<a href=""""Test/Page1"""">1</a>""\n                + @""<a href=""""Test/Page2"""">2</a>""\n                + @""<a href=""""Test/Page3"""">3</a>"",\n                 output.Content.GetContent());\n        }\n    }\n}\nThe complexity in this test is in creating the objects that are required to create and use a \ntag helper. Tag helpers use IUrlHelperFactory  objects to generate URLs that target \ndifferent parts of the application, and I have used Moq to create an implementation of \nthis interface and the related IUrlHelper  interface that provides test data.\nThe core part of the test verifies the tag helper output by using a literal string value that \ncontains double quotes. C# is perfectly capable of working with such strings, as long as \nthe string is prefixed with @ and uses two sets of double quotes ( """") in place of one set \nof double quotes. You must remember not to break the literal string into separate lines \nunless the string you are comparing to is similarly broken. For example, the literal I use in \nthe test method has wrapped onto several lines because the width of a printed page is \nnarrow. I have not added a newline character; if I did, the test would fail.\nadding  the view model  data\nI am not quite ready to use the tag helper because I have yet to provide an instance \nof the PagingInfo  view model class to the view. To do this, I added a class file called \nProductsListViewModel.cs  to the Models/ViewModels  folder of the SportsStore \nproject with the content shown in listing 7.30.\nListing 7.30    The contents of the ProductsListViewModel.cs file in the SportsStore/\nModels/ViewModels folder\nnamespace SportsStore.Models.ViewModels {\n    public class ProductsListViewModel {\n        public IEnumerable<Product> Products { get; set; } \n164 chapter  7 SportsStore: A real application \n            = Enumerable.Empty<Product>();\n        public PagingInfo PagingInfo { get; set; } = new();\n    }\n}\nI can update the Index  action method in the HomeController  class to use the  \nProductsListViewModel  class to provide the view with details of the products to dis-\nplay on the page and with details of the pagination, as shown in listing 7.31.\nListing 7.31    Updating the action method in the HomeController.cs file in the Sports \nStore/Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nusing SportsStore.Models.ViewModels;\nnamespace SportsStore.Controllers {\n    public class HomeController : Controller {\n        private IStoreRepository repository;\n        public int PageSize = 4;\n        public HomeController(IStoreRepository repo) {\n            repository = repo;\n        }\n        public ViewResult Index(int productPage = 1)\n           => View(new ProductsListViewModel {\n               Products = repository.Products\n                   .OrderBy(p => p.ProductID)\n                   .Skip((productPage - 1) * PageSize)\n                   .Take(PageSize),\n               PagingInfo = new PagingInfo {\n                   CurrentPage = productPage,\n                   ItemsPerPage = PageSize,\n                   TotalItems = repository.Products.Count()\n               }\n           });\n    }\n}\nThese changes pass a ProductsListViewModel  object as the model data to the view. \nUnit test: page model view data\nI need to ensure that the controller sends the correct pagination data to the view. Here \nis the unit test I added to the HomeControllerTests  class in the test project to make \nsure:\n...\n[Fact]\npublic void Can_Send_Pagination_View_Model() {\n    // Arrange\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1""},\n 165 Adding pagination\n(continued)\n        new Product {ProductID = 2, Name = ""P2""},\n        new Product {ProductID = 3, Name = ""P3""},\n        new Product {ProductID = 4, Name = ""P4""},\n        new Product {ProductID = 5, Name = ""P5""}\n    }).AsQueryable<Product>());\n    // Arrange\n    HomeController controller =\n        new HomeController(mock.Object) { PageSize = 3 };\n    // Act\n    ProductsListViewModel result =\n        controller.Index(2)?.ViewData.Model as ProductsListViewModel \n            ?? new();\n    // Assert\n    PagingInfo pageInfo = result.PagingInfo;\n    Assert.Equal(2, pageInfo.CurrentPage);\n    Assert.Equal(3, pageInfo.ItemsPerPage);\n    Assert.Equal(5, pageInfo.TotalItems);\n    Assert.Equal(2, pageInfo.TotalPages);\n} \n...\nI also need to modify the earlier unit tests to reflect the new result from the Index  action \nmethod. Here are the revised tests:\n...\n[Fact]\npublic void Can_Use_Repository() {\n    // Arrange\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1""},\n        new Product {ProductID = 2, Name = ""P2""}\n    }).AsQueryable<Product>());\n    HomeController controller = new HomeController(mock.Object);\n    // Act\n    ProductsListViewModel result =\n        controller.Index()?.ViewData.Model as ProductsListViewModel \n            ?? new();\n    // Assert\n    Product[] prodArray = result.Products.ToArray();\n    Assert.True(prodArray.Length == 2);\n    Assert.Equal(""P1"", prodArray[0].Name);\n    Assert.Equal(""P2"", prodArray[1].Name);\n}\n[Fact]\npublic void Can_Paginate() {\n    // Arrange\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n166 chapter  7 SportsStore: A real application \n(continued)\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1""},\n        new Product {ProductID = 2, Name = ""P2""},\n        new Product {ProductID = 3, Name = ""P3""},\n        new Product {ProductID = 4, Name = ""P4""},\n        new Product {ProductID = 5, Name = ""P5""}\n    }).AsQueryable<Product>());\n    HomeController controller = new HomeController(mock.Object);\n    controller.PageSize = 3;\n    // Act\n    ProductsListViewModel result =\n        controller.Index(2)?.ViewData.Model as ProductsListViewModel \n            ?? new();\n    // Assert\n    Product[] prodArray = result.Products.ToArray();\n    Assert.True(prodArray.Length == 2);\n    Assert.Equal(""P4"", prodArray[0].Name);\n    Assert.Equal(""P5"", prodArray[1].Name);\n}\n...\nI would usually create a common setup method, given the degree of duplication between \nthese two test methods. However, since I am delivering the unit tests in individual side-\nbars like this one, I am going to keep everything separate so you can see each test on its \nown.\nThe view is currently expecting a sequence of Product  objects, so I need to update the \nIndex.cshtml  file, as shown in listing 7.32, to deal with the new view model type.\nListing 7.32    Updating the Index.cshtml file in the SportsStore/Views/Home folder\n@model ProductsListViewModel\n@foreach (var p in Model.Products ?? Enumerable.Empty<Product>()) {\n    <div>\n        <h3>@p.Name</h3>\n        @p.Description\n        <h4>@p.Price.ToString(""c"")</h4>\n    </div>\n}\nI have changed the @model  directive to tell Razor that I am now working with a dif-\nferent data type. I updated the foreach  loop so that the data source is the Products  \nproperty of the model data. \ndisplaying  the page links\nI have everything in place to add the page links to the Index  view. I created the view \nmodel that contains the paging information, updated the controller so that it passes",16529
92-7.4.2 Improving the URLs.pdf,92-7.4.2 Improving the URLs,"167 Adding pagination\nthis information to the view, and changed the @model  directive to match the new \nmodel view type. All that remains is to add an HTML element that the tag helper will \nprocess to create the page links, as shown in listing 7.33.\nListing 7.33    Adding the pagination links in the Index.cshtml file in the SportsStore/\nViews/Home folder\n@model ProductsListViewModel\n@foreach (var p in Model.Products ?? Enumerable.Empty<Product>()) {\n    <div>\n        <h3>@p.Name</h3>\n        @p.Description\n        <h4>@p.Price.ToString(""c"")</h4>\n    </div>\n}\n<div page-model=""@Model.PagingInfo"" page-action=""Index""></div>\nRestart ASP.NET Core and request http://localhost:5000, and you will see the new \npage links, as shown in figure 7.5. The style is still basic, which I will fix later in the \nchapter. What is important for the moment is that the links take the user from page \nto page in the catalog and allow for exploration of the products for sale. When Razor \nfinds the page-model  attribute on the div element, it asks the PageLinkTagHelper  \nclass to transform the element, which produces the set of links shown in the figure.\nFigure 7.5    Displaying page navigation links\n7.4.2 Improving the URLs\nI have the page links working, but they still use the query string to pass page informa-\ntion to the server, like this:\nhttp://localhost/?productPage=2\n168 chapter  7 SportsStore: A real application \nI can create URLs that are more appealing by creating a scheme that follows the pat-\ntern of composable URLs . A composable URL is one that makes sense to the user, like \nthis one:\nhttp://localhost/Page2\nThe ASP.NET Core routing feature makes it easy to change the URL scheme in an \napplication. All I need to do is add a new route in the Program.cs  file, as shown in \nlisting 7.34.\nListing 7.34    Adding a new route in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapDefaultControllerRoute();\nSeedData.EnsurePopulated(app);\napp.Run();\nThis is the only alteration required to change the URL scheme for product pagina-\ntion. ASP.NET Core and the routing function are tightly integrated, so the application \nautomatically reflects a change like this in the URLs used by the application, including \nthose generated by tag helpers like the one I use to generate the page navigation links. \nRestart ASP.NET Core, request http://localhost:5000, and click one of the pagina-\ntion links. The browser will navigate to a URL that uses the new URL scheme, as shown \nin figure 7.6.\nFigure 7.6    \nThe new \nURL scheme \ndisplayed in the \nbrowser",3171
93-7.5 Styling the content.pdf,93-7.5 Styling the content,,0
94-7.5.1 Installing the Bootstrap package.pdf,94-7.5.1 Installing the Bootstrap package,,0
95-7.5.2 Applying Bootstrap styles.pdf,95-7.5.2 Applying Bootstrap styles,"169 Styling the content\n7.5 Styling the content\nI have built a great deal of infrastructure, and the basic features of the application \nare starting to come together, but I have not paid any attention to appearance. Even \nthough this book is not about design or CSS, the SportsStore application design is so \nmiserably plain that it undermines its technical strengths. In this section, I will put \nsome of that right. I am going to implement a classic two-column layout with a header, \nas shown in figure 7.7.\nFigure 7.7    \nThe design \ngoal for the \nSportsStore \napplication\n7.5.1 Installing the Bootstrap package\nI am going to use the Bootstrap package to provide the CSS styles I will apply to the \napplication. As explained in chapter 4, client-side packages are installed using LibMan. \nIf you did not install the LibMan package when following the examples in chapter 4, \nuse a PowerShell command prompt to run the commands shown in listing 7.35, which \nremove any existing LibMan package and install the version required for this book. \nListing 7.35    Installing the LibMan tool package \ndotnet tool uninstall --global Microsoft.Web.LibraryManager.Cli\ndotnet tool install --global Microsoft.Web.LibraryManager.Cli  \n    --version 2.1.175\nOnce you have installed LibMan, run the commands shown in listing 7.36 in the \nSportsStore  folder to initialize the example project and install the Bootstrap package.\nListing 7.36    Initializing the example project \nlibman init -p cdnjs\nlibman install bootstrap@5.2.3 -d wwwroot/lib/bootstrap\n7.5.2 Applying Bootstrap styles\nRazor layouts provide common content so that it doesn’t have to be repeated in mul-\ntiple views. Add the elements shown in listing 7.37 to the _Layout.cshtml  file in the \nViews/Shared  folder to include the Bootstrap CSS stylesheet in the content sent to \nthe browser and define a common header that will be used throughout the Sports -\nStore application.\n170 chapter  7 SportsStore: A real application \nListing 7.37    Applying Bootstrap CSS to the _Layout.cshtml file in the SportsStore/\nViews/Shared folder \n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>SportsStore</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />    \n</head>\n<body>\n    <div class=""bg-dark text-white p-2"">\n        <span class=""navbar-brand ml-2"">SPORTS STORE</span>\n    </div>\n    <div class=""row m-1 p-1"">\n        <div id=""categories"" class=""col-3"">\n            Put something useful here later\n        </div>\n        <div class=""col-9"">\n            @RenderBody()\n        </div>\n    </div>\n</body>\n</html>\nAdding the Bootstrap CSS stylesheet to the layout means that I can use the styles it \ndefines in any of the views that rely on the layout. Listing 7.38 shows the styling  \nI applied to the Index.cshtml  file.\nListing 7.38    Styling content in the Index.cshtml file in the SportsStore/Views/Home \nfolder\n@model ProductsListViewModel\n@foreach (var p in Model.Products ?? Enumerable.Empty<Product>()) {\n    <div class=""card card-outline-primary m-1 p-1"">\n        <div class=""bg-faded p-1"">\n            <h4>\n                @p.Name\n                <span class=""badge rounded-pill bg-primary text-white"" \n                        style=""float:right"">\n                    <small>@p.Price.ToString(""c"")</small>\n                </span>\n            </h4>\n        </div>\n        <div class=""card-text p-1"">@p.Description</div>\n    </div>\n}\n<div page-model=""@Model.PagingInfo"" page-action=""Index"" \n     page-classes-enabled=""true"" page-class=""btn"" \n     page-class-normal=""btn-outline-dark""\n     page-class-selected=""btn-primary"" class=""btn-group pull-right m-1"">\n</div>\n 171 Styling the content\nI need to style the buttons generated by the PageLinkTagHelper  class, but I don’t \nwant to hardwire the Bootstrap classes into the C# code because it makes it harder \nto reuse the tag helper elsewhere in the application or change the appearance of the \nbuttons. Instead, I have defined custom attributes on the div element that specify the \nclasses that I require, and these correspond to properties I added to the tag helper \nclass, which are then used to style the a elements that are produced, as shown in listing \n7.39.\nListing 7.39    Adding classes to elements in the PageLinkTagHelper.cs file in the \nSportsStore/Infrastructure folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.Routing;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nusing SportsStore.Models.ViewModels;\nnamespace SportsStore.Infrastructure {\n    [HtmlTargetElement(""div"", Attributes = ""page-model"")]\n    public class PageLinkTagHelper : TagHelper {\n        private IUrlHelperFactory urlHelperFactory;\n        public PageLinkTagHelper(IUrlHelperFactory helperFactory) {\n            urlHelperFactory = helperFactory;\n        }\n        [ViewContext]\n        [HtmlAttributeNotBound]\n        public ViewContext? ViewContext { get; set; }\n        public PagingInfo? PageModel { get; set; }\n        public string? PageAction { get; set; }\n        public bool PageClassesEnabled { get; set; } = false;\n        public string PageClass { get; set; } = String.Empty;\n        public string PageClassNormal { get; set; } = String.Empty;\n        public string PageClassSelected { get; set; } = String.Empty;\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            if (ViewContext != null && PageModel != null) {\n                IUrlHelper urlHelper \n                    = urlHelperFactory.GetUrlHelper(ViewContext);\n                TagBuilder result = new TagBuilder(""div"");\n                for (int i = 1; i <= PageModel.TotalPages; i++) {\n                    TagBuilder tag = new TagBuilder(""a"");\n                    tag.Attributes[""href""] = urlHelper.Action(PageAction,\n                       new { productPage = i });\n                    if (PageClassesEnabled) {",6142
96-7.5.3 Creating a partial view.pdf,96-7.5.3 Creating a partial view,"172 chapter  7 SportsStore: A real application \n                        tag.AddCssClass(PageClass);\n                        tag.AddCssClass(i == PageModel.CurrentPage\n                            ? PageClassSelected : PageClassNormal);\n                    }\n                    tag.InnerHtml.Append(i.ToString());\n                    result.InnerHtml.AppendHtml(tag);\n                }\n                output.Content.AppendHtml(result.InnerHtml);\n            }\n        }\n    }\n}\nThe values of the attributes are automatically used to set the tag helper property \nvalues, with the mapping between the HTML attribute name format ( page-class \n-normal ) and the C# property name format ( PageClassNormal ) taken into account. \nThis allows tag helpers to respond differently based on the attributes of an HTML \nelement, creating a more flexible way to generate content in an ASP.NET Core \napplication.\nRestart ASP.NET Core and request http://localhost:5000, and you will see the \nappearance of the application has been improved—at least a little, anyway—as illus-\ntrated by figure 7.8.\nFigure 7.8    Applying styles to the SportsStore application\n7.5.3 Creating a partial view\nAs a finishing flourish for this chapter, I am going to refactor the application to sim-\nplify the Index.cshtml  view. I am going to create a partial view , which is a fragment \nof content that you can embed into another view, rather like a template. I describe \npartial views in detail in chapter 22, and they help reduce duplication when you need \nthe same content to appear in different places in an application. Rather than copy and \npaste the same Razor markup into multiple views, you can define it once in a partial \nview. To create the partial view, I added a Razor View called ProductSummary.cshtml  \nto the Views/Shared  folder and added the markup shown in listing 7.40.\n 173 Styling the content\nListing 7.40    The contents of the ProductSummary.cshtml file in the SportsStore/\nViews/Shared folder\n@model Product\n<div class=""card card-outline-primary m-1 p-1"">\n    <div class=""bg-faded p-1"">\n        <h4>\n            @Model.Name\n            <span class=""badge rounded-pill bg-primary text-white""\n                  style=""float:right"">\n                <small>@Model.Price.ToString(""c"")</small>\n            </span>\n        </h4>\n    </div>\n    <div class=""card-text p-1"">@Model.Description</div>\n</div>\nNow I need to update the Index.cshtml  file in the Views/Home  folder so that it uses \nthe partial view, as shown in listing 7.41.\nListing 7.41    Using a partial view in the Index.cshtml file in the SportsStore/Views/\nHome folder\n@model ProductsListViewModel\n@foreach (var p in Model.Products ?? Enumerable.Empty<Product>()) {\n    <partial name=""ProductSummary"" model=""p"" />\n}\n<div page-model=""@Model.PagingInfo"" page-action=""Index""\n     page-classes-enabled=""true"" page-class=""btn""\n     page-class-normal=""btn-outline-dark""\n     page-class-selected=""btn-primary"" class=""btn-group pull-right m-1"">\n</div>\nI have taken the markup that was previously in the @foreach  expression in the \nIndex.cshtml  view and moved it to the new partial view. I call the partial view using a  \npartial  element, using the name  and model  attributes to specify the name of the par-\ntial view and its view model. Using a partial view allows the same markup to be inserted \ninto any view that needs to display a summary of a product. \nRestart ASP.NET Core and request http://localhost:5000, and you will see that \nintroducing the partial view doesn’t change the appearance of the application; it just \nchanges where Razor finds the content that is used to generate the response sent to the \nbrowser.",3734
97-8 SportsStore Navigation and cart.pdf,97-8 SportsStore Navigation and cart,"174 chapter  7 SportsStore: A real application \nSummary\n¡ The SportsStore ASP.NET Core project is created using the basic ASP.NET Core \ntemplate.\n¡ ASP.NET Core has close integration with Entity Framework Core, which is the \n.NET framework for working with relational data.\n¡ Data can be paginated by including the page number in the request, either using \nthe query string or the URL path and using the page when querying the database.\n¡ The HTML content generated by ASP.NET Core can be styled using popular CSS \nframeworks, such as Bootstrap.",554
98-8.1.1 Filtering the product list.pdf,98-8.1.1 Filtering the product list,"1758SportsStore:  \nNavigation and cart\nThis chapter covers\n¡ Navigating between product categories \n¡ Correcting the pagination controls to support  \n category navigation\n¡ Using sessions to store data between requests \n¡ Implementing a shopping cart using session  \n data\n¡ Displaying the shopping cart contents using  \n Razor Pages\nIn this chapter, I continue to build out the SportsStore example app. I add support \nfor navigating around the application and start building a shopping cart. \nTIP    You can download the example project for this chapter—and for all \nthe other chapters in this book—from https://github.com/manningbooks/\npro-asp.net-core-7 . See chapter 1 for how to get help if you have problems \nrunning the examples.\n8.1 Adding navigation controls\nThe SportsStore application will be more useful if customers can navigate products \nby category. I will do this in three phases:\n¡ Enhance the Index  action method in the HomeController  class so that it can \nfilter the Product  objects in the repository\n176 chapter  8 SportsStore: Navigation and cart \n¡ Revisit and enhance the URL scheme\n¡ Create a category list that will go into the sidebar of the site, highlighting the cur-\nrent category and linking to others\n8.1.1 Filtering the product list\nI am going to start by enhancing the view model class, ProductsListViewModel , \nwhich I added to the SportsStore  project in the previous chapter. I need to commu-\nnicate the current category to the view to render the sidebar, and this is as good a place \nto start as any. Listing 8.1 shows the changes I made to the ProductsListViewModel \n.cs file in the Models/ViewModels  folder. \nListing 8.1    Modifying the ProductsListViewModel.cs file in the SportsStore/Models/  \n ViewModels folder \nnamespace SportsStore.Models.ViewModels {\n    public class ProductsListViewModel {\n        public IEnumerable<Product> Products { get; set; }\n            = Enumerable.Empty<Product>();\n        public PagingInfo PagingInfo { get; set; } = new();\n        public string? CurrentCategory { get; set; }\n    }\n}\nI added a property called CurrentCategory . The next step is to update the Home  con-\ntroller so that the Index  action method will filter Product  objects by category and use \nthe property I added to the view model to indicate which category has been selected, \nas shown in listing 8.2.\nListing 8.2.    Supporting categories in the HomeController.cs file in the SportsStore/   \n Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nusing SportsStore.Models.ViewModels;\nnamespace SportsStore.Controllers {\n    public class HomeController : Controller {\n        private IStoreRepository repository;\n        public int PageSize = 4;\n        public HomeController(IStoreRepository repo) {\n            repository = repo;\n        }\n        public ViewResult Index(string? category, int productPage = 1)\n           => View(new ProductsListViewModel {\n               Products = repository.Products\n                    .Where(p => category == null || \n                        p.Category == category)\n 177 Adding navigation controls\n                   .OrderBy(p => p.ProductID)\n                   .Skip((productPage - 1) * PageSize)\n                   .Take(PageSize),\n               PagingInfo = new PagingInfo {\n                   CurrentPage = productPage,\n                   ItemsPerPage = PageSize,\n                   TotalItems = repository.Products.Count()\n               },\n               CurrentCategory = category\n           });\n    }\n}\nI made three changes to the action method. First, I added a parameter called category . \nThis parameter is used by the second change in the listing, which is an enhancement \nto the LINQ query: if cat is not null , only those Product  objects with a matching  \nCategory  property are selected. The last change is to set the value of the Current-\nCategory  property I added to the ProductsListViewModel  class. However, these \nchanges mean that the value of PagingInfo.TotalItems  is incorrectly calculated \nbecause it doesn’t take the category filter into account. I will fix this later.\nUnit test: updating existing tests\nI changed the signature of the Index  action method, which will prevent some of the \nexisting unit test methods from compiling. To address this, I need to pass null  a s   \nthe first parameter to the Index  method in those unit tests that work with the controller.  \nFor example, in the Can_Use_Repository  test in the HomeControllerTests.cs  \nfile, the action section of the unit test becomes as follows:\n...\n[Fact]\npublic void Can_Use_Repository() {\n    // Arrange\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1""},\n        new Product {ProductID = 2, Name = ""P2""}\n    }).AsQueryable<Product>());\n    HomeController controller = new HomeController(mock.Object);\n    // Act\n    ProductsListViewModel result =\n        controller.Index(null)?.ViewData.Model \n            as ProductsListViewModel ?? new();\n    // Assert\n    Product[] prodArray = result.Products.ToArray();\n    Assert.True(prodArray.Length == 2);\n    Assert.Equal(""P1"", prodArray[0].Name);\n    Assert.Equal(""P2"", prodArray[1].Name);\n}\n...\n178 chapter  8 SportsStore: Navigation and cart \n(continued)\nBy using null  for the category  argument, I receive all the Product  objects that  \nthe controller gets from the repository, which is the same situation I had before add-\ning the new parameter. I need to make the same change to the Can_Paginate  and  \nCan_Send_Pagination_View_Model  tests as well.\n...\n[Fact]\npublic void Can_Paginate() {\n    // Arrange\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1""},\n        new Product {ProductID = 2, Name = ""P2""},\n        new Product {ProductID = 3, Name = ""P3""},\n        new Product {ProductID = 4, Name = ""P4""},\n        new Product {ProductID = 5, Name = ""P5""}\n    }).AsQueryable<Product>());\n    HomeController controller = new HomeController(mock.Object);\n    controller.PageSize = 3;\n    // Act\n    ProductsListViewModel result =\n        controller.Index(null, 2)?.ViewData.Model \n            as ProductsListViewModel ?? new();\n    // Assert\n    Product[] prodArray = result.Products.ToArray();\n    Assert.True(prodArray.Length == 2);\n    Assert.Equal(""P4"", prodArray[0].Name);\n    Assert.Equal(""P5"", prodArray[1].Name);\n}\n[Fact]\npublic void Can_Send_Pagination_View_Model() {\n    // Arrange\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1""},\n        new Product {ProductID = 2, Name = ""P2""},\n        new Product {ProductID = 3, Name = ""P3""},\n        new Product {ProductID = 4, Name = ""P4""},\n        new Product {ProductID = 5, Name = ""P5""}\n    }).AsQueryable<Product>());\n    // Arrange\n    HomeController controller =\n        new HomeController(mock.Object) { PageSize = 3 };\n    // Act\n    ProductsListViewModel result =\n        controller.Index(null, 2)?.ViewData.Model as\n 179 Adding navigation controls\n(continued)\n           ProductsListViewModel ?? new();\n    // Assert\n    PagingInfo pageInfo = result.PagingInfo;\n    Assert.Equal(2, pageInfo.CurrentPage);\n    Assert.Equal(3, pageInfo.ItemsPerPage);\n    Assert.Equal(5, pageInfo.TotalItems);\n    Assert.Equal(2, pageInfo.TotalPages);\n}\n...\nKeeping your unit tests synchronized with your code changes quickly becomes second \nnature when you get into the testing mindset.\nTo see the effect of the category filtering, start ASP.NET Core and select a category \nusing the following URL:\nhttp://localhost:5000/?category=soccer\nYou will see only the products in the Soccer  category, as shown in figure 8.1.\nFigure 8.1    Using the query string to filter by category\nUsers won’t want to navigate to categories using URLs, but you can see how small \nchanges can have a big impact once the basic structure of an ASP.NET Core applica-\ntion is in place.\nUnit Test: category filtering\nI need a unit test to properly test the category filtering function to ensure that the filter \ncan correctly generate products in a specified category. Here is the test method I added \nto the HomeControllerTests  class:\n...\n[Fact]\npublic void Can_Filter_Products() {",8607
99-8.1.2 Refining the URL scheme.pdf,99-8.1.2 Refining the URL scheme,"180 chapter  8 SportsStore: Navigation and cart \n(continued)\n    // Arrange\n    // - create the mock repository\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1"", Category = ""Cat1""},\n        new Product {ProductID = 2, Name = ""P2"", Category = ""Cat2""},\n        new Product {ProductID = 3, Name = ""P3"", Category = ""Cat1""},\n        new Product {ProductID = 4, Name = ""P4"", Category = ""Cat2""},\n        new Product {ProductID = 5, Name = ""P5"", Category = ""Cat3""}\n    }).AsQueryable<Product>());\n    // Arrange - create a controller and make the page size 3 items\n    HomeController controller = new HomeController(mock.Object);\n    controller.PageSize = 3;\n    // Action\n    Product[] result = (controller.Index(""Cat2"", 1)?.ViewData.Model \n        as ProductsListViewModel ?? new()).Products.ToArray();\n    // Assert\n    Assert.Equal(2, result.Length);\n    Assert.True(result[0].Name == ""P2"" && result[0].Category == ""Cat2"");\n    Assert.True(result[1].Name == ""P4"" && result[1].Category == ""Cat2"");\n} \n...\nThis test creates a mock repository containing Product  objects that belong to a range of \ncategories. One specific category is requested using the action method, and the results \nare checked to ensure that the results are the right objects in the right order. \n8.1.2 Refining the URL scheme\nNo one wants to see or use ugly URLs such as /?category=Soccer . To address this, I \nam going to change the routing configuration in the Program.cs  file to create a more \nuseful set of URLs, as shown in listing 8.3.\nListing 8.3    Changing the schema in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\n 181 Adding navigation controls\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\nSeedData.EnsurePopulated(app);\napp.Run();\nTable 8.1 describes the URL scheme that these routes represent. I explain the routing \nsystem in detail in chapter 13.\nTable 8.1    Route summary\nURL Leads To\n/ Lists the first page of products from all categories\n/Page2 Lists the specified page (in this case, page 2), show -\ning items from all categories\n/Soccer Shows the first page of items from a specific category \n(in this case, the Soccer  category)\n/Soccer/Page2 Shows the specified page (in this case, page 2) \nof items from the specified category (in this case, \nSoccer )\nThe ASP.NET Core routing system handles incoming  requests from clients, but it also \ngenerates outgoing  URLs that conform to the URL scheme and that can be embedded \nin web pages. By using the routing system both to handle incoming requests and to gen-\nerate outgoing URLs, I can ensure that all the URLs in the application are consistent.\nThe IUrlHelper  interface provides access to URL-generating functionality. I used \nthis interface and the Action  method it defines in the tag helper I created in the pre-\nvious chapter. Now that I want to start generating more complex URLs, I need a way to \nreceive additional information from the view without having to add extra properties to \nthe tag helper class. Fortunately, tag helpers have a nice feature that allows properties \nwith a common prefix to be received all together in a single collection, as shown in list-\ning 8.4.\n182 chapter  8 SportsStore: Navigation and cart \nListing 8.4    Prefixed values in the PageLinkTagHelper.cs file in the SportsStore/  \n Infrastructure folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.Routing;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nusing SportsStore.Models.ViewModels;\nnamespace SportsStore.Infrastructure {\n    [HtmlTargetElement(""div"", Attributes = ""page-model"")]\n    public class PageLinkTagHelper : TagHelper {\n        private IUrlHelperFactory urlHelperFactory;\n        public PageLinkTagHelper(IUrlHelperFactory helperFactory) {\n            urlHelperFactory = helperFactory;\n        }\n        [ViewContext]\n        [HtmlAttributeNotBound]\n        public ViewContext? ViewContext { get; set; }\n        public PagingInfo? PageModel { get; set; }\n        public string? PageAction { get; set; }\n        [HtmlAttributeName(DictionaryAttributePrefix = ""page-url-"")]\n        public Dictionary<string, object> PageUrlValues { get; set; }\n            = new Dictionary<string, object>();\n        public bool PageClassesEnabled { get; set; } = false;\n        public string PageClass { get; set; } = String.Empty;\n        public string PageClassNormal { get; set; } = String.Empty;\n        public string PageClassSelected { get; set; } = String.Empty;\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            if (ViewContext != null && PageModel != null) {\n                IUrlHelper urlHelper \n                    = urlHelperFactory.GetUrlHelper(ViewContext);\n                TagBuilder result = new TagBuilder(""div"");\n                for (int i = 1; i <= PageModel.TotalPages; i++) {\n                    TagBuilder tag = new TagBuilder(""a"");\n                    PageUrlValues[""productPage""] = i;\n                    tag.Attributes[""href""] = urlHelper.Action(PageAction, \n                        PageUrlValues);\n                    if (PageClassesEnabled) {\n                        tag.AddCssClass(PageClass);\n                        tag.AddCssClass(i == PageModel.CurrentPage\n                            ? PageClassSelected : PageClassNormal);\n                    }\n                    tag.InnerHtml.Append(i.ToString());\n                    result.InnerHtml.AppendHtml(tag);\n 183 Adding navigation controls\n                }\n                output.Content.AppendHtml(result.InnerHtml);\n            }\n        }\n    }\n}\nDecorating a tag helper property with the HtmlAttributeName  attribute allows \nme to specify a prefix for attribute names on the element, which in this case will be  \npage-url- . The value of any attribute whose name begins with this prefix will  \nbe added to the dictionary that is assigned to the PageUrlValues  property, which  \nis then passed to the IUrlHelper.Action  method to generate the URL for the href  \nattribute of the a elements that the tag helper produces.\nIn listing 8.5, I have added a new attribute to the div element that is processed by \nthe tag helper, specifying the category that will be used to generate the URL. I have \nadded only one new attribute to the view, but any attribute with the same prefix would \nbe added to the dictionary.\nListing 8.5    Adding a attribute in the Index.cshtml file in the SportsStore/Views/  \n Home folder\n@model ProductsListViewModel\n@foreach (var p in Model.Products ?? Enumerable.Empty<Product>()) {\n    <partial name=""ProductSummary"" model=""p"" />\n}\n<div page-model=""@Model.PagingInfo"" page-action=""Index""\n     page-classes-enabled=""true"" page-class=""btn""\n     page-class-normal=""btn-outline-dark""\n     page-class-selected=""btn-primary"" \n     page-url-category=""@Model.CurrentCategory!""\n     class=""btn-group pull-right m-1"">\n</div>\nI used the null-forgiving operator in the page-url-category  expression so that I can \npass a null  value without receiving a compiler warning.\nPrior to this change, the links generated for the pagination links looked like this:\nhttp://localhost:5000/Page1\nIf the user clicked a page link like this, the category filter would be lost, and the appli-\ncation would present a page containing products from all categories. By adding the \ncurrent category, taken from the view model, I generate URLs like this instead:\nhttp://localhost:5000/Chess/Page1\nWhen the user clicks this kind of link, the current category will be passed to the Index \naction method, and the filtering will be preserved. To see the effect of this change, \nstart ASP.NET Core and request http://localhost:5000/chess, which will display just \nthe products in the Chess  category, as shown in figure 8.2.",9008
100-8.1.3 Building a category navigation menu.pdf,100-8.1.3 Building a category navigation menu,"184 chapter  8 SportsStore: Navigation and cart \nFigure 8.2    \nFiltering data by \ncategory\n8.1.3 Building a category navigation menu\nI need to provide users with a way to select a category that does not involve typing in \nURLs. This means presenting a list of the available categories and indicating which, if \nany, is currently selected. \nASP.NET Core has the concept of view components , which are perfect for creating \nitems such as reusable navigation controls. A view component is a C# class that provides \na small amount of reusable application logic with the ability to select and display Razor \npartial views. I describe view components in detail in chapter 24.\nIn this case, I will create a view component that renders the navigation menu and \nintegrate it into the application by invoking the component from the shared layout. \nThis approach gives me a regular C# class that can contain whatever application logic I \nneed and that can be unit tested like any other class. \ncreating  the navigation  view component  \nI created a folder called Components , which is the conventional home of view compo-\nnents, in the SportsStore project and added to it a class file named NavigationMenu-\nViewComponent.cs , which I used to define the class shown in listing 8.6.\nListing 8.6    The contents of the NavigationMenuViewComponent.cs file in the  \n SportsStore/Components folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace SportsStore.Components {\n    public class NavigationMenuViewComponent : ViewComponent {\n        public string Invoke() {\n            return ""Hello from the Nav View Component"";\n        }\n    }\n}\n 185 Adding navigation controls\nThe view component’s Invoke  method is called when the component is used in a \nRazor view, and the result of the Invoke  method is inserted into the HTML sent to \nthe browser. I have started with a simple view component that returns a string, but I’ll \nreplace this with HTML shortly.\nI want the category list to appear on all pages, so I am going to use the view compo-\nnent in the shared layout, rather than in a specific view. Within a view, view components \nare applied using a tag helper, as shown in listing 8.7.\nListing 8.7    Using a view component in the _Layout.cshtml file in the SportsStore/  \n Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>SportsStore</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />    \n</head>\n<body>\n    <div class=""bg-dark text-white p-2"">\n        <span class=""navbar-brand ml-2"">SPORTS STORE</span>\n    </div>\n    <div class=""row m-1 p-1"">\n        <div id=""categories"" class=""col-3"">\n            <vc:navigation-menu />\n        </div>\n        <div class=""col-9"">\n            @RenderBody()\n        </div>\n    </div>\n</body>\n</html>\nI removed the placeholder text and replaced it with the vc:navigation-menu  ele-\nment, which inserts the view component. The element omits the ViewComponent  part \nof the class name and hyphenates it, such that vc:navigation-menu  specifies the \nNavigationMenuViewComponent  class.\nRestart ASP.NET Core and request http://localhost:5000, and you will see that the \noutput from the Invoke  method is included in the HTML sent to the browser, as shown \nin figure 8.3.\nFigure 8.3    \nUsing a view \ncomponent\n186 chapter  8 SportsStore: Navigation and cart \ngenerating  category  lists\nI can now return to the navigation view component and generate a real set of catego-\nries. I could build the HTML for the categories programmatically, as I did for the page \ntag helper, but one of the benefits of working with view components is they can render \nRazor partial views. That means I can use the view component to generate the list of \ncategories and then use the more expressive Razor syntax to render the HTML that \nwill display them. The first step is to update the view component, as shown in listing \n8.8.\nListing 8.8    Adding categories in the NavigationMenuViewComponent.cs file in the  \n SportsStore/Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nnamespace SportsStore.Components {\n    public class NavigationMenuViewComponent : ViewComponent {\n        private IStoreRepository  repository;\n        public NavigationMenuViewComponent(IStoreRepository repo) {\n            repository = repo;\n        }\n        public IViewComponentResult Invoke() {\n            return View(repository.Products\n                .Select(x => x.Category)\n                .Distinct()\n                .OrderBy(x => x));\n        }\n    }\n}\nThe constructor defined in listing 8.8 defines an IStoreRepository  parameter. When \nASP.NET Core needs to create an instance of the view component class, it will note \nthe need to provide a value for this parameter and inspect the configuration in the  \nProgram.cs  file to determine which implementation object should be used. This is \nthe same dependency injection feature that I used in the controller in chapter 7, and \nit has the same effect, which is to allow the view component to access data without \nknowing which repository implementation will be used, a feature I describe in detail in \nchapter 14.\nIn the Invoke  method, I use LINQ to select and order the set of categories in the \nrepository and pass them as the argument to the View  method, which renders the \ndefault Razor partial view, details of which are returned from the method using an \nIViewComponentResult  object, a process I describe in more detail in chapter 24.\n 187 Adding navigation controls\nUnit test: generating the category list\nThe unit test for my ability to produce a category list is relatively simple. The goal is to \ncreate a list that is sorted in alphabetical order and contains no duplicates, and the sim-\nplest way to do this is to supply some test data that does  have duplicate categories and \nthat is not in order, pass this to the view component class, and assert that the data has \nbeen properly cleaned up. Here is the unit test, which I defined in a new class file called  \nNavigationMenuViewComponentTests.cs  in the SportsStore.Tests  project:\nusing System.Collections.Generic;\nusing System.Linq;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.ViewComponents;\nusing Moq;\nusing SportsStore.Components;\nusing SportsStore.Models;\nusing Xunit;\nnamespace SportsStore.Tests {\n    public class NavigationMenuViewComponentTests {\n        [Fact]\n        public void Can_Select_Categories() {\n            // Arrange\n            Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n            mock.Setup(m => m.Products).Returns((new Product[] {\n                new Product {ProductID = 1, Name = ""P1"", \n                    Category = ""Apples""},\n                new Product {ProductID = 2, Name = ""P2"", \n                    Category = ""Apples""},\n                new Product {ProductID = 3, Name = ""P3"", \n                    Category = ""Plums""},\n                new Product {ProductID = 4, Name = ""P4"", \n                    Category = ""Oranges""},\n            }).AsQueryable<Product>());\n            NavigationMenuViewComponent target =\n                new NavigationMenuViewComponent(mock.Object);\n            // Act = get the set of categories\n            string[] results = ((IEnumerable<string>?)(target.Invoke() \n               as ViewViewComponentResult)?.ViewData?.Model \n                 ?? Enumerable.Empty<string>()).ToArray();\n            // Assert\n            Assert.True(Enumerable.SequenceEqual(new string[] { ""Apples"",\n                ""Oranges"", ""Plums"" }, results));\n        }\n    }\n}\nI created a mock repository implementation that contains repeating categories and cat-\negories that are not in order. I assert that the duplicates are removed and that alphabeti-\ncal ordering is imposed.\n188 chapter  8 SportsStore: Navigation and cart \ncreating  the view\nRazor uses different conventions for locating views that are selected by view compo-\nnents. Both the default name of the view and the locations that are searched for the \nview are different from those used for controllers. To that end, I created the Views/\nShared/Components/NavigationMenu  folder in the SportsStore project and added \nto it a Razor View named Default.cshtml , to which I added the content shown in \nlisting 8.9.\nListing 8.9    The contents of the Default.cshtml file in the SportsStore/Views/  \n Shared/Components/NavigationMenu folder\n@model IEnumerable<string>\n<div class=""d-grid gap-2"">\n    <a class=""btn btn-outline-secondary""asp-action=""Index""\n       asp-controller=""Home"" asp-route-category="""">\n        Home\n    </a>\n    @foreach (string category in Model ?? Enumerable.Empty<string>()) {\n        <a class=""btn btn-outline-secondary""\n           asp-action=""Index"" asp-controller=""Home""\n           asp-route-category=""@category""\n           asp-route-productPage=""1"">\n            @category\n        </a>\n    }\n</div>\nThis view uses one of the built-in tag helpers, which I describe in chapters 25–27, to \ncreate anchor elements whose href  attribute contains a URL that selects a different \nproduct category. \nRestart ASP.NET Core and request http://localhost:5000 to see the category naviga-\ntion buttons. If you click a button, the list of items is updated to show only items from \nthe selected category, as shown in figure 8.4.\nFigure 8.4    Generating category links with a view component\n 189 Adding navigation controls\nhighlighting  the current  category\nThere is no feedback to the user to indicate which category has been selected. It might \nbe possible to infer the category from the items in the list, but some clear visual feed-\nback seems like a good idea. ASP.NET Core components such as controllers and view \ncomponents can receive information about the current request by asking for a context \nobject. Most of the time, you can rely on the base classes that you use to create com-\nponents to take care of getting the context object for you, such as when you use the  \nController  base class to create controllers. \nThe ViewComponent  base class is no exception and provides access to context objects \nthrough a set of properties. One of the properties is called RouteData , which provides \ninformation about how the request URL was handled by the routing system.\nIn listing 8.10, I use the RouteData property to access the request data to get the \nvalue for the currently selected category. I could pass the category to the view by creat-\ning another view model class (and that’s what I would do in a real project), but for vari-\nety, I am going to use the view bag feature, which allows unstructured data to be passed \nto a view alongside the view model object. I describe how this feature works in detail in \nchapter 22.\nListing 8.10    Passing the selected category in the NavigationMenuViewComponent.cs \nfile in the SportsStore/Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nnamespace SportsStore.Components {\n    public class NavigationMenuViewComponent : ViewComponent {\n        private IStoreRepository repository;\n        public NavigationMenuViewComponent(IStoreRepository repo) {\n            repository = repo;\n        }\n        public IViewComponentResult Invoke() {\n            ViewBag.SelectedCategory = RouteData?.Values[""category""];\n            return View(repository.Products\n                .Select(x => x.Category)\n                .Distinct()\n                .OrderBy(x => x));\n        }\n    }\n}\nInside the Invoke  method, I have dynamically assigned a SelectedCategory  property \nto the ViewBag  object and set its value to be the current category, which is obtained \nthrough the context object returned by the RouteData  property. The ViewBag  is a \ndynamic object that allows me to define new properties simply by assigning values to \nthem.\n190 chapter  8 SportsStore: Navigation and cart \nUnit test: reporting the selected category\nI can test that the view component correctly adds details of the selected category by \nreading the value of the ViewBag  property in a unit test, which is available through \nthe ViewViewComponentResult  class. Here is the test, which I added to the \nNavigationMenuViewComponentTests  class:\n...\n[Fact]\npublic void Indicates_Selected_Category() {\n    // Arrange\n    string categoryToSelect = ""Apples"";\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1"", Category = ""Apples""},\n        new Product {ProductID = 4, Name = ""P2"", Category = ""Oranges""},\n    }).AsQueryable<Product>());\n    NavigationMenuViewComponent target =\n        new NavigationMenuViewComponent(mock.Object);\n    target.ViewComponentContext = new ViewComponentContext {\n        ViewContext = new ViewContext {\n            RouteData = new Microsoft.AspNetCore.Routing.RouteData()\n        }\n    };\n    target.RouteData.Values[""category""] = categoryToSelect;\n    // Action\n    string? result = (string?)(target.Invoke() \n        as ViewViewComponentResult)?.ViewData?[""SelectedCategory""];\n    // Assert\n    Assert.Equal(categoryToSelect, result);\n}\n...\nThis unit test provides the view component with routing data through the View-\nComponentContext  property, which is how view components receive all their context \ndata. The ViewComponentContext  property provides access to view-specific context \ndata through its ViewContext  property, which in turn provides access to the routing \ninformation through its RouteData  property. Most of the code in the unit test goes into \ncreating the context objects that will provide the selected category in the same way that \nit would be presented when the application is running and the context data is provided by \nASP.NET Core MVC.\nNow that I am providing information about which category is selected, I can update \nthe view selected by the view component and vary the CSS classes used to style the links \nso that the one representing the current category is distinct. Listing 8.11 shows the \nchange I made to the Default.cshtml  file.",14314
101-8.1.4 Correcting the page count.pdf,101-8.1.4 Correcting the page count,"191 Adding navigation controls\nListing 8.11    Highlighting in the Default.cshtml file in the SportsStore/Views/Shared/\nComponents/NavigationMenu folder\n@model IEnumerable<string>\n<div class=""d-grid gap-2"">\n    <a class=""btn btn-outline-secondary""asp-action=""Index""\n       asp-controller=""Home"" asp-route-category="""">\n        Home\n    </a>\n    @foreach (string category in Model ?? Enumerable.Empty<string>()) {\n        <a class=""btn @(category == ViewBag.SelectedCategory \n                ? ""btn-primary"": ""btn-outline-secondary"")""\n           asp-action=""Index"" asp-controller=""Home""\n           asp-route-category=""@category""\n           asp-route-productPage=""1"">\n            @category\n        </a>\n    }\n</div>\nI have used a Razor expression within the class  attribute to apply the btn-primary  \nclass to the element that represents the selected category and the btn-secondary  \nclass otherwise. These classes apply different Bootstrap styles and make the active \nbutton obvious, which you can see by restarting ASP.NET Core, requesting http:// \nlocalhost:5000, and clicking one of the category buttons, as shown in figure 8.5.\nFigure 8.5    \nHighlighting the \nselected category\n8.1.4 Correcting the page count\nI need to correct the page links so that they work correctly when a category is selected. \nCurrently, the number of page links is determined by the total number of products in \nthe repository and not the number of products in the selected category. This means \nthat the customer can click the link for page 2 of the Chess  category and end up with \nan empty page because there are not enough chess products to fill two pages. You can \nsee the problem in figure 8.6. \n192 chapter  8 SportsStore: Navigation and cart \nFigure 8.6    Displaying the wrong page links when a category is selected\nI can fix this by updating the Index  action method in the Home  controller so that the \npagination information takes the categories into account, as shown in listing 8.12.\nListing 8.12    Creating Category Pagination Data in the HomeController.cs File in the \nSportsStore/Controllers Folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nusing SportsStore.Models.ViewModels;\nnamespace SportsStore.Controllers {\n    public class HomeController : Controller {\n        private IStoreRepository repository;\n        public int PageSize = 4;\n        public HomeController(IStoreRepository repo) {\n            repository = repo;\n        }\n        public ViewResult Index(string? category, int productPage = 1)\n           => View(new ProductsListViewModel {\n               Products = repository.Products\n                    .Where(p => category == null \n                       || p.Category == category)\n                   .OrderBy(p => p.ProductID)\n                   .Skip((productPage - 1) * PageSize)\n                   .Take(PageSize),\n               PagingInfo = new PagingInfo {\n                   CurrentPage = productPage,\n                   ItemsPerPage = PageSize,\n                   TotalItems = category == null \n                        ? repository.Products.Count() \n                        : repository.Products.Where(e => \n                            e.Category == category).Count()\n               },\n               CurrentCategory = category\n           });\n    }\n}\n 193 Adding navigation controls\nIf a category has been selected, I return the number of items in that category; if not, \nI return the total number of products. Restart ASP.NET Core and request http:// \nlocalhost:5000 to see the changes when a category is selected, as shown in figure 8.7.\nFigure 8.7    Displaying category-specific page counts\nUnit test: category-specific product counts\nTesting that I am able to generate the current product count for different categories is \nsimple. I create a mock repository that contains known data in a range of categories and \nthen call the Index  action method requesting each category in turn. Here is the unit test \nmethod that I added to the HomeControllerTests  class (you will need to import the \nSystem  namespace for this test):\n...\n[Fact]\npublic void Generate_Category_Specific_Product_Count() {\n    // Arrange\n    Mock<IStoreRepository> mock = new Mock<IStoreRepository>();\n    mock.Setup(m => m.Products).Returns((new Product[] {\n        new Product {ProductID = 1, Name = ""P1"", Category = ""Cat1""},\n        new Product {ProductID = 2, Name = ""P2"", Category = ""Cat2""},\n        new Product {ProductID = 3, Name = ""P3"", Category = ""Cat1""},\n        new Product {ProductID = 4, Name = ""P4"", Category = ""Cat2""},\n        new Product {ProductID = 5, Name = ""P5"", Category = ""Cat3""}\n    }).AsQueryable<Product>());\n    HomeController target = new HomeController(mock.Object);\n    target.PageSize = 3;\n    Func<ViewResult, ProductsListViewModel?> GetModel = result",4891
102-8.2 Building the shopping cart.pdf,102-8.2 Building the shopping cart,,0
103-8.2.1 Configuring Razor Pages.pdf,103-8.2.1 Configuring Razor Pages,"194 chapter  8 SportsStore: Navigation and cart \n(continued)\n        => result?.ViewData?.Model as ProductsListViewModel;\n    // Action\n    int? res1 = GetModel(target.Index(""Cat1""))?.PagingInfo.TotalItems;\n    int? res2 = GetModel(target.Index(""Cat2""))?.PagingInfo.TotalItems;\n    int? res3 = GetModel(target.Index(""Cat3""))?.PagingInfo.TotalItems;\n    int? resAll = GetModel(target.Index(null))?.PagingInfo.TotalItems;\n    // Assert\n    Assert.Equal(2, res1);\n    Assert.Equal(2, res2);\n    Assert.Equal(1, res3);\n    Assert.Equal(5, resAll);\n} \n...\nNotice that I also call the Index  method, specifying no category, to make sure I get the \ncorrect total count as well.\n8.2 Building the shopping cart\nThe application is progressing nicely, but I cannot sell any products until I implement \na shopping cart. In this section, I will create the shopping cart experience shown in fig-\nure 8.8. This will be familiar to anyone who has ever made a purchase online.\nFigure 8.8    The basic shopping cart flow\nAn Add To Cart button will be displayed alongside each of the products in the catalog. \nClicking this button will show a summary of the products the customer has selected so \nfar, including the total cost. At this point, the user can click the Continue Shopping \nbutton to return to the product catalog or click the Checkout Now button to complete \nthe order and finish the shopping session. \n8.2.1 Configuring Razor Pages\nSo far, I have used the MVC Framework to define the SportsStore project features. \nFor variety, I am going to use Razor Pages—another application framework supported \nby ASP.NET Core—to implement the shopping cart. Listing 8.13 configures the  \nProgram.cs  file to enable Razor Pages in the SportsStore application.\n 195 Building the shopping cart\nListing 8.13    Enabling Razor Pages in the Program.cs file in the SportsStore folder \nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddRazorPages();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nSeedData.EnsurePopulated(app);\napp.Run();\nThe AddRazorPages  method sets up the services used by Razor Pages, and the Map-\nRazorPages  method registers Razor Pages as endpoints that the URL routing system \ncan use to handle requests.\nAdd a folder named Pages , which is the conventional location for Razor Pages, \nto the SportsStore  project. Add a Razor View Imports file named _ViewImports \n.cshtml  to the Pages  folder with the content shown in listing 8.14. These expressions \nset the namespace that the Razor Pages will belong to and allow the SportsStore classes \nto be used in Razor Pages without needing to specify their namespace.",3596
104-8.2.3 Creating the Add to Cart buttons.pdf,104-8.2.3 Creating the Add to Cart buttons,"196 chapter  8 SportsStore: Navigation and cart \nListing 8.14    The _ViewImports.cshtml file in the SportsStore/Pages folder\n@namespace SportsStore.Pages\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using SportsStore.Models\n@using SportsStore.Infrastructure\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\nNext, add a Razor View Start file named _ViewStart.cshtml  to the Pages  folder, with \nthe content shown in listing 8.15. Razor Pages have their own configuration files, and \nthis one specifies that the Razor Pages in the SportsStore project will use a layout file \nnamed _CartLayout  by default.\nListing 8.15    The contents of the _ViewStart.cshtml file in the SportsStore/Pages folder\n@{\n    Layout = ""_CartLayout"";\n}\nFinally, to provide the layout the Razor Pages will use, add a Razor View named  \n_CartLayout.cshtml  to the Pages  folder with the content shown in listing 8.16.\nListing 8.16    The contents of the _CartLayout.cshtml file in the SportsStore/Pages \nfolder\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>SportsStore</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />    \n</head>\n<body>\n    <div class=""bg-dark text-white p-2"">\n        <span class=""navbar-brand ml-2"">SPORTS STORE</span>\n    </div>\n    <div class=""m-1 p-1"">\n        @RenderBody()\n    </div>\n</body>\n</html>\n8.2.2 Creating a Razor Page \nIf you are using Visual Studio, use the Razor Page template item and set the item name \nto Cart.cshtml . This will create a Cart.cshtml  file and a Cart.cshtml.cs  class file. \nReplace the contents of the file with those shown in listing 8.17. If you are using Visual \nStudio Code, just create a Cart.cshtml  file with the content shown in listing 8.17.\n 197 Building the shopping cart\nListing 8.17    The contents of the Cart.cshtml file in the SportsStore/Pages folder\n@page\n<h4>This is the Cart Page</h4>\nRestart ASP.NET Core and request http://localhost:5000/cart to see the placeholder \ncontent from listing 8.17, which is shown in figure 8.9. Notice that I have not had to \nregister the page and that the mapping between the /cart  URL path and the Razor \nPage has been handled automatically.\nFigure 8.9    \nPlaceholder \ncontent from a \nRazor Page\n8.2.3 Creating the Add to Cart buttons\nI have some preparation to do before I can implement the cart feature. First, I need to \ncreate the buttons that will add products to the cart. To prepare for this, I added a class \nfile called UrlExtensions.cs  to the Infrastructure  folder and defined the exten-\nsion method shown in listing 8.18.\nListing 8.18    The UrlExtensions.cs file in the SportsStore/Infrastructure folder\nnamespace SportsStore.Infrastructure {\n    public static class UrlExtensions {\n        public static string PathAndQuery(this HttpRequest request) =>\n            request.QueryString.HasValue \n                ? $""{request.Path}{request.QueryString}"" \n                : request.Path.ToString();\n    }\n}\nThe PathAndQuery  extension method operates on the HttpRequest  class, which \nASP.NET Core uses to describe an HTTP request. The extension method generates a \nURL that the browser will be returned to after the cart has been updated, taking into \naccount the query string, if there is one. In listing 8.19, I have added the namespace \nthat contains the extension method to the view imports file so that I can use it in the \npartial view.\nNOTE     This is the view imports file in the Views  folder and not the one added to \nthe Pages  folder.\n198 chapter  8 SportsStore: Navigation and cart \nListing 8.19    Adding a namespace in the _ViewImports.cshtml file in the SportsStore/\nViews folder\n@using SportsStore.Models\n@using SportsStore.Models.ViewModels\n@using SportsStore.Infrastructure\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@addTagHelper *, SportsStore\nIn listing 8.20, I have updated the partial view that describes each product so that it \ncontains an Add To Cart button.\nListing 8.20    Adding the Buttons to the ProductSummary.cshtml File in the \nSportsStore/Views/Shared Folder\n@model Product\n<div class=""card card-outline-primary m-1 p-1"">\n    <div class=""bg-faded p-1"">\n        <h4>\n            @Model.Name\n            <span class=""badge rounded-pill bg-primary text-white""\n                  style=""float:right"">\n                <small>@Model.Price.ToString(""c"")</small>\n            </span>\n        </h4>\n    </div>\n    <form id=""@Model.ProductID"" asp-page=""/Cart"" method=""post"">\n        <input type=""hidden"" asp-for=""ProductID"" />\n        <input type=""hidden"" name=""returnUrl""\n               value=""@ViewContext.HttpContext.Request.PathAndQuery()"" />\n        <span class=""card-text p-1"">\n            @Model.Description\n            <button type=""submit"" style=""float:right""\n                    class=""btn btn-success btn-sm pull-right"" >\n                Add To Cart\n            </button>\n        </span>\n    </form>\n</div>\nI have added a form  element that contains hidden input  elements specifying the  \nProductID  value from the view model and the URL that the browser should be \nreturned to after the cart has been updated. The form  element and one of the input  \nelements are configured using built-in tag helpers, which are a useful way of gener-\nating forms that contain model values and that target controllers or Razor Pages, as \ndescribed in chapter 27. The other input  element uses the extension method I cre-\nated to set the return URL. I also added a button  element that will submit the form to \nthe application.",5662
105-8.2.5 Implementing the cart feature.pdf,105-8.2.5 Implementing the cart feature,"199 Building the shopping cart\nNOTE     Notice that I have set the method  attribute on the form element to post , \nwhich instructs the browser to submit the form data using an HTTP POST  request. \nYou can change this so that forms use the GET method, but you should think \ncarefully about doing so. The HTTP specification requires that GET requests be \nidempotent , meaning that they must not cause changes, and adding a product to a \ncart is definitely a change. \n8.2.4 Enabling sessions\nI am going to store details of a user’s cart using session state , which is data associated \nwith a series of requests made by a user. ASP.NET provides a range of different ways \nto store session state, including storing it in memory, which is the approach that I am \ngoing to use. This has the advantage of simplicity, but it means that the session data is \nlost when the application is stopped or restarted. Enabling sessions requires adding \nservices and middleware in the Program.cs  file, as shown in listing 8.21. \nListing 8.21    Enabling sessions in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n200 chapter  8 SportsStore: Navigation and cart \n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nSeedData.EnsurePopulated(app);\napp.Run();\nThe AddDistributedMemoryCache  method call sets up the in-memory data store. The \nAddSession  method registers the services used to access session data, and the Use-\nSession  method allows the session system to automatically associate requests with ses-\nsions when they arrive from the client.\n8.2.5 Implementing the cart feature\nNow that the preparations are complete, I can implement the cart features. I started by \nadding a class file called Cart.cs  to the Models  folder in the SportsStore project and \nused it to define the classes shown in listing 8.22.\nListing 8.22    The contents of the Cart.cs file in the SportsStore/Models folder\nnamespace SportsStore.Models {\n    public class Cart {\n        public List<CartLine> Lines { get; set; } = new List<CartLine>();\n        public void AddItem(Product product, int quantity) {\n            CartLine? line = Lines\n                .Where(p => p.Product.ProductID == product.ProductID)\n                .FirstOrDefault();\n            if (line == null) {\n                Lines.Add(new CartLine {\n                    Product = product,\n                    Quantity = quantity\n                });\n            } else {\n                line.Quantity += quantity;\n            }\n        }\n        public void RemoveLine(Product product) =>\n            Lines.RemoveAll(l => l.Product.ProductID \n                == product.ProductID);\n        public decimal ComputeTotalValue() =>\n            Lines.Sum(e => e.Product.Price * e.Quantity);\n        public void Clear() => Lines.Clear();\n    }\n    public class CartLine {\n 201 Building the shopping cart\n        public int CartLineID { get; set; }\n        public Product Product { get; set; } = new();\n        public int Quantity { get; set; }\n    }\n}\nThe Cart  class uses the CartLine  class, defined in the same file, to represent a prod-\nuct selected by the customer and the quantity the user wants to buy. I defined methods \nto add an item to the cart, remove a previously added item from the cart, calculate the \ntotal cost of the items in the cart, and reset the cart by removing all the items. \nUnit test: testing the cart\nThe Cart  class is relatively simple, but it has a range of important behaviors that must \nwork properly. A poorly functioning cart would undermine the entire SportsStore applica-\ntion. I have broken down the features and tested them individually. I created a new unit \ntest file called CartTests.cs  in the SportsStore.Tests  project to contain these \ntests.\nThe first behavior relates to when I add an item to the cart. If this is the first time that a \ngiven Product  has been added to the cart, I want a new CartLine  to be added. Here is \nthe test, including the unit test class definition: \nusing System.Linq;\nusing SportsStore.Models;\nusing Xunit;\nnamespace SportsStore.Tests {\n    public class CartTests {\n        [Fact]\n        public void Can_Add_New_Lines() {\n            // Arrange - create some test products\n            Product p1 = new Product { ProductID = 1, Name = ""P1"" };\n            Product p2 = new Product { ProductID = 2, Name = ""P2"" };\n            // Arrange - create a new cart\n            Cart target = new Cart();\n            // Act\n            target.AddItem(p1, 1);\n            target.AddItem(p2, 1);\n            CartLine[] results = target.Lines.ToArray();\n            // Assert\n            Assert.Equal(2, results.Length);\n            Assert.Equal(p1, results[0].Product);\n            Assert.Equal(p2, results[1].Product);\n        }\n    }\n}\n202 chapter  8 SportsStore: Navigation and cart \n(continued)\nHowever, if the customer has already added a Product  to the cart, I want to increment \nthe quantity of the corresponding CartLine  and not create a new one. Here is the test:\n...\n[Fact]\npublic void Can_Add_Quantity_For_Existing_Lines() {\n    // Arrange - create some test products\n    Product p1 = new Product { ProductID = 1, Name = ""P1"" };\n    Product p2 = new Product { ProductID = 2, Name = ""P2"" };\n    // Arrange - create a new cart\n    Cart target = new Cart();\n    // Act\n    target.AddItem(p1, 1);\n    target.AddItem(p2, 1);\n    target.AddItem(p1, 10);\n    CartLine[] results = (target.Lines ?? new())\n        .OrderBy(c => c.Product.ProductID).ToArray();\n    // Assert\n    Assert.Equal(2, results.Length);\n    Assert.Equal(11, results[0].Quantity);\n    Assert.Equal(1, results[1].Quantity);\n}\n...\nI also need to check that users can change their mind and remove products from the \ncart. This feature is implemented by the RemoveLine  method. Here is the test:\n...\n[Fact]\npublic void Can_Remove_Line() {\n    // Arrange - create some test products\n    Product p1 = new Product { ProductID = 1, Name = ""P1"" };\n    Product p2 = new Product { ProductID = 2, Name = ""P2"" };\n    Product p3 = new Product { ProductID = 3, Name = ""P3"" };\n    // Arrange - create a new cart\n    Cart target = new Cart();\n    // Arrange - add some products to the cart\n    target.AddItem(p1, 1);\n    target.AddItem(p2, 3);\n    target.AddItem(p3, 5);\n    target.AddItem(p2, 1);\n    // Act\n    target.RemoveLine(p2);\n    // Assert\n    Assert.Empty(target.Lines.Where(c => c.Product == p2));\n    Assert.Equal(2, target.Lines.Count());\n}\n...\n 203 Building the shopping cart\n(continued)\nThe next behavior I want to test is the ability to calculate the total cost of the items in the \ncart. Here’s the test for this behavior:\n...\n[Fact]\npublic void Calculate_Cart_Total() {\n    // Arrange - create some test products\n    Product p1 = new Product { ProductID = 1, Name = ""P1"", Price = 100M };\n    Product p2 = new Product { ProductID = 2, Name = ""P2"", Price = 50M };\n    // Arrange - create a new cart\n    Cart target = new Cart();\n    // Act\n    target.AddItem(p1, 1);\n    target.AddItem(p2, 1);\n    target.AddItem(p1, 3);\n    decimal result = target.ComputeTotalValue();\n    // Assert\n    Assert.Equal(450M, result);\n}\n...\nThe final test is simple. I want to ensure that the contents of the cart are properly \nremoved when reset. Here is the test:\n...\n[Fact]\npublic void Can_Clear_Contents() {\n    // Arrange - create some test products\n    Product p1 = new Product { ProductID = 1, Name = ""P1"", Price = 100M };\n    Product p2 = new Product { ProductID = 2, Name = ""P2"", Price = 50M };\n    // Arrange - create a new cart\n    Cart target = new Cart();\n    // Arrange - add some items\n    target.AddItem(p1, 1);\n    target.AddItem(p2, 1);\n    // Act - reset the cart\n    target.Clear();\n    // Assert\n    Assert.Empty(target.Lines);\n}\n...\nSometimes, as in this case, the code required to test the functionality of a class is lon -\nger and more complex than the class itself. Do not let that put you off writing the unit \ntests. Defects in simple classes can have huge impacts, especially ones that play such \nan important role as Cart  does in the example application.\n204 chapter  8 SportsStore: Navigation and cart \ndefining  session  state extension  methods\nThe session state feature in ASP.NET Core stores only int, string , and byte[]  val-\nues. Since I want to store a Cart  object, I need to define extension methods to the  \nISession  interface, which provides access to the session state data to serialize Cart  \nobjects into JSON and convert them back. I added a class file called Session-\nExtensions.cs  to the Infrastructure  folder and defined the extension methods \nshown in listing 8.23.\nListing 8.23    The SessionExtensions.cs file in the SportsStore/Infrastructure folder\nusing System.Text.Json;\nnamespace SportsStore.Infrastructure {\n    public static class SessionExtensions {\n        public static void SetJson(this ISession session, \n                string key, object value) {\n            session.SetString(key, JsonSerializer.Serialize(value));\n        }\n        public static T? GetJson<T>(this ISession session, string key) {\n            var sessionData = session.GetString(key);\n            return sessionData == null\n                ? default(T) : JsonSerializer.Deserialize<T>(sessionData);\n        }\n    }\n}\nThese methods serialize objects into the JavaScript Object Notation format, making it \neasy to store and retrieve Cart  objects. \ncompleting  the razor page\nThe Cart Razor Page will receive the HTTP POST request that the browser sends when \nthe user clicks an Add To Cart button. It will use the request form data to get the  \nProduct  object from the database and use it to update the user’s cart, which will be \nstored as session data for use by future requests. Listing 8.24 implements these features.\nListing 8.24    Handling requests in the Cart.cshtml file in the SportsStore/Pages folder\n@page\n@model CartModel\n<h2>Your cart</h2>\n<table class=""table table-bordered table-striped"">\n    <thead>\n        <tr>\n            <th>Quantity</th>\n            <th>Item</th>\n            <th class=""text-right"">Price</th>\n            <th class=""text-right"">Subtotal</th>\n        </tr>\n 205 Building the shopping cart\n    </thead>\n    <tbody>\n        @foreach (var line in Model.Cart?.Lines \n                    ?? Enumerable.Empty<CartLine>()) {\n            <tr>\n                <td class=""text-center"">@line.Quantity</td>\n                <td class=""text-left"">@line.Product.Name</td>\n                <td class=""text-right"">\n                    @line.Product.Price.ToString(""c"")\n                </td>\n                <td class=""text-right"">\n                    @((line.Quantity * line.Product.Price).ToString(""c""))\n                </td>\n            </tr>\n        }\n    </tbody>\n    <tfoot>\n        <tr>\n            <td colspan=""3"" class=""text-right"">Total:</td>\n            <td class=""text-right"">\n                @Model.Cart?.ComputeTotalValue().ToString(""c"")\n            </td>\n        </tr>\n    </tfoot>\n</table>\n<div class=""text-center"">\n    <a class=""btn btn-primary"" href=""@Model.ReturnUrl"">\n        Continue shopping\n    </a>\n</div>\nRazor Pages allow HTML content, Razor expressions, and code to be combined in a \nsingle file, as I explain in chapter 23, but if you want to unit test a Razor Page, then you \nneed to use a separate class file. If you are using Visual Studio, there will already be a \nclass file named Cart.cshtml.cs  in the Pages  folder, which was created by the Razor \nPage template item. If you are using Visual Studio Code, you will need to create the \nclass file separately. Use the class file, however it has been created, to define the class \nshown in listing 8.25.\nListing 8.25    The Cart.cshtml.cs file in the SportsStore/Pages folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing SportsStore.Infrastructure;\nusing SportsStore.Models;\nnamespace SportsStore.Pages {\n    public class CartModel : PageModel {\n        private IStoreRepository repository;\n        public CartModel(IStoreRepository repo) {\n206 chapter  8 SportsStore: Navigation and cart \n            repository = repo;\n        }\n        public Cart? Cart { get; set; }\n        public string ReturnUrl { get; set; } = ""/"";\n        public void OnGet(string returnUrl) {\n            ReturnUrl = returnUrl ?? ""/"";\n            Cart = HttpContext.Session.GetJson<Cart>(""cart"") \n                ?? new Cart();\n        }\n        public IActionResult OnPost(long productId, string returnUrl) {\n            Product? product = repository.Products\n                .FirstOrDefault(p => p.ProductID == productId);\n            if (product != null) {\n                Cart = HttpContext.Session.GetJson<Cart>(""cart"") \n                    ?? new Cart();\n                Cart.AddItem(product, 1);\n                HttpContext.Session.SetJson(""cart"", Cart);\n            }\n            return RedirectToPage(new { returnUrl = returnUrl });\n        }\n    }\n}\nThe class associated with a Razor Page is known as its page model class , and it defines \nhandler methods that are invoked for different types of HTTP requests, which update \nstate before rendering the view. The page model class in listing 8.25, which is named \nCartModel , defines an OnPost  handler method, which is invoked to handle HTTP \nPOST requests. It does this by retrieving a Product  from the database, retrieving the \nuser’s Cart  from the session data, and updating its content using the Product . The \nmodified Cart  is stored, and the browser is redirected to the same Razor Page, which \nit will do using a GET request (which prevents reloading the browser from triggering a \nduplicate POST request).\nThe GET request is handled by the OnGet  handler method, which sets the values of \nthe ReturnUrl  and Cart  properties, after which the Razor content section of the page \nis rendered. The expressions in the HTML content are evaluated using the CartModel  \nas the view model object, which means that the values assigned to the ReturnUrl  and \nCart  properties can be accessed within the expressions. The content generated by the \nRazor Page details the products added to the user’s cart and provides a button to navi-\ngate back to the point where the product was added to the cart.\nThe handler methods use parameter names that match the input  elements in the \nHTML forms produced by the ProductSummary.cshtml  view. This allows ASP.NET \nCore to associate incoming form POST variables with those parameters, meaning I do \nnot need to process the form directly. This is known as model binding  and is a powerful \ntool for simplifying development, as I explain in detail in chapter 28.\n 207 Building the shopping cart\nUnderstanding Razor Pages\nRazor Pages can feel a little odd when you first start using them, especially if you have \nprevious experience with the MVC Framework features provided by ASP.NET Core. But \nRazor Pages are complementary to the MVC Framework, and I find myself using them \nalongside controllers and views because they are well-suited to self-contained features \nthat don’t require the complexity of the MVC Framework. I describe Razor Pages in chap -\nter 23 and show their use alongside controllers throughout part 3 and part 4 of this book.\nThe result is that the basic functions of the shopping cart are in place. First, products \nare listed along with a button to add them to the cart, which you can see by restarting \nASP.NET Core and requesting http://localhost:5000, as shown in figure 8.10.\nFigure 8.10    \nThe Add To Cart \nbuttons\nSecond, when the user clicks an Add To Cart button, the appropriate product is added \nto their cart, and a summary of the cart is displayed, as shown in figure 8.11. Clicking \nthe Continue Shopping button returns the user to the product page they came from.\nFigure 8.11    \nDisplaying the \ncontents of the \nshopping cart\n208 chapter  8 SportsStore: Navigation and cart \nUnit testing: razor pages\nTesting Razor Pages can require a lot of mocking to create the context objects that the \npage model class requires. To test the behavior of the OnGet  method defined by the \nCartModel  class, I added a class file named CartPageTests.cs  to the Sports-\nStore.Tests  project and defined this test:\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing Microsoft.AspNetCore.Routing;\nusing Moq;\nusing SportsStore.Models;\nusing SportsStore.Pages;\nusing System.Linq;\nusing System.Text;\nusing System.Text.Json;\nusing Xunit;\nnamespace SportsStore.Tests {\n    public class CartPageTests {\n        [Fact]\n        public void Can_Load_Cart() {\n            // Arrange\n            // - create a mock repository\n            Product p1 = new Product { ProductID = 1, Name = ""P1"" };\n            Product p2 = new Product { ProductID = 2, Name = ""P2"" };\n            Mock<IStoreRepository> mockRepo \n                = new Mock<IStoreRepository>();\n            mockRepo.Setup(m => m.Products).Returns((new Product[] {\n                p1, p2\n            }).AsQueryable<Product>());\n            // - create a cart \n            Cart testCart = new Cart();\n            testCart.AddItem(p1, 2);\n            testCart.AddItem(p2, 1);\n            // - create a mock page context and session\n            Mock<ISession> mockSession = new Mock<ISession>();\n            byte[] data = Encoding.UTF8.GetBytes(\n                    JsonSerializer.Serialize(testCart));\n            mockSession.Setup(c => \n                c.TryGetValue(It.IsAny<string>(), out data!));\n            Mock<HttpContext> mockContext = new Mock<HttpContext>();\n            mockContext.SetupGet(c => \n                c.Session).Returns(mockSession.Object);\n            // Action\n            CartModel cartModel = new CartModel(mockRepo.Object) {\n                PageContext = new PageContext(new ActionContext {\n                    HttpContext = mockContext.Object,\n                    RouteData = new RouteData(),\n 209 Building the shopping cart\n(continued)\n                    ActionDescriptor = new PageActionDescriptor()\n                })\n            };\n            cartModel.OnGet(""myUrl"");\n            //Assert\n            Assert.Equal(2, cartModel.Cart?.Lines.Count());\n            Assert.Equal(""myUrl"", cartModel.ReturnUrl);\n        }\n    }\n}\nI am not going to describe these unit tests in detail because there is a simpler way to per-\nform these tests, which I explain in the next chapter. The complexity in this test is mock-\ning the ISession  interface so that the page model class can use extension methods \nto retrieve a JSON representation of a Cart  object. The ISession  interface only stores \nbyte arrays, and getting and deserializing a string is performed by extension methods. \nOnce the mock objects are defined, they can be wrapped in context objects and used to \nconfigure an instance of the page model class, which can be subjected to tests.\nThe process of testing the OnPost  method of the page model class means capturing \nthe byte array that is passed to the ISession  interface mock and then deserializing \nit to ensure that it contains the expected content. Here is the unit test I added to the  \nCartPageTests  class:\n...\n[Fact]\npublic void Can_Update_Cart() {\n    // Arrange\n    // - create a mock repository\n    Mock<IStoreRepository> mockRepo = \n        new Mock<IStoreRepository>();\n    mockRepo.Setup(m => m.Products).Returns((new Product[] {\n        new Product { ProductID = 1, Name = ""P1"" }\n    }).AsQueryable<Product>());\n    Cart? testCart = new Cart();\n    Mock<ISession> mockSession = new Mock<ISession>();\n    mockSession.Setup(s => \n            s.Set(It.IsAny<string>(), It.IsAny<byte[]>()))\n        .Callback<string, byte[]>((key, val) => {\n            testCart = JsonSerializer.Deserialize<Cart>(\n                Encoding.UTF8.GetString(val));\n        });\n    Mock<HttpContext> mockContext = new Mock<HttpContext>();\n    mockContext.SetupGet(c => \n        c.Session).Returns(mockSession.Object);\n    // Action\n    CartModel cartModel = new CartModel(mockRepo.Object) {\n        PageContext = new PageContext(new ActionContext {\n            HttpContext = mockContext.Object,\n            RouteData = new RouteData(),",21626
106-9 SportsStore Completing the cart.pdf,106-9 SportsStore Completing the cart,"210 chapter  8 SportsStore: Navigation and cart \n(continued)\n            ActionDescriptor = new PageActionDescriptor()\n        })\n    };\n    cartModel.OnPost(1, ""myUrl"");\n    //Assert\n    Assert.Single(testCart.Lines);\n    Assert.Equal(""P1"", testCart.Lines.First().Product.Name);\n    Assert.Equal(1, testCart.Lines.First().Quantity);\n} \n...\nPatience and a little experimentation are required to write effective unit tests, especially \nwhen the feature you are testing operates on the context objects that ASP.NET Core \nprovides.\nSummary\n¡ The navigation controls include the selected category in the request URL, which \nis combined with the page number when querying the database.\n¡ The View Bag allows data to be passed to views alongside the view model. \n¡ Razor Pages are well-suited for simple self-contained features, like displaying the \ncontents of a shopping cart.\n¡ Sessions allow data to be associated with a series of related requests.",967
107-9.1.1 Creating a storage-aware cart class.pdf,107-9.1.1 Creating a storage-aware cart class,"2119SportsStore:  \nCompleting the cart\nThis chapter covers\n¡ Updating the shopping cart so that it persists  \n itself as session data\n¡ Creating a shopping cart summary widget using  \n a view component\n¡ Receiving and validating user data\n¡ Displaying data validation errors to the user\nIn this chapter, I continue to build the SportsStore example app. In the previous \nchapter, I added the basic support for a shopping cart, and now I am going to \nimprove on and complete that functionality. \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/ManningBooks/\npro-asp.net-core-7 . See chapter 1 for how to get help if you have problems \nrunning the examples.\n9.1 Refining the cart model with a service\nI defined a Cart  model class in the previous chapter and demonstrated how it can \nbe stored using the session feature, allowing the user to build up a set of products \nfor purchase. The responsibility for managing the persistence of the Cart  class fell \nto the Cart  Razor Page, which has to deal with getting and storing Cart  objects as \nsession data.\n212 chapter  9 SportsStore: Completing the cart \nThe problem with this approach is that I will have to duplicate the code that obtains \nand stores Cart  objects in any other Razor Page or controller that uses them. In this \nsection, I am going to use the services feature that sits at the heart of ASP.NET Core to \nsimplify the way that Cart  objects are managed, freeing individual components from \nneeding to deal with the details directly.\nServices are commonly used to hide details of how interfaces are implemented from \nthe components that depend on them. But services can be used to solve lots of other \nproblems as well and can be used to shape and reshape an application, even when you \nare working with concrete classes such as Cart . \n9.1.1 Creating a storage-aware cart class\nThe first step in tidying up the way that the Cart  class is used will be to create a subclass \nthat is aware of how to store itself using session state. To prepare, I apply the virtual  \nkeyword to the Cart  class, as shown in listing 9.1, so that I can override the members.  \nListing 9.1    Applying the keyword in the Cart.cs file in the SportsStore/Models folder\nnamespace SportsStore.Models {\n    public class Cart {\n        public List<CartLine> Lines { get; set; } = new List<CartLine>();\n        public virtual void AddItem(Product product, int quantity) {\n            CartLine? line = Lines\n                .Where(p => p.Product.ProductID == product.ProductID)\n                .FirstOrDefault();\n            if (line == null) {\n                Lines.Add(new CartLine {\n                    Product = product,\n                    Quantity = quantity\n                });\n            } else {\n                line.Quantity += quantity;\n            }\n        }\n        public virtual void RemoveLine(Product product) =>\n            Lines.RemoveAll(l => \n                l.Product.ProductID == product.ProductID);\n        public decimal ComputeTotalValue() =>\n            Lines.Sum(e => e.Product.Price * e.Quantity);\n        public virtual void Clear() => Lines.Clear();\n    }\n    public class CartLine {\n        public int CartLineID { get; set; }\n        public Product Product { get; set; } = new();\n 213 Refining the cart model with a service\n        public int Quantity { get; set; }\n    }\n}\nNext, I added a class file called SessionCart.cs  to the Models  folder and used it to \ndefine the class shown in listing 9.2.\nListing 9.2    The contents of the SessionCart.cs file in the SportsStore/Models folder\nusing System.Text.Json.Serialization;\nusing SportsStore.Infrastructure;\nnamespace SportsStore.Models {\n    public class SessionCart : Cart {\n        public static Cart GetCart(IServiceProvider services) {\n            ISession? session = \n                services.GetRequiredService<IHttpContextAccessor>()\n                    .HttpContext?.Session;            \n            SessionCart cart = session?.GetJson<SessionCart>(""Cart"") \n                ?? new SessionCart();\n            cart.Session = session;\n            return cart;\n        }\n        [JsonIgnore]\n        public ISession? Session { get; set; }\n        public override void AddItem(Product product, int quantity) {\n            base.AddItem(product, quantity);\n            Session?.SetJson(""Cart"", this);\n        }\n        public override void RemoveLine(Product product) {\n            base.RemoveLine(product);\n            Session?.SetJson(""Cart"", this);\n        }\n        public override void Clear() {\n            base.Clear();\n            Session?.Remove(""Cart"");\n        }\n    }\n}\nThe SessionCart  class subclasses the Cart  class and overrides the AddItem , Remove-\nLine , and Clear  methods so they call the base implementations and then store the \nupdated state in the session using the extension methods on the ISession  interface. \nThe static GetCart  method is a factory for creating SessionCart  objects and provid-\ning them with an ISession  object so they can store themselves. \nGetting hold of the ISession  object is a little complicated. I obtain an instance of \nthe IHttpContextAccessor  service, which provides me with access to an Http Context  \nobject that, in turn, provides me with the ISession . This indirect approach is required \nbecause the session isn’t provided as a regular service.",5522
108-9.1.3 Simplifying the cart Razor Page.pdf,108-9.1.3 Simplifying the cart Razor Page,"214 chapter  9 SportsStore: Completing the cart \n9.1.2 Registering the service\nThe next step is to create a service for the Cart  class. My goal is to satisfy requests for \nCart  objects with SessionCart  objects that will seamlessly store themselves. You can \nsee how I created the service in listing 9.3.\nListing 9.3    Creating the cart service in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession();\nbuilder.Services.AddScoped<Cart>(sp => SessionCart.GetCart(sp));\nbuilder.Services.AddSingleton<IHttpContextAccessor, \n    HttpContextAccessor>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nSeedData.EnsurePopulated(app);\napp.Run();\n 215 Refining the cart model with a service\nThe AddScoped  method specifies that the same object should be used to satisfy related \nrequests for Cart  instances. How requests are related can be configured, but by default, \nit means that any Cart  required by components handling the same HTTP request will \nreceive the same object.\nRather than provide the AddScoped  method with a type mapping, as I did for the \nrepository, I have specified a lambda expression that will be invoked to satisfy Cart  \nrequests. The expression receives the collection of services that have been registered \nand passes the collection to the GetCart  method of the SessionCart  class. The result \nis that requests for the Cart  service will be handled by creating SessionCart  objects, \nwhich will serialize themselves as session data when they are modified. \nI also added a service using the AddSingleton  method, which specifies that the \nsame object should always be used. The service I created tells ASP.NET Core to use the \nHttpContextAccessor  class when implementations of the IHttpContextAccessor  \ninterface are required. This service is required so I can access the current session in the \nSessionCart  class.\n9.1.3 Simplifying the cart Razor Page\nThe benefit of creating this kind of service is that it allows me to simplify the code \nwhere Cart  objects are used. In listing 9.4, I have reworked the page model class for \nthe Cart  Razor Page to take advantage of the new service.\nListing 9.4    Using the service in the Cart.cshtml.cs file in the SportsStore/Pages folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing SportsStore.Infrastructure;\nusing SportsStore.Models;\nnamespace SportsStore.Pages {\n    public class CartModel : PageModel {\n        private IStoreRepository repository;\n        public CartModel(IStoreRepository repo, Cart cartService) {\n            repository = repo;\n            Cart = cartService;\n        }\n        public Cart Cart { get; set; }\n        public string ReturnUrl { get; set; } = ""/"";\n        public void OnGet(string returnUrl) {\n            ReturnUrl = returnUrl ?? ""/"";\n            //Cart = HttpContext.Session.GetJson<Cart>(""cart"") \n            //    ?? new Cart();\n        }\n        public IActionResult OnPost(long productId, string returnUrl) {\n            Product? product = repository.Products\n216 chapter  9 SportsStore: Completing the cart \n                .FirstOrDefault(p => p.ProductID == productId);\n            if (product != null) {\n                Cart.AddItem(product, 1);\n            }\n            return RedirectToPage(new { returnUrl = returnUrl });\n        }\n    }\n}\nThe page model class indicates that it needs a Cart  object by declaring a constructor \nargument, which has allowed me to remove the statements that load and store sessions \nfrom the handler methods. The result is a simpler page model class that focuses on its \nrole in the application without having to worry about how Cart  objects are created or \npersisted. And, since services are available throughout the application, any component \ncan get hold of the user’s cart using the same technique. \nUpdating the unit tests \nThe simplification of the CartModel  class in listing 9.4 requires a corresponding change \nto the unit tests in the CartPageTests.cs  file in the unit test project so that the Cart  \nis provided as a constructor argument and not accessed through the context objects. \nHere is the change to the test for reading the cart:\n...\n[Fact]\npublic void Can_Load_Cart() {\n    // Arrange\n    // - create a mock repository\n    Product p1 = new Product { ProductID = 1, Name = ""P1"" };\n    Product p2 = new Product { ProductID = 2, Name = ""P2"" };\n    Mock<IStoreRepository> mockRepo = new Mock<IStoreRepository>();\n    mockRepo.Setup(m => m.Products).Returns((new Product[] {\n        p1, p2\n    }).AsQueryable<Product>());\n    // - create a cart \n    Cart testCart = new Cart();\n    testCart.AddItem(p1, 2);\n    testCart.AddItem(p2, 1);\n    // Action\n    CartModel cartModel = new CartModel(mockRepo.Object, testCart);\n    cartModel.OnGet(""myUrl"");\n    //Assert\n    Assert.Equal(2, cartModel.Cart.Lines.Count());\n    Assert.Equal(""myUrl"", cartModel.ReturnUrl);\n}\n...\nI applied the same change to the unit test that checks changes to the cart:",6135
109-9.2 Completing the cart functionality.pdf,109-9.2 Completing the cart functionality,,0
110-9.2.1 Removing items from the cart.pdf,110-9.2.1 Removing items from the cart,"217 Completing the cart functionality\n(continued)\n...\n[Fact]\npublic void Can_Update_Cart() {\n    // Arrange\n    // - create a mock repository\n    Mock<IStoreRepository> mockRepo = new Mock<IStoreRepository>();\n    mockRepo.Setup(m => m.Products).Returns((new Product[] {\n        new Product { ProductID = 1, Name = ""P1"" }\n    }).AsQueryable<Product>());\n    Cart testCart = new Cart();\n    // Action\n    CartModel cartModel = new CartModel(mockRepo.Object, testCart);\n    cartModel.OnPost(1, ""myUrl"");\n    //Assert\n    Assert.Single(testCart.Lines);\n    Assert.Equal(""P1"", testCart.Lines.First().Product.Name);\n    Assert.Equal(1, testCart.Lines.First().Quantity);\n}\n...\nUsing services simplifies the testing process and makes it much easier to provide the \nclass being tested with its dependencies.\n9.2 Completing the cart functionality\nNow that I have introduced the Cart  service, it is time to complete the cart function-\nality by adding two new features. The first will allow the customer to remove an item \nfrom the cart. The second feature will display a summary of the cart at the top of the \npage.\n9.2.1 Removing items from the cart\nTo remove items from the cart, I need to add a Remove button to the content rendered \nby the Cart  Razor Page that will submit an HTTP POST request. The changes are \nshown in listing 9.5.\nListing 9.5    Removing cart items in the Cart.cshtml file in the SportsStore/Pages folder\n@page\n@model CartModel\n<h2>Your cart</h2>\n<table class=""table table-bordered table-striped"">\n    <thead>\n        <tr>\n            <th>Quantity</th>\n            <th>Item</th>\n218 chapter  9 SportsStore: Completing the cart \n            <th class=""text-right"">Price</th>\n            <th class=""text-right"">Subtotal</th>\n            <th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @foreach (var line in Model.Cart?.Lines\n                ?? Enumerable.Empty<CartLine>()) {\n            <tr>\n                <td class=""text-center"">@line.Quantity</td>\n                <td class=""text-left"">@line.Product.Name</td>\n                <td class=""text-right"">\n                    @line.Product.Price.ToString(""c"")\n                </td>\n                <td class=""text-right"">\n                    @((line.Quantity * line.Product.Price).ToString(""c""))\n                </td>\n                <td class=""text-center"">\n                    <form asp-page-handler=""Remove"" method=""post"">\n                        <input type=""hidden"" name=""ProductID""\n                           value=""@line.Product.ProductID"" />\n                        <input type=""hidden"" name=""returnUrl""\n                           value=""@Model?.ReturnUrl"" />\n                        <button type=""submit"" \n                                class=""btn btn-sm btn-danger"">\n                            Remove\n                        </button>\n                    </form>\n                </td>\n            </tr>\n        }\n    </tbody>\n    <tfoot>\n        <tr>\n            <td colspan=""3"" class=""text-right"">Total:</td>\n            <td class=""text-right"">\n                @Model.Cart?.ComputeTotalValue().ToString(""c"")\n            </td>\n        </tr>\n    </tfoot>\n</table>\n<div class=""text-center"">\n    <a class=""btn btn-primary"" href=""@Model.ReturnUrl"">\n        Continue shopping\n    </a>\n</div>\nThe button requires a new handler method in the page model class that will receive \nthe request and modify the cart, as shown in listing 9.6.\nListing 9.6    Removing an item in the Cart.cshtml.cs file in the SportsStore/Pages folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\n 219 Completing the cart functionality\nusing SportsStore.Infrastructure;\nusing SportsStore.Models;\nnamespace SportsStore.Pages {\n    public class CartModel : PageModel {\n        private IStoreRepository repository;\n        public CartModel(IStoreRepository repo, Cart cartService) {\n            repository = repo;\n            Cart = cartService;\n        }\n        public Cart Cart { get; set; }\n        public string ReturnUrl { get; set; } = ""/"";\n        public void OnGet(string returnUrl) {\n            ReturnUrl = returnUrl ?? ""/"";\n        }\n        public IActionResult OnPost(long productId, string returnUrl) {\n            Product? product = repository.Products\n                .FirstOrDefault(p => p.ProductID == productId);\n            if (product != null) {\n                Cart.AddItem(product, 1);\n            }\n            return RedirectToPage(new { returnUrl = returnUrl });\n        }\n        public IActionResult OnPostRemove(long productId,\n                string returnUrl) {\n            Cart.RemoveLine(Cart.Lines.First(cl =>\n                cl.Product.ProductID == productId).Product);\n            return RedirectToPage(new { returnUrl = returnUrl });\n        }\n    }\n}\nThe new HTML content defines an HTML form. The handler method that will receive \nthe request is specified with the asp-page-handler  tag helper attribute, like this:\n...\n<form asp-page-handler=""Remove""  method=""post"">\n...\nThe specified name is prefixed with On and given a suffix that matches the request \ntype so that a value of Remove  selects the OnPostRemove  handler method. The handler \nmethod uses the value it receives to locate the item in the cart and remove it.\nRestart ASP.NET Core and request http://localhost:5000. Click the Add To Cart but-\ntons to add items to the cart and then click a Remove button. The cart will be updated \nto remove the item you specified, as shown in figure 9.1.",5604
111-9.2.2 Adding the cart summary widget.pdf,111-9.2.2 Adding the cart summary widget,"220 chapter  9 SportsStore: Completing the cart \nFigure 9.1    Removing items from the shopping cart\n9.2.2 Adding the cart summary widget\nI may have a functioning cart, but there is an issue with the way it is integrated into \nthe interface. Customers can tell what is in their cart only by viewing the cart summary \nscreen. And they can view the cart summary screen only by adding a new item to the \ncart. \nTo solve this problem, I am going to add a widget that summarizes the contents of \nthe cart and that can be clicked to display the cart contents throughout the application. \nI will do this in much the same way that I added the navigation widget—as a view compo-\nnent whose output I can include in a Razor layout. \nadding  the font awesome  package  \nAs part of the cart summary, I am going to display a button that allows the user to check \nout. Rather than display the word checkout  in the button, I want to use a cart symbol. \nSince I have no artistic skills, I am going to use the Font Awesome package, which is an \nexcellent set of open source icons that are integrated into applications as fonts, where \neach character in the font is a different image. You can learn more about Font Awe-\nsome, including inspecting the icons it contains, at https://fontawesome.com . \nTo install the client-side package, use a PowerShell command prompt to run the \ncommand shown in listing 9.7 in the SportsStore project.\nListing 9.7    Installing the icon package \nlibman install font-awesome@6.2.1 -d wwwroot/lib/font-awesome\ncreating  the view component  class  and view\nI added a class file called CartSummaryViewComponent.cs  in the Components  folder \nand used it to define the view component shown in listing 9.8.\n 221 Completing the cart functionality\nListing 9.8    The CartSummaryViewComponent.cs file in the SportsStore/ \n Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nnamespace SportsStore.Components {\n    public class CartSummaryViewComponent : ViewComponent {\n        private Cart cart;\n        public CartSummaryViewComponent(Cart cartService) {\n            cart = cartService;\n        }\n        public IViewComponentResult Invoke() {\n            return View(cart);\n        }\n    }\n}\nThis view component can take advantage of the service that I created earlier in the \nchapter to receive a Cart  object as a constructor argument. The result is a simple view \ncomponent class that passes on the Cart  to the View  method to generate the fragment \nof HTML that will be included in the layout. To create the view for the component, I \ncreated the Views/Shared/Components/CartSummary  folder and added to it a Razor \nView named Default.cshtml  with the content shown in listing 9.9.\nListing 9.9    The Default.cshtml file in the Views/Shared/Components/ \n CartSummary folder\n@model Cart\n<div class="""">\n    @if (Model.Lines.Count() > 0) {\n            <small class=""navbar-text"">\n                <b>Your cart:</b>\n                @Model.Lines.Sum(x => x.Quantity) item(s)\n                @Model.ComputeTotalValue().ToString(""c"")\n            </small>\n    }\n    <a class=""btn btn-sm btn-secondary navbar-btn"" asp-page=""/Cart"" \n       asp-route-returnurl=\n            ""@ViewContext.HttpContext.Request.PathAndQuery()"">\n        <i class=""fa fa-shopping-cart""></i>\n    </a>\n</div>\nThe view displays a button with the Font Awesome cart icon and, if there are items in \nthe cart, provides a snapshot that details the number of items and their total value. \nNow that I have a view component and a view, I can modify the layout so that the cart \nsummary is included in the responses generated by the Home  controller, as shown in \nlisting 9.10.\n222 chapter  9 SportsStore: Completing the cart \nListing 9.10    Adding the summary in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>SportsStore</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />    \n    <link href=""/lib/font-awesome/css/all.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-dark text-white p-2"">\n        <div class=""container-fluid"">\n            <div class=""row"">\n                <div class=""col navbar-brand"">SPORTS STORE</div>\n                <div class=""col-6 navbar-text text-end"">\n                    <vc:cart-summary />\n                </div>\n            </div>\n        </div>\n    </div>\n    <div class=""row m-1 p-1"">\n        <div id=""categories"" class=""col-3"">\n            <vc:navigation-menu />\n        </div>\n        <div class=""col-9"">\n            @RenderBody()\n        </div>\n    </div>\n</body>\n</html>\nYou can see the cart summary by starting the application. When the cart is empty, only \nthe checkout button is shown. If you add items to the cart, then the number of items \nand their combined cost are shown, as illustrated in figure 9.2. With this addition, cus-\ntomers know what is in their cart and have an obvious way to check out from the store. \nFigure 9.2    Displaying a summary of the cart",5155
112-9.3 Submitting orders.pdf,112-9.3 Submitting orders,,0
113-9.3.3 Creating the controller and view.pdf,113-9.3.3 Creating the controller and view,"223 Submitting orders\n9.3 Submitting orders\nI have now reached the final customer feature in SportsStore: the ability to check out \nand complete an order. In the following sections, I will extend the data model to pro-\nvide support for capturing the shipping details from a user and add the application \nsupport to process those details. \n9.3.1 Creating the model class\nI added a class file called Order.cs  to the Models folder and used it to define the class \nshown in listing 9.11. This is the class I will use to represent the shipping details for a \ncustomer. \nListing 9.11    The contents of the Order.cs file in the SportsStore/Models folder \nusing System.ComponentModel.DataAnnotations;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace SportsStore.Models {\n    public class Order {\n        [BindNever]\n        public int OrderID { get; set; }\n        [BindNever]\n        public ICollection<CartLine> Lines { get; set; } \n            = new List<CartLine>();\n        [Required(ErrorMessage = ""Please enter a name"")]\n        public string? Name { get; set; }\n        [Required(ErrorMessage = ""Please enter the first address line"")]\n        public string? Line1 { get; set; }\n        public string? Line2 { get; set; }\n        public string? Line3 { get; set; }\n        [Required(ErrorMessage = ""Please enter a city name"")]\n        public string? City { get; set; }\n        [Required(ErrorMessage = ""Please enter a state name"")]\n        public string? State { get; set; }\n        public string? Zip { get; set; }\n        [Required(ErrorMessage = ""Please enter a country name"")]\n        public string? Country { get; set; }\n        public bool GiftWrap { get; set; }\n    }\n}\nI am using the validation attributes from the System.ComponentModel.Data -\nAnnotations  namespace, just as I did in chapter 3. I describe validation further in \nchapter 29. \n224 chapter  9 SportsStore: Completing the cart \nI also use the BindNever  attribute, which prevents the user from supplying values \nfor these properties in an HTTP request. This is a feature of the model binding system, \nwhich I describe in chapter 28, and it stops ASP.NET Core using values from the HTTP \nrequest to populate sensitive or important model properties.\n9.3.2 Adding the checkout process\nThe goal is to reach the point where users can enter their shipping details and submit \nan order. To start, I need to add a Checkout  button to the cart view, as shown in listing \n9.12.  \nListing 9.12    Adding a button in the Cart.cshtml file in the SportsStore/Pages folder\n...\n<div class=""text-center"">\n    <a class=""btn btn-primary"" href=""@Model.ReturnUrl"">\n        Continue shopping\n    </a>\n    <a class=""btn btn-primary"" asp-action=""Checkout"" \n            asp-controller=""Order"">\n        Checkout\n    </a>\n</div>\n...\nThis change generates a link that I have styled as a button and that, when clicked, calls \nthe Checkout  action method of the Order  controller, which I create in the following \nsection. To show how Razor Pages and controllers can work together, I am going to \nhandle the order processing in a controller and then return to a Razor Page at the end \nof the process. To see the Checkout button, restart ASP.NET Core, request http://\nlocalhost:5000, and click one of the Add To Cart buttons. The new button is shown as \npart of the cart summary, as shown in figure 9.3.\nFigure 9.3    The Checkout button\n 225 Submitting orders\n9.3.3 Creating the controller and view\nI now need to define the controller that will deal with the order. I added a class file \ncalled OrderController.cs  to the Controllers  folder and used it to define the class \nshown in listing 9.13.\nListing 9.13    The OrderController.cs file in the SportsStore/Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nnamespace SportsStore.Controllers {\n    public class OrderController : Controller {\n        public ViewResult Checkout() => View(new Order());\n    }\n}\nThe Checkout  method returns the default view and passes a new Order  object as the \nview model. To create the view, I created the Views/Order  folder and added to it a \nRazor View called Checkout.cshtml  with the markup shown in listing 9.14.\nListing 9.14    The Checkout.cshtml file in the SportsStore/Views/Order folder\n@model Order\n<h2>Check out now</h2>\n<p>Please enter your details, and we'll ship your goods right away!</p>\n<form asp-action=""Checkout"" method=""post"">\n    <h3>Ship to</h3>\n    <div class=""form-group"">\n        <label>Name:</label>\n        <input asp-for=""Name"" class=""form-control"" />\n    </div>\n    <h3>Address</h3>\n    <div class=""form-group"">\n        <label>Line 1:</label>\n        <input asp-for=""Line1"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>Line 2:</label>\n        <input asp-for=""Line2"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>Line 3:</label>\n        <input asp-for=""Line3"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>City:</label>\n        <input asp-for=""City"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>State:</label>\n        <input asp-for=""State"" class=""form-control"" />\n226 chapter  9 SportsStore: Completing the cart \n    </div>\n    <div class=""form-group"">\n        <label>Zip:</label>\n        <input asp-for=""Zip"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>Country:</label>\n        <input asp-for=""Country"" class=""form-control"" />\n    </div>\n    <h3>Options</h3>\n    <div class=""checkbox"">\n        <label>\n            <input asp-for=""GiftWrap"" /> Gift wrap these items\n        </label>\n    </div>\n    <div class=""text-center"">\n        <input class=""btn btn-primary"" type=""submit"" \n            value=""Complete Order"" />\n    </div>\n</form>\nFor each of the properties in the model, I have created a label  and input  elements to \ncapture the user input, styled with Bootstrap, and configured using a tag helper. The \nasp-for  attribute on the input  elements is handled by a built-in tag helper that gen-\nerates the type , id, name , and value  attributes based on the specified model property, \nas described in chapter 27.\nYou can see the form, shown in figure 9.4, by restarting ASP.NET Core, requesting \nhttp://localhost:5000, adding an item to the basket, and clicking the Checkout button. \nOr, more directly, you can request http://localhost:5000/order/checkout.\nFigure 9.4    \nThe shipping \ndetails form",6611
114-9.3.4 Implementing order processing.pdf,114-9.3.4 Implementing order processing,"227 Submitting orders\n9.3.4 Implementing order processing\nI will process orders by writing them to the database. Most e-commerce sites would \nnot simply stop there, of course, and I have not provided support for processing credit \ncards or other forms of payment. But I want to keep things focused on ASP.NET Core, \nso a simple database entry will do. \nextending  the database  \nAdding a new kind of model to the database is simple because of the initial setup I went \nthrough in chapter 7. First, I added a new property to the database context class, as \nshown in listing 9.15.\nListing 9.15    Adding a property in the StoreDbContext.cs file in the SportsStore/\nModels folder\nusing Microsoft.EntityFrameworkCore;\nnamespace SportsStore.Models {\n    public class StoreDbContext : DbContext {\n        public StoreDbContext(DbContextOptions<StoreDbContext> options)\n            : base(options) { }\n        public DbSet<Product> Products => Set<Product>();\n        public DbSet<Order> Orders => Set<Order>();\n    }\n}\nThis change is enough for Entity Framework Core to create a database migration \nthat will allow Order  objects to be stored in the database. To create the migration, \nuse a PowerShell command prompt to run the command shown in listing 9.16 in the \nSportsStore  folder.\nListing 9.16    Creating a migration \ndotnet ef migrations add Orders\nThis command tells Entity Framework Core to take a new snapshot of the application \ndata model, work out how it differs from the previous database version, and generate \na new migration called Orders . The new migration will be applied automatically when \nthe application starts because the SeedData  calls the Migrate  method provided by \nEntity Framework Core.\nResetting the database\nWhen you are making frequent changes to the model, there will come a point when \nyour migrations and your database schema get out of sync. The easiest thing to do is \ndelete the database and start over. However, this applies only during development, of \ncourse, because you will lose any data you have stored. Run this command to delete the \ndatabase:\ndotnet ef database drop --force --context StoreDbContext\n228 chapter  9 SportsStore: Completing the cart \n(continued)\nOnce the database has been removed, run the following command from the Sports-\nStore  folder to re-create the database and apply the migrations you have created by \nrunning the following command:\ndotnet ef database update --context StoreDbContext\nThe migrations will also be applied by the SeedData  class if you just start the applica-\ntion. Either way, the database will be reset so that it accurately reflects your data model \nand allows you to return to developing your application.\n \ncreating  the order  repository\nI am going to follow the same pattern I used for the product repository to provide \naccess to the Order  objects. I added a class file called IOrderRepository.cs  to the \nModels  folder and used it to define the interface shown in listing 9.17.\nListing 9.17    The IOrderRepository.cs file in the SportsStore/Models folder\nnamespace SportsStore.Models {\n    public interface IOrderRepository {\n        IQueryable<Order> Orders { get; }\n        void SaveOrder(Order order);\n    }\n}\nTo implement the order repository interface, I added a class file called EFOrder-\nRepository.cs  to the Models  folder and defined the class shown in listing 9.18.\nListing 9.18    The EFOrderRepository.cs File in the SportsStore/Models folder\nusing Microsoft.EntityFrameworkCore;\nnamespace SportsStore.Models {\n    public class EFOrderRepository : IOrderRepository {\n        private StoreDbContext context;\n        public EFOrderRepository(StoreDbContext ctx) {\n            context = ctx;\n        }\n        public IQueryable<Order> Orders => context.Orders\n                            .Include(o => o.Lines)\n                            .ThenInclude(l => l.Product);\n        public void SaveOrder(Order order) {\n            context.AttachRange(order.Lines.Select(l => l.Product));\n            if (order.OrderID == 0) {\n                context.Orders.Add(order);\n 229 Submitting orders\n            }\n            context.SaveChanges();\n        }\n    }\n}\nThis class implements the IOrderRepository  interface using Entity Framework Core, \nallowing the set of Order  objects that have been stored to be retrieved and allowing for \norders to be created or changed. \nUnderstanding the order repository\nEntity Framework Core requires instruction to load related data if it spans multiple tables. \nIn listing 9.18, I used the Include  and ThenInclude  methods to specify that when \nan Order  object is read from the database, the collection associated with the Lines  \nproperty should also be loaded along with each Product  object associated with each \ncollection object.\n...\npublic IQueryable<Order> Orders => context.Orders\n    .Include(o => o.Lines)\n    .ThenInclude (l => l.Product);\n...\nThis ensures that I receive all the data objects that I need without having to perform sep-\narate queries and then assemble the data myself.\nAn additional step is also required when I store an Order  object in the database. When \nthe user’s cart data is de-serialized from the session store, new objects are created that \nare not known to Entity Framework Core, which then tries to write all the objects into the \ndatabase. For the Product  objects associated with an Order , this means that Entity \nFramework Core tries to write objects that have already been stored, which causes an \nerror. To avoid this problem, I notify Entity Framework Core that the objects exist and \nshouldn’t be stored in the database unless they are modified, as follows:\n...\ncontext. AttachRange (order.Lines.Select(l => l.Product));\n...\nThis ensures that Entity Framework Core won’t try to write the de-serialized Product  \nobjects that are associated with the Order  object.\nIn listing 9.19, I have registered the order repository as a service in the Program.cs  \nfile. \nListing 9.19    Registering the service in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();",6307
115-9.3.5 Completing the order controller.pdf,115-9.3.5 Completing the order controller,"230 chapter  9 SportsStore: Completing the cart \nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddScoped<IOrderRepository, EFOrderRepository>();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession();\nbuilder.Services.AddScoped<Cart>(sp => SessionCart.GetCart(sp));\nbuilder.Services.AddSingleton<IHttpContextAccessor, \n    HttpContextAccessor>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nSeedData.EnsurePopulated(app);\napp.Run();\n9.3.5 Completing the order controller\nTo complete the OrderController  class, I need to modify the constructor so that it \nreceives the services it requires to process an order and add an action method that will \nhandle the HTTP form POST  request when the user clicks the Complete Order button. \nListing 9.20 shows both changes.\nListing 9.20    Completing the controller in the OrderController.cs file in the \nSportsStore/Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models;\nnamespace SportsStore.Controllers {\n 231 Submitting orders\n    public class OrderController : Controller {\n        private IOrderRepository repository;\n        private Cart cart;\n        public OrderController(IOrderRepository repoService,\n                Cart cartService) {\n            repository = repoService;\n            cart = cartService;\n        }\n        public ViewResult Checkout() => View(new Order());\n        [HttpPost]\n        public IActionResult Checkout(Order order) {\n            if (cart.Lines.Count() == 0) {\n                ModelState.AddModelError("""", \n                    ""Sorry, your cart is empty!"");\n            }\n            if (ModelState.IsValid) {\n                order.Lines = cart.Lines.ToArray();\n                repository.SaveOrder(order);\n                cart.Clear();\n                return RedirectToPage(""/Completed"", \n                    new { orderId = order.OrderID });\n            } else {\n                return View();\n            }\n        }\n    }\n}\nThe Checkout  action method is decorated with the HttpPost  attribute, which means \nthat it will be used to handle POST  requests—in this case, when the user submits the \nform. \nIn chapter 8, I use the ASP.NET Core model binding feature to receive simple data \nvalues from the request. This same feature is used in the new action method to receive \na completed Order  object. When a request is processed, the model binding system tries \nto find values for the properties defined by the Order  class. This works on a best-effort \nbasis, which means I may receive an Order  object lacking property values if there is no \ncorresponding data item in the request.\nTo ensure I have the data I require, I applied validation attributes to the Order  class. \nASP.NET Core checks the validation constraints that I applied to the Order  class and \nprovides details of the result through the ModelState  property. I can see whether there \nare any problems by checking the ModelState.IsValid  property. I call the Model-\nState.AddModelError  method to register an error message if there are no items in \nthe cart. I will explain how to display such errors shortly, and I have much more to say \nabout model binding and validation in chapters 28 and 29.\n232 chapter  9 SportsStore: Completing the cart \nUnit test: order processing\nTo perform unit testing for the OrderController  class, I need to test the behavior of \nthe POST  version of the Checkout  method. Although the method looks short and sim-\nple, the use of model binding means that a lot is going on behind the scenes that needs \nto be tested. \nI want to process an order only if there are items in the cart and the customer has pro-\nvided valid shipping details. Under all other circumstances, the customer should be \nshown an error. Here is the first test method, which I defined in a class file called Order-\nControllerTests.cs  in the SportsStore.Tests  project:\nusing Microsoft.AspNetCore.Mvc;\nusing Moq;\nusing SportsStore.Controllers;\nusing SportsStore.Models;\nusing Xunit;\nnamespace SportsStore.Tests {\n    public class OrderControllerTests {\n        [Fact]\n        public void Cannot_Checkout_Empty_Cart() {\n            // Arrange - create a mock repository\n            Mock<IOrderRepository> mock = new Mock<IOrderRepository>();\n            // Arrange - create an empty cart\n            Cart cart = new Cart();\n            // Arrange - create the order\n            Order order = new Order();\n            // Arrange - create an instance of the controller\n            OrderController target = \n                new OrderController(mock.Object, cart);\n            // Act\n            ViewResult? result = target.Checkout(order) as ViewResult;\n            // Assert - check that the order hasn't been stored \n            mock.Verify(m => m.SaveOrder(It.IsAny<Order>()), Times.Never);\n            // Assert - check that the method is returning the default view\n            Assert.True(string.IsNullOrEmpty(result?.ViewName));\n            // Assert - check I am passing an invalid model to the view\n            Assert.False(result?.ViewData.ModelState.IsValid);\n        }\n    }\n}\nThis test ensures that I cannot check out with an empty cart. I check this by ensuring that \nthe SaveOrder  of the mock IOrderRepository  implementation is never called, that \nthe view the method returns is the default view (which will redisplay the data entered by \ncustomers and give them a chance to correct it), and that the model state being passed \nto the view has been marked as invalid. This may seem like a belt-and-braces set of \nassertions, but I need all three to be sure that I have the right behavior. The next test \nmethod works in much the same way but injects an error into the view model to simulate \na problem reported by the model binder (which would happen in production when the \ncustomer enters invalid shipping data):\n 233 Submitting orders\n(continued)\n...\n[Fact]\npublic void Cannot_Checkout_Invalid_ShippingDetails() {\n    // Arrange - create a mock order repository\n    Mock<IOrderRepository> mock = new Mock<IOrderRepository>();\n    // Arrange - create a cart with one item\n    Cart cart = new Cart();\n    cart.AddItem(new Product(), 1);\n    // Arrange - create an instance of the controller\n    OrderController target = new OrderController(mock.Object, cart);\n    // Arrange - add an error to the model\n    target.ModelState.AddModelError(""error"", ""error"");\n    // Act - try to checkout\n    ViewResult? result = target.Checkout(new Order()) as ViewResult;\n    // Assert - check that the order hasn't been passed stored\n    mock.Verify(m => m.SaveOrder(It.IsAny<Order>()), Times.Never);\n    // Assert - check that the method is returning the default view\n    Assert.True(string.IsNullOrEmpty(result?.ViewName));\n    // Assert - check that I am passing an invalid model to the view\n    Assert.False(result?.ViewData.ModelState.IsValid);\n}\n...\nHaving established that an empty cart or invalid details will prevent an order from being \nprocessed, I need to ensure that I process orders when appropriate. Here is the test:\n...\n[Fact]\npublic void Can_Checkout_And_Submit_Order() {\n    // Arrange - create a mock order repository\n    Mock<IOrderRepository> mock = new Mock<IOrderRepository>();\n    // Arrange - create a cart with one item\n    Cart cart = new Cart();\n    cart.AddItem(new Product(), 1);\n    // Arrange - create an instance of the controller\n    OrderController target = new OrderController(mock.Object, cart);\n    // Act - try to checkout\n    RedirectToPageResult? result =\n            target.Checkout(new Order()) as RedirectToPageResult;\n    // Assert - check that the order has been stored\n    mock.Verify(m => m.SaveOrder(It.IsAny<Order>()), Times.Once);\n    // Assert - check the method is redirecting to the Completed action\n    Assert.Equal(""/Completed"", result?.PageName);\n} \n...\nI did not need to test that I can identify valid shipping details. This is handled for me auto-\nmatically by the model binder using the attributes applied to the properties of the Order  \nclass.",8993
116-9.3.6 Displaying validation errors.pdf,116-9.3.6 Displaying validation errors,"234 chapter  9 SportsStore: Completing the cart \n9.3.6 Displaying validation errors\nASP.NET Core uses the validation attributes applied to the Order  class to validate \nuser data, but I need to make a simple change to display any problems. This relies on \nanother built-in tag helper that inspects the validation state of the data provided by the \nuser and adds warning messages for each problem that has been discovered. Listing \n9.21 shows the addition of an HTML element that will be processed by the tag helper \nto the Checkout.cshtml  file. \nListing 9.21    Adding a validation summary to the Checkout.cshtml file in the \nSportsStore/Views/Order folder\n@model Order\n<h2>Check out now</h2>\n<p>Please enter your details, and we'll ship your goods right away!</p>\n<div asp-validation-summary=""All"" class=""text-danger""></div>\n<form asp-action=""Checkout"" method=""post"">\n    <h3>Ship to</h3>\n    <div class=""form-group"">\n        <label>Name:</label>\n        <input asp-for=""Name"" class=""form-control"" />\n    </div>\n    <h3>Address</h3>\n    <div class=""form-group"">\n        <label>Line 1:</label>\n        <input asp-for=""Line1"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>Line 2:</label>\n        <input asp-for=""Line2"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>Line 3:</label>\n        <input asp-for=""Line3"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>City:</label>\n        <input asp-for=""City"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>State:</label>\n        <input asp-for=""State"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>Zip:</label>\n        <input asp-for=""Zip"" class=""form-control"" />\n    </div>\n    <div class=""form-group"">\n        <label>Country:</label>\n        <input asp-for=""Country"" class=""form-control"" />\n 235 Submitting orders\n    </div>\n    <h3>Options</h3>\n    <div class=""checkbox"">\n        <label>\n            <input asp-for=""GiftWrap"" /> Gift wrap these items\n        </label>\n    </div>\n    <div class=""text-center"">\n        <input class=""btn btn-primary"" type=""submit"" \n            value=""Complete Order"" />\n    </div>\n</form>\nWith this simple change, validation errors are reported to the user. To see the effect, \nrestart ASP.NET Core, request http://localhost:5000/Order/Checkout, and click the \nComplete Order button without filling out the form. ASP.NET Core will process the \nform data, detect that the required values were not found, and generate the validation \nerrors shown in figure 9.5.\nFigure 9.5    Displaying validation messages\nTIP    The data submitted by the user is sent to the server before it is validated, \nwhich is known as server-side validation  and for which ASP.NET Core has excel-\nlent support. The problem with server-side validation is that the user isn’t told \nabout errors until after the data has been sent to the server and processed and \nthe result page has been generated—something that can take a few seconds on \na busy server. For this reason, server-side validation is usually complemented by \nclient-side validation , where JavaScript is used to check the values that the user has \nentered before the form data is sent to the server. I describe client-side validation \nin chapter 29.",3400
117-10.1.1 Creating the imports file.pdf,117-10.1.1 Creating the imports file,"236 chapter  9 SportsStore: Completing the cart \n9.3.7 Displaying a summary page\nTo complete the checkout process, I am going to create a Razor Page that displays a \nthank-you message with a summary of the order. Add a Razor Page named Completed \n.cshtml  to the Pages  folder with the contents shown in listing 9.22.\nListing 9.22    The contents of the Completed.cshtml file in the SportsStore/Pages folder\n@page\n<div class=""text-center"">\n    <h2>Thanks!</h2>\n    <p>Thanks for placing order #@OrderId</p>\n    <p>We'll ship your goods as soon as possible.</p>\n    <a class=""btn btn-primary"" asp-controller=""Home"">Return to Store</a>\n</div>\n@functions {\n    [BindProperty(SupportsGet = true)]\n    public string? OrderId { get; set; }\n}\nAlthough Razor Pages usually have page model classes, they are not a requirement, \nand simple features can be developed without them. In this example, I have defined \na property named OrderId  and decorated it with the BindProperty  attribute, which \nspecifies that a value for this property should be obtained from the request by the \nmodel binding system. \nNow customers can go through the entire process, from selecting products to check-\ning out. If they provide valid shipping details (and have items in their cart), they will see \nthe summary page when they click the Complete Order button, as shown in figure 9.6.\nNotice the way the application moves between controllers and Razor Pages. The \napplication features that ASP.NET Core provides are complementary and can be mixed \nfreely in projects.\nFigure 9.6    The completed order summary view \n 237 Summary\nSummary\n¡ Representations of user data can be written to persist themselves as session data.\n¡ View components are used to present content that is not directly related to the \nview model for the current response, such as a summary of a shopping cart.\n¡ View components can access services via dependency injection to get the data \nthey require.\n¡ User data can be received using HTTP POST requests, which are transformed \ninto C# objects by model binding.\n¡ ASP.NET Core provides integrated support for validating user data and dis-\nplaying details of validation problems to the user.Revisit and enhance the URL \nscheme\n¡ Create a category list that will go into the sidebar of the site, highlighting the cur-\nrent category and linking to others\n23810SportsStore:  \nAdministration\nThis chapter covers\n¡ Building an interactive feature using Blazor\n¡ Implementing application features with Razor  \n Components \n¡ Aligning component and service lifecycles \n¡ Validating data in a Razor Component\n¡ Performing create, read, update, and delete  \n operations with Blazor\nIn this chapter, I continue to build the SportsStore application to give the site admin-\nistrator a way to manage orders and products. In this chapter, I use Blazor to create \nadministration features. Blazor combines client-side JavaScript code with server-side \ncode executed by ASP.NET Core, connected by a persistent HTTP connection. I \ndescribe Blazor in detail in chapters 32–35, but it is important to understand that \nthe Blazor model is not suited to all projects. (I use Blazor Server in this chapter, \nwhich is a supported part of the ASP.NET Core platform. There is also Blazor Web-\nAssembly, which is, at the time of writing, experimental and runs entirely in the \nbrowser. I describe Blazor WebAssembly in chapter 36.)\nTIP    You can download the example project for this chapter—and for all \nthe other chapters in this book—from https://github.com/manningbooks/\npro-asp.net-core-7 . See chapter 1 for how to get help if you have problems \nrunning the examples.\n 239 Preparing Blazor Server\n10.1 Preparing Blazor Server\nThe first step is to enable the services and middleware for Blazor, as shown in listing \n10.1.\nListing 10.1    Enabling Blazor in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddScoped<IOrderRepository, EFOrderRepository>();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession();\nbuilder.Services.AddScoped<Cart>(sp => SessionCart.GetCart(sp));\nbuilder.Services.AddSingleton<IHttpContextAccessor, \n    HttpContextAccessor>();\nbuilder.Services.AddServerSideBlazor();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/admin/{*catchall}"", ""/Admin/Index"");\nSeedData.EnsurePopulated(app);\napp.Run();",5480
118-10.1.4 Creating the Razor Components.pdf,118-10.1.4 Creating the Razor Components,"240 chapter  10 SportsStore: Administration \nThe AddServerSideBlazor  method creates the services that Blazor uses, and the \nMapBlazorHub  method registers the Blazor middleware components. The final addi-\ntion is to finesse the routing system to ensure that Blazor works seamlessly with the rest \nof the application.\n10.1.1  Creating the imports file\nBlazor requires its own imports file to specify the namespaces that it uses. Create the \nPages/Admin  folder and add to it a file named _Imports.razor  with the content \nshown in listing 10.2. (If you are using Visual Studio, you can use the Razor Compo-\nnents template to create this file.)\nNOTE     The conventional location for Blazor files is within the Pages  folder, but \nBlazor files can be defined anywhere in the project. In part 4, for example, I \nused a folder named Blazor  to help emphasize which features were provided by \nBlazor and which by Razor Pages.\nListing 10.2    The _Imports.razor file in the SportsStore/Pages/Admin folder\n@using Microsoft.AspNetCore.Components\n@using Microsoft.AspNetCore.Components.Forms\n@using Microsoft.AspNetCore.Components.Routing\n@using Microsoft.AspNetCore.Components.Web\n@using Microsoft.EntityFrameworkCore\n@using SportsStore.Models\nThe first four @using  expressions are for the namespaces required for Blazor. The last \ntwo expressions are for convenience in the examples that follow because they will allow \nme to use Entity Framework Core and the classes in the Models  namespace.\n10.1.2  Creating the startup Razor Page\nBlazor relies on a Razor Page to provide the initial content to the browser, which \nincludes the JavaScript code that connects to the server and renders the Blazor HTML \ncontent. Add a Razor Page named Index.cshtml  to the Pages/Admin  folder with the \ncontents shown in listing 10.3.\nListing 10.3    The Index.cshtml File in the SportsStore/Pages/Admin Folder\n@page ""/admin""\n@{  Layout = null; }\n<!DOCTYPE html>\n<html>\n<head>\n    <title>SportsStore Admin</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <base href=""/"" />  \n</head>\n<body>    \n 241 Preparing Blazor Server\n    <component type=""typeof(Routed)"" render-mode=""Server"" />\n    <script src=""/_framework/blazor.server.js""></script>\n</body>\n</html>\nThe component  element is used to insert a Razor Component in the output from the \nRazor Page. Razor Components are the confusingly named Blazor building blocks, \nand the component  element applied in listing 10.3 is named Routed  and will be cre-\nated shortly. The Razor Page also contains a script  element that tells the browser to \nload the JavaScript file that Blazor Server uses. Requests for this file are intercepted by \nthe Blazor Server middleware, and you don’t need to explicitly add the JavaScript file \nto the project.\n10.1.3  Creating the routing and layout components \nAdd a Razor Component named Routed.razor  to the Pages/Admin  folder and add \nthe content shown in listing 10.4. \nListing 10.4    The Routed.razor File in the SportsStore/Pages/Admin Folder\n<Router AppAssembly=""typeof(Program).Assembly"">\n    <Found>\n        <RouteView RouteData=""@context"" \n            DefaultLayout=""typeof(AdminLayout)"" />\n    </Found>\n    <NotFound>\n        <h4 class=""bg-danger text-white text-center p-2"">\n            No Matching Route Found\n        </h4>\n    </NotFound>\n</Router>\nThe content of this component is described in detail in part 4 of this book, but, for this \nchapter, it is enough to know that the component will use the browser’s current URL \nto locate a Razor Component that can be displayed to the user. If no matching compo-\nnent can be found, then an error message is displayed.\nBlazor has its own system of layouts. To create the layout for the administration tools, \nadd a Razor Component named AdminLayout.razor  to the Pages/Admin  folder with \nthe content shown in listing 10.5.\nListing 10.5    The AdminLayout.razor File in the SportsStore/Pages/Admin Folder\n@inherits LayoutComponentBase\n<div class=""bg-info text-white p-2"">\n    <span class=""navbar-brand ml-2"">SPORTS STORE Administration</span>\n</div>\n<div class=""container-fluid"">\n    <div class=""row p-2"">\n        <div class=""col-3"">\n            <div class=""d-grid gap-1"">\n                <NavLink class=""btn btn-outline-primary""",4372
119-10.2.2 Displaying orders to the administrator.pdf,119-10.2.2 Displaying orders to the administrator,"242 chapter  10 SportsStore: Administration \n                            href=""/admin/products"" \n                            ActiveClass=""btn-primary text-white"" \n                            Match=""NavLinkMatch.Prefix"">\n                    Products\n                </NavLink>\n                <NavLink class=""btn btn-outline-primary""\n                            href=""/admin/orders"" \n                            ActiveClass=""btn-primary text-white"" \n                            Match=""NavLinkMatch.Prefix"">\n                    Orders\n                </NavLink>\n            </div>\n        </div>\n        <div class=""col"">\n            @Body\n        </div>\n    </div>\n</div>\nBlazor uses Razor syntax to generate HTML but introduces its own directives and fea-\ntures. This layout renders a two-column display with Product and Order navigation \nbuttons, which are created using NavLink  elements. These elements apply a built-in \nRazor Component that changes the URL without triggering a new HTTP request, \nwhich allows Blazor to respond to user interaction without losing the application state.\n10.1.4  Creating the Razor Components \nTo complete the initial setup, I need to add the components that will provide the \nadministration tools, although they will contain placeholder messages at first. Add a \nRazor Component named Products.razor  to the Pages/Admin  folder with the con-\ntent shown in listing 10.6.\nListing 10.6.    The Products.razor File in the SportsStore/Pages/Admin Folder\n@page ""/admin/products""\n@page ""/admin""\n<h4>This is the products component</h4>\nThe @page  directives specify the URLs for which this component will be displayed, \nwhich are /admin/products  and /admin . Next, add a Razor Component named \nOrders.razor  to the Pages/Admin  folder with the content shown in listing 10.7.\nListing 10.7.    The Orders.razor File in the SportsStore/Pages/Admin Folder\n@page ""/admin/orders""\n<h4>This is the orders component</h4>\n10.1.5  Checking the Blazor setup\nTo make sure that Blazor is working correctly, start ASP.NET Core and request http://\nlocalhost:5000/admin. This request will be handled by the Index  Razor Page in the \n 243 Managing orders\nPages/Admin  folder, which will include the Blazor JavaScript file in the content it \nsends to the browser. The JavaScript code will open a persistent HTTP connection to \nthe ASP.NET Core server, and the initial Blazor content will be rendered, as shown in \nfigure 10.1.\nNOTE    Microsoft has not released tools for testing Razor Components, which is \nwhy there are no unit testing examples in this chapter. \nFigure 10.1    The Blazor application \nClick the Orders button, and content generated by the Orders  Razor Component \nwill be displayed, as shown in figure 10.2. Unlike the other ASP.NET Core applica-\ntion frameworks I used in earlier chapters, the new content is displayed without a new \nHTTP request being sent, even though the URL displayed by the browser changes. \nFigure 10.2    Navigating in the Blazor application \n10.2 Managing orders\nNow that Blazor has been set up and tested, I am going to start implementing admin-\nistration features. In the previous chapter, I added support for receiving orders from \ncustomers and storing them in a database. In this section, I am going to create a simple \nadministration tool that will let me view the orders that have been received and mark \nthem as shipped.\n244 chapter  10 SportsStore: Administration \n10.2.1  Enhancing the model\nThe first change I need to make is to enhance the data model so that I can record \nwhich orders have been shipped. Listing 10.8 shows the addition of a new property to \nthe Order  class, which is defined in the Order.cs  file in the Models  folder.\nListing 10.8    Adding a property in the Order.cs file in the SportsStore/Models folder \nusing System.ComponentModel.DataAnnotations;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace SportsStore.Models {\n    public class Order {\n        [BindNever]\n        public int OrderID { get; set; }\n        [BindNever]\n        public ICollection<CartLine> Lines { get; set; }\n            = new List<CartLine>();\n        [Required(ErrorMessage = ""Please enter a name"")]\n        public string? Name { get; set; }\n        [Required(ErrorMessage = ""Please enter the first address line"")]\n        public string? Line1 { get; set; }\n        public string? Line2 { get; set; }\n        public string? Line3 { get; set; }\n        [Required(ErrorMessage = ""Please enter a city name"")]\n        public string? City { get; set; }\n        [Required(ErrorMessage = ""Please enter a state name"")]\n        public string? State { get; set; }\n        public string? Zip { get; set; }\n        [Required(ErrorMessage = ""Please enter a country name"")]\n        public string? Country { get; set; }\n        public bool GiftWrap { get; set; }\n        [BindNever]\n        public bool Shipped { get; set; }\n    }\n}\nThis iterative approach of extending and adapting the data model to support differ-\nent features is typical of ASP.NET Core development. In an ideal world, you would be \nable to completely define the data model at the start of the project and just build the \napplication around it, but that happens only for the simplest of projects, and, in prac-\ntice, iterative development is to be expected as the understanding of what is required \ndevelops and evolves. \n 245 Managing orders\nEntity Framework Core migrations make this process easier because you don’t have \nto manually keep the database schema synchronized to the model class by writing your \nown SQL commands. To update the database to reflect the addition of the Shipped  \nproperty to the Order  class, open a new PowerShell window and run the command \nshown in listing 10.9 in the SportsStore project. \nListing 10.9    Creating a new migration \ndotnet ef migrations add ShippedOrders\nThe migration will be applied automatically when the application is started and the \nSeedData  class calls the Migrate  method provided by Entity Framework Core.\n10.2.2  Displaying orders to the administrator\nI am going to display two tables, one of which shows the orders waiting to be shipped \nand the other the shipped orders. Each order will be presented with a button that \nchanges the shipping state. This is not entirely realistic because orders processing is \ntypically more complex than simply updating a field in the database, but integration \nwith warehouse and fulfillment systems is well beyond the scope of this book. \nTo avoid duplicating code and content, I am going to create a Razor Component \nthat displays a table without knowing which category of order it is dealing with. Add \na Razor Component named OrderTable.razor  to the Pages/Admin  folder with the \ncontent shown in listing 10.10.\nListing 10.10    The OrderTable.razor file in the SportsStore/Pages/Admin folder\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr><th colspan=""5"" class=""text-center"">@TableTitle</th></tr>\n    </thead>\n    <tbody>\n        @if (Orders?.Count() > 0) {\n            @foreach (Order o in Orders) {\n                <tr>\n                    <td>@o.Name</td>\n                    <td>@o.Zip</td>\n                    <th>Product</th>\n                    <th>Quantity</th>\n                    <td>\n                        <button class=""btn btn-sm btn-danger""\n                        @onclick=""@(e => \n                                OrderSelected.InvokeAsync(o.OrderID))"">\n                            @ButtonLabel\n                        </button>\n                    </td>\n                </tr>\n                @foreach (CartLine line in o.Lines) {\n                    <tr>\n                        <td colspan=""2""></td>\n                        <td>@line.Product.Name</td>\n246 chapter  10 SportsStore: Administration \n                        <td>@line.Quantity</td>\n                        <td></td>\n                    </tr>\n                }\n            }\n        } else {\n            <tr><td colspan=""5"" class=""text-center"">No Orders</td></tr>\n        }\n    </tbody>\n</table>\n@code {\n    [Parameter]\n    public string TableTitle { get; set; } = ""Orders"";\n    [Parameter]\n    public IEnumerable<Order> Orders { get; set; } \n        = Enumerable.Empty<Order>();\n    [Parameter]\n    public string ButtonLabel { get; set; } = ""Ship"";\n    [Parameter]\n    public EventCallback<int> OrderSelected { get; set; }\n}\nRazor Components, as the name suggests, rely on the Razor approach to annotated \nHTML elements. The view part of the component is supported by the statements in \nthe @code  section. The @code  section in this component defines four properties that \nare decorated with the Parameter  attribute, which means the values will be provided \nat runtime by the parent component, which I will create shortly. The values provided \nfor the parameters are used in the view section of the component to display details of a \nsequence of Order  objects. \nBlazor adds expressions to the Razor syntax. The view section of this component \nincludes this button  element, which has an @onclick  attribute:\n...\n<button class=""btn btn-sm btn-danger"" \n        @onclick=""@(e => OrderSelected.InvokeAsync(o.OrderID))"" >\n    @ButtonLabel\n</button>\n...\nThis tells Blazor how to react when the user clicks the button. In this case, the expres-\nsion tells Razor to call the InvokeAsync  method of the OrderSelected  property. \nThis is how the table will communicate with the rest of the Blazor application and will \nbecome clearer as I build out additional features. \nTIP    I describe Blazor in-depth in part 4 of this book, so don’t worry if the Razor \nComponents in this chapter do not make immediate sense. The purpose of the \nSportsStore example is to show the overall development process, even if individ-\nual features are not understood.\n 247 Managing orders\nThe next step is to create a component that will get the Order  data from the database \nand use the OrderTable  component to display it to the user. Remove the placeholder \ncontent in the Orders  component and replace it with the code and content shown in \nlisting 10.11.\nListing 10.11    The revised contents of the Orders.razor file in the SportsStore/\nPages/Admin folder\n@page ""/admin/orders""\n@inherits OwningComponentBase<IOrderRepository>\n<OrderTable TableTitle=""Unshipped Orders"" Orders=""UnshippedOrders"" \n            ButtonLabel=""Ship"" OrderSelected=""ShipOrder"" />\n<OrderTable TableTitle=""Shipped Orders"" Orders=""ShippedOrders"" \n            ButtonLabel=""Reset"" OrderSelected=""ResetOrder"" />\n<button class=""btn btn-info"" @onclick=""@(e => UpdateData())"">\n    Refresh Data\n</button>\n@code {\n    public IOrderRepository Repository => Service;\n    public IEnumerable<Order> AllOrders { get; set; } \n        = Enumerable.Empty<Order>();\n    public IEnumerable<Order> UnshippedOrders { get; set; }\n        = Enumerable.Empty<Order>();\n    public IEnumerable<Order> ShippedOrders { get; set; }\n        = Enumerable.Empty<Order>();\n    protected async override Task OnInitializedAsync() {\n        await UpdateData();\n    }\n    public async Task UpdateData() {\n        AllOrders = await Repository.Orders.ToListAsync();\n        UnshippedOrders = AllOrders.Where(o => !o.Shipped);\n        ShippedOrders = AllOrders.Where(o => o.Shipped);\n    }\n    public void ShipOrder(int id) => UpdateOrder(id, true);\n    public void ResetOrder(int id) => UpdateOrder(id, false);\n    private void UpdateOrder(int id, bool shipValue) {\n        Order? o = Repository.Orders.FirstOrDefault(o => o.OrderID == id);\n        if (o != null) {\n            o.Shipped = shipValue;\n            Repository.SaveOrder(o);\n        }\n    }\n}\nBlazor Components are not like the other application framework building blocks used \nfor the user-facing sections of the SportsStore application. Instead of dealing with indi-\nvidual requests, components can be long-lived and deal with multiple user interactions \n248 chapter  10 SportsStore: Administration \nover a longer period. This requires a different style of development, especially when it \ncomes to dealing with data using Entity Framework Core. The @inherits  expression \nensures that this component gets its own repository object, which ensures its opera-\ntions are separate from those performed by other components displayed to the same \nuser. And to avoid repeatedly querying the database—which can be a serious problem \nin Blazor, as I explain in part 4—the repository is used only when the component is \ninitialized, when Blazor invokes the OnInitializedAsync  method, or when the user \nclicks a Refresh Data button.\nTo display its data to the user, the OrderTable  component is used, which is applied \nas an HTML element, like this:\n...\n<OrderTable TableTitle=""Unshipped Orders"" \n    Orders=""UnshippedOrders"" ButtonLabel=""Ship""  \n    OrderSelected=""ShipOrder"" />\n...\nThe values assigned to the OrderTable  element’s attributes are used to set the proper-\nties decorated with the Parameter  attribute in listing 10.10. In this way, a single com-\nponent can be configured to present two different sets of data without the need to \nduplicate code and content. \nThe ShipOrder  and ResetOrder  methods are used as the values for the Order-\nSelected  attributes, which means they are invoked when the user clicks one of the \nbuttons presented by the OrderTable  component, updating the data in the database \nthrough the repository.\nTo see the new features, restart ASP.NET Core, request http://localhost:5000, and \ncreate an order. Once you have at least one order in the database, request http://\nlocalhost:5000/admin/orders, and you will see a summary of the order you created \ndisplayed in the Unshipped Orders table. Click the Ship button, and the order will be \nupdated and moved to the Shipped Orders table, as shown in figure 10.3.\nFigure 10.3    Administering orders",14067
120-10.3 Adding catalog management.pdf,120-10.3 Adding catalog management,,0
121-10.3.3 Creating the list component.pdf,121-10.3.3 Creating the list component,"249 Adding catalog management \n10.3 Adding catalog management \nThe convention for managing more complex collections of items is to present the user \nwith two interfaces: a list interface and an edit interface, as shown in figure 10.4.\nFigure 10.4    Sketch of a CRUD UI for the product catalog\nTogether, these interfaces allow a user to create, read, update, and delete items in the \ncollection. Collectively, these actions are known as CRUD . In this section, I will imple-\nment these interfaces using Blazor.\nTIP    Developers need to implement CRUD so often that Visual Studio scaffold-\ning includes scenarios for creating CRUD controllers or Razor Pages. But, like all \nVisual Studio scaffolding, I think it is better to learn how to create these features \ndirectly, which is why I demonstrate CRUD operations for all the ASP.NET Core \napplication frameworks in later chapters.\n10.3.1  Expanding the repository \nThe first step is to add features to the repository that will allow Product  objects to \nbe created, modified, and deleted. Listing 10.12 adds new methods to the IStore-\nRepository  interface.\nListing 10.12    Adding methods in the IStoreRepository.cs file in the SportsStore/\nModels folder\nnamespace SportsStore.Models {\n    public interface IStoreRepository {\n        IQueryable<Product> Products { get; }\n        void SaveProduct(Product p);\n        void CreateProduct(Product p);\n        void DeleteProduct(Product p);\n    }\n}\nListing 10.13 adds implementations of these methods to the Entity Framework Core \nrepository class.\n250 chapter  10 SportsStore: Administration \nListing 10.13    Implementing methods in the EFStoreRepository.cs file in the \nSportsStore/Models folder\nnamespace SportsStore.Models {\n    public class EFStoreRepository : IStoreRepository {\n        private StoreDbContext context;\n        public EFStoreRepository(StoreDbContext ctx) {\n            context = ctx;\n        }\n        public IQueryable<Product> Products => context.Products;\n        public void CreateProduct(Product p) {\n            context.Add(p);\n            context.SaveChanges();\n        }\n        public void DeleteProduct(Product p) {\n            context.Remove(p);\n            context.SaveChanges();\n        }\n        public void SaveProduct(Product p) {\n            context.SaveChanges();\n        }\n    }\n}\n10.3.2  Applying validation attributes to the data model\nI want to validate the values the user provides when editing or creating Product  \nobjects, just as I did for the customer checkout process. In listing 10.14, I have added \nvalidation attributes to the Product  data model class.\nListing 10.14    Adding validation in the Product.cs file in the SportsStore/Models folder\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.ComponentModel.DataAnnotations;\nnamespace SportsStore.Models {\n    public class Product {\n        public long? ProductID { get; set; }\n        [Required(ErrorMessage = ""Please enter a product name"")]\n        public string Name { get; set; } = String.Empty;\n        [Required(ErrorMessage = ""Please enter a description"")]\n        public string Description { get; set; } = String.Empty;\n        [Required]\n        [Range(0.01, double.MaxValue,\n            ErrorMessage = ""Please enter a positive price"")]\n        [Column(TypeName = ""decimal(8, 2)"")]\n 251 Adding catalog management \n        public decimal Price { get; set; }\n        [Required(ErrorMessage = ""Please specify a category"")]\n        public string Category { get; set; } = String.Empty;\n    }\n}\nBlazor uses the same approach to validation as the rest of ASP.NET Core but, as you \nwill see, applies it in a different way to deal with the more interactive nature of Razor \nComponents.\n10.3.3  Creating the list component \nI am going to start by creating the table that will present the user with a table of prod-\nucts and the links that will allow them to be inspected and edited. Replace the contents \nof the Products.razor  file with those shown in listing 10.15.\nListing 10.15    The revised contents of the Products.razor file in the SportsStore/\nPages/Admin folder\n@page ""/admin/products""\n@page ""/admin""\n@inherits OwningComponentBase<IStoreRepository>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Category</th>\n            <th>Price</th>\n            <td />\n        </tr>\n    </thead>\n    <tbody>\n        @if (ProductData?.Count() > 0) {\n            @foreach (Product p in ProductData) {\n                <tr>\n                    <td>@p.ProductID</td>\n                    <td>@p.Name</td>\n                    <td>@p.Category</td>\n                    <td>@p.Price.ToString(""c"")</td>\n                    <td>\n                        <NavLink class=""btn btn-info btn-sm""\n                         href=""@GetDetailsUrl(p.ProductID ?? 0)"">\n                            Details\n                        </NavLink>\n                        <NavLink class=""btn btn-warning btn-sm""\n                         href=""@GetEditUrl(p.ProductID ?? 0)"">\n                            Edit\n                        </NavLink>\n                    </td>\n                </tr>\n            }\n        } else {\n            <tr>\n                <td colspan=""5"" class=""text-center"">No Products</td>\n252 chapter  10 SportsStore: Administration \n            </tr>\n        }\n    </tbody>\n</table>\n<NavLink class=""btn btn-primary"" href=""/admin/products/create"">\n    Create\n</NavLink>\n@code {\n    public IStoreRepository Repository => Service;\n    public IEnumerable<Product> ProductData { get; set; }\n        = Enumerable.Empty<Product>();\n    protected async override Task OnInitializedAsync() {\n        await UpdateData();\n    }\n    public async Task UpdateData() {\n        ProductData = await Repository.Products.ToListAsync();\n    }\n    public string GetDetailsUrl(long id) => \n        $""/admin/products/details/{id}"";\n    public string GetEditUrl(long id) => \n        $""/admin/products/edit/{id}"";\n}\nThe component presents each Product  object in the repository in a table row with \nNavLink  components that will navigate to the components that will provide a detailed \nview and an editor. There is also a button that navigates to the component that will \nallow new Product  objects to be created and stored in the database. Restart ASP.NET \nCore and request http://localhost:5000/admin/products, and you will see the con-\ntent shown in figure 10.5, although none of the buttons presented by the Products  \ncomponent work currently because I have yet to create the components they target.\nFigure 10.5    \nPresenting a \nlist of products",6786
122-10.3.5 Creating the editor component.pdf,122-10.3.5 Creating the editor component,"253 Adding catalog management \n10.3.4  Creating the detail component \nThe job of the detail component is to display all the fields for a single Product  object. \nAdd a Razor Component named Details.razor  to the Pages/Admin  folder with the \ncontent shown in listing 10.16.\nListing 10.16.    The Details.razor file in the SportsStore/Pages/Admin folder\n@page ""/admin/products/details/{id:long}""\n@inherits OwningComponentBase<IStoreRepository>\n<h3 class=""bg-info text-white text-center p-1"">Details</h3>\n<table class=""table table-sm table-bordered table-striped"">\n    <tbody>\n        <tr><th>ID</th><td>@Product?.ProductID</td></tr>\n        <tr><th>Name</th><td>@Product?.Name</td></tr>\n        <tr><th>Description</th><td>@Product?.Description</td></tr>\n        <tr><th>Category</th><td>@Product?.Category</td></tr>\n        <tr><th>Price</th><td>@Product?.Price.ToString(""C"")</td></tr>\n    </tbody>\n</table>\n<NavLink class=""btn btn-warning"" href=""@EditUrl"">Edit</NavLink>\n<NavLink class=""btn btn-secondary"" href=""/admin/products"">Back</NavLink>\n@code {\n    [Inject]\n    public IStoreRepository? Repository { get; set; }\n    [Parameter]\n    public long Id { get; set; }\n    public Product? Product { get; set; }\n    protected override void OnParametersSet() {\n        Product = \n            Repository?.Products.FirstOrDefault(p => p.ProductID == Id);\n    }\n    public string EditUrl => $""/admin/products/edit/{Product?.ProductID}"";\n}\nThe component uses the Inject  attribute to declare that it requires an implementa-\ntion of the IStoreRepository  interface, which is one of the ways that Blazor provides \naccess to the application’s services. The value of the Id property will be populated from \nthe URL that has been used to navigate to the component, which is used to retrieve \nthe Product  object from the database. To see the detail view, restart ASP.NET Core, \nrequest http://localhost:5000/admin/products, and click one of the Details buttons, \nas shown in figure 10.6.\n254 chapter  10 SportsStore: Administration \nFigure 10.6    Displaying details of a product\n10.3.5  Creating the editor component \nThe operations to create and edit data will be handled by the same component. Add a \nRazor Component named Editor.razor  to the Pages/Admin  folder with the content \nshown in listing 10.17.\nListing 10.17.    The Editor.razor file in the SportsStore/Pages/Admin folder\n@page ""/admin/products/edit/{id:long}""\n@page ""/admin/products/create""\n@inherits OwningComponentBase<IStoreRepository>\n<style>\n    div.validation-message { color: rgb(220, 53, 69); font-weight: 500 }\n</style>\n<h3 class=""bg-@ThemeColor text-white text-center p-1"">\n    @TitleText a Product\n</h3>\n<EditForm Model=""Product"" OnValidSubmit=""SaveProduct"">\n    <DataAnnotationsValidator />\n    @if(Product.ProductID.HasValue && Product.ProductID.Value != 0) {\n        <div class=""form-group"">\n            <label>ID</label>\n            <input class=""form-control"" disabled \n                value=""@Product.ProductID"" />\n        </div>\n    }\n    <div class=""form-group"">\n        <label>Name</label>\n        <ValidationMessage For=""@(() => Product.Name)"" />\n        <InputText class=""form-control"" @bind-Value=""Product.Name"" />\n    </div>\n    <div class=""form-group"">\n 255 Adding catalog management \n        <label>Description</label>\n        <ValidationMessage For=""@(() => Product.Description)"" />\n        <InputText class=""form-control"" \n            @bind-Value=""Product.Description"" />\n    </div>\n    <div class=""form-group"">\n        <label>Category</label>\n        <ValidationMessage For=""@(() => Product.Category)"" />\n        <InputText class=""form-control"" @bind-Value=""Product.Category"" />\n    </div>\n    <div class=""form-group"">\n        <label>Price</label>\n        <ValidationMessage For=""@(() => Product.Price)"" />\n        <InputNumber class=""form-control"" @bind-Value=""Product.Price"" />\n    </div>\n    <div class=""mt-2"">\n        <button type=""submit"" class=""btn btn-@ThemeColor"">Save</button>\n        <NavLink class=""btn btn-secondary"" href=""/admin/products"">\n            Cancel\n        </NavLink>\n    </div>\n</EditForm>\n@code {\n    public IStoreRepository Repository => Service;\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Parameter]\n    public long Id { get; set; } = 0;\n    public Product Product { get; set; } = new Product();\n    protected override void OnParametersSet() {\n        if (Id != 0) {\n            Product = Repository.Products\n                .FirstOrDefault(p => p.ProductID == Id) ?? new();\n        } \n    }\n    public void SaveProduct() {\n        if (Id == 0) {\n            Repository.CreateProduct(Product);\n        } else {\n            Repository.SaveProduct(Product);\n        }\n        NavManager?.NavigateTo(""/admin/products"");\n    }\n    public string ThemeColor => Id == 0 ? ""primary"" : ""warning"";\n    public string TitleText => Id == 0 ? ""Create"" : ""Edit"";\n}\n256 chapter  10 SportsStore: Administration \nBlazor provides a set of built-in Razor Components that are used to display and validate \nforms, which is important because the browser can’t submit data using a POST  request \nin a Blazor Component. The EditForm  component is used to render a Blazor-friendly \nform, and the InputText  and InputNumber  components render input  elements that \naccept string and number values and that automatically update a model property when \nthe user makes a change.\nData validation is integrated into these built-in components, and the OnValid-\nSubmit  attribute on the EditForm  component is used to specify a method that is \ninvoked only if the data entered into the form conforms to the rules defined by the \nvalidation attributes. \nBlazor also provides the NavigationManager  class, which is used to programmat-\nically navigate between components without triggering a new HTTP request. The  \nEditor  component uses NavigationManager , which is obtained as a service, to return \nto the Products  component after the database has been updated.\nTo see the editor, restart ASP.NET Core, request http://localhost:5000/admin, and \nclick the Create button. Click the Save button without filling out the form fields, and \nyou will see the validation errors that Blazor produces automatically, as shown in figure \n10.7. Fill out the form and click Save again, and you will see the product you created \ndisplayed in the table, also as shown in figure 10.7.\nFigure 10.7    Using the Editor component \nClick the Edit button for one of the products, and the same component will be used to \nedit the selected Product  object’s properties. Click the Save button, and any changes \nyou made—if they pass validation—will be stored in the database, as shown in figure \n10.8.",6823
123-10.3.6 Deleting products.pdf,123-10.3.6 Deleting products,"257 Adding catalog management \nFigure 10.8    Editing products\n10.3.6  Deleting products\nThe final CRUD feature is deleting products, which is easily implemented in the  \nProducts  component, as shown in listing 10.18.\nListing 10.18    Adding delete support in the Products.razor file in the SportsStore/\nPages/Admin folder\n@page ""/admin/products""\n@page ""/admin""\n@inherits OwningComponentBase<IStoreRepository>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Category</th>\n            <th>Price</th>\n            <td />\n        </tr>\n    </thead>\n    <tbody>\n        @if (ProductData?.Count() > 0) {\n            @foreach (Product p in ProductData) {\n                <tr>\n                    <td>@p.ProductID</td>\n                    <td>@p.Name</td>\n                    <td>@p.Category</td>\n                    <td>@p.Price.ToString(""c"")</td>\n                    <td>\n                        <NavLink class=""btn btn-info btn-sm""\n                         href=""@GetDetailsUrl(p.ProductID ?? 0)"">\n258 chapter  10 SportsStore: Administration \n                            Details\n                        </NavLink>\n                        <NavLink class=""btn btn-warning btn-sm""\n                         href=""@GetEditUrl(p.ProductID ?? 0)"">\n                            Edit\n                        </NavLink>\n                        <button class=""btn btn-danger btn-sm""\n                                 @onclick=""@(e => DeleteProduct(p))"">\n                            Delete\n                        </button>\n                    </td>\n                </tr>\n            }\n        } else {\n            <tr>\n                <td colspan=""5"" class=""text-center"">No Products</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<NavLink class=""btn btn-primary"" href=""/admin/products/create"">\n    Create\n</NavLink>\n@code {\n    public IStoreRepository Repository => Service;\n    public IEnumerable<Product> ProductData { get; set; }\n        = Enumerable.Empty<Product>();\n    protected async override Task OnInitializedAsync() {\n        await UpdateData();\n    }\n    public async Task UpdateData() {\n        ProductData = await Repository.Products.ToListAsync();\n    }\n    public async Task DeleteProduct(Product p) {\n        Repository.DeleteProduct(p);\n        await UpdateData();\n    }\n    public string GetDetailsUrl(long id) => \n        $""/admin/products/details/{id}"";\n    public string GetEditUrl(long id) => \n        $""/admin/products/edit/{id}"";\n}\nThe new button  element is configured with the @onclick  attribute, which invokes the \nDeleteProduct  method. The selected Product  object is removed from the database, \nand the data displayed by the component is updated. Restart ASP.NET Core, request \nhttp://localhost:5000/admin/products, and click a Delete button to remove an object \nfrom the database, as shown in figure 10.9.",3010
124-11.1 Creating the Identity database.pdf,124-11.1 Creating the Identity database,"259 Summary\nFigure 10.9    Deleting objects from the database\nSummary\n¡ Blazor creates ASP.NET Core applications that use JavaScript to respond to user \ninteraction, handled by C# code running in the ASP.NET Core server.\n¡ Blazor functionality is created using Razor Components, which have a similar \nsyntax to Razor Pages and views.\n¡ Requests are directed to components using the @page  directive.\n¡ The lifecycle of repository objects is aligned the to the component lifecycle using \nthe @inherits OwningComponentBase<T>  expression.\n¡ Blazor provides built-in components for common tasks, such as receiving user \ninput, defining layouts, and navigating between pages.\n26011SportsStore:  \nSecurity and deployment\nThis chapter covers\n¡ Authenticating users with ASP.NET Core Identity \n¡ Authorizing user access to ASP.NET Core   \n resources\n¡ Preparing and publishing an application\n¡ Creating a Docker container image for the   \n SportsStore application\nAuthentication and authorization are provided by the ASP.NET Core Identity sys-\ntem, which integrates neatly into the ASP.NET Core platform and the individual \napplication frameworks. In the sections that follow, I will create a basic security setup \nthat allows one user, called Admin , to authenticate and access the administration fea-\ntures in the application. ASP.NET Core Identity provides many more features for \nauthenticating users and authorizing access to application features and data, and \nyou can find more information in chapters 37 and 38, where I show you how to cre-\nate and manage user accounts and how to perform authorization using roles. But, as \nI noted previously, ASP.NET Core Identity is a large framework in its own right, and \nI cover only the basic features in this book.\nMy goal in this chapter is just to get enough functionality in place to prevent cus-\ntomers from being able to access the sensitive parts of the SportsStore application \nand, in doing so, give you a flavor of how authentication and authorization fit into an \nASP.NET Core application.",2076
125-11.1.1 Installing the Identity package for Entity Framework Core.pdf,125-11.1.1 Installing the Identity package for Entity Framework Core,,0
126-11.1.3 Defining the connection string.pdf,126-11.1.3 Defining the connection string,"261 Creating the Identity database\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from  https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\n11.1 Creating the Identity database\nThe ASP.NET Identity system is endlessly configurable and extensible and supports lots \nof options for how its user data is stored. I am going to use the most common, which \nis to store the data using Microsoft SQL Server accessed using Entity Framework Core. \n11.1.1  Installing the Identity package for Entity Framework Core \nTo add the package that contains the ASP.NET Core Identity support for Entity Frame-\nwork Core, use a PowerShell command prompt to run the command shown in listing \n11.1 in the SportsStore  folder.\nListing 11.1    Installing the Entity Framework Core package\ndotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore  \n    --version 7.0.0\n11.1.2  Creating the context class \nI need to create a database context file that will act as the bridge between the data-\nbase and the Identity model objects it provides access to. I added a class file called \nAppIdentityDbContext.cs  to the Models  folder and used it to define the class shown \nin listing 11.2. \nListing 11.2    The AppIdentityDbContext.cs file in the SportsStore/Models folder\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Identity.EntityFrameworkCore;\nusing Microsoft.EntityFrameworkCore;\nnamespace SportsStore.Models {\n    public class AppIdentityDbContext : IdentityDbContext<IdentityUser> {\n        public AppIdentityDbContext(\n                DbContextOptions<AppIdentityDbContext> options)\n            : base(options) { }\n    }\n}\nThe AppIdentityDbContext  class is derived from IdentityDbContext , which pro-\nvides Identity-specific features for Entity Framework Core. For the type parameter, I \nused the IdentityUser  class, which is the built-in class used to represent users.",2050
127-11.1.4 Configuring the application.pdf,127-11.1.4 Configuring the application,"262 chapter  11 SportsStore: Security and deployment \n11.1.3  Defining the connection string\nThe next step is to define the connection string for the database. Listing 11.3 shows \nthe addition of the connection string to the appsettings.json  file of the SportsStore \nproject, which follows the same format as the connection string that I defined for the \nproduct database. \nListing 11.3    Defining a connection string in the appsettings.json file in the \nSportsStore folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""ConnectionStrings"": {\n    ""SportsStoreConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database= \n‰SportsStore;MultipleActiveResultSets=true"",\n    ""IdentityConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=Identity \n‰;MultipleActiveResultSets=true""\n  }\n}\nRemember that the connection string has to be defined in a single unbroken line \nin the appsettings.json  file and is shown across multiple lines in the listing only \nbecause of the fixed width of a book page. The addition in the listing defines a con-\nnection string called IdentityConnection  that specifies a LocalDB database called \nIdentity .\n11.1.4  Configuring the application \nLike other ASP.NET Core features, Identity is configured in the Program.cs  file. List-\ning 11.4 shows the additions I made to set up Identity in the SportsStore project, using \nthe context class and connection string defined previously.\nListing 11.4    Configuring identity in the Program.cs file in the SportsStore folder\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nusing Microsoft.AspNetCore.Identity;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\n 263 Creating the Identity database\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddScoped<IOrderRepository, EFOrderRepository>();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession();\nbuilder.Services.AddScoped<Cart>(sp => SessionCart.GetCart(sp));\nbuilder.Services.AddSingleton<IHttpContextAccessor, \n    HttpContextAccessor>();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<AppIdentityDbContext>(options =>\n    options.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<AppIdentityDbContext>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.UseAuthentication();\napp.UseAuthorization();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/admin/{*catchall}"", ""/Admin/Index"");\nSeedData.EnsurePopulated(app);\napp.Run();\nIn the listing, I extended the Entity Framework Core configuration to register the con-\ntext class and used the AddIdentity  method to set up the Identity services using the \nbuilt-in classes to represent users and roles. I called the UseAuthentication  and Use-\nAuthorization  methods to set up the middleware components that implement the \nsecurity policy.",3921
128-11.1.5 Creating and applying the database migration.pdf,128-11.1.5 Creating and applying the database migration,,0
129-11.1.6 Defining the seed data.pdf,129-11.1.6 Defining the seed data,"264 chapter  11 SportsStore: Security and deployment \n11.1.5  Creating and applying the database migration\nThe basic configuration is in place, and it is time to use the Entity Framework Core \nmigrations feature to define the schema and apply it to the database. Open a new com-\nmand prompt or PowerShell window and run the command shown in listing 11.5 in \nthe SportsStore  folder to create a new migration for the Identity database.\nListing 11.5    Creating the identity migration \ndotnet ef migrations add Initial --context AppIdentityDbContext \nThe important difference from previous database commands is that I have used the \n-context  argument to specify the name of the context class associated with the data-\nbase that I want to work with, which is AppIdentityDbContext . When you have multi-\nple databases in the application, it is important to ensure that you are working with the \nright context class. \nOnce Entity Framework Core has generated the initial migration, run the command \nshown in listing 11.6 in the SportsStore  folder to create the database and apply the \nmigration.\nListing 11.6    Applying the identity migration  \ndotnet ef database update --context AppIdentityDbContext\nThe result is a new LocalDB database called Identity  that you can inspect using the \nVisual Studio SQL Server Object Explorer.\n11.1.6  Defining the seed data \nI am going to explicitly create the Admin  user by seeding the database when the appli-\ncation starts. I added a class file called IdentitySeedData.cs  to the Models  folder \nand defined the static class shown in listing 11.7. \nListing 11.7    The IdentitySeedData.cs file in the SportsStore/Models folder\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.EntityFrameworkCore;\nnamespace SportsStore.Models {\n    public static class IdentitySeedData {\n        private const string adminUser = ""Admin"";\n        private const string adminPassword = ""Secret123$"";\n        public static async void EnsurePopulated(\n            IApplicationBuilder app) {\n            AppIdentityDbContext context = app.ApplicationServices\n                .CreateScope().ServiceProvider\n                .GetRequiredService<AppIdentityDbContext>();\n            if (context.Database.GetPendingMigrations().Any()) {\n                context.Database.Migrate();\n            }\n 265 Creating the Identity database\n            UserManager<IdentityUser> userManager = \n                app.ApplicationServices\n                .CreateScope().ServiceProvider\n                .GetRequiredService<UserManager<IdentityUser>>();\n            IdentityUser? user = \n                await userManager.FindByNameAsync(adminUser);\n            if (user == null) {\n                user = new IdentityUser(""Admin"");\n                user.Email = ""admin@example.com"";\n                user.PhoneNumber = ""555-1234"";\n                await userManager.CreateAsync(user, adminPassword);\n            }\n        }\n    }\n}\nThis code ensures the database is created and up-to-date and uses the UserManager<T>  \nclass, which is provided as a service by ASP.NET Core Identity for managing users, as \ndescribed in chapter 38. The database is searched for the Admin  user account, which is \ncreated—with a password of Secret123$ —if it is not present. Do not change the hard-\ncoded password in this example because Identity has a validation policy that requires \npasswords to contain a number and range of characters. See chapter 38 for details of \nhow to change the validation settings.\nCAUTION     Hard-coding the details of an administrator account is often required \nso that you can log into an application once it has been deployed and start \nadministering it. When you do this, you must remember to change the password \nfor the account you have created. See chapter 38 for details of how to change \npasswords using Identity. See chapter 15 for how to keep sensitive data, such as \ndefault passwords, out of source code control.\nTo ensure that the Identity database is seeded when the application starts, I added the \nstatement shown in listing 11.8 to the Program.cs  file.\nListing 11.8    Seeding the identity database in the Program.cs file in the SportsStore \nfolder\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddScoped<IOrderRepository, EFOrderRepository>();\n266 chapter  11 SportsStore: Security and deployment \nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession();\nbuilder.Services.AddScoped<Cart>(sp => SessionCart.GetCart(sp));\nbuilder.Services.AddSingleton<IHttpContextAccessor, \n    HttpContextAccessor>();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<AppIdentityDbContext>(options =>\n    options.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<AppIdentityDbContext>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.UseAuthentication();\napp.UseAuthorization();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/admin/{*catchall}"", ""/Admin/Index"");\nSeedData.EnsurePopulated(app);\nIdentitySeedData.EnsurePopulated(app);\napp.Run();\nDeleting and re-creating the ASP .NET Core Identity database\nIf you need to reset the Identity database, then run the following command:\ndotnet ef database drop --force --context AppIdentityDbContext\nRestart the application, and the database will be re-created and populated with seed \ndata.",6542
130-11.4 Creating the account controller and views.pdf,130-11.4 Creating the account controller and views,"267 Adding a conventional administration feature\n11.2 Adding a conventional administration feature\nIn chapter 10, I used Blazor to create the administration features so that I could demon-\nstrate a wide range of ASP.NET Core features in the SportsStore project. Although \nBlazor is useful, it is not suitable for all projects—as I explain in part 4—and most \nprojects are likely to use controllers or Razor Pages for their administration features. I \ndescribe the way that ASP.NET Core Identity works with all the application frameworks \nin chapter 38, but just to provide a balance to the all-Blazor tools created in chapter \n10, I am going to create a Razor Page that will display the list of users in the ASP.NET \nCore Identity database. I describe how to manage the Identity database in more detail \nin chapter 38, and this Razor Page is just to add a sensitive feature to the SportsStore \napplication that isn’t created with Blazor. Add a Razor Page named IdentityUsers \n.cshtml  to the SportsStore/Pages/Admin  folder with the contents shown in listing \n11.9.\nListing 11.9    The IdentityUsers.cshtml file in the SportsStore/Pages/Admin folder\n@page\n@model IdentityUsersModel\n@using Microsoft.AspNetCore.Identity\n<h3 class=""bg-primary text-white text-center p-2"">Admin User</h3>\n<table class=""table table-sm table-striped table-bordered"">\n    <tbody>\n        <tr><th>User</th><td>@Model.AdminUser?.UserName</td></tr>\n        <tr><th>Email</th><td>@Model.AdminUser?.Email</td></tr>\n        <tr><th>Phone</th><td>@Model.AdminUser?.PhoneNumber</td></tr>\n    </tbody>\n</table>\n@functions {\n    public class IdentityUsersModel : PageModel {\n        private UserManager<IdentityUser> userManager;\n        public IdentityUsersModel(UserManager<IdentityUser> mgr) {\n            userManager = mgr;\n        }\n        public IdentityUser? AdminUser { get; set; } = new();\n        public async Task OnGetAsync() {\n            AdminUser = await userManager.FindByNameAsync(""Admin"");\n        }\n    }\n}\nRestart ASP.NET Core and request http://localhost:5000/admin/identityusers to see \nthe content generated by the Razor Page, which is shown in figure 11.1.\n268 chapter  11 SportsStore: Security and deployment \nFigure 11.1    A Razor Page administration feature \n11.3 Applying a basic authorization policy \nNow that I have configured ASP.NET Core Identity, I can apply an authorization pol-\nicy to the parts of the application that I want to protect. I am going to use the most \nbasic authorization policy possible, which is to allow access to any authenticated user. \nAlthough this can be a useful policy in real applications as well, there are also options \nfor creating finer-grained authorization controls, as described in chapters 37 and 38, \nbut since the SportsStore application has only one user, distinguishing between anony-\nmous and authenticated requests is sufficient. \nFor controllers and Razor pages, the Authorize  attribute is used to restrict access, as \nshown in listing 11.10.\nListing 11.10    Restricting access in the IdentityUsers.cshtml file in the SportsStore/\nPages/Admin folder\n@page\n@model IdentityUsersModel\n@using Microsoft.AspNetCore.Identity\n@using Microsoft.AspNetCore.Authorization\n<h3 class=""bg-primary text-white text-center p-2"">Admin User</h3>\n<table class=""table table-sm table-striped table-bordered"">\n    <tbody>\n        <tr><th>User</th><td>@Model.AdminUser?.UserName</td></tr>\n        <tr><th>Email</th><td>@Model.AdminUser?.Email</td></tr>\n        <tr><th>Phone</th><td>@Model.AdminUser?.PhoneNumber</td></tr>\n    </tbody>\n</table>\n@functions {\n    [Authorize]\n    public class IdentityUsersModel : PageModel {\n        private UserManager<IdentityUser> userManager;\n 269 Creating the account controller and views\n        public IdentityUsersModel(UserManager<IdentityUser> mgr) {\n            userManager = mgr;\n        }\n        public IdentityUser? AdminUser { get; set; } = new();\n        public async Task OnGetAsync() {\n            AdminUser = await userManager.FindByNameAsync(""Admin"");\n        }\n    }\n}\nWhen there are only authorized and unauthorized users, the Authorize  attribute can \nbe applied to the Razor Page that acts as the entry point for the Blazor part of the appli-\ncation, as shown in listing 11.11.\nListing 11.11    Applying authorization in the Index.cshtml file in the SportsStore/\nPages/Admin folder\n@page ""/admin""\n@{  Layout = null; }\n@using Microsoft.AspNetCore.Authorization\n@attribute [Authorize]\n<!DOCTYPE html>\n<html>\n<head>\n    <title>SportsStore Admin</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <base href=""/"" />  \n</head>\n<body>    \n    <component type=""typeof(Routed)"" render-mode=""Server"" />\n    <script src=""/_framework/blazor.server.js""></script>\n</body>\n</html>\nSince this Razor Page has been configured without a page model class, I can apply the \nattribute with an @attribute  expression.\n11.4 Creating the account controller and views\nWhen an unauthenticated user sends a request that requires authorization, the user \nis redirected to the /Account/Login  URL, which the application can use to prompt \nthe user for their credentials. In chapters 38 and 39, I show you how to handle authen-\ntication using Razor Pages, so, for variety, I am going to use controllers and views for \nSportsStore. In preparation, I added a view model to represent the user’s credentials \nby adding a class file called LoginModel.cs  to the Models/ViewModels  folder and \nusing it to define the class shown in listing 11.12.\n270 chapter  11 SportsStore: Security and deployment \nListing 11.12    The LoginModel.cs file in the SportsStore/Models/ViewModels folder\nusing System.ComponentModel.DataAnnotations;\nnamespace SportsStore.Models.ViewModels {\n    public class LoginModel {\n        public required string Name { get; set; }\n        public required string Password { get; set; }\n        public string ReturnUrl { get; set; } = ""/"";\n    }\n}\nThe Name  and Password  properties have been decorated with the Required  attribute, \nwhich uses model validation to ensure that values have been provided. Next, I added \na class file called AccountController.cs  to the Controllers  folder and used it to \ndefine the controller shown in listing 11.13. This is the controller that will respond to \nrequests to the /Account/Login  URL.\nListing 11.13    The AccountController.cs file in the SportsStore/Controllers folder\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Mvc;\nusing SportsStore.Models.ViewModels;\nnamespace SportsStore.Controllers {\n    public class AccountController : Controller {\n        private UserManager<IdentityUser> userManager;\n        private SignInManager<IdentityUser> signInManager;\n        public AccountController(UserManager<IdentityUser> userMgr,\n                SignInManager<IdentityUser> signInMgr) {\n            userManager = userMgr;\n            signInManager = signInMgr;\n        }\n        public ViewResult Login(string returnUrl) {\n            return View(new LoginModel {\n                Name = string.Empty, Password = string.Empty,\n                ReturnUrl = returnUrl\n            });\n        }\n        [HttpPost]\n        [ValidateAntiForgeryToken]\n        public async Task<IActionResult> Login(LoginModel loginModel) {\n            if (ModelState.IsValid) {\n                IdentityUser? user =\n                    await userManager.FindByNameAsync(loginModel.Name);\n 271 Creating the account controller and views\n                if (user != null) {\n                    await signInManager.SignOutAsync();\n                    if ((await signInManager.PasswordSignInAsync(user,\n                        loginModel.Password, false, false)).Succeeded) {\n                            return Redirect(loginModel?.ReturnUrl \n                                ?? ""/Admin"");\n                    }\n                }\n                ModelState.AddModelError("""", ""Invalid name or password"");\n            }\n            return View(loginModel);\n        }\n        [Authorize]\n        public async Task<RedirectResult> Logout(string returnUrl = ""/"") {\n            await signInManager.SignOutAsync();\n            return Redirect(returnUrl);\n        }\n    }\n}\nWhen the user is redirected to the /Account/Login  URL, the GET version of the \nLogin  action method renders the default view for the page, providing a view model \nobject that includes the URL to which the browser should be redirected if the authen-\ntication request is successful.\nAuthentication credentials are submitted to the POST version of the Login  method, \nwhich uses the UserManager<IdentityUser>  and SignInManager<IdentityUser>  \nservices that have been received through the controller’s constructor to authenticate \nthe user and log them into the system. I explain how these classes work in chapters 37 \nand 38, but for now, it is enough to know that if there is an authentication failure, then I \ncreate a model validation error and render the default view; however, if authentication \nis successful, then I redirect the user to the URL that they want to access before they are \nprompted for their credentials.\nCAUTION    In general, using client-side data validation is a good idea. It offloads \nsome of the work from your server and gives users immediate feedback about \nthe data they are providing. However, you should not be tempted to perform \nauthentication at the client, as this would typically involve sending valid creden-\ntials to the client so they can be used to check the username and password that \nthe user has entered, or at least trusting the client’s report of whether they have \nsuccessfully authenticated. Authentication should always be done at the server.\nTo provide the Login  method with a view to render, I created the Views/Account  \nfolder and added a Razor View file called Login.cshtml  with the contents shown in \nlisting 11.14.\n272 chapter  11 SportsStore: Security and deployment \nListing 11.14    The Login.cshtml file in the SportsStore/Views/Account folder\n@model LoginModel\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <title>SportsStore</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-dark text-white p-2"">\n        <span class=""navbar-brand ml-2"">SPORTS STORE</span>\n    </div>\n    <div class=""m-1 p-1"">\n        <div class=""text-danger"" asp-validation-summary=""All""></div>\n        <form asp-action=""Login"" asp-controller=""Account"" method=""post"">\n            <input type=""hidden"" asp-for=""ReturnUrl"" />\n            <div class=""form-group"">\n                <label asp-for=""Name""></label>\n                <input asp-for=""Name"" class=""form-control"" />\n            </div>\n            <div class=""form-group"">\n                <label asp-for=""Password""></label>\n                <input asp-for=""Password"" type=""password"" \n                    class=""form-control"" />\n            </div>\n            <button class=""btn btn-primary mt-2"" type=""submit"">\n                Log In\n            </button>\n        </form>\n    </div>\n</body>\n</html>\nThe final step is a change to the shared administration layout to add a button that will \nlog out the current user by sending a request to the Logout  action, as shown in listing \n11.15. This is a useful feature that makes it easier to test the application, without which \nyou would need to clear the browser’s cookies to return to the unauthenticated state. \nListing 11.15    Adding a logout button in the AdminLayout.razor file in the \nSportsStore/Pages/Admin Folder\n@inherits LayoutComponentBase\n<div class=""bg-info text-white p-2"">\n    <div class=""container-fluid"">\n        <div class=""row"">\n            <div class=""col"">\n                <span class=""navbar-brand ml-2"">",12071
131-11.6 Preparing ASP.NET Core for deployment.pdf,131-11.6 Preparing ASP.NET Core for deployment,"273 Testing the security policy \n                    SPORTS STORE Administration\n                </span>\n            </div>\n            <div class=""col-2 text-right"">\n                <a class=""btn btn-sm btn-primary"" href=""/account/logout"">\n                    Log Out\n                </a>\n            </div>\n        </div>\n    </div>\n</div>\n<div class=""container-fluid"">\n    <div class=""row p-2"">\n        <div class=""col-3"">\n            <div class=""d-grid gap-1"">\n                <NavLink class=""btn btn-outline-primary""\n                         href=""/admin/products""\n                         ActiveClass=""btn-primary text-white""\n                         Match=""NavLinkMatch.Prefix"">\n                    Products\n                </NavLink>\n                <NavLink class=""btn btn-outline-primary""\n                         href=""/admin/orders""\n                         ActiveClass=""btn-primary text-white""\n                         Match=""NavLinkMatch.Prefix"">\n                    Orders\n                </NavLink>\n            </div>\n        </div>\n        <div class=""col"">\n            @Body\n        </div>\n    </div>\n</div>\n11.5 Testing the security policy \nEverything is in place, and you can test the security policy by restarting ASP.NET \nCore and requesting http://localhost:5000/admin or http://localhost:5000/admin/\nidentityusers.\nSince you are presently unauthenticated and you are trying to target an action that \nrequires authorization, your browser will be redirected to the /Account/Login  URL. \nEnter Admin  and Secret123$  as the name and password and submit the form. The \nAccount  controller will check the credentials you provided with the seed data added to \nthe Identity database and—assuming you entered the right details—authenticate you \nand redirect you to the URL you requested, to which you now have access. Figure 11.2 \nillustrates the process.",1916
132-11.6.1 Configuring error handling.pdf,132-11.6.1 Configuring error handling,"274 chapter  11 SportsStore: Security and deployment \nFigure 11.2    The administration authentication/authorization process\n11.6 Preparing ASP .NET Core for deployment \nIn this section, I will prepare SportsStore and create a container that can be deployed \ninto production. There is a wide range of deployment models available for ASP.NET \nCore applications, but I have picked Docker containers because they can be run on \nmost hosting platforms or be deployed into a private data center. This is not a com-\nplete guide to deployment, but it will give you a sense of the process to prepare an \napplication.  \n11.6.1  Configuring error handling\nAt the moment, the application is configured to use the developer-friendly error pages, \nwhich provide helpful information when a problem occurs. This is not information \nthat end users should see, so I added a Razor Page named Error.cshtml  to the Pages  \nfolder with the content shown in listing 11.16.\nListing 11.16    The contents of the Error.cshtml file in the Pages folder\n@page ""/error""\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <meta name=""viewport"" content=""width=device-width"" />\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />    \n    <title>Error</title>\n</head>\n<body class=""text-center"">\n    <h2 class=""text-danger"">Error.</h2>\n    <h3 class=""text-danger"">\n        An error occurred while processing your request\n    </h3>\n</body>\n</html>\n 275 Preparing ASP.NET Core for deployment \nThis kind of error page is the last resort, and it is best to keep it as simple as possible \nand not to rely on shared views, view components, or other rich features. In this case, I \nhave disabled shared layouts and defined a simple HTML document that explains that \nthere has been an error, without providing any information about what has happened. \nIn listing 11.17, I have reconfigured the application so that the Error  page is used \nfor unhandled exceptions when the application is in the production environment. I \nhave also set the locale, which is required when deploying to a Docker container. The \nlocale I have chosen is en-US , which represents the language and currency conventions \nof English as it is spoken in the United States.\nListing 11.17    Configuring error handling in the Program.cs file in the SportsStore folder\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.EntityFrameworkCore;\nusing SportsStore.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDbContext<StoreDbContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:SportsStoreConnection""]);\n});\nbuilder.Services.AddScoped<IStoreRepository, EFStoreRepository>();\nbuilder.Services.AddScoped<IOrderRepository, EFOrderRepository>();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession();\nbuilder.Services.AddScoped<Cart>(sp => SessionCart.GetCart(sp));\nbuilder.Services.AddSingleton<IHttpContextAccessor, \n    HttpContextAccessor>();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<AppIdentityDbContext>(options =>\n    options.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<AppIdentityDbContext>();\nvar app = builder.Build();\nif (app.Environment.IsProduction()) {\n    app.UseExceptionHandler(""/error"");\n}\napp.UseRequestLocalization(opts => {\n    opts.AddSupportedCultures(""en-US"")\n    .AddSupportedUICultures(""en-US"")\n    .SetDefaultCulture(""en-US"");\n});",3715
133-11.6.3 Creating the Docker image.pdf,133-11.6.3 Creating the Docker image,"276 chapter  11 SportsStore: Security and deployment \napp.UseStaticFiles();\napp.UseSession();\napp.UseAuthentication();\napp.UseAuthorization();\napp.MapControllerRoute(""catpage"",\n    ""{category}/Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"" });\napp.MapControllerRoute(""page"", ""Page{productPage:int}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""category"", ""{category}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapControllerRoute(""pagination"",\n    ""Products/Page{productPage}"",\n    new { Controller = ""Home"", action = ""Index"", productPage = 1 });\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/admin/{*catchall}"", ""/Admin/Index"");\nSeedData.EnsurePopulated(app);\nIdentitySeedData.EnsurePopulated(app);\napp.Run();\nAs I explain in chapter 12, the IWebHostEnvironment  interface describes the envi-\nronment in which the application is running. The changes mean that the Use-\nExceptionHandler  method is called when the application is in production, but the \ndeveloper-friendly error pages are used otherwise.\n11.6.2  Creating the production configuration settings\nThe JSON configuration files that are used to define settings such as connection \nstrings can be created so they apply only when the application is in a specific environ-\nment, such as development, staging, or production. The template I used to create the \nSportsStore project in chapter 7 created the appsettings.json  and appsettings \n. Development.json  files, which are intended to be the default settings that are over-\nridden with those that are specific for development. I am going to take the reverse \napproach for this chapter and define a file that contains just those settings that are \nspecific to production. Add a JSON file named appsettings.Production.json  to \nthe SportsStore  folder with the content shown in listing 11.18. \nCAUTION    Do not use these connection strings in real projects. You must cor-\nrectly describe the connection to your production database, which is unlikely to \nbe the same as the ones in the listing.\n 277 Preparing ASP.NET Core for deployment \nListing 11.18    The appsettings.Production.json file in the SportsStore folder \n{\n  ""ConnectionStrings"": {\n    ""SportsStoreConnection"": ""Server=sqlserver;Database=SportsStore; \n‰MultipleActiveResultSets=true;User=sa;Password=MyDatabaseSecret123; \n‰Encrypt=False"",\n    ""IdentityConnection"": ""Server=sqlserver;Database=Identity; \n‰MultipleActiveResultSets=true;User=sa;Password=MyDatabaseSecret123; \n‰Encrypt=False""\n  }\n}\nThese connection strings, each of which is defined on a single line, describe connec-\ntions to SQL Server running on sqlserver , which is another Docker container run-\nning SQL Server. For simplicity, I have disabled encryption for the connections to the \ndatabase.\n11.6.3  Creating the Docker image \nIn the sections that follow, I configure and create the Docker image for the application \nthat can be deployed into a container environment such as Microsoft Azure or Amazon \nWeb Services. Bear in mind that containers are only one style of deployment and there \nare many others available if this approach does not suit you.\nNOTE    Bear in mind that I am going to connect to a database running on the \ndevelopment machine, which is not how most real applications are configured. \nBe sure to configure the database connection strings and the container network-\ning settings to match your production environment.\ninstalling  docker  desktop\nGo to https://docker.com  and download and install the Docker Desktop package. Fol-\nlow the installation process, reboot your Windows machine, and run the command \nshown in listing 11.19 to check that Docker has been installed and is in your path. (The \nDocker installation process seems to change often, which is why I have not been more \nspecific about the process.)\nNOTE    You will have to create an account on Docker.com to download the \ninstaller. \nListing 11.19    Checking the Docker Desktop installation \ndocker --version\ncreating  the docker  configuration  files \nDocker is configured using a file named Dockerfile . There is no Visual Studio item \ntemplate for this file, so use the Text File template to add a file named Dockerfile  \n.text  to the project and then rename the file to Dockerfile . If you are using Visual \n278 chapter  11 SportsStore: Security and deployment \nStudio Code, you can just create a file named Dockerfile  without the extension. Use \nthe configuration settings shown in listing 11.20 as the contents for the new file.\nCreating container images without Docker files.\nMicrosoft has introduced features in .NET for creating application images without \nneeding a Dockerfile, with the details of the configuration specified in the CSPROJ file \ninstead. This is an interesting idea, but my view is that the configuration of the image \nis too important to leave to automated tools, and is something that should be under-\nstood by the developer because misconfiguration can impact seriously the performance \nof the application. For this reason, I have created a Dockerfile in this chapter, and this is \nwhat I do in my own projects. You can learn more about this feature at https://devblogs \n. microsoft.com/dotnet/announcing-builtin-container-support-for-the-dotnet-sdk .\nListing 11.20    The contents of the Dockerfile File in the SportsStore folder \nFROM mcr.microsoft.com/dotnet/aspnet:7.0\nCOPY /bin/Release/net7.0/publish/ SportsStore/\nENV ASPNETCORE_ENVIRONMENT Production\nENV Logging__Console__FormatterName=Simple\nEXPOSE 5000\nWORKDIR /SportsStore\nENTRYPOINT [""dotnet"", ""SportsStore.dll"",  ""--urls=http://0.0.0.0:5000""]\nThese instructions copy the SportsStore application into a Docker image and config-\nure its execution. Next, create a file called docker-compose.yml  with the content \nshown in listing 11.21. Visual Studio doesn’t have a template for this type of file, but \nif you select the Text File template and enter the complete file name, it will create the \nfile. Visual Studio Code users can simply create a file named docker-compose.yml .\nNOTE    The configuration file in listing 11.21 is used by Docker Compose, which \ncreates containers and lets them work together. Docker Compose has been \neclipsed by Kubernetes, which has become the most popular choice for deploy-\ning containers into production. Kubernetes is incredibly complex, however, and \nDocker Compose remains a good choice for working with simple applications, \nespecially during development and testing.\nListing 11.21    The contents of the docker-compose.yml file in the SportsStore folder\nversion: ""3""\nservices:\n    sportsstore:\n        build: .\n        ports:\n            - ""5000:5000""\n 279 Preparing ASP.NET Core for deployment \n        environment:\n            - ASPNETCORE_ENVIRONMENT=Production\n        depends_on:\n            - sqlserver\n    sqlserver:\n        image: ""mcr.microsoft.com/mssql/server""\n        environment:\n            SA_PASSWORD: ""MyDatabaseSecret123""\n            ACCEPT_EULA: ""Y""\nThe YML files are especially sensitive to formatting and indentation, and it is important \nto create this file exactly as shown. If you have problems, then use the docker \n-compose.yml  file from the GitHub repository for this book.\npublishing  and imaging  the application  \nPrepare the SportsStore application by using a PowerShell prompt to run the com-\nmand shown listing 11.22 in the SportsStore  folder.\nListing 11.22    Preparing the application\ndotnet publish -c Release\nNext, run the command shown in listing 11.23 to create the Docker image for the \nSportsStore application. This command will take some time to complete the first time \nit is run because it will download the Docker images for ASP.NET Core. \nListing 11.23    Performing the Docker build\ndocker-compose build\nThe first time you run this command, you may be prompted to allow Docker to use the \nnetwork, as shown in figure 11.3. \nFigure 11.3    \nGranting \nnetwork access\nClick the Allow button, return to the PowerShell prompt, use Control+C to terminate \nthe Docker containers, and run the command in listing 11.23 again.",8331
134-Summary.pdf,134-Summary,"280 chapter  11 SportsStore: Security and deployment \n11.6.4  Running the containerized application \nRun the command shown in listing 11.24 in the SportsStore  folder to start the \nDocker containers for SQL Server.\nListing 11.24    Starting the database container\ndocker-compose up sqlserver\nThis command will take some time to complete the first time it is run because it will \ndownload the Docker images for SQL Server. You will see a large amount of output as \nSQL Server starts up. Once the database is running, use a separate command prompt \nto run the command shown in listing 11.25 to start the container for the SportsStore \napplication. \nListing 11.25    Starting the SportsStore container\ndocker-compose up sportsstore\nThe application will be ready when you see output like this:\n...\nsportsstore_1  | info: Microsoft.Hosting.Lifetime[0]\nsportsstore_1  |       Now listening on: http://0.0.0.0:5000\nsportsstore_1  | info: Microsoft.Hosting.Lifetime[0]\nsportsstore_1  |       Application started. Press Ctrl+C to shut down.\nsportsstore_1  | info: Microsoft.Hosting.Lifetime[0]\nsportsstore_1  |       Hosting environment: Production\nsportsstore_1  | info: Microsoft.Hosting.Lifetime[0]\nsportsstore_1  |       Content root path: /SportsStore\n...\nOpen a new browser window and request http://localhost:5000, and you will receive a \nresponse from the containerized version of SportsStore, as shown in figure 11.4, which \nis now ready for deployment. Use Control+C at the PowerShell command prompts to \nterminate the Docker containers.\nFigure 11.4    \nRunning the \nSportsStore \napplication in  \na container\n 281 Summary\nSummary\n¡ ASP.NET Core applications use ASP.NET Core Identity for user authentication \nand have built-in support for enforcing authorization using attributes. \n¡ Applications are published to prepare them for deployment, using the dotnet \npublish  command, specifying the environment name to ensure the correct con-\nfiguration settings are used.\n¡ Applications can be deployed into containers, which can be used on most host-\ning platforms or hosted locally within a data center.",2143
135-Part 2.pdf,135-Part 2,Part 2\nXXXX,12
136-12.1 Preparing for this chapter.pdf,136-12.1 Preparing for this chapter,"28512Understanding the  \nASP.NET Core platform \nThis chapter covers\n¡ Understanding the basic structure of an ASP.  \n NET Core application\n¡ Understanding the HTTP request processing  \n pipeline and middleware components\n¡ Creating custom middleware components\nThe ASP.NET Core platform is the foundation for creating web applications; it pro-\nvides the features that make it possible to use frameworks like MVC and Blazor. In \nthis chapter, I explain how the basic ASP.NET Core features work, describe the pur-\npose of the files in an ASP.NET Core project, and explain how the ASP.NET Core \nrequest pipeline is used to process HTTP requests and demonstrate the different \nways that it can be customized. \nDon’t worry if not everything in this chapter makes immediate sense or appears to \napply to the applications you intend to create. The features I describe in this chapter \nare the underpinnings for everything that ASP.NET Core does, and understanding \nhow they work helps provide a context for understanding the features that you will \nuse daily, as well as giving you the knowledge you need to diagnose problems when \nyou don’t get the behavior you expect. Table 12.1 puts the ASP.NET Core platform \nin context.\n286 chapter  12 Understanding the ASP.NET Core platform  \nTable 12.1    Putting the ASP .NET Core platform in context\nQuestion Answer\nWhat is it? The ASP.NET Core platform is the foundation \non which web applications are built and pro-\nvides features for processing HTTP requests. \nWhy is it useful? The ASP.NET Core platform takes care of the \nlow-level details of web applications so that \ndevelopers can focus on features for the end \nuser. \nHow is it used? The key building blocks are services and \nmiddleware components, both of which can \nbe created using top-level statements in the \nProgram.cs  file. \nAre there any pit-\nfalls or limitations?The use of the Program.cs  file can be con -\nfusing, and close attention must be paid to the \norder of the statements it contains. \nAre there any \nalternatives?The ASP.NET Core platform is required for ASP.\nNET Core applications, but you can choose not \nto work with the platform directly and rely on \njust the higher-level ASP.NET Core features, \nwhich are described in later chapters.\nTable 12.2 provides a guide to the chapter.\nTable 12.2    Chapter guide\nProblem Solution Listing\nCreating a middle-\nware componentCall the Use or UseMiddleware  \nmethod to add a function or class \nto the request pipeline.6–8\nModifying a \nresponseWrite a middleware component \nthat uses the return pipeline path.9\nPreventing other \ncomponents from \nprocessing a \nrequest Short-circuit the request pipeline \nor create terminal middleware.10, \n12–14\nUsing different sets \nof middleware Create a pipeline branch. 11\nConfiguring middle -\nware componentsUse the options pattern. 15–18\n12.1 Preparing for this chapter\nTo prepare for this chapter, I am going to create a new project named Platform, using \nthe template that provides the minimal ASP.NET Core setup. Open a new PowerShell \ncommand prompt from the Windows Start menu and run the commands shown in \nlisting 12.1.\n 287 Preparing for this chapter\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from  https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 12.1    Creating the project\ndotnet new globaljson --sdk-version 7.0.100 --output Platform\ndotnet new web --no-https --output Platform --framework net7.0\ndotnet new sln -o Platform\ndotnet sln Platform add Platform\nIf you are using Visual Studio, open the Platform.sln  file in the Platform  folder. \nIf you are using Visual Studio Code, open the Platform  folder. Click the Yes button \nwhen prompted to add the assets required for building and debugging the project.\nOpen the launchSettings.json  file in the Properties  folder and change the \nports that will be used to handle HTTP requests, as shown in listing 12.2.\nListing 12.2    Setting ports in the launchSettings.json file in the Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""Platform"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}",4877
137-12.1.1 Running the example application.pdf,137-12.1.1 Running the example application,,0
138-12.2 Understanding the ASP.NET Core platform.pdf,138-12.2 Understanding the ASP.NET Core platform,,0
139-12.2.2 Understanding services.pdf,139-12.2.2 Understanding services,"288 chapter  12 Understanding the ASP.NET Core platform  \n12.1.1  Running the example application \nTo start the application, run the command shown in listing 12.3 in the Platform  \nfolder.\nListing 12.3    Starting the example application \ndotnet run\nOpen a new browser window and use it to request http://localhost:5000. You will see \nthe output shown in figure 12.1. \nFigure 12.1    Running the example application \n12.2 Understanding the ASP .NET Core platform\nTo understand ASP.NET Core, it is helpful to focus on just the key features: the request \npipeline, middleware, and services. Understanding how these features fit together—\neven without going into detail—provides useful context for understanding the con-\ntents of the ASP.NET Core project and the shape of the ASP.NET Core platform.  \n12.2.1  Understanding middleware and the request pipeline\nThe purpose of the ASP.NET Core platform is to receive HTTP requests and send \nresponses to them, which ASP.NET Core delegates to middleware components . Middle-\nware components are arranged in a chain, known as the request pipeline . \nWhen a new HTTP request arrives, the ASP.NET Core platform creates an object \nthat describes it and a corresponding object that describes the response that will be sent \nin return. These objects are passed to the first middleware component in the chain, \nwhich inspects the request and modifies the response. The request is then passed to the \nnext middleware component in the chain, with each component inspecting the request \nand adding to the response. Once the request has made its way through the pipeline, \nthe ASP.NET Core platform sends the response, as illustrated in figure 12.2.\nFigure 12.2    The ASP .NET Core request pipeline",1756
140-12.3 Understanding the ASP.NET Core project.pdf,140-12.3 Understanding the ASP.NET Core project,"289 Understanding the ASP.NET Core project\nSome components focus on generating responses for requests, but others are there \nto provide supporting features, such as formatting specific data types or reading and \nwriting cookies. ASP.NET Core includes middleware components that solve common \nproblems, as described in chapters 15 and 16, and I show how to create custom middle-\nware components later in this chapter. If no response is generated by the middleware \ncomponents, then ASP.NET Core will return a response with the HTTP 404 Not Found \nstatus code. \n12.2.2  Understanding services\nServices are objects that provide features in a web application. Any class can be used \nas a service, and there are no restrictions on the features that services provide. What \nmakes services special is that they are managed by ASP.NET Core, and a feature called \ndependency injection  makes it possible to easily access services anywhere in the applica-\ntion, including middleware components.  \nDependency injection can be a difficult topic to understand, and I describe it in \ndetail in chapter 14. For now, it is enough to know that there are objects that are man-\naged by the ASP.NET Core platform that can be shared by middleware components, \neither to coordinate between components or to avoid duplicating common features, \nsuch as logging or loading configuration data, as shown in figure 12.3.\nFigure 12.3    Services in the ASP .NET Core platform\nAs the figure shows, middleware components use only the services they require to do \ntheir work. As you will learn in later chapters, ASP.NET Core provides some basic ser-\nvices that can be supplemented by additional services that are specific to an application. \n12.3 Understanding the ASP .NET Core project\nThe web template produces a project with just enough code and configuration to start \nthe ASP.NET Core runtime with some basic services and middleware components. Fig-\nure 12.4 shows the files added to the project by the template. \n290 chapter  12 Understanding the ASP.NET Core platform  \nFigure 12.4    \nThe files in the \nexample project\nVisual Studio and Visual Studio Code take different approaches to displaying files and \nfolders. Visual Studio hides items that are not commonly used by the developer and \nnests related items together, while Visual Studio Code shows everything. \nThis is why the two project views shown in the figure are different: Visual Studio has \nhidden the bin and obj folders and nested the appsettings.Development.json  file \nwithin the appsettings.json  file. The buttons at the top of the Solution Explorer win-\ndow can be used to prevent nesting and to show all the files in the project.\nAlthough there are few files in the project, they underpin ASP.NET Core develop-\nment and are described in table 12.3.  \nTable 12.3    The files and folders in the Example project \nName Description\nappsettings.json This file is used to configure the application, as described in \nchapter 15.\nappsettings.Development.json This file is used to define configuration settings that are \nspecific to development, as explained in chapter 15.\nbin This folder contains the compiled application files. Visual \nStudio hides this folder.\nglobal.json This file is used to select a specific version of the .NET Core \nSDK. \nProperties/launchSettings.json This file is used to configure the application when it starts. \nobj This folder contains the intermediate output from the \ncompiler. Visual Studio hides this folder.\nPlatform.csproj This file describes the project to the .NET Core tools, \nincluding the package dependencies and build instruc-\ntions, as described in the “Understanding the Project File” \nsection. Visual Studio hides this file, but it can be edited by \nright-clicking the project item in the Solution Explorer and \nselecting Edit Project File from the pop-up menu. \nPlatform.sln This file is used to organize projects. Visual Studio hides this \nfolder.\nProgram.cs This file is the entry point for the ASP.NET Core platform \nand is used to configure the platform, as described in the \n“Understanding the Entry Point” section",4169
141-12.4 Creating custom middleware.pdf,141-12.4 Creating custom middleware,"291 Understanding the ASP.NET Core project\n12.3.1  Understanding the entry point\nThe Program.cs  file contains the code statements that are executed when the applica-\ntion is started and that are used to configure the ASP.NET platform and the individual \nframeworks it supports. Here is the content of the Program.cs  file in the example \nproject:\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nThis file contains only top-level statements. The first statement calls the Web-\nApplication.CreateBuilder  and assigns the result to a variable named builder :\n...\nvar builder = WebApplication.CreateBuilder (args);\n...\nThis method is responsible for setting up the basic features of the ASP.NET Core \nplatform, including creating services responsible for configuration data and logging, \nboth of which are described in chapter 15. This method also sets up the HTTP server, \nnamed Kestrel, that is used to receive HTTP requests.\nThe result from the CreateBuilder  method is a WebApplicationBuilder  object, \nwhich is used to register additional services, although none are defined at present. The \nWebApplicationBuilder  class defines a Build  method that is used to finalize the ini-\ntial setup:\n...\nvar app = builder. Build();\n...\nThe result of the Build  method is a WebApplication  object, which is used to set up \nmiddleware components. The template has set up one middleware component, using \nthe MapGet  extension method:\n...\napp.MapGet(""/"", () => ""Hello World!"");\n...\nMapGet  is an extension method for the IEndpointRouteBuilder  interface, which is \nimplemented by the WebApplication  class, and which sets up a function that will han-\ndle HTTP requests with a specified URL path. In this case, the function responds to \nrequests for the default URL path, which is denoted by /, and the function responds to \nall requests by returning a simple string  response, which is how the output shown in \nfigure 12.1 was produced.\nMost projects need a more sophisticated set of responses, and Microsoft provides \nmiddleware as part of ASP.NET Core that deals with the most common features required \nby web applications, which I describe in chapters 15 and 16. You can also create your \nown middleware, as described in the “Creating Custom Middleware” section, when the \nbuilt-in features don’t suit your requirements.\n292 chapter  12 Understanding the ASP.NET Core platform  \nThe final statement in the Program.cs  file calls the Run method defined by the \nWebApplication  class, which starts listening to HTTP requests.\nEven though the function used with the MapGet  method returns a string, ASP.NET \nCore is clever enough to create a valid HTTP response that will be understood by brows-\ners. While ASP.NET Core is still running, open a new PowerShell command prompt \nand run the command shown in listing 12.4 to send an HTTP request to the ASP.NET \nCore server.\nListing 12.4    Sending an HTTP Request \n(Invoke-WebRequest http://localhost:5000).RawContent \nThe output from this command shows that the response sent by ASP.NET Core con-\ntains an HTTP status code and the set of basic headers, like this:\nHTTP/1.1 200 OK\nTransfer-Encoding: chunked\nContent-Type: text/plain; charset=utf-8\nDate: Wed, 14 Dec 2022 08:09:13 GMT\nServer: Kestrel\n12.3.2  Understanding the project file\nThe Platform.csproj  file, known as the project file , contains the information that \n.NET Core uses to build the project and keep track of dependencies. Here is the con-\ntent that was added to the file by the Empty template when the project was created:\n<Project Sdk=""Microsoft.NET.Sdk.Web"">\n  <PropertyGroup>\n    <TargetFramework>net7.0</TargetFramework>\n    <Nullable>enable</Nullable>\n    <ImplicitUsings>enable</ImplicitUsings>\n  </PropertyGroup>\n</Project>\nThe csproj  file is hidden when using Visual Studio; you can edit it by right-clicking \nthe Platform project item in the Solution Explorer and selecting Edit Project File from \nthe pop-up menu.\nThe project file contains XML elements that describe the project to MSBuild, the \nMicrosoft build engine. MSBuild can be used to create complex build processes and \nis described in detail at https://docs.microsoft.com/en-us/visualstudio/msbuild/\nmsbuild .\nThere is no need to edit the project file directly in most projects. The most common \nchange to the file is to add dependencies on other .NET packages, but these are typi-\ncally added using the command-line tools or the interface provided by Visual Studio.  \nTo add a package to the project using the command line, open a new PowerShell \ncommand prompt, navigate to the Platform  project folder (the one that contains the \ncsproj  file), and run the command shown in listing 12.5.  \n 293 Creating custom middleware \nListing 12.5    Adding a package to the project \ndotnet add package Swashbuckle.AspNetCore --version 6.4.0 \nThis command adds the Swashbuckle.AspNetCore  package to the project. You will \nsee this package used in chapter 20, but for now, it is the effect of the dotnet add \npackage  command that is important. \nThe new dependency will be shown in the Platform.csproj  file:\n<Project Sdk=""Microsoft.NET.Sdk.Web"">\n  <PropertyGroup>\n    <TargetFramework>net7.0</TargetFramework>\n    <Nullable>enable</Nullable>\n    <ImplicitUsings>enable</ImplicitUsings>\n  </PropertyGroup>\n  <ItemGroup>\n    <PackageReference Include=""Swashbuckle.AspNetCore"" Version=""6.4.0"" />\n  </ItemGroup>\n</Project>\n12.4 Creating custom middleware \nAs mentioned, Microsoft provides various middleware components for ASP.NET Core \nthat handle the features most commonly required by web applications. You can also \ncreate your own middleware, which is a useful way to understand how ASP.NET Core \nworks, even if you use only the standard components in your projects. The key method \nfor creating middleware is Use, as shown in listing 12.6.  \nListing 12.6    Creating custom middleware in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.Use(async (context, next) => {\n    if (context.Request.Method == HttpMethods.Get\n            && context.Request.Query[""custom""] == ""true"") {\n        context.Response.ContentType = ""text/plain"";\n        await context.Response.WriteAsync(""Custom Middleware \n"");\n    } \n    await next();\n});\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nThe Use method registers a middleware component that is typically expressed as a \nlambda function that receives each request as it passes through the pipeline (there is \nanother method used for classes, as described in the next section). \n294 chapter  12 Understanding the ASP.NET Core platform  \nThe arguments to the lambda function are an HttpContext  object and a function \nthat is invoked to tell ASP.NET Core to pass the request to the next middleware compo-\nnent in the pipeline.\n The HttpContext  object describes the HTTP request and the HTTP response and \nprovides additional context, including details of the user associated with the request. \nTable 12.4 describes the most useful members provided by the HttpContext  class, \nwhich is defined in the Microsoft.AspNetCore.Http  namespace.  \nTable 12.4    Useful HttpContext members\nName Description\nConnection This property returns a Connection-\nInfo  object that provides information \nabout the network connection underlying \nthe HTTP request, including details of local \nand remote IP addresses and ports.\nRequest This property returns an HttpRequest  \nobject that describes the HTTP request \nbeing processed.\nRequestServices This property provides access to the \nservices available for the request, as \ndescribed in chapter 14.\nResponse This property returns an HttpResponse  \nobject that is used to create a response to \nthe HTTP request.\nSession This property returns the session data \nassociated with the request. The session \ndata feature is described in chapter 16.\nUser This property returns details of the user \nassociated with the request, as described \nin chapters 37 and 38.\nFeatures This property provides access to request \nfeatures, which allow access to the low-\nlevel aspects of request handling. See \nchapter 16 for an example of using a \nrequest feature.\nThe ASP.NET Core platform is responsible for processing the HTTP request to create \nthe HttpRequest  object, which means that middleware and endpoints don’t have to \nworry about the raw request data. Table 12.5 describes the most useful members of the \nHttpRequest  class.  \n 295 Creating custom middleware \nTable 12.5    Useful HttpRequest members\nName Description\nBody This property returns a stream that can be used to read the \nrequest body.\nContentLength This property returns the value of the  Content-Length  header.\nContentType This property returns the value of the Content-Type header.\nCookies This property returns the request cookies.\nForm This property returns a representation of the request body as a \nform.\nHeaders This property returns the request headers.\nIsHttps This property returns true  if the request was made using HTTPS.\nMethod This property returns the HTTP verb—also known as the HTTP \nmethod—used for the request.\nPath This property returns the path section of the request URL.\nQuery This property returns the query string section of the request URL as \nkey-value pairs.\nThe HttpResponse  object describes the HTTP response that will be sent back to the \nclient when the request has made its way through the pipeline. Table 12.6 describes the \nmost useful members of the HttpResponse  class. The ASP.NET Core platform makes \ndealing with responses as easy as possible, sets headers automatically, and makes it easy \nto send content to the client.  \nTable 12.6    Useful HttpResponse members\nName Description\nContentLength This property sets the value of the Content-Length  \nheader.\nContentType This property sets the value of the Content-Type  \nheader.\nCookies This property allows cookies to be associated with the \nresponse.\nHasStarted This property returns true  if ASP.NET Core has \nstarted to send the response headers to the client, \nafter which it is not possible to make changes to the \nstatus code or headers.\nHeaders This property allows the response headers to be set.\nStatusCode This property sets the status code for the response.\nWriteAsync(data) This asynchronous method writes a data string to the \nresponse body. \nRedirect(url) This method sends a redirection response.\n296 chapter  12 Understanding the ASP.NET Core platform  \nWhen creating custom middleware, the HttpContext , HttpRequest , and Http-\nResponse  objects are used directly, but, as you will learn in later chapters, this isn’t \nusually required when using the higher-level ASP.NET Core features such as the MVC \nFramework and Razor Pages. \nThe middleware function I defined in listing 12.6 uses the HttpRequest  object to \ncheck the HTTP method and query string to identify GET requests that have a custom  \nparameter in the query string whose value is true , like this:\n...\nif (context. Request.Method  == HttpMethods.Get\n    && context. Request.Query [""custom""] == ""true"") {\n...\nThe HttpMethods  class defines static strings for each HTTP method. For GET requests \nwith the expected query string, the middleware function uses the ContentType  prop-\nerty to set the Content-Type  header and uses the WriteAsync  method to add a string \nto the body of the response.\n...\ncontext.Response. ContentType  = ""text/plain"";\nawait context.Response. WriteAsync (""Custom Middleware \n"");\n...\nSetting the Content-Type  header is important because it prevents the subsequent \nmiddleware component from trying to set the response status code and headers. ASP.\nNET Core will always try to make sure that a valid HTTP response is sent, and this can \nlead to the response headers or status code being set after an earlier component has \nalready written content to the response body, which produces an exception (because \nthe headers have to be sent to the client before the response body can begin). \nNOTE    In this part of the book, all the examples send simple string results to the \nbrowser. In part 3, I show you how to create web services that return JSON data \nand introduce the different ways that ASP.NET Core can produce HTML results.\nThe second argument to the middleware is the function conventionally named next  \nthat tells ASP.NET Core to pass the request to the next component in the request \npipeline.\n...\nif (context.Request.Method == HttpMethods.Get\n        && context.Request.Query[""custom""] == ""true"") {\n    context.Response.ContentType = ""text/plain"";\n    await context.Response.WriteAsync(""Custom Middleware \n"");\n} \nawait next();\n...\nNo arguments are required when invoking the next middleware component because \nASP.NET Core takes care of providing the component with the HttpContext  object \nand its own next  function so that it can process the request. The next  function is \nasynchronous, which is why the await  keyword is used and why the lambda function is \ndefined with the async  keyword.",13302
142-12.4.1 Defining middleware using a class.pdf,142-12.4.1 Defining middleware using a class,"297 Creating custom middleware \nTIP    You may encounter middleware that calls next.Invoke()  instead of \nnext() . These are equivalent, and next()  is provided as a convenience by the \ncompiler to produce concise code.  \nStart ASP.NET Core using the dotnet run  command and use a browser to request \nhttp://localhost:5000/?custom=true. You will see that the new middleware function \nwrites its message to the response before passing on the request to the next middle-\nware component, as shown in figure 12.5. Remove the query string, or change true  to \nfalse , and the middleware component will pass on the request without adding to the \nresponse.\nFigure 12.5    Creating custom middleware  \n12.4.1  Defining middleware using a class \nDefining middleware using lambda functions is convenient, but it can lead to a long \nand complex series of statements in the Program.cs  file and makes it hard to reuse \nmiddleware in different projects. Middleware can also be defined using classes, which \nkeeps the code outside of the Program.cs  file. To create a middleware class, add a \nclass file named Middleware.cs  to the Platform  folder, with the content shown in \nlisting 12.7.  \nListing 12.7    The contents of the Middleware.cs file in the Platform folder \nnamespace Platform {\n    public class QueryStringMiddleWare {\n        private RequestDelegate next;\n        public QueryStringMiddleWare(RequestDelegate nextDelegate) {\n            next = nextDelegate;\n        }\n        public async Task Invoke(HttpContext context) {\n            if (context.Request.Method == HttpMethods.Get\n                        && context.Request.Query[""custom""] == ""true"") {\n                if (!context.Response.HasStarted) {\n                    context.Response.ContentType = ""text/plain"";\n                }\n298 chapter  12 Understanding the ASP.NET Core platform  \n                await context.Response.WriteAsync(""Class Middleware \n"");\n            }\n            await next(context);\n        }\n    }\n}\nMiddleware classes receive a RequestDelegate  object as a constructor parameter, \nwhich is used to forward the request to the next component in the pipeline. The \nInvoke  method is called by ASP.NET Core when a request is received and is given an \nHttpContext  object that provides access to the request and response, using the same \nclasses that lambda function middleware receives. The RequestDelegate  returns a \nTask , which allows it to work asynchronously.\nOne important difference in class-based middleware is that the HttpContext  object \nmust be used as an argument when invoking the RequestDelegate  to forward the \nrequest, like this:\n...\nawait next( context);\n...\nClass-based middleware components are added to the pipeline with the Use-\nMiddleware  method, which accepts the middleware as a type argument, as shown in \nlisting 12.8.\nListing 12.8    Adding class-based middleware in the Program.cs file in the Platform \nfolder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.Use(async (context, next) => {\n    if (context.Request.Method == HttpMethods.Get\n            && context.Request.Query[""custom""] == ""true"") {\n        context.Response.ContentType = ""text/plain"";\n        await context.Response.WriteAsync(""Custom Middleware \n"");\n    }\n    await next();\n});\napp.UseMiddleware<Platform.QueryStringMiddleWare>();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nWhen the ASP.NET Core is started, the QueryStringMiddleware  class will be instan-\ntiated, and its Invoke  method will be called to process requests as they are received. \nCAUTION     A single middleware object is used to handle all requests, which \nmeans that the code in the Invoke  method must be thread-safe.\nUse the dotnet run  command to start ASP.NET Core and use a browser to request \nhttp://localhost:5000/?custom=true. You will see the output from both middleware \ncomponents, as shown in figure 12.6.",3985
143-12.4.3 Short-Circuiting the request pipeline.pdf,143-12.4.3 Short-Circuiting the request pipeline,"299 Creating custom middleware \nFigure 12.6    Using a class-based middleware component \n12.4.2  Understanding the return pipeline path \nMiddleware components can modify the HTTPResponse  object after the next  function \nhas been called, as shown by the new middleware in listing 12.9.  \nListing 12.9    Adding new middleware in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.Use(async (context, next) => {\n    await next();\n    await context.Response\n        .WriteAsync($""\nStatus Code: { context.Response.StatusCode}"");\n});\napp.Use(async (context, next) => {\n    if (context.Request.Method == HttpMethods.Get\n            && context.Request.Query[""custom""] == ""true"") {\n        context.Response.ContentType = ""text/plain"";\n        await context.Response.WriteAsync(""Custom Middleware \n"");\n    }\n    await next();\n});\napp.UseMiddleware<Platform.QueryStringMiddleWare>();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nThe new middleware immediately calls the next  method to pass the request along the \npipeline and then uses the WriteAsync  method to add a string to the response body. \nThis may seem like an odd approach, but it allows middleware to make changes to the \nresponse before and after it is passed along the request pipeline by defining statements \nbefore and after the next function is invoked, as illustrated by figure 12.7. \n300 chapter  12 Understanding the ASP.NET Core platform  \nFigure 12.7    Passing requests and responses through the ASP .NET Core pipeline \nMiddleware can operate before the request is passed on, after the request has been \nprocessed by other components, or both. The result is that several middleware com-\nponents collectively contribute to the response that is produced, each providing \nsome aspect of the response or providing some feature or data that is used later in the \npipeline. \nStart ASP.NET Core using the dotnet run  command and use a browser to request \nhttp://localhost:5000, which will produce output that includes the content from the \nnew middleware component, as shown in figure 12.8.\nFigure 12.8    Modifying a response in the return path\nNOTE    Middleware components must not change the response status code \nor headers once ASP.NET Core has started to send the response to the client. \nCheck the HasStarted  property, described in table 12.6, to avoid exceptions. \n12.4.3  Short-Circuiting the request pipeline \nComponents that generate complete responses can choose not to call the next  func-\ntion so that the request isn’t passed on. Components that don’t pass on requests are \nsaid to short-circuit  the pipeline, which is what the new middleware component shown \nin listing 12.10 does for requests that target the /short  URL.  \nListing 12.10    Short-Circuiting the pipeline in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.Use(async (context, next) => {\n    await next();\n    await context.Response\n 301 Creating custom middleware \n        .WriteAsync($""\nStatus Code: { context.Response.StatusCode}"");\n});\napp.Use(async (context, next) => {\n    if (context.Request.Path == ""/short"") {\n        await context.Response\n            .WriteAsync($""Request Short Circuited"");\n    } else {\n        await next();\n    }\n});\napp.Use(async (context, next) => {\n    if (context.Request.Method == HttpMethods.Get\n            && context.Request.Query[""custom""] == ""true"") {\n        context.Response.ContentType = ""text/plain"";\n        await context.Response.WriteAsync(""Custom Middleware \n"");\n    }\n    await next();\n});\napp.UseMiddleware<Platform.QueryStringMiddleWare>();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nThe new middleware checks the Path  property of the HttpRequest  object to see \nwhether the request is for the /short  URL; if it is, it calls the WriteAsync  method \nwithout calling the next  function. To see the effect, restart ASP.NET Core and use a \nbrowser to request http://localhost:5000/short?custom=true, which will produce the \noutput shown in figure 12.9. \nFigure 12.9    Short-circuiting the request pipeline\nEven though the URL has the query string parameter that is expected by the next com-\nponent in the pipeline, the request isn’t forwarded, so that subsequent middleware \ndoesn’t get used. Notice, however, that the previous component in the pipeline has \nadded its message to the response. That’s because the short-circuiting only prevents \ncomponents further along the pipeline from being used and doesn’t affect earlier \ncomponents, as illustrated in figure 12.10.",4715
144-12.4.4 Creating pipeline branches.pdf,144-12.4.4 Creating pipeline branches,"302 chapter  12 Understanding the ASP.NET Core platform  \nFigure 12.10    Short-circuiting the request pipeline\n12.4.4  Creating pipeline branches\nThe Map method is used to create a section of pipeline that is used to process requests \nfor specific URLs, creating a separate sequence of middleware components, as shown \nin listing 12.11.  \nListing 12.11    Creating a pipeline branch in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.Map(""/branch"", branch => {\n    branch.UseMiddleware<Platform.QueryStringMiddleWare>();\n    branch.Use(async (HttpContext context, Func<Task> next) => {\n        await context.Response.WriteAsync($""Branch Middleware"");\n    });\n});\napp.UseMiddleware<Platform.QueryStringMiddleWare>();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nThe first argument to the Map method specifies the string that will be used to match \nURLs. The second argument is the branch of the pipeline, to which middleware com-\nponents are added with the Use and UseMiddleware  methods. \nThe statements in listing 12.11 create a branch that is used for URLs that start with  \n/branch  and that pass requests through the QueryStringMiddleware  class defined in \nlisting 12.7 and a middleware lambda expression that adds a message to the response. \nFigure 12.11 shows the effect of the branch on the request pipeline.\n 303 Creating custom middleware \nFigure 12.11    Adding a branch to the request pipeline\nWhen a URL is matched by the Map method, it follows the branch. In this example, the \nfinal component in the middleware branch doesn’t invoke the next delegate, which \nmeans that requests do not pass through the middleware components on the main \npath through the pipeline. \nThe same middleware can be used in different parts of the pipeline, which can be \nseen in listing 12.11, where the QueryStringMiddleWare  class is used in both the main \npart of the pipeline and the branch.\nTo see the different ways that requests are handled, restart ASP.NET Core and use a \nbrowser to request the http://localhost:5000/?custom=true URL, which will be han-\ndled on the main part of the pipeline and will produce the output shown on the left of \nfigure 12.12. Navigate to http://localhost:5000/branch?custom=true, and the request \nwill be forwarded to the middleware in the branch, producing the output shown on the \nright in figure 12.12. \nFigure 12.12    The effect of branching the request pipeline\nBranching wIth a predicate\nASP.NET Core also supports the MapWhen  method, which can match requests using a \npredicate, allowing requests to be selected for a pipeline branch on criteria other than \njust URLs. \nThe arguments to the MapWhen  method are a predicate function that receives an Http-\nContext  and that returns true  for requests that should follow the branch, and a func -\ntion that receives an IApplicationBuilder  object representing the pipeline branch,",2996
145-12.4.5 Creating terminal middleware.pdf,145-12.4.5 Creating terminal middleware,"304 chapter  12 Understanding the ASP.NET Core platform  \n(continued)\nto which middleware is added. Here is an example of using the MapWhen  method to \nbranch the pipeline:\n...\napp.MapWhen(context => context.Request.Query.Keys.Contains(""branch""), \n   branch => {\n        // ...add middleware components here...\n});\n...\n The predicate function returns true  to branch for requests whose query string contains \na parameter named branch . A cast to the IApplicationBuilder  interface is not \nrequired because there only one MapWhen  extension method has been defined.\n12.4.5  Creating terminal middleware \nTerminal middleware never forwards requests to other components and always marks \nthe end of the request pipeline. There is a terminal middleware component in the \nProgram.cs  file, as shown here:  \n...\nbranch.Use(async (context, next) => {\n    await context.Response.WriteAsync($""Branch Middleware"");\n});\n...\nASP.NET Core supports the Run method as a convenience feature for creating termi-\nnal middleware, which makes it obvious that a middleware component won’t forward \nrequests and that a deliberate decision has been made not to call the next  function. In \nlisting 12.12, I have used the Run method for the terminal middleware in the pipeline \nbranch.\nListing 12.12    Using the run method in the Program.cs file in the Platform folder \nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\n((IApplicationBuilder)app).Map(""/branch"", branch => {\n    branch.UseMiddleware<Platform.QueryStringMiddleWare>();\n    branch.Run(async (context) => {\n        await context.Response.WriteAsync($""Branch Middleware"");\n    });\n});\napp.UseMiddleware<Platform.QueryStringMiddleWare>();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\n 305 Creating custom middleware \nThe middleware function passed to the Run method receives only an HttpContext  \nobject and doesn’t have to define a parameter that isn’t used. Behind the scenes, the \nRun method is implemented through the Use method, and this feature is provided \nonly as a convenience.  \nCAUTION     Middleware added to the pipeline after a terminal component will \nnever receive requests. ASP.NET Core won’t warn you if you add a terminal com-\nponent before the end of the pipeline.\nClass-based components can be written so they can be used as both regular and termi-\nnal middleware, as shown in listing 12.13.\nListing 12.13    Adding terminal support in the Middleware.cs file in the Platform folder\nnamespace Platform {\n    public class QueryStringMiddleWare {\n        private RequestDelegate? next;\n        public QueryStringMiddleWare() {\n            // do nothing\n        }\n        public QueryStringMiddleWare(RequestDelegate nextDelegate) {\n            next = nextDelegate;\n        }\n        public async Task Invoke(HttpContext context) {\n            if (context.Request.Method == HttpMethods.Get\n                        && context.Request.Query[""custom""] == ""true"") {\n                if (!context.Response.HasStarted) {\n                    context.Response.ContentType = ""text/plain"";\n                }\n                await context.Response.WriteAsync(""Class Middleware\n"");\n            }\n            if (next != null) {\n                await next(context);\n            }\n        }\n    }\n}\nThe component will forward requests only when the constructor has been provided \nwith a non- null  value for the nextDelegate  parameter. listing 12.14 shows the appli-\ncation of the component in both standard and terminal forms.\nListing 12.14    Applying middleware in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\n((IApplicationBuilder)app).Map(""/branch"", branch => {\n    branch.Run(new Platform.QueryStringMiddleWare().Invoke);",3856
146-12.5 Configuring middleware.pdf,146-12.5 Configuring middleware,"306 chapter  12 Understanding the ASP.NET Core platform  \n});\napp.UseMiddleware<Platform.QueryStringMiddleWare>();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nThere is no equivalent to the UseMiddleware  method for terminal middleware, so \nthe Run method must be used by creating a new instance of the middleware class and \nselecting its Invoke  method. Using the Run method doesn’t alter the output from \nthe middleware, which you can see by restarting ASP.NET Core and navigating to the \nhttp://localhost:5000/branch?custom=true URL, which produces the content shown \nin figure 12.13.\nFigure 12.13.    Using the Run method to create terminal middleware \n12.5 Configuring middleware\nThere is a common pattern for configuring middleware that is known as the options \npattern  and that is used by some of the built-in middleware components described in \nlater chapters. \nThe starting point is to define a class that contains the configuration options for a \nmiddleware component. Add a class file named MessageOptions.cs  to the Platform  \nfolder with the code shown in listing 12.15.  \nListing 12.15    The contents of the MessageOptions.cs file in the Platform folder \nnamespace Platform {\n    public class MessageOptions {\n        public string CityName { get; set; } = ""New York"";\n        public string CountryName{ get; set; } = ""USA"";\n    }\n}\nThe MessageOptions  class defines properties that detail a city and a country. In listing \n12.16, I have used the options pattern to create a custom middleware component that \nrelies on the MessageOptions  class for its configuration. I have also removed some of \nthe middleware from previous examples for brevity.\n 307 Configuring middleware\nListing 12.16    Using the options pattern in the Program.cs file in the Platform folder \nusing Microsoft.Extensions.Options;\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<MessageOptions>(options => {\n    options.CityName = ""Albany"";\n});\nvar app = builder.Build();\napp.MapGet(""/location"", async (HttpContext context,\n    IOptions<MessageOptions> msgOpts) => {\n        Platform.MessageOptions opts = msgOpts.Value;\n        await context.Response.WriteAsync($""{opts.CityName}, "" \n            + opts.CountryName);\n    });\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nThe options are set up using the Services.Configure  method defined by the Web-\nApplicationBuilder  class, using a generic type parameter like this:\n...\nbuilder.Services.Configure<MessageOptions> (options => {\n    options.CityName = ""Albany"";\n});\n...\nThis statement creates options using the MessageOptions  class and changes the value \nof the CityName  property. When the application starts, the ASP.NET Core platform \nwill create a new instance of the MessageOptions  class and pass it to the function sup-\nplied as the argument to the Configure  method, allowing the default option values to \nbe changed. \nThe options will be available as a service, which means this statement must appear \nbefore the call to the Build  method is called, as shown in the listing.\nMiddleware components can access the configuration options by defining a parame-\nter for the function that handles the request, like this:\n...\napp.MapGet(""/location"", async ( HttpContext context,\n    IOptions<MessageOptions> msgOpts ) => {\n        Platform.MessageOptions opts = msgOpts.Value;\n        await context.Response.WriteAsync($""{opts.CityName}, "" \n            + opts.CountryName);\n    });\n...\nSome of the extension methods used to register middleware components will \naccept any function to handle requests. When a request is processed, the ASP.NET",3709
147-12.5.1 Using the options pattern with class-based middleware.pdf,147-12.5.1 Using the options pattern with class-based middleware,"308 chapter  12 Understanding the ASP.NET Core platform  \nCore platform inspects the function to find parameters that require services, which \nallows the middleware component to use the configuration options in the response it \ngenerates:\n...\napp.MapGet(""/location"", async (HttpContext context,\n    IOptions<MessageOptions> msgOpts) => {\n        Platform.MessageOptions opts = msgOpts.Value;\n        await context.Response.WriteAsync($""{opts.CityName}, "" \n            + opts.CountryName);\n    });\n... \nThis is an example of dependency injection, which I describe in detail in chapter 14. \nFor now, however, you can see how the middleware component uses the options pat-\ntern by restarting ASP.NET Core and using a browser to request http://localhost:5000/\nlocation, which will produce the response shown in figure 12.14.\nFigure 12.14    Using the options pattern \n12.5.1  Using the options pattern with class-based middleware \nThe options pattern can also be used with class-based middleware and is applied in a \nsimilar way. Add the statements shown in listing 12.17 to the Middleware.cs  file to \ndefine a class-based middleware component that uses the MessageOptions  class for \nconfiguration.\nListing 12.17    Defining middleware in the Middleware.cs file in the Platform folder\nusing Microsoft.Extensions.Options;\nnamespace Platform {\n    public class QueryStringMiddleWare {\n        private RequestDelegate? next;\n        // ...statements omitted for brevity...\n    }\n    public class LocationMiddleware {\n        private RequestDelegate next;\n        private MessageOptions options;\n        public LocationMiddleware(RequestDelegate nextDelegate,\n 309 Configuring middleware\n                IOptions<MessageOptions> opts) {\n            next = nextDelegate;\n            options = opts.Value;\n        }\n        public async Task Invoke(HttpContext context) {\n            if (context.Request.Path == ""/location"") {\n                await context.Response\n                    .WriteAsync($""{options.CityName}, "" \n                        + options.CountryName);\n            } else {\n                await next(context);\n            }\n        }\n    }\n}\nThe LocationMiddleware  class defines an IOptions<MessageOptions>  constructor \nparameter, which can be used in the Invoke  method to access the options settings.\nListing 12.18 reconfigures the request pipeline to replace the lambda function mid-\ndleware component with the class from listing 12.17.\nListing 12.18    Using class-based middleware in the Program.cs file in the Platform \nfolder\n//using Microsoft.Extensions.Options;\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<MessageOptions>(options => {\n    options.CityName = ""Albany"";\n});\nvar app = builder.Build();\napp.UseMiddleware<LocationMiddleware>();\napp.MapGet(""/"", () => ""Hello World!"");\napp.Run();\nWhen the UseMiddleware  statement is executed, the LocationMiddleware  con-\nstructor is inspected, and its IOptions<MessageOptions>  parameter will be resolved \nusing the object created with the Services.Configure  method. This is done using the \ndependency injection feature that is described in chapter 14, but the immediate effect \nis that the options pattern can be used to easily configure class-based middleware. \nRestart ASP.NET Core and request http://localhost:5000/location to test the new mid-\ndleware, which will produce the same output as shown in figure 12.14.",3506
148-13.1 Preparing for this chapter.pdf,148-13.1 Preparing for this chapter,"310 chapter  12 Understanding the ASP.NET Core platform  \nSummary\n¡ ASP.NET Core uses a pipeline to process HTTP requests. \n¡ Each request is passed to a series of middleware components for processing.\n¡ Once the request has reached the end of the pipeline, the same middleware \ncomponents are able to inspect and modify the response before it is sent.\n¡ Middleware components can choose not to forward requests to the next compo-\nnent in the pipeline, known as “short-circuiting.”\n¡ ASP.NET Core can be configured to use different sequences of middleware com-\nponents to handle different request URLs.\n¡ Middleware is configured using the options pattern, which is a simple and consis-\ntent approach used throughout ASP.NET Core.\n31113Using URL routing\nThis chapter covers\n¡ Understanding how routes can be used to   \n match request URLs\n¡ Structuring URLs patterns to match requests\n¡ Matching requests using routes\nThe URL routing feature makes it easier to generate responses by consolidating the \nprocessing and matching of request URLs. In this chapter, I explain how the ASP \n.NET Core platform supports URL routing, show its use, and explain why it can be \npreferable to creating custom middleware components. Table 13.1 puts URL rout-\ning in context.\nNOTE     This chapter focuses on URL routing for the ASP.NET Core platform. \nSee part 3 for details of how the higher-level parts of ASP.NET Core build on \nthe features described in this chapter.\n312 chapter  13 Using URL routing\nTable 13.1    Putting URL routing in context\nQuestion Answer\nWhat is it? URL routing consolidates the processing and matching of URLs, \nallowing components known as endpoints  to generate responses.\nWhy is it useful? URL routing obviates the need for each middleware component \nto process the URL to see whether the request will be handled or \npassed along the pipeline. The result is more efficient and easier \nto maintain.\nHow is it used? The URL routing middleware components are added to the request \npipeline and configured with a set of routes. Each route contains \na URL path and a delegate that will generate a response when a \nrequest with the matching path is received. \nAre there any pit-\nfalls or limitations?It can be difficult to define the set of routes matching all the URLs \nsupported by a complex application. \nAre there any \nalternatives?URL routing is optional, and custom middleware components can \nbe used instead.\nTable 13.2 provides a guide to the chapter.\nTable 13.2    Chapter guide\nProblem Solution Listing\nHandling requests for a spe -\ncific set of URLsDefine a route with a pattern that \nmatches the required URLs.1–7\nExtracting values from URLs Use segment variables. 8–11, 15\nGenerating URLs Use the link generator to produce URLs \nfrom routes.12–14, 16\nMatching URLs with different \nnumbers of segmentsUse optional segments or catchall seg-\nments in the URL routing pattern.17–19\nRestricting matches Use constraints in the URL routing \npattern. 20–22, \n24–27\nMatching requests that are \nnot otherwise handledDefine fallback routes. 23\nSeeing which endpoint will \nhandle a requestUse the routing context data. 28\n13.1 Preparing for this chapter\nIn this chapter, I continue to use the Platform  project from chapter 12. To prepare \nfor this chapter, add a file called Population.cs  to the Platform  folder with the code \nshown in listing 13.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from  https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\n 313 Preparing for this chapter\nListing 13.1    The contents of the Population.cs file in the Platform folder\nnamespace Platform {\n    public class Population {\n        private RequestDelegate? next;\n        public Population() { }\n        public Population(RequestDelegate nextDelegate) {\n            next = nextDelegate;\n        }\n        public async Task Invoke(HttpContext context) {\n            string[] parts = context.Request.Path.ToString()\n                .Split(""/"", StringSplitOptions.RemoveEmptyEntries);\n            if (parts.Length == 2 && parts[0] == ""population"") {\n                string city = parts[1];\n                int? pop = null;\n                switch (city.ToLower()) {\n                    case ""london"":\n                        pop = 8_136_000;\n                        break;\n                    case ""paris"":\n                        pop = 2_141_000;\n                        break;\n                    case ""monaco"":\n                        pop = 39_000;\n                        break;\n                }\n                if (pop.HasValue) {\n                    await context.Response\n                        .WriteAsync($""City: {city}, Population: {pop}"");\n                    return;\n                }\n            }\n            if (next != null) {\n                await next(context);\n            }\n        }\n    }\n}\nThis middleware component responds to requests for /population/<city>  where \n<city>  is london , paris , or monaco . The middleware component splits up the URL \npath string, checks that it has the expected length, and uses a switch  statement to \ndetermine if it is a request for a URL that it can respond to. A response is generated if \nthe URL matches the pattern the middleware is looking for; otherwise, the request is \npassed along the pipeline. \nAdd a class file named Capital.cs  to the Platform  folder with the code shown in \nlisting 13.2.\n314 chapter  13 Using URL routing\nListing 13.2    The contents of the Capital.cs file in the Platform folder\nnamespace Platform {\n    public class Capital {\n        private RequestDelegate? next;\n        public Capital() { }\n        public Capital(RequestDelegate nextDelegate) {\n            next = nextDelegate;\n        }\n        public async Task Invoke(HttpContext context) {\n            string[] parts = context.Request.Path.ToString()\n                .Split(""/"", StringSplitOptions.RemoveEmptyEntries);\n            if (parts.Length == 2 && parts[0] == ""capital"") {\n                string? capital = null;\n                string country = parts[1];\n                switch (country.ToLower()) {\n                    case ""uk"":\n                        capital = ""London"";\n                        break;\n                    case ""france"":\n                        capital = ""Paris"";\n                        break;\n                    case ""monaco"":\n                        context.Response.Redirect(\n                            $""/population/{country}"");\n                        return;\n                }\n                if (capital != null) {\n                    await context.Response.WriteAsync(\n                        $""{capital} is the capital of {country}"");\n                    return;\n                }\n            }\n            if (next != null) {\n                await next(context);\n            }\n        }\n    }\n}\nThis middleware component is looking for requests for /capital/<country> , where \n<country>  is uk, france , or monaco . The capital cities of the United Kingdom and \nFrance are displayed, but requests for Monaco, which is a city and a state, are redi-\nrected to /population/monaco .\nListing 13.3 replaces the middleware examples from the previous chapter and adds \nthe new middleware components to the request pipeline.",7514
149-13.1.2 Adding the routing middleware and defining an endpoint.pdf,149-13.1.2 Adding the routing middleware and defining an endpoint,"315 Preparing for this chapter\nListing 13.3      Replacing the contents of the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.UseMiddleware<Population>();\napp.UseMiddleware<Capital>();\napp.Run(async (context) => {\n    await context.Response.WriteAsync(""Terminal Middleware Reached"");\n});\napp.Run();\nStart ASP.NET Core by running the command shown in listing 13.4 in the Platform  \nfolder.\nListing 13.4    Starting the ASP .NET Core Runtime \ndotnet run\nNavigate to http://localhost:5000/population/london, and you will see the output on \nthe left side of figure 13.1. Navigate to http://localhost:5000/capital/france  to see the \noutput from the other middleware component, which is shown on the right side of fig-\nure 13.1.\nFigure 13.1    Running the example application  \n13.1.1  Understanding URL routing \nEach middleware component decides whether to act on a request as it passes along the \npipeline. Some components are looking for a specific header or query string value, but \nmost components—especially terminal and short-circuiting components—are trying \nto match URLs. \nEach middleware component has to repeat the same set of steps as the request works \nits way along the pipeline. You can see this in the middleware defined in the previous \nsection, where both components go through the same process: split up the URL, check \nthe number of parts, inspect the first part, and so on.  \nThis approach is far from ideal. It is inefficient because the same set of operations is \nrepeated by each middleware component to process the URL. It is difficult to maintain \nbecause the URL that each component is looking for is hidden in its code. It breaks \neasily because changes must be carefully worked through in multiple places. For \n316 chapter  13 Using URL routing\nexample, the Capital  component redirects requests to a URL whose path starts with \n/population , which is handled by the Population  component. If the Population  \ncomponent is revised to support the /size  URL instead, then this change must also \nbe reflected in the Capital  component. Real applications can support complex sets of \nURLs and working changes fully through individual middleware components can be \ndifficult.\nURL routing solves these problems by introducing middleware that takes care of \nmatching request URLs so that components, called endpoints , can focus on responses. \nThe mapping between endpoints and the URLs they require is expressed in a route. The \nrouting middleware processes the URL, inspects the set of routes, and finds the end-\npoint to handle the request, a process known as routing . \n13.1.2  Adding the routing middleware and defining an endpoint \nThe routing middleware is added using two separate methods: UseRouting  and \nUseEndpoints . The UseRouting  method adds the middleware responsible for pro-\ncessing requests to the pipeline. The UseEndpoints  method is used to define the \nroutes that match URLs to endpoints. URLs are matched using patterns that are com-\npared to the path of request URLs, and each route creates a relationship between one \nURL pattern and one endpoint. Listing 13.5 shows the use of the routing middleware \nand contains a simple route.  \nTIP    I explain why there are two methods for routing in the “Accessing the end-\npoint in a middleware component” section.\nListing 13.5    Using the routing middleware in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.UseMiddleware<Population>();\napp.UseMiddleware<Capital>();\napp.UseRouting();\n#pragma warning disable ASP0014\napp.UseEndpoints(endpoints => {\n    endpoints.MapGet(""routing"", async context => {\n        await context.Response.WriteAsync(""Request Was Routed"");\n    });\n});\napp.Run(async (context) => {\n    await context.Response.WriteAsync(""Terminal Middleware Reached"");\n});\napp.Run();\n 317 Preparing for this chapter\nThere are no arguments to the UseRouting  method. The UseEndpoints  method \nreceives a function that accepts an IEndpointRouteBuilder  object and uses it to cre-\nate routes using the extension methods described in table 13.3. \nThe code in listing 13.5 contains a #pragma  directive that prevents a compiler warn-\ning, which I explain in the next section.\nTIP    There are also extension methods that set up endpoints for other parts of \nASP.NET Core, such as the MVC Framework, as explained in part 3.\nTable 13.3    The IEndpointRouteBuilder extension methods\nName Description\nMapGet(pattern, endpoint) This method routes HTTP GET requests that \nmatch the URL pattern to the endpoint.\nMapPost(pattern, endpoint) This method routes HTTP POST requests that \nmatch the URL pattern to the endpoint.\nMapPut(pattern, endpoint) This method routes HTTP PUT requests that \nmatch the URL pattern to the endpoint.\nMapDelete(pattern, endpoint) This method routes HTTP DELETE requests \nthat match the URL pattern to the endpoint.\nMapMethods(pattern, methods, endpoint) This method routes requests made with one \nof the specified HTTP methods that match the \nURL pattern to the endpoint.\nMap(pattern, endpoint) This method routes all HTTP requests that \nmatch the URL pattern to the endpoint.\nEndpoints are defined using RequestDelegate , which is the same delegate used by \nconventional middleware, so endpoints are asynchronous methods that receive an \nHttpContext  object and use it to generate a response. This means that the features \ndescribed in chapter 12 for middleware components can also be used in endpoints. \nRestart ASP.NET Core and use a browser to request http://localhost:5000/routing \nto test the new route. When matching a request, the routing middleware applies the \nroute’s URL pattern to the path section of the URL. The path is separated from the \nhostname by the / character, as shown in figure 13.2.\nFigure 13.2    The URL path \n318 chapter  13 Using URL routing\nThe path in the URL matches the pattern specified in the route.\n...\nendpoints.MapGet("" routing"", async context => {\n...\nURL patterns are conventionally expressed without a leading / character, which \nisn’t part of the URL path. When the request URL path matches the URL pattern, \nthe request will be forwarded to the endpoint function, which generates the response \nshown in figure 13.3.\nFigure 13.3    Using an endpoint to generate a response\nThe routing middleware short-circuits the pipeline when a route matches a URL so that \nthe response is generated only by the route’s endpoint. The request isn’t forwarded to \nother endpoints or middleware components that appear later in the request pipeline.\nIf the request URL isn’t matched by any route, then the routing middleware passes \nthe request to the next middleware component in the request pipeline. To test this \nbehavior, request the http://localhost:5000/notrouted URL, whose path doesn’t \nmatch the pattern in the route defined in listing 13.5. \nThe routing middleware can’t match the URL path to a route and forwards the \nrequest, which reaches the terminal middleware, producing the response shown in fig-\nure 13.4. \nFigure 13.4    Requesting a URL for which there is no matching route\nEndpoints generate responses in the same way as the middleware components demon-\nstrated in earlier chapters: they receive an HttpContext  object that provides access \nto the request and response through HttpRequest  and HttpResponse  objects. This \nmeans that any middleware component can also be used as an endpoint. Listing 13.6 \nadds a route that uses the Capital  and Population  middleware components as \nendpoints.",7768
150-13.1.3 Simplifying the pipeline configuration.pdf,150-13.1.3 Simplifying the pipeline configuration,"319 Preparing for this chapter\nListing 13.6     Using components as endpoints in the Program.cs file in the Platform \nfolder \nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\n//app.UseMiddleware<Population>();\n//app.UseMiddleware<Capital>();\napp.UseRouting();\n#pragma warning disable ASP0014\napp.UseEndpoints(endpoints => {\n    endpoints.MapGet(""routing"", async context => {\n        await context.Response.WriteAsync(""Request Was Routed"");\n    });\n    endpoints.MapGet(""capital/uk"", new Capital().Invoke);\n    endpoints.MapGet(""population/paris"", new Population().Invoke);\n});\napp.Run(async (context) => {\n    await context.Response.WriteAsync(""Terminal Middleware Reached"");\n});\napp.Run();\nUsing middleware components like this is awkward because I need to create new \ninstances of the classes to select the Invoke  method as the endpoint. The URL pat-\nterns used by the routes support only some of the URLs that the middleware compo-\nnents support, but it is useful to understand that endpoints rely on features that are \nfamiliar from earlier chapters. To test the new routes, restart ASP.NET Core and use a \nbrowser to request http://localhost:5000/capital/uk and http://localhost:5000/pop-\nulation/paris, which will produce the results shown in figure 13.5. \nFigure 13.5    Using middleware components as endpoints\n13.1.3  Simplifying the pipeline configuration \nI demonstrated the use of the UseRouting  and UseEndpoints  method because \nI wanted to emphasize that routing builds on the standard pipeline features and is \nimplemented using regular middleware components.\n320 chapter  13 Using URL routing\nHowever, as part of a drive to simplify the configuration of ASP.NET Core applica-\ntions, Microsoft automatically applies the UseRouting  and UseEndpoints  methods \nto the request pipeline, which means that the methods described in table 13.3 can \nbe used directly on the WebApplication  object returned by the WebApplication \n. CreateBuilder  method, as shown in listing 13.7. \nWhen you call the UseEndpoints  method, the C# code analyzer generates a warning \nthat suggests registering routes at the top level of the Program.cs  file.\nListing 13.7     Simplifying the code in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.UseRouting();\n//#pragma warning disable ASP0014\n//app.UseEndpoints(endpoints => {\n//    endpoints.MapGet(""routing"", async context => {\n//        await context.Response.WriteAsync(""Request Was Routed"");\n//    });\n//    endpoints.MapGet(""capital/uk"", new Capital().Invoke);\n//    endpoints.MapGet(""population/paris"", new Population().Invoke);\n//});\napp.MapGet(""routing"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed"");\n});\napp.MapGet(""capital/uk"", new Capital().Invoke);\napp.MapGet(""population/paris"", new Population().Invoke);\n//app.Run(async (context) => {\n//    await context.Response.WriteAsync(""Terminal Middleware Reached"");\n//});\napp.Run();\nThe WebApplication  class implements the IEndpointRouteBuilder  interface, \nwhich means that endpoints can be created more concisely. Behind the scenes, the \nrouting middleware is still responsible for matching requests and selecting routes.\nRestart ASP.NET Core and use a browser to request http://localhost:5000/capital/\nuk and http://localhost:5000/population/paris, which will produce the results shown \nin figure 13.5. \nAvoiding the direct route registration pitfall \nNotice that I have removed the terminal middleware component from the pipeline. In the \nprevious example, the routing middleware I added to the pipeline explicitly would forward",3771
151-13.1.5 Using segment variables in URL patterns.pdf,151-13.1.5 Using segment variables in URL patterns,"321 Preparing for this chapter\n(continued)\nrequests along the pipeline only if none of the routes matched. Defining routes directly, \nas in listing 13.7, changes this behavior so that requests are always forwarded, which \nmeans the terminal middleware will be used for every request.\nI show you an alternative to the terminal middleware that is part of the URL routing sys-\ntem in the “Defining Fallback Routes” section, but it is important to understand that \nusing the simplified pipeline configuration doesn’t just reduce the amount of code in the  \nProgram.cs  file and can alter the way that requests are processed. \n13.1.4  Understanding URL patterns\nUsing middleware components as endpoints shows that URL routing builds on the \nstandard ASP.NET Core platform features. Although the URLs that the application \nhandles can be seen by examining the routes, not all of the URLs understood by the \nCapital  and Population  classes are routed, and there have been no efficiency gains \nsince the URL is processed once by the routing middleware to select the route and \nagain by the Capital  or Population  class to extract the data values they require.  \nMaking improvements requires understanding more about how URL patterns are \nused. When a request arrives, the routing middleware processes the URL to extract the \nsegments from its path, which are the sections of the path separated by the / character, \nas shown in figure 13.6.\nFigure 13.6    The URL segments\nThe routing middleware also extracts the segments from the URL routing pattern, as \nshown in figure 13.7.\nFigure 13.7    The URL pattern segments\nTo route a request, the segments from the URL pattern are compared to those from \nthe request to see whether they match. The request is routed to the endpoint if its path \ncontains the same number of segments and each segment has the same content as \nthose in the URL pattern, as summarized in table 13.4.\n322 chapter  13 Using URL routing\nTable 13.4    Matching URL segments\nURL Path Description\n/capital No match—too few segments\n/capital/europe/uk No match—too many segments\n/name/uk No match—first segment is not capital\n/capital/uk Matches\n13.1.5  Using segment variables in URL patterns\nThe URL pattern used in listing 13.7 uses literal segments , also known as static segments , \nwhich match requests using fixed strings. The first segment in the pattern will match \nonly those requests whose path has capital  as the first segment, for example, and the \nsecond segment in the pattern will match only those requests whose second segment \nis uk. Put these together, and you can see why the route matches only those requests \nwhose path is /capital/uk .\nSegment variables , also known as route parameters , expand the range of path segments \nthat a pattern segment will match, allowing more flexible routing. Segment variables \nare given a name and are denoted by curly braces (the { and } characters), as shown in \nlisting 13.8.  \nListing 13.8     Using segment variables in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first}/{second}/{third}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/uk"", new Capital().Invoke);\napp.MapGet(""population/paris"", new Population().Invoke);\napp.Run();\nThe URL pattern {first}/{second}/{third}  matches URLs whose path contains \nthree segments, regardless of what those segments contain. When a segment variable \nis used, the routing middleware provides the endpoint with the contents of the URL \npath segment they have matched. This content is available through the HttpRequest \n.RouteValues  property, which returns a RouteValuesDictionary  object. Table 13.5 \ndescribes the most useful RouteValuesDictionary  members.  \n 323 Preparing for this chapter\nTIP    There are reserved words that cannot be used as the names for segment \nvariables: action , area , controller , handler , and page .\nTable 13.5    Useful RouteValuesDictionary members\nName Description\n[key] The class defines an indexer that allows values to be \nretrieved by key.\nKeys This property returns the collection of segment \nvariable names.\nValues This property returns the collection of segment \nvariable values.\nCount This property returns the number of segment \nvariables.\nContainsKey(key) This method returns true  if the route data contains a \nvalue for the specified key.\nThe RouteValuesDictionary  class is enumerable, which means that it can be used in \na foreach  loop to generate a sequence of KeyValuePair<string, object>  objects, \neach of which corresponds to the name of a segment variable and the corresponding \nvalue extracted from the request URL. The endpoint in listing 13.8 enumerates the \nHttpRequest.RouteValues  property to generate a response that lists the names and \nvalues of the segment variables matched by the URL pattern. \nThe names of the segment variables are first , second , and third , and you can see \nthe values extracted from the URL by restarting ASP.NET Core and requesting any \nthree-segment URL, such as http://localhost:5000/apples/oranges/cherries, which \nproduces the response shown in figure 13.8. \nFigure 13.8    Using segment variables\nUnderstanding route selection\nWhen processing a request, the middleware finds all the routes that can match the \nrequest and gives each a score, and the route with the lowest score is selected to handle \nthe route. The scoring process is complex, but the effect is that the most specific route \nreceives the request. This means literal segments are given preference over segment \n324 chapter  13 Using URL routing\n(continued)\nvariables and that segment variables with constraints are given preference over those \nwithout (constraints are described in the “Constraining Segment Matching” section \nlater in this chapter). The scoring system can produce surprising results, and you should \ncheck to make sure that the URLs supported by your application are matched by the \nroutes you expect.  \nIf two routes have the same score, meaning they are equally suited to routing the request, \nthen an exception will be thrown, indicating an ambiguous routing selection. See the \n“Avoiding Ambiguous Route Exceptions” section later in the chapter for details of how to \navoid ambiguous routes.\nrefactoring  middleware  into an endpoint  \nEndpoints usually rely on the routing middleware to provide specific segment vari-\nables, rather than enumerating all the segment variables. By relying on the URL pat-\ntern to provide a specific value, I can refactor the Capital  and Population  classes to \ndepend on the route data, as shown in listing 13.9.\nListing 13.9    Depending on the route data in the Capital.cs file in the Platform folder \nnamespace Platform {\n    public class Capital {\n        public static async Task Endpoint(HttpContext context) {\n            string? capital = null;\n            string? country \n                = context.Request.RouteValues[""country""] as string;\n            switch ((country ?? """").ToLower()) {\n                case ""uk"":\n                    capital = ""London"";\n                    break;\n                case ""france"":\n                    capital = ""Paris"";\n                    break;\n                case ""monaco"":\n                    context.Response.Redirect($""/population/{country}"");\n                    return;\n            }\n            if (capital != null) {\n                await context.Response\n                    .WriteAsync($""{capital} is the capital of {country}"");\n            } else {\n                context.Response.StatusCode \n                    = StatusCodes.Status404NotFound;\n            }\n        }\n    }\n}\nMiddleware components can be used as endpoints, but the opposite isn’t true once \nthere is a dependency on the data provided by the routing middleware. In listing 13.9, \n 325 Preparing for this chapter\nI used the route data to get the value of a segment variable named country  through \nthe indexer defined by the RouteValuesDictionary  class.\n...\nstring country = context.Request.RouteValues[""country""]  as string;\n...\nThe indexer returns an object  value that is cast to a string  using the as keyword. \nThe listing removes the statements that pass the request along the pipeline, which the \nrouting middleware handles on behalf of endpoints. \nThe use of the segment variable means that requests may be routed to the endpoint \nwith values that are not supported, so I added a statement that returns a 404 status code \nfor countries the endpoint doesn’t understand. \nI also removed the constructors and replaced the Invoke  instance method with a \nstatic  method named Endpoint , which better fits with the way that endpoints are \nused in routes. Listing 13.10 applies the same set of changes to the Population  class, \ntransforming it from a standard middleware component into an endpoint that depends \non the routing middleware to process URLs.\nListing 13.10     Depending on route data in the Population.cs file in the Platform folder\nnamespace Platform {\n    public class Population {\n        public static async Task Endpoint(HttpContext context) {\n            string? city = context.Request.RouteValues[""city""] as string;\n            int? pop = null;\n            switch ((city ?? """").ToLower()) {\n                case ""london"":\n                    pop = 8_136_000;\n                    break;\n                case ""paris"":\n                    pop = 2_141_000;\n                    break;\n                case ""monaco"":\n                    pop = 39_000;\n                    break;\n            }\n            if (pop.HasValue) {\n                await context.Response\n                    .WriteAsync($""City: {city}, Population: {pop}"");\n            } else {\n                context.Response.StatusCode \n                    = StatusCodes.Status404NotFound;\n            }\n        }\n    }\n}\nThe change to static methods tidies up the use of the endpoints when defining routes, \nas shown in listing 13.11.",10369
152-13.1.6 Generating URLs from routes.pdf,152-13.1.6 Generating URLs from routes,"326 chapter  13 Using URL routing\nListing 13.11     Updating routes in the Program.cs file in the Platform folder \nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first}/{second}/{third}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country}"", Capital.Endpoint);\napp.MapGet(""population/{city}"", Population.Endpoint);\napp.Run();\nThe new routes match URLs whose path has two segments, the first of which is  \ncapital  or population . The contents of the second segment are assigned to the seg-\nment variables named country  and city , allowing the endpoints to support the full \nset of URLs that were handled at the start of the chapter, without the need to process \nthe URL directly. To test the new routes, restart ASP.NET Core and request http://\nlocalhost:5000/capital/uk and http://localhost:5000/population/london, which will \nproduce the responses shown in figure 13.9.\nFigure 13.9    Using segment variables in endpoints\nThese changes address two of the problems I described at the start of the chapter. \nEfficiency has improved because the URL is processed only once by the routing mid-\ndleware and not by multiple components. And it is easier to see the URLs that each \nendpoint supports because the URL patterns show how requests will be matched.\n13.1.6  Generating URLs from routes\nThe final problem was the difficulty in making changes. The Capital  endpoint still \nhas a hardwired dependency on the URL that the Population  endpoint supports. To \nbreak this dependency, the routing system allows URLs to be generated by supplying \ndata values for segment variables. The first step is to assign a name to the route that will \nbe the target of the URL that is generated, as shown in listing 13.12.  \n 327 Preparing for this chapter\nListing 13.12     Naming a route in the Program.cs file in the Platform folder \nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first}/{second}/{third}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country}"", Capital.Endpoint);\napp.MapGet(""population/{city}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nThe WithMetadata  method is used on the result from the MapGet  method to assign \nmetadata to the route. The only metadata required for generating URLs is a name, \nwhich is assigned by passing a new RouteNameMetadata  object, whose constructor \nargument specifies the name that will be used to refer to the route. The effect of the \nchange in the listing is to assign the route the name population . \nTIP    Naming routes helps to avoid links being generated that target a route \nother than the one you expect, but they can be omitted, in which case the rout-\ning system will try to find the best matching route.\nIn listing 13.13, I have revised the Capital  endpoint to remove the direct dependency \non the /population  URL and rely on the routing features to generate a URL.\nListing 13.13    Generating a URL in the Capital.cs file in the Platform folder\nnamespace Platform {\n    public class Capital {\n        public static async Task Endpoint(HttpContext context) {\n            string? capital = null;\n            string? country \n                = context.Request.RouteValues[""country""] as string;\n            switch ((country ?? """").ToLower()) {\n                case ""uk"":\n                    capital = ""London"";\n                    break;\n                case ""france"":\n                    capital = ""Paris"";\n                    break;\n                case ""monaco"":\n                    LinkGenerator? generator =\n328 chapter  13 Using URL routing\n                      context.RequestServices.GetService<LinkGenerator>();\n                    string? url = generator?.GetPathByRouteValues(context,\n                        ""population"", new { city = country });\n                    if (url != null) {\n                        context.Response.Redirect(url);\n                    }\n                    return;\n            }\n            if (capital != null) {\n                await context.Response\n                    .WriteAsync($""{capital} is the capital of {country}"");\n            } else {\n                context.Response.StatusCode \n                    = StatusCodes.Status404NotFound;\n            }\n        }\n    }\n}\nURLs are generated using the LinkGenerator  class. You can’t just create a new Link-\nGenerator  instance; one must be obtained using the dependency injection feature \nthat is described in chapter 14. For this chapter, it is enough to know that this state-\nment obtains the LinkGenerator  object that the endpoint will use:\n...\nLinkGenerator? generator = \n    context.RequestServices.GetService<LinkGenerator>() ;\n...\nThe LinkGenerator  class provides the GetPathByRouteValues  method, which is \nused to generate the URL that will be used in the redirection.\n...\ngenerator?. GetPathByRouteValues (context,""population"", \n    new { city = country });\n...\nThe arguments to the GetPathByRouteValues  method are the endpoint’s Http-\nContext  object, the name of the route that will be used to generate the link, and an object \nthat is used to provide values for the segment variables. The GetPathByRouteValues  \nmethod returns a URL that will be routed to the Population  endpoint, which can \nbe confirmed by restarting ASP.NET Core and requesting the http://localhost:5000/\ncapital/monaco URL. The request will be routed to the Capital  endpoint, which will \ngenerate the URL and use it to redirect the browser, producing the result shown in \nfigure 13.10.\nFigure 13.10    Generating a URL \n 329 Preparing for this chapter\nThe benefit of this approach is that the URL is generated from the URL pattern in the \nnamed route, which means a change in the URL pattern is reflected in the generated \nURLs, without the need to make changes to endpoints. To demonstrate, listing 13.14 \nchanges the URL pattern.\nListing 13.14    Changing a URL pattern in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first}/{second}/{third}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country}"", Capital.Endpoint);\napp.MapGet(""size/{city}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nThe name assigned to the route is unchanged, which ensures that the same endpoint \nis targeted by the generated URL. To see the effect of the new pattern, restart ASP.NET \nCore and request the http://localhost:5000/capital/monaco URL again. The redirec-\ntion is to a URL that is matched by the modified pattern, as shown in figure 13.11. This \nfeature addresses the final problem that I described at the start of the chapter, making \nit easy to change the URLs that an application supports.\nFigure 13.11    Changing the URL pattern \nURL routing and areas\nThe URL routing system supports a feature called areas , which allows separate sec-\ntions of the application to have their own controllers, views, and Razor Pages. I have not \ndescribed the areas feature in this book because it is not widely used, and when it is \nused, it tends to cause more problems than it solves. If you want to break up an applica-\ntion, then I recommend creating separate projects.",8072
153-13.2 Managing URL matching.pdf,153-13.2 Managing URL matching,,0
154-13.2.2 Using default values for segment variables.pdf,154-13.2.2 Using default values for segment variables,"330 chapter  13 Using URL routing\n13.2 Managing URL matching \nThe previous section introduced the basic URL routing features, but most applications \nrequire more work to ensure that URLs are routed correctly, either to increase or to \nrestrict the range of URLs that are matched by a route. In the sections that follow, I \nshow you the different ways that URL patterns can be adjusted to fine-tune the match-\ning process.\n13.2.1  Matching multiple values from a single URL segment \nMost segment variables correspond directly to a segment in the URL path, but the \nrouting middleware is able to perform more complex matches, allowing a single seg-\nment to be matched to a variable while discarding unwanted characters. Listing 13.15 \ndefines a route that matches only part of a URL segment to a variable.  \nListing 13.15     Matching part of a segment in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""files/{filename}.{ext}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country}"", Capital.Endpoint);\napp.MapGet(""size/{city}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nA URL pattern can contain as many segment variables as you need, as long as they are \nseparated by a static string. The requirement for a static separator is so the routing \nmiddleware knows where the content for one variable ends and the content for the \nnext starts. The pattern in listing 13.15 matches segment variables named filename  \nand ext, which are separated by a period; this pattern is often used by process file \nnames. To see how the pattern matches URLs, restart ASP.NET Core and request the \nhttp://localhost:5000/files/myfile.txt URL, which will produce the response shown in \nfigure 13.12.\n 331 Managing URL matching \nFigure 13.12    Matching multiple values from a single path segment\nAvoiding the complex pattern mismatching pitfall\nThe order of the segment variables in figure 13.12 shows that pattern segments that \ncontain multiple variables are matched from right to left. This isn’t important most of the \ntime, because endpoints can’t rely on a specific key order, but it does show that complex \nURL patterns are handled differently, which reflects the difficulty in matching them. \nIn fact, the matching process is so difficult that there can be unexpected matching fail -\nures. The specific failures change with each release of ASP.NET Core as the matching \nprocess is adjusted to address problems, but the adjustments often introduce new \nissues. At the time of writing, there is a problem with URL patterns where the content that \nshould be matched by the first variable also appears as a literal string at the start of a \nsegment. This is easier to understand with an example, as shown here:\n...\napp.MapGet("" example/red{color} "", async context => {\n...\nThis pattern has a segment that begins with the literal string red, followed by a seg-\nment variable named color . The routing middleware will correctly match the pattern \nagainst the URL path example/redgreen , and the value of the color  route variable \nwill be green . However, the URL path example/redredgreen  won’t match because \nthe matching process confuses the position of the literal content with the first part of the \ncontent that should be assigned to the color  variable. This problem may be fixed by the \ntime you read this book, but there will be other issues with complex patterns. It is a good \nidea to keep URL patterns as simple as possible and make sure you get the matching \nresults you expect.\n13.2.2  Using default values for segment variables\nPatterns can be defined with default values that are used when the URL doesn’t con-\ntain a value for the corresponding segment, increasing the range of URLs that a route \ncan match. Listing 13.16 shows the use of default values in a pattern.  \n332 chapter  13 Using URL routing\nListing 13.16    Using Default Values in the Program.cs File in the Platform Folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""files/{filename}.{ext}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country=France}"", Capital.Endpoint);\napp.MapGet(""size/{city}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nDefault values are defined using an equal sign and the value to be used. The default \nvalue in the listing uses the value France  when there is no second segment in the URL \npath. The result is that the range of URLs that can be matched by the route increases, \nas described in table 13.6.\nTable 13.6    Matching URLs\nURL Path Description\n/ No match—too few segments\n/city No match—first segment isn’t capital\n/capital Matches, country  variable is France\n/capital/uk Matches, country  variable is uk\n/capital/europe/italy No match—too many segments\nTo test the default value, restart ASP.NET Core and navigate to http://localhost:5000/\ncapital, which will produce the result shown in figure 13.13.\nFigure 13.13    Using a default value for a segment variable",5626
155-13.2.4 Using a catchall segment variable.pdf,155-13.2.4 Using a catchall segment variable,"333 Managing URL matching \n13.2.3  Using optional segments in a URL Pattern\nDefault values allow URLs to be matched with fewer segments, but the use of the default \nvalue isn’t obvious to the endpoint. Some endpoints define their own responses to deal \nwith URLs that omit segments, for which optional segments  are used. To prepare, listing \n13.17 updates the Population  endpoint so that it uses a default value when no city  \nvalue is available in the routing data.  \nListing 13.17     Using a default value in the Population.cs file in the Platform folder\nnamespace Platform {\n    public class Population {\n        public static async Task Endpoint(HttpContext context) {\n            string city = context.Request.RouteValues[""city""] \n                as string ?? ""london"";\n            int? pop = null;\n            switch (city.ToLower()) {\n                case ""london"":\n                    pop = 8_136_000;\n                    break;\n                case ""paris"":\n                    pop = 2_141_000;\n                    break;\n                case ""monaco"":\n                    pop = 39_000;\n                    break;\n            }\n            if (pop.HasValue) {\n                await context.Response\n                    .WriteAsync($""City: {city}, Population: {pop}"");\n            } else {\n                context.Response.StatusCode \n                    = StatusCodes.Status404NotFound;\n            }\n        }\n    }\n}\nThe change uses london  as the default value because there is no city  segment vari-\nable available. Listing 13.18 updates the route for the Population  endpoint to make \nthe second segment optional.\nListing 13.18    Using an optional segment in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""files/{filename}.{ext}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n334 chapter  13 Using URL routing\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country=France}"", Capital.Endpoint);\napp.MapGet(""size/{city?}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nOptional segments are denoted with a question mark (the ? character) after the vari-\nable name and allow the route to match URLs that don’t have a corresponding path \nsegment, as described in table 13.7.\nTable 13.7    Matching URLs\nURL Path Description\n/ No match—too few segments.\n/city No match—first segment isn’t size .\n/size Matches. No value for the city  variable is \nprovided to the endpoint.\n/size/paris Matches, city  variable is paris .\n/size/europe/italy No match—too many segments.\nTo test the optional segment, restart ASP.NET Core and navigate to http://  \nlocalhost:5000/size, which will produce the response shown in figure 13.14.\nFigure 13.14    Using an optional segment\n13.2.4  Using a catchall segment variable \nOptional segments allow a pattern to match shorter URL paths. A catchall  segment \ndoes the opposite and allows routes to match URLs that contain more segments than \nthe pattern. A catchall segment is denoted with an asterisk before the variable name, as \nshown in listing 13.19.  \n 335 Managing URL matching \nListing 13.19    Using a catchall segment in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first}/{second}/{*catchall}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country=France}"", Capital.Endpoint);\napp.MapGet(""size/{city?}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nThe new pattern contains two-segment variables and a catchall, and the result is that \nthe route will match any URL whose path contains two or more segments. There is no \nupper limit to the number of segments that the URL pattern in this route will match, \nand the contents of any additional segments are assigned to the segment variable \nnamed catchall . Restart ASP.NET Core and navigate to http://localhost:5000/one/\ntwo/three/four, which produces the response shown in figure 13.15.\nTIP    Notice that the segments captured by the catchall are presented in the form \nsegment /segment /segment  and that the endpoint is responsible for processing the \nstring to break out the individual segments.\nFigure 13.15    Using a catchall segment variable",4808
156-13.2.5 Constraining segment matching.pdf,156-13.2.5 Constraining segment matching,"336 chapter  13 Using URL routing\n13.2.5  Constraining segment matching \nDefault values, optional segments, and catchall segments all increase the range of URLs \nthat a route will match. Constraints have the opposite effect and restrict matches. This \ncan be useful if an endpoint can deal only with specific segment contents or if you want \nto differentiate matching closely related URLs for different endpoints. Constraints are \napplied by a colon (the : character) and a constraint type after a segment variable \nname, as shown in listing 13.20.  \nListing 13.20    Applying constraints in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first:int}/{second:bool}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country=France}"", Capital.Endpoint);\napp.MapGet(""size/{city?}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nThis example constrains the first segment variable so it will match only the path seg-\nments that can be parsed to an int value, and it constrains the second segment so \nit will match only the path segments that can be parsed to a bool . Values that don’t \nmatch the constraints won’t be matched by the route. Table 13.8 describes the URL \npattern constraints.\nNOTE    Some of the constraints match types whose format can differ based on \nlocale. The routing middleware doesn’t handle localized formats and will match \nonly those values that are expressed in the invariant culture format. \n 337 Managing URL matching \nTable 13.8    The URL pattern constraints \nConstraint Description\nalpha This constraint matches the letters a to z (and is \ncase-insensitive).\nbool This constraint matches true  and false  (and is \ncase-insensitive).\ndatetime This constraint matches DateTime  values, expressed in the \nnonlocalized invariant culture format.\ndecimal This constraint matches decimal  values, formatted in the \nnonlocalized invariant culture.\ndouble This constraint matches double values, formatted in the \nnonlocalized invariant culture.\nfile This constraint matches segments whose content represents \na file name, in the form name.ext . The existence of the file is \nnot validated.\nfloat This constraint matches float values, formatted in the nonlo-\ncalized invariant culture.\nguid This constraint matches GUID values.\nint This constraint matches int values.\nlength(len) This constraint matches path segments that have the speci-\nfied number of characters.\nlength(min, max) This constraint matches path segments whose length falls \nbetween the lower and upper values specified.\nlong This constraint matches long values.\nmax(val) This constraint matches path segments that can be parsed to \nan int value that is less than or equal to the specified value. \nmaxlength(len) This constraint matches path segments whose length is equal \nto or less than the specified value.\nmin(val) This constraint matches path segments that can be parsed to \nan int value that is more than or equal to the specified value.\nminlength(len) This constraint matches path segments whose length is equal \nto or more than the specified value.\nnonfile This constraint matches segments that do not represent a \nfile name, i.e., values that would not be matched by the file \nconstraint.\nrange(min, max) This constraint matches path segments that can be parsed to \nan int value that falls between the inclusive range specified. \nregex(expression) This constraint applies a regular expression to match path \nsegments.\nTo test the constraints, restart ASP.NET Core and request http://localhost:5000/100/\ntrue, which is a URL whose path segments conform to the constraints in listing 13.20 \nand that produces the result shown on the left side of figure 13.16. Request http://\nlocalhost:5000/apples/oranges, which has the right number of segments but contains \nvalues that don’t conform to the constraints. None of the routes matches the request, \nwhich is forwarded to the terminal middleware, as shown on the right of figure 13.16.\n338 chapter  13 Using URL routing\nFigure 13.16    Testing constraints  \nConstraints can be combined to further restrict matching, as shown in listing 13.21.  \nListing 13.21    Combining URL pattern constraints in the Program.cs file in the \nPlatform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first:alpha:length(3)}/{second:bool}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country=France}"", Capital.Endpoint);\napp.MapGet(""size/{city?}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nThe constraints are combined, and only path segments that can satisfy all the con-\nstraints will be matched. The combination in listing 13.21 constrains the URL pattern \nso that the first segment will match only three alphabetic characters. To test the pat-\ntern, restart ASP.NET Core and request http://localhost:5000/dog/true, which will \nproduce the output shown in figure 13.17. Requesting the URL http://localhost:5000/\ndogs/true won’t match the route because the first segment contains four characters.\nFigure 13.17    \nCombining \nconstraints\n 339 Managing URL matching \nconstraining  matching  to a specific  set of values  \nThe regex  constraint applies a regular expression, which provides the basis for one of \nthe most commonly required restrictions: matching only a specific set of values. In list-\ning 13.22, I have applied the regex constraint to the routes for the Capital endpoint, \nso it will receive requests only for the values it can process.  \nListing 13.22     Matching specific values in the Program.cs file in the Platform folder \nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first:alpha:length(3)}/{second:bool}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country:regex(^uk|france|monaco$)}"", \n    Capital.Endpoint);\napp.MapGet(""size/{city?}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.Run();\nThe route will match only those URLs with two segments. The first segment must be \ncapital , and the second segment must be uk, france , or monaco . Regular expres-\nsions are case-insensitive, which you can confirm by restarting ASP.NET Core and \nrequesting http://localhost:5000/capital/UK, which will produce the result shown in \nfigure 13.18.\nTIP    You may find that your browser requests /capital/uk , with a lowercase uk. \nIf this happens, clear your browser history, and try again.\nFigure 13.18.    Matching specific values with a regular expression",7398
157-13.3 Advanced routing features.pdf,157-13.3 Advanced routing features,"340 chapter  13 Using URL routing\n13.2.6  Defining fallback routes\nFallback routes direct a request to an endpoint only when no other route matches a \nrequest. Fallback routes prevent requests from being passed further along the request \npipeline by ensuring that the routing system will always generate a response, as shown \nin listing 13.23.  \nListing 13.23     Using a fallback route in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""{first:alpha:length(3)}/{second:bool}"", async context => {\n    await context.Response.WriteAsync(""Request Was Routed\n"");\n    foreach (var kvp in context.Request.RouteValues) {\n        await context.Response\n            .WriteAsync($""{kvp.Key}: {kvp.Value}\n"");\n    }\n});\napp.MapGet(""capital/{country:regex(^uk|france|monaco$)}"", \n    Capital.Endpoint);\napp.MapGet(""size/{city?}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.MapFallback(async context => {\n    await context.Response.WriteAsync(""Routed to fallback endpoint"");\n});\napp.Run();\nThe MapFallback  method creates a route that will be used as a last resort and that \nwill match any request. Table 13.9 describes the methods for creating fallback routes. \n(There are also methods for creating fallback routes that are specific to other parts of \nASP.NET Core and that are described in part 3.)\nTable 13.9.    The methods for creating fallback routes\nName Description\nMapFallback(endpoint) This method creates a fallback that routes \nrequests to an endpoint.\nMapFallbackToFile(path) This method creates a fallback that routes \nrequests to a file.\nWith the addition of the route in listing 13.23, the routing middleware will handle all \nrequests, including those that match none of the regular routes. Restart ASP.NET Core \nand navigate to a URL that won’t be matched by any of the routes, such as http://  \nlocalhost:5000/notmatched, and you will see the response shown in figure 13.19.",2056
158-13.3.2 Avoiding ambiguous route exceptions.pdf,158-13.3.2 Avoiding ambiguous route exceptions,"341 Advanced routing features \nFigure 13.19.    Using a fallback route \n13.3 Advanced routing features \nThe routing features described in the previous sections address the needs of most proj-\nects, especially since they are usually accessed through higher-level features such as the \nMVC Framework, described in part 3. There are some advanced features for projects \nthat have unusual routing requirements, which I describe in the following sections.\n13.3.1  Creating custom constraints\nIf the constraints described in table 13.8 are not sufficient, you can define your own \ncustom constraints by implementing the IRouteConstraint  interface. To create a \ncustom constraint, add a file named CountryRouteConstraint.cs  to the Platform  \nfolder and add the code shown in listing 13.24.  \nListing 13.24    The contents of the CountryRouteConstraint.cs file in the Platform folder \nnamespace Platform {\n    public class CountryRouteConstraint : IRouteConstraint {\n        private static string[] countries = { ""uk"", ""france"", ""monaco"" };\n        public bool Match(HttpContext? httpContext, IRouter? route, \n                string routeKey, RouteValueDictionary values, \n                RouteDirection routeDirection) {\n            string segmentValue = values[routeKey] as string ?? """";\n            return Array.IndexOf(countries, segmentValue.ToLower()) > -1;\n        }\n    }\n}\nThe IRouteConstraint  interface defines the Match  method, which is called to allow \na constraint to decide whether a request should be matched by the route. The parame-\nters for the Match  method provide the HttpContext  object for the request, the route, \nthe name of the segment, the segment variables extracted from the URL, and whether \nthe request is to check for an incoming or outgoing URL. The Match  method returns \ntrue  if the constraint is satisfied by the request and false  if it is not. The constraint in \nlisting 13.24 defines a set of countries that are compared to the value of the segment \nvariable to which the constraint has been applied. The constraint is satisfied if the seg-\nment matches one of the countries. Custom constraints are set up using the options \npattern, as shown in listing 13.25. (The options pattern is described in chapter 12.)\n342 chapter  13 Using URL routing\nListing 13.25    Using a custom constraint in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<RouteOptions>(opts => {\n    opts.ConstraintMap.Add(""countryName"",\n        typeof(CountryRouteConstraint));\n});\nvar app = builder.Build();\napp.MapGet(""capital/{country:countryName}"", Capital.Endpoint);\napp.MapGet(""capital/{country:regex(^uk|france|monaco$)}"", \n    Capital.Endpoint);\napp.MapGet(""size/{city?}"", Population.Endpoint)\n    .WithMetadata(new RouteNameMetadata(""population""));\napp.MapFallback(async context => {\n    await context.Response.WriteAsync(""Routed to fallback endpoint"");\n});\napp.Run();\nThe options pattern is applied to the RouteOptions  class, which defines the  \nConstraintMap  property. Each constraint is registered with a key that allows it to be \napplied in URL patterns. In listing 13.25, the key for the CountryRouteConstraint  \nclass is countryName , which allows me to constrain a route like this:\n...\nendpoints.MapGet(""capital/{ country:countryName }"", Capital.Endpoint);\n...\nRequests will be matched by this route only when the first segment of the URL is  \ncapital  and the second segment is one of the countries defined in listing 13.24.\n13.3.2  Avoiding ambiguous route exceptions\nWhen trying to route a request, the routing middleware assigns each route a score. \nAs explained earlier in the chapter, precedence is given to more specific routes, and \nroute selection is usually a straightforward process that behaves predictably, albeit with \nthe occasional surprise if you don’t think through and test the full range of URLs the \napplication will support.  \nIf two routes have the same score, the routing system can’t choose between them and \nthrows an exception, indicating that the routes are ambiguous. In most cases, the best \napproach is to modify the ambiguous routes to increase specificity by introducing literal \nsegments or a constraint. There are some situations where that won’t be possible, and \nsome extra work is required to get the routing system to work as intended. Listing 13.26 \nreplaces the routes from the previous example with two new routes that are ambiguous, \nbut only for some requests.\n 343 Advanced routing features \nListing 13.26    Defining ambiguous routes in the Program.cs file in the Platform folder \nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<RouteOptions>(opts => {\n    opts.ConstraintMap.Add(""countryName"",\n        typeof(CountryRouteConstraint));\n});\nvar app = builder.Build();\napp.Map(""{number:int}"", async context => {\n    await context.Response.WriteAsync(""Routed to the int endpoint"");\n});\napp.Map(""{number:double}"", async context => {\n    await context.Response\n        .WriteAsync(""Routed to the double endpoint"");\n});\napp.MapFallback(async context => {\n    await context.Response.WriteAsync(""Routed to fallback endpoint"");\n});\napp.Run();\nThese routes are ambiguous only for some values. Only one route matches URLs where \nthe first path segment can be parsed to a double, but both routes match for where \nthe segment can be parsed as an int or a double . To see the issue, restart ASP.NET \nCore and request http://localhost:5000/23.5. The path segment 23.5  can be parsed \nto a double  and produces the response shown on the left side of figure 13.20. Request \nhttp://localhost:5000/23, and you will see the exception shown on the right of figure \n13.20. The segment 23 can be parsed as both an int and a double , which means that \nthe routing system cannot identify a single route to handle the request.\nFigure 13.20    An occasionally ambiguous routing configuration  \nFor these situations, preference can be given to a route by defining its order relative to \nother matching routes, as shown in listing 13.27.",6213
159-13.3.3 Accessing the endpoint in a middleware component.pdf,159-13.3.3 Accessing the endpoint in a middleware component,"344 chapter  13 Using URL routing\nListing 13.27    Breaking route ambiguity in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<RouteOptions>(opts => {\n    opts.ConstraintMap.Add(""countryName"",\n        typeof(CountryRouteConstraint));\n});\nvar app = builder.Build();\napp.Map(""{number:int}"", async context => {\n    await context.Response.WriteAsync(""Routed to the int endpoint"");\n}).Add(b => ((RouteEndpointBuilder)b).Order = 1);\napp.Map(""{number:double}"", async context => {\n    await context.Response\n        .WriteAsync(""Routed to the double endpoint"");\n}).Add(b => ((RouteEndpointBuilder)b).Order = 2);\napp.MapFallback(async context => {\n    await context.Response.WriteAsync(""Routed to fallback endpoint"");\n});\napp.Run();\nThe process is awkward and requires a call to the Add method, casting to a Route-\nEndpointBuilder  and setting the value of the Order  property. Precedence is given to \nthe route with the lowest Order  value, which means that these changes tell the routing \nsystem to use the first route for URLs that both routes can handle. Restart ASP.NET \nCore and request the http://localhost:5000/23 URL again, and you will see that the \nfirst route handles the request, as shown in figure 13.21.\nFigure 13.21    Avoiding ambiguous routes\n13.3.3  Accessing the endpoint in a middleware component \nAs earlier chapters demonstrated, not all middleware generates responses. Some com-\nponents provide features used later in the request pipeline, such as the session middle-\nware, or enhance the response in some way, such as status code middleware.\n 345 Advanced routing features \nOne limitation of the normal request pipeline is that a middleware component at the \nstart of the pipeline can’t tell which of the later components will generate a response. \nThe routing middleware does something different.\nAs I demonstrated at the start of the chapter, routing is set up by calling the Use-\nRouting  and UseEndpoints  methods, either explicitly or relying on the ASP.NET Core \nplatform to call them during startup. \nAlthough routes are registered in the UseEndpoints  method, the selection of a \nroute is done in the UseRouting  method, and the endpoint is executed to generate a \nresponse in the UseEndpoints  method. Any middleware component that is added to \nthe request pipeline between the UseRouting  method and the UseEndpoints  method \ncan see which endpoint has been selected before the response is generated and alter its \nbehavior accordingly.\nIn listing 13.28, I have added a middleware component that adds different messages \nto the response based on the route that has been selected to handle the request.  \nListing 13.28    Adding a middleware component in the Program.cs file in the Platform \nfolder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<RouteOptions>(opts => {\n    opts.ConstraintMap.Add(""countryName"",\n        typeof(CountryRouteConstraint));\n});\nvar app = builder.Build();\napp.Use(async (context, next) => {\n    Endpoint? end = context.GetEndpoint();\n    if (end != null) {\n        await context.Response\n            .WriteAsync($""{end.DisplayName} Selected \n"");\n    } else {\n        await context.Response.WriteAsync(""No Endpoint Selected \n"");\n    }\n    await next();\n});\napp.Map(""{number:int}"", async context => {\n    await context.Response.WriteAsync(""Routed to the int endpoint"");\n}).WithDisplayName(""Int Endpoint"")\n    .Add(b => ((RouteEndpointBuilder)b).Order = 1);\napp.Map(""{number:double}"", async context => {\n    await context.Response\n        .WriteAsync(""Routed to the double endpoint"");\n}).WithDisplayName(""Double Endpoint"")\n    .Add(b => ((RouteEndpointBuilder)b).Order = 2);\n346 chapter  13 Using URL routing\napp.MapFallback(async context => {\n    await context.Response.WriteAsync(""Routed to fallback endpoint"");\n});\napp.Run();\nThe GetEndpoint  extension method on the HttpContext  class returns the endpoint \nthat has been selected to handle the request, described through an Endpoint  object. \nThe Endpoint  class defines the properties described in table 13.10.  \nCAUTION     There is also a SetEndpoint  method that allows the endpoint chosen \nby the routing middleware to be changed before the response is generated. This \nshould be used with caution and only when there is a compelling need to inter-\nfere with the normal route selection process.\nTable 13.10    The properties defined by the Endpoint class\nName Description\nDisplayName This property returns the display name asso-\nciated with the endpoint, which can be set \nusing the WithDisplayName  method when \ncreating a route.\nMetadata This property returns the collection of meta-\ndata associated with the endpoint. \nRequestDelegate This property returns the delegate that will be \nused to generate the response.\nTo make it easier to identify the endpoint that the routing middleware has selected, \nI used the WithDisplayName  method to assign names to the routes in listing 13.28. \nThe new middleware component adds a message to the response reporting the \nendpoint that has been selected. Restart ASP.NET Core and request the http://  \nlocalhost:5000/23 URL to see the output from the middleware that shows the end-\npoint has been selected between the two methods that add the routing middleware to \nthe request pipeline, as shown in figure 13.22.\nFigure 13.22    Determining the endpoint",5543
160-14 Using dependency injection.pdf,160-14 Using dependency injection,"347 Summary\nSummary\n¡ Routes allow an endpoint to match request with a URL pattern.\n¡ URL patterns can match variable segments whose values can be read by the \nendpoint.\n¡ URL patterns can contain optional segments that match URLs when they are \npresent.\n¡ Matching URLs can be controlled using constraints. \n¡ Routes can be used to generate URLs that can be included in responses, ensur-\ning that subsequent requests target a given endpoint.\n34814Using dependency  \ninjection\nThis chapter covers\n¡ Understanding how dependency injection  \n allows components to access shared services\n¡ Configuring services lifecycles to control when  \n services are instantiated\n¡ Understanding how to define and access  \n services using dependency injection \nServices are objects that are shared between middleware components and end-\npoints. There are no restrictions on the features that services can provide, but they \nare usually used for tasks that are needed in multiple parts of the application, such \nas logging or database access.\nThe ASP.NET Core dependency injection  feature is used to create and consume ser-\nvices. This topic causes confusion and can be difficult to understand. In this chapter, \nI describe the problems that dependency injection solves and explain how depen-\ndency injection is supported by the ASP.NET Core platform. Table 14.1 puts depen-\ndency injection in context.\n 349  \nTable 14.1.    Putting dependency injection in context\nQuestion Answer\nWhat is it? Dependency injection makes it easy to create loosely coupled components, \nwhich typically means that components consume functionality defined by inter -\nfaces without having any firsthand knowledge of which implementation classes \nare being used.\nWhy is it useful? Dependency injection makes it easier to change the behavior of an application by \nchanging the components that implement the interfaces that define application \nfeatures. It also results in components that are easier to isolate for unit testing.\nHow is it used? The Program.cs  file is used to specify which implementation classes are used \nto deliver the functionality specified by the interfaces used by the application. \nServices can be explicitly requested through the IServiceProvider  interface \nor by declaring constructor or method parameters. \nAre there any pitfalls \nor limitations?There are some differences in the way that middleware components and \nendpoints are handled and the way that services with different lifecycles are \naccessed. \nAre there any \nalternatives?You don’t have to use dependency injection in your code, but it is helpful to know \nhow it works because it is used by the ASP.NET Core platform to provide features \nto developers. \nTable 14.2 provides a guide to the chapter.\nTable 14.2.   Chapter guide\nProblem Solution Listing\nObtaining a service in a handler function \ndefined in the Program.cs  fileAdd a parameter to the handler function. 15\nObtaining a service in a middleware component Define a constructor parameter. 16, \n30–32\nObtaining a service in an endpoint Get an  IServiceProvider  object \nthrough the context objects.17\nInstantiating a class that has constructor \ndependenciesUse the ActivatorUtilities  class. 18–20\nDefining services that are instantiated for every \ndependencyDefine transient services. 21–25\nDefining services that are instantiated for every \nrequestDefine scoped services. 26–29\nAccessing configuration services before the \nBuild  method is called in the Program.cs  \nfileUse the properties defined by the \nWebApplicationBuilder  class.33\nManaging service instantiation Use a service factory. 34, 35\nDefining multiple implementations for a service Define multiple services with the same \nscope and consume them through the \nGetServices  method.36–38\nUsing services that support generic type \nparameters Use a service with an unbound type. 39",3923
161-14.1 Preparing for this chapter.pdf,161-14.1 Preparing for this chapter,,0
162-14.2.1 Understanding the service location problem.pdf,162-14.2.1 Understanding the service location problem,"350 chapter  14 Using dependency injection \n14.1 Preparing for this chapter\nIn this chapter, I continue to use the Platform  project from chapter 13. New classes \nare required to prepare for this chapter. Start by creating the Platform/Services  \nfolder and add to it a class file named IResponseFormatter.cs , with the code shown \nin listing 14.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from  https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 14.1    The contents of the IResponseFormatter.cs file in the Services folder\nnamespace Platform.Services {\n    public interface IResponseFormatter {\n        Task Format(HttpContext context, string content);\n    }\n}\nThe IResponseFormatter  interface defines a single method that receives an Http-\nContext  object and a string . To create an implementation of the interface, add a \nclass called TextResponseFormatter.cs  to the Platform/Services  folder with the \ncode shown in listing 14.2.\nListing 14.2    The contents of the TextResponseFormatter.cs file in the Services folder\nnamespace Platform.Services {\n    public class TextResponseFormatter : IResponseFormatter {\n        private int responseCounter = 0;\n        public async Task Format(HttpContext context, string content) {\n            await context.Response.\n                WriteAsync($""Response {++responseCounter}:\n{content}"");\n        }\n    }\n}\nThe TextResponseFormatter  class implements the interface and writes the content \nto the response as a simple string with a prefix to make it obvious when the class is used.\n14.1.1  Creating a middleware component and an endpoint\nSome of the examples in this chapter show how features are applied differently when \nusing middleware and endpoints. Add a file called WeatherMiddleware.cs  to the \nPlatform  folder with the code shown in listing 14.3.\nListing 14.3    The contents of the WeatherMiddleware.cs file in the Platform folder\nnamespace Platform {\n    public class WeatherMiddleware {\n 351 Preparing for this chapter\n        private RequestDelegate next;\n        public WeatherMiddleware(RequestDelegate nextDelegate) {\n            next = nextDelegate;\n        }\n        public async Task Invoke(HttpContext context) {\n            if (context.Request.Path == ""/middleware/class"") {\n                await context.Response\n                 .WriteAsync(""Middleware Class: It is raining in London"");\n            } else {\n                await next(context);\n            }\n        }\n    }\n}\nTo create an endpoint that produces a similar result to the middleware component, \nadd a file called WeatherEndpoint.cs  to the Platform  folder with the code shown in \nlisting 14.4.\nListing 14.4    The contents of the WeatherEndpoint.cs file in the Platform folder\nnamespace Platform {\n    public class WeatherEndpoint {\n        public static async Task Endpoint(HttpContext context) {\n            await context.Response\n                .WriteAsync(""Endpoint Class: It is cloudy in Milan"");\n        }\n    }\n}\n14.1.2  Configuring the request pipeline \nReplace the contents of the Program.cs  file with those shown in listing 14.5. The \nclasses defined in the previous section are applied alongside a lambda function that \nproduce similar results.\nListing 14.5    Replacing the contents of the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapGet(""endpoint/class"", WeatherEndpoint.Endpoint);\nIResponseFormatter formatter = new TextResponseFormatter();\napp.MapGet(""endpoint/function"", async context => {\n    await formatter.Format(context, \n352 chapter  14 Using dependency injection \n        ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nStart the application by opening a new PowerShell command prompt, navigating to \nthe Platform  project folder, and running the command shown in listing 14.6.\nListing 14.6    Starting the ASP .NET Core Runtime \ndotnet run\nUse a browser to request http://localhost:5000/endpoint/function, and you will see \nthe response shown in figure 14.1. Each time you reload the browser, the counter \nshown in the response will be incremented.\nFigure 14.1   Running the example application  \n14.2 Understanding service location and tight coupling \nTo understand dependency injection, it is important to start with the two problems it \nsolves. In the sections that follow, I describe both problems addressed by dependency \ninjection.  \nTaking a view on dependency injection \nDependency injection is one of the topics that readers contact me about most often. \nAbout half of the emails complain that I am “forcing” DI upon them. Oddly, the other half \nare complaints that I did not emphasize the benefits of DI strongly enough and other \nreaders may not have realized how useful it can be.  \nDependency injection can be a difficult topic to understand, and its value is contentious. \nDI can be a useful tool, but not everyone likes it—or needs it. \nDI offers limited benefit if you are not doing unit testing or if you are working on a small, \nself-contained, and stable project. It is still helpful to understand how DI works because \nDI is used to access some important ASP.NET Core features described in earlier chap-\nters, but you don’t always need to embrace DI in the custom classes you write. There are \nalternative ways of creating shared features—two of which I describe in the following sec-\ntions—and using these is perfectly acceptable if you don’t like DI.\nI rely on DI in my applications because I find that projects often go in unexpected direc -\ntions, and being able to easily replace a component with a new implementation can save \nme a lot of tedious and error-prone changes. I’d rather put in some effort at the start of \nthe project than do a complex set of edits later. \n 353 Understanding service location and tight coupling \n(continued)\nBut I am not dogmatic about dependency injection and nor should you be. Dependency \ninjection solves a problem that doesn’t arise in every project, and only you can determine \nwhether you need DI for your project. \n14.2.1  Understanding the service location problem\nMost projects have features that need to be used in different parts of the application, \nwhich are known as services . Common examples include logging tools and configu-\nration settings but can extend to any shared feature, including the TextResponse -\nFormatter  class that is defined in listing 14.2 and to handle requests by the middleware \ncomponent and the lambda function.\nEach TextResponseFormatter  object maintains a counter that is included in the \nresponse sent to the browser, and if I want to incorporate the same counter into the \nresponses generated by other endpoints, I need to have a way to make a single Text-\nResponseFormatter  object available in such a way that it can be easily found and con-\nsumed at every point where responses are generated. \nThere are many ways to make services locatable, but there are two main approaches, \naside from the one that is the main topic of this chapter. The first approach is to create \nan object and use it as a constructor or method argument to pass it to the part of the \napplication where it is required. The other approach is to add a static  property to the \nservice class that provides direct access to the shared instance, as shown in listing 14.7. \nThis is known as the singleton pattern , and it was a common approach before the wide-\nspread use of dependency injection.\nListing 14.7    A singleton in the TextResponseFormatter.cs file in the Services folder\nnamespace Platform.Services {\n    public class TextResponseFormatter : IResponseFormatter {\n        private int responseCounter = 0;\n        private static TextResponseFormatter? shared;\n        public async Task Format(HttpContext context, string content) {\n            await context.Response.\n                WriteAsync($""Response {++responseCounter}:\n{content}"");\n        }\n        public static TextResponseFormatter Singleton {\n            get {\n                if (shared == null) {\n                    shared = new TextResponseFormatter();\n                }\n                return shared;\n            }\n        }\n    }\n}\n354 chapter  14 Using dependency injection \nThis is a basic implementation of the singleton pattern, and there are many variations \nthat pay closer attention to issues such as safe concurrent access. What’s important \nfor this chapter is that the changes in listing 14.7 rely on the consumers of the Text-\nResponseFormatter  service obtaining a shared object through the static Singleton  \nproperty, as shown in listing 14.8.\nListing 14.8    Using a singleton in the WeatherEndpoint.cs file in the Platform folder\nusing Platform.Services;\nnamespace Platform {\n    public class WeatherEndpoint {\n        public static async Task Endpoint(HttpContext context) {\n            await TextResponseFormatter.Singleton.Format(context, \n                ""Endpoint Class: It is cloudy in Milan"");\n        }\n    }\n}\nListing 14.9 makes the same change to the lambda function in the Program.cs  file.\nListing 14.9    Using a service in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapGet(""endpoint/class"", WeatherEndpoint.Endpoint);\nIResponseFormatter formatter = TextResponseFormatter.Singleton;\napp.MapGet(""endpoint/function"", async context => {\n    await formatter.Format(context, \n        ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nThe singleton pattern allows me to share a single TextResponseFormatter  object so \nit is used by two endpoints, with the effect that a single counter is incremented by \nrequests for two different URLs. \nTo see the effect of the singleton pattern, restart ASP.NET Core and request the \nhttp://localhost:5000/endpoint/class  and http://localhost:5000/endpoint/function \nURLs. A single counter is updated for both URLs, as shown in figure 14.2.",10402
163-14.2.2 Understanding the tightly coupled components problem.pdf,163-14.2.2 Understanding the tightly coupled components problem,"355 Understanding service location and tight coupling \nFigure 14.2   Implementing the singleton pattern to create a shared service\nThe singleton pattern is simple to understand and easy to use, but the knowledge of \nhow services are located is spread throughout the application, and all service classes \nand service consumers need to understand how to access the shared object. This can \nlead to variations in the singleton pattern as new services are created and creates many \npoints in the code that must be updated when there is a change. This pattern can also \nbe rigid and doesn’t allow any flexibility in how services are managed because every \nconsumer always shares a single service object. \n14.2.2  Understanding the tightly coupled components problem\nAlthough I defined an interface in listing 14.1, the way that I have used the singleton \npattern means that consumers are always aware of the implementation class they are \nusing because that’s the class whose static property is used to get the shared object. If \nI want to switch to a different implementation of the IResponseFormatter  interface, \nI must locate every use of the service and replace the existing implementation class \nwith the new one. There are patterns to solve this problem, too, such as the type broker  \npattern, in which a class provides access to singleton objects through their interfaces. \nAdd a class file called TypeBroker.cs  to the Platform/Services  folder and use it to \ndefine the code shown in listing 14.10.  \nListing 14.10    The contents of the TypeBroker.cs file in the Services folder\nnamespace Platform.Services {\n    public static class TypeBroker {\n        private static IResponseFormatter formatter \n            = new TextResponseFormatter();\n        public static IResponseFormatter Formatter => formatter;\n    }\n}\nThe Formatter  property provides access to a shared service object that implements \nthe IResponseFormatter  interface. Consumers of the service need to know that the \nTypeBroker  class is responsible for selecting the implementation that will be used, but \nthis pattern means that service consumers can work through interfaces rather than \nconcrete classes, as shown in listing 14.11.\n356 chapter  14 Using dependency injection \nListing 14.11    Using a type broker in the WeatherEndpoint.cs file in the Platform folder\nusing Platform.Services;\nnamespace Platform {\n    public class WeatherEndpoint {\n        public static async Task Endpoint(HttpContext context) {\n            await TypeBroker.Formatter.Format(context, \n                ""Endpoint Class: It is cloudy in Milan"");\n        }\n    }\n}\nListing 14.12 makes the same change to the lambda function so that both uses of \nthe IResponseFormatter  interface get their implementation objects from the type \nbroker.\nListing 14.12    Using a type broker in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapGet(""endpoint/class"", WeatherEndpoint.Endpoint);\nIResponseFormatter formatter = TypeBroker.Formatter;\napp.MapGet(""endpoint/function"", async context => {\n    await formatter.Format(context, \n        ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nThis approach makes it easy to switch to a different implementation class by altering \njust the TypeBroker  class and prevents service consumers from creating dependencies \non a specific implementation. It also means that service classes can focus on the fea-\ntures they provide without having to deal with how those features will be located. To \ndemonstrate, add a class file called HtmlResponseFormatter.cs  to the Platform/\nServices  folder with the code shown in listing 14.13.\nListing 14.13    The contents of the HtmlResponseFormatter.cs file in the Services folder\nnamespace Platform.Services {\n    public class HtmlResponseFormatter : IResponseFormatter {\n        public async Task Format(HttpContext context, string content) {\n            context.Response.ContentType = ""text/html"";",4153
164-14.3 Using dependency injection.pdf,164-14.3 Using dependency injection,"357 Using dependency injection\n            await context.Response.WriteAsync($@""\n                <!DOCTYPE html>\n                <html lang=""""en"""">\n                <head><title>Response</title></head>\n                <body>\n                    <h2>Formatted Response</h2>\n                    <span>{content}</span>\n                </body>\n                </html>"");\n        }\n    }\n}\nThis implementation of the IResponseFormatter  sets the ContentType  property of \nthe HttpResponse  object and inserts the content into an HTML template string. To \nuse the new formatter class, I only need to change the TypeBroker , as shown in listing \n14.14.\nListing 14.14    changing the TypeBroker.cs file in the Platform/Services folder\nnamespace Platform.Services {\n    public static class TypeBroker {\n        private static IResponseFormatter formatter \n            = new HtmlResponseFormatter();\n        public static IResponseFormatter Formatter => formatter;\n    }\n}\nTo confirm the new formatter works, restart ASP.NET Core and request http://  \nlocalhost:5000/endpoint/function, which will produce the result shown in figure 14.3.\nFigure 14.3   Using a different service implementation class\n14.3 Using dependency injection\nDependency injection provides an alternative approach to providing services that tidy \nup the rough edges that arise in the singleton and type broker patterns, and is inte-\ngrated with other ASP.NET Core features. Listing 14.15 shows the use of ASP.NET Core \ndependency injection to replace the type broker from the previous section.  \n358 chapter  14 Using dependency injection \nListing 14.15    Using dependency injection in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddSingleton<IResponseFormatter, \n    HtmlResponseFormatter>();\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapGet(""endpoint/class"", WeatherEndpoint.Endpoint);\n//IResponseFormatter formatter = TypeBroker.Formatter;\napp.MapGet(""endpoint/function"", \n    async (HttpContext context, IResponseFormatter formatter) => {\n        await formatter.Format(context, \n            ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nServices are registered using extension methods defined by the IService  Collection  \ninterface, an implementation of which is obtained using the WebApplication-\nBuilder.Services  property. In the listing, I used an extension method to create a \nservice for the IResponseFormatter  interface: \n...\nbuilder. Services.AddSingleton <IResponseFormatter, HtmlResponseFormatter>();\n...\nThe AddSingleton  method is one of the extension methods available for services and \ntells ASP.NET Core that a single object should be used to satisfy all demands for the \nservice (the other extension methods are described in the “Using Service Lifecycles” \nsection). The interface and the implementation class are specified as generic type \narguments. To consume the service, I added parameters to the functions that handle \nrequests, like this:\n...\nasync (HttpContext context, IResponseFormatter formatter ) => {\n...\nMany of the methods that are used to register middleware or create endpoints will \naccept any function, which allows parameters to be defined for the services that are \nrequired to produce a response. One consequence of this feature is that the C# com-\npiler can’t determine the parameter types, which is why I had to specify them in the \nlisting.\nThe new parameter declares a dependency on the IResponseFormatter  interface, \nand the function is said to depend on the interface. Before the function is invoked to \nhandle a request, its parameters are inspected, the dependency is detected, and the",3819
165-14.3.2 Getting services from the HttpContext object.pdf,165-14.3.2 Getting services from the HttpContext object,"359 Using dependency injection\napplication’s services are inspected to determine whether it is possible to resolve the \ndependency. \nThe call to the AddSingleton  method told the dependency injection system that \na dependency on the IResponseFormatter  interface can be resolved with an Html-\nResponseFormatter  object. The object is created and used as an argument to invoke \nthe handler function. Because the object that resolves the dependency is provided from \noutside the function that uses it, it is said to have been injected , which is why the process \nis known as dependency injection .\n14.3.1  Using a Service with a Constructor Dependency \nDefining a service and consuming it in the same code file may not seem impressive, but \nonce a service is defined, it can be used almost anywhere in an ASP.NET Core applica-\ntion. Listing 14.16 declares a dependency on the IResponseFormatter  interface in \nthe middleware class defined at the start of the chapter. \nListing 14.16    A dependency in the WeatherMiddleware.cs file in the Platform folder \nusing Platform.Services;\nnamespace Platform {\n    public class WeatherMiddleware {\n        private RequestDelegate next;\n        private IResponseFormatter formatter;\n        public WeatherMiddleware(RequestDelegate nextDelegate,\n                IResponseFormatter respFormatter) {\n            next = nextDelegate;\n            formatter = respFormatter;\n        }\n        public async Task Invoke(HttpContext context) {\n            if (context.Request.Path == ""/middleware/class"") {\n                await formatter.Format(context,\n                    ""Middleware Class: It is raining in London"");\n            } else {\n                await next(context);\n            }\n        }\n    }\n}\nTo declare the dependency, I added a constructor parameter. To see the result, restart \nASP.NET Core and request the http://localhost:5000/middleware/class URL, which \nwill produce the response shown in figure 14.4.  \n360 chapter  14 Using dependency injection \nFigure 14.4   Declaring a dependency in a middleware class\nWhen the request pipeline is being set up, the ASP.NET Core platform reaches \nthe statement in the Program.cs  file that adds the WeatherMiddleware  class as a \ncomponent.\n...\napp.UseMiddleware< WeatherMiddleware >();\n...\nThe platform understands it needs to create an instance of the WeatherMiddleware  \nclass and inspects the constructor. The dependency on the IResponseFormatter  inter-\nface is detected, the services are inspected to see if the dependency can be resolved, \nand the shared service object is used when the constructor is invoked. \nThere are two important points to understand about this example. The first is that \nWeatherMiddleware  doesn’t know which implementation class will be used to resolve \nits dependency on the IResponseFormatter  interface—it just knows that it will receive \nan object that conforms to the interface through its constructor parameter. Second, \nthe WeatherMiddleware  class doesn’t know how the dependency is resolved—it just \ndeclares a constructor parameter and relies on ASP.NET Core to figure out the details. \nThis is a more elegant approach than my implementations of the singleton and type \nbroker patterns earlier in the chapter, and I can change the implementation class used \nto resolve the service by changing the generic type parameters used in the Program.cs  \nfile. \n14.3.2  Getting services from the HttpContext object \nASP.NET Core does a good job of supporting dependency injection as widely as possi-\nble but there will be times when you are not working directly with the ASP.NET Core \nAPI and won’t have a way to declare your service dependencies directly. \nServices can be accessed through the HttpContext  object, which is used to repre-\nsent the current request and response, as shown in listing 14.17. You may find that you \nreceive an HttpContext  object even if you are working with third-party code that acts as \nan intermediary to ASP.NET Core and which doesn’t allow you to resolve services. \nNOTE     This example is a demonstration of a common problem but ASP.NET \nCore does support dependency injection for endpoint delegates.\n 361 Using dependency injection\nListing 14.17    Using the HttpContext in the WeatherEndpoint.cs file in the Platform \nfolder\nusing Platform.Services;\nnamespace Platform {\n    public class WeatherEndpoint {\n        public static async Task Endpoint(HttpContext context) {\n            IResponseFormatter formatter = context.RequestServices\n                .GetRequiredService<IResponseFormatter>();\n            await formatter.Format(context,\n                ""Endpoint Class: It is cloudy in Milan"");\n        }\n    }\n}\nThe HttpContext.RequestServices  property returns an object that implements \nthe IServiceProvider  interfaces, which provides access to the services that have \nbeen configured in the Program.cs  file. The Microsoft.Extensions.Dependency -\nInjection  namespace contains extension methods for the IServiceProvider  inter-\nface that allow individual services to be obtained, as described in table 14.3.  \nTable 14.3   The IServiceProvider extension methods for obtaining services\nName Description\nGetService<T>() This method returns a service for the type \nspecified by the generic type parameter or \nnull  if no such service has been defined.\nGetService(type) This method returns a service for the type \nspecified or null  if no such service has been \ndefined.\nGetRequiredService<T>() This method returns a service specified by the \ngeneric type parameter and throws an excep-\ntion if a service isn’t available.\nGetRequiredService(type) This method returns a service for the type \nspecified and throws an exception if a service \nisn’t available.\nWhen the Endpoint  method is invoked in listing 14.17, the GetRequiredService<T>  \nmethod is used to obtain an IResponseFormatter  object, which is used to format \nthe response. To see the effect, restart ASP.NET Core and use the browser to request \nhttp://localhost:5000/endpoint/class, which will produce the formatted response \nshown in figure 14.5.\n362 chapter  14 Using dependency injection \nFigure 14.5   Using a service in an endpoint class\nusing the activation  utility  class\nI defined static methods for endpoint classes in chapter 13 because it makes them eas-\nier to use when creating routes. But for endpoints that require services, it can often be \neasier to use a class that can be instantiated because it allows for a more generalized \napproach to handling services. Listing 14.18 revises the endpoint with a constructor \nand removes the static  keyword from the Endpoint  method.  \nListing 14.18    Revising the endpoint in the WeatherEndpoint.cs file in the  \nPlatform folder\nusing Platform.Services;\nnamespace Platform {\n    public class WeatherEndpoint {\n        private IResponseFormatter formatter;\n        public WeatherEndpoint(IResponseFormatter responseFormatter) {\n            formatter = responseFormatter;\n        }\n        public async Task Endpoint(HttpContext context) {\n            await formatter.Format(context, \n                ""Endpoint Class: It is cloudy in Milan"");\n        }\n    }\n}\nThe most common use of dependency injection in ASP.NET Core applications is in \nclass constructors. Injection through methods, such as performed for middleware \nclasses, is a complex process to re-create, but there are some useful built-in tools that \ntake care of inspecting constructors and resolving dependencies using services. Create \na file called EndpointExtensions.cs  to the Services  folder with the content shown \nin listing 14.19. \nListing 14.19    The contents of the  EndpointExtensions.cs file in the Services folder\nusing System.Reflection;\nnamespace Microsoft.AspNetCore.Builder {\n 363 Using dependency injection\n    public static class EndpointExtensions {\n        public static void MapEndpoint<T>(this IEndpointRouteBuilder app,\n                string path, string methodName = ""Endpoint"") {\n            MethodInfo? methodInfo = typeof(T).GetMethod(methodName);\n            if (methodInfo?.ReturnType != typeof(Task)) {\n                throw new System.Exception(""Method cannot be used"");\n            }\n            T endpointInstance =\n                ActivatorUtilities.CreateInstance<T>(app.ServiceProvider);\n            app.MapGet(path, (RequestDelegate)methodInfo\n                .CreateDelegate(typeof(RequestDelegate), \n                    endpointInstance));\n        }\n    }\n}\nThe MapEndpoint  extension method accepts a generic type parameter that specifies \nthe endpoint class that will be used. The other arguments are the path that will be used \nto create the route and the name of the endpoint class method that processes requests.\nA new instance of the endpoint class is created, and a delegate to the specified \nmethod is used to create a route. Like any code that uses .NET reflection, the extension \nmethod in listing 14.19 can be difficult to read, but this is the key statement for this \nchapter:\n...\nT endpointInstance = \n    ActivatorUtilities.CreateInstance<T>(app.ServiceProvider);\n...\nThe ActivatorUtilities  class, defined in the Microsoft.Extensions.Dependency  -\nInjection  namespace, provides methods for instantiating classes that have depen-\ndencies declared through their constructor. Table 14.4 shows the most useful \nActivatorUtilities  methods.  \nTable 14.4   The ActivatorUtilities methods\nName Description\nCreateInstance<T>(services, args) This method creates a new instance of the \nclass specified by the type parameter, resolving \ndependencies using the services and additional \n(optional) arguments.\nCreateInstance(services, type, args) This method creates a new instance of the \nclass specified by the parameter, resolving \ndependencies using the services and additional \n(optional) arguments.\nGetServiceOrCreateInstance<T> \n(services, args)This method returns a service of the specified \ntype, if one is available, or creates a new instance \nif there is no service.\nGetServiceOrCreateInstance \n(services, type, args)This method returns a service of the specified \ntype, if one is available, or creates a new instance \nif there is no service.",10341
166-14.4.2 Avoiding the transient service reuse pitfall.pdf,166-14.4.2 Avoiding the transient service reuse pitfall,"364 chapter  14 Using dependency injection \nThese methods make it easy to instantiate classes that declare constructor depen-\ndencies. Both methods resolve constructor dependencies using services through \nan IServiceProvider  object and an optional array of arguments that are used for \ndependencies that are not services. These methods make it easy to apply dependency \ninjection to custom classes, and the use of the CreateInstance  method results in an \nextension method that can create routes with endpoint classes that consume services. \nListing 14.20 uses the new extension method to create a route.\nListing 14.20    Creating a route in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddSingleton<IResponseFormatter, \n    HtmlResponseFormatter>();\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\n//app.MapGet(""endpoint/class"", WeatherEndpoint.Endpoint);\napp.MapEndpoint<WeatherEndpoint>(""endpoint/class"");\napp.MapGet(""endpoint/function"", \n    async (HttpContext context, IResponseFormatter formatter) => {\n        await formatter.Format(context, \n            ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nTo confirm that requests are routed to the endpoint, restart ASP.NET Core and request \nthe http://localhost:5000/endpoint/class URL, which should produce the same \nresponse as shown in figure 14.5.\n14.4 Using Service Lifecycles\nWhen I created the service in the previous section, I used the AddSingleton  extension \nmethod, like this:  \n...\nbuilder.Services. AddSingleton <IResponseFormatter, HtmlResponseFormatter>();\n...\nThe AddSingleton  method produces a service that is instantiated the first time it is \nused to resolve a dependency and is then reused for each subsequent dependency. \nThis means that any dependency on the IResponseFormatter  object will be resolved \nusing the same HtmlResponseFormatter  object.  \nSingletons are a good way to get started with services, but there are some problems \nfor which they are not suited, so ASP.NET Core supports scoped and transient services, \n 365 Using Service Lifecycles\nwhich give different lifecycles for the objects that are created to resolve dependencies. \nTable 14.5 describes the set of methods used to create services. There are versions of \nthese methods that accept types as conventional arguments, as demonstrated in the \n“Using Unbound Types in Services” section, later in this chapter. \nTable 14.5.   The extension methods for creating services\nName Description\nAddSingleton<T, U>() This method creates a single object of type U that \nis used to resolve all dependencies on type T.\nAddTransient<T, U>() This method creates a new object of type U to \nresolve each dependency on type T.\nAddScoped<T, U>() This method creates a new object of type U that is \nused to resolve dependencies on T within a single \nscope, such as request.\nThere are versions of the methods in Table 14.5 that have a single type argument, \nwhich allows a service to be created that solves the service location problem without \naddressing the tightly coupled issue. You can see an example of this type of service in \nchapter 24, where I share a simple data source that isn’t accessed through an interface.\n14.4.1  Creating transient services\nThe AddTransient  method does the opposite of the AddSingleton  method and cre-\nates a new instance of the implementation class for every dependency that is resolved. \nTo create a service that will demonstrate the use of service lifecycles, add a file called \nGuidService.cs  to the Platform/Services  folder with the code shown in listing \n14.21.  \nListing 14.21    The contents of the GuidService.cs file in the Services folder\nnamespace Platform.Services {\n    public class GuidService : IResponseFormatter {\n        private Guid guid = Guid.NewGuid();\n        public async Task Format(HttpContext context, string content) {\n            await context.Response.WriteAsync($""Guid: {guid}\n{content}"");\n        }\n    }\n}\nThe Guid  struct generates a unique identifier, which will make it obvious when a differ-\nent instance is used to resolve a dependency on the IResponseFormatter  interface. \nIn listing 14.22, I have changed the statement that creates the IResponseFormatter  \nservice to use the AddTransient  method and the GuidService  implementation class.  \n366 chapter  14 Using dependency injection \nListing 14.22    Creating a transient service in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddTransient<IResponseFormatter, GuidService>();\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapEndpoint<WeatherEndpoint>(""endpoint/class"");\napp.MapGet(""endpoint/function"", \n    async (HttpContext context, IResponseFormatter formatter) => {\n        await formatter.Format(context, \n            ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nIf you restart ASP.NET Core and request the http://localhost:5000/endpoint/\nfunction URL, you will receive the responses similar to the ones shown in figure 14.6. \nEach response will be shown with a different GUID value, confirming that transient \nservice objects have been used to resolve the dependency on the IResponseFormatter  \nservice. \nFigure 14.6   Using transient services\n14.4.2  Avoiding the transient service reuse pitfall\nThere is a pitfall when using transient services, which you can see by requesting http://\nlocalhost:5000/middleware/class and clicking the reload button. Unlike the previous \nexample, the same GUID value is shown in every response, as shown in figure 14.7.\nFigure 14.7   The same GUID values appearing in responses\n 367 Using Service Lifecycles\nNew service objects are created only when dependencies are resolved, not when ser-\nvices are used. The components and endpoints in the example application have their \ndependencies resolved only when the application starts and the top-level statements \nin the Program.cs  file are executed. Each receives a separate service object, which is \nthen reused for every request that is processed. \nTo address this issue, I have to ensure that the dependency is resolved every time the \nInvoke  method is called, as shown in listing 14.23.\nListing 14.23    Moving dependencies in the Platform/WeatherMiddleware.cs file \nusing Platform.Services;\nnamespace Platform {\n    public class WeatherMiddleware {\n        private RequestDelegate next;\n        //private IResponseFormatter formatter;\n        public WeatherMiddleware(RequestDelegate nextDelegate) {\n            next = nextDelegate;\n            //formatter = respFormatter;\n        }\n        public async Task Invoke(HttpContext context, \n                IResponseFormatter formatter) {\n            if (context.Request.Path == ""/middleware/class"") {\n                await formatter.Format(context,\n                    ""Middleware Class: It is raining in London"");\n            } else {\n                await next(context);\n            }\n        }\n    }\n}\nThe ASP.NET Core platform will resolve dependencies declared by the Invoke  method \nevery time a request is processed, which ensures that a new transient service object is \ncreated. \nThe ActivatorUtilities  class doesn’t deal with resolving dependencies for meth-\nods. The simplest way of solving this issue for endpoints is to explicitly request services \nwhen each request is handled, which is the approach I used earlier when showing how \nservices are used. It is also possible to enhance the extension method to request services \non behalf of an endpoint, as shown in listing 14.24.\nListing 14.24   Requesting services in the Services/EndpointExtensions.cs file \nusing System.Reflection;\nnamespace Microsoft.AspNetCore.Builder {\n    public static class EndpointExtensions {\n        public static void MapEndpoint<T>(this IEndpointRouteBuilder app,\n368 chapter  14 Using dependency injection \n                string path, string methodName = ""Endpoint"") {\n            MethodInfo? methodInfo = typeof(T).GetMethod(methodName);\n            if (methodInfo?.ReturnType != typeof(Task)) {\n                throw new System.Exception(""Method cannot be used"");\n            }\n            T endpointInstance =\n                ActivatorUtilities.CreateInstance<T>(app.ServiceProvider);\n            ParameterInfo[] methodParams = methodInfo!.GetParameters();\n            app.MapGet(path, context => \n                (Task)methodInfo.Invoke(endpointInstance,\n                  methodParams.Select(p => \n                    p.ParameterType == typeof(HttpContext) ? context\n                      : app.ServiceProvider.GetService(p.ParameterType))\n                    .ToArray())!);\n        }\n    }\n}\nThe code in listing 14.24 isn’t as efficient as the approach taken by the ASP.NET Core \nplatform for middleware components. All the parameters defined by the method that \nhandles requests are treated as services to be resolved, except for the HttpContext  \nparameter. A route is created with a delegate that resolves the services for every request \nand invokes the method that handles the request. Listing 14.25 revises the Weather-\nEndpoint  class to move the dependency on IResponseFormatter  to the Endpoint  \nmethod so that a new service object will be received for every request.\nListing 14.25    Moving the dependency in the Platform/WeatherEndpoint.cs file \nusing Platform.Services;\nnamespace Platform {\n    public class WeatherEndpoint {\n        //private IResponseFormatter formatter;\n        //public WeatherEndpoint(IResponseFormatter responseFormatter) {\n        //    formatter = responseFormatter;\n        //}\n        public async Task Endpoint(HttpContext context, \n                IResponseFormatter formatter) {\n            await formatter.Format(context,\n                ""Endpoint Class: It is cloudy in Milan"");\n        }\n    }\n}\nThe changes in listing 14.23 to listing 14.25 ensure that the transient service is resolved \nfor every request, which means that a new GuidService  object is created and every \nresponse contains a unique ID.\nRestart ASP.NET Core, navigate to http://localhost:5000/endpoint/class, and click \nthe browser’s reload button. Each time you reload, a new request is sent to ASP.NET",10490
167-14.4.3 Using scoped services.pdf,167-14.4.3 Using scoped services,"369 Using Service Lifecycles\nCore, and the component or endpoint that handles the request receives a new service \nobject, such that a different GUID is shown in each response, as shown in figure 14.8.\nFigure 14.8   Using a transient service\n14.4.3  Using scoped services\nScoped services strike a balance between singleton and transient services. Within a \nscope, dependencies are resolved with the same object. A new scope is started for each \nHTTP request, which means that a service object will be shared by all the components \nthat handle that request. To prepare for a scoped service, listing 14.26 changes the \nWeatherMiddleware  class to declare three dependencies on the same service. \nListing 14.26    Adding dependencies in the Platform/WeatherMiddleware.cs file \nusing Platform.Services;\nnamespace Platform {\n    public class WeatherMiddleware {\n        private RequestDelegate next;\n        public WeatherMiddleware(RequestDelegate nextDelegate) {\n            next = nextDelegate;\n        }\n        public async Task Invoke(HttpContext context, \n                IResponseFormatter formatter1,\n                IResponseFormatter formatter2, \n                IResponseFormatter formatter3) {\n            if (context.Request.Path == ""/middleware/class"") {\n                await formatter1.Format(context, string.Empty);\n                await formatter2.Format(context, string.Empty);\n                await formatter3.Format(context, string.Empty);\n            } else {\n                await next(context);\n            }\n        }\n    }\n}\nDeclaring several dependencies on the same service isn’t required in real projects, \nbut it is useful for this example because each dependency is resolved independently. \nSince the IResponseFormatter  service was created with the AddTransient  method, \neach dependency is resolved with a different object. Restart ASP.NET Core and request \n370 chapter  14 Using dependency injection \nhttp://localhost:5000/middleware/class, and you will see that a different GUID is \nused for each of the three messages written to the response, as shown in figure 14.9. \nWhen you reload the browser, a new set of three GUIDs is displayed.\nFigure 14.9   Resolving dependencies on a transient service\nListing 14.27 changes the IResponseFormatter  service to use the scoped lifecycle \nwith the AddScoped  method.  \nTIP    You can create scopes through the CreateScope  extension method for \nthe IServiceProvider  interface. The result is an IServiceProvider  that is \nassociated with a new scope and that will have its own implementation objects for \nscoped services. \nListing 14.27    Using a scoped service in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddScoped<IResponseFormatter, GuidService>();\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapEndpoint<WeatherEndpoint>(""endpoint/class"");\napp.MapGet(""endpoint/function"", \n    async (HttpContext context, IResponseFormatter formatter) => {\n        await formatter.Format(context, \n            ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nRestart ASP.NET Core and request http://localhost:5000/middleware/class again, \nand you will see that the same GUID is used to resolve all three dependencies declared \nby the middleware component, as shown in figure 14.10. When the browser is reloaded, \nthe HTTP request sent to ASP.NET Core creates a new scope and a new service object.\n 371 Using Service Lifecycles\nFigure 14.10   Using a scoped service\navoiding  the scoped  service  validation  pitfall\nService consumers are unaware of the lifecycle that has been selected for singleton and \ntransient services: they declare a dependency or request a service and get the object \nthey require. \nScoped services can be used only within a scope. A new scope is created automati-\ncally for each request that was received. Requesting a scoped service outside of a scope \ncauses an exception. To see the problem, request http://localhost:5000/endpoint/\nclass, which will generate the exception response shown in figure 14.11.  \nFigure 14.11   Requesting a scoped service\nThe extension method that configures the endpoint resolves services through an \nIServiceProvider  object obtained from the routing middleware, like this:\n...\napp.ServiceProvider. GetService (p.ParameterType))\n...\naccessing  scoped  services  through  the context  object\nThe HttpContext  class defines a RequestServices  property that returns an  \nIServiceProvider  object that allows access to scoped services, as well as singleton \nand transient services. This fits well with the most common use of scoped services, \nwhich is to use a single service object for each HTTP request. Listing 14.28 revises the \nendpoint extension method so that dependencies are resolved using the services pro-\nvided through the HttpContext . \n372 chapter  14 Using dependency injection \nListing 14.28    Using a service in the EndpointExtensions.cs file in the Services folder\nusing System.Reflection;\nnamespace Microsoft.AspNetCore.Builder {\n    public static class EndpointExtensions {\n        public static void MapEndpoint<T>(this IEndpointRouteBuilder app,\n                string path, string methodName = ""Endpoint"") {\n            MethodInfo? methodInfo = typeof(T).GetMethod(methodName);\n            if (methodInfo?.ReturnType != typeof(Task)) {\n                throw new System.Exception(""Method cannot be used"");\n            }\n            T endpointInstance =\n                ActivatorUtilities.CreateInstance<T>(app.ServiceProvider);\n            ParameterInfo[] methodParams = methodInfo!.GetParameters();\n            app.MapGet(path, context => \n                (Task)methodInfo.Invoke(endpointInstance,\n                  methodParams.Select(p => \n                    p.ParameterType == typeof(HttpContext) ? context\n                      : context.RequestServices\n                        .GetService(p.ParameterType))\n                    .ToArray())!);\n        }\n    }\n}\nUsing the HttpContext.RequestServices  property ensures that services are resolved \nwithin the scope of the current HTTP request, which ensures that endpoints don’t use \nscoped services inappropriately.\nCreating new handlers for each request\nNotice that the ActivatorUtilities.CreateInstance<T>  method is still used to \ncreate an instance of the endpoint class in listing 14.28.\nThis presents a problem because it requires endpoint classes to know the lifecycles \nof the services on which they depend. The WeatherEndpoint  class depends on the \nIResponseFormatter  service and must know that a dependency can be declared only \nthrough the Endpoint  method and not the constructor.\nTo remove the need for this knowledge, a new instance of the endpoint class can \nbe created to handle each request, as shown in listing 14.29, which allows constructor \nand method dependencies to be resolved without needing to know which services are \nscoped. \nListing 14.29    Instantiating in the EndpointExtensions.cs file in the Services folder\nusing System.Reflection;\nnamespace Microsoft.AspNetCore.Builder {\n 373 Using Service Lifecycles\n    public static class EndpointExtensions {\n        public static void MapEndpoint<T>(this IEndpointRouteBuilder app,\n                string path, string methodName = ""Endpoint"") {\n            MethodInfo? methodInfo = typeof(T).GetMethod(methodName);\n            if (methodInfo?.ReturnType != typeof(Task)) {\n                throw new System.Exception(""Method cannot be used"");\n            }\n            //T endpointInstance =\n            //ActivatorUtilities.CreateInstance<T> (app.ServiceProvider);\n            ParameterInfo[] methodParams = methodInfo!.GetParameters();\n            app.MapGet(path, context => {\n                T endpointInstance =\n                    ActivatorUtilities.CreateInstance<T>\n                        (context.RequestServices);\n                return (Task)methodInfo.Invoke(endpointInstance!,\n                    methodParams.Select(p => \n                    p.ParameterType == typeof(HttpContext)\n                    ? context\n                    : context.RequestServices.GetService(p.ParameterType))\n                        .ToArray())!;\n            });\n        }\n    }\n}\nThis approach requires a new instance of the endpoint class to handle each request, \nbut it ensures that no knowledge of service lifecycles is required. \nRestart ASP.NET Core and request http://localhost:5000/endpoint/class. The \nscoped service will be obtained from the context, producing the responses shown in \nfigure 14.12.\nFigure 14.12   Using scoped services in lambda functions\nAccessing scoped services when configuring the request pipeline\nIf you require a scoped service to configure the application in the Program.cs  file, then \nyou can create a new scope and then request the service, like this:",9054
168-14.5 Other dependency injection features.pdf,168-14.5 Other dependency injection features,,0
169-14.5.1 Creating dependency chains.pdf,169-14.5.1 Creating dependency chains,"374 chapter  14 Using dependency injection \n(continued)\n...\napp.Services. CreateScope ().ServiceProvider\n    .GetRequiredService<MyScopedService>();\n...\nThe CreateScope  method creates a scope that allows scoped services to be accessed. \nIf you try to obtain a scoped service without creating a scope, then you will receive an \nexception.\n14.5 Other dependency injection features\nIn the sections that follow, I describe some additional features available when using \ndependency injection. These are not required for all projects, but they are worth \nunderstanding because they provide context for how dependency injection works and \ncan be helpful when the standard features are not quite what a project requires.\n14.5.1  Creating dependency chains \nWhen a class is instantiated to resolve a service dependency, its constructor is inspected, \nand any dependencies on services are resolved. This allows one service to declare a \ndependency on another service, creating a chain that is resolved automatically. To \ndemonstrate, add a class file called TimeStamping.cs  to the Platform/Services  \nfolder with the code shown in listing 14.30.  \nListing 14.30    The contents of the TimeStamping.cs file in the Services folder \nnamespace Platform.Services {\n    public interface ITimeStamper {\n        string TimeStamp { get; }\n    }\n    public class DefaultTimeStamper : ITimeStamper {\n        public string TimeStamp {\n            get => DateTime.Now.ToShortTimeString();\n        }\n    }\n}\nThe class file defines an interface named ITimeStamper  and an implementation class \nnamed DefaultTimeStamper . Next, add a file called TimeResponseFormatter.cs  to \nthe Platform/Services  folder with the code shown in listing 14.31.\nListing 14.31    The contents of the TimeResponseFormatter.cs file in the Services folder \nnamespace Platform.Services {\n    public class TimeResponseFormatter : IResponseFormatter {\n        private ITimeStamper stamper;\n 375 Other dependency injection features\n        public TimeResponseFormatter(ITimeStamper timeStamper) {\n            stamper = timeStamper;\n        }\n        public async Task Format(HttpContext context, string content) {\n            await context.Response.WriteAsync($""{stamper.TimeStamp}: "" \n                + content);\n        }\n    }\n}\nThe TimeResponseFormatter  class is an implementation of the IResponse  Formatter  \ninterface that declares a dependency on the ITimeStamper  interface with a construc-\ntor parameter. Listing 14.32 defines services for both interfaces in the Program.cs  file.\nNOTE     Services don’t need to have the same lifecycle as their dependencies, but \nyou can end up with odd effects if you mix lifecycles. Lifecycles are applied only \nwhen a dependency is resolved, which means that if a scoped service depends on \na transient service, for example, then the transient object will behave as though \nit was assigned the scoped lifecycle.\nListing 14.32    Configuring services in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddScoped<IResponseFormatter, TimeResponseFormatter>();\nbuilder.Services.AddScoped<ITimeStamper, DefaultTimeStamper>();\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapEndpoint<WeatherEndpoint>(""endpoint/class"");\napp.MapGet(""endpoint/function"", \n    async (HttpContext context, IResponseFormatter formatter) => {\n        await formatter.Format(context, \n            ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nWhen a dependency on the IResponseFormatter  service is resolved, the Time-\nResponse  Formatter  constructor will be inspected, and its dependency on the ITime-\nStamper  service will be detected. A DefaultTimeStamper  object will be created \nand injected into the TimeResponseFormatter  constructor, which allows the origi-\nnal dependency to be resolved. To see the dependency chain in action, restart ASP.\nNET Core and request http://localhost:5000/endpoint/class, and you will see the",4113
170-14.5.3 Using service factory functions.pdf,170-14.5.3 Using service factory functions,"376 chapter  14 Using dependency injection \ntimestamp generated by the DefaultTimeStamper  class included in the response pro-\nduced by the TimeResponseFormatter  class, as shown in figure 14.13.\nFigure 14.13   Creating a chain of dependencies\n14.5.2  Accessing services in the Program.cs file \nA common requirement is to use the application’s configuration settings to alter the \nset of services that are created in the Program.cs  file. This presents a problem because \nthe configuration is presented as a service and services cannot normally be accessed \nuntil after the WebApplicationBuilder.Build  method is invoked.\nTo address this issue, the WebApplication  and WebApplicationBuilder  classes \ndefine properties that provide access to the built-in services that provide access to the \napplication configuration, as described in table 14.6.  \nTable 14.6   The WebApplication and WebApplicationBuilder properties for configuration services\nName Description\nIConfiguration ­ This property returns an implementation of the  \nIConfiguration  interface, which provides access to \nthe application’s configuration settings, as described \nin chapter 15. ­Configuration.\nEnvironment This property returns an implementation of the  \nIWebHostEnvironment  interface, which provides \ninformation about the environment in which the appli-\ncation is being executed and whose principal use is to \ndetermine if the application is configured for develop -\nment or deployment, as described in chapter 15.\nThese services are described in chapter 15, but what’s important for this chapter is that \nthey can be used to customize which services are configured in the Program.cs  file, as \nshown in listing 14.33.\nListing 14.33    Accessing configuration data in the Program.cs file in the Platform folder \nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nIWebHostEnvironment env = builder.Environment;\n 377 Other dependency injection features\nif (env.IsDevelopment()) {\n    builder.Services.AddScoped<IResponseFormatter, \n        TimeResponseFormatter>();\n    builder.Services.AddScoped<ITimeStamper, DefaultTimeStamper>();\n} else {\n    builder.Services.AddScoped<IResponseFormatter, \n        HtmlResponseFormatter>();\n}\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapEndpoint<WeatherEndpoint>(""endpoint/class"");\napp.MapGet(""endpoint/function"", \n    async (HttpContext context, IResponseFormatter formatter) => {\n        await formatter.Format(context, \n            ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nThis example uses the Environment  property to get an implementation of the \nIWebHost  Environment  interface and uses its IsDevelopment  extension method to \ndecide which services are set up for the application. \n14.5.3  Using service factory functions\nFactory functions allow you to take control of the way that service implementation \nobjects are created, rather than relying on ASP.NET Core to create instances for you. \nThere are factory versions of the AddSingleton , AddTransient , and AddScoped  \nmethods, all of which are used with a function that receives an IServiceProvider  \nobject and returns an implementation object for the service. \nOne use for factory functions is to define the implementation class for a service as a \nconfiguration setting, which is read through the IConfguration  service. This requires \nthe WebApplicationBuilder  properties described in the previous section. Listing \n14.34 adds a factory function for the IResponseFormatter  service that gets the imple-\nmentation class from the configuration data.\nListing 14.34    Using a factory function in the Program.cs file in the Platform folder\nusing Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\n//IWebHostEnvironment env = builder.Environment;\nIConfiguration config = builder.Configuration;\nbuilder.Services.AddScoped<IResponseFormatter>(serviceProvider => {\n    string? typeName = config[""services:IResponseFormatter""];\n    return (IResponseFormatter)ActivatorUtilities\n        .CreateInstance(serviceProvider, typeName == null\n378 chapter  14 Using dependency injection \n            ? typeof(GuidService) : Type.GetType(typeName, true)!);\n});\nbuilder.Services.AddScoped<ITimeStamper, DefaultTimeStamper>();\nvar app = builder.Build();\napp.UseMiddleware<WeatherMiddleware>();\napp.MapEndpoint<WeatherEndpoint>(""endpoint/class"");\napp.MapGet(""endpoint/function"", \n    async (HttpContext context, IResponseFormatter formatter) => {\n        await formatter.Format(context, \n            ""Endpoint Function: It is sunny in LA"");\n});\napp.Run();\nThe factory function reads a value from the configuration data, which is converted into \na type and passed to the ActivatorUtilities.CreateInstance  method. Listing \n14.35 adds a configuration setting to the appsettings.Development.json  file that \nselects the HtmlResponseFormatter  class as the implementation for the IResponse-\nFormatter  service. The JSON configuration file is described in detail in chapter 15.\nListing 14.35    A setting in the appsettings.Development.json file in the Platform folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning""\n    }\n  },\n  ""services"": {\n    ""IResponseFormatter"": ""Platform.Services.HtmlResponseFormatter""\n  }\n}\nWhen a dependency on the IResponseFormatter  service is resolved, the factory func-\ntion creates an instance of the type specified in the configuration file. Restart ASP.NET \nCore and request the http://localhost:5000/endpoint/class  URL, which will produce \nthe response shown in figure 14.14.\nFigure 14.14   Using a service factory",5792
171-14.5.4 Creating services with multiple implementations.pdf,171-14.5.4 Creating services with multiple implementations,"379 Other dependency injection features\n14.5.4  Creating services with multiple implementations \nServices can be defined with multiple implementations, which allows a consumer to \nselect an implementation that best suits a specific problem. This is a feature that works \nbest when the service interface provides insight into the capabilities of each imple-\nmentation class. To provide information about the capabilities of the IResponse -\nFormatter  implementation classes, add the default property shown in listing 14.36 to \nthe interface.  \nListing 14.36    Adding a property in the IResponseFormatter.cs file in the Services \nfolder\nnamespace Platform.Services {\n    public interface IResponseFormatter {\n        Task Format(HttpContext context, string content);\n        public bool RichOutput => false;\n    }\n}\nThis RichOutput  property will be false  for implementation classes that don’t over-\nride the default value. To ensure there is one implementation that returns true , add \nthe property shown in listing 14.37 to the HtmlResponseFormatter  class.\nListing 14.37    Overriding in the HtmlResponseFormatter.cs file in the Services folder\nnamespace Platform.Services {\n    public class HtmlResponseFormatter : IResponseFormatter {\n        public async Task Format(HttpContext context, string content) {\n            context.Response.ContentType = ""text/html"";\n            await context.Response.WriteAsync($@""\n                <!DOCTYPE html>\n                <html lang=""""en"""">\n                <head><title>Response</title></head>\n                <body>\n                    <h2>Formatted Response</h2>\n                    <span>{content}</span>\n                </body>\n                </html>"");\n        }\n        public bool RichOutput => true;\n    }\n}\nListing 14.38 registers multiple implementations for the IResponseFormatter  ser-\nvice, which is done by making repeated calls to the Add<lifecycle>  method. The \nlisting also replaces the existing request pipeline with two routes that demonstrate how \nthe service can be used.\n380 chapter  14 Using dependency injection \nListing 14.38    Defining and using a service in the Program.cs file in the Platform folder\n//using Platform;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\n//IConfiguration config = builder.Configuration;\n//builder.Services.AddScoped<IResponseFormatter>(serviceProvider => {\n//    string? typeName = config[""services:IResponseFormatter""];\n//    return (IResponseFormatter)ActivatorUtilities\n//        .CreateInstance(serviceProvider, typeName == null\n//            ? typeof(GuidService) : Type.GetType(typeName, true)!);\n//});\n//builder.Services.AddScoped<ITimeStamper, DefaultTimeStamper>();\nbuilder.Services.AddScoped<IResponseFormatter, TextResponseFormatter>();\nbuilder.Services.AddScoped<IResponseFormatter, HtmlResponseFormatter>();\nbuilder.Services.AddScoped<IResponseFormatter, GuidService>();\nvar app = builder.Build();\n//app.UseMiddleware<WeatherMiddleware>();\n//app.MapEndpoint<WeatherEndpoint>(""endpoint/class"");\n//app.MapGet(""endpoint/function"", \n//    async (HttpContext context, IResponseFormatter formatter) => {\n//        await formatter.Format(context, \n//            ""Endpoint Function: It is sunny in LA"");\n//});\napp.MapGet(""single"", async context => {\n    IResponseFormatter formatter = context.RequestServices\n        .GetRequiredService<IResponseFormatter>();\n    await formatter.Format(context, ""Single service"");\n});\napp.MapGet(""/"", async context => {\n    IResponseFormatter formatter = context.RequestServices\n        .GetServices<IResponseFormatter>().First(f => f.RichOutput);\n    await formatter.Format(context, ""Multiple services"");\n});\napp.Run();\nThe AddScoped  statements register three services for the IResponseFormatter  inter-\nface, each with a different implementation class. The route for the /single  URL uses \nthe IServiceProvider.GetRequiredService<T>  method to request a service, like \nthis:\n...\ncontext.RequestServices. GetRequiredService <IResponseFormatter>();\n...",4104
172-14.5.5 Using unbound types in services.pdf,172-14.5.5 Using unbound types in services,"381 Other dependency injection features\nThis is a service consumer that is unaware that there are multiple implementations \navailable. The service is resolved using the most recently registered implementa-\ntion, which is the GuidService  class. Restart ASP.NET Core and request http://  \nlocalhost:5000/single, and you will see the output on the left side of figure 14.15.\nThe other endpoint is a service consumer that is aware that multiple implemen-\ntations may be available and that requests the service using the IServiceProvider \n. GetServices<T>  method.\n...\ncontext.RequestServices. GetServices <IResponseFormatter>()\n    .First(f => f.RichOutput);\n...\nThis method returns an IEnumerable<IResponseFormatter>  that enumerates the \navailable implementations. These are filtered using the LINQ First  method to select \nan implementation whose RichOutput  property returns true . If you request http://\nlocalhost:5000, you will see the output on the right of figure 14.15, showing that the \nendpoint has selected the service implementation that best suits its needs.\nFigure 14.15   Using multiple service implementations \n14.5.5  Using unbound types in services \nServices can be defined with generic type parameters that are bound to specific types \nwhen the service is requested, as shown in listing 14.39.  \nListing 14.39.   Using an unbound type in the Program.cs file in the Platform folder\n//using Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\n//builder.Services.AddScoped<IResponseFormatter, TextResponseFormatter>();\n//builder.Services.AddScoped<IResponseFormatter, HtmlResponseFormatter>();\n//builder.Services.AddScoped<IResponseFormatter, GuidService>();\nbuilder.Services.AddSingleton(typeof(ICollection<>), typeof(List<>));\nvar app = builder.Build();\n//app.MapGet(""single"", async context => {\n//    IResponseFormatter formatter = context.RequestServices\n//        .GetRequiredService<IResponseFormatter>();\n382 chapter  14 Using dependency injection \n//    await formatter.Format(context, ""Single service"");\n//});\n//app.MapGet(""/"", async context => {\n//    IResponseFormatter formatter = context.RequestServices\n//        .GetServices<IResponseFormatter>().First(f => f.RichOutput);\n//    await formatter.Format(context, ""Multiple services"");\n//});\napp.MapGet(""string"", async context => {\n    ICollection<string> collection = context.RequestServices\n        .GetRequiredService<ICollection<string>>();\n    collection.Add($""Request: {DateTime.Now.ToLongTimeString()}"");\n    foreach (string str in collection) {\n        await context.Response.WriteAsync($""String: {str}\n"");\n    }\n});\napp.MapGet(""int"", async context => {\n    ICollection<int> collection\n        = context.RequestServices.GetRequiredService<ICollection<int>>();\n    collection.Add(collection.Count() + 1);\n    foreach (int val in collection) {\n        await context.Response.WriteAsync($""Int: {val}\n"");\n    }\n});\napp.Run();\nThis feature relies on the versions of the AddSingleton , AddScoped , and Add-\nTransient  methods that accept types as conventional arguments and cannot be \nperformed using generic type arguments. The service in listing 14.39 is created with \nunbound types, like this:\n...\nservices.AddSingleton( typeof(ICollection<>), typeof(List<>) );\n...\nWhen a dependency on an ICollection<T>  service is resolved, a List<T>  object \nwill be created so that a dependency on ICollection<string> , for example, will be \nresolved using a List<string>  object. Rather than require separate services for each \ntype, the unbound service allows mappings for all generic types to be created. \nThe two endpoints in listing 14.39 request ICollection<string>  and  \nICollection<int>  services, each of which will be resolved with a different \nList<T>  object. To target the endpoints, restart ASP.NET Core and request http://\nlocalhost:5000/string and http://localhost:5000/int. The service has been defined \nas a singleton, which means that the same List<string>  and List<int>  objects will \nbe used to resolve all requests for ICollection<string>  and ICollection<int> . \nEach request adds a new item to the collection, which you can see by reloading the web \nbrowser, as shown in figure 14.16.",4273
173-15.1 Preparing for this chapter.pdf,173-15.1 Preparing for this chapter,"383 Summary\nFigure 14.16    Using a singleton service with an unbound type\nSummary\n¡ Dependency injection allows application components to declare dependencies \non services by defining constructor parameters.\n¡ Services can be defined with a type, an object, or a factory function.\n¡ The scope of a service determines when services are instantiated and how they \nare shared between components.\n¡ Dependency injection is integrated into the ASP.NET Core request pipeline.\n38415Using the platform  \nfeatures, part 1\nThis chapter covers\n¡ Understanding the built-in features provided by  \n ASP.NET Core \n¡ Accessing the application configuration\n¡ Storing secrets outside of the project folder\n¡ Logging messages\n¡ Generating static content and using client-side  \n packages\nASP.NET Core includes a set of built-in services and middleware components that \nprovide features that are commonly required by web applications. In this chapter, I \ndescribe three of the most important and widely used features: application configu-\nration, logging, and serving static content. In chapter 16, I continue to describe the \nplatform features, focusing on the more advanced built-in services and middleware. \nTable 15.1 puts the chapter in context.\n 385 Preparing for this chapter\nTable 15.1    Putting platform features in context\nQuestion Answer\nWhat are they? The platform features deal with common web appli-\ncation requirements, such as configuration, logging, \nstatic files, sessions, authentication, and database \naccess.\nWhy are they useful? Using these features means you don’t have to re-cre-\nate their functionality in your own projects.\nHow are they used? The built-in middleware components are added to \nthe request pipeline using extension methods whose \nname starts with Use. Services are set up using \nmethods that start with Add. \nAre there any pitfalls or \nlimitations?The most common problems relate to the order in \nwhich middleware components are added to the \nrequest pipeline. Middleware components form a \nchain along which requests pass, as described in \nchapter 12.\nAre there any alternatives? You don’t have to use any of the services or middle-\nware components that ASP.NET Core provides. \nTable 15.2 provides a guide to the chapter.\nTable 15.2    Chapter guide\nProblem Solution Listing\nAccessing the configuration \ndataUse the IConfiguration  service. 4–8\nSetting the application \nenvironmentUse the launch settings file. 9–11\nDetermining the application \nenvironment Use the IWebHostEnvironment  \nservice.12\nKeeping sensitive data \noutside of the projectCreate user secrets. 13–17\nLogging messages Use the ILogger<T>  service. 18–27\nDelivering static content Enable the static content middleware. 28–31\nDelivering client-side \npackagesInstall the package with LibMan \nand deliver it with the static content \nmiddleware. 32–35\n15.1 Preparing for this chapter\nIn this chapter, I continue to use the Platform project created in chapter 14. To pre-\npare for this chapter, update the Program.cs  file to remove middleware and services, \nas shown in listing 15.1.\n386 chapter  15 Using the platform features, part 1 \nListing 15.1    The contents of the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nOne of the main topics in this chapter is configuration data. Replace the contents of \nthe appsettings.Development.json  file with the contents of listing 15.2 to remove \nthe setting added in chapter 14.\nListing 15.2    The contents of the appsettings.Development.json file in the Platform \nfolder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Debug"",\n      ""System"": ""Information"",\n      ""Microsoft"": ""Information""\n    }\n  }\n}\nStart the application by opening a new PowerShell command prompt, navigating to \nthe Platform  project folder, and running the command shown in listing 15.3.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from  https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 15.3    Starting the ASP .NET Core runtime \ndotnet run\nOpen a new browser tab and navigate to http://localhost:5000; you will see the con-\ntent shown in figure 15.1.\nFigure 15.1    Running the example application",4541
174-15.2 Using the configuration service.pdf,174-15.2 Using the configuration service,,0
175-15.2.2 Accessing configuration settings.pdf,175-15.2.2 Accessing configuration settings,"387 Using the configuration service\n15.2 Using the configuration service\nOne of the built-in features provided by ASP.NET Core is access to the application’s \nconfiguration settings, which is presented as a service.  \nThe main source of configuration data is the appsettings.json  file. The  \napp settings.json  file created by the template used in chapter 12 contains the \nfollowing settings: \n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning""\n    }\n  },\n  ""AllowedHosts"": ""*""\n}\nThe configuration service will process the JSON configuration file and create nested \nconfiguration sections that contain individual settings. For the appsettings.json  file \nin the example application, the configuration service will create a Logging  configura-\ntion section that contains a LogLevel  section. The LogLevel  section will contain set-\ntings for Default  and Microsoft.AspnetCore . There will also be an AllowedHosts  \nsetting that isn’t part of a configuration section and whose value is an asterisk (the * \ncharacter).\nThe configuration service doesn’t understand the meaning of the configuration sec-\ntions or settings in the appsettings.json  file and is just responsible for processing the \nJSON data file and merging the configuration settings with the values obtained from \nother sources, such as environment variables or command-line arguments. The result is \na hierarchical set of configuration properties, as shown in figure 15.2.\nFigure 15.2    The hierarchy of configuration properties in the appsettings.json file \n15.2.1  Understanding the environment configuration file\nMost projects contain more than one JSON configuration file, allowing different \nsettings to be defined for different parts of the development cycle. There are three \npredefined environments, named Development , Staging , and Production , each of \nwhich corresponds to a commonly used phase of development. During startup, the \nconfiguration service looks for a JSON file whose name includes the current envi-\nronment. The default environment is Development , which means the configuration \n388 chapter  15 Using the platform features, part 1 \nservice will load the appsettings.Development.json  file and use its contents to sup-\nplement the contents of the main appsettings.json  file. \nNOTE    The Visual Studio Solution Explorer nests the appsettings.Development \n.json  file in the appsettings.json  item. You can expand the appsettings.\njson  file to see and edit the nested entries or click the button at the top of the \nSolution Explorer that disables the nesting feature.\nHere are the configuration settings added to the appsettings.Development.json  \nfile in listing 15.2:\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Debug"",\n      ""System"": ""Information"",\n      ""Microsoft"": ""Information""\n    }\n  }\n}\nWhere the same setting is defined in both files, the value in the appsettings \n. Development.json  file will replace the one in the appsettings.json  file, which \nmeans that the contents of the two JSON files will produce the hierarchy of configura-\ntion settings shown in figure 15.3.\nFigure 15.3    Merging JSON configuration settings\nThe effect of the additional configuration settings is to increase the detail level of \nlogging messages, which I describe in more detail in the “Using the Logging Service” \nsection.\n15.2.2  Accessing configuration settings\nThe configuration data is accessed through a service. If you only require the configura-\ntion data to configure middleware, then the dependency on the configuration service \ncan be declared using a parameter, as shown in listing 15.4.  \n 389 Using the configuration service\nListing 15.4    Accessing configuration data in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""config"", async (HttpContext context, \n        IConfiguration config) => {\n    string? defaultDebug = config[""Logging:LogLevel:Default""];\n    await context.Response\n        .WriteAsync($""The config setting is: {defaultDebug}"");\n});\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nConfiguration data is provided through the IConfiguration  interface; this interface \nis defined in the Microsoft.Extensions.Configuration  namespace and provides \nan API for navigating through the configuration hierarchy and reading configuration \nsettings. Configuration settings can be read by specifying the path through the config-\nuration sections, like this: \n...\nstring? defaultDebug = config[""Logging:LogLevel:Default""] ;\n...\nThis statement reads the value of the Default  setting, which is defined in the Log-\nLevel  section of the Logging  part of the configuration. The names of the configura-\ntion sections and the configuration settings are separated by colons (the : character). \nThe value of the configuration setting read in listing 15.4 is used to provide a result \nfor a middleware component that handles the /config  URL. Restart ASP.NET Core \nusing Control+C at the command prompt and run the command shown in listing 15.5 \nin the Platform  folder.\nListing 15.5    Starting the ASP .NET Core platform\ndotnet run\nOnce the runtime has restarted, navigate to the http://localhost:5000/config URL, \nand you will see the value of the configuration setting displayed in the browser tab, as \nshown in figure 15.4.\nFigure 15.4    \nReading \nconfiguration \ndata",5582
176-15.2.3 Using the configuration data in the Program.cs file.pdf,176-15.2.3 Using the configuration data in the Program.cs file,,0
177-15.2.4 Using configuration data with the options pattern.pdf,177-15.2.4 Using configuration data with the options pattern,"390 chapter  15 Using the platform features, part 1 \n15.2.3  Using the configuration data in the Program.cs file \nAs noted in chapter 14, the WebApplication  and WebApplicationBuilder  classes \nprovide a Configuration  property that can be used to obtain an implementation of the \nIConfiguration  interface, which is useful when using configuration data to configure \nan application’s services. Listing 15.6 shows both uses of configuration data.\nListing 15.6    Configuring services and pipeline in the Program.cs file in the Platform \nfolder\nvar builder = WebApplication.CreateBuilder(args);\nvar servicesConfig = builder.Configuration;\n// - use configuration settings to set up services\nvar app = builder.Build();\nvar pipelineConfig = app.Configuration;\n// - use configuration settings to set up pipeline\napp.MapGet(""config"", async (HttpContext context, \n        IConfiguration config) => {\n    string? defaultDebug = config[""Logging:LogLevel:Default""];\n    await context.Response\n        .WriteAsync($""The config setting is: {defaultDebug}"");\n});\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThis may seem like an unnecessary step because there is so little code in the Program \n.cs file in this example application, which makes it obvious that the configuration \nservice isn’t replaced. It isn’t always as obvious in a real project, where services can be \ndefined in groups by methods defined outside of the Program.cs  file, making it diffi-\ncult to see if these methods alter the IConfiguration  service.\n15.2.4  Using configuration data with the options pattern \nIn chapter 12, I described the options pattern, which is a useful way to configure mid-\ndleware components. A helpful feature provided by the IConfiguration  service is the \nability to create options directly from configuration data.\nTo prepare, add the configuration settings shown in listing 15.7 to the app settings \n.json  file. \nListing 15.7    Adding configuration data in the appsettings.json file in the Platform folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n 391 Using the configuration service\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""Location"": {\n    ""CityName"": ""Buffalo""\n  }\n}\nThe Location  section of the configuration file can be used to provide options pattern \nvalues, as shown in listing 15.8.\nListing 15.8    Using configuration data in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar servicesConfig = builder.Configuration;\nbuilder.Services.Configure<MessageOptions>(\n    servicesConfig.GetSection(""Location""));\nvar app = builder.Build();\nvar pipelineConfig = app.Configuration;\n// - use configuration settings to set up pipeline\napp.UseMiddleware<LocationMiddleware>();\napp.MapGet(""config"", async (HttpContext context, \n        IConfiguration config) => {\n    string? defaultDebug = config[""Logging:LogLevel:Default""];\n    await context.Response\n        .WriteAsync($""The config setting is: {defaultDebug}"");\n});\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThe configuration data is obtained using the GetSection  method and passed to the \nConfigure  method when the options are created. The configuration values in the \nselected section are inspected and used to replace the default values with the same \nnames in the options class. To see the effect, restart ASP.NET Core and use the browser \nto navigate to the http://localhost:5000/location URL. You will see the results shown \nin figure 15.5, where the CityName  option is taken from the configuration data and \nthe CountryName  option is taken from the default value in the options class.",3862
178-15.2.5 Understanding the launch settings file.pdf,178-15.2.5 Understanding the launch settings file,"392 chapter  15 Using the platform features, part 1 \nFigure 15.5    Using configuration data in the options pattern  \n15.2.5  Understanding the launch settings file \nThe launchSettings.json  file in the Properties  folder contains the configuration \nsettings for starting the ASP.NET Core platform, including the TCP ports that are used \nto listen for HTTP and HTTPS requests and the environment used to select the addi-\ntional JSON configuration files. \nTIP    Visual Studio often hides the Properties  folder. If you can’t see the folder, \nclick the Show All Files button at the top of the Solution Explorer to reveal the \nfolder and the launchSettings.json  file.\nHere is the content added to the launchSettings.json  file when the project was cre-\nated and then edited to set the HTTP ports:  \n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""Platform"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n} \n 393 Using the configuration service\nThe iisSettings  section is used to configure the HTTP and HTTPS ports used when \nthe ASP.NET Core platform is started through IIS Express, which is how older versions \nof ASP.NET Core were deployed.\nThe profiles  section describes a series of launch profiles, which define config-\nuration settings for different ways of running the application. The Platform  section \ndefines the configuration used by the dotnet run  command. The IIS Express  sec-\ntion defines the configuration used when the application is used with IIS Express. \nBoth profiles contain an environmentVariables  section, which is used to define \nenvironment variables that are added to the application’s configuration data. There is \nonly one environment variable defined by default: ASPNETCORE_ENVIRONMENT . \nDuring startup, the value of the ASPNETCORE_ENVIRONMENT  setting is used to select \nthe additional JSON configuration file so that a value of Development , for example, \nwill cause the appsettings.Development.json  file to be loaded. \nWhen the application is started within Visual Studio Code, ASPNETCORE_\nENVIRONMENT  is set in a different file. Select Run > Open Configurations to open the \nlaunch.json  file in the .vscode  folder, which is created when a project is edited with \nVisual Studio Code. Here is the default configuration for the example project, showing \nthe current ASPNETCORE_ENVIRONMENT  value, with the comments removed for brevity:  \n{\n    ""version"": ""0.2.0"",\n    ""configurations"": [\n        {\n  \n            ""name"": "".NET Core Launch (web)"",\n            ""type"": ""coreclr"",\n            ""request"": ""launch"",\n            ""preLaunchTask"": ""build"",\n            ""program"": ""${workspaceFolder}/bin/Debug/net7.0/Platform.dll"",\n            ""args"": [],\n            ""cwd"": ""${workspaceFolder}"",\n            ""stopAtEntry"": false,\n            ""serverReadyAction"": {\n                ""action"": ""openExternally"",\n                ""pattern"": ""\\bNow listening on:\\s+(https?://\\S+)""\n            },\n            ""env"": {\n                ""ASPNETCORE_ENVIRONMENT"": ""Development""\n            },\n            ""sourceFileMap"": {\n                ""/Views"": ""${workspaceFolder}/Views""\n            }\n        },\n        {\n            ""name"": "".NET Core Attach"",\n            ""type"": ""coreclr"",\n            ""request"": ""attach""\n        }\n    ]\n}\n394 chapter  15 Using the platform features, part 1 \nTo display the value of the ASPNETCORE_ENVIRONMENT  setting, add the statements to \nthe middleware component that responds to the /config  URL, as shown in listing 15.9.\nListing 15.9    Displaying the configuration in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar servicesConfig = builder.Configuration;\nbuilder.Services.Configure<MessageOptions>(\n    servicesConfig.GetSection(""Location""));\nvar app = builder.Build();\nvar pipelineConfig = app.Configuration;\napp.UseMiddleware<LocationMiddleware>();\napp.MapGet(""config"", async (HttpContext context, \n        IConfiguration config) => {\n    string? defaultDebug = config[""Logging:LogLevel:Default""];\n    await context.Response\n        .WriteAsync($""The config setting is: {defaultDebug}"");\n    string? environ = config[""ASPNETCORE_ENVIRONMENT""];\n    await context.Response.WriteAsync($""\nThe env setting is: {environ}"");\n});\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nRestart ASP.NET Core and navigate to http://localhost:5000/config, and you will see \nthe value of the ASPNETCORE_ENVIRONMENT  setting, as shown in figure 15.6. \nFigure 15.6    Displaying the environment configuration setting\nTo see the effect that the ASPNETCORE_ENVIRONMENT  setting has on the overall config-\nuration, change the value in the launchSettings.json  file, as shown in listing 15.10. \n 395 Using the configuration service\nListing 15.10    Changing the launchSettings.json file in the Platform/Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""Platform"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Production""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nIf you are using Visual Studio, you can change the environment variables by selecting \nDebug > Launch Profiles. The settings for each launch profile are displayed, and there \nis support for changing the value of the ASPNETCORE_ENVIRONMENT  variable, as shown \nin figure 15.7.\nFigure 15.7    \nChanging an \nenvironment variable \nusing Visual Studio\n396 chapter  15 Using the platform features, part 1 \nIf you are using Visual Studio Code, select Run > Open Configurations and change the \nvalue in the env section, as shown in listing 15.11.\nListing 15.11    Changing the launch.json file in the Platform/.vscode folder\n{\n    ""version"": ""0.2.0"",\n    ""configurations"": [\n        {\n            ""name"": "".NET Core Launch (web)"",\n            ""type"": ""coreclr"",\n            ""request"": ""launch"",\n            ""preLaunchTask"": ""build"",\n            ""program"": ""${workspaceFolder}/bin/Debug/net7.0/Platform.dll"",\n            ""args"": [],\n            ""cwd"": ""${workspaceFolder}"",\n            ""stopAtEntry"": false,\n            ""serverReadyAction"": {\n                ""action"": ""openExternally"",\n                ""pattern"": ""\\bNow listening on:\\s+(https?://\\S+)""\n            },\n            ""env"": {\n                ""ASPNETCORE_ENVIRONMENT"": ""Production""\n            },\n            ""sourceFileMap"": {\n                ""/Views"": ""${workspaceFolder}/Views""\n            }\n        },\n        {\n            ""name"": "".NET Core Attach"",\n            ""type"": ""coreclr"",\n            ""request"": ""attach""\n        }\n    ]\n}\nSave the changes to the property page or configuration file and restart ASP.NET Core. \nNavigate to http://localhost:5000/config, and you will see the effect of the environ-\nment change, as shown in figure 15.8. \nFigure 15.8    The effect of changing the environment configuration setting\nNotice that both configuration values displayed in the browser have changed. \nThe appsettings.Development.json  file is no longer loaded, and there is no",8203
179-15.2.7 Storing user secrets.pdf,179-15.2.7 Storing user secrets,"397 Using the configuration service\nappsettings.Production.json  file in the project, so only the configuration settings \nin the appsettings.json file are used.\n15.2.6  Using the environment service\nThe ASP.NET Core platform provides the IWebHostEnvironment  service for deter-\nmining the current environment, which avoids the need to get the configuration \nsetting manually. The IWebHostEnvironment  service defines the property and meth-\nods shown in table 15.3. The methods are extension methods that are defined in the  \nMicrosoft.Extensions.Hosting  namespace.  \nTable 15.3    The IWebHostEnvironment extension methods\nName Description\nEnvironmentName This property returns the current environment.\nIsDevelopment() This method returns true  when the Development  \nenvironment has been selected.\nIsStaging() This method returns true  when the Staging  envi-\nronment has been selected.\nIsProduction() This method returns true  when the Production  \nenvironment has been selected.\nIsEnvironment(env) This method returns true  when the environment \nspecified by the argument has been selected.\nIf you need to access the environment when setting up services, then you can use the \nWebApplicationBuilder.Environment property. If you need to access the environ-\nment when configuring the pipeline, you can use the WebApplication.  Environment \nproperty. If you need to access the environment within a middleware component \nor endpoint, then you can define a IWebHostEnvironment  parameter. All three \napproaches are shown in listing 15.12.\nListing 15.12    Accessing the environment in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar servicesConfig = builder.Configuration;\nbuilder.Services.Configure<MessageOptions>(\n    servicesConfig.GetSection(""Location""));\nvar servicesEnv = builder.Environment;\n// - use environment to set up services\nvar app = builder.Build();\nvar pipelineConfig = app.Configuration;\n// - use configuration settings to set up pipeline\nvar pipelineEnv = app.Environment;\n398 chapter  15 Using the platform features, part 1 \n// - use envirionment to set up pipeline\napp.UseMiddleware<LocationMiddleware>();\napp.MapGet(""config"", async (HttpContext context,\n        IConfiguration config, IWebHostEnvironment env) => {\n    string? defaultDebug = config[""Logging:LogLevel:Default""];\n    await context.Response\n        .WriteAsync($""The config setting is: {defaultDebug}"");\n    await context.Response\n        .WriteAsync($""\nThe env setting is: {env.EnvironmentName}"");\n});\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nRestart ASP.NET Core and use a browser to request http://localhost:5000/config, \nwhich produces the output shown in figure 15.8.\n15.2.7  Storing user secrets\nDuring development, it is often necessary to use sensitive data to work with the ser-\nvices that an application depends on. This data can include API keys, database con-\nnection passwords, or default administration accounts, and it is used both to access \nservices and to reinitialize them to test application changes with a fresh database or \nuser configuration. \nIf the sensitive data is included in the C# classes or JSON configuration files, it will be \nchecked into the source code version control repository and become visible to all devel-\nopers and to anyone else who can see the code—which may mean visible to the world \nfor projects that have open repositories or repositories that are poorly secured.\nThe user secrets service allows sensitive data to be stored in a file that isn’t part of \nthe project and won’t be checked into version control, allowing each developer to have \nsensitive data that won’t be accidentally exposed through a version control check-in.  \nstoring  user secrets  \nThe first step is to prepare the file that will be used to store sensitive data. Run the com-\nmand shown in listing 15.13 in the Platform  folder.  \nListing 15.13    Initializing user secrets \ndotnet user-secrets init\nThis command adds an element to the Platform.csproj  project file that contains \na unique ID for the project that will be associated with the secrets on each developer \nmachine. Next, run the commands shown in listing 15.14 in the Platform  folder.  \n 399 Using the configuration service\nListing 15.14    Storing a user secret\ndotnet user-secrets set ""WebService:Id"" ""MyAccount""\ndotnet user-secrets set ""WebService:Key"" ""MySecret123$""\nEach secret has a key and a value, and related secrets can be grouped together by using \na common prefix, followed by a colon (the : character), followed by the secret name. \nThe commands in listing 15.14 create related Id and Key secrets that have the Web-\nService  prefix.\nAfter each command, you will see a message confirming that a secret has been added \nto the secret store. To check the secrets for the project, use the command prompt to \nrun the command shown in listing 15.15 in the Platform  folder.  \nListing 15.15    Listing the user secrets\ndotnet user-secrets list\nThis command produces the following output:\nWebService:Key = MySecret123$\nWebService:Id = MyAccount\nBehind the scenes, a JSON file has been created in the %APPDATA%\Microsoft\User-\nSecrets  folder (or the ~/.microsoft/usersecrets  folder for Linux) to store the \nsecrets. Each project has its own folder (whose name corresponds to the unique ID \ncreated by the init  command in listing 15.13). \nTIP    If you are using Visual Studio, you can create and edit the JSON file directly \nby right-clicking the project in the Solution Explorer and selecting Manage User \nSecrets from the pop-up menu. \nreading  user secrets\nUser secrets are merged with the normal configuration settings and accessed in the \nsame way. In listing 15.16, I have added a statement that displays the secrets to the mid-\ndleware component that handles the /config  URL.  \nListing 15.16    Using user secrets in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar servicesConfig = builder.Configuration;\nbuilder.Services.Configure<MessageOptions>(\n    servicesConfig.GetSection(""Location""));\nvar servicesEnv = builder.Environment;\n// - use environment to set up services\nvar app = builder.Build();\nvar pipelineConfig = app.Configuration;\n400 chapter  15 Using the platform features, part 1 \n// - use configuration settings to set up pipeline\nvar pipelineEnv = app.Environment;\n// - use envirionment to set up pipeline\napp.UseMiddleware<LocationMiddleware>();\napp.MapGet(""config"", async (HttpContext context,\n        IConfiguration config, IWebHostEnvironment env) => {\n    string? defaultDebug = config[""Logging:LogLevel:Default""];\n    await context.Response\n        .WriteAsync($""The config setting is: {defaultDebug}"");\n    await context.Response\n        .WriteAsync($""\nThe env setting is: {env.EnvironmentName}"");\n    string? wsID = config[""WebService:Id""];\n    string? wsKey = config[""WebService:Key""];\n    await context.Response.WriteAsync($""\nThe secret ID is: {wsID}"");\n    await context.Response.WriteAsync($""\nThe secret Key is: {wsKey}"");\n});\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nUser secrets are loaded only when the application is set to the Development  environ-\nment. Edit the launchSettings.json  file to change the environment to Development , \nas shown in listing 15.17.\nListing 15.17    Changing the launchSettings.json file in the Platform/Properties folder \n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""Platform"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {",8270
180-15.3 Using the logging service.pdf,180-15.3 Using the logging service,,0
181-15.3.1 Generating logging messages.pdf,181-15.3.1 Generating logging messages,"401 Using the logging service \n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nSave the changes, restart the ASP.NET Core runtime using the dotnet run  command, \nand request the http://localhost:5000/config URL to see the user secrets, as shown in \nfigure 15.9.\nFigure 15.9    Displaying user secrets\n15.3 Using the logging service \nASP.NET Core provides a logging service that can be used to record messages that \ndescribe the state of the application to track errors, monitor performance, and help \ndiagnose problems. \nLog messages are sent to logging providers, which are responsible for forwarding \nmessages to where they can be seen, stored, and processed. There are built-in providers \nfor basic logging, and there is a range of third-party providers available for feeding mes-\nsages into logging frameworks that allow messages to be collated and analyzed.  \nThree of the built-in providers are enabled by default: the console provider, the \ndebug provider, and the EventSource  provider. The debug provider forwards mes-\nsages so they can be processed through the System.Diagnostics.Debug  class, and \nthe EventSource  provider forwards messages for event tracing tools, such as PerfView  \n(https://github.com/Microsoft/perfview ). I use the console provider in this chapter \nbecause it is simple and doesn’t require any additional configuration to display logging \nmessages.  \nTIP    You can see the list of providers available and instructions for enabling them \nat https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging .\n15.3.1  Generating logging messages \nTo prepare for this section, listing 15.18 reconfigures the application to remove the \nservices, middleware, and endpoints from the previous section.\n402 chapter  15 Using the platform features, part 1 \nListing 15.18    Configuring the application in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""population/{city?}"", Population.Endpoint);\napp.Run();\nLogging messages are generated using the unbounded ILogger<>  service, as shown in \nlisting 15.19.\nListing 15.19    Generating logging messages in the Population.cs file in the Platform \nfolder\nnamespace Platform {\n    public class Population {\n        public static async Task Endpoint(HttpContext context,\n                ILogger<Population> logger) {\n            logger.LogDebug(""Started processing for {path}"",\n                context.Request.Path);\n            string city = context.Request.RouteValues[""city""] \n                as string ?? ""london"";\n            int? pop = null;\n            switch (city.ToLower()) {\n                case ""london"":\n                    pop = 8_136_000;\n                    break;\n                case ""paris"":\n                    pop = 2_141_000;\n                    break;\n                case ""monaco"":\n                    pop = 39_000;\n                    break;\n            }\n            if (pop.HasValue) {\n                await context.Response\n                    .WriteAsync($""City: {city}, Population: {pop}"");\n            } else {\n                context.Response.StatusCode \n                    = StatusCodes.Status404NotFound;\n            }\n            logger.LogDebug(""Finished processing for {path}"", \n                context.Request.Path);\n        }\n    }\n}\nThe logging service groups log messages together based on the category assigned \nto messages. Log messages are written using the ILogger<T>  interface, where the \ngeneric parameter T is used to specify the category. The convention is to use the type \n 403 Using the logging service \nof the class that generates the messages as the category type, which is why listing 15.19 \ndeclares a dependency on the service using Population  for the type argument, like \nthis:\n...\npublic static async Task Endpoint(HttpContext context,  \n    ILogger<Population>  logger) {\n...\nThis ensures that log messages generated by the Endpoint  method will be assigned the \ncategory Population . Log messages are created using the extension methods shown \nin table 15.4.  \nTable 15.4    The ILogger<T> extension methods\nName Description\nLogTrace This method generates a Trace -level message, used \nfor low-level debugging during  development.\nLogDebug This method generates a Debug -level message, used \nfor low-level debugging during development or produc-\ntion problem resolution.\nLogInformation This method generates an Information -level mes-\nsage, used to provide information about the general \nstate of the application.\nLogWarning This method generates a Warning -level message, \nused to record unexpected, but minor, problems that \nare unlikely to disrupt the application.\nLogError This method generates an Error -level message, used \nto record exceptions or errors that are not handled by \nthe application.\nLogCritical This method generates a Critical -level message, \nused to record serious failures.\nLog messages are assigned a level that reflects their importance and detail. The levels \nrange from Trace , for detailed diagnostics, to Critical , for the most important infor-\nmation that requires an immediate response. There are overloaded versions of each \nmethod that allow log messages to be generated using strings or exceptions. In listing \n15.19, I used the LogDebug method to generate logging messages when a request is \nhandled.\n...\nlogger.LogDebug (""Started processing for {path}"", context.Request.Path);\n...\nThe result is log messages at the Debug level that are generated when the response \nis started and completed. To see the log messages, restart ASP.NET Core and use a \nbrowser to request http://localhost:5000/population. Look at the console output, and \nyou will see the log messages in the output from ASP.NET Core, like this:\nBuilding...\ninfo: Microsoft.Hosting.Lifetime[14]\n      Now listening on: http://localhost:5000\n404 chapter  15 Using the platform features, part 1 \ninfo: Microsoft.Hosting.Lifetime[0]\n      Application started. Press Ctrl+C to shut down.\ninfo: Microsoft.Hosting.Lifetime[0]\n      Hosting environment: Development\ninfo: Microsoft.Hosting.Lifetime[0]\n      Content root path: C:\Platform\ndbug: Platform.Population[0]\n      Started processing for /population\ndbug: Platform.Population[0]\n      Finished processing for /population\nlogging  messages  in the program .cs file \nThe Logger<>  service is useful for logging in classes but isn’t suited to logging in the \nProgram.cs  file, where top-level statements are used to configure the application. The \nsimplest approach is to use the ILogger  returned by the Logger  property defined by \nthe WebApplication  class, as shown in listing 15.20.\nListing 15.20    Logging in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.Logger.LogDebug(""Pipeline configuration starting"");\napp.MapGet(""population/{city?}"", Population.Endpoint);\napp.Logger.LogDebug(""Pipeline configuration complete"");\napp.Run();\nThe ILogger  interface defines all the methods described in table 15.4. Start ASP.NET \nCore, and you will see the logging messages in the startup output, like this:\nBuilding...\ndbug: Platform[0]\n      Pipeline configuration starting\ndbug: Platform[0]\n      Pipeline configuration complete\ninfo: Microsoft.Hosting.Lifetime[14]\n      Now listening on: http://localhost:5000\ninfo: Microsoft.Hosting.Lifetime[0]\n      Application started. Press Ctrl+C to shut down.\ninfo: Microsoft.Hosting.Lifetime[0]\n      Hosting environment: Development\ninfo: Microsoft.Hosting.Lifetime[0]\n      Content root path: C:\Platform\nThe category for logging messages generated using the ILogger  provided by the \nWebApplication  class is the name of the application, which is Platform  for this exam-\nple. If you want to generate log messages with a different category, which can be useful \nin lambda functions, for example, then you can use the ILoggerFactory  interface,",8144
182-15.3.2 Logging messages with attributes.pdf,182-15.3.2 Logging messages with attributes,"405 Using the logging service \nwhich is available as a service, and call the CreateLogger  method to obtain an  \nILogger  for a specified category, as shown in listing 15.21.\nListing 15.21    Creating a logger in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\nvar logger = app.Services\n       .GetRequiredService<ILoggerFactory>().CreateLogger(""Pipeline"");\nlogger.LogDebug(""Pipeline configuration starting"");\napp.MapGet(""population/{city?}"", Population.Endpoint);\nlogger.LogDebug(""Pipeline configuration complete"");\napp.Run();\nRestart ASP.NET Core, and you will see the following messages in the output produced \nas the application starts:\nBuilding...\ndbug: Pipeline[0]\n      Pipeline configuration starting\ndbug: Pipeline[0]\n      Pipeline configuration complete\ninfo: Microsoft.Hosting.Lifetime[14]\n      Now listening on: http://localhost:5000\ninfo: Microsoft.Hosting.Lifetime[0]\n      Application started. Press Ctrl+C to shut down.\ninfo: Microsoft.Hosting.Lifetime[0]\n      Hosting environment: Development\ninfo: Microsoft.Hosting.Lifetime[0]\n      Content root path: C:\Platform\n15.3.2  Logging messages with attributes \nAn alternative approach to generating log messages is to use the LoggerMessage  attri-\nbute, as shown in listing 15.22.  \nListing 15.22    Using the attribute in the Population.cs file in the Platform folder\nnamespace Platform {\n    public partial class Population {\n        public static async Task Endpoint(HttpContext context,\n                ILogger<Population> logger) {\n            //logger.LogDebug(""Started processing for {path}"",\n            //    context.Request.Path);\n            StartingResponse(logger, context.Request.Path);\n            string city = context.Request.RouteValues[""city""] \n                as string ?? ""london"";\n406 chapter  15 Using the platform features, part 1 \n            int? pop = null;\n            switch (city.ToLower()) {\n                case ""london"":\n                    pop = 8_136_000;\n                    break;\n                case ""paris"":\n                    pop = 2_141_000;\n                    break;\n                case ""monaco"":\n                    pop = 39_000;\n                    break;\n            }\n            if (pop.HasValue) {\n                await context.Response\n                    .WriteAsync($""City: {city}, Population: {pop}"");\n            } else {\n                context.Response.StatusCode \n                    = StatusCodes.Status404NotFound;\n            }\n            logger.LogDebug(""Finished processing for {path}"", \n                context.Request.Path);\n        }\n        [LoggerMessage(0, LogLevel.Debug, ""Starting response for {path}"")]\n        public static partial void StartingResponse(ILogger logger, \n            string path);\n    }\n}\nThe LoggerMessage  attribute is applied to partial  methods, which must be defined \nin partial  classes. When the application is compiled, the attribute generates the \nimplementation for the method to which it is applied, resulting in logging, which \nMicrosoft says offers better performance than the other techniques described in this \nsection. Full details of how this feature works can be found at https://docs.microsoft \n.com/en-us/dotnet/core/extensions/logger-message-generator . \nNOTE    I do not doubt Microsoft’s assertion that using the LoggerMessage  attri-\nbute is faster, but I doubt it matters for most projects. Use the attribute if you \nfind this approach easier to understand and maintain, but don’t rush to adopt \nit just for the sake of a performance gain unless you have an application that \ndoesn’t meet its performance goals and you are sure that logging performance \nis contributing to the problem. I am confident that this will never be the case for \nmost projects because of the nature of most web applications, but please get in \ntouch if you find yourself in this position because I am always willing to have my \nassumptions proven wrong.\nStart ASP.NET Core and use a browser to request http://localhost:5000/population, \nand the output will include the following log messages:\ndbug: Platform.Population[0]\n      Starting response for /population\ndbug: Platform.Population[0]\n      Finished processing for /population",4369
183-15.3.3 Configuring minimum logging levels.pdf,183-15.3.3 Configuring minimum logging levels,"407 Using the logging service \n15.3.3  Configuring minimum logging levels\nEarlier in this chapter, I showed you the default contents of the appsettings.json  \nand appsettings.Development.json  files and explained how they are merged to \ncreate the application’s configuration settings. The settings in the JSON file are used \nto configure the logging service, which ASP.NET Core provides to record messages \nabout the state of the application.\nThe Logging:LogLevel  section of the appsettings.json  file is used to set the \nminimum level for logging messages. Log messages that are below the minimum level \nare discarded. The appsettings.json  file contains the following levels:  \n...\n""Default"": ""Information"",\n""Microsoft.AspNetCore"": ""Warning""\n...\nThe category for the log messages—which is set using the generic type argument or \nusing a string—is used to select a minimum filter level. \nFor the log messages generated by the Population  class, for example, the category \nwill be Platform.Population , which means that they can be matched directly by add-\ning a Platform.Population entry to the appsettings.json  file or indirectly by spec-\nifying just the Platform  namespace. Any category for which there is no minimum log \nlevel is matched by the Default  entry, which is set to Information .\nIt is common to increase the detail of the log messages displayed during develop-\nment, which is why the levels in the appsettings.Development.json  file specify more \ndetailed logging levels, like this:\n...\n""Default"": ""Debug"",\n""System"": ""Information"",\n""Microsoft"": ""Information""\n...\nWhen the application is configured for the Development  environment, the default \nlogging level is Debug . The levels for the System  and Microsoft  categories are set to \nInformation , which affects the logging messages generated by ASP.NET Core and the \nother packages and frameworks provided by Microsoft.\nYou can tailor the logging levels to focus the log on those parts of the application \nthat are of interest by setting a level to Trace , Debug , Information , Warning , Error , or \nCritical . Logging messages can be disabled for a category using the None  value.\nListing 15.23 sets the level to Debug  for the Microsoft.AspNetCore  setting, which \nwill increase the default level of detail and will have the effect of displaying debug-level \nmessages generated by ASP.NET Core. \nTIP    If you are using Visual Studio, you may have to expand the appsettings \n.json  item in the Solution Explorer to see the appsettings.Development \n.json  file.\n408 chapter  15 Using the platform features, part 1 \nListing 15.23    Configuring the appsettings.Development.json file in the Platform folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Debug"",\n      ""System"": ""Information"",\n      ""Microsoft"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Debug""\n    }\n  }\n}\nRestart ASP.NET Core and request the http://localhost:5000/population URL, and \nyou will see a series of messages from the different ASP.NET Core components. You \ncan reduce the detail by being more specific about the namespace for which messages \nare required, as shown in listing 15.24.\nListing 15.24    Configuring the appsettings.Development.json file in the Platform folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Debug"",\n      ""System"": ""Information"",\n      ""Microsoft"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning"",\n      ""Microsoft.AspNetCore.Routing"": ""Debug""\n    }\n  }\n}\nThe changes return the Microsoft.AspNetCore  category to Warning  and set the  \nMicrosoft.AspNetCore.Routing  category to Debug , which increases the detail level \nfor logging messages by the components responsible for routing. Restart ASP.NET \nCore and request http://localhost:5000/population again, and you will see fewer mes-\nsages overall, but still see those that report how the request was matched to a route:\n...\ndbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1001]\n      1 candidate(s) found for the request path '/population'\ndbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1005]\n      Endpoint 'HTTP: GET population/{city?} =>  \n        Endpoint' with route pattern 'population/{city?}' is valid  \n        for the request path '/population'\ndbug: Microsoft.AspNetCore.Routing.EndpointRoutingMiddleware[1]\n      Request matched endpoint 'HTTP: GET population/{city?} => Endpoint'\ninfo: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]\n      Executing endpoint 'HTTP: GET population/{city?} => Endpoint'\ndbug: Platform.Population[0]\n      Starting response for /population\ndbug: Platform.Population[0]\n      Finished processing for /population\ninfo: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]\n      Executed endpoint 'HTTP: GET population/{city?} => Endpoint'\n...",4848
184-15.3.4 Logging HTTP requests and responses.pdf,184-15.3.4 Logging HTTP requests and responses,"409 Using the logging service \nIf you are having trouble figuring out a routing scheme, then these messages can be \nhelpful in figuring out what the application is doing with requests.\n15.3.4  Logging HTTP requests and responses\nASP.NET Core includes built-in middleware for generating log messages that describe \nthe HTTP requests received by an application and the responses it produces. Listing \n15.25 adds the HTTP logging middleware to the request pipeline.\nListing 15.25    Adding logging middleware in the Program.cs file in the Platform folder\nusing Platform;\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.UseHttpLogging();\n//var logger = app.Services\n//  .GetRequiredService<ILoggerFactory>().CreateLogger(""Pipeline"");\n//logger.LogDebug(""Pipeline configuration starting"");\napp.MapGet(""population/{city?}"", Population.Endpoint);\n//logger.LogDebug(""Pipeline configuration complete"");\napp.Run();\nThe UseHttpLogging  method adds a middleware component that generates logging \nmessages that describe the HTTP requests and responses. These log messages are gen-\nerated with the Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware  \ncategory and the Information  severity, which I have enabled in listing 15.26.\nListing 15.26    Logging in the appsettings.Development.json file in the Platform folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Debug"",\n      ""System"": ""Information"",\n      ""Microsoft"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning"",\n      ""Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware"": \n          ""Information""\n    }\n  }\n}\nRestart ASP.NET Core and request http://localhost:5000/population, and you will see \nlogging messages that describe the HTTP request sent by the browser and the response \nthe application produces, similar to the following:\n410 chapter  15 Using the platform features, part 1 \n...\ninfo: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[1]\n      Request:\n      Protocol: HTTP/1.1\n      Method: GET\n      Scheme: http\n      PathBase:\n      Path: /population\n      Accept: text/html,application/xhtml+xml,application/xml;q=0.9, \n          image/avif,image/webp,image/apng,*/*;q=0.8,\n          application/signed-exchange;v=b3;q=0.9\n      Connection: keep-alive\n      Host: localhost:5000\n      User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)  \n          AppleWebKit/537.36 (KHTML, like Gecko)  \n          Chrome/94.0.4606.71 Safari/537.36\n      Accept-Encoding: gzip, deflate, br\n      Accept-Language: en-GB,en-US;q=0.9,en;q=0.8\n      Cache-Control: [Redacted]\n      Cookie: [Redacted]\n      Upgrade-Insecure-Requests: [Redacted]\n      sec-ch-ua: [Redacted]\n      sec-ch-ua-mobile: [Redacted]\n      sec-ch-ua-platform: [Redacted]\n      Sec-Fetch-Site: [Redacted]\n      Sec-Fetch-Mode: [Redacted]\n      Sec-Fetch-User: [Redacted]\n      Sec-Fetch-Dest: [Redacted]\ndbug: Platform.Population[0]\n      Starting response for /population\ndbug: Platform.Population[0]\n      Finished processing for /population\ninfo: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[2]\n      Response:\n      StatusCode: 200\n      Date: [Redacted]\n      Server: [Redacted]\n      Transfer-Encoding: chunked\n...\nThe details of the HTTP request and response logging messages can be configured \nusing the AddHttpLogging  method, as shown in listing 15.27.\nListing 15.27    HTTP logging messages in the Program.cs file in the Platform folder\nusing Platform;\nusing Microsoft.AspNetCore.HttpLogging;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddHttpLogging(opts => {\n    opts.LoggingFields = HttpLoggingFields.RequestMethod\n        | HttpLoggingFields.RequestPath \n        | HttpLoggingFields.ResponseStatusCode;\n});",3819
185-15.4.1 Adding the static content middleware.pdf,185-15.4.1 Adding the static content middleware,"411 Using static content and client-side packages \nvar app = builder.Build();\napp.UseHttpLogging();\napp.MapGet(""population/{city?}"", Population.Endpoint);\napp.Run();\nThis method selects the fields and headers that are included in the logging mes-\nsage. The configuration in listing 15.27 selects the method and path from the HTTP \nrequest and the status code from the response. See https://docs.microsoft.com/\nen-us/aspnet/core/fundamentals/http-logging  for the complete set of configuration \noptions for HTTP logging. \nRestart ASP.NET Core and request http://localhost:5000/population, and you will \nsee the selected details in the output:\n...\ninfo: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[1]\n      Request:\n      Method: GET\n      PathBase:\n      Path: /population\ndbug: Platform.Population[0]\n      Starting response for /population\ndbug: Platform.Population[0]\n      Finished processing for /population\ninfo: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[2]\n      Response:\n      StatusCode: 200\n...\nNOTE     ASP.NET Core also provides middleware that will generate log messages \nin the W3C format. See https://docs.microsoft.com/en-us/aspnet/core/  \nfundamentals/w3c-logger  for details.\n15.4 Using static content and client-side packages \nMost web applications rely on a mix of dynamically generated and static content. \nThe dynamic content is generated by the application based on the user’s identity and \nactions, such as the contents of a shopping cart or the detail of a specific product and \nis generated fresh for each request. I describe the different ways that dynamic content \ncan be created using ASP.NET Core in part 3.  \nStatic content doesn’t change and is used to provide images, CSS stylesheets, Java -\nScript files, and anything else on which the application relies but which doesn’t have to \nbe generated for every request. The conventional location for static content in an ASP.\nNET Core project is the wwwroot  folder. \nTo prepare static content to use in the examples for this section, create the  \nPlatform/wwwroot  folder and add to it a file called static.html , with the content \nshown in listing 15.28. You can create the file with the HTML Page template if you are \nusing Visual Studio .\n412 chapter  15 Using the platform features, part 1 \nListing 15.28    The contents of the static.html file in the wwwroot folder\n<!DOCTYPE html>\n<html lang=""en"">\n<head>\n    <title>Static Content</title>\n</head>\n<body>\n    <h3>This is static content</h3>\n</body>\n</html>\nThe file contains a basic HTML document with just the basic elements required to dis-\nplay a message in the browser. \n15.4.1  Adding the static content middleware \nASP.NET Core provides a middleware component that handles requests for static con-\ntent, which is added to the request pipeline in listing 15.29.  \nListing 15.29    Adding middleware in the Program.cs file in the Platform folder\nusing Platform;\nusing Microsoft.AspNetCore.HttpLogging;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddHttpLogging(opts => {\n    opts.LoggingFields = HttpLoggingFields.RequestMethod\n        | HttpLoggingFields.RequestPath \n        | HttpLoggingFields.ResponseStatusCode;\n});\nvar app = builder.Build();\napp.UseHttpLogging();\napp.UseStaticFiles();\napp.MapGet(""population/{city?}"", Population.Endpoint);\napp.Run();\nThe UseStaticFiles  extension method adds the static file middleware to the request \npipeline. This middleware responds to requests that correspond to the names of disk \nfiles and passes on all other requests to the next component in the pipeline. This mid-\ndleware is usually added close to the start of the request pipeline so that other compo-\nnents don’t handle requests that are for static files.\nRestart ASP.NET Core and navigate to http://localhost:5000/static.html. The static \nfile middleware will receive the request and respond with the contents of the static \n.html  file in the wwwroot  folder, as shown in figure 15.10. \n 413 Using static content and client-side packages \nFigure 15.10    Serving static content\nThe middleware component returns the content of the requested file and sets the \nresponse headers, such as Content-Type  and Content-Length , that describe the con-\ntent to the browser. \nchanging  the default  options  for the static  content  middleware\nWhen the UseStaticFiles  method is invoked without arguments, the middleware \nwill use the wwwroot  folder to locate files that match the path of the requested URL. \nThis behavior can be adjusted by passing a StaticFileOptions  object to the Use-\nStaticFiles  method. Table 15.5 describes the properties defined by the StaticFile -\nOptions  class.  \nTable 15.5    The properties defined by the StaticFileOptions class\nName Description\nContentTypeProvider This property is used to get or set the IContentType -\nProvider  object that is responsible for producing the \nMIME type for a file. The default implementation of the \ninterface uses the file extension to determine the content \ntype and supports the most common file types.\nDefaultContentType This property is used to set the default content type if the \nIContentTypeProvider  cannot determine the type of \nthe file.\nFileProvider This property is used to locate the content for requests, as \nshown in the listing below.\nOnPrepareResponse This property can be used to register an action that will be \ninvoked before the static content response is generated.\nRequestPath This property is used to specify the URL path that the mid-\ndleware will respond to, as shown in the following listing.\nServeUnknownFileTypes By default, the static content middleware will not serve \nfiles whose content type cannot be determined by the \nIContentTypeProvider . This behavior is changed by \nsetting this property to true .\nThe FileProvider  and RequestPath  properties are the most commonly used. The \nFileProvider  property is used to select a different location for static content, and the \nRequestPath  property is used to specify a URL prefix that denotes requests for static \ncontext. Listing 15.30 uses both properties to configure the static file middleware.\n414 chapter  15 Using the platform features, part 1 \nTIP    There is also a version of the UseStaticFiles  method that accepts a single \nstring argument, which is used to set the RequestPath  configuration property. \nThis is a convenient way of adding support for URLs without needing to create \nan options object.\nListing 15.30    Configuring the static files in the Program.cs file in the Platform folder\nusing Platform;\nusing Microsoft.AspNetCore.HttpLogging;\nusing Microsoft.Extensions.FileProviders;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddHttpLogging(opts => {\n    opts.LoggingFields = HttpLoggingFields.RequestMethod\n        | HttpLoggingFields.RequestPath \n        | HttpLoggingFields.ResponseStatusCode;\n});\nvar app = builder.Build();\napp.UseHttpLogging();\napp.UseStaticFiles();\nvar env = app.Environment;\napp.UseStaticFiles(new StaticFileOptions {\n    FileProvider = new\n        PhysicalFileProvider($""{env.ContentRootPath}/staticfiles""),\n    RequestPath = ""/files""\n});\napp.MapGet(""population/{city?}"", Population.Endpoint);\napp.Run();\nMultiple instances of the middleware component can be added to the pipeline, each \nof which handles a separate mapping between URLs and file locations. In the listing, \na second instance of the static files middleware is added to the request pipeline so that \nrequests for URLs that start with /files  will be handled using files from a folder named \nstaticfiles . Reading files from the folder is done with an instance of the Physical-\nFileProvider  class, which is responsible for reading disk files. The PhysicalFile-\nProvider  class requires an absolute path to work with, which I based on the value \nof the ContentRootPath  property defined by the IWebHostEnvironment  interface, \nwhich is the same interface used to determine whether the application is running in \nthe Development  or Production  environment.\nTo provide content for the new middleware component to use, create the  \nPlatform­ /staticfiles  folder and add to it an HTML file named hello.html  with the \ncontent shown in listing 15.31.",8365
186-15.4.2 Using client-side packages.pdf,186-15.4.2 Using client-side packages,"415 Using static content and client-side packages \nListing 15.31    The contents of the hello.html file in the Platform/staticfiles folder\n<!DOCTYPE html>\n<html lang=""en"">\n<head>\n    <title>Static Content</title>\n</head>\n<body>\n    <h3>This is additional static content</h3>\n</body>\n</html>\nRestart ASP.NET Core and use the browser to request the http://localhost:5000/files/\nhello.html URL. Requests for URLs that begin with /files  and that correspond to \nfiles in the staticfiles  folder are handled by the new middleware, as shown in figure \n15.11.\nFigure 15.11    Configuring the static files middleware\n15.4.2  Using client-side packages \nMost web applications rely on client-side packages to support the content they gen-\nerate, using CSS frameworks to style content or JavaScript packages to create rich \nfunctionality in the browser. Microsoft provides the Library Manager tool, known as \nLibMan, for downloading and managing client-side packages.  \npreparing  the project  for client -side packages  \nUse the command prompt to run the commands shown in listing 15.32, which remove \nany existing LibMan package and install the version required by this chapter as a global \n.NET Core tool.  \nListing 15.32    Installing LibMan\ndotnet tool uninstall --global Microsoft.Web.LibraryManager.Cli\ndotnet tool install --global Microsoft.Web.LibraryManager.Cli  \n    --version 2.1.175 \nThe next step is to create the LibMan configuration file, which specifies the repository \nthat will be used to get client-side packages and the directory into which packages will \nbe downloaded. Open a PowerShell command prompt and run the command shown \nin listing 15.33 in the Platform  folder.  \n416 chapter  15 Using the platform features, part 1 \nListing 15.33    Initializing LibMan\nlibman init -p cdnjs\nThe -p argument specifies the provider that will get packages. I have used cdnjs , \nwhich selects cdnjs.com . The other option is unpkg , which selects unpkg.com . If you \ndon’t have existing experience with package repositories, then you should start with \nthe cdnjs  option.\n The command in listing 15.33 creates a file named libman.json  in the Platform  \nfolder; the file contains the following settings:\n...\n{\n  ""version"": ""1.0"",\n  ""defaultProvider"": ""cdnjs"",\n  ""libraries"": []\n}\n...\nIf you are using Visual Studio, you can create and edit the libman.json  file directly by \nselecting Project > Manage Client-Side Libraries. \ninstalling  client -side packages  \nPackages are installed from the command line. Run the command shown in listing \n15.34 in the Platform  folder to install the Bootstrap package.  \nListing 15.34    Installing the Bootstrap package \nlibman install bootstrap@5.2.3 -d wwwroot/lib/bootstrap\nThe required version is separated from the package name by the @ character, and the \n-d argument is used to specify where the package will be installed. The wwwroot/lib  \nfolder is the conventional location for installing client-side packages in ASP.NET Core \nprojects.\nusing a client -side package  \nOnce a client-side package has been installed, its files can be referenced by script  or \nlink  HTML elements or by using the features provided by the higher-level ASP.NET \nCore features described in later chapters. \nFor simplicity in this chapter, listing 15.35 adds a link  element to the static HTML \nfile created earlier in this section.\nListing 15.35    Using a client package in the static.html file in the Platform/wwwroot \nfolder\n<!DOCTYPE html>\n<html lang=""en"">\n<head>\n    <link rel=""stylesheet"" href=""/lib/bootstrap/css/bootstrap.min.css"" />\n    <title>Static Content</title>\n</head>\n<body>",3691
187-16.2 Using cookies.pdf,187-16.2 Using cookies,"417 Summary\n    <h3 class=""p-2 bg-primary text-white"">This is static content</h3>\n</body>\n</html>\nRestart ASP.NET Core and request http://localhost:5000/static.html. When the \nbrowser receives and processes the contents of the static.html  file, it will encounter \nthe link  element and send an HTTP request to the ASP.NET Core runtime for the  \n/lib/bootstrap/css/bootstrap.min.css  URL. The original static file middleware \ncomponent will receive this request, determine that it corresponds to a file in the \nwwwroot  folder, and return its contents, providing the browser with the Bootstrap \nCSS stylesheet. The Bootstrap styles are applied through the classes to which the h3 \nelement has been assigned, producing the result shown in figure 15.12. \nFigure 15.12    Using a client-side package \nSummary\n¡ The ASP.NET Core platform includes features for common tasks, must of which \nare presented as services.\n¡ The configuration service provides access to the application configuration, which \nincludes the contents of the appsettings.json  file and environment variables.\n¡ The configuration data is typically used with the options service to configure the \nservices available through dependency injection.\n¡ The user secrets feature is used to store sensitive data outside of the project \nfolder, so they are not committed into a version control code repository.\n¡ The logging service is used to generate log messages, with different severity levels \nand with options for sending the log messages to different handlers.\n¡ ASP.NET Core includes middleware for serving static content and a tool for add-\ning packages that will be delivered as static content to the project.\n41816Using the platform \n features, part 2\nThis chapter covers\n¡ Using cookies to store data that will be  \n presented in subsequent requests\n¡ Using sessions to identify related requests and  \n store associated data\n¡ Working with HTTPS requests\n¡ Limiting the rate of requests processed by   \n endpoints\n¡ Responding to exceptions and errors\n¡ Filtering requests based on the host header\nIn this chapter, I continue to describe the basic features provided by the ASP.NET \nCore platform. I explain how cookies are used and how the user’s consent for track-\ning cookies is managed. I describe how sessions provide a robust alternative to basic \ncookies, how to use and enforce HTTPS requests, how to deal with errors, and \nhow to filter requests based on the Host  header. Table 16.1 provides a guide to the \nchapter.\n 419 Preparing for this chapter\nTable 16.1    Chapter guide\nProblem Solution Listing\nUsing cookies Use the context objects to read \nand write cookies.1–3\nManaging cookie consent Use the consent middleware. 4–6\nStoring data across \nrequestsUse sessions. 7, 8\nSecuring HTTP requests Use the HTTPS middleware. 9–13\nRestrict the number of \nrequests handled by the \napplicationUse the rate limiting middleware 14\nHandling errors Use the error and status code \nmiddleware.15–20\nRestricting a request with \nthe host headerSet the AllowedHosts configu -\nration setting. 21\n16.1 Preparing for this chapter\nIn this chapter, I continue to use the Platform  project from chapter 15. To prepare \nfor this chapter, replace the contents of the Program.cs  file with the contents of listing \n16.1, which removes the middleware and services from the previous chapter. \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from  https://github.com/manningbooks/proasp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 16.1    Replacing the contents of the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapFallback(async context => \n    await context.Response.WriteAsync(""Hello World!""));\napp.Run();\nStart the application by opening a new PowerShell command prompt, navigating to \nthe folder that contains the Platform.csproj  file, and running the command shown \nin listing 16.2.\nListing 16.2    Starting the ASP .NET Core runtime \ndotnet run\nOpen a new browser window and use it to request http://localhost:5000, which will \nproduce the response shown in figure 16.1.\n420 chapter  16 Using the platform features, part 2 \nFigure 16.1   \nRunning the \nexample \napplication\n16.2 Using cookies\nCookies are small amounts of text added to responses that the browser includes in \nsubsequent requests. Cookies are important for web applications because they allow \nfeatures to be developed that span a series of HTTP requests, each of which can be \nidentified by the cookies that the browser sends to the server.\nASP.NET Core provides support for working with cookies through the HttpRequest  \nand HttpResponse  objects that are provided to middleware components. To demon-\nstrate, listing 16.3 changes the routing configuration in the example application to add \nendpoints that implement a counter. \nListing 16.3    Using cookies in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""/cookie"", async context => {\n    int counter1 =\n        int.Parse(context.Request.Cookies[""counter1""] ?? ""0"") + 1;\n    context.Response.Cookies.Append(""counter1"", counter1.ToString(),\n        new CookieOptions {\n            MaxAge = TimeSpan.FromMinutes(30)\n        });\n    int counter2 =\n        int.Parse(context.Request.Cookies[""counter2""] ?? ""0"") + 1;\n    context.Response.Cookies.Append(""counter2"", counter2.ToString(),\n        new CookieOptions {\n            MaxAge = TimeSpan.FromMinutes(30)\n        });\n    await context.Response\n        .WriteAsync($""Counter1: {counter1}, Counter2: {counter2}"");\n});\napp.MapGet(""clear"", context => {\n    context.Response.Cookies.Delete(""counter1"");\n    context.Response.Cookies.Delete(""counter2"");\n    context.Response.Redirect(""/"");\n    return Task.CompletedTask;\n});\napp.MapFallback(async context => \n    await context.Response.WriteAsync(""Hello World!""));\napp.Run();\n 421 Using cookies\nThe new endpoints rely on cookies called counter1  and counter2 . When the  \n/cookie  URL is requested, the middleware looks for the cookies and parses the values \nto an int. If there is no cookie, a fallback zero is used.\n...\nint counter1 = int.Parse( context.Request.Cookies[""counter1""]  ?? ""0"") + 1;\n...\nCookies are accessed through the HttpRequest.Cookies  property, where the name \nof the cookie is used as the key. The value retrieved from the cookie is incremented \nand used to set a cookie in the response, like this:\n...\ncontext.Response.Cookies.Append (""counter1"", counter1.ToString(),\n    new CookieOptions {\n        MaxAge = TimeSpan.FromMinutes(30)\n});\n...\nCookies are set through the HttpResponse.Cookies  property and the Append  method \ncreates or replaces a cookie in the response. The arguments to the Append  method are \nthe name of the cookie, its value, and a CookieOptions  object, which is used to con-\nfigure the cookie. The CookieOptions  class defines the properties described in table \n16.2, each of which corresponds to a cookie field.  \nNOTE     Cookies are sent in the response header, which means that cookies can \nbe set only before the response body is written, after which any changes to the \ncookies are ignored.\nTable 16.2   The CookieOptions properties \nName Description\nDomain This property specifies the hosts to which the browser will send the \ncookie. By default, the cookie will be sent only to the host that cre-\nated the cookie.\nExpires This property sets the expiry for the cookie.\nHttpOnly When true , this property tells the browser not to include the \ncookie  in requests made by JavaScript code.\nIsEssential This property is used to indicate that a cookie is essential, as \ndescribed in the ""Managing Cookie Consent"" section.\nMaxAge This property specifies the number of seconds until the cookie \nexpires. Older browsers do not support cookies with this setting.\nPath This property is used to set a URL path that must be present in the \nrequest before the cookie will be sent by the browser.\nSameSite This property is used to specify whether the cookie should be \nincluded in cross-site requests. The values are Lax, Strict , and \nNone  (which is the default value).\nSecure When true , this property tells the browser to send the cookie using \nHTTPS only.",8515
188-16.2.1 Enabling cookie consent checking.pdf,188-16.2.1 Enabling cookie consent checking,"422 chapter  16 Using the platform features, part 2 \nThe only cookie option set in listing 16.3 is MaxAge , which tells the browser that the \ncookies expire after 30 minutes. The middleware in listing 16.3 deletes the cookies \nwhen the /clear  URL is requested, which is done using the HttpResponse.Cookie \n.Delete  method, after which the browser is redirected to the / URL.\n...\napp.MapGet(""clear"", context => {\n    context.Response.Cookies.Delete(""counter1"");\n    context.Response.Cookies.Delete(""counter2"");\n    context.Response.Redirect(""/"");\n    return Task.CompletedTask;\n});\n...\nRestart ASP.NET Core and navigate to http://localhost:5000/cookie. The response \nwill contain cookies that are included in subsequent requests, and the counters will be \nincremented each time the browser is reloaded, as shown in figure 16.2. A request for \nhttp://localhost:5000/clear will delete the cookies, and the counters will be reset.\nFigure 16.2   Using a cookie\n16.2.1  Enabling cookie consent checking\nThe EU General Data Protection Regulation (GDPR) requires the user’s consent \nbefore nonessential cookies can be used. ASP.NET Core provides support for obtain-\ning consent and preventing nonessential cookies from being sent to the browser when \nconsent has not been granted. The options pattern is used to create a policy for cook-\nies, which is applied by a middleware component, as shown in listing 16.4.  \nCAUTION     Cookie consent is only one part of GDPR. See https://en.wikipedia.org/\nwiki/General_Data_Protection_Regulation  for a good overview of the regulations.\nListing 16.4    Enabling cookie consent in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<CookiePolicyOptions>(opts => {\n    opts.CheckConsentNeeded = context => true;\n});\nvar app = builder.Build();\napp.UseCookiePolicy();\n 423 Using cookies\napp.MapGet(""/cookie"", async context => {\n    int counter1 =\n        int.Parse(context.Request.Cookies[""counter1""] ?? ""0"") + 1;\n    context.Response.Cookies.Append(""counter1"", counter1.ToString(),\n        new CookieOptions {\n            MaxAge = TimeSpan.FromMinutes(30),\n            IsEssential = true\n        });\n    int counter2 =\n        int.Parse(context.Request.Cookies[""counter2""] ?? ""0"") + 1;\n    context.Response.Cookies.Append(""counter2"", counter2.ToString(),\n        new CookieOptions {\n            MaxAge = TimeSpan.FromMinutes(30)\n        });\n    await context.Response\n        .WriteAsync($""Counter1: {counter1}, Counter2: {counter2}"");\n});\napp.MapGet(""clear"", context => {\n    context.Response.Cookies.Delete(""counter1"");\n    context.Response.Cookies.Delete(""counter2"");\n    context.Response.Redirect(""/"");\n    return Task.CompletedTask;\n});\napp.MapFallback(async context => \n    await context.Response.WriteAsync(""Hello World!""));\napp.Run();\nThe options pattern is used to configure a CookiePolicyOptions  object, which sets \nthe overall policy for cookies in the application using the properties described in table \n16.3.  \nTable 16.3.   The CookiePolicyOptions properties\nName Description\nCheckConsentNeeded This property is assigned a function that receives an HttpContext  \nobject and returns true  if it represents  a request for which cookie \nconsent is required. The function is called for every request, and the \ndefault function always returns false .\nConsentCookie This property returns an object that is used to configure the cookie \nsent to the browser to record the user’s cookie consent.\nHttpOnly This property sets the default value for the HttpOnly  property, as \ndescribed in table 16.2. \nMinimumSameSitePolicy This property sets the lowest level of security for the SameSite  \nproperty, as described in table 16.2.\nSecure This property sets the default value for the Secure  property, as \ndescribed in table 16.2.\nTo enable consent checking, I assigned a new function to the CheckConsentNeeded  \nproperty that always returns true . The function is called for every request that ASP",4078
189-16.2.2 Managing cookie consent.pdf,189-16.2.2 Managing cookie consent,"424 chapter  16 Using the platform features, part 2 \n.NET Core receives, which means that sophisticated rules can be defined to select the \nrequests for which consent is required. For this application, I have taken the most cau-\ntious approach and required consent for all requests.  \nThe middleware that enforces the cookie policy is added to the request pipeline using \nthe UseCookiePolicy  method. The result is that only cookies whose IsEssential  \nproperty is true will be added to responses. Listing 16.4 sets the IsEssential  property \non cookie1  only, and you can see the effect by restarting ASP.NET Core, requesting \nhttp://localhost:5000/cookie, and reloading the browser. Only the counter whose \ncookie is marked as essential updates, as shown in figure 16.3.\nFigure 16.3   Using cookie consent \n16.2.2  Managing cookie consent \nUnless the user has given consent, only cookies that are essential to the core features \nof the web application are allowed. Consent is managed through a request feature , which \nprovides middleware components with access to the implementation details of how \nrequests and responses are handled by ASP.NET Core. Features are accessed through \nthe HttpRequest.Features  property, and each feature is represented by an interface \nwhose properties and methods deal with one aspect of low-level request handling.\nFeatures deal with aspects of request handling that rarely need to be altered, such as \nthe structure of responses. The exception is the management of cookie consent, which \nis handled through the ITrackingConsentFeature  interface, which defines the meth-\nods and properties described in table 16.4.  \nTable 16.4.   The ITrackingConsentFeature members\nName Description\nCanTrack This property returns true  if nonessential cookies can be added \nto the current request, either because the user has given con -\nsent or because consent is not required.\nCreateConsentCookie() This method returns a cookie that can be used by JavaScript \nclients to indicate consent.\nGrantConsent() Calling this method adds a cookie to the response that grants \nconsent for nonessential cookies.\nHasConsent This property returns true  if the user has given consent for non-\nessential cookies.\nIsConsentNeeded This property returns true  if consent for nonessential cookies is \nrequired for the current request.\nWithdrawConsent() This method deletes the consent cookie.\n 425 Using cookies\nTo deal with consent, add a class file named ConsentMiddleware.cs  to the Platform  \nfolder and the code shown in listing 16.5. Managing cookie consent can be done using \nlambda expressions, but I have used a class in this example to keep the Program.cs  \nmethod uncluttered.\nListing 16.5    The contents of the ConsentMiddleware.cs file in the Platform folder\nusing Microsoft.AspNetCore.Http.Features;\nnamespace Platform {\n    public class ConsentMiddleware {\n        private RequestDelegate next;\n        public ConsentMiddleware(RequestDelegate nextDelgate) {\n            next = nextDelgate;\n        }\n        public async Task Invoke(HttpContext context) {\n            if (context.Request.Path == ""/consent"") {\n                ITrackingConsentFeature? consentFeature\n                    = context.Features.Get<ITrackingConsentFeature>();\n                if (consentFeature != null) {\n                    if (!consentFeature.HasConsent) {\n                        consentFeature.GrantConsent();\n                    } else {\n                        consentFeature.WithdrawConsent();\n                    }\n                    await context.Response.WriteAsync(\n                        consentFeature.HasConsent ? ""Consent Granted \n"" \n                            : ""Consent Withdrawn\n"");\n                }\n            } else {\n                await next(context);\n            }\n        }\n    }\n}\nRequest features are obtained using the Get method, where the generic type argument \nspecifies the feature interface that is required, like this:\n...\nITrackingConsentFeature? consentFeature\n    = context.Features. Get<ITrackingConsentFeature> ();\n...\nUsing the properties and methods described in table 16.4, the new middleware com-\nponent responds to the /consent  URL to determine and change the cookie consent. \nListing 16.6 adds the new middleware to the request pipeline.\nListing 16.6    Adding middleware in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<CookiePolicyOptions>(opts => {",4558
190-16.3 Using sessions.pdf,190-16.3 Using sessions,,0
191-16.3.1 Configuring the session service and middleware.pdf,191-16.3.1 Configuring the session service and middleware,"426 chapter  16 Using the platform features, part 2 \n    opts.CheckConsentNeeded = context => true;\n});\nvar app = builder.Build();\napp.UseCookiePolicy();\napp.UseMiddleware<Platform.ConsentMiddleware>();\napp.MapGet(""/cookie"", async context => {\n// ...statments omitted for brevity...\nTo see the effect, restart ASP.NET Core and request http://localhost:5000/consent \nand then http://localhost:5000/cookie. When consent is granted, nonessential cook-\nies are allowed, and both the counters in the example will work, as shown in figure \n16.4. Repeat the process to withdraw consent, and you will find that only the counter \nwhose cookie has been denoted as essential works.\nFigure 16.4   Managing cookie consent\n16.3 Using sessions \nThe example in the previous section used cookies to store the application’s state data, \nproviding the middleware component with the data required. The problem with this \napproach is that the contents of the cookie are stored at the client, where it can be \nmanipulated and used to alter the behavior of the application. \nA better approach is to use the ASP.NET Core session feature. The session middle-\nware adds a cookie to responses, which allows related requests to be identified and \nwhich is also associated with data stored at the server.\nWhen a request containing the session cookie is received, the session middleware \ncomponent retrieves the server-side data associated with the session and makes it avail-\nable to other middleware components through the HttpContext  object. Using sessions \nmeans that the application’s data remains at the server and only the identifier for the \nsession is sent to the browser.\n16.3.1  Configuring the session service and middleware \nSetting up sessions requires configuring services and adding a middleware component \nto the request pipeline. Listing 16.7 adds the statements to the Program.cs  file to set \nup sessions for the example application and removes the endpoints from the previous \nsection.\n 427 Using sessions \nListing 16.7    Configuring sessions in the Program.cs file in the Platform folder \nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(opts => {\n    opts.IdleTimeout = TimeSpan.FromMinutes(30);\n    opts.Cookie.IsEssential = true;\n});\nvar app = builder.Build();\napp.UseSession();\napp.MapFallback(async context =>\n    await context.Response.WriteAsync(""Hello World!""));\napp.Run();\nWhen you use sessions, you must decide how to store the associated data. ASP.NET \nCore provides three options for session data storage, each of which has its own method \nto register a service, as described in table 16.5. \nTable 16.5   The session storage methods\nName Description\nAddDistributedMemoryCache This method sets up an in-memory cache. Despite the \nname, the cache is not distributed and is responsible \nonly for storing data for the instance of the ASP.NET \nCore runtime where it is created.\nAddDistributedSqlServerCache This method sets up a cache that stores data in SQL \nServer and is available when the Microsoft \n.Extensions.Caching.SqlServer  package is \ninstalled. This cache is used in chapter 17.\nAddStackExchangeRedisCache This method sets up a Redis cache and is available \nwhen the Microsoft.Extensions.Caching \n.Redis  package is installed.\nCaching is described in detail in chapter 17, but for this chapter, I used the in-memory \ncache:  \n...\nbuilder.Services. AddDistributedMemoryCache ();\n...\nDespite its name, the cache service created by the AddDistributedMemoryCache  \nmethod isn’t distributed and stores the session data for a single instance of the ASP.\nNET Core runtime. If you scale an application by deploying multiple instances of the \nruntime, then you should use one of the other caches, such as the SQL Server cache, \nwhich is demonstrated in chapter 17.\nThe next step is to use the options pattern to configure the session middleware, like \nthis: \n428 chapter  16 Using the platform features, part 2 \n...\nbuilder.Services. AddSession (opts => {\n    opts.IdleTimeout = TimeSpan.FromMinutes(30);\n    opts.Cookie.IsEssential = true;\n});\n...\nTable 16.6 shows that the options class for sessions is SessionOptions  and describes \nthe key properties it defines. \nTable 16.6   Properties defined by the SessionOptions class\nName Description\nCookie This property is used to configure the session cookie.\nIdleTimeout This property is used to configure the time span after which a \nsession expires.\nThe Cookie  property returns an object that can be used to configure the session cookie.  \nTable 16.7 describes the most useful cookie configuration properties for session data.\nTable 16.7   Cookie configuration properties\nName Description\nHttpOnly This property specifies whether the browser will prevent \nthe cookie from being included in HTTP requests sent by \nJavaScript code. This property should be set to true  for \nprojects that use a JavaScript application whose requests \nshould be included in the session. The default value is \ntrue .\nIsEssential This property specifies whether the cookie is required for \nthe application to function and should be used even when \nthe user has specified that they don’t want the application \nto use cookies. The default value is false . See the “Man-\naging Cookie Consent” section for more details.\nSecurityPolicy This property sets the security policy for the cookie, using \na value from the CookieSecurePolicy  enum. The \nvalues are Always  (which restricts the cookie to HTTPS \nrequests), SameAsRequest  (which restricts the cookie \nto HTTPS if the original request was made using HTTPS), \nand None  (which allows the cookie to be used on HTTP and \nHTTPS requests). The default value is None .\nThe options set in listing 16.7 allow the session cookie to be included in requests started \nby JavaScript and flag the cookie as essential so that it will be used even when the user \nhas expressed a preference not to use cookies (see the “Managing Cookie Consent” \nsection for more details about essential cookies). The IdleTimeout  option has been \nset so that sessions expire if no request containing the sessions cookie is received for 30 \nminutes.",6288
192-16.3.2 Using session data.pdf,192-16.3.2 Using session data,"429 Using sessions \nCAUTION     The session cookie isn’t denoted as essential by default, which can \ncause problems when cookie consent is used. Listing 16.7 sets the IsEssential  \nproperty to true  to ensure that sessions always work. If you find sessions \ndon’t work as expected, then this is the likely cause, and you must either set \nIsEssential  to true  or adapt your application to deal with users who don’t \ngrant consent and won’t accept session cookies.\nThe final step is to add the session middleware component to the request pipeline, \nwhich is done with the UseSession  method. When the middleware processes a request \nthat contains a session cookie, it retrieves the session data from the cache and makes \nit available through the HttpContext  object, before passing the request along the \nrequest pipeline and providing it to other middleware components. When a request \narrives without a session cookie, a new session is started, and a cookie is added to the \nresponse so that subsequent requests can be identified as being part of the session.\n16.3.2  Using session data \nThe session middleware provides access to details of the session associated with a \nrequest through the Session  property of the HttpContext  object. The Session  prop-\nerty returns an object that implements the ISession  interface, which provides the \nmethods shown in table 16.8 for accessing session data.  \nTable 16.8   Useful ISession methods and extension methods\nName Description\nClear() This method removes all the data in the session.\nCommitAsync() This asynchronous method commits changed session \ndata to the cache.\nGetString(key) This method retrieves a string value using the speci-\nfied key.\nGetInt32(key) This method retrieves an integer value using the spec-\nified key.\nId This property returns the unique identifier for the \nsession.\nIsAvailable This returns true  when the session data has been \nloaded.\nKeys This enumerates the keys for the session data items.\nRemove(key) This method removes the value associated with the \nspecified key.\nSetString(key,val) This method stores a string using the specified key.\nSetInt32(key,  val) This method stores an integer using the specified key.\nSession data is stored in key-value pairs, where the keys are strings and the values are \nstrings or integers. This simple data structure allows session data to be stored easily by \n430 chapter  16 Using the platform features, part 2 \neach of the caches listed in table 16.5. Applications that need to store more complex \ndata can use serialization, which is the approach I took for the SportsStore. Listing 16.8 \nuses session data to re-create the counter example.\nListing 16.8    Using session data in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(opts => {\n    opts.IdleTimeout = TimeSpan.FromMinutes(30);\n    opts.Cookie.IsEssential = true;\n});\nvar app = builder.Build();\napp.UseSession();\napp.MapGet(""/session"", async context => {\n    int counter1 = (context.Session.GetInt32(""counter1"") ?? 0) + 1;\n    int counter2 = (context.Session.GetInt32(""counter2"") ?? 0) + 1;\n    context.Session.SetInt32(""counter1"", counter1);\n    context.Session.SetInt32(""counter2"", counter2);\n    await context.Session.CommitAsync();\n    await context.Response\n        .WriteAsync($""Counter1: {counter1}, Counter2: {counter2}"");\n});\napp.MapFallback(async context =>\n    await context.Response.WriteAsync(""Hello World!""));\napp.Run();\nThe GetInt32  method is used to read the values associated with the keys counter1  \nand counter2 . If this is the first request in a session, no value will be available, and the \nnull-coalescing operator is used to provide an initial value. The value is incremented \nand then stored using the SetInt32  method and used to generate a simple result for \nthe client.\nThe use of the CommitAsync  method is optional, but it is good practice to use it \nbecause it will throw an exception if the session data can’t be stored in the cache. By \ndefault, no error is reported if there are caching problems, which can lead to unpre-\ndictable and confusing behavior. \nAll changes to the session data must be made before the response is sent to the cli-\nent, which is why I read, update, and store the session data before calling the Response \n.WriteAsync  method in listing 16.8.  \nNotice that the statements in listing 16.8 do not have to deal with the session \ncookie, detect expired sessions, or load the session data from the cache. All this work \nis done automatically by the session middleware, which presents the results through \nthe HttpContext.Session  property. One consequence of this approach is that the \nHttp Context.Session  property is not populated with data until after the session",4898
193-16.4 Working with HTTPS connections.pdf,193-16.4 Working with HTTPS connections,,0
194-16.4.1 Enabling HTTPS connections.pdf,194-16.4.1 Enabling HTTPS connections,"431 Working with HTTPS connections\nmiddleware has processed a request, which means that you should attempt to access ses-\nsion data only in middleware or endpoints that are added to the request pipeline after \nthe UseSession  method is called.\nRestart ASP.NET Core and navigate to the http://localhost:5000/session URL, and \nyou will see the value of the counter. Reload the browser, and the counter values will be \nincremented, as shown in figure 16.5. The sessions and session data will be lost when \nASP.NET Core is stopped because I chose the in-memory cache. The other storage \noptions operate outside of the ASP.NET Core runtime and survive application restarts.\nFigure 16.5   Using session data\n16.4 Working with HTTPS connections\nUsers increasingly expect web applications to use HTTPS connections, even for \nrequests that don’t contain or return sensitive data. ASP.NET Core supports both \nHTTP and HTTPS connections and provides middleware that can force HTTP clients \nto use HTTPS.   \nHTTPS vs. SSL vs. TLS\nHTTPS is the combination of HTTP and the Transport Layer Security (TLS) or Secure \nSockets Layer (SSL). TLS has replaced the obsolete SSL protocol, but the term SSL has \nbecome synonymous with secure networking and is often used to refer to TLS.  If you are \ninterested in security and cryptography, then the details of HTTPS are worth exploring, \nand https://en.wikipedia.org/wiki/HTTPS  is a good place to start.\n16.4.1  Enabling HTTPS connections \nHTTPS is enabled and configured in the launchSettings.json  file in the Properties  \nfolder, as shown in listing 16.9.  \nListing 16.9    Changes in the launchSettings.json file in the Platform/Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n432 chapter  16 Using the platform features, part 2 \n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""Platform"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000;https://localhost:5500"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nThe new applicationUrl  setting sets the URLs to which the application will respond, \nand HTTPS is enabled by adding an HTTPS URL to the configuration setting. Note \nthat the URLs are separated by a semicolon and no spaces are allowed.\nThe .NET Core runtime includes a test certificate that is used for HTTPS requests. \nRun the commands shown in listing 16.10 in the Platform  folder to regenerate and \ntrust the test certificate.  \nListing 16.10    Regenerating the Development Certificates \ndotnet dev-certs https --clean\ndotnet dev-certs https --trust\nSelect Yes to the prompts to delete the existing certificate that has already been trusted \nand select Yes to trust the new certificate, as shown in figure 16.6.\nFigure 16.6   Regenerating the HTTPS certificate",3236
195-16.4.4 Enabling HTTP strict transport security.pdf,195-16.4.4 Enabling HTTP strict transport security,"433 Working with HTTPS connections\n16.4.2  Detecting HTTPS requests\nRequests made using HTTPS can be detected through the HttpRequest.IsHttps  \nproperty. In listing 16.11, I added a message to the fallback response that reports \nwhether a request is made using HTTPS.  \nListing 16.11    Detecting HTTPS in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(opts => {\n    opts.IdleTimeout = TimeSpan.FromMinutes(30);\n    opts.Cookie.IsEssential = true;\n});\nvar app = builder.Build();\napp.UseSession();\napp.MapGet(""/session"", async context => {\n    int counter1 = (context.Session.GetInt32(""counter1"") ?? 0) + 1;\n    int counter2 = (context.Session.GetInt32(""counter2"") ?? 0) + 1;\n    context.Session.SetInt32(""counter1"", counter1);\n    context.Session.SetInt32(""counter2"", counter2);\n    await context.Session.CommitAsync();\n    await context.Response\n        .WriteAsync($""Counter1: {counter1}, Counter2: {counter2}"");\n});\napp.MapFallback(async context => {\n    await context.Response\n        .WriteAsync($""HTTPS Request: {context.Request.IsHttps} \n"");\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nTo test HTTPS, restart ASP.NET Core and navigate to http://localhost:5000. This is \na regular HTTP request and will produce the result shown on the left of figure 16.7. \nNext, navigate to https://localhost:5500, paying close attention to the URL scheme, \nwhich is https  and not http , as it has been in previous examples. The new middleware \nwill detect the HTTPS connection and produce the output on the right of figure 16.7.\nFigure 16.7   Detecting an HTTPS request\n434 chapter  16 Using the platform features, part 2 \n16.4.3  Enforcing HTTPS requests\nASP.NET Core provides a middleware component that enforces the use of HTTPS by \nsending a redirection response for requests that arrive over HTTP. Listing 16.12 adds \nthis middleware to the request pipeline.  \nListing 16.12    Enforcing HTTPS in the Program.cs file in the Platform folder \nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(opts => {\n    opts.IdleTimeout = TimeSpan.FromMinutes(30);\n    opts.Cookie.IsEssential = true;\n});\nvar app = builder.Build();\napp.UseHttpsRedirection();\napp.UseSession();\napp.MapGet(""/session"", async context => {\n    int counter1 = (context.Session.GetInt32(""counter1"") ?? 0) + 1;\n    int counter2 = (context.Session.GetInt32(""counter2"") ?? 0) + 1;\n    context.Session.SetInt32(""counter1"", counter1);\n    context.Session.SetInt32(""counter2"", counter2);\n    await context.Session.CommitAsync();\n    await context.Response\n        .WriteAsync($""Counter1: {counter1}, Counter2: {counter2}"");\n});\napp.MapFallback(async context => {\n    await context.Response\n        .WriteAsync($""HTTPS Request: {context.Request.IsHttps} \n"");\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThe UseHttpsRedirection  method adds the middleware component, which appears \nat the start of the request pipeline so that the redirection to HTTPS occurs before any \nother component can short-circuit the pipeline and produce a response using regular \nHTTP.\nConfiguring HTTPS redirection\nThe options pattern can be used to configure the HTTPS redirection middleware, by call -\ning the AddHttpsRedirection  method like this:  \n...\nbuilder.Services.AddHttpsRedirection(opts => {\n 435 Working with HTTPS connections\n(continued)\n    opts.RedirectStatusCode = StatusCodes.Status307TemporaryRedirect;\n    opts.HttpsPort = 443;\n});\n...\nThe only two configuration options are shown in this fragment, which sets the status code \nused in the redirection response, and the port to which the client is redirected, overriding \nthe value that is loaded from the configuration files. Specifying the HTTPS port can be \nuseful when deploying the application, but care should be taken when changing the redi-\nrection status code.\nRestart ASP.NET Core and request http://localhost:5000, which is the HTTP URL for \nthe application. The HTTPS redirection middleware will intercept the request and \nredirect the browser to the HTTPS URL, as shown in figure 16.8.\nTIP    Modern browsers often hide the URL scheme, which is why you should pay \nattention to the port number that is displayed. To display the URL scheme in the \nfigure, I had to click the URL bar so the browser would display the full URL.\nFigure 16.8   Forcing HTTPS \nrequests\n16.4.4  Enabling HTTP strict transport security\nOne limitation of HTTPS redirection is that the user can make an initial request using \nHTTP before being redirected to a secure connection, presenting a security risk.\nThe HTTP Strict Transport Security (HSTS) protocol is intended to help mitigate \nthis risk and works by including a header in responses that tells browsers to use HTTPS \nonly when sending requests to the web application’s host. After an HSTS header has \nbeen received, browsers that support HSTS will send requests to the application using \nHTTPS even if the user specifies an HTTP URL. Listing 16.13 shows the addition of the \nHSTS middleware to the request pipeline.  \nListing 16.13    Enabling HSTS in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(opts => {\n436 chapter  16 Using the platform features, part 2 \n    opts.IdleTimeout = TimeSpan.FromMinutes(30);\n    opts.Cookie.IsEssential = true;\n});\nbuilder.Services.AddHsts(opts => {\n    opts.MaxAge = TimeSpan.FromDays(1);\n    opts.IncludeSubDomains = true;\n});\nvar app = builder.Build();\nif (app.Environment.IsProduction()) {\n    app.UseHsts();\n}\napp.UseHttpsRedirection();\napp.UseSession();\napp.MapGet(""/session"", async context => {\n    int counter1 = (context.Session.GetInt32(""counter1"") ?? 0) + 1;\n    int counter2 = (context.Session.GetInt32(""counter2"") ?? 0) + 1;\n    context.Session.SetInt32(""counter1"", counter1);\n    context.Session.SetInt32(""counter2"", counter2);\n    await context.Session.CommitAsync();\n    await context.Response\n        .WriteAsync($""Counter1: {counter1}, Counter2: {counter2}"");\n});\napp.MapFallback(async context => {\n    await context.Response\n        .WriteAsync($""HTTPS Request: {context.Request.IsHttps} \n"");\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThe middleware is added to the request pipeline using the UseHsts  method. The \nHSTS middleware can be configured with the AddHsts  method, using the properties \ndescribed in table 16.9.\nTable 16.9   The HSTS configuration properties\nName Description\nExcludeHosts This property returns a List<string>  that contains the hosts \nfor which the middleware won’t send an HSTS header. The defaults \nexclude localhost  and the loopback addresses for IP version 4 \nand version 6.\nIncludeSubDomains When true , the browser will apply the HSTS setting to subdomains. \nThe default value is false .\nMaxAge This property specifies the period for which the browser should \nmake only HTTPS requests. The default value is 30 days.\nPreload This property is set to true  for domains that are part of the HSTS \npreload scheme. The domains are hard-coded into the browser, \nwhich avoids the initial insecure request and ensures that only \nHTTPS is used. See hstspreload.org for more details.",7552
196-16.5 Using rate limits.pdf,196-16.5 Using rate limits,"437 Using rate limits\nHSTS is disabled during development and enabled only in production, which is why \nthe UseHsts  method is called only for that environment.\n...\nif (app.Environment. IsProduction ()) {\n    app.UseHsts();\n}\n... \nHSTS must be used with care because it is easy to create a situation where clients can-\nnot access the application, especially when nonstandard ports are used for HTTP and \nHTTPS. \nIf the example application is deployed to a server named myhost , for example, \nand the user requests http://myhost:5000, the browser will be redirected to https://\nmyhost:5500 and sent the HSTS header, and the application will work as expected. But \nthe next time the user requests http://myhost:5000, they will receive an error stating \nthat a secure connection cannot be established.\nThis problem arises because some browsers take a simplistic approach to HSTS and \nassume that HTTP requests are handled on port 80 and HTTPS requests on port 443.\nWhen the user requests http://myhost:5000, the browser checks its HSTS data and \nsees that it previously received an HSTS header for myhost . Instead of the HTTP URL \nthat the user entered, the browser sends a request to https://myhost:5000. ASP.NET \nCore doesn’t handle HTTPS on the port it uses for HTTP, and the request fails. The \nbrowser doesn’t remember or understand the redirection it previously received for \nport 5001.\nThis isn’t an issue where port 80 is used for HTTP and 443 is used for HTTPS. The \nURL http://myhost  is equivalent to http://myhost:80, and https://myhost  is equiv-\nalent to https://myhost:443, which means that changing the scheme targets the right \nport.\nOnce a browser has received an HSTS header, it will continue to honor it for the \nduration of the header’s MaxAge  property. When you first deploy an application, it is a \ngood idea to set the HSTS MaxAge  property to a relatively short duration until you are \nconfident that your HTTPS infrastructure is working correctly, which is why I have set \nMaxAge  to one day in listing 16.13. Once you are sure that clients will not need to make \nHTTP requests, you can increase the MaxAge  property. A MaxAge  value of one year is \ncommonly used.\nTIP    If you are testing HSTS with Google Chrome, you can inspect and edit \nthe list of domains to which HSTS is applied by navigating to chrome://\nnet-internals/#hsts .\n16.5 Using rate limits\nASP.NET Core includes middleware components that limit the rate at which requests \nare processed, which can be a good way to ensure that a large number of requests \ndoesn’t overwhelm the application. The .NET framework provides a general API for \n438 chapter  16 Using the platform features, part 2 \nrate limiting, which is integrated into ASP.NET Core through extension methods used \nin the Program.cs  file. Listing 16.14 defines a rate limit and applies it to an endpoint.\nCAUTION     Use this feature with caution. Once a rate limit has been reached, \nASP.NET Core rejects HTTP requests with an error until capacity becomes avail-\nable again, which can confuse clients and users alike.\nListing 16.14    Defining a rate limit in the Program.cs file in the Platform folder\nusing Microsoft.AspNetCore.RateLimiting;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(opts => {\n    opts.IdleTimeout = TimeSpan.FromMinutes(30);\n    opts.Cookie.IsEssential = true;\n});\nbuilder.Services.AddHsts(opts => {\n    opts.MaxAge = TimeSpan.FromDays(1);\n    opts.IncludeSubDomains = true;\n});\nbuilder.Services.AddRateLimiter(opts => {\n    opts.AddFixedWindowLimiter(""fixedWindow"", fixOpts => {\n        fixOpts.PermitLimit = 1;\n        fixOpts.QueueLimit = 0;\n        fixOpts.Window = TimeSpan.FromSeconds(15);\n    });\n});\nvar app = builder.Build();\nif (app.Environment.IsProduction()) {\n    app.UseHsts();\n}\napp.UseHttpsRedirection();\napp.UseRateLimiter();\napp.UseSession();\napp.MapGet(""/session"", async context => {\n    int counter1 = (context.Session.GetInt32(""counter1"") ?? 0) + 1;\n    int counter2 = (context.Session.GetInt32(""counter2"") ?? 0) + 1;\n    context.Session.SetInt32(""counter1"", counter1);\n    context.Session.SetInt32(""counter2"", counter2);\n    await context.Session.CommitAsync();\n    await context.Response\n        .WriteAsync($""Counter1: {counter1}, Counter2: {counter2}"");\n}).RequireRateLimiting(""fixedWindow"");\n 439 Using rate limits\napp.MapFallback(async context => {\n    await context.Response\n        .WriteAsync($""HTTPS Request: {context.Request.IsHttps} \n"");\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThe AddRateLimiter  extension method is used to configure rate limiting, which is \ndone using the options pattern. In this example, I have used the AddFixedWindow-\nLimiter  method to create a rate-limiting policy that limits the number of requests \nthat will be handled in a specified duration. The AddFixedWindowLimiter  method is \none of four extension methods that are available for rate limiting, described in table \n16.10. Full details of how each of these rate limits works can be found at https://learn \n.microsoft.  com/en-us/aspnet/core/performance/rate-limit .\nTable 16.10   The rate limiting extension methods \nName Description\nAddFixedWindowLimiter This method creates a rate limiter that allows a specified \nnumber of requests in a fixed period.\nAddSlidingWindowLimiter This method creates a rate limiter that allows a specified \nnumber of requests in a fixed period, with the addition of a \nsliding window to smooth the rate limits.\nAddTokenBucketLimiter This method creates a rate limiter that maintains a pool of \ntokens that are allocated to requests. Requests can be allo -\ncated different amounts of tokens, and requests are only \nhandled when there are sufficient free tokens in the pool.\nAddConcurrencyLimiter This method creates a rate limiter that allows a specific \nnumber of concurrent requests. \nThis is the least flexible of the time-based rate limiters, but it is the easiest to demon-\nstrate and test:\n...\nopts.AddFixedWindowLimiter(""fixedWindow"", fixOpts => {\n    fixOpts.PermitLimit = 1;\n    fixOpts.QueueLimit = 0;\n    fixOpts.Window = TimeSpan.FromSeconds(15);\n});\n...\nEach extension method is configured with an instance of its own options class, but they \nall share the most important properties. The PermitLimit  property is used to specify \nthe maximum number of requests, and the QueueLimit  property is used to specify \nthe maximum number of requests that will be queued waiting for available capacity. \nIf there is no available capacity and no available slots in the queue, then requests will \nbe rejected. The combination of properties is given a name, which is used to apply the \nrate limit to endpoints.\n440 chapter  16 Using the platform features, part 2 \nThese options are supplemented by additional properties which are specific to each \nrate limiter. In the case of the AddFixedWindowLimiter  method, the Window  property \nis used to specify the duration to which the rate is applied.\nIn listing 16.14, I specified a PermitLimit  of 1, a QueueLimit  of 0, and a Window  of \n15 seconds. This means that one request will be accepted every 15 seconds, without any \nqueue, meaning that any additional requests will be rejected. This rate limit is assigned \nthe name fixedWindow .\nThe rate limiting middleware is added to the pipeline using the UseRateLimiter  \nmethod and applied to an endpoint with the RequireRateLimiting  method. An \napplication can define multiple rate limits and so a name is used to select the rate limit \nthat is required:\n...\n}).RequireRateLimiting (""fixedWindow"");\n...\nEndpoints can be con configured with different rate limits, or no rate limit, and each \nrate limit will be managed independently. \nApplying rate limits to controllers and pages \nASP.NET Core provides extension methods to configure rate limits for controllers, \ndescribed in chapter 19, and Razor Pages, which are described in chapter 23.\nIt can be difficult to test rate limits effectively because browsers will often apply their \nown restrictions on the requests they send. Microsoft provides recommendations \nfor testing tools at https://learn.microsoft.com/en-us/aspnet/core/performance/\nrate-limit#testing-endpoints-with-rate-limiting , but a policy as simple as the one defined \nin listing 16.14 is easy to test.\nRestart ASP.NET Core and request https://localhost:5500/session. Click the Reload \nbutton within 15 seconds, and the new request will exceed the rate limit and ASP.NET \nCore will respond with a 503 status code, as shown in figure 16.9. Wait until the 15-sec-\nond period has elapsed and click the Reload button again; the rate limit should reset \nand the request will be processed normally.\nFigure 16.9   The effect of a rate limit.",8943
197-16.6.1 Returning an HTML error response.pdf,197-16.6.1 Returning an HTML error response,"441 Handling exceptions and errors\n16.6 Handling exceptions and errors\nWhen the request pipeline is created, the WebApplicationBuilder  class uses the \ndevelopment environment to enable middleware that handles exceptions by produc-\ning HTTP responses that are helpful to developers. Here is a fragment of code from \nthe WebApplicationBuilder  class:\n...\nif (context.HostingEnvironment.IsDevelopment()) {\n    app.UseDeveloperExceptionPage(); \n}\n...\nThe UseDeveloperExceptionPage  method adds the middleware component that \nintercepts exceptions and presents a more useful response. To demonstrate the way \nthat exceptions are handled, listing 16.15 replaces the middleware and endpoints used \nin earlier examples with a new component that deliberately throws an exception.  \nListing 16.15    Adding Middleware in the Program.cs File in the Platform Folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.Run(context => {\n    throw new Exception(""Something has gone wrong"");\n});\napp.Run();\nRestart ASP.NET Core and navigate to http://localhost:5000 to see the response that \nthe middleware component generates, which is shown in figure 16.10. The page pres-\nents a stack trace and details about the request, including details of the headers and \ncookies it contained. \nFigure 16.10   The developer exception page  \n442 chapter  16 Using the platform features, part 2 \n16.6.1  Returning an HTML error response\nWhen the developer exception middleware is disabled, as it will be when the applica-\ntion is in production, ASP.NET Core deals with unhandled exceptions by sending a \nresponse that contains just an error code. Listing 16.16 changes the environment to \nproduction.\nListing 16.16    Changes in the launchSettings.json file in the Platform/Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""Platform"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": true,\n      ""applicationUrl"": ""http://localhost:5000;https://localhost:5500"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Production""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nStart ASP.NET Core using the dotnet run  command and navigate to http://\nlocalhost:5000. The response you see will depend on your browser because ASP.NET \nCore has only provided it with a response containing status code 500, without any \ncontent to display. Figure 16.11 shows how this is handled by Google Chrome.\nFigure 16.11   \nReturning an \nerror response\n 443 Handling exceptions and errors\nAs an alternative to returning just status codes, ASP.NET Core provides middleware \nthat intercepts unhandled exceptions and sends a redirection to the browser instead, \nwhich can be used to show a friendlier response than the raw status code. The excep-\ntion redirection middleware is added with the UseExceptionHandler  method, as \nshown in listing 16.17.  \nListing 16.17    Returning an error response in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\nif (!app.Environment.IsDevelopment()) {\n    app.UseExceptionHandler(""/error.html"");\n    app.UseStaticFiles();\n}\napp.Run(context => {\n    throw new Exception(""Something has gone wrong"");\n});\napp.Run();\nWhen an exception is thrown, the exception handler middleware will intercept \nthe response and redirect the browser to the URL provided as the argument to the  \nUseExceptionHandler  method. For this example, the redirection is to a URL that will \nbe handled by a static file, so the UseStaticFiles  middleware has also been added to \nthe pipeline.\nTo add the file that the browser will receive, create an HTML file named error.html  \nin the wwwroot  folder and add the content shown in listing 16.18.\nListing 16.18    The contents of the error.html file in the Platform/wwwroot folder\n<!DOCTYPE html>\n<html lang=""en"">\n<head>\n    <link rel=""stylesheet"" href=""/lib/bootstrap/css/bootstrap.min.css"" />\n    <title>Error</title>\n</head>\n<body class=""text-center"">\n    <h3 class=""p-2"">Something went wrong...</h3>\n    <h6>You can go back to the <a href=""/"">homepage</a> and try again</h6>\n</body>\n</html>\nRestart ASP.NET Core and navigate to http://localhost:5000 to see the effect of the \nnew middleware. Instead of the raw status code, the browser will be sent the content of \nthe /error.html  URL, as shown in figure 16.12.",4819
198-16.6.2 Enriching status code responses.pdf,198-16.6.2 Enriching status code responses,"444 chapter  16 Using the platform features, part 2 \nFigure 16.12   Displaying an \nHTML error\nThere are versions of the UseExceptionHandler  method that allow more complex \nresponses to be composed, but my advice is to keep error handling as simple as possi-\nble because you can’t anticipate all of the problems an application may encounter, and \nyou run the risk of encountering another exception when trying to handle the one \nthat triggered the handler, resulting in a confusing response or no response at all.\n16.6.2  Enriching status code responses\nNot all error responses will be the result of uncaught exceptions. Some requests can-\nnot be processed for reasons other than software defects, such as requests for URLs \nthat are not supported or that require authentication. For this type of problem, redi-\nrecting the client to a different URL can be problematic because some clients rely on \nthe error code to detect problems. You will see examples of this in later chapters when \nI show you how to create and consume RESTful web applications.  \nASP.NET Core provides middleware that adds user-friendly content to error \nresponses without requiring redirection. This preserves the error status code while pro-\nviding a human-readable message that helps users make sense of the problem.\nThe simplest approach is to define a string that will be used as the body for the \nresponse. This is more awkward than simply pointing at a file, but it is a more reliable \ntechnique, and as a rule, simple and reliable techniques are preferable when handling \nerrors. To create the string response for the example project, add a class file named \nResponseStrings.cs  to the Platform  folder with the code shown in listing 16.19.\nListing 16.19    The contents of the ResponseStrings.cs file in the Platform folder \nnamespace Platform {\n    public static class Responses {\n        public static string DefaultResponse = @""\n        <!DOCTYPE html>\n            <html lang=""""en"""">\n            <head>\n                <link rel=""""stylesheet"""" \n                   href=""""/lib/bootstrap/css/bootstrap.min.css"""" />\n                <title>Error</title>\n            </head>\n            <body class=""""text-center"""">\n                <h3 class=""""p-2"""">Error {0}</h3>\n                <h6>\n 445 Handling exceptions and errors\n                    You can go back to the <a href=""""/"""">homepage</a> \n                        and try again\n                </h6>\n            </body>\n        </html>"";\n    }\n}\nThe Responses  class defines a DefaultResponse  property to which I have assigned a \nmultiline string containing a simple HTML document. There is a placeholder— {0}—\ninto which the response status code will be inserted when the response is sent to the \nclient. \nListing 16.20 adds the status code middleware to the request pipeline and adds a new \nmiddleware component that will return a 404 status code, indicating that the requested \nURL was not found.\nListing 16.20    Adding middleware in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\nif (!app.Environment.IsDevelopment()) {\n    app.UseExceptionHandler(""/error.html"");\n    app.UseStaticFiles();\n}\napp.UseStatusCodePages(""text/html"", Platform.Responses.DefaultResponse);\napp.Use(async (context, next) => {\n    if (context.Request.Path == ""/error"") {\n        context.Response.StatusCode = StatusCodes.Status404NotFound;\n        await Task.CompletedTask;\n    } else {\n        await next();\n    }\n});\napp.Run(context => {\n    throw new Exception(""Something has gone wrong"");\n});\napp.Run();\nThe UseStatusCodePages  method adds the response-enriching middleware to the \nrequest pipeline. The first argument is the value that will be used for the response’s \nContent-Type  header, which is text/html  in this example. The second argument is \nthe string that will be used as the body of the response, which is the HTML string from \nlisting 16.19. \nThe custom middleware component sets the HttpResponse.StatusCode  property \nto specify the status code for the response, using a value defined by the StatusCode",4185
199-16.7 Filtering requests using the host header.pdf,199-16.7 Filtering requests using the host header,"446 chapter  16 Using the platform features, part 2 \nclass. Middleware components are required to return a Task , so I have used the Task \n.CompletedTask  property because there is no work for this middleware component to \ndo.\nTo see how the 404 status code is handled, restart ASP.NET Core and request http://\nlocalhost:5000/error. The status code middleware will intercept the result and add the \ncontent shown in figure 16.13 to the response. The string used as the second argu-\nment to UseStatusCodePages  is interpolated using the status code to resolve the \nplaceholder.\nFigure 16.13   \nUsing the \nstatus code \nmiddleware\nThe status code middleware responds only to status codes between 400 and 600 and \ndoesn’t alter responses that already contain content, which means you won’t see the \nresponse in the figure if an error occurs after another middleware component has \nstarted to generate a response. The status code middleware won’t respond to unhan-\ndled exceptions because exceptions disrupt the flow of a request through the pipeline, \nmeaning that the status code middleware isn’t given the opportunity to inspect the \nresponse before it is sent to the client. As a result, the UseStatusCodePages  method \nis typically used in conjunction with the UseExceptionHandler  or UseDeveloper -\nExceptionPage  method.\nNOTE    There are two related methods, UseStatusCodePagesWithRedirects  \nand UseStatusCodePagesWithReExecute , which work by redirecting the client \nto a different URL or by rerunning the request through the pipeline with a dif-\nferent URL. In both cases, the original status code may be lost.\n16.7 Filtering requests using the host header\nThe HTTP specification requires requests to include a Host  header that specifies the \nhostname the request is intended for, which makes it possible to support virtual servers \nwhere one HTTP server receives requests on a single port and handles them differ-\nently based on the hostname that was requested.  \nThe default set of middleware that is added to the request pipeline by the Program  \nclass includes middleware that filters requests based on the Host  header so that only \nrequests that target a list of approved hostnames are handled and all other requests are \nrejected.\n 447 Filtering requests using the host header\nThe default configuration for the Hosts  header middleware is included in the \nappsettings.json  file, as follows:  \n...\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""Location"": {\n    ""CityName"": ""Buffalo""\n  }\n}\n...\nThe AllowedHosts  configuration property is added to the JSON file when the project \nis created, and the default value accepts requests regardless of the Host  header value. \nYou can change the configuration by editing the JSON file. The configuration can also \nbe changed using the options pattern, as shown in listing 16.21.\nNOTE     The middleware is added to the pipeline by default, but you can use the \nUseHostFiltering  method if you need to add the middleware explicitly.\nListing 16.21    Configuring host filtering in the Program.cs file in the Platform folder\nusing Microsoft.AspNetCore.HostFiltering;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.Configure<HostFilteringOptions>(opts => {\n    opts.AllowedHosts.Clear();\n    opts.AllowedHosts.Add(""*.example.com"");\n});\nvar app = builder.Build();\nif (!app.Environment.IsDevelopment()) {\n    app.UseExceptionHandler(""/error.html"");\n    app.UseStaticFiles();\n}\napp.UseStatusCodePages(""text/html"", Platform.Responses.DefaultResponse);\napp.Use(async (context, next) => {\n    if (context.Request.Path == ""/error"") {\n        context.Response.StatusCode = StatusCodes.Status404NotFound;\n        await Task.CompletedTask;\n    } else {\n        await next();\n    }\n});\n448 chapter  16 Using the platform features, part 2 \napp.Run(context => {\n    throw new Exception(""Something has gone wrong"");\n});\napp.Run();\nThe HostFilteringOptions  class is used to configure the host filtering middleware \nusing the properties described in table 16.11.\nTable 16.11   The HostFilteringOptions properties\nName Description\nAllowedHosts This property returns a List<string>  that contains \nthe domains for which requests are allowed. Wildcards \nare allowed so that *.example.com accepts all \nnames in the example.com  domain and * accepts \nall header values.\nAllowEmptyHosts When false , this property tells the middleware to \nreject requests that do not contain a Host  header. The \ndefault value is true .\nIncludeFailureMessage When true , this property includes a message in the \nresponse that indicates the reason for the error. The \ndefault value is true .\nIn listing 16.21, I called the Clear  method to remove the wildcard entry that has been \nloaded from the appsettings.json  file and then called the Add method to accept all \nhosts in the example.com  domain. Requests sent from the browser to localhost will no \nlonger contain an acceptable Host  header. You can see what happens by restarting ASP.\nNET Core and using the browser to request http://localhost:5000. The Host  header \nmiddleware checks the Host  header in the request, determines that the request host-\nname doesn’t match the AllowedHosts  list, and terminates the request with the 400 \nstatus code, which indicates a bad request. Figure 16.14 shows the error message.\nFigure 16.14    \nA request \nrejected based \non the Host \nheader",5578
200-17 Working with data.pdf,200-17 Working with data,"449 Summary\nSummary\n¡ ASP.NET Core provides support for adding cookies to responses and reading \nthose cookies when the client includes them in subsequent requests. \n¡ Sessions allow related requests to be identified to provide continuity across \nrequests. \n¡ ASP.NET Core supports HTTPS requests and can be configured to disallow reg-\nular HTTP requests.\n¡ Limits can be applied to the rate of requests handled by endpoints.\n45017Working with data\nThis chapter covers\n¡ Caching data values or complete responses  \n using ASP.NET Core\n¡ Working with Entity Framework Core to access  \n data in a relational database\nAll the examples in the earlier chapters in this part of the book have generated fresh \nresponses for each request, which is easy to do when dealing with simple strings or \nsmall fragments of HTML. Most real projects deal with data that is expensive to pro-\nduce and needs to be used as efficiently as possible. In this chapter, I describe the \nfeatures that ASP.NET Core provides for caching data and caching entire responses. \nI also show you how to create and configure the services required to access data in a \ndatabase using Entity Framework Core. Table 17.1 puts the ASP.NET Core features \nfor working with data in context.\nNOTE    The examples in this chapter rely on the SQL Server LocalDB fea-\nture that was installed in chapter 2. You will encounter errors if you have not \ninstalled LocalDB and the required updates. \n 451  \nTable 17.1    Putting the ASP .NET Core data features in context\nQuestion Answer\nWhat are they? The features described in this chapter allow responses to be \nproduced using data that has been previously created, either \nbecause it was created for an earlier request or because it has \nbeen stored in a database.\nWhy are they \nuseful?Most web applications deal with data that is expensive to \nre-create for every request. The features in this chapter allow \nresponses to be produced more efficiently and with fewer \nresources.\nHow are they used? Data values are cached using a service. Responses are cached \nby a middleware component based on the Cache-Control  \nheader. Databases are accessed through a service that trans-\nlates LINQ queries into SQL statements. \nAre there any pit-\nfalls or limitations?For caching, it is important to test the effect of your cache policy \nbefore deploying the application to ensure you have found the \nright balance between efficiency and responsiveness. For Entity \nFramework Core, it is important to pay attention to the queries \nsent to the database to ensure that they are not retrieving large \namounts of data that is processed and then discarded by the \napplication.\nAre there any \nalternatives?All the features described in this chapter are optional. You can \nelect not to cache data or responses or to use an external cache. \nYou can choose not to use a database or to access a database \nusing a framework other than Entity Framework Core.\nTable 17.2 provides a guide to the chapter.\nTable 17.2    Chapter guide\nProblem Solution Listing\nCaching data \nvaluesSet up a cache service and use it in endpoints and \nmiddleware components to store data values.3–6\nCreating a per-\nsistent cacheUse the database-backed cache. 7–13\nCaching entire \nresponsesEnable the response or output caching middleware. 14-19\nStoring application \ndata Use Entity Framework Core. 20-26, \n29-31\nCreating a data-\nbase schemaCreate and apply migrations. 27, 28\nAccessing data in \nendpoints Consume the database context service. 32\nIncluding all \nrequest details in \nlogging messagesEnable the sensitive data logging feature. 33",3668
201-17.1 Preparing for this chapter.pdf,201-17.1 Preparing for this chapter,,0
202-17.2 Caching data.pdf,202-17.2 Caching data,"452 chapter  17 Working with data\n17.1 Preparing for this chapter\nIn this chapter, I continue to use the Platform  project from chapter 16. To prepare for \nthis chapter, replace the contents of the Program.cs  file with the code shown in listing \n17.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 17.1    Replacing the contents of the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nStart the application by opening a new PowerShell command prompt, navigating to \nthe Platform  project folder (which contains the Platform.csproj  file), and running \nthe command shown in listing 17.2.\nListing 17.2    Starting the ASP .NET Core runtime \ndotnet run\nOpen a new browser tab, navigate to https://localhost:5000, and you will see the con-\ntent shown in figure 17.1.\nFigure 17.1    Running the example application \n17.2 Caching data\nIn most web applications, there will be some items of data that are relatively expensive \nto generate but are required repeatedly. The exact nature of the data is specific to \neach project, but repeatedly performing the same set of calculations can increase the \nresources required to host the application. To represent an expensive response, add a \nclass file called SumEndpoint.cs  to the Platform  folder with the code shown in listing \n17.3.  \n 453 Caching data\nListing 17.3    The contents of the SumEndpoint.cs file in the Platform folder \nnamespace Platform {\n    public class SumEndpoint {\n        public async Task Endpoint(HttpContext context) {\n            int count;\n            int.TryParse((string?)context.Request.RouteValues[""count""],\n                out count);\n            long total = 0;\n            for (int i = 1; i <= count; i++) {\n                total += i;\n            }\n            string totalString = $""({DateTime.Now.ToLongTimeString()}) ""\n                + total;\n            await context.Response.WriteAsync(\n                $""({DateTime.Now.ToLongTimeString()}) Total for {count}""\n                + $"" values:\n{totalString}\n"");\n        }\n    }\n}\nListing 17.4 creates a route that uses the endpoint, which is applied using the Map-\nEndpoint  extension methods created in chapter 14.\nListing 17.4    Adding an endpoint in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\napp.MapEndpoint<Platform.SumEndpoint>(""/sum/{count:int=1000000000}"");\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nRestart ASP.NET Core and use a browser to request http://localhost:5000/sum. The \nendpoint will sum 1,000,000,000 integer values and produce the result shown in figure \n17.2. \nReload the browser window, and the endpoint will repeat the calculation. Both the \ntimestamps change in the response, as shown in the figure, indicating that every part of \nthe response was produced fresh for each request.\nTIP    You may need to increase or decrease the default value for the route param-\neter based on the capabilities of your machine. Try to find a value that takes two \nor three seconds to produce the result—just long enough that you can tell when \nthe calculation is being performed but not so long that you can step out for cof-\nfee while it happens.",3678
203-17.2.1 Caching data values.pdf,203-17.2.1 Caching data values,"454 chapter  17 Working with data\nFigure 17.2    An expensive response\n17.2.1  Caching data values \nASP.NET Core provides a service that can be used to cache data values through the \nIDistributedCache  interface. Listing 17.5 revises the endpoint to declare a depen-\ndency on the service and use it to cache calculated values.  \nListing 17.5    Using the cache service in the SumEndpoint.cs file in the Platform folder\nusing Microsoft.Extensions.Caching.Distributed;\nnamespace Platform {\n    public class SumEndpoint {\n        public async Task Endpoint(HttpContext context, \n                IDistributedCache cache) {\n            int count;\n            int.TryParse((string?)context.Request.RouteValues[""count""],\n                out count);\n            string cacheKey = $""sum_{count}"";\n            string? totalString = await cache.GetStringAsync(cacheKey);\n            if (totalString == null) {\n                long total = 0;\n                for (int i = 1; i <= count; i++) {\n                    total += i;\n                }\n                totalString = $""({DateTime.Now.ToLongTimeString()}) "" \n                    + total;\n                await cache.SetStringAsync(cacheKey, totalString,\n                    new DistributedCacheEntryOptions {\n                        AbsoluteExpirationRelativeToNow = \n                            TimeSpan.FromMinutes(2)\n                    });\n            }\n            await context.Response.WriteAsync(\n                $""({DateTime.Now.ToLongTimeString()}) Total for {count}""\n                + $"" values:\n{totalString}\n"");\n        }\n    }\n}\nThe cache service can store only byte arrays, which can be restrictive but allows for \na range of IDistributedCache  implementations to be used. There are extension \n 455 Caching data\nmethods available that allow strings to be used, which is a more convenient way of \ncaching most data. Table 17.3 describes the most useful methods for using the cache.  \nTable 17.3    Useful IDistributedCache methods\nName Description\nGetString(key) This method returns the cached string associated \nwith the specified key, or null  if there is no such \nitem.\nGetStringAsync(key) This method returns a Task<string>  that pro-\nduces the cached string associated with the key, or \nnull  if there is no such item.\nSetString(key, value, options) This method stores a string in the cache using the \nspecified key. The cache entry can be configured with \nan optional DistributedCacheEntryOptions  \nobject.\nSetStringAsync(key, value, options) This method asynchronously stores a string in the \ncache using the specified key. The cache entry can \nbe configured with an optional Distributed-\nCacheEntryOptions  object.\nRefresh(key) This method resets the expiry interval for the value \nassociated with the key, preventing it from being \nflushed from the cache.\nRefreshAsync(key) This method asynchronously resets the expiry inter-\nval for the value associated with the key, preventing it \nfrom being flushed from the cache.\nRemove(key) This method removes the cached item associated \nwith the key.\nRemoveAsync(key) This method asynchronously removes the cached \nitem associated with the key.\nBy default, entries remain in the cache indefinitely, but the SetString  and SetString -\nAsync  methods accept an optional DistributedCacheEntryOptions  argument that \nis used to set an expiry policy, which tells the cache when to eject the item. Table 17.4 \nshows the properties defined by the DistributedCacheEntryOptions  class.  \nTable 17.4    The DistributedCacheEntryOptions properties\nName Description\nAbsoluteExpiration This property is used to specify an absolute \nexpiry date.\nAbsoluteExpirationRelativeToNow This property is used to specify a relative expiry \ndate.\nSlidingExpiration This property is used to specify a period of inac-\ntivity, after which the item will be ejected from \nthe cache if it hasn’t been read.\n456 chapter  17 Working with data\nIn listing 17.5, the endpoint uses the GetStringAsync  to see whether there is a cached \nresult available from a previous request. If there is no cached value, the endpoint per-\nforms the calculation and caches the result using the SetStringAsync  method, with \nthe AbsoluteExpirationRelativeToNow  property to tell the cache to eject the item \nafter two minutes.\n...\nawait cache.SetStringAsync(cacheKey, totalStr,\n    new DistributedCacheEntryOptions {\n        AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(2)\n    });\n...\nThe next step is to set up the cache service, as shown in listing 17.6.\nListing 17.6    Adding a service in the Program.cs file in the Platform folder \nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedMemoryCache(opts => {\n    opts.SizeLimit = 200;\n});\nvar app = builder.Build();\napp.MapEndpoint<Platform.SumEndpoint>(""/sum/{count:int=1000000000}"");\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nAddDistributedMemoryCache  is the same method I used in chapter 16 to provide the \ndata store for session data. This is one of the three methods used to select an imple-\nmentation for the IDistributedCache  service, as described in table 17.5.  \nTable 17.5    The cache service implementation methods\nName Description\nAddDistributed  MemoryCache This method sets up an in-memory cache. \nAddDistributed  SqlServerCache This method sets up a cache that stores data in SQL \nServer and is available when the Microsoft.\nExtensions.Caching.SqlServer  package is \ninstalled. See the ""Caching Responses"" section for \ndetails.\nAddStackExchangeRedisCache This method sets up a Redis cache and is available \nwhen the Microsoft.Extensions.Caching.\nRedis package is installed.\nListing 17.6 uses the AddDistributedMemoryCache  method to create an in-mem-\nory cache as the implementation for the IDistributedCache  service. This cache is",5981
204-17.2.2 Using a shared and persistent data cache.pdf,204-17.2.2 Using a shared and persistent data cache,"457 Caching data\nconfigured using the MemoryDistributedCacheOptions  class, whose most useful \nproperties are described in table 17.6.  \nTable 17.6    Useful MemoryCacheOptions properties\nName Description\nExpirationScanFrequency This property is used to set a TimeSpan  that \ndetermines how often the cache scans for \nexpired items.\nSizeLimit This property specifies the maximum num -\nber of items in the cache. When the size is \nreached, the cache will eject items.\nCompactionPercentage This property specifies the percentage by \nwhich the size of the cache is reduced when \nSizeLimit  is reached.\nThe statement in listing 17.6 uses the SizeLimit  property to restrict the cache to 200 \nitems. Care must be taken when using an in-memory cache to find the right balance \nbetween allocating enough memory for the cache to be effective without exhausting \nserver resources.\nTo see the effect of the cache, restart ASP.NET Core and request the http://  \nlocalhost:5000/sum URL. Reload the browser, and you will see that only one of the \ntimestamps will change, as shown in figure 17.3. This is because the cache has provided \nthe calculation response, which allows the endpoint to produce the result without hav-\ning to repeat the calculation.\nFigure 17.3.    Caching data values\nIf you wait for two minutes and then reload the browser, then both timestamps will \nchange because the cached result will have been ejected, and the endpoint will have to \nperform the calculation to produce the result.\n17.2.2  Using a shared and persistent data cache\nThe cache created by the AddDistributedMemoryCache  method isn’t distributed, \ndespite the name. The items are stored in memory as part of the ASP.NET Core pro-\ncess, which means that applications that run on multiple servers or containers don’t \nshare cached data. It also means that the contents of the cache are lost when ASP.NET \nCore is stopped. \n458 chapter  17 Working with data\nThe AddDistributedSqlServerCache  method stores the cache data in a SQL \nServer database, which can be shared between multiple ASP.NET Core servers and \nwhich stores the data persistently. \nThe first step is to create a database that will be used to store the cached data. You \ncan store the cached data alongside the application’s other data, but for this chapter, I \nam going to use a separate database, which will be named CacheDb . You can create the \ndatabase using Azure Data Studio or SQL Server Management Studio, both of which \nare available for free from Microsoft. Databases can also be created from the command \nline using sqlcmd . Open a new PowerShell command prompt and run the command \nshown in listing 17.7 to connect to the LocalDB server.  \nTIP    The sqlcmd  tool should have been installed as part of the Visual Studio \nworkload or as part of the SQL Server Express installation. If it has not been \ninstalled, then you can download an installer from https://docs.microsoft.com/\nen-us/sql/tools/sqlcmd-utility .\nListing 17.7    Connecting to the database server\nsqlcmd -S ""(localdb)\MSSQLLocalDB""\nPay close attention to the argument that specifies the database. There is one backs-\nlash, which is followed by MSSQLLocalDB . It can be hard to spot the repeated letters: \nMS-SQL-LocalDB (but without the hyphens).  \nWhen the connection has been established, you will see a 1> prompt. Enter the com-\nmands shown in listing 17.8 and press the Enter key after each command.\nCAUTION    If you are using Visual Studio, you must apply the updates for SQL \nServer described in chapter 2. The version of SQL Server that is installed by \ndefault when you install Visual Studio cannot create LocalDB databases.\nListing 17.8    Creating the database \nCREATE DATABASE CacheDb\nGO\nIf no errors are reported, then enter exit  and press Enter to terminate the connection. \nTIP    If you need to reset the cache database, use the command in listing 17.7 to \nopen a connection and use the command DROP DATABASE CacheDB . You can \nthen re-create the database using the commands in listing 17.8.\nRun the commands shown in listing 17.9 to install the package required to create a \ncache.\nListing 17.9    Installing the SQL cache package \ndotnet tool uninstall --global dotnet-sql-cache\ndotnet tool install --global dotnet-sql-cache --version 7.0.0\n 459 Caching data\nThe first command removes any existing version of the dotnet-sql-cache  package, \nand the second command installs the version required for the examples in this book. \nThe next step is to run the command shown in listing 17.10 to create a table in the new \ndatabase, using the command installed by the dotnet-sql-cache  package.\nListing 17.10    Creating the cache database table\ndotnet sql-cache create ""Server=(localdb)\MSSQLLocalDB;Database=CacheDb""  \ndbo DataCache\nThe arguments for this command are the connection string that specifies the database, \nthe schema, and the name of the table that will be used to store the cached data. Enter \nthe command on a single line and press Enter. It will take a few seconds for the tool to \nconnect to the database. If the process is successful, you will see the following message:\nTable and index were created successfully.\ncreating  the persistent  cache  service  \nNow that the database is ready, I can create the service that will use it to store cached \ndata. To add the NuGet package required for SQL Server caching support, open a new \nPowerShell command prompt, navigate to the Platform  project folder, and run the \ncommand shown in listing 17.11. (If you are using Visual Studio, you can add the pack-\nage by selecting Project > Manage NuGet Packages.)  \nListing 17.11    Adding a package to the project \ndotnet add package Microsoft.Extensions.Caching.SqlServer --version 7.0.0 \nThe next step is to define a connection string, which describes the database connec-\ntion in the JSON configuration file, as shown in listing 17.12.\nNOTE    The cache created by the AddDistributedSqlServerCache  method is \ndistributed, meaning that multiple applications can use the same database and \nshare cache data. If you are deploying the same application to multiple servers \nor containers, all instances will be able to share cached data. If you are sharing a \ncache between different applications, then you should pay close attention to the \nkeys you use to ensure that applications receive the data types they expect.\nListing 17.12    A connection string in the appsettings.json file in the Platform folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""Location"": {\n    ""CityName"": ""Buffalo""\n  },\n460 chapter  17 Working with data\n  ""ConnectionStrings"": {\n    ""CacheConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=CacheDb""\n  }\n}\nNotice that the connection string uses two backslash characters ( \\) to escape the \ncharacter in the JSON file. Listing 17.13 changes the implementation for the cache \nservice to use SQL Server with the connection string from listing 17.12.\nListing 17.13    Using a persistent data cache in the Program.cs file in the Platform folder\nvar builder = WebApplication.CreateBuilder(args);\n//builder.Services.AddDistributedMemoryCache(opts => {\n//    opts.SizeLimit = 200;\n//});\nbuilder.Services.AddDistributedSqlServerCache(opts => {\n    opts.ConnectionString\n        = builder.Configuration[""ConnectionStrings:CacheConnection""];\n    opts.SchemaName = ""dbo"";\n    opts.TableName = ""DataCache"";\n});\nvar app = builder.Build();\napp.MapEndpoint<Platform.SumEndpoint>(""/sum/{count:int=1000000000}"");\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThe IConfiguration  service is used to access the connection string from the \napplication’s configuration data. The cache service is created using the Add-\nDistributedSqlServerCache  method and is configured using an instance of the \nSqlServerCacheOptions  class, whose most useful properties are described in table \n17.7.  \nTable 17.7.    Useful SqlServerCacheOptions properties\nName Description\nConnectionString This property specifies the connection string, which is \nconventionally stored in the JSON configuration file and \naccessed through the IConfguration  service.\nSchemaName This property specifies the schema name for the cache table.\nTableName This property specifies the name of the cache table.\nExpiredItemsDeletionInterval This property specifies how often the table is scanned for \nexpired items. The default is 30 minutes.\nDefaultSlidingExpiration This property specifies how long an item remains unread in \nthe cache before it expires. The default is 20 minutes.",8797
205-17.3 Caching responses.pdf,205-17.3 Caching responses,"461 Caching responses \nThe listing uses the ConnectionString , SchemaName , and TableName  properties to \nconfigure the cache middleware to use the database table. Restart ASP.NET Core and \nuse a browser to request the http://localhost:5000/sum URL. There is no change in \nthe response produced by the application, which is shown in figure 17.4, but you will \nfind that the cached responses are persistent and will be used even when you restart \nASP.NET Core. \nCaching session-specific data values \nWhen you use the IDistributedCache  service, the data values are shared between \nall requests. If you want to cache different data values for each user, then you can use \nthe session middleware described in chapter 16. The session middleware relies on \nthe IDistributedCache  service to store its data, which means that session data \nwill be stored persistently and available to a distributed application when the Add-\nDistributedSqlServerCache  method is used.\n17.3 Caching responses \nAn alternative to caching individual data items is to cache entire responses, which can \nbe a useful approach if a response is expensive to compose and is likely to be repeated. \nCaching responses requires the addition of a service and a middleware component, as \nshown in listing 17.14.  \nListing 17.14    Configuring Caching in the Program.cs File in the Platform Folder\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDistributedSqlServerCache(opts => {\n    opts.ConnectionString\n        = builder.Configuration[""ConnectionStrings:CacheConnection""];\n    opts.SchemaName = ""dbo"";\n    opts.TableName = ""DataCache"";\n});\nbuilder.Services.AddResponseCaching();\nbuilder.Services.AddSingleton<IResponseFormatter, \n    HtmlResponseFormatter>();\nvar app = builder.Build();\napp.UseResponseCaching();\napp.MapEndpoint<Platform.SumEndpoint>(""/sum/{count:int=1000000000}"");\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\n462 chapter  17 Working with data\nThe AddResponseCaching  method is used to set up the service used by the cache. \nThe middleware component is added with the UseResponseCaching  method, which \nshould be called before any endpoint or middleware that needs its responses cached.  \nI have also defined the IResponseFormatter  service, which I used to explain how \ndependency injection works in chapter 14. Response caching is used only in certain \ncircumstances, and, as I explain shortly, demonstrating the feature requires an HTML \nresponse.\nNOTE     The response caching feature does not use the IDistributedCache  ser-\nvice. Responses are cached in memory and are not distributed. \nIn listing 17.15, I have updated the SumEndpoint  class so that it requests response \ncaching instead of caching just a data value.\nListing 17.15    Using response caching in the SumEndpoint.cs file in the Platform folder\n//using Microsoft.Extensions.Caching.Distributed;\nusing Platform.Services;\nnamespace Platform {\n    public class SumEndpoint {\n        public async Task Endpoint(HttpContext context, \n                IResponseFormatter formatter, LinkGenerator generator) {\n            int count;\n            int.TryParse((string?)context.Request.RouteValues[""count""],\n                out count);\n            long total = 0;\n            for (int i = 1; i <= count; i++) {\n                total += i;\n            }\n            string totalString = $""({DateTime.Now.ToLongTimeString()}) "" \n                + total;\n            context.Response.Headers[""Cache-Control""] \n                = ""public, max-age=120"";\n            string? url = generator.GetPathByRouteValues(context, null,\n                new { count = count });\n            await formatter.Format(context,\n                $""<div>({DateTime.Now.ToLongTimeString()}) Total for ""\n                + $""{count} values:</div><div>{totalString}</div>""\n                + $""<a href={url}>Reload</a>"");\n        }\n    }\n}\nSome of the changes to the endpoint enable response caching, but others are just to \ndemonstrate that it is working. For enabling response caching, the important state-\nment is the one that adds a header to the response, like this:\n 463 Caching responses \n...\ncontext.Response.Headers[""Cache-Control""] = ""public, max-age=120"";\n...\nThe Cache-Control  header is used to control response caching. The middleware will \nonly cache responses that have a Cache-Control  header that contains the public  \ndirective. The max-age  directive is used to specify the period that the response can \nbe cached for, expressed in seconds. The Cache-Control  header used in listing 17.15 \nenables caching and specifies that responses can be cached for two minutes.  \nEnabling response caching is simple, but checking that it is working requires care. \nWhen you reload the browser window or press Return in the URL bar, browsers will \ninclude a Cache-Control  header in the request that sets the max-age  directive to zero, \nwhich bypasses the response cache and causes a new response to be generated by the \nendpoint. The only reliable way to request a URL without the Cache-Control  header is \nto navigate using an HTML anchor element, which is why the endpoint in listing 17.15 \nuses the IResponseFormatter  service to generate an HTML response and uses the \nLinkGenerator  service to create a URL that can be used in the anchor element’s href  \nattribute. \nTo check the response cache, restart ASP.NET Core and use the browser to request \nhttp://localhost:5000/sum. Once the response has been generated, click the Reload \nlink to request the same URL. You will see that neither of the timestamps in the response \nchange, indicating that the entire response has been cached, as shown in figure 17.4.\nFigure 17.4    \nCaching \nresponses\nThe Cache-Control  header can be combined with the Vary  header to provide fine-\ngrained control over which requests are cached. See https://developer.mozilla.org/\nen-US/docs/Web/HTTP/Headers/Cache-Control  and https://developer.mozilla.\norg/en-US/docs/Web/HTTP/Headers/Vary  for details of the features provided by \nboth headers.  \nCompressing responses \nASP.NET Core includes middleware that will compress responses for browsers that have \nindicated they can handle compressed data. The middleware is added to the pipeline \nwith the UseResponseCompression  method. Compression is a trade-off between the \nserver resources required for compression and the bandwidth required to deliver content \nto the client, and it should not be switched on without testing to determine the perfor-\nmance impact.",6689
206-17.4 Caching output.pdf,206-17.4 Caching output,"464 chapter  17 Working with data\n17.4 Caching output\nThe use of the Cache-Control  header follows the intended design of HTTP but lim-\nits the benefits of caching responses. ASP.NET Core includes an alternative approach \nto caching, known as output caching , which overcomes these problems and provides a \nmore configurable—albeit complex—set of features. Caching is applied to endpoints \nand to prepare for this example, I need to update the code written in chapter 14 so \nthat it produces a result on which the caching extension method can be invoked, as \nshown in listing 17.16.\nNOTE     The output cache feature is more comprehensive than response caching \nbut has its own limitations. There is an API for implementing persistent cache \nstorage, for example, but no default implementation. The distributed cache \nused in earlier examples can’t be used because output caching requires careful \nlocking of cached data. \nListing 17.16    A result in the EndpointExtensions.cs file in the Platform/Services folder\nusing System.Reflection;\nnamespace Microsoft.AspNetCore.Builder {\n    public static class EndpointExtensions {\n        public static IEndpointConventionBuilder MapEndpoint<T>(\n                this IEndpointRouteBuilder app,\n                string path, string methodName = ""Endpoint"") {\n            MethodInfo? methodInfo = typeof(T).GetMethod(methodName);\n            if (methodInfo?.ReturnType != typeof(Task)) {\n                throw new System.Exception(""Method cannot be used"");\n            }\n            ParameterInfo[] methodParams = methodInfo!.GetParameters();\n            return app.MapGet(path, context => {\n                T endpointInstance =\n                    ActivatorUtilities.CreateInstance<T>\n                        (context.RequestServices);\n                return (Task)methodInfo.Invoke(endpointInstance!,\n                    methodParams.Select(p =>\n                    p.ParameterType == typeof(HttpContext)\n                    ? context\n                    : context.RequestServices.GetService(p.ParameterType))\n                        .ToArray())!;\n            });\n        }\n    }\n}\nThis change alters the MapEndpoint<T>  extension method to produce an implementa-\ntion of the IEndpointConventionBuilder  interface, which is the result produced by \n 465 Caching output\nthe built-in MapGet  method and the other methods used to create endpoints. Listing \n17.17 replaces the response caching from the previous section with output caching.\nListing 17.17    Using output caching in the Program.cs file in the Platform folder  \nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\n//builder.Services.AddDistributedSqlServerCache(opts => {\n//    opts.ConnectionString\n//        = builder.Configuration[""ConnectionStrings:CacheConnection""];\n//    opts.SchemaName = ""dbo"";\n//    opts.TableName = ""DataCache"";\n//});\nbuilder.Services.AddOutputCache();\n//builder.Services.AddResponseCaching();\nbuilder.Services.AddSingleton<IResponseFormatter, \n    HtmlResponseFormatter>();\nvar app = builder.Build();\n//app.UseResponseCaching();\napp.UseOutputCache();\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum/{count:int=1000000000}"")\n    .CacheOutput(); \napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThis is the simplest output caching configuration, and it is applied in three parts. First, \nthe AddOutputCache  method is called to set up the services required for caching. Sec-\nond, the UseOutputCache  method is called to register the caching middleware, which \nwill short-circuit the pipeline where requests are received that can be handled using \ncached content. The final step enables caching for a specific endpoint, which is done \nusing the CacheOutput  extension method:\n...\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum/{count:int=1000000000}"")\n    .CacheOutput ();\n...\nThis extension method enables caching for the sum endpoint. The final step is to \nupdate the endpoint so that it doesn’t set the caching header, as shown in listing 17.18.\n466 chapter  17 Working with data\nListing 17.18    Disabling the header in the SumEndpoint.cs file in the Platform folder\n//using Microsoft.Extensions.Caching.Distributed;\nusing Platform.Services;\nnamespace Platform {\n    public class SumEndpoint {\n        public async Task Endpoint(HttpContext context, \n                IResponseFormatter formatter, LinkGenerator generator) {\n            int count;\n            int.TryParse((string?)context.Request.RouteValues[""count""],\n                out count);\n            long total = 0;\n            for (int i = 1; i <= count; i++) {\n                total += i;\n            }\n            string totalString = $""({DateTime.Now.ToLongTimeString()}) "" \n                + total;\n            //context.Response.Headers[""Cache-Control""] \n            //    = ""public, max-age=120"";\n            string? url = generator.GetPathByRouteValues(context, null,\n                new { count = count });\n            await formatter.Format(context,\n                $""<div>({DateTime.Now.ToLongTimeString()}) Total for ""\n                + $""{count} values:</div><div>{totalString}</div>""\n                + $""<a href={url}>Reload</a>"");\n        }\n    }\n}\nThe endpoint doesn’t need to manage the caching of its content directly, which means \nthat the cache settings can be altered without needing to change the code that gener-\nates responses. \nThe configuration used in listing 17.18 applies the default caching policy, which \ncaches content for one minute and caches only HTTP GET or HEAD requests that pro-\nduce HTTP 200 responses, and which are not authenticated or set cookies. \nTo check the output cache, restart ASP.NET Core and use the browser to request \nhttp://localhost:5000/sum. You will see the same output as in earlier examples, but \nnow the cache is applied when the browser is reloaded and not just when the user clicks \non the link, as shown in figure 17.5.",6076
207-17.4.1 Defining a custom cache policy.pdf,207-17.4.1 Defining a custom cache policy,"467 Caching output\nFigure 17.5.    Output caching applies to all requests for a given URL\n17.4.1  Defining a custom cache policy\nThe output caching feature supports custom caching policies and allows different poli-\ncies to be applied to endpoints. Caching policies are defined using the options pattern, \nas shown in listing 17.19.\nListing 17.19    A custom configuration in the Program.cs file in the Platform folder\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddOutputCache(opts => {\n    opts.AddBasePolicy(policy => {\n        policy.Cache();\n        policy.Expire(TimeSpan.FromSeconds(10));\n    });\n    opts.AddPolicy(""30sec"", policy => {\n        policy.Cache(); \n        policy.Expire(TimeSpan.FromSeconds(30));\n    });\n});\nbuilder.Services.AddSingleton<IResponseFormatter, \n    HtmlResponseFormatter>();\nvar app = builder.Build();\napp.UseOutputCache();\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum/{count:int=1000000000}"")\n    .CacheOutput();\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum30/{count:int=1000000000}"")\n    .CacheOutput(""30sec"");\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\n468 chapter  17 Working with data\nThe options pattern is applied to an OutputCacheOptions  object, whose most useful \nmethods are described in table 17.8.\nTable 17.8  Useful OutputCacheOptions methods\nName Description\nAddBasePolicy This method is used to define the default policy \nAddPolicy This method is used to create a policy that can be \napplied to specific endpoints.\nThe methods described in table 17.8 define policies using the methods defined by the \nOutputCachePolicyBuilder  class. The basic methods are described in table 17.9.\nTable 17.9  The basic OutputCachePolicyBuilder methods\nName Description\nExpire This method sets the expiry interval for cached output, \nexpressed as a TimeSpan .\nSetLocking This method is used to enable or disable locking in the \ncache. Locking is enabled by default and should only be \ndisabled with caution since it can lead to unexpected \nbehavior.\nNoCache This method disables caching in the policy. \nCache This method enables caching in the policy. \nThe policies in listing 17.19 use the Cache  and Expire  methods. The AddBasePolicy  \nmethod is used to change the cache duration for the default policy. The AddPolicy  \nmethod is used to create a new cache policy named 30sec , which caches output for 30 \nseconds:\n...\nopts.AddPolicy("" 30sec"", policy => {\n    policy.Cache(); \n    policy.Expire(TimeSpan.FromSeconds(30));\n});\n...\nThe name given to a policy created with the AddPolicy  method is used to apply the \npolicy to an endpoint, like this:\n...\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum30/{count:int=1000000000}"")\n    .CacheOutput(""30sec"") ;\n...\nThe result is that requests to the /sum  URL are cached using the default policy, while \nrequests to the /sum30  URL are cached using the 30sec  policy, causing the output \nfrom the endpoints to be cached for a different duration.",3118
208-17.5 Using Entity Framework Core.pdf,208-17.5 Using Entity Framework Core,,0
209-17.5.3 Configuring the database service.pdf,209-17.5.3 Configuring the database service,"469 Using Entity Framework Core \n17.5 Using Entity Framework Core \nNot all data values are produced directly by the application, and most projects will \nneed to access data in a database. Entity Framework Core is well-integrated into the \nASP.NET Core platform, with good support for creating a database from C# classes and \nfor creating C# classes to represent an existing database. In the sections that follow, I \ndemonstrate the process for creating a simple data model, using it to create a database, \nand querying that database in an endpoint.\nWorking with Entity Framework Core \nThe most common complaint about Entity Framework Core is poor performance. When \nI review projects that have Entity Framework Core performance issues, the problem is \nalmost always because the development team has treated Entity Framework Core as a \nblack box and has not paid attention to the SQL queries that are sent to the database. \nNot all LINQ features can be translated into SQL, and the most common problem is a \nquery that retrieves large amounts of data from the database, which is then discarded \nafter it has been reduced to produce a single value.\nUsing Entity Framework Core requires a good understanding of SQL and ensuring that \nthe LINQ queries made by the application are translated into efficient SQL queries. There \nare rare applications that have high-performance data requirements that cannot be met \nby Entity Framework Core, but that isn’t the case for most typical web applications.\nThat is not to say that Entity Framework Core is perfect. It has its quirks and requires \nan investment in time to become proficient. If you don’t like the way that Entity Frame -\nwork Core works, then you may prefer to use an alternative, such as Dapper ( https://\ndapperlib.github.io/Dapper ). But if your issue is that queries are not being performed \nfast enough, then you should spend some time exploring how those queries are being \nprocessed, which you can do using the techniques described in the remainder of the \nchapter.\n17.5.1  Installing Entity Framework Core\nEntity Framework Core requires a global tool package that is used to manage databases \nfrom the command line and to manage packages for the project that provides data \naccess. To install the tools package, open a new PowerShell command prompt and run \nthe commands shown in listing 17.20.  \nListing 17.20    Installing the Entity Framework Core Global Tool Package\ndotnet tool uninstall --global dotnet-ef\ndotnet tool install --global dotnet-ef --version 7.0.0\nThe first command removes any existing version of the dotnet-ef  package, and the \nsecond command installs the version required for the examples in this book. This \npackage provides the dotnet ef  commands that you will see in later examples. To \nensure the package is working as expected, run the command shown in listing 17.21.  \n470 chapter  17 Working with data\nListing 17.21    Testing the Entity Framework Core Global Tool\ndotnet ef --help\nThis command shows the help message for the global tool and produces the following \noutput:\nEntity Framework Core .NET Command-line Tools 7.0.0\nUsage: dotnet ef [options] [command]\nOptions:\n  --version        Show version information \n  -h|--help        Show help information \n  -v|--verbose     Show verbose output. \n  --no-color       Don't colorize output. \n  --prefix-output  Prefix output with level.\nCommands: \n  database    Commands to manage the database. \n  dbcontext   Commands to manage DbContext types. \n  migrations  Commands to manage migrations.\nUse ""dotnet ef [command] --help"" for more information about a command.\nEntity Framework Core also requires packages to be added to the project. If you are \nusing Visual Studio Code or prefer working from the command line, navigate to the \nPlatform  project folder (the folder that contains the Platform.csproj  file) and run \nthe commands shown in listing 17.22.  \nListing 17.22    Adding Entity Framework Core Packages to the Project\ndotnet add package Microsoft.EntityFrameworkCore.Design --version 7.0.0 \ndotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 7.0.0\n17.5.2  Creating the data model \nFor this chapter, I am going to define the data model using C# classes and use Entity \nFramework Core to create the database and schema. Create the Platform/Models  \nfolder and add to it a class file called Calculation.cs  with the contents shown in \nlisting 17.23.  \nListing 17.23    The contents of the Calculation.cs file in the Platform/Models folder\nnamespace Platform.Models {\n    public class Calculation {\n        public long Id { get; set; }\n        public int Count { get; set; }\n        public long Result { get; set; }\n    }\n}\nYou can see more complex data models in other chapters, but for this example, I am \ngoing to keep with the theme of this chapter and model the calculation performed in \nearlier examples. The Id property will be used to create a unique key for each object \nstored in the database, and the Count  and Result  properties will describe a calcula-\ntion and its result.\n 471 Using Entity Framework Core \nEntity Framework Core uses a context class that provides access to the database. Add \na file called CalculationContext.cs  to the Platform/Models  folder with the con-\ntent shown in listing 17.24.  \nListing 17.24    The CalculationContext.cs file in the Platform/Models folder\nusing Microsoft.EntityFrameworkCore;\nnamespace Platform.Models {\n    public class CalculationContext : DbContext {\n        public CalculationContext(\n            DbContextOptions<CalculationContext> opts) : base(opts) { }\n        public DbSet<Calculation> Calculations => Set<Calculation>();\n    }\n}\nThe CalculationContext  class defines a constructor that is used to receive an options \nobject that is passed on to the base constructor. The Calculations  property provides \naccess to the Calculation  objects that Entity Framework Core will retrieve from the \ndatabase. \n17.5.3  Configuring the database service\nAccess to the database is provided through a service, as shown in listing 17.25.  \nListing 17.25    Configuring the data service in the Program.cs file in the Platform folder\nusing Platform.Services;\nusing Platform.Models;\nusing Microsoft.EntityFrameworkCore;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddOutputCache(opts => {\n    opts.AddBasePolicy(policy => {\n        policy.Cache();\n        policy.Expire(TimeSpan.FromSeconds(10));\n    });\n    opts.AddPolicy(""30sec"", policy => {\n        policy.Cache();\n        policy.Expire(TimeSpan.FromSeconds(30));\n    });\n});\nbuilder.Services.AddSingleton<IResponseFormatter,\n    HtmlResponseFormatter>();\nbuilder.Services.AddDbContext<CalculationContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:CalcConnection""]);\n});\n472 chapter  17 Working with data\nvar app = builder.Build();\napp.UseOutputCache();\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum/{count:int=1000000000}"")\n    .CacheOutput();\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum30/{count:int=1000000000}"")\n    .CacheOutput(""30sec"");\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\napp.Run();\nThe AddDbContext  method creates a service for an Entity Framework Core context \nclass. The method receives an options object that is used to select the database pro-\nvider, which is done with the UseSqlServer  method. The IConfiguration  service is \nused to get the connection string for the database, which is defined in listing 17.26.  \nListing 17.26    A connection string in the appsettings.json file in the Platform folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning"",\n      ""Microsoft.EntityFrameworkCore"": ""Information""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""Location"": {\n    ""CityName"": ""Buffalo""\n  },\n  ""ConnectionStrings"": {\n    ""CacheConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=CacheDb"",\n    ""CalcConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=CalcDb""\n  }\n}\nThe listing also sets the logging level for the Microsoft.EntityFrameworkCore  cat-\negory, which will show the SQL statements that are used by Entity Framework Core to \nquery the database.\nTIP    Set the MultipleActiveResultSets  option to True  for connection strings \nthat will be used to make queries with multiple result sets. You can see an exam-\nple of this option set in the connection strings for the SportsStore project in \nchapter 7.",8644
210-17.5.4 Creating and applying the database migration.pdf,210-17.5.4 Creating and applying the database migration,,0
211-17.5.5 Seeding the database.pdf,211-17.5.5 Seeding the database,"473 Using Entity Framework Core \n17.5.4  Creating and applying the database migration \nEntity Framework Core manages the relationship between data model classes and \nthe database using a feature called migrations . When changes are made to the model \nclasses, a new migration is created that modifies the database to match those changes. \nTo create the initial migration, which will create a new database and prepare it to store \nCalculation  objects, open a new PowerShell command prompt, navigate to the folder \nthat contains the Platform.csproj  file, and run the command shown in listing 17.27.  \nListing 17.27    Creating a migration \ndotnet ef migrations add Initial\nThe dotnet ef  commands relate to Entity Framework Core. The command in listing \n17.27 creates a new migration named Initial , which is the name conventionally given \nto the first migration for a project. You will see that a Migrations  folder has been \nadded to the project and that it contains class files whose statements prepare the data-\nbase so that it can store the objects in the data model. To apply the migration, run the \ncommand shown in listing 17.28 in the Platform  project folder.  \nListing 17.28    Applying a migration \ndotnet ef database update\nThis command executes the commands in the migration and uses them to prepare the \ndatabase, which you can see in the SQL statements written to the command prompt.\n17.5.5  Seeding the database\nMost applications require some seed data, especially during development. Entity \nFramework Core does provide a database seeding feature, but it is of limited use for \nmost projects because it doesn’t allow data to be seeded where the database allocates \nunique keys to the objects it stores. This is an important feature in most data models \nbecause it means the application doesn’t have to worry about allocating unique key \nvalues.  \nA more flexible approach is to use the regular Entity Framework Core features to add \nseed data to the database. Create a file called SeedData.cs  in the Platform/  Models  \nfolder with the code shown in listing 17.29.\nListing 17.29   The contents of the SeedData.cs file in the Platform/Models folder \nusing Microsoft.EntityFrameworkCore;\nnamespace Platform.Models {\n    public class SeedData {\n        private CalculationContext context;\n        private ILogger<SeedData> logger;\n        private static Dictionary<int, long> data\n            = new Dictionary<int, long>() {\n474 chapter  17 Working with data\n                {1, 1}, {2, 3}, {3, 6}, {4, 10}, {5, 15},\n                {6, 21}, {7, 28}, {8, 36}, {9, 45}, {10, 55}\n            };\n        public SeedData(CalculationContext dataContext, \n                ILogger<SeedData> log) {\n            context = dataContext;\n            logger = log;\n        }\n        public void SeedDatabase() {\n            context.Database.Migrate();\n            if (context.Calculations?.Count() == 0) {\n                logger.LogInformation(""Preparing to seed database"");\n                context.Calculations.AddRange(\n                        data.Select(kvp => new Calculation() {\n                            Count = kvp.Key, Result = kvp.Value\n                        }));\n                context.SaveChanges();\n                logger.LogInformation(""Database seeded"");\n            } else {\n                logger.LogInformation(""Database not seeded"");\n            }\n        }\n    }\n}\nThe SeedData  class declares constructor dependencies on the CalculationContext  \nand ILogger<T>  types, which are used in the SeedDatabase  method to prepare the \ndatabase. The context’s Database.Migrate  method is used to apply any pending \nmigrations to the database, and the Calculations  property is used to store new data \nusing the AddRange  method, which accepts a sequence of Calculation  objects. \n The new objects are stored in the database using the SaveChanges  method. To use \nthe SeedData  class, make the changes shown in listing 17.30 to the Program.cs  file. \nListing 17.30    Enabling database seeding in the Program.cs file in the Platform folder\nusing Microsoft.EntityFrameworkCore;\nusing Platform.Models;\nusing Platform.Services;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddOutputCache(opts => {\n    opts.AddBasePolicy(policy => {\n        policy.Cache();\n        policy.Expire(TimeSpan.FromSeconds(10));\n    });\n    opts.AddPolicy(""30sec"", policy => {\n        policy.Cache();\n        policy.Expire(TimeSpan.FromSeconds(30));\n    });\n});\n 475 Using Entity Framework Core \nbuilder.Services.AddSingleton<IResponseFormatter,\n    HtmlResponseFormatter>();\nbuilder.Services.AddDbContext<CalculationContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:CalcConnection""]);\n});\nbuilder.Services.AddTransient<SeedData>();\nvar app = builder.Build();\napp.UseOutputCache();\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum/{count:int=1000000000}"")\n    .CacheOutput();\napp.MapEndpoint<Platform\n    .SumEndpoint>(""/sum30/{count:int=1000000000}"")\n    .CacheOutput(""30sec"");\napp.MapGet(""/"", async context => {\n    await context.Response.WriteAsync(""Hello World!"");\n});\nbool cmdLineInit = (app.Configuration[""INITDB""] ?? ""false"") == ""true"";\nif (app.Environment.IsDevelopment() || cmdLineInit) {\n    var seedData = app.Services.GetRequiredService<SeedData>();\n    seedData.SeedDatabase();\n}\nif (!cmdLineInit) {\n    app.Run();\n}\nI create a service for the SeedData  class, which means that it will be instantiated, and \nits dependencies will be resolved, which is more convenient than working directly with \nthe class constructor.\nIf the hosting environment is Development , the database will be seeded automati-\ncally as the application starts. It can also be useful to seed the database explicitly, espe-\ncially when setting up the application for staging or production testing. This statement \nchecks for a configuration setting named INITDB : \n...\nbool cmdLineInit = ( app.Configuration[""INITDB""]  ?? ""false"") == ""true"";\n...\nThis setting can be supplied on the command line to seed the database, after which the \napplication will terminate because the Run method, which starts listening for HTTP \nrequests, is never called.\nTo seed the database, open a new PowerShell command prompt, navigate to the \nproject folder, and run the command shown in listing 17.31.",6448
212-17.5.6 Using data in an endpoint.pdf,212-17.5.6 Using data in an endpoint,"476 chapter  17 Working with data\nListing 17.31    Seeding the database\ndotnet run INITDB=true\nThe application will start, and the database will be seeded with the results for the ten \ncalculations defined by the SeedData  class, after which the application will terminate. \nDuring the seeding process, you will see the SQL statements that are sent to the data-\nbase, which check to see whether there are any pending migrations, count the number \nof rows in the table used to store Calculation  data, and, if the table is empty, add the \nseed data. \nNOTE    If you need to reset the database, you can use the dotnet ef database \ndrop --force  command. You can then use dotnet run INITDB=true  to re-cre-\nate and seed the database again.\n17.5.6  Using data in an endpoint\nEndpoints and middleware components access Entity Framework Core data by declar-\ning a dependency on the context class and using its DbSet<T>  properties to perform \nLINQ queries. The LINQ queries are translated into SQL and sent to the database. \nThe row data received from the database is used to create data model objects that are \nused to produce responses. Listing 17.32 updates the SumEndpoint  class to use Entity \nFramework Core.  \nListing 17.32    Using a database in the SumEndpoint.cs file in the Platform folder\n//using Platform.Services;\nusing Platform.Models;\nnamespace Platform {\n    public class SumEndpoint {\n        public async Task Endpoint(HttpContext context, \n                CalculationContext dataContext) {\n            int count;\n            int.TryParse((string?)context.Request.RouteValues[""count""],\n                out count);\n            long total = dataContext.Calculations?\n                .FirstOrDefault(c => c.Count == count)?.Result ?? 0;\n            if (total == 0) {\n                for (int i = 1; i <= count; i++) {\n                    total += i;\n                }\n                dataContext.Calculations?.Add(new() {\n                    Count = count, Result = total\n                });\n                await dataContext.SaveChangesAsync();\n            }\n 477 Using Entity Framework Core \n            string totalString = $""({DateTime.Now.ToLongTimeString()}) "" \n                + total;\n            await context.Response.WriteAsync(\n                $""({DateTime.Now.ToLongTimeString()}) Total for {count}""\n                + $"" values:\n{totalString}\n"");\n        }\n    }\n}\nThe endpoint uses the LINQ FirstOrDefault  to search for a stored Calculation  \nobject for the calculation that has been requested like this:\n...\ndataContext.Calculations?\n    .FirstOrDefault (c => c.Count == count)?.Result ?? 0;            \n...\nIf an object has been stored, it is used to prepare the response. If not, then the calcula-\ntion is performed, and a new Calculation  object is stored by these statements:\n...\ndataContext.Calculations?.Add(new () { Count = count, Result = total});\nawait dataContext.SaveChangesAsync();\n...\nThe Add method is used to tell Entity Framework Core that the object should be stored, \nbut the update isn’t performed until the SaveChangesAsync  method is called. To see \nthe effect of the changes, restart ASP.NET Core MVC (without the INITDB  argument \nif you are using the command line) and request the http://localhost:5000/sum/10 \nURL. This is one of the calculations with which the database has been seeded, and you \nwill be able to see the query sent to the database in the logging messages produced by \nthe application.  \n...\nExecuting DbCommand [Parameters=[@__count_0='?' (DbType = Int32)], \n   CommandType='Text', CommandTimeout='30']\nSELECT TOP(1) [c].[Id], [c].[Count], [c].[Result]\n      FROM [Calculations] AS [c]\n      WHERE [c].[Count] = @__count_0\n...\nIf you request http://localhost:5000/sum/100, the database will be queried, but no \nresult will be found. The endpoint performs the calculation and stores the result in the \ndatabase before producing the result shown in figure 17.6. \nFigure 17.6    Performing a calculation  \n478 chapter  17 Working with data\nOnce a result has been stored in the database, subsequent requests for the same URL \nwill be satisfied using the stored data. You can see the SQL statement used to store the \ndata in the logging output produced by Entity Framework Core.\n...\nExecuting DbCommand [Parameters=[@p0='?' (DbType = Int32),  \n    @p1='?' (DbType = Int64)], \n        CommandType='Text', CommandTimeout='30']\nSET NOCOUNT ON;\nINSERT INTO [Calculations] ([Count], [Result])\nVALUES (@p0, @p1);\nSELECT [Id]\nFROM [Calculations]\nWHERE @@ROWCOUNT = 1 AND [Id] = scope_identity();\n...\nNOTE    Notice that the data retrieved from the database is not cached and that \neach request leads to a new SQL query. Depending on the frequency and com-\nplexity of the queries you require, you may want to cache data values or responses \nusing the techniques described earlier in the chapter.\nenabling  sensitive  data logging\nEntity Framework Core doesn’t include parameter values in the logging messages it \nproduces, which is why the logging output contains question marks, like this:  \n...\nExecuting DbCommand [Parameters=[ @__count_0='?'  (DbType = Int32)],  \n    CommandType='Text', CommandTimeout='30']\n...\nThe data is omitted as a precaution to prevent sensitive data from being stored in logs. \nIf you are having problems with queries and need to see the values sent to the database, \nthen you can use the EnableSensitiveDataLogging  method when configuring the \ndatabase context, as shown in listing 17.33.\nListing 17.33    Sensitive data logging in the Program.cs file in the Platform folder\n...\nbuilder.Services.AddDbContext<CalculationContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:CalcConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\n...\nRestart ASP.NET Core MVC and request the http://localhost:5000/sum/100 URL \nagain. When the request is handled, Entity Framework Core will include parameter \nvalues in the logging message it creates to show the SQL query, like this:\n...\nExecuted DbCommand (40ms) [Parameters=[ @__count_0='100' ],  \n    CommandType='Text', CommandTimeout='30']\nSELECT TOP(1) [c].[Id], [c].[Count], [c].[Result]",6285
213-Summary.pdf,213-Summary,"479 Summary\nFROM [Calculations] AS [c]\nWHERE [c].[Count] = @__count_0\n...\nThis is a feature that should be used with caution because logs are often accessible by \npeople who would not usually have access to the sensitive data that applications han-\ndle, such as credit card numbers and account details. \nSummary\n¡ ASP.NET Core provides support for caching individual data values, which can be \naccessed by endpoints.\n¡ Entire responses can be cached, which means that requests are serviced from the \ncache without using the endpoint. \n¡ ASP.NET Core provides two different middleware components for caching \nresponses. The response cache requires a header to be set and only uses cached \nresponses for some requests. The output cache is more complex, but more com-\nprehensive, and uses cached responses more widely.\n¡ Entity Framework Core provides access to relational data. Entity Framework \nCore is configured as a service and consumed by endpoints via dependency injec-\ntion. Entity Framework Core can be used to create a database from a set of model \nclasses and is queried using LINQ.",1109
214-Part 3.pdf,214-Part 3,Part 3\nXXXX,12
215-18.2 Adding a data model.pdf,215-18.2 Adding a data model,"48318Creating the  \nexample project\nThis chapter covers\n¡ Creating an ASP.NET Core project \n¡ Creating a simple data model\n¡ Adding Entity Framework Core to the ASP.NET  \n Core project\n¡ Creating and applying an Entity Framework  \n Core migration\n¡ Adding the Bootstrap CSS package to the   \n project\n¡ Defining a simple request pipeline   \n configuration \nIn this chapter, you will create the example project used throughout this part of the \nbook. The project contains a simple data model, a client-side package for format-\nting HTML content, and a simple request pipeline.\n484 chapter  18 Creating the example project \n18.1 Creating the project\nOpen a new PowerShell command prompt and run the commands shown in listing \n18.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 18.1    Creating the project\ndotnet new globaljson --sdk-version 7.0.100 --output WebApp\ndotnet new web --no-https --output WebApp --framework net7.0\ndotnet new sln -o WebApp\ndotnet sln WebApp add WebApp\nIf you are using Visual Studio, open the WebApp.sln  file in the WebApp folder. If you \nare using Visual Studio Code, open the WebApp  folder. Click the Yes button when \nprompted to add the assets required for building and debugging the project, as shown \nin figure 18.1. \nFigure 18.1    Adding project assets\nOpen the launchSettings.json  file in the WebApp/Properties  folder, change the \nHTTP port, and disable automatic browser launching, as shown in listing 18.2.\nListing 18.2    Setting the port in the launchSettings.json file in the Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""WebApp"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": false,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""",2246
216-18.2.1 Adding NuGet packages to the project.pdf,216-18.2.1 Adding NuGet packages to the project,,0
217-18.2.2 Creating the data model.pdf,217-18.2.2 Creating the data model,"485 Adding a data model\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\n18.2 Adding a data model\nA data model helps demonstrate the different ways that web applications can be built \nusing ASP.NET Core, showing how complex responses can be composed and how data \ncan be submitted by the user. In the sections that follow, I create a simple data model \nand use it to create the database schema that will be used to store the application’s \ndata.\n18.2.1  Adding NuGet packages to the project \nThe data model will use Entity Framework Core to store and query data in a SQL Server \nLocalDB database. To add the NuGet packages for Entity Framework Core, use a Pow-\nerShell command prompt to run the commands shown in listing 18.3 in the WebApp  \nproject folder.  \nListing 18.3    Adding packages to the project \ndotnet add package Microsoft.EntityFrameworkCore.Design --version 7.0.0 \ndotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 7.0.0\nIf you are using Visual Studio, you can add the packages by selecting Project > Manage \nNuGet Packages. Take care to choose the correct version of the packages to add to the \nproject.\nIf you have not followed the examples in earlier chapters, you will need to install the \nglobal tool package that is used to create and manage Entity Framework Core migra-\ntions. Run the commands shown in listing 18.4 to remove any existing version of the \npackage and install the version required for this book. (You can skip these commands if \nyou installed this version of the tools package in earlier chapters.)\nListing 18.4    Installing a global tool package \ndotnet tool uninstall --global dotnet-ef\ndotnet tool install --global dotnet-ef --version 7.0.0\n18.2.2  Creating the data model\nThe data model for this part of the book will consist of three related classes: Product , \nSupplier , and Category . Create a new folder named Models  and add to it a class file \nnamed Category.cs , with the contents shown in listing 18.5.  \n486 chapter  18 Creating the example project \nListing 18.5    The contents of the Category.cs file in the Models folder\nnamespace WebApp.Models {\n    public class Category {\n        public long CategoryId { get; set; }\n        public required string Name { get; set; }\n        public IEnumerable<Product>? Products { get; set; }\n    }\n}\nAdd a class called Supplier.cs  to the Models  folder and use it to define the class \nshown in listing 18.6.\nListing 18.6    The contents of the Supplier.cs file in the Models folder\nnamespace WebApp.Models {\n    public class Supplier {\n        public long SupplierId { get; set; }\n        public required string Name { get; set; }\n        public required string City { get; set; }\n        public IEnumerable<Product>? Products { get; set; }\n    }\n}\nNext, add a class named Product.cs  to the Models  folder and use it to define the class \nshown in listing 18.7.\nListing 18.7    The contents of the Product.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations.Schema;\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n        public required string Name { get; set; }\n        [Column(TypeName = ""decimal(8, 2)"")]\n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        public long SupplierId { get; set; }\n        public Supplier? Supplier { get; set; }\n    }\n}\nEach of the three data model classes defines a key property whose value will be allo-\ncated by the database when new objects are stored. There are also navigation proper-\nties that will be used to query for related data so that it will be possible, for example, to \nquery for all the products in a specific category.",3977
218-18.3 Adding the CSS framework.pdf,218-18.3 Adding the CSS framework,"487 Adding a data model\nThe Price  property has been decorated with the Column  attribute, which specifies \nthe precision of the values that will be stored in the database. There isn’t a one-to-one \nmapping between C# and SQL numeric types, and the Column  attribute tells Entity \nFramework Core which SQL type should be used in the database to store Price  values. \nIn this case, the decimal(8, 2)  type will allow a total of eight digits, including two fol-\nlowing the decimal point.  \nTo create the Entity Framework Core context class that will provide access to the \ndatabase, add a file called DataContext.cs  to the Models  folder and add the code \nshown in listing 18.8.  \nListing 18.8    The contents of the DataContext.cs file in the Models folder\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Models {\n    public class DataContext : DbContext {\n        public DataContext(DbContextOptions<DataContext> opts)\n            : base(opts) { }\n        public DbSet<Product> Products => Set<Product>();\n        public DbSet<Category> Categories => Set<Category>();\n        public DbSet<Supplier> Suppliers => Set<Supplier>();\n    }\n}\nThe context class defines properties that will be used to query the database for  \nProduct , Category , and Supplier  data. \n18.2.3  Preparing the seed data\nAdd a class called SeedData.cs  to the Models  folder and add the code shown in listing \n18.9 to define the seed data that will be used to populate the database.  \nListing 18.9    The contents of the SeedData.cs file in the Models folder \nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Models {\n    public static class SeedData {\n        public static void SeedDatabase(DataContext context) {\n            context.Database.Migrate();\n            if (context.Products.Count() == 0 \n                    && context.Suppliers.Count() == 0\n                    && context.Categories.Count() == 0) {\n                Supplier s1 = new Supplier \n                    { Name = ""Splash Dudes"", City = ""San Jose""};\n                Supplier s2 = new Supplier \n                    { Name = ""Soccer Town"", City = ""Chicago""};\n                Supplier s3 = new Supplier \n                    { Name = ""Chess Co"", City = ""New York""};\n488 chapter  18 Creating the example project \n                Category c1 = new Category { Name = ""Watersports"" };\n                Category c2 = new Category { Name = ""Soccer"" };\n                Category c3 = new Category { Name = ""Chess"" };\n                context.Products.AddRange(\n                    new Product {  Name = ""Kayak"", Price = 275, \n                        Category = c1, Supplier = s1},\n                    new Product {  Name = ""Lifejacket"", Price = 48.95m, \n                        Category = c1, Supplier = s1},\n                    new Product {  Name = ""Soccer Ball"", Price = 19.50m, \n                        Category = c2, Supplier = s2},\n                    new Product {  Name = ""Corner Flags"", Price = 34.95m, \n                        Category = c2, Supplier = s2},\n                    new Product {  Name = ""Stadium"", Price = 79500, \n                        Category = c2, Supplier = s2},\n                    new Product {  Name = ""Thinking Cap"", Price = 16, \n                        Category = c3, Supplier = s3},\n                    new Product {  Name = ""Unsteady Chair"", Price = 29.95m, \n                        Category = c3, Supplier = s3},\n                    new Product {  Name = ""Human Chess Board"", Price = 75, \n                        Category = c3, Supplier = s3},\n                    new Product {  Name = ""Bling-Bling King"", Price = 1200, \n                        Category = c3, Supplier = s3}\n                );\n                context.SaveChanges();\n            }\n        }\n    }\n}\nThe static SeedDatabase  method ensures that all pending migrations have been \napplied to the database. If the database is empty, it is seeded with categories, suppliers, \nand products. Entity Framework Core will take care of mapping the objects into the \ntables in the database, and the key properties will be assigned automatically when the \ndata is stored.\n18.2.4  Configuring EF Core services and middleware \nMake the changes to the Program.cs  file shown in listing 18.10, which configure \nEntity Framework Core and set up the DataContext  services that will be used through-\nout this part of the book to access the database.  \nListing 18.10    Services and middleware in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\n 489 Adding a data model\nvar app = builder.Build();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe DataContext  service is scoped, which means that I have to create a scope to get \nthe service required by the SeedDatabase  method.\nTo define the connection string that will be used for the application’s data, add the \nconfiguration settings shown in listing 18.11 in the appsettings.json  file. The con-\nnection string should be entered on a single line.  \nListing 18.11    A connection string in the appsettings.json file in the WebApp folder\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning"",\n      ""Microsoft.EntityFrameworkCore"": ""Information""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""ConnectionStrings"": {\n    ""ProductConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=Products; \n‰MultipleActiveResultSets=True""\n  }\n}\nIn addition to the connection string, listing 18.11 sets the logging detail for Entity \nFramework Core so that the SQL queries sent to the database are logged.\n18.2.5  Creating and applying the migration \nTo create the migration that will set up the database schema, use a PowerShell com-\nmand prompt to run the command shown in listing 18.12 in the WebApp  project folder.  \nListing 18.12    Creating an Entity Framework Core migration \ndotnet ef migrations add Initial\nOnce the migration has been created, apply it to the database using the command \nshown in listing 18.13.\nListing 18.13    Applying the migration to the database \ndotnet ef database update\nThe logging messages displayed by the application will show the SQL commands that \nare sent to the database.",6676
219-19.2 Understanding RESTful web services.pdf,219-19.2 Understanding RESTful web services,"490 chapter  18 Creating the example project \nNOTE    If you need to reset the database, then run the dotnet ef database \ndrop --force  command and then the command in listing 18.13.\n18.3 Adding the CSS framework \nLater chapters will demonstrate the different ways that HTML responses can be gener-\nated. Run the commands shown in listing 18.14 to remove any existing version of the \nLibMan package and install the version used in this book. (You can skip these com-\nmands if you installed this version of LibMan in earlier chapters.)\nListing 18.14    Installing the LibMan tool package \ndotnet tool uninstall --global Microsoft.Web.LibraryManager.Cli\ndotnet tool install --global Microsoft.Web.LibraryManager.Cli  \n    --version 2.1.175 \nTo add the Bootstrap CSS framework so that the HTML responses can be styled, run \nthe commands shown in listing 18.15 in the WebApp  project folder. \nListing 18.15    Installing the Bootstrap CSS framework \nlibman init -p cdnjs\nlibman install bootstrap@5.2.3 -d wwwroot/lib/bootstrap\n18.4 Configuring the request pipeline\nTo define a simple middleware component that will be used to make sure the example \nproject has been set up correctly, add a class file called TestMiddleware.cs  to the \nWebApp  folder and add the code shown in listing 18.16.\nListing 18.16    The contents of the TestMiddleware.cs file in the WebApp folder\nusing WebApp.Models;\nnamespace WebApp {\n    public class TestMiddleware {\n        private RequestDelegate nextDelegate;\n        public TestMiddleware(RequestDelegate next) {\n            nextDelegate = next;\n        }\n        public async Task Invoke(HttpContext context, \n                DataContext dataContext) {\n            if (context.Request.Path == ""/test"") {\n                await context.Response.WriteAsync($""There are ""\n                    + dataContext.Products.Count() + "" products\n"");\n                await context.Response.WriteAsync(""There are ""  \n                    + dataContext.Categories.Count() + "" categories\n"");\n                await context.Response.WriteAsync($""There are "" \n                    + dataContext.Suppliers.Count() + "" suppliers\n"");\n            } else {\n 491 Running the example application \n                await nextDelegate(context);\n            }\n        }\n    }\n}\nAdd the middleware component to the request pipeline, as shown in listing 18.17.\nListing 18.17    A middleware component in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nvar app = builder.Build();\napp.UseMiddleware<WebApp.TestMiddleware>();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\n18.5 Running the example application \nStart the application by running the command shown in listing 18.18 in the WebApp  \nproject folder.\nListing 18.18    Running the example application \ndotnet run\nUse a new browser tab and request http://localhost:5000/test, and you will see the \nresponse shown in figure 18.2.\nFigure 18.2    \nRunning the \nexample \napplication\n49219Creating RESTful  \nweb services\nThis chapter covers \n¡ Using ASP.NET Core to create RESTful web   \n services\n¡ Creating web services with the minimal API\n¡ Creating web services with controllers\n¡ Using model binding data from web service  \n requests\n¡ Managing the content produced by web   \n services\nWeb services accept HTTP requests and generate responses that contain data. In \nthis chapter, I explain how the features provided by the MVC Framework, which is \nan integral part of ASP.NET Core, can be used to build on the capabilities described \nin part 2 to create web services. \nThe nature of web services means that some of the examples in this chapter are \ntested using command-line tools provided by PowerShell, and it is important to enter \nthe commands exactly as shown. Chapter 20 introduces more sophisticated tools for \nworking with web services, but the command-line approach is better suited to follow-\ning examples in a book chapter, even if they can feel a little awkward as you type them \nin. Table 19.1 puts RESTful web services in context.\n 493 Preparing for this chapter\nTable 19.1    Putting RESTful web services in context\nQuestion Answer\nWhat are they? Web services provide access to an application’s data, typically \nexpressed in the JSON format.\nWhy are they useful? Web services are most often used to provide rich client-side appli -\ncations with data. \nHow are they used? The combination of the URL and an HTTP method describes an \noperation that is handled by an endpoint, or an action method \ndefined by a controller.\nAre there any pitfalls or limitations? There is no widespread agreement about how web services \nshould be implemented, and care must be taken to produce just \nthe data the client expects.\nAre there any alternatives? There are several different approaches to providing clients with \ndata, although RESTful web services are the most common.\nTable 19.2 provides a guide to the chapter. \nTable 19.2    Chapter guide\nProblem Solution Listing\nDefining a web service Define endpoints in the Program.cs  file or create a \ncontroller with action methods that correspond to the \noperations that you require.3–13\nGenerating data sequences over time Use the IAsyncEnumerable<T>  response, which \nwill prevent the request thread from blocking while \nresults are generated.14\nPreventing request values from being \nused for sensitive data propertiesUse a binding target to restrict the model binding \nprocess to only safe properties.15–17\nExpressing nondata outcomes Use action results to describe the response that ASP.\nNET Core should send.18–23\nValidating data Use the ASP.NET Core model binding and model vali-\ndation features.24–26\nAutomatically validating requests Use the ApiController  attribute. 27\nOmitting null values from data \nresponses Map the data objects to filter out properties or config -\nure the JSON serializer to ignore null  properties.28–32\nApply a rate limit Use the EnableRateLimiting  and \nDisableRateLimiting .33, 34\n19.1 Preparing for this chapter\nIn this chapter, I continue to use the WebApp project created in chapter 18. To prepare \nfor this chapter, drop the database by opening a new PowerShell command prompt, \nnavigating to the folder that contains the WebApp.csproj  file, and running the com-\nmand shown in listing 19.1.",6793
220-19.3 Creating a web service using the minimal API.pdf,220-19.3 Creating a web service using the minimal API,"494 chapter  19 Creating RESTful web services \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 19.1    Dropping the database \ndotnet ef database drop --force\nStart the application by running the command shown in listing 19.2 in the project \nfolder.\nListing 19.2    Starting the example application \ndotnet run\nRequest the URL http://localhost:5000/test once ASP.NET Core has started, and you \nwill see the response shown in figure 19.1.\nFigure 19.1     Running the \nexample \napplication\n19.2 Understanding RESTful web services\nWeb services respond to HTTP requests with data that can be consumed by clients, \nsuch as JavaScript applications. There are no hard-and-fast rules for how web services \nshould work, but the most common approach is to adopt the Representational State \nTransfer (REST) pattern. There is no authoritative specification for REST, and there is \nno consensus about what constitutes a RESTful web service, but there are some com-\nmon themes that are widely used for web services.  The lack of a detailed specification \nleads to endless disagreement about what REST means and how RESTful web services \nshould be created, all of which can be safely ignored if the web services you create work \nfor your projects.  \n19.2.1  Understanding request URLs and methods\nThe core premise of REST—and the only aspect for which there is broad agreement—\nis that a web service defines an API through a combination of URLs and HTTP meth-\nods such as GET and POST, which are also known as the HTTP verbs. The method \nspecifies the type of operation, while the URL specifies the data object or objects that \nthe operation applies to.\n 495 Understanding RESTful web services\nAs an example, here is a URL that might identify a Product  object in the example \napplication:  \n/api/products/1\nThis URL may identify the Product  object that has a value of 1 for its ProductId  prop-\nerty. The URL identifies the Product , but it is the HTTP method that specifies what \nshould be done with it. Table 19.3 lists the HTTP methods that are commonly used in \nweb services and the operations they conventionally represent.\nTable 19.3.    HTTP methods and operations \nHTTP Method Description\nGET This method is used to retrieve one or more data \nobjects.\nPOST This method is used to create a new object.\nPUT This method is used to update an existing object.\nPATCH This method is used to update part of an existing object.\nDELETE This method is used to delete an object.\n19.2.2  Understanding JSON \nMost RESTful web services format the response data using the JavaScript Object Nota-\ntion (JSON) format. JSON has become popular because it is simple and easily con-\nsumed by JavaScript clients. JSON is described in detail at www.json.org , but you don’t \nneed to understand every aspect of JSON to create web services because ASP.NET Core \nprovides all the features required to create JSON responses. \nUnderstanding the alternatives to RESTful web services\nREST isn’t the only way to design web services, and there are some popular alternatives. \nGraphQL  is most closely associated with the React JavaScript framework, but it can be \nused more widely. Unlike REST web services, which provide specific queries through indi -\nvidual combinations of a URL and an HTTP method, GraphQL provides access to all an \napplication’s data and lets clients query for just the data they require in the format they \nrequire. GraphQL can be complex to set up—and can require more sophisticated clients—\nbut the result is a more flexible web service that puts the developers of the client in con -\ntrol of the data they consume. GraphQL isn’t supported directly by ASP.NET Core, but \nthere are .NET implementations available. See https://graphql.org  for more detail.  \nA new alternative is gRPC, a full remote procedure call framework that focuses on speed \nand efficiency. At the time of writing, gRPC cannot be used in web browsers, such as by \nthe Angular or React framework, because browsers don’t provide the fine-grained access \nthat gRPC requires to formulate its HTTP requests.  \n496 chapter  19 Creating RESTful web services \n19.3 Creating a web service using the minimal API\nAs you learn about the facilities that ASP.NET Core provides for web services, it can be \neasy to forget they are built on the features described in part 2. To create a simple web \nservice, add the statements shown in listing 19.3 to the Program.cs  file.\nListing 19.3    Creating a web service in the Program.cs file in the Platform folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing System.Text.Json;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nvar app = builder.Build();\nconst string BASEURL = ""api/products"";\napp.MapGet($""{BASEURL}/{{id}}"", async (HttpContext context,  \n        DataContext data) => {\n    string? id = context.Request.RouteValues[""id""] as string;\n    if (id != null) {\n        Product? p = data.Products.Find(long.Parse(id));\n        if (p == null) {\n            context.Response.StatusCode = StatusCodes.Status404NotFound;\n        } else {\n            context.Response.ContentType = ""application/json"";\n            await context.Response\n                .WriteAsync(JsonSerializer.Serialize<Product>(p));\n        }\n    }\n});\napp.MapGet(BASEURL, async (HttpContext context, DataContext data) => {\n    context.Response.ContentType = ""application/json"";\n    await context.Response.WriteAsync(JsonSerializer\n        .Serialize<IEnumerable<Product>>(data.Products));\n});\napp.MapPost(BASEURL, async (HttpContext context, DataContext data) => {\n    Product? p = await\n        JsonSerializer.DeserializeAsync<Product>(context.Request.Body);\n    if (p != null) { \n        await data.AddAsync(p);\n       await data.SaveChangesAsync();\n        context.Response.StatusCode = StatusCodes.Status200OK;\n    }\n});\n 497 Creating a web service using the minimal API\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe same API that I used to register endpoints in earlier chapters can be used to create \na web service, using only features that you have seen before. The MapGet  and MapPost  \nmethods are used to create three routes, all of which match URLs that start with /api , \nwhich is the conventional prefix for web services. \nThe endpoint for the first route receives a value from a segment variable that is used \nto locate a single Product  object in the database. The endpoint for the second route \nretrieves all the Product  objects in the database. The third endpoint handles POST \nrequests and reads the request body to get a JSON representation of a new object to add \nto the database.\nThere are better ASP.NET Core features for creating web services, which you will see \nshortly, but the code in listing 19.3 shows how the HTTP method and the URL can be \ncombined to describe an operation, which is the key concept in creating web services.\nTo test the web service, restart ASP.NET Core and request http://localhost:5000/\napi/products/1. The request will be matched by the first route defined in listing 19.3 \nand will produce the response shown on the left of figure 19.2. Next, request http://\nlocalhost:5000/api/products, which will be matched by the second route and produce \nthe response shown on the right of figure 19.2.  \nNOTE     The responses shown in the figure contain null  values for the Supplier  \nand Category  properties because the LINQ queries do not include related data. \nSee chapter 20 for details.\nFigure 19.2     Web service response  \nTesting the third route requires a different approach because it isn’t possible to send \nHTTP POST requests using the browser. Open a new PowerShell command prompt \nand run the command shown in listing 19.4. It is important to enter the command",8379
221-19.4.2 Creating a controller.pdf,221-19.4.2 Creating a controller,"498 chapter  19 Creating RESTful web services \nexactly as shown because the Invoke-RestMethod  command is fussy about the syntax \nof its arguments.  \nTIP    You may receive an error when you use the Invoke-RestMethod  or \nInvoke-WebRequest  command to test the examples in this chapter if you have \nnot performed the initial setup for Microsoft Edge. The problem can be fixed by \nrunning the browser and selecting the initial configurations you require. \nListing 19.4    Sending a POST request \nInvoke-RestMethod http://localhost:5000/api/products -Method POST -Body   \n‰(@{ Name=""Swimming Goggles""; Price=12.75; CategoryId=1; SupplierId=1} | \n‰ ConvertTo-Json) -ContentType ""application/json""\nThe command sends an HTTP POST command that is matched by the third route \ndefined in listing 19.3. The body of the request is a JSON-formatted object that is \nparsed to create a Product , which is then stored in the database. The JSON object \nincluded in the request contains values for the Name , Price , CategoryId , and  \nSupplierId  properties. The unique key for the object, which is associated with the \nProductId  property, is assigned by the database when the object is stored. Use the \nbrowser to request the http://localhost:5000/api/products URL again, and you will \nsee that the JSON response contains the new object, as shown in figure 19.3.\nFigure 19.3     Storing new data using the web service\n19.4 Creating a web service using a controller \nThe drawback of using individual endpoints to create a web service is that each end-\npoint has to duplicate a similar set of steps to produce a response: get the Entity Frame-\nwork Core service so that it can query the database, set the Content-Type  header \nfor the response, serialize the objects into JSON, and so on. As a result, web services \ncreated with endpoints are difficult to understand and awkward to maintain, and the  \nProgram.cs  file quickly becomes unwieldy.\nA more elegant and robust approach is to use a controller , which allows a web service \nto be defined in a single class. Controllers are part of the MVC Framework, which builds \non the ASP.NET Core platform and takes care of handling data in the same way that \nendpoints take care of processing URLs. \n 499 Creating a web service using a controller \nThe rise and fall of the MVC pattern in ASP .NET Core\nThe MVC Framework is an implementation of the Model-View-Controller pattern, which \ndescribes one way to structure an application. The examples in this chapter use two of \nthe three pillars of the pattern: a data model (the M in MVC) and controllers (the C in \nMVC). chapter 21 provides the missing piece and explains how views can be used to cre-\nate HTML responses using Razor.  \nThe MVC pattern was an important step in the evolution of ASP.NET and allowed the \nplatform to break away from the Web Forms model that predated it. Web Forms applica -\ntions were easy to start but quickly became difficult to manage and hid details of HTTP \nrequests and responses from the developer. By contrast, the adherence to the MVC \npattern provided a strong and scalable structure for applications written with the MVC \nFramework and hid nothing from the developer. The MVC Framework revitalized ASP.NET \nand provided the foundation for what became ASP.NET Core, which dropped support for \nWeb Forms and focused solely on using the MVC pattern.\nAs ASP.NET Core evolved, other styles of web application have been embraced, and the \nMVC Framework is only one of the ways that applications can be created. That doesn’t \nundermine the utility of the MVC pattern, but it doesn’t have the central role that it used \nto in ASP.NET Core development, and the features that used to be unique to the MVC \nFramework can now be accessed through other approaches, such as Razor Pages and \nBlazor.\nA consequence of this evolution is that understanding the MVC pattern is no longer a pre -\nrequisite for effective ASP.NET Core development. If you are interested in understanding \nthe MVC pattern, then https://en.wikipedia.org/wiki/Model–view–controller  is a good \nplace to start. But for this book, understanding how the features provided by the MVC \nFramework build on the ASP.NET Core platform is all the context that is required.\n19.4.1  Enabling the MVC Framework \nThe first step to creating a web service using a controller is to configure the MVC \nframework, which requires a service and an endpoint, as shown in listing 19.5. This \nlisting also removes the endpoints defined in the previous section.  \nListing 19.5    Enabling the MVC Framework in the Program.cs File in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers();\nvar app = builder.Build();\n500 chapter  19 Creating RESTful web services \napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe AddControllers  method defines the services that are required by the MVC \nframework, and the MapControllers  method defines routes that will allow controllers \nto handle requests. You will see other methods used to configure the MVC framework \nused in later chapters, which provide access to different features, but the methods used \nin listing 19.5 are the ones that configure the MVC framework for web services.\n19.4.2  Creating a controller \nControllers  are classes whose methods, known as actions , can process HTTP requests. \nControllers are discovered automatically when the application is started. The basic dis-\ncovery process is simple: any public class whose name ends with Controller  is a con-\ntroller, and any public  method a controller defines is an action. To demonstrate how \nsimple a controller can be, create the WebApp/Controllers  folder and add to it a file \nnamed ProductsController.cs  with the code shown in listing 19.6.  \nTIP    Controllers are conventionally defined in the Controllers  folder, but they \ncan be defined anywhere in the project and will still be discovered. \nListing 19.6    The contents of the ProductsController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        [HttpGet]\n        public IEnumerable<Product> GetProducts() {\n            return new Product[] {\n                new Product() { Name = ""Product #1"" },\n                new Product() { Name = ""Product #2"" },\n            };\n        }\n        [HttpGet(""{id}"")]\n        public Product GetProduct() {\n            return new Product() {\n                ProductId = 1, Name = ""Test Product""\n            };\n        }\n    }\n}\n 501 Creating a web service using a controller \nThe ProductsController  class meets the criteria that the MVC framework looks \nfor in a controller. It defines public methods named GetProducts  and GetProduct , \nwhich will be treated as actions. \nunderstanding  the base class\nControllers are derived from the ControllerBase  class, which provides access to fea-\ntures provided by the MVC Framework and the underlying ASP.NET Core platform. \nTable 19.4 describes the most useful properties provided by the ControllerBase  class.  \nNOTE    Although controllers are typically derived from the ControllerBase  \nor Controller  classes (described in chapter 21), this is just convention, and \nthe MVC Framework will accept any class whose name ends with Controller , \nthat is derived from a class whose name ends with Controller , or that has been \ndecorated with the Controller  attribute. Apply the NonController  attribute to \nclasses that meet these criteria but that should not receive HTTP requests. \nTable 19.4     Useful ControllerBase properties\nName Description\nHttpContext This property returns the HttpContext  object for the \ncurrent request.\nModelState This property returns details of the data validation pro-\ncess, as demonstrated in the “Validating Data” section \nlater in the chapter and described in detail in chapter 29.\nRequest This property returns the HttpRequest  object for the \ncurrent request.\nResponse This property returns the HttpResponse  object for the \ncurrent response.\nRouteData This property returns the data extracted from the request \nURL by the routing middleware, as described in chapter \n13.\nUser This property returns an object that describes the user \nassociated with the current request, as described in \nchapter 38.\nA new instance of the controller class is created each time one of its actions is used to \nhandle a request, which means the properties in table 19.4 describe only the current \nrequest. \nunderstanding  the controller  attributes  \nThe HTTP methods and URLs supported by the action methods are determined by \nthe combination of attributes that are applied to the controller. The URL for the con-\ntroller is specified by the Route  attribute, which is applied to the class, like this: \n...\n[Route("" api/[controller] "")]\npublic class ProductsController: ControllerBase {\n...\n502 chapter  19 Creating RESTful web services \nThe [controller]  part of the attribute argument is used to derive the URL from \nthe name of the controller class. The Controller  part of the class name is dropped, \nwhich means that the attribute in listing 19.6 sets the URL for the controller to /api/\nproducts . \nEach action is decorated with an attribute that specifies the HTTP method that it \nsupports, like this:\n...\n[HttpGet]\npublic Product[] GetProducts() {\n...\nThe name given to action methods doesn’t matter in controllers used for web services. \nThere are other uses for controllers, described in chapter 21, where the name does \nmatter, but for web services, it is the HTTP method attributes and the route patterns \nthat are important.\n The HttpGet  attribute tells the MVC framework that the GetProducts  action \nmethod will handle HTTP GET requests. Table 19.5 describes the full set of attributes \nthat can be applied to actions to specify HTTP methods.  \nTable 19.5    The HTTP method attributes\nName Description\nHttpGet This attribute specifies that the action can be invoked \nonly by HTTP requests that use the GET verb.\nHttpPost This attribute specifies that the action can be invoked \nonly by HTTP requests that use the POST verb.\nHttpDelete This attribute specifies that the action can be invoked \nonly by HTTP requests that use the DELETE verb.\nHttpPut This attribute specifies that the action can be invoked \nonly by HTTP requests that use the PUT verb.\nHttpPatch This attribute specifies that the action can be invoked \nonly by HTTP requests that use the PATCH verb.\nHttpHead This attribute specifies that the action can be invoked \nonly by HTTP requests that use the HEAD verb.\nAcceptVerbs This attribute is used to specify multiple HTTP verbs.\nThe attributes applied to actions to specify HTTP methods can also be used to build on \nthe controller’s base URL.\n...\n[HttpGet (""{id}"") ]\npublic Product GetProduct() {\n...\nThis attribute tells the MVC framework that the GetProduct  action method handles \nGET requests for the URL pattern api/products/{id} . During the discovery process, \nthe attributes applied to the controller are used to build the set of URL patterns that \nthe controller can handle, summarized in table 19.6.\n 503 Creating a web service using a controller \nTIP    When writing a controller, it is important to ensure that each combination \nof the HTTP method and URL pattern that the controller supports is mapped \nto only one action method. An exception will be thrown when a request can be \nhandled by multiple actions because the MVC Framework is unable to decide \nwhich to use.\nTable 19.6    The URL patterns \nHTTP Method URL Pattern Action Method Name\nGET api/products GetProducts\nGET api/products/{id} GetProduct\nYou can see how the combination of attributes is equivalent to the MapGet  methods I \nused for the same URL patterns when I used endpoints to create a web service earlier \nin the chapter.\nGET and POST: Pick the right one\nThe rule of thumb is that GET requests should be used for all read-only information \nretrieval, while POST requests should be used for any operation that changes the appli -\ncation state. In standards-compliance terms, GET requests are for safe interactions \n(having no side effects besides information retrieval), and POST requests are for unsafe  \ninteractions (making a decision or changing something). These conventions are set by \nthe World Wide Web Consortium (W3C), at https://www.rfc-editor.org/rfc/rfc9110.html .\nGET requests are addressable : all the information is contained in the URL, so it’s possible \nto bookmark and link to these addresses. Do not use GET requests for operations that \nchange state. Many web developers learned this the hard way in 2005 when Google Web \nAccelerator was released to the public. This application prefetched all the content linked \nfrom each page, which is legal within the HTTP because GET requests should be safe. \nUnfortunately, many web developers had ignored the HTTP conventions and placed sim-\nple links to “delete item” or “add to shopping cart” in their applications. Chaos ensued. \nunderstanding  action  method  results\nOne of the main benefits provided by controllers is that the MVC Framework takes \ncare of setting the response headers and serializing the data objects that are sent to the \nclient. You can see this in the results defined by the action methods, like this:  \n...\n[HttpGet(""{id}"")]\npublic Product GetProduct() {\n...\nWhen I used an endpoint, I had to work directly with the JSON serializer to create a \nstring that can be written to the response and set the Content-Type  header to tell the \nclient that the response contained JSON data. The action method returns a Product  \nobject, which is processed automatically. \n504 chapter  19 Creating RESTful web services \nTo see how the results from the action methods are handled, restart ASP.NET Core \nand request http://localhost:5000/api/products, which will produce the response \nshown on the left of figure 19.4, which is produced by the GetProducts  action method. \nNext, request http://localhost:5000/api/products/1, which will be handled by the \nGetProduct  method and produce the result shown on the right side of figure 19.4.\nFigure 19.4    Using a controller \nusing dependency  injection  in controllers  \nA new instance of the controller class is created each time one of its actions is used \nto handle a request. The application’s services are used to resolve any dependencies \nthe controller declares through its constructor and any dependencies that the action \nmethod defines. This allows services that are required by all actions to be handled \nthrough the constructor while still allowing individual actions to declare their own \ndependencies, as shown in listing 19.7.  \nListing 19.7    Using services in the ProductsController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IEnumerable<Product> GetProducts() {\n            return context.Products;\n        }\n        [HttpGet(""{id}"")]\n        public Product? GetProduct([FromServices]\n                ILogger<ProductsController> logger) {\n            logger.LogInformation(""GetProduct Action Invoked"");\n            return context.Products\n                .OrderBy(p => p.ProductId).FirstOrDefault();\n        }\n    }\n}\n 505 Creating a web service using a controller \nThe constructor declares a dependency on the DataContext  service, which provides \naccess to the application’s data. The services are resolved using the request scope, \nwhich means that a controller can request all services, without needing to understand \ntheir lifecycle. \nThe Entity Framework Core context service lifecycle\nA new Entity Framework Core context object is created for each controller. Some devel-\nopers will try to reuse context objects as a perceived performance improvement, but this \ncauses problems because data from one query can affect subsequent queries. Behind \nthe scenes, Entity Framework Core efficiently manages the connections to the database, \nand you should not try to store or reuse context objects outside of the controller for which \nthey are created.\nThe GetProducts  action method uses the DataContext  to request all the Product  \nobjects in the database. The GetProduct  method also uses the DataContext  service, \nbut it declares a dependency on ILogger<T> , which is the logging service described in \nchapter 15. Dependencies that are declared by action methods must be decorated with \nthe FromServices  attribute, like this:  \n...\npublic Product GetProduct( [FromServices]   \n    ILogger<ProductsController> logger)\n...\nBy default, the MVC Framework attempts to find values for action method parameters \nfrom the request URL, and the FromServices  attribute overrides this behavior. The \nFromServices  attribute can often be omitted, and ASP.NET Core will try to resolve \nparameters using dependency injection, but this doesn’t work for all parameter types, \nand I prefer to use the attribute to clearly denote that the value for the parameter will \nbe provided by dependency injection.\nTo see the use of the services in the controller, restart ASP.NET Core and request \nhttp://localhost:5000/api/products/1, which will produce the response shown in fig-\nure 19.5. You will also see the following logging message in the application’s output:\n...\ninfo: WebApp.Controllers.ProductsController[0]\n      GetProduct Action Invoked\n... \nFigure 19.5    Using services \nin a controller\n \n506 chapter  19 Creating RESTful web services \nCAUTION     One consequence of the controller lifecycle is that you can’t rely on \nside effects caused by methods being called in a specific sequence. So, for exam-\nple, I can’t assign the ILogger<T>  object received by the GetProduct  method \nin listing 19.7 to a property that can be read by the GetProducts  action in later \nrequests. Each controller object is used to handle one request, and only one \naction method will be invoked by the MVC Framework for each object.\nusing model  binding  to access  route  data \nIn the previous section, I noted that the MVC Framework uses the request URL to find \nvalues for action method parameters, a process known as model binding . Model binding \nis described in detail in chapter 28, but listing 19.8 shows a simple example.  \nListing 19.8    Model binding in the ProductsController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IEnumerable<Product> GetProducts() {\n            return context.Products;\n        }\n        [HttpGet(""{id}"")]\n        public Product? GetProduct(long id,\n                [FromServices] ILogger<ProductsController> logger) {\n            logger.LogDebug(""GetProduct Action Invoked"");\n            return context.Products.Find(id);\n        }\n    }\n}\nThe listing adds a long  parameter named id to the GetProduct  method. When the \naction method is invoked, the MVC Framework injects the value with the same name \nfrom the routing data, automatically converting it to a long  value, which is used by the \naction to query the database using the LINQ Find  method. The result is that the action \nmethod responds to the URL, which you can see by restarting ASP.NET Core and \nrequesting http://localhost:5000/api/products/5, which will produce the response \nshown in figure 19.6. \n 507 Creating a web service using a controller \nFigure 19.6    Using model \nbinding in an \naction\nmodel binding  from the reQuest body\nThe model binding feature can also be used on the data in the request body, which \nallows clients to send data that is easily received by an action method. Listing 19.9 adds \na new action method that responds to POST requests and allows clients to provide a \nJSON representation of the Product  object in the request body.  \nListing 19.9    Adding an action in the ProductsController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IEnumerable<Product> GetProducts() {\n            return context.Products;\n        }\n        [HttpGet(""{id}"")]\n        public Product? GetProduct(long id,\n                [FromServices] ILogger<ProductsController> logger) {\n            logger.LogDebug(""GetProduct Action Invoked"");\n            return context.Products.Find(id);\n        }\n        [HttpPost]\n        public void SaveProduct([FromBody] Product product) {\n            context.Products.Add(product);\n            context.SaveChanges();\n        }\n    }\n}\nThe new action relies on two attributes. The HttpPost  attribute is applied to the action \nmethod and tells the MVC Framework that the action can process POST requests. The \nFromBody  attribute is applied to the action’s parameter, and it specifies that the value \n508 chapter  19 Creating RESTful web services \nfor this parameter should be obtained by parsing the request body. When the action \nmethod is invoked, the MVC Framework will create a new Product  object and popu-\nlate its properties with the values in the request body. The model binding process can \nbe complex and is usually combined with data validation, as described in chapter 29, \nbut for a simple demonstration, restart ASP.NET Core, open a new PowerShell com-\nmand prompt, and run the command shown in listing 19.10.\nListing 19.10    Sending a POST request to the example application \nInvoke-RestMethod http://localhost:5000/api/products -Method POST -Body  (@ \n‰{ Name=""Soccer Boots""; Price=89.99; CategoryId=2; SupplierId=2} |  \n‰ ConvertTo-Json) -ContentType ""application/json""\nOnce the command has executed, use a web browser to request http://localhost:5000/\napi/products, and you will see the new object that has been stored in the database, as \nshown in figure 19.7.\nFigure 19.7    Storing new \ndata using a \ncontroller\nadding  additional  actions  \nNow that the basic features are in place, I can add actions that allow clients to replace \nand delete Product  objects using the HTTP PUT and DELETE methods, as shown in \nlisting 19.11.\nListing 19.11    Adding actions in the ProductsController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n 509 Creating a web service using a controller \n        [HttpGet]\n        public IEnumerable<Product> GetProducts() {\n            return context.Products;\n        }\n        [HttpGet(""{id}"")]\n        public Product? GetProduct(long id,\n                [FromServices] ILogger<ProductsController> logger) {\n            logger.LogDebug(""GetProduct Action Invoked"");\n            return context.Products.Find(id);\n        }\n        [HttpPost]\n        public void SaveProduct([FromBody] Product product) {\n            context.Products.Add(product);\n            context.SaveChanges();\n        }\n        [HttpPut]\n        public void UpdateProduct([FromBody] Product product) {\n            context.Products.Update(product);\n            context.SaveChanges();\n        }\n        [HttpDelete(""{id}"")]\n        public void DeleteProduct(long id) {\n            context.Products.Remove(new Product() { \n                ProductId = id, Name = string.Empty\n            });\n            context.SaveChanges();\n        }\n    }\n}\nThe UpdateProduct  action is similar to the SaveProduct  action and uses model bind-\ning to receive a Product  object from the request body. The DeleteProduct  action \nreceives a primary key value from the URL and uses it to create a Product  that has a \nvalue for the ProductId  property, which is required because Entity Framework Core \nworks only with objects, but web service clients typically expect to be able to delete \nobjects using just a key value. (The empty string is assigned to the Name  property, to \nwhich the required  keyword has been applied and without which a Product  object \ncannot be created. Entity Framework Core ignores the empty string when identifying \nthe data to delete).\nRestart ASP.NET Core and then use a different PowerShell command prompt to run \nthe command shown in listing 19.12, which tests the UpdateProduct  action.\nListing 19.12    Updating an object \nInvoke-RestMethod http://localhost:5000/api/products -Method PUT -Body  (@{  \nProductId=1; Name=""Green Kayak""; Price=275; CategoryId=1; SupplierId=1} | \nConvertTo-Json) -ContentType ""application/json""\nThe command sends an HTTP PUT request whose body contains a replacement \nobject. The action method receives the object through the model binding feature",26256
222-19.5.2 Preventing over-binding.pdf,222-19.5.2 Preventing over-binding,"510 chapter  19 Creating RESTful web services \nand updates the database. Next, run the command shown in listing 19.13 to test the \nDeleteProduct  action.\nListing 19.13    Deleting an object \nInvoke-RestMethod http://localhost:5000/api/products/2 -Method DELETE\nThis command sends an HTTP DELETE request, which will delete the object whose \nProductId  property is 2. To see the effect of the changes, use the browser to request \nhttp://localhost:5000/api/products, which will send a GET request that is handled by \nthe GetProducts  action and produce the response shown in figure 19.8.\nFigure 19.8    Updating \nand deleting \nobjects\n19.5 Improving the web service \nThe controller in listing 19.11 re-creates the functionality provided by the separate \nendpoints, but there are still improvements that can be made, as described in the fol-\nlowing sections.\nSupporting cross-origin requests \nIf you are supporting third-party JavaScript clients, you may need to enable support for \ncross-origin requests (CORS). Browsers protect users by only allowing JavaScript code to \nmake HTTP requests within the same origin, which means to URLs that have the same \nscheme, host, and port as the URL used to load the JavaScript code. CORS loosens \nthis restriction by performing an initial HTTP request to check that the server will allow \nrequests originating from a specific URL, helping prevent malicious code using your ser -\nvice without the user’s consent. \nASP.NET Core provides a built-in service that handles CORS, which is enabled by adding \nthe following statement to the Program.cs  file:\n...\nbuilder.Services.AddCors();\n...\nThe options pattern is used to configure CORS with the CorsOptions  class defined in \nthe Microsoft.AspNetCore.Cors.Infrastructure  namespace. See https://\ndocs.microsoft.com/en-gb/aspnet/core/security/cors  for details.\n 511 Improving the web service \n19.5.1  Using asynchronous actions\nThe ASP.NET Core platform processes each request by assigning a thread from a pool. \nThe number of requests that can be processed concurrently is limited to the size of the \npool, and a thread can’t be used to process any other request while it is waiting for an \naction to produce a result.\nActions that depend on external resources can cause a request thread to wait for an \nextended period. A database server, for example, may have its own concurrency lim-\nits and may queue up queries until they can be executed. The ASP.NET Core request \nthread is unavailable to process any other requests until the database produces a result \nfor the action, which then produces a response that can be sent to the HTTP client.\nThis problem can be addressed by defining asynchronous actions, which allow ASP.\nNET Core threads to process other requests when they would otherwise be blocked, \nincreasing the number of HTTP requests that the application can process simultane-\nously. Listing 19.14 revises the controller to use asynchronous actions.  \nNOTE    Asynchronous actions don’t produce responses any quicker, and the ben-\nefit is only to increase the number of requests that can be processed concurrently.\nListing 19.14    Async actions in the ProductsController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IAsyncEnumerable<Product> GetProducts() {\n            return context.Products.AsAsyncEnumerable();\n        }\n        [HttpGet(""{id}"")]\n        public async Task<Product?> GetProduct(long id) {\n            return await context.Products.FindAsync(id);\n        }\n        [HttpPost]\n        public async Task SaveProduct([FromBody] Product product) {\n            await context.Products.AddAsync(product);\n            await context.SaveChangesAsync();\n        }\n        [HttpPut]\n        public async Task UpdateProduct([FromBody] Product product) {\n512 chapter  19 Creating RESTful web services \n            context.Update(product);\n            await context.SaveChangesAsync();\n        }\n        [HttpDelete(""{id}"")]\n        public async Task DeleteProduct(long id) {\n            context.Products.Remove(new Product() { \n                ProductId = id, Name = string.Empty\n            });\n            await context.SaveChangesAsync();\n        }\n    }\n}\nEntity Framework Core provides asynchronous versions of some methods, such as \nFind Async , AddAsync , and SaveChangesAsync , and I have used these with the await  \nkeyword. Not all operations can be performed asynchronously, which is why the \nUpdate  and Remove  methods are unchanged within the UpdateProduct  and Delete-\nProduct  actions.\nFor some operations—including LINQ queries to the database—the IAsync-\nEnumerable<T>  interface can be used, which denotes a sequence of objects that should \nbe enumerated asynchronously and prevents the ASP.NET Core request thread from \nwaiting for each object to be produced by the database, as explained in chapter 5.\nThere is no change to the responses produced by the controller, but the threads that \nASP.NET Core assigns to process each request are not necessarily blocked by the action \nmethods.\n19.5.2  Preventing over-binding\nSome of the action methods use the model binding feature to get data from the request \nbody so that it can be used to perform database operations. There is a problem with \nthe SaveProduct  action, which can be seen by using a PowerShell prompt to run the \ncommand shown in listing 19.15. \nListing 19.15    Saving a product \nInvoke-RestMethod http://localhost:5000/api/products -Method POST -Body  (@ \n‰{ ProductId=100; Name=""Swim Buoy""; Price=19.99; CategoryId=1;  \n‰SupplierId=1} | ConvertTo-Json) -ContentType ""application/json""\nThis command fails with an error. Unlike the command that was used to test the POST \nmethod, this command includes a value for the ProductId  property. When Entity \nFramework Core sends the data to the database, the following exception is thrown:\n...\nMicrosoft.Data.SqlClient.SqlException (0x80131904): Cannot insert explicit \nvalue for identity column in table 'Products' when IDENTITY_INSERT  \nis set to OFF.\n...\nBy default, Entity Framework Core configures the database to assign primary key values \nwhen new objects are stored. This means the application doesn’t have to worry about \nkeeping track of which key values have already been assigned and allows multiple \n 513 Improving the web service \napplications to share the same database without the need to coordinate key alloca-\ntion. The Product  data model class needs a ProductId  property, but the model bind-\ning process doesn’t understand the significance of the property and adds any values \nthat the client provides to the objects it creates, which causes the exception in the  \nSaveProduct  action method. \nThis is known as over-binding , and it can cause serious problems when a client pro-\nvides values that the developer didn’t expect. At best, the application will behave unex-\npectedly, but this technique has been used to subvert application security and grant \nusers more access than they should have. \nThe safest way to prevent over-binding is to create separate data model classes that \nare used only for receiving data through the model binding process. Add a class file \nnamed ProductBindingTarget.cs  to the WebApp/Models  folder and use it to define \nthe class shown in listing 19.16.\nListing 19.16    The ProductBindingTarget.cs file in the WebApp/Models folder\nnamespace WebApp.Models {\n    public class ProductBindingTarget {\n        public required string Name { get; set; }\n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public long SupplierId { get; set; }\n        public Product ToProduct() => new Product() {\n            Name = this.Name, Price = this.Price,\n            CategoryId = this.CategoryId, SupplierId = this.SupplierId\n        };\n    }\n}\nThe ProductBindingTarget  class defines only the properties that the application \nwants to receive from the client when storing a new object. The ToProduct  method \ncreates a Product  that can be used with the rest of the application, ensuring that the \nclient can provide properties only for the Name , Price , CategoryId , and SupplierId  \nproperties. Listing 19.17 uses the binding target class in the SaveProduct  action to \nprevent over-binding.\nListing 19.17    A binding target in the ProductsController.cs file in the Controllers folder\n...\n[HttpPost]\npublic async Task SaveProduct([FromBody] ProductBindingTarget target) {\n    await context.Products.AddAsync(target.ToProduct());\n    await context.SaveChangesAsync();\n}\n...",8968
223-19.5.3 Using action results.pdf,223-19.5.3 Using action results,"514 chapter  19 Creating RESTful web services \nRestart ASP.NET Core and repeat the command from listing 19.15, and you will see the \nresponse shown in figure 19.9. The client has included the ProductId  value, but it is \nignored by the model binding process, which discards values for read-only properties. \n(You may see a different value for the ProductId  property when you run this example \ndepending on the changes you made to the database before running the command.)\nFigure 19.9    Discarding \nunwanted data \nvalues\n19.5.3  Using action results\nASP.NET Core sets the status code for responses automatically, but you won’t always get \nthe result you desire, in part because there are no firm rules for RESTful web services, \nand the assumptions that Microsoft makes may not match your expectations. To see \nan example, use a PowerShell command prompt to run the command shown in listing \n19.18, which sends a GET request to the web service.  \nListing 19.18    Sending a GET request \nInvoke-WebRequest http://localhost:5000/api/products/1000 | Select-Object  \n‰StatusCode\nThe Invoke-WebRequest  command is similar to the Invoke-RestMethod  command \nused in earlier examples but makes it easier to get the status code from the response. \nThe URL requested in listing 19.18 will be handled by the GetProduct  action method, \nwhich will query the database for an object whose ProductId  value is 1000 , and the \ncommand produces the following output:\nStatusCode \n---------- \n       204\nThere is no matching object in the database, which means that the GetProduct  \naction method returns null . When the MVC Framework receives null  from an action \nmethod, it returns the 204 status code, which indicates a successful request that has \nproduced no data. Not all web services behave this way, and a common alternative is to \nreturn a 404 response, indicating not found. \nSimilarly, the SaveProducts  action will return a 200 response when it stores an \nobject, but since the primary key isn’t generated until the data is stored, the client \ndoesn’t know what key value was assigned. \n 515 Improving the web service \nNOTE     There is no right or wrong when it comes to these kinds of web service \nimplementation details, and you should pick the approaches that best suit your \nproject and personal preferences. This section is an example of how to change \nthe default behavior and not a direction to follow any specific style of web service.\nAction methods can direct the MVC Framework to send a specific response by return-\ning an object that implements the IActionResult  interface, which is known as an \naction result . This allows the action method to specify the type of response that is \nrequired without having to produce it directly using the HttpResponse  object.\nThe ControllerBase  class provides a set of methods that are used to create action \nresult objects, which can be returned from action methods. Table 19.7 describes the \nmost useful action result methods.\nTable 19.7    Useful ControllerBase action result methods\nName Description\nOk The IActionResult  returned by this method produces a 200 \nOK status code and sends an optional data object in the response \nbody.\nNoContent The IActionResult  returned by this method produces a 204 \nNO CONTENT status code.\nBadRequest The IActionResult  returned by this method produces a 400 \nBAD REQUEST status code. The method accepts an optional model \nstate object that describes the problem to the client, as demon-\nstrated in the “Validating Data” section.\nFile The IActionResult  returned by this method produces a 200 OK \nresponse, sets the Content-Type  header to the specified type, \nand sends the specified file to the client. \nNotFound The IActionResult  returned by this method produces a 404 \nNOT FOUND status code.\nRedirect \nRedirectPermanentThe IActionResult  returned by these methods redirects the \nclient to a specified URL.\nRedirectToRoute \nRedirectToRoutePermanentThe IActionResult  returned by these methods redirects the \nclient to the specified URL that is created using the routing system, \nusing convention routing, as described in the “Redirecting Using \nRoute Values” sidebar.\nLocalRedirect \nLocalRedirectPermanentThe IActionResult  returned by these methods redirects the \nclient to the specified URL that is local to the application. \nRedirectToAction \nRedirectToActionPermanentThe IActionResult  returned by these methods redirects the \nclient to an action method. The URL for the redirection is created \nusing the URL routing system.\nRedirectToPage \nRedirectToPagePermanentThe IActionResult  returned by these methods redirects the \nclient to a Razor Page, described in chapter 23.\nStatusCode The IActionResult  returned by this method produces a \nresponse with a specific status code.\n516 chapter  19 Creating RESTful web services \nWhen an action method returns an object, it is equivalent to passing the object to the \nOk method and returning the result. When an action returns null , it is equivalent to \nreturning the result from the NoContent  method. Listing 19.19 revises the behavior of \nthe GetProduct  and SaveProduct  actions so they use the methods from table 19.7 to \noverride the default behavior for web service controllers.\nListing 19.19    Action results in the ProductsController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IAsyncEnumerable<Product> GetProducts() {\n            return context.Products.AsAsyncEnumerable();\n        }\n        [HttpGet(""{id}"")]\n        public async Task<IActionResult> GetProduct(long id) {\n            Product? p = await context.Products.FindAsync(id);\n            if (p == null) {\n                return NotFound();\n            }\n            return Ok(p);\n        }\n        [HttpPost]\n        public async Task<IActionResult>\n                SaveProduct([FromBody] ProductBindingTarget target) {\n            Product p = target.ToProduct();\n            await context.Products.AddAsync(p);\n            await context.SaveChangesAsync();\n            return Ok(p);\n        }\n        [HttpPut]\n        public async Task UpdateProduct([FromBody] Product product) {\n            context.Update(product);\n            await context.SaveChangesAsync();\n        }\n        [HttpDelete(""{id}"")]\n        public async Task DeleteProduct(long id) {\n            context.Products.Remove(new Product() {\n                ProductId = id, Name = string.Empty\n 517 Improving the web service \n            });\n            await context.SaveChangesAsync();\n        }\n    }\n}\nRestart ASP.NET Core and repeat the command from listing 19.18, and you will see an \nexception, which is how the Invoke-WebRequest  command responds to error status \ncodes, such as the 404 Not Found returned by the GetProduct  action method.\nTo see the effect of the change to the SaveProduct  action method, use a PowerShell \ncommand prompt to run the command shown in listing 19.20, which sends a POST \nrequest to the web service.\nListing 19.20    Sending a POST request \nInvoke-RestMethod http://localhost:5000/api/products -Method POST -Body   \n‰(@{Name=""Boot Laces""; Price=19.99; CategoryId=2; SupplierId=2} |  \n‰ConvertTo-Json) -ContentType ""application/json""\nThe command will produce the following output, showing the values that were parsed \nfrom the JSON data received from the web service:\nproductId  : 13 \nname       : Boot Laces \nprice      : 19.99 \ncategoryId : 2 \ncategory   : \nsupplierId : 2 \nsupplier   :\nperforming  redirections\nMany of the action result methods in table 19.7 relate to redirections, which redirect \nthe client to another URL. The most basic way to perform a redirection is to call the \nRedirect  method, as shown in listing 19.21.\nTIP    The LocalRedirect  and LocalRedirectPermanent  methods throw an \nexception if a controller tries to perform a redirection to any URL that is not \nlocal. This is useful when you are redirecting to URLs provided by users, where \nan open redirection attack  is attempted to redirect another user to an untrusted site. \nListing 19.21    Redirecting in the ProductsController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n518 chapter  19 Creating RESTful web services \n            context = ctx;\n        }\n        // ...other action methods omitted for brevity...\n        [HttpGet(""redirect"")]\n        public IActionResult Redirect() {\n            return Redirect(""/api/products/1"");\n        }\n    }\n}\nThe redirection URL is expressed as a string  argument to the Redirect  method, \nwhich produces a temporary redirection. Restart ASP.NET Core and use a PowerShell \ncommand prompt to run the command shown in listing 19.22, which sends a GET \nrequest that will be handled by the new action method.\nListing 19.22    Testing redirection \nInvoke-RestMethod http://localhost:5000/api/products/redirect\nThe Invoke-RestMethod  command will receive the redirection response from the \nweb service and send a new request to the URL it is given, producing the following \nresponse:\nproductId  : 1 \nname       : Green Kayak \nprice      : 275.00 \ncategoryId : 1 \ncategory   : \nsupplierId : 1 \nsupplier   :\nredirecting  to an action  method\nYou can redirect to another action method using the RedirectToAction  method (for \ntemporary redirections) or the RedirectToActionPermanent  method (for perma-\nnent redirections). Listing 19.23 changes the Redirect  action method so that the cli-\nent will be redirected to another action method defined by the controller.\nListing 19.23    Redirecting in the ProductsController.cs file in the Controllers folder\n...\n[HttpGet(""redirect"")]\npublic IActionResult Redirect() {\n    return RedirectToAction(nameof(GetProduct), new { Id = 1 });\n}\n...\nThe action method is specified as a string, although the nameof  expression can be used \nto select an action method without the risk of a typo. Any additional values required \nto create the route are supplied using an anonymous object. Restart ASP.NET Core \nand use a PowerShell command prompt to repeat the command in listing 19.22. The \nrouting system will be used to create a URL that targets the specified action method, \nproducing the following response:",10862
224-19.5.4 Validating data.pdf,224-19.5.4 Validating data,"519 Improving the web service \nproductId  : 1 \nname       : Green Kayak \nprice      : 275.00 \ncategoryId : 1 \ncategory   : \nsupplierId : 1 \nsupplier   :\nIf you specify only an action method name, then the redirection will target the current \ncontroller. There is an overload of the RedirectToAction  method that accepts action \nand controller names. \nRedirecting using route values \nThe RedirectToRoute  and RedirectToRoutePermanent  methods redirect the \nclient to a URL that is created by providing the routing system with values for segment \nvariables and allowing it to select a route to use. This can be useful for applications with \ncomplex routing configurations, and caution should be used because it is easy to create \na redirection to the wrong URL. Here is an example of redirection with the Redirect-\nToRoute  method:\n...\n[HttpGet(""redirect"")]\npublic IActionResult Redirect() {\n    return RedirectToRoute(new {\n        controller = ""Products"", action = ""GetProduct"", Id = 1\n    });\n}\n...\nThe set of values in this redirection relies on convention routing to select the control-\nler and action method. Convention routing is typically used with controllers that produce \nHTML responses, as described in chapter 21.\n19.5.4  Validating data \nWhen you accept data from clients, you must assume that a lot of the data will be \ninvalid and be prepared to filter out values that the application can’t use. The data \nvalidation features provided for MVC Framework controllers are described in detail \nin chapter 29, but for this chapter, I am going to focus on only one problem: ensuring \nthat the client provides values for the properties that are required to store data in the \ndatabase. The first step in model binding is to apply attributes to the properties of the \ndata model class, as shown in listing 19.24.  \nListing 19.24    Attributes in the ProductBindingTarget.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations;\nnamespace WebApp.Models {\n    public class ProductBindingTarget {\n520 chapter  19 Creating RESTful web services \n        [Required]\n        public required string Name { get; set; }\n        [Range(1, 1000)]\n        public decimal Price { get; set; }\n        [Range(1, long.MaxValue)]\n        public long CategoryId { get; set; }\n        [Range(1, long.MaxValue)]\n        public long SupplierId { get; set; }\n        public Product ToProduct() => new Product() {\n            Name = this.Name, Price = this.Price,\n            CategoryId = this.CategoryId, SupplierId = this.SupplierId\n        };\n    }\n}\nThe Required  attribute denotes properties for which the client must provide a value \nand can be applied to properties that are assigned null  when there is no value in the \nrequest. The Range  attribute requires a value between upper and lower limits and is \nused for primitive types that will default to zero when there is no value in the request.\nNOTE     The Required  attribute could be omitted from the Name  property \nbecause ASP.NET Core will infer the validation constraint from the required  \nkeyword. This is a useful feature, but I like to use the Required  attribute for \nconsistency and to make it obvious that the validation constraint was intentional.\nListing 19.25 updates the SaveProduct  action to perform validation before storing \nthe object that is created by the model binding process, ensuring that only objects \nthat contain values for all four properties decorated with the validation attributes are \naccepted.  \nListing 19.25    Validation in the ProductsController.cs file in the Controllers folder\n...\n[HttpPost]\npublic async Task<IActionResult>\n        SaveProduct([FromBody] ProductBindingTarget target) {\n    if (ModelState.IsValid) {\n        Product p = target.ToProduct();\n        await context.Products.AddAsync(p);\n        await context.SaveChangesAsync();\n        return Ok(p);\n    }\n    return BadRequest(ModelState);\n}\n...\nThe ModelState  property is inherited from the ControllerBase  class, and the \nIsValid  property returns true  if the model binding process has produced data that",4160
225-19.5.5 Applying the API controller attribute.pdf,225-19.5.5 Applying the API controller attribute,"521 Improving the web service \nmeets the validation criteria. If the data received from the client is valid, then the \naction result from the Ok method is returned. If the data sent by the client fails the \nvalidation check, then the IsValid  property will be false , and the action result from \nthe BadRequest  method is used instead. The BadRequest  method accepts the object \nreturned by the ModelState  property, which is used to describe the validation errors \nto the client. (There is no standard way to describe validation errors, so the client may \nrely only on the 400 status code to determine that there is a problem.)\nTo test the validation, restart ASP.NET Core and use a new PowerShell command \nprompt to run the command shown in listing 19.26.\nListing 19.26    Testing validation \nInvoke-WebRequest http://localhost:5000/api/products -Method POST -Body   \n‰(@{Name=""Boot Laces""} | ConvertTo-Json) -ContentType ""application/json""\nThe command will throw an exception that shows the web service has returned a 400 \nBad Request response. Details of the validation errors are not shown because neither \nthe Invoke-WebRequest  command nor the Invoke-RestMethod  command provides \naccess to error response bodies. Although you can’t see it, the body contains a JSON \nobject that has properties for each data property that has failed validation, like this:\n{ \n ""Price"":[""The field Price must be between 1 and 1000.""], \n ""CategoryId"":[""The field CategoryId must be between 1  \n    and 9.223372036854776E+18.""], \n ""SupplierId"":[""The field SupplierId must be between 1  \n    and 9.223372036854776E+18.""] \n}\nYou can see examples of working with validation messages in chapter 29 where the val-\nidation feature is described in detail.\n19.5.5  Applying the API controller attribute \nThe ApiController  attribute can be applied to web service controller classes to \nchange the behavior of the model binding and validation features. The use of the \nFromBody  attribute to select data from the request body and explicitly check the  \nModelState.IsValid  property is not required in controllers that have been deco-\nrated with the ApiController  attribute. Getting data from the body and validating \ndata are required so commonly in web services that they are applied automatically \nwhen the attribute is used, restoring the focus of the code in the controller’s action to \ndealing with the application features, as shown in listing 19.27.  \nListing 19.27    The ProductsController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n522 chapter  19 Creating RESTful web services \n    [Route(""api/[controller]"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IAsyncEnumerable<Product> GetProducts() {\n            return context.Products.AsAsyncEnumerable();\n        }\n        [HttpGet(""{id}"")]\n        public async Task<IActionResult> GetProduct(long id) {\n            Product? p = await context.Products.FindAsync(id);\n            if (p == null) {\n                return NotFound();\n            }\n            return Ok(p);\n        }\n        [HttpPost]\n        public async Task<IActionResult>\n                SaveProduct(ProductBindingTarget target) {\n            Product p = target.ToProduct();\n            await context.Products.AddAsync(p);\n            await context.SaveChangesAsync();\n            return Ok(p);            \n        }\n        [HttpPut]\n        public async Task UpdateProduct(Product product) {\n            context.Update(product);\n            await context.SaveChangesAsync();\n        }\n        [HttpDelete(""{id}"")]\n        public async Task DeleteProduct(long id) {\n            context.Products.Remove(new Product() {\n                ProductId = id, Name = string.Empty\n            });\n            await context.SaveChangesAsync();\n        }\n        [HttpGet(""redirect"")]\n        public IActionResult Redirect() {\n            return RedirectToAction(nameof(GetProduct), new { Id = 1 });\n        }\n    }\n}\nUsing the ApiController  attribute is optional, but it helps produce concise web ser-\nvice controllers.",4369
226-19.5.6 Omitting Null properties.pdf,226-19.5.6 Omitting Null properties,"523 Improving the web service \n19.5.6  Omitting Null properties \nThe final change I am going to make in this chapter is to remove the null  values \nfrom the data returned by the web service. The data model classes contain navigation \nproperties that are used by Entity Framework Core to associate related data in complex \nqueries, as explained in chapter 20. For the simple queries that are performed in this \nchapter, no values are assigned to these navigation properties, which means that the \nclient receives properties for which values are never going to be available. To see the \nproblem, use a PowerShell command prompt to run the command shown in listing \n19.28.  \nListing 19.28    Sending a GET request \nInvoke-WebRequest http://localhost:5000/api/products/1 |  \n‰Select-Object Content\nThe command sends a GET request and displays the body of the response from the \nweb service, producing the following output:\nContent \n------- \n{""productId"":1,""name"":""Green Kayak"",""price"":275.00, \n ""categoryId"":1,""category"":null,""supplierId"":1,""supplier"":null}\nThe request was handled by the GetProduct  action method, and the category  and \nsupplier  values in the response will always be null  because the action doesn’t ask \nEntity Framework Core to populate these properties.\nprojecting  selected  properties  \nThe first approach is to return just the properties that the client requires. This gives \nyou complete control over each response, but it can become difficult to manage and \nconfusing for client developers if each action returns a different set of values. Listing \n19.29 shows how the Product  object obtained from the database can be projected so \nthat the navigation properties are omitted.\nListing 19.29    Omit properties in the ProductsController.cs file in the Controllers folder \n...\n[HttpGet(""{id}"")]\npublic async Task<IActionResult> GetProduct(long id) {\n    Product? p = await context.Products.FindAsync(id);\n    if (p == null) {\n        return NotFound();\n    }\n    return Ok(new {\n        p.ProductId, p.Name, p.Price, p.CategoryId, p.SupplierId\n    });\n}\n...\nThe properties that the client requires are selected and added to an object that is \npassed to the Ok method. Restart ASP.NET Core and run the command from listing \n524 chapter  19 Creating RESTful web services \n19.28, and you will receive a response that omits the navigation properties and their \nnull  values, like this:\nContent \n------- \n{""productId"":1,""name"":""Green Kayak"",""price"":275.00, \n ""categoryId"":1,""supplierId"":1}\nconfiguring  the json  serializer\nThe JSON serializer can be configured to omit properties when it serializes objects. \nOne way to configure the serializer is with the JsonIgnore  attribute, as shown in list-\ning 19.30.  \nListing 19.30    Configuring the serializer in the Product.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n        public required string Name { get; set; }\n        [Column(TypeName = ""decimal(8, 2)"")]\n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nThe Condition  property is assigned a JsonIgnoreCondition  value, as described in \ntable 19.8.  \nTable 19.8    The values defined by the JsonIgnoreCondition enum\nName Description\nAlways The property will always be ignored when serializ-\ning an object.\nNever The property will always be included when serializ-\ning an object.\nWhenWritingDefault The property will be ignored if the value is null  or \nthe default value for the property type.\nWhenWritingNull The property will be ignored if the value is null .\n 525 Improving the web service \nThe JsonIgnore  attribute has been applied using the WhenWritingNull  value, which \nmeans that the Supplier  property will be ignored if its value is null . Listing 19.31 \nupdates the controller to use the Product  class directly in the GetProduct  action \nmethod.\nListing 19.31    A model class in the ProductController.cs file in the Controllers folder\n...\n[HttpGet(""{id}"")]\npublic async Task<IActionResult> GetProduct(long id) {\n    Product? p = await context.Products.FindAsync(id);\n    if (p == null) {\n        return NotFound();\n    }\n    return Ok(p);\n}\n...\nRestart ASP.NET Core and run the command from listing 19.28, and you will receive a \nresponse that omits the supplier  property, like this:\nContent \n------- \n{""productId"":1,""name"":""Green Kayak"",""price"":275.00,""categoryId"":1, \n    ""category"":null, \n ""supplierId"":1}\nThe attribute has to be applied to model classes and is useful when a small number of \nproperties should be ignored, but this can be difficult to manage for more complex \ndata models. A general policy can be defined for serialization using the options pat-\ntern, as shown in listing 19.32.\nListing 19.32    Configuring the serializer in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Text.Json.Serialization;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers();\nbuilder.Services.Configure<JsonOptions>(opts => {\n    opts.JsonSerializerOptions.DefaultIgnoreCondition \n        = JsonIgnoreCondition.WhenWritingNull;\n});",5839
227-19.5.7 Applying a rate limit.pdf,227-19.5.7 Applying a rate limit,"526 chapter  19 Creating RESTful web services \nvar app = builder.Build();\napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe JSON serializer is configured using the JsonSerializerOptions  property of the \nJsonOptions  class, and null  values are managed using the DefaultIgnore  Condition  \nproperty, which is assigned one of the JsonIgnoreCondition  values described in table \n19.8. (The Always  value does not make sense when using the options pattern and will \ncause an exception when ASP.NET Core is started.)\nThis configuration change affects all JSON responses and should be used with cau-\ntion, especially if your data model classes use null  values to impart information to \nthe client. To see the effect of the change, restart ASP.NET Core and use a browser to \nrequest http://localhost:5000/api/products, which will produce the response shown \nin figure 19.10.\nTIP    The JsonIgnore  attribute can be used to override the default policy, which \nis useful if you need to include null  or default values for a particular property.\nFigure 19.10    Configuring the JSON serializer \n19.5.7  Applying a rate limit \nIn chapter 16, I demonstrated the rate limiting feature and showed you how it is \napplied to individual endpoints. This feature also works for controllers, using an attri-\nbute to select the rate limit that will be applied. In preparation, listing 19.33 defines a \nrate limiting policy and enables rate limits on controllers.\n 527 Improving the web service \nListing 19.33    Rate limits in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.RateLimiting;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers();\nbuilder.Services.AddRateLimiter(opts => {\n    opts.AddFixedWindowLimiter(""fixedWindow"", fixOpts => {\n        fixOpts.PermitLimit = 1;\n        fixOpts.QueueLimit = 0;\n        fixOpts.Window = TimeSpan.FromSeconds(15);\n    });\n});\nbuilder.Services.Configure<JsonOptions>(opts => {\n    opts.JsonSerializerOptions.DefaultIgnoreCondition\n        = JsonIgnoreCondition.WhenWritingNull;\n});\nvar app = builder.Build();\napp.UseRateLimiter();\napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThis listing sets up the same policy I used in chapter 16, which limits requests to one \nevery 15 seconds with no queue. Listing 19.34 applies the policy to the controller using \nthe EnableRateLimiting  and DisableRateLimiting  attributes.\nNOTE     You can apply a single rate limiting policy to all controllers by calling \napp.MapControllers().RequireRateLimiting(""fixedWindow"") . This pol-\nicy can be overridden for specific controllers and actions using the Enable-\nRateLimiting  and DisableRateLimiting  attributes.\n528 chapter  19 Creating RESTful web services \nListing 19.34    Limits in the ProductsController.cs file in the WebApp/Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.RateLimiting;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""api/[controller]"")]\n    [EnableRateLimiting(""fixedWindow"")]\n    public class ProductsController : ControllerBase {\n        private DataContext context;\n        public ProductsController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IAsyncEnumerable<Product> GetProducts() {\n            return context.Products.AsAsyncEnumerable();\n        }\n        [HttpGet(""{id}"")]\n        [DisableRateLimiting]\n        public async Task<IActionResult> GetProduct(long id) {\n            Product? p = await context.Products.FindAsync(id);\n            if (p == null) {\n                return NotFound();\n            }\n            return Ok(p);\n        }\n        // ...other action methods omitted for brevity...\n    }\n}\nThe EnableRateLimiting  attribute is used to apply a rate limiting policy to the con-\ntroller, specifying the name of the policy as an argument. This policy will apply to all \nof the action methods defined by the controller, except the GetProduct  method, to \nwhich the DisableRateLimiting  attribute has been applied and to which no limits \nwill be enforced.\nRestart ASP.NET Core and use a browser to request http://localhost:5000/api/\nproducts. Click the browser’s reload button and you will exceed the request limit and see \na 503 error, as shown in figure 19.11. You can request the URL http://localhost:5000/\napi/products/1 as often as you wish without producing an error.",5128
228-20.1.1 Dropping the database.pdf,228-20.1.1 Dropping the database,"529 Summary\nFigure 19.11    An error caused by a rate limit\nSummary\n¡ RESTful web services use the HTTP method and URL to specify an operation to \nperform.Web services can be created using top-level statements but using con-\ntroller scales is better for most projects.\n¡ The base class for controllers defines properties that access the request data. \n¡ Action methods are decorated with attributes to specify the HTTP methods they \naccept.\n¡ ASP.NET Core will perform model binding to extract data from the request and \npass it to an action method as an object. \n¡ Care must be taken to receive only the data that is required from the user.\n¡ Data validation can be performed on the data that is produced by model bind-\ning, ensuring that clients provide data in a way the ASP.NET Core application can \nwork with.\n¡ The rate limiting features described in chapter 16 can also be applied to web \nservices.\n53020Advanced web  \nservice features\nThis chapter covers\n¡ Managing related data in web service results\n¡ Supporting the PATCH method to make  \n selective changes\n¡ Formatting content produced by web services\n¡ Caching the output from web services\n¡ Generating documentation that describes a  \n web service\nIn this chapter, I describe advanced features that can be used to create RESTful web \nservices. I explain how to deal with related data in Entity Framework Core queries, \nhow to add support for the HTTP PATCH method, how to use content negotiations, \nand how to use OpenAPI to describe your web services. Table 20.1 puts this chapter \nin context.\n 531 Preparing for this chapter\nTable 20.1    Putting advanced web service features in context\nQuestion Answer\nWhat are they? The features described in this chapter provide greater control \nover how ASP.NET Core web services work, including man-\naging the data sent to the client and the format used for that \ndata.\nWhy are they useful? The default behaviors provided by ASP.NET Core don’t meet \nthe needs of every project, and the features described in \nthis chapter allow web services to be reshaped to fit specific \nrequirements.\nHow are they used? The common theme for the features in this chapter is altering \nthe responses produced by action methods. \nAre there any pitfalls or \nlimitations?It can be hard to decide how to implement web services, espe-\ncially if they are consumed by third-party clients. The behavior \nof a web service becomes fixed as soon as clients start using \na web service, which means that careful thought is required \nwhen using the features described in this chapter. \nAre there any \nalternatives?The features described in this chapter are optional, and \nyou can rely on the default behaviors of ASP.NET Core web \nservices.\nTable 20.2 provides a guide to the chapter.\nTable 20.2    Chapter guide\nProblem Solution Listing\nUsing relational data Use the Include  and ThenIn-\nclude  methods in LINQ queries. 4\nBreaking circular references Explicitly set navigation properties \nto null .5\nAllowing clients to selectively update data Support the HTTP PATCH method. 6–9\nSupporting a range of response data types Support content formatting and \nnegotiation. 10–24\nCache output Use the output caching middleware \nand the OutputCache attribute.25, 26\nDocumenting a web service Use OpenAPI to describe the web \nservice.27–29\n20.1 Preparing for this chapter\nThis chapter uses the WebApp project created in chapter 18 and modified in chapter \n19. To prepare for this chapter, add a file named SuppliersController.cs  to the \nWebApp/Controllers  folder with the content shown in listing 20.1.",3642
229-20.2 Dealing with related data.pdf,229-20.2 Dealing with related data,"532 chapter  20 Advanced web service features \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 20.1    The contents of the SuppliersController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""api/[controller]"")]\n    public class SuppliersController : ControllerBase {\n        private DataContext context;\n        public SuppliersController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet(""{id}"")]\n        public async Task<Supplier?> GetSupplier(long id) {\n            return await context.Suppliers.FindAsync(id);\n        }\n    }\n}\nThe controller extends the ControllerBase  class, declares a dependency on the \nDataContext  service, and defines an action named GetSupplier  that handles GET \nrequests for the /api/[controller]/{id}  URL pattern.\n20.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 20.2 to drop the database.\nListing 20.2    Dropping the database\ndotnet ef database drop --force\n20.1.2  Running the example application \nOnce the database has been dropped, use the PowerShell command prompt to run \nthe command shown in listing 20.3. \nListing 20.3    Running the example application \ndotnet run\nThe database will be seeded as part of the application startup. Once ASP.NET Core is \nrunning, use a web browser to request http://localhost:5000/api/suppliers/1, which \nwill produce the response shown in figure 20.1.\n 533 Dealing with related data \nFigure 20.1    \nRunning the \nexample \napplication\nThe response shows the Supplier  object whose primary key matches the last segment of \nthe request URL. In chapter 19, the JSON serializer was configured to ignore properties \nwith null  values, which is why the response doesn’t include the navigation property \ndefined by the Supplier  data model class.\n20.2 Dealing with related data \nAlthough this isn’t a book about Entity Framework Core, there is one aspect of que-\nrying for data that most web services encounter. The data model classes defined in \nchapter 18 include navigation properties, which Entity Framework Core can populate \nby following relationships in the database when the Include  method is used, as shown \nin listing 20.4.  \nListing 20.4    Related data in the SuppliersController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""api/[controller]"")]\n    public class SuppliersController : ControllerBase {\n        private DataContext context;\n        public SuppliersController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet(""{id}"")]\n        public async Task<Supplier?> GetSupplier(long id) {\n            return await context.Suppliers\n                .Include(s => s.Products)\n                .FirstAsync(s => s.SupplierId == id);\n        }\n    }\n}\nThe Include  method tells Entity Framework Core to follow a relationship in the data-\nbase and load the related data. In this case, the Include  method selects the Products  \nnavigation property defined by the Supplier  class, which causes Entity Framework \n534 chapter  20 Advanced web service features \nCore to load the Product  objects associated with the selected Supplier  and assign \nthem to the Products  property.  \nRestart ASP.NET Core and use a browser to request http://localhost:5000/api/\nsuppliers/1, which will target the GetSupplier  action method. The request fails, and \nyou will see the exception shown in figure 20.2.\nFigure 20.2    An exception caused by querying for related data\nThe JSON serializer has reported an “object cycle,” which means there is a circular ref-\nerence in the data that is being serialized for the response. \nLooking at the code in listing 20.4, you might struggle to see why using the Include  \nmethod has created a circular reference. The problem is caused by an Entity Frame-\nwork Core feature that attempts to minimize the amount of data read from the database \nbut that causes problems in ASP.NET Core applications. \nWhen Entity Framework Core creates objects, it populates navigation properties \nwith objects that have already been created by the same database context. This can be \na useful feature in some kinds of applications, such as desktop apps, where a database \ncontext object has a long life and is used to make many requests over time. It isn’t useful \nfor ASP.NET Core applications, where a new context object is created for each HTTP \nrequest. \nEntity Framework Core queries the database for the Product  objects associated with \nthe selected Supplier  and assigns them to the Supplier.Products  navigation prop-\nerty. The problem is that Entity Framework Core then looks at each Product  object \nit has created and uses the query response to populate the Product.Supplier  navi-\ngation property as well. For an ASP.NET Core application, this is an unhelpful step to \ntake because it creates a circular reference between the navigation properties of the  \nSupplier  and Product  objects, as shown in figure 20.3.",5520
230-20.3 Supporting the HTTP PATCH method.pdf,230-20.3 Supporting the HTTP PATCH method,"535 Dealing with related data \nFigure 20.3    Understanding how Entity Framework Core uses related data\nWhen the Supplier  object is returned by the controller’s action method, the JSON \nserializer works its way through the properties and follows the references to the  \nProduct  objects, each of which has a reference back to the Supplier object, which \nit follows in a loop until the maximum depth is reached and the exception shown in \nfigure 20.2 is thrown.\n20.2.1  Breaking circular references in related data \nThere is no way to stop Entity Framework Core from creating circular references in \nthe data it loads in the database. Preventing the exception means presenting the JSON \nserializer with data that doesn’t contain circular references, which is most easily done \nby altering the objects after they have been created by Entity Framework Core and \nbefore they are serialized, as shown in listing 20.5.  \nListing 20.5    References in the SuppliersController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""api/[controller]"")]\n    public class SuppliersController : ControllerBase {\n        private DataContext context;\n        public SuppliersController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet(""{id}"")]\n        public async Task<Supplier?> GetSupplier(long id) {",1472
231-20.3.3 Defining the action method.pdf,231-20.3.3 Defining the action method,"536 chapter  20 Advanced web service features \n            Supplier supplier = await context.Suppliers\n                .Include(s => s.Products)\n                .FirstAsync(s => s.SupplierId == id);\n            if (supplier.Products != null) {\n                foreach (Product p in supplier.Products) {\n                    p.Supplier = null;\n                };\n            }\n            return supplier;\n        }\n    }\n}\nThe foreach  loop sets the Supplier property of each Product  object to null , \nwhich breaks the circular references. Restart ASP.NET Core and request http://\nlocalhost:5000/api/suppliers/1 to query for a supplier and its related products, which \nproduces the response shown in figure 20.4.\nFigure 20.4    Querying for related data\n20.3 Supporting the HTTP PATCH method\nFor simple data types, edit operations can be handled by replacing the existing object \nusing the PUT method, which is the approach I took in chapter 19. Even if you only \nneed to change a single property value in the Product  class, for example, it isn’t too \nmuch trouble to use a PUT method and include the values for all the other Product  \nproperties, too.\nNot all data types are as easy to work with, either because they define too many prop-\nerties or because the client has received values only for selected properties. The solu-\ntion is to use a PATCH request, which sends just the changes to the web service rather \nthan a complete replacement object. \n20.3.1  Understanding JSON Patch \nASP.NET Core has support for working with the JSON Patch standard, which allows \nchanges to be specified in a uniform way. The JSON Patch standard allows for a com-\nplex set of changes to be described, but for this chapter, I am going to focus on just the \nability to change the value of a property.  \nI am not going to go into the details of the JSON Patch standard, which you can read \nat https://tools.ietf.org/html/rfc6902 , but the client is going to send the web service \nJSON data like this in its HTTP PATCH requests:\n 537 Supporting the HTTP PATCH method\n[\n { ""op"": ""replace"", ""path"": ""Name"", ""value"": ""Surf Co""},\n { ""op"": ""replace"", ""path"": ""City"", ""value"": ""Los Angeles""},\n]\nA JSON Patch document is expressed as an array of operations. Each operation has an \nop property, which specifies the type of operation, and a path  property, which specifies \nwhere the operation will be applied. \nFor the example application—and, in fact, for most applications—only the replace  \noperation is required, which is used to change the value of a property. This JSON Patch \ndocument sets new values for the Name  and City  properties. The properties defined by \nthe Supplier  class not mentioned in the JSON Patch document will not be modified.\n20.3.2  Installing and configuring the JSON Patch package \nSupport for JSON Patch isn’t installed when a project is created with the Empty tem-\nplate. To install the JSON Patch package, open a new PowerShell command prompt, \nnavigate to the folder that contains the WebApp.csproj  file, and run the command \nshown in listing 20.6. If you are using Visual Studio, you can install the package by \nselecting Project > Manage NuGet Packages.  \nListing 20.6    Installing the JSON Patch package \ndotnet add package Microsoft.AspNetCore.Mvc.NewtonsoftJson --version 7.0.0\nThe Microsoft implementation of JSON Patch relies on the third-party Newtonsoft \nJSON.NET serializer. Add the statements shown in listing 20.7 to the Program.cs  file \nto enable the JSON.NET serializer.  \nListing 20.7    Enabling the serializer in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\n//using System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.RateLimiting;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers().AddNewtonsoftJson();\nbuilder.Services.AddRateLimiter(opts => {\n    opts.AddFixedWindowLimiter(""fixedWindow"", fixOpts => {\n        fixOpts.PermitLimit = 1;\n        fixOpts.QueueLimit = 0;\n        fixOpts.Window = TimeSpan.FromSeconds(15);\n538 chapter  20 Advanced web service features \n    });\n});\n//builder.Services.Configure<JsonOptions>(opts => {\n//    opts.JsonSerializerOptions.DefaultIgnoreCondition\n//        = JsonIgnoreCondition.WhenWritingNull;\n//});\nbuilder.Services.Configure<MvcNewtonsoftJsonOptions>(opts => {\n    opts.SerializerSettings.NullValueHandling\n        = Newtonsoft.Json.NullValueHandling.Ignore;\n});\nvar app = builder.Build();\napp.UseRateLimiter();\napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe AddNewtonsoftJson  method enables the JSON.NET serializer, which replaces \nthe standard ASP.NET Core serializer. The JSON.NET serializer has its own config-\nuration class, MvcNewtonsoftJsonOptions , which is applied through the options \npattern. Listing 20.7 sets the NullValueHandling  value, which tells the serializer to \ndiscard properties with null  values. \nTIP    See https://www.newtonsoft.com/json  for details of the other configura-\ntion options available for the JSON.NET serializer. \n20.3.3  Defining the action method \nTo add support for the PATCH method, add the action method shown in listing 20.8 to \nthe SuppliersController  class.  \nListing 20.8    Adding an action in the SuppliersController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.JsonPatch;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""api/[controller]"")]\n    public class SuppliersController : ControllerBase {\n 539 Supporting the HTTP PATCH method\n        private DataContext context;\n        public SuppliersController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet(""{id}"")]\n        public async Task<Supplier?> GetSupplier(long id) {\n            Supplier supplier = await context.Suppliers\n                .Include(s => s.Products)\n                .FirstAsync(s => s.SupplierId == id);\n            if (supplier.Products != null) {\n                foreach (Product p in supplier.Products) {\n                    p.Supplier = null;\n                };\n            }\n            return supplier;\n        }\n        [HttpPatch(""{id}"")]\n        public async Task<Supplier?> PatchSupplier(long id,\n                JsonPatchDocument<Supplier> patchDoc) {\n            Supplier? s = await context.Suppliers.FindAsync(id);\n            if (s != null) {\n                patchDoc.ApplyTo(s);\n                await context.SaveChangesAsync();\n            }\n            return s;\n        }\n    }\n}\nThe action method is decorated with the HttpPatch  attribute, which denotes that it \nwill handle HTTP PATCH requests. The model binding feature is used to process the \nJSON Patch document through a JsonPatchDocument<T>  method parameter. The \nJsonPatchDocument<T>  class defines an ApplyTo  method, which applies each oper-\nation to an object. The action method in listing 20.8 retrieves a Supplier  object from \nthe database, applies the JSON PATCH, and stores the modified object.  \nRestart ASP.NET Core and use a separate PowerShell command prompt to run the \ncommand shown in listing 20.9, which sends an HTTP PATCH request with a JSON \nPATCH document that changes the value of the City  property to Los Angeles .\nListing 20.9    Sending an HTTP PATCH request \nInvoke-RestMethod http://localhost:5000/api/suppliers/1 -Method PATCH  \n‰-ContentType ""application/json"" -Body '[{""op"":""replace"",""path"":""City"", \n‰""value"":""Los Angeles""}]'\nThe PatchSupplier  action method returns the modified Supplier  object as its \nresult, which is serialized and sent to the client in the HTTP response. You can also \nsee the effect of the change by using a web browser to request http://localhost:5000/  \nsuppliers/1, which produces the response shown in figure 20.5.",8338
232-20.4 Understanding content formatting.pdf,232-20.4 Understanding content formatting,,0
233-20.4.1 Understanding the default content policy.pdf,233-20.4.1 Understanding the default content policy,"540 chapter  20 Advanced web service features \nFigure 20.5    Updating using a PATCH request\n20.4 Understanding content formatting\nThe web service examples so far have produced JSON results, but this is not the \nonly data format that action methods can produce. The content format selected for \nan action result depends on four factors: the formats that the client will accept, the \nformats that the application can produce, the content policy specified by the action \nmethod, and the type returned by the action method. Figuring out how everything \nfits together can be daunting, but the good news is that the default policy works just \nfine for most applications, and you only need to understand what happens behind the \nscenes when you need to make a change or when you are not getting results in the for-\nmat that you expect.  \n20.4.1  Understanding the default content policy \nThe best way to get acquainted with content formatting is to understand what happens \nwhen neither the client nor the action method applies any restrictions to the formats \nthat can be used. In this situation, the outcome is simple and predictable.  \n1 If the action method returns a string , the string is sent unmodified to the client, \nand the Content-Type  header of the response is set to text/plain .\n2 For all other data types, including other simple types such as int, the data is \nformatted as JSON, and the Content-Type  header of the response is set to \napplication/json .\nStrings get special treatment because they cause problems when they are encoded as \nJSON. When you encode other simple types, such as the C# int value 2, then the result \nis a quoted string, such as ""2"". When you encode a string, you end up with two sets of \nquotes so that ""Hello""  becomes """"Hello"""" . Not all clients cope well with this double \nencoding, so it is more reliable to use the text/plain  format and sidestep the issue \nentirely. This is rarely an issue because few applications send string  values; it is more \ncommon to send objects in the JSON format. To see the default policy, add a class file \nnamed ContentController.cs  to the WebApps/Controllers  folder with the code \nshown in listing 20.10.\n 541 Understanding content formatting\nListing 20.10    The contents of the ContentController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""/api/[controller]"")]\n    public class ContentController : ControllerBase {\n        private DataContext context;\n        public ContentController(DataContext dataContext) {\n            context = dataContext;\n        }\n        [HttpGet(""string"")]\n        public string GetString() => ""This is a string response"";\n        [HttpGet(""object"")]\n        public async Task<Product> GetObject() {\n            return await context.Products.FirstAsync();\n        }\n    }\n}\nThe controller defines actions that return string and object results. Restart ASP.NET \nCore and use a separate PowerShell prompt to run the command shown in listing \n20.11; this command sends a request that invokes the GetString  action method, \nwhich returns a string.\nListing 20.11    Requesting a string response \nInvoke-WebRequest http://localhost:5000/api/content/string | select  \n‰@{n='Content-Type';e={ $_.Headers.""Content-Type"" }}, Content\nThis command sends a GET request to the /api/content/string  URL and processes \nthe response to display the Content-Type  header and the content from the response. \nThe command produces the following output, which shows the Content-Type  header \nfor the response:\nContent-Type              Content \n------------              ------- \ntext/plain; charset=utf-8 This is a string response\nNext, run the command shown in listing 20.12, which sends a request that will be han-\ndled by the GetObject  action method.\nListing 20.12    Requesting an object response \nInvoke-WebRequest http://localhost:5000/api/content/object  | select  \n‰@{n='Content-Type';e={ $_.Headers.""Content-Type"" }}, Content",4133
234-20.4.2 Understanding content negotiation.pdf,234-20.4.2 Understanding content negotiation,"542 chapter  20 Advanced web service features \nThis command produces the following output, formatted for clarity, that shows that \nthe response has been encoded as JSON:\nContent-Type                    Content \n------------                    ------- \napplication/json; charset=utf-8 {""productId"":1,""name"":""Kayak"",    \n    ""price"":275.00,""categoryId"":1,""supplierId"":1}\n20.4.2  Understanding content negotiation\nMost clients include an Accept  header in a request, which specifies the set of formats \nthat they are willing to receive in the response, expressed as a set of MIME types. Here \nis the Accept  header that Google Chrome sends in requests:  \nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif, \n    image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nThis header indicates that Chrome can handle the HTML and XHTML formats \n(XHTML is an XML-compliant dialect of HTML), XML, and the AVIF, WEBP, and \nAPNG formats. Chrome also supports the application/signed-exchange , which is \nthe data type used for signed exchanges, which allow the origin of content to be vali-\ndated regardless of how it has been delivered. \nThe q values in the header specify relative preference, where the value is 1.0 by \ndefault. Specifying a q value of 0.9 for application/xml  tells the server that Chrome \nwill accept XML data but prefers to deal with HTML or XHTML. The */* item tells the \nserver that Chrome will accept any format, but its q value specifies that it is the lowest \npreference of the specified types. Putting this together means that the Accept  header \nsent by Chrome provides the server with the following information:\n1 Chrome prefers to receive HTML or XHTML data and AVIF, WEBP, and APNG \nimages.\n2 If those formats are not available, then the next most preferred format is XML or \na signed exchange.\n3 If none of the preferred formats is available, then Chrome will accept any format.\nYou might assume from this that you can change the format produced by the ASP.NET \nCore application by setting the Accept  header, but it doesn’t work that way—or, rather, \nit doesn’t work that way just yet because there is some preparation required. \nTo see what happens when the Accept  header is changed, use a PowerShell prompt \nto run the command shown in listing 20.13, which sets the Accept  header to tell ASP.\nNET Core that the client is willing to receive only XML data.\nListing 20.13    Requesting XML data \nInvoke-WebRequest http://localhost:5000/api/content/object  \n‰-Headers @{Accept=""application/xml""}  | select @{n='Content-Type';e={  \n‰$_.Headers.""Content-Type"" }}, Content\nHere are the results, which show that the application has sent an application/json  \nresponse:\n 543 Understanding content formatting\nContent-Type                    Content \n------------                    ------- \napplication/json; charset=utf-8 {""productId"":1,""name"":""Kayak"", \n ""price"":275.00,""categoryId"":1,""supplierId"":1}\nIncluding the Accept  header has no effect on the format, even though the ASP.NET \nCore application sent the client a format that it hasn’t specified. The problem is that, \nby default, the MVC Framework is configured to only use JSON. Rather than return an \nerror, the MVC Framework sends JSON data in the hope that the client can process it, \neven though it was not one of the formats specified by the request Accept  header.\nenabling  xml formatting  \nFor content negotiation to work, the application must be configured so there is some \nchoice in the formats that can be used. Although JSON has become the default format \nfor web applications, the MVC Framework can also support encoding data as XML, as \nshown in listing 20.14. \nTIP    You can create your own content format by deriving from the Microsoft \n.AspNetCore.Mvc.Formatters.OutputFormatter  class. This is rarely used \nbecause creating a custom data format isn’t a useful way of exposing the data in \nyour application, and the most common formats—JSON and XML—are already \nimplemented.\nListing 20.14    Enabling XML formatting in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.RateLimiting;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers()\n    .AddNewtonsoftJson().AddXmlDataContractSerializerFormatters();\nbuilder.Services.AddRateLimiter(opts => {\n    opts.AddFixedWindowLimiter(""fixedWindow"", fixOpts => {\n        fixOpts.PermitLimit = 1;\n        fixOpts.QueueLimit = 0;\n        fixOpts.Window = TimeSpan.FromSeconds(15);\n    });\n});\nbuilder.Services.Configure<MvcNewtonsoftJsonOptions>(opts => {\n    opts.SerializerSettings.NullValueHandling\n        = Newtonsoft.Json.NullValueHandling.Ignore;\n});\n544 chapter  20 Advanced web service features \nvar app = builder.Build();\napp.UseRateLimiter();\napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe XML Serializer has some limitations, including the inability to deal with Entity \nFramework Core navigation properties because they are defined through an interface. \nTo create an object that can be serialized, listing 20.15 uses ProductBindingTarget  \ndefined in chapter 19.\nListing 20.15    Creating an object in the ContentController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""/api/[controller]"")]\n    public class ContentController : ControllerBase {\n        private DataContext context;\n        public ContentController(DataContext dataContext) {\n            context = dataContext;\n        }\n        [HttpGet(""string"")]\n        public string GetString() => ""This is a string response"";\n        [HttpGet(""object"")]\n        public async Task<ProductBindingTarget> GetObject() {\n            Product p = await context.Products.FirstAsync();\n            return new ProductBindingTarget() {\n                Name = p.Name, Price = p.Price, CategoryId = p.CategoryId,\n                SupplierId = p.SupplierId\n            };\n        }\n    }\n}\nWhen the MVC Framework had only the JSON format available, it had no choice but \nto encode responses as JSON. Now that there is a choice, you can see the content nego-\ntiation process working more fully. Restart ASP.NET Core MVC and run the command \nin listing 20.13 again to request XML data, and you will see the following output (from \nwhich I have omitted the namespace attributes for brevity):\n 545 Understanding content formatting\nContent-Type                   Content \n------------                   ------- \napplication/xml; charset=utf-8 <ProductBindingTarget> \n                                 <Name>Kayak</Name> \n                                 <Price>275.00</Price> \n                                 <CategoryId>1</CategoryId> \n                                 <SupplierId>1</SupplierId> \n                               </ProductBindingTarget>\nfully respecting  accept  headers\nThe MVC Framework will always use the JSON format if the Accept  header contains \n*/*, indicating any format, even if there are other supported formats with a higher \npreference. This is an odd feature that is intended to deal with requests from browsers \nconsistently, although it can be a source of confusion. Run the command shown in list-\ning 20.16 to send a request with an Accept  header that requests XML but will accept \nany other format if XML isn’t available.\nListing 20.16    Requesting an XML response with a fallback\nInvoke-WebRequest http://localhost:5000/api/content/object -Headers  \n‰@{Accept=""application/xml,*/*;q=0.8""}  | select @{n='Content-Type'; \n‰e={ $_.Headers.""Content-Type"" }}, Content\nEven though the Accept  header tells the MVC Framework that the client prefers XML, \nthe presence of the */* fallback means that a JSON response is sent. A related problem \nis that a JSON response will be sent when the client requests a format that the MVC \nFramework hasn’t been configured to produce, which you can see by running the com-\nmand shown in listing 20.17.\nListing 20.17    Requesting a PNG response \nInvoke-WebRequest http://localhost:5000/api/content/object -Headers  \n‰@{Accept=""img/png""}  | select @{n='Content-Type';e={ $_.Headers. \n‰""Content-Type"" }}, Content\nThe commands in listing 20.16 and listing 20.17 both produce this response:\nContent-Type                    Content \n------------                    -------\napplication/json; charset=utf-8 {""name"":""Kayak"",""price"":275.00, \n                                 ""categoryId"":1,""supplierId"":1}\nIn both cases, the MVC Framework returns JSON data, which may not be what the \nclient is expecting. Two configuration settings are used to tell the MVC Framework to \nrespect the Accept  setting sent by the client and not send JSON data by default. To \nchange the configuration, add the statements shown in listing 20.18 to the Program \n.cs file. \nListing 20.18    Configuring negotiation in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\n546 chapter  20 Advanced web service features \nusing Microsoft.AspNetCore.RateLimiting;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers()\n    .AddNewtonsoftJson().AddXmlDataContractSerializerFormatters();\nbuilder.Services.AddRateLimiter(opts => {\n    opts.AddFixedWindowLimiter(""fixedWindow"", fixOpts => {\n        fixOpts.PermitLimit = 1;\n        fixOpts.QueueLimit = 0;\n        fixOpts.Window = TimeSpan.FromSeconds(15);\n    });\n});\nbuilder.Services.Configure<MvcNewtonsoftJsonOptions>(opts => {\n    opts.SerializerSettings.NullValueHandling\n        = Newtonsoft.Json.NullValueHandling.Ignore;\n});\nbuilder.Services.Configure<MvcOptions>(opts => {\n    opts.RespectBrowserAcceptHeader = true;\n    opts.ReturnHttpNotAcceptable = true;\n});\nvar app = builder.Build();\napp.UseRateLimiter();\napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe options pattern is used to set the properties of an MvcOptions  object. Setting \nRespectBrowserAcceptHeader  to true  disables the fallback to JSON when the \nAccept  header contains */*. Setting ReturnHttpNotAcceptable  to true  disables the \nfallback to JSON when the client requests an unsupported data format.\nRestart ASP.NET Core and repeat the command from listing 20.16. Instead of a JSON \nresponse, the format preferences specified by the Accept  header will be respected, and \nan XML response will be sent. Repeat the command from listing 20.17, and you will \nreceive a response with the 406 status code.",11478
235-20.4.5 Restricting the formats received by an action method.pdf,235-20.4.5 Restricting the formats received by an action method,"547 Understanding content formatting\n...\nInvoke-WebRequest : The remote server returned an error:  \n    (406) Not Acceptable.\n...\nSending a 406 code indicates there is no overlap between the formats the client can \nhandle and the formats that the MVC Framework can produce, ensuring that the cli-\nent doesn’t receive a data format it cannot process.\n20.4.3  Specifying an action result format\nThe data formats that the MVC Framework can use for an action method result can be \nconstrained using the Produces  attribute, as shown in listing 20.19.\nTIP    The Produces  attribute is an example of a filter, which allows attributes to \nalter requests and responses. See chapter 30 for more details.\nListing 20.19    Data formats in the ContentController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""/api/[controller]"")]\n    public class ContentController : ControllerBase {\n        private DataContext context;\n        public ContentController(DataContext dataContext) {\n            context = dataContext;\n        }\n        [HttpGet(""string"")]\n        public string GetString() => ""This is a string response"";\n        [HttpGet(""object"")]\n        [Produces(""application/json"")]\n        public async Task<ProductBindingTarget> GetObject() {\n            Product p = await context.Products.FirstAsync();\n            return new ProductBindingTarget() {\n                Name = p.Name, Price = p.Price, CategoryId = p.CategoryId,\n                SupplierId = p.SupplierId\n            };\n        }\n    }\n}\nThe argument for the attribute specifies the format that will be used for the result from \nthe action, and more than one type can be specified. The Produces  attribute restricts \nthe types that the MVC Framework will consider when processing an Accept  header. \nTo see the effect of the Produces  attribute, use a PowerShell prompt to run the com-\nmand shown in listing 20.20.\n548 chapter  20 Advanced web service features \nListing 20.20    Requesting data \nInvoke-WebRequest http://localhost:5000/api/content/object -Headers  \n‰@{Accept=""application/xml,application/json;q=0.8""}  | select  \n‰@{n='Content-Type';e={ $_.Headers.""Content-Type"" }}, Content\nThe Accept  header tells the MVC Framework that the client prefers XML data but will \naccept JSON. The Produces  attribute means that XML data isn’t available as the data \nformat for the GetObject  action method and so the JSON serializer is selected, which \nproduces the following response:\nContent-Type                    Content \n------------                    ------- \napplication/json; charset=utf-8 {""name"":""Kayak"",""price"":275.00, \n                                 ""categoryId"":1,""supplierId"":1}\n20.4.4  Requesting a format in the URL \nThe Accept  header isn’t always under the control of the programmer who is writing \nthe client. In such situations, it can be helpful to allow the data format for the response \nto be requested using the URL. This feature is enabled by decorating an action method \nwith the FormatFilter  attribute and ensuring there is a format  segment variable in \nthe action method’s route, as shown in listing 20.21.  \nListing 20.21    Formatting in the ContentController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""/api/[controller]"")]\n    public class ContentController : ControllerBase {\n        private DataContext context;\n        public ContentController(DataContext dataContext) {\n            context = dataContext;\n        }\n        [HttpGet(""string"")]\n        public string GetString() => ""This is a string response"";\n        [HttpGet(""object/{format?}"")]\n        [FormatFilter]\n        [Produces(""application/json"", ""application/xml"")]\n        public async Task<ProductBindingTarget> GetObject() {\n            Product p = await context.Products.FirstAsync();\n            return new ProductBindingTarget() {\n                Name = p.Name, Price = p.Price, CategoryId = p.CategoryId,\n                SupplierId = p.SupplierId\n            };\n        }\n    }\n}\n 549 Understanding content formatting\nThe FormatFilter  attribute is an example of a filter, which is an attribute that can \nmodify requests and responses, as described in chapter 30. This filter gets the value of \nthe format  segment variable from the route that matched the request and uses it to \noverride the Accept  header sent by the client. I have also expanded the range of types \nspecified by the Produces  attribute so that the action method can return both JSON \nand XML responses. \nEach data format supported by the application has a shorthand: xml for XML data, \nand json  for JSON data. When the action method is targeted by a URL that contains \none of these shorthand names, the Accept  header is ignored, and the specified format \nis used. To see the effect, restart ASP.NET Core and use the browser to request http://\nlocalhost:5000/api/content/object/json and http://localhost:5000/api/content/\nobject/xml, which produce the responses shown in figure 20.6.\nFigure 20.6    Requesting data formats in the URL\n20.4.5  Restricting the formats received by an action method\nMost content formatting decisions focus on the data formats the ASP.NET Core appli-\ncation sends to the client, but the same serializers that deal with results are used to \ndeserialize the data sent by clients in request bodies. The deserialization process hap-\npens automatically, and most applications will be happy to accept data in all the for-\nmats they are configured to send. The example application is configured to send JSON \nand XML data, which means that clients can send JSON and XML data in requests.\nThe Consumes  attribute can be applied to action methods to restrict the data types it \nwill handle, as shown in listing 20.22.  \nListing 20.22    Adding actions in the ContentController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""/api/[controller]"")]\n    public class ContentController : ControllerBase {\n        private DataContext context;\n550 chapter  20 Advanced web service features \n        public ContentController(DataContext dataContext) {\n            context = dataContext;\n        }\n        [HttpGet(""string"")]\n        public string GetString() => ""This is a string response"";\n        [HttpGet(""object/{format?}"")]\n        [FormatFilter]\n        [Produces(""application/json"", ""application/xml"")]\n        public async Task<ProductBindingTarget> GetObject() {\n            Product p = await context.Products.FirstAsync();\n            return new ProductBindingTarget() {\n                Name = p.Name, Price = p.Price, CategoryId = p.CategoryId,\n                SupplierId = p.SupplierId\n            };\n        }\n        [HttpPost]\n        [Consumes(""application/json"")]\n        public string SaveProductJson(ProductBindingTarget product) {\n            return $""JSON: {product.Name}"";\n        }\n        [HttpPost]\n        [Consumes(""application/xml"")]\n        public string SaveProductXml(ProductBindingTarget product) {\n            return $""XML: {product.Name}"";\n        }\n    }\n}\nThe new action methods are decorated with the Consumes  attribute, restricting the \ndata types that each can handle. The combination of attributes means that HTTP \nPOST attributes whose Content-Type  header is application/json  will be handled \nby the SaveProductJson  action method. HTTP POST requests whose Content-Type  \nheader is application/xml  will be handled by the SaveProductXml  action method. \nRestart ASP.NET Core and use a PowerShell command prompt to run the command \nshown in listing 20.23 to send JSON data to the example application.\nListing 20.23    Sending JSON data \nInvoke-RestMethod http://localhost:5000/api/content -Method POST -Body   \n‰(@{ Name=""Swimming Goggles""; Price=12.75; CategoryId=1; SupplierId=1} |  \n‰ConvertTo-Json) -ContentType ""application/json""\nThe request is automatically routed to the correct action method, which produces the \nfollowing response:\nJSON: Swimming Goggles\nRun the command shown in listing 20.24 to send XML data to the example application.",8524
236-20.4.6 Caching output.pdf,236-20.4.6 Caching output,"551 Understanding content formatting\nListing 20.24    Sending XML data \nInvoke-RestMethod http://localhost:5000/api/content -Method POST -Body  \n‰""<ProductBindingTarget xmlns=`""http://schemas.datacontract.org/2004/07/ \n‰WebApp.Models`""> <CategoryId>1</CategoryId><Name>Kayak</Name><Price> \n‰275.00</Price> <SupplierId>1</SupplierId></ProductBindingTarget>"" \n‰ -ContentType ""application/xml""\nThe request is routed to the SaveProductXml  action method and produces the follow-\ning response:\nXML: Kayak\nThe MVC Framework will send a 415 - Unsupported Media Type  response if a \nrequest is sent with a Content-Type  header that doesn’t match the data types that the \napplication supports.\n20.4.6  Caching output \nIn chapter 7, I demonstrated the output caching middleware, which allows caching \npolicies to be defined and applied to endpoints. This feature can be extended to con-\ntrollers using attributes, allowing fine-grained control over how responses from con-\ntrollers are cached. To prepare, listing 20.25 configures the example application to set \nup a caching policy.\nListing 20.25    Configuring caching in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.RateLimiting;\nvar builder = WebApplication.CreateBuilder(args);\n// ...statements omitted for brevity...\nbuilder.Services.Configure<MvcOptions>(opts => {\n    opts.RespectBrowserAcceptHeader = true;\n    opts.ReturnHttpNotAcceptable = true;\n});\nbuilder.Services.AddOutputCache(opts => {\n    opts.AddPolicy(""30sec"", policy => {\n        policy.Cache();\n        policy.Expire(TimeSpan.FromSeconds(30));\n    });\n});\nvar app = builder.Build();\napp.UseRateLimiter();\napp.UseOutputCache();\napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\n552 chapter  20 Advanced web service features \nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThis configuration creates an output caching policy named 30sec , which caches con-\ntent for 30 seconds. The caching policy is applied to the controller using the Output-\nCache  attribute, as shown in listing 20.26.\nListing 20.26    Caching in the ContentController.cs file in the WebApp/Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.OutputCaching;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""/api/[controller]"")]\n    public class ContentController : ControllerBase {\n        private DataContext context;\n        public ContentController(DataContext dataContext) {\n            context = dataContext;\n        }\n        [HttpGet(""string"")]\n        [OutputCache(PolicyName = ""30sec"")]\n        [Produces(""application/json"")]\n        public string GetString() => \n            $""{DateTime.Now.ToLongTimeString()} String response"";\n        \n        // ...other actions omitted for brevity...\n    }\n}\nThe OutputCache  attribute can be applied to the entire controller, which causes the \nresponses for all action methods, or applied to individual actions. The attribute accepts \na policy name as an argument or can be used to create a custom policy. The attribute \nin listing 20.26 has been applied a single action and applies the policy created in listing \n20.25. (I added the Produces  attribute to force a JSON response, which is not required \nfor caching but makes the response easier to see in the browser window).\nRestart ASP.NET Core and use a browser to request http://localhost:5000/api/  \ncontent/string. Reload the browser and you will see the same time displayed, illustrat-\ning that output is cached for 30 seconds, as shown in figure 20.7.",3834
237-20.5 Documenting and exploring web services.pdf,237-20.5 Documenting and exploring web services,,0
238-20.5.2 Installing and configuring the Swashbuckle package.pdf,238-20.5.2 Installing and configuring the Swashbuckle package,"553 Documenting and exploring web services\nFigure 20.7    Cached output from a controller action\n20.5 Documenting and exploring web services\nWhen you are responsible for developing both the web service and its client, the pur-\npose of each action and its results are obvious and are usually written at the same time. \nIf you are responsible for a web service that is consumed by third-party developers, then \nyou may need to provide documentation that describes how the web service works. The \nOpenAPI specification, which is also known as Swagger, describes web services in a way \nthat can be understood by other programmers and consumed programmatically. In \nthis section, I demonstrate how to use OpenAPI to describe a web service and show you \nhow to fine-tune that description.  \n20.5.1  Resolving action conflicts \nThe OpenAPI discovery process requires a unique combination of the HTTP method \nand URL pattern for each action method. The process doesn’t support the Consumes  \nattribute, so a change is required to the ContentController  to remove the separate \nactions for receiving XML and JSON data, as shown in listing 20.27.  \nListing 20.27    Removing actions in the ContentController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.OutputCaching;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""/api/[controller]"")]\n    public class ContentController : ControllerBase {\n        private DataContext context;\n        // ...methods omitted for brevity...\n        [HttpPost]\n        [Consumes(""application/json"")]\n        public string SaveProductJson(ProductBindingTarget product) {\n            return $""JSON: {product.Name}"";\n        }\n554 chapter  20 Advanced web service features \n        //[HttpPost]\n        //[Consumes(""application/xml"")]\n        //public string SaveProductXml(ProductBindingTarget product) {\n        //    return $""XML: {product.Name}"";\n        //}        \n    }\n}\nCommenting out one of the action methods ensures that each remaining action has a \nunique combination of HTTP method and URL.\n20.5.2  Installing and configuring the Swashbuckle package \nThe Swashbuckle package is the most popular ASP.NET Core implementation of the \nOpenAPI specification and will automatically generate a description for the web ser-\nvices in an ASP.NET Core application. The package also includes tools that consume \nthat description to allow the web service to be inspected and tested.\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the commands shown in listing 20.28 to install the NuGet \npackage. \nListing 20.28    Adding a package to the project \ndotnet add package Swashbuckle.AspNetCore --version 6.4.0\nAdd the statements shown in listing 20.29 to the Program.cs  file to add the services \nand middleware provided by the Swashbuckle package.\nListing 20.29    Configuring Swashbuckle in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.RateLimiting;\nusing Microsoft.OpenApi.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers()\n    .AddNewtonsoftJson().AddXmlDataContractSerializerFormatters();\nbuilder.Services.AddRateLimiter(opts => {\n    opts.AddFixedWindowLimiter(""fixedWindow"", fixOpts => {\n        fixOpts.PermitLimit = 1;\n        fixOpts.QueueLimit = 0;\n        fixOpts.Window = TimeSpan.FromSeconds(15);\n    });\n});\n 555 Documenting and exploring web services\nbuilder.Services.Configure<MvcNewtonsoftJsonOptions>(opts => {\n    opts.SerializerSettings.NullValueHandling\n        = Newtonsoft.Json.NullValueHandling.Ignore;\n});\nbuilder.Services.Configure<MvcOptions>(opts => {\n    opts.RespectBrowserAcceptHeader = true;\n    opts.ReturnHttpNotAcceptable = true;\n});\nbuilder.Services.AddOutputCache(opts => {\n    opts.AddPolicy(""30sec"", policy => {\n        policy.Cache();\n        policy.Expire(TimeSpan.FromSeconds(30));\n    });\n});\nbuilder.Services.AddSwaggerGen(c => {\n    c.SwaggerDoc(""v1"", new OpenApiInfo { \n        Title = ""WebApp"", Version = ""v1"" \n    });\n});\nvar app = builder.Build();\napp.UseRateLimiter();\napp.UseOutputCache();\napp.MapControllers();\napp.MapGet(""/"", () => ""Hello World!"");\napp.UseSwagger();\napp.UseSwaggerUI(options => {\n    options.SwaggerEndpoint(""/swagger/v1/swagger.json"", ""WebApp"");\n});\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run(); \nThere are two features set up by the statements in listing 20.29. The feature generates \nan OpenAPI description of the web services that the application contains. You can see \nthe description by restarting ASP.NET Core and using the browser to request the URL \nhttp://localhost:5000/swagger/v1/swagger.json, which produces the response shown \nin figure 20.8. The OpenAPI format is verbose, but you can see each URL that the web \nservice controllers support, along with details of the data each expects to receive and \nthe range of responses that it will generate.",5488
239-20.5.3 Fine-Tuning the API description.pdf,239-20.5.3 Fine-Tuning the API description,"556 chapter  20 Advanced web service features \nFigure 20.8    The OpenAPI description of the web service\nThe second feature is a UI that consumes the OpenAPI description of the web service \nand presents the information in a more easily understood way, along with support for \ntesting each action. Use the browser to request http://localhost:5000/swagger, and \nyou will see the interface shown in figure 20.9. You can expand each action to see \ndetails, including the data that is expected in the request and the different responses \nthat the client can expect.\nFigure 20.9    \nThe OpenAPI \nexplorer \ninterface\n20.5.3  Fine-Tuning the API description\nRelying on the API discovery process can produce a result that doesn’t truly capture \nthe web service. You can see this by examining the entry in the Products section that \ndescribes GET requests matched by the /api/Products/{id} URL pattern. Expand \n 557 Documenting and exploring web services\nthis item and examine the response section, and you will see there is only one status \ncode response that will be returned, as shown in figure 20.10.\nFigure 20.10    The data formats listed in the OpenAPI web service description \nThe API discovery process makes assumptions about the responses produced by an \naction method and doesn’t always reflect what can really happen. In this case, the \nGetProduct  action method in the ProductsController  class can return another \nresponse that the discovery process hasn’t detected.\n...\n[HttpGet(""{id}"")]\n[DisableRateLimiting]\npublic async Task<IActionResult> GetProduct(long id) {\n    Product? p = await context.Products.FindAsync(id);\n    if (p == null) {\n        return NotFound();\n    }\n    return Ok(p);\n}\n...\nIf a third-party developer attempts to implement a client for the web service using the \nOpenAPI data, they won’t be expecting the 404 - Not Found response that the action \nsends when it can’t find an object in the database.  \nrunning  the api analyzer  \nASP.NET Core includes an analyzer that inspects web service controllers and highlights \nproblems like the one described in the previous section. To enable the analyzer, add \nthe elements shown in listing 20.30 to the WebApp.csproj  file. (If you are using Visual \nStudio, right-click the WebApp project item in the Solution Explorer and select Edit \nProject File from the pop-up menu.)\nListing 20.30    Enabling the analyzer in the WebApp.csproj file in the WebApp folder\n<Project Sdk=""Microsoft.NET.Sdk.Web"">\n  <PropertyGroup>\n    <TargetFramework>net7.0</TargetFramework>\n558 chapter  20 Advanced web service features \n    <Nullable>enable</Nullable>\n    <ImplicitUsings>enable</ImplicitUsings>\n  </PropertyGroup>\n  <ItemGroup>\n    <PackageReference Include=""Microsoft.AspNetCore.Mvc.NewtonsoftJson"" \n       Version=""7.0.0"" />\n    <PackageReference Include=""Microsoft.EntityFrameworkCore.Design"" \n       Version=""7.0.0"">\n      <IncludeAssets>\n    runtime; build; native; contentfiles; analyzers; \n    buildtransitive\n   </IncludeAssets>\n      <PrivateAssets>all</PrivateAssets>\n    </PackageReference>\n    <PackageReference Include=""Microsoft.EntityFrameworkCore.SqlServer"" \n       Version=""7.0.0"" />\n    <PackageReference Include=""Swashbuckle.AspNetCore"" Version=""6.4.0"" />\n  </ItemGroup>\n  <PropertyGroup>\n    <IncludeOpenAPIAnalyzers>true</IncludeOpenAPIAnalyzers>\n  </PropertyGroup>\n</Project>\nIf you are using Visual Studio, you will see any problems detected by the API analyzer \nshown in the controller class file, as shown in figure 20.11. \nFigure 20.11    A problem detected by the API analyzer \nIf you are using Visual Studio Code, you will see warning messages when the project is \ncompiled, either using the dotnet build  command or when it is executed using the \ndotnet run  command. When the project is compiled, you will see this message that \ndescribes the issue in the ProductController  class:\nControllers\ProductsController.cs(27,24): warning API1000:  \n    Action method returns undeclared status code '404'.  \n[C:\WebApp\WebApp.csproj] \n    1 Warning(s) \n    0 Error(s)\n 559 Documenting and exploring web services\ndeclaring  the action  method  result  type \nTo fix the problem detected by the analyzer, the ProducesResponseType  attribute can \nbe used to declare each of the response types that the action method can produce, as \nshown in listing 20.31.  \nListing 20.31    Declaring results in the ProductsController.cs file in the Controllers \nfolder\n...\n[HttpGet(""{id}"")]\n[DisableRateLimiting]\n[ProducesResponseType(StatusCodes.Status200OK)]\n[ProducesResponseType(StatusCodes.Status404NotFound)]\npublic async Task<IActionResult> GetProduct(long id) {\n    Product? p = await context.Products.FindAsync(id);\n    if (p == null) {\n        return NotFound();\n    }\n    return Ok(p);\n}\n...\nRestart ASP.NET Core and use a browser to request http://localhost:5000/swagger, \nand you will see the description for the action method has been updated to reflect the \n404 response, as shown in figure 20.12.\nFigure 20.12    Reflecting all the status codes produced by an action method",5160
240-21.1.1 Dropping the database.pdf,240-21.1.1 Dropping the database,"560 chapter  20 Advanced web service features \nSummary\n¡ The Entity Framework Core-related data feature can cause serialization prob-\nlems when used in web service results.\n¡ Cycles in object data must be broken before serialization.\n¡ The PATCH method is used to specify fine-grained changes to data and is sup-\nported by ASP.NET Core.\n¡ ASP.NET Core uses JSON to serialize data by default but supports a content nego-\ntiation process that allows clients to specify the formats they can accept.\n¡ The output from web services can be cached, using the caching middleware that \ncan be applied to any endpoint.\n¡ Documentation for a web service can be generated using the OpenAPI \nspecification.\n56121Using controllers  \nwith views, part I\nThis chapter covers\n¡ Using controllers with views to  \n programmatically generate HTML content\n¡ Using the Razor view syntax to mix code and  \n markup\n¡ Selecting a view in an action method\n¡ Using view models to pass data from an action  \n to a view\nIn this chapter, I introduce the Razor view engine , which is responsible for generating \nHTML responses that can be displayed directly to the user (as opposed to the JSON \nand XML responses, which are typically consumed by other applications). Views  are \nfiles that contain C# expressions and HTML fragments that are processed by the \nview engine to generate HTML responses. I show how views work, explain how they \nare used in action methods, and describe the different types of C# expressions they \ncontain. In chapter 22, I describe some of the other features that views support. \nTable 21.1 puts Razor views in context.  \n562 chapter  21 Using controllers with views, part I \nTable 21.1    Putting Razor Views in context\nQuestion Answer\nWhat are they? Views are files that contain a mix of static HTML content \nand C# expressions.\nWhy are they useful? Views are used to create HTML responses for HTTP \nrequests. The C# expressions are evaluated and com -\nbined with the HTML content to create a response.\nHow are they used? The View  method defined by the Controller  class \ncreates an action response that uses a view. \nAre there any pitfalls or \nlimitations?It can take a little time to get used to the syntax of view \nfiles and the way they combine code and content.\nAre there any \nalternatives?There are third-party view engines that can be used in \nASP.NET Core MVC, but their use is limited. \nTable 21.2 provides a guide to the chapter\nTable 21.2    Chapter guide\nProblem Solution Listing\nEnabling views Use the AddControllersWithViews  \nand MapControllerRoute  methods to \nset up the required services and endpoints.4, 6\nReturning an HTML response \nfrom a controller action \nmethodUse the View  method to create a \nViewResult .5\nCreating dynamic HTML \ncontentCreate a Razor View that uses expressions \nfor dynamic content.7, 8, \n19, 20\nSelecting a view by name Provide the view name as an argument to the \nView  method.9, 10\nCreating a view that can be \nused by multiple controllersCreate a shared view. 11–13\nSpecifying a model type for \na viewUse an @model  expression. 14–18\nAllow for null view model \nvaluesUse a nullable type in the @model  \nexpression19–21\nGenerating content \nselectivelyUse @if, @switch , or @foreach  \nexpressions.22–28\nIncluding C# code in a view Use a code block. 29\n21.1 Preparing for this chapter\nThis chapter uses the WebApp  project from chapter 20. To prepare for this chapter, \nreplace the contents of the Program.cs  file with the statements shown in listing 21.1, \nwhich removes some of the services and middleware used in earlier chapters.",3655
241-21.2 Getting started with views.pdf,241-21.2 Getting started with views,"563 Preparing for this chapter\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 21.1    Replacing the contents of the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllers();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\n21.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 21.2 to drop the database.\nListing 21.2    Dropping the database\ndotnet ef database drop --force\n21.1.2  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 21.3. \nListing 21.3    Running the example application \ndotnet watch\nThe database will be seeded as part of the application startup. Once ASP.NET Core is \nrunning, use a web browser to request http://localhost:5000/api/products, which will \nproduce the response shown in figure 21.1.",1598
242-21.2.2 Creating an HTML controller.pdf,242-21.2.2 Creating an HTML controller,"564 chapter  21 Using controllers with views, part I \nFigure 21.1    Running the example application \nThis chapter uses dotnet watch , rather than the dotnet run  command used in ear-\nlier chapters. The dotnet watch  command is useful when working with views because \nchanges are pushed to the browser automatically. At some point, however, you will \nmake a change that cannot be processed by the dotnet watch  command, and you will \nsee a message like this at the command prompt:\nwatch : Unable to apply hot reload because of a rude edit. \nwatch : Do you want to restart your app - Yes (y) / No (n) /  \n    Always (a) / Never (v)?\nThe point at which this arises depends on the editor you have chosen, but when this \nhappens, select the Always  option so that the application will always be restarted when \na reload cannot be performed.\n21.2 Getting started with views\nI started this chapter with a web service controller to demonstrate the similarity with a \ncontroller that uses views. It is easy to think about web service and view controllers as \nbeing separate, but it is important to understand that the same underlying features are \nused for both types of response. In the sections that follow, I configure the application \nto support HTML applications and repurpose the Home  controller so that it produces \nan HTML response.\n21.2.1  Configuring the application \nThe first step is to configure ASP.NET Core to enable HTML responses, as shown in \nlisting 21.4. \nListing 21.4    Changing the configuration in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n 565 Getting started with views\n});\nbuilder.Services.AddControllersWithViews();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""Default"",\n    ""{controller=Home}/{action=Index}/{id?}"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nHTML responses are created using views, which are files containing a mix of HTML \nelements and C# expressions. The AddControllers  method I used in chapter 19 to \nenable the MVC Framework only supports web service controllers. To enable support \nfor views, the AddControllersWithViews  method is used. \nThe second change is the addition of the MapControllerRoute  method in the end-\npoint routing configuration. Controllers that generate HTML responses don’t use the \nsame routing attributes that are applied to web service controllers and rely on a feature \nnamed convention routing, which I describe in the next section.  \n21.2.2  Creating an HTML controller \nControllers for HTML applications are similar to those used for web services but with \nsome important differences. To create an HTML controller, add a class file named \nHomeController.cs  to the Controllers  folder with the statements shown in listing \n21.5.\nListing 21.5    The contents of the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            return View(await context.Products.FindAsync(id));\n        }\n    }\n}\n566 chapter  21 Using controllers with views, part I \nThe base class for HTML controllers is Controller , which is derived from the  \nControllerBase  class used for web service controllers and provides additional meth-\nods that are specific to working with views.\n...\npublic class HomeController: Controller  {\n...\nAction methods in HTML controllers return objects that implement the IAction-\nResult  interface, which is the same result type used in chapter 19 to return specific \nstatus code responses. The Controller  base class provides the View  method, which is \nused to select a view that will be used to create a response.\n...\nreturn View(await context.Products.FindAsync(id));\n...\nTIP    Notice that the controller in listing 21.5 hasn’t been decorated with attri-\nbutes. The ApiController  attribute is applied only to web service controllers \nand should not be used for HTML controllers. The Route  and HTTP method \nattributes are not required because HTML controllers rely on convention-based \nrouting, which was configured in listing 21.4 and which is introduced shortly.\nThe View  method creates an instance of the ViewResult  class, which implements the \nIActionResult  interface and tells the MVC Framework that a view should be used to \nproduce the response for the client. The argument to the View  method is called the \nview model  and provides the view with the data it needs to generate a response.\nThere are no views for the MVC Framework to use at the moment, but if you restart \nASP.NET Core and use a browser to request http://localhost:5000, you will see an error \nmessage that shows how the MVC Framework responds to the ViewResult  it received \nfrom the Index  action method, as shown in figure 21.2.\nFigure 21.2    Using a view result \nBehind the scenes, there are two important conventions at work, which are described \nin the following sections.\n 567 Getting started with views\nNOTE    Two features can expand the range of search locations. The search will \ninclude the /Pages/Shared  folder if the project uses Razor Pages, as explained in \nchapter 23.\nunderstanding  convention  routing\nHTML controllers rely on convention routing  instead of the Route  attribute. The conven-\ntion in this term refers to the use of the controller class name and the action method \nname used to configure the routing system, which was done in listing 21.5 by adding \nthis statement to the endpoint routing configuration:\n...\napp.MapControllerRoute(""Default"",  \n    ""{controller=Home}/{action=Index}/{id?}"");\n...\nThe route that this statement sets up matches two- and three-segment URLs. The value \nof the first segment is used as the name of the controller class, without the Control-\nler suffix, so that Home  refers to the HomeController  class. The second segment is \nthe name of the action method, and the optional third segment allows action methods \nto receive a parameter named id. Default values are used to select the Index  action \nmethod on the Home  controller for URLs that do not contain all the segments. This is \nsuch a common convention that the same routing configuration can be set up without \nhaving to specify the URL pattern, as shown in listing 21.6.  \nListing 21.6    The default routing convention in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nvar app = builder.Build();\napp.UseStaticFiles(); \napp.MapControllers();\napp.MapDefaultControllerRoute();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe MapDefaultControllerRoute  method avoids the risk of mistyping the URL pat-\ntern and sets up the convention-based routing. I have configured one route in this",7804
243-21.2.3 Creating a Razor View.pdf,243-21.2.3 Creating a Razor View,"568 chapter  21 Using controllers with views, part I \nchapter, but an application can define as many routes as it needs, and later chapters \nexpand the routing configuration to make examples easier to follow.\nTIP    The MVC Framework assumes that any public  method defined by \nan HTML controller is an action method and that action methods support  \nall HTTP methods. If you need to define a method in a controller that is not an \naction, you can make it private  or, if that is not possible, decorate the method \nwith the NonAction  attribute. You can restrict an action method to support spe-\ncific HTTP methods by applying attributes so that the HttpGet  attribute denotes \nan action that handles GET requests, the HttpPost  method denotes an action \nthat handles POST requests, and so on.\nunderstanding  the razor view convention\nWhen the Index  action method defined by the Home  controller is invoked, it uses the \nvalue of the id parameter to retrieve an object from the database and passes it to the \nView  method.\n...\npublic async Task<IActionResult> Index(long id = 1) {\n    return View(await context.Products.FindAsync(id));\n}\n...\nWhen an action method invokes the View  method, it creates a ViewResult  that tells \nthe MVC Framework to use the default convention to locate a view. The Razor view \nengine looks for a view with the same name as the action method, with the addition of \nthe cshtml  file extension, which is the file type used by the Razor view engine. Views \nare stored in the Views  folder, grouped by the controller they are associated with. The \nfirst location searched is the Views/Home  folder, since the action method is defined \nby the Home  controller (the name of which is taken by dropping Controller  from the \nname of the controller class). If the Index.cshtml  file cannot be found in the Views/\nHome  folder, then the Views/Shared  folder is checked, which is the location where \nviews that are shared between controllers are stored.\nWhile most controllers have their own views, views can also be shared so that com-\nmon functionality doesn’t have to be duplicated, as demonstrated in the “Using Shared \nViews” section.\nThe exception response in figure 21.2 shows the result of both conventions. The \nrouting conventions are used to process the request using the Index  action method \ndefined by the Home  controller, which tells the Razor view engine to use the view search \nconvention to locate a view. The view engine uses the name of the action method and \ncontroller to build its search pattern and checks for the Views/Home/Index.cshtml  \nand Views/Shared/Index.cshtml  files.\n21.2.3  Creating a Razor View\nTo provide the MVC Framework with a view to display, create the Views/Home  folder \nand add to it a file named Index.cshtml  with the content shown in listing 21.7. If you \n 569 Getting started with views\nare using Visual Studio, create the view by right-clicking the Views/Home  folder, select-\ning Add > New Item from the pop-up menu, and selecting the Razor View - Empty item \nin the ASP.NET Core > Web category, as shown in figure 21.3.  \nFigure 21.3    Creating a view using Visual Studio \nTIP    There is a menu item for creating views in the Add popup menu, but this \nrelies on the Visual Studio scaffolding feature, which adds template content to \ncreate different types of view. I don’t rely on the scaffolding in this book and \ninstead show you how to create views from scratch.\nListing 21.7    The contents of the Index.cshtml file in the Views/Home folder \n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        Product Table\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\n570 chapter  21 Using controllers with views, part I \nThe view file contains standard HTML elements that are styled using the Bootstrap \nCSS framework, which is applied through the class  attribute. The key view feature is \nthe ability to generate content using C# expressions, like this:  \n...\n<tr><th>Name</th><td> @Model.Name </td></tr>\n<tr><th>Price</th><td> @Model.Price.ToString(""c"") </td></tr>\n...\nI explain how these expressions work in the “Understanding the Razor Syntax” section, \nbut for now, it is enough to know that these expressions insert the value of the Name  \nand Price  properties from the Product  view model passed to the View  method by \nthe action method in listing 21.5. Restart ASP.NET Core and use a browser to request \nhttp://localhost:5000, and you will see the HTML response shown in figure 21.4. \nFigure 21.4     \nA view response\nmodifying  a razor view \nThe dotnet watch  command detects and recompiles Razor Views automatically, \nmeaning that the ASP.NET Core runtime doesn’t have to be restarted when views are \nedited. To demonstrate the recompilation process, listing 21.8 adds new elements to \nthe Index  view.  \nListing 21.8    Adding Elements in the Index.cshtml File in the Views/Home Folder\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        Product Table\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model.CategoryId</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>",6100
244-21.2.4 Selecting a View by name.pdf,244-21.2.4 Selecting a View by name,"571 Getting started with views\nSave the changes to the view; the change will be detected, and the browser will be auto-\nmatically reloaded to display the change, as shown in figure 21.5.\nFigure 21.5    \nModifying a \nRazor View\n21.2.4  Selecting a View by name\nThe action method in listing 21.5 relies entirely on convention, leaving Razor to select \nthe view that is used to generate the response. Action methods can select a view by pro-\nviding a name as an argument to the View  method, as shown in listing 21.9.  \nListing 21.9    Selecting a view in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            Product? prod = await context.Products.FindAsync(id);\n            if (prod?.CategoryId == 1) {\n                return View(""Watersports"", prod);\n            } else {\n                return View(prod);\n            }\n        }\n    }\n}\nThe action method selects the view based on the CategoryId  property of the Product  \nobject that is retrieved from the database. If the CategoryId  is 1, the action method \ninvokes the View  method with an additional argument that selects a view named \nWatersports .\n...\nreturn View( ""Watersports"" , prod);\n...\n572 chapter  21 Using controllers with views, part I \n Notice that the action method doesn’t specify the file extension or the location for the \nview. It is the job of the view engine to translate Watersports  into a view file. \nIf you save the HomeController.cs  file, dotnet watch  will detect the change and \nreload the browser, which will cause an error because the view file doesn’t exist. To \ncreate the view, add a Razor View file named Watersports.cshtml  to the Views/Home  \nfolder with the content shown in listing 21.10.\nListing 21.10    The contents of the Watersports.cshtml file in the Views/Home folder\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model.CategoryId</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe new view follows the same pattern as the Index  view but has a different title above \nthe table. Save the change and request http://localhost:5000/home/index/1 and \nhttp://localhost:5000/home/index/4. The action method selects the Watersports  \nview for the first URL and the default view for the second URL, producing the two \nresponses shown in figure 21.6.\nFigure 21.6    Selecting views\n 573 Getting started with views\nusing shared  views\nWhen the Razor view engine locates a view, it looks in the Views/[controller]  folder \nand then the Views/Shared  folder. This search pattern means that views that contain \ncommon content can be shared between controllers, avoiding duplication. To see how \nthis process works, add a Razor View file named Common.cshtml  to the Views/Shared  \nfolder with the content shown in listing 21.11.  \nListing 21.11    The contents of the Common.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Shared View\n    </h6>\n</body>\n</html>\nNext, add an action method to the Home  controller that uses the new view, as shown in \nlisting 21.12.\nListing 21.12    Adding an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            Product? prod = await context.Products.FindAsync(id);\n            if (prod?.CategoryId == 1) {\n                return View(""Watersports"", prod);\n            } else {\n                return View(prod);\n            }\n        }\n        public IActionResult Common() {\n            return View();\n        }\n    }\n}\nThe new action relies on the convention of using the method name as the name of \nthe view. When a view doesn’t require any data to display to the user, the View  method \n574 chapter  21 Using controllers with views, part I \ncan be called without arguments. Next, create a new controller by adding a class file \nnamed SecondController.cs  to the Controllers  folder, with the code shown in \nlisting 21.13.\nListing 21.13    The contents of the SecondController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n    public class SecondController : Controller {\n        public IActionResult Index() {\n            return View(""Common"");\n        }\n    }\n}\nThe new controller defines a single action, named Index , which invokes the View  \nmethod to select the Common  view. Wait for the application to be built and navigate \nto http://localhost:5000/home/common and http://localhost:5000/second, both of \nwhich will render the Common  view, producing the responses shown in figure 21.7.\nFigure 21.7    Using a shared view\nSpecifying a view location \nThe Razor view engine will look for a controller-specific view before a shared view. You \ncan change this behavior by specifying the complete path to a view file, which can be use -\nful if you want to select a shared view that would otherwise be ignored because there is a \ncontroller-specific view with the same name.\n...\npublic IActionResult Index() {\n    return View( ""/Views/Shared/Common.cshtml"" );\n}\n...\nWhen specifying the view, the path relative to the project folder must be specified, start -\ning with the / character. Notice that the full name of the file, including the file extension, \nis used.\nThis is a technique that should be used sparingly because it creates a dependency on a \nspecific file, rather than allowing the view engine to select the file.",6734
245-21.3 Working with Razor Views.pdf,245-21.3 Working with Razor Views,"575 Working with Razor Views\n21.3 Working with Razor Views\nRazor Views contain HTML elements and C# expressions. Expressions are mixed in \nwith the HTML elements and denoted with the @ character, like this:\n...\n<tr><th>Name</th><td> @Model.Name </td></tr>\n...\nWhen the view is used to generate a response, the expressions are evaluated, and the \nresults are included in the content sent to the client. This expression gets the name of \nthe Product  view model object provided by the action method and produces output \nlike this:\n...\n<tr><th>Name</th><td> Corner Flags </td></tr>\n...\nThis transformation can seem like magic, but Razor is simpler than it first appears. \nRazor Views are converted into C# classes that inherit from the RazorPage  class, which \nare then compiled like any other C# class. \nSeeing the compiled output from Razor Views\nBy default, Razor Views are compiled directly into a DLL, and the generated C# classes \nare not written to the disk during the build process. You can see the generated classes, \nby adding the following setting to the WebApp.csproj  file, which is accessed in Visual \nStudio by right-clicking the WebApp item in the Solution Explorer and selecting Edit Proj -\nect File from the pop-up menu:\n...\n<PropertyGroup>\n    <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>\n</PropertyGroup>\n...\nSave the project file and build the project using the dotnet build  command. The \nC# files generated from the Razor Views will be written to the obj/Debug/net7.0/  \ngenerated  folder. You may have to dig around in the subfolders to find specific files.\nThe view from listing 21.10, for example, would be transformed into a class like this:\nnamespace AspNetCoreGeneratedDocument {\n    using System;\n    using System.Collections.Generic;\n    using System.Linq;\n    using System.Threading.Tasks;\n    using Microsoft.AspNetCore.Mvc;\n    using Microsoft.AspNetCore.Mvc.Rendering;\n    using Microsoft.AspNetCore.Mvc.ViewFeatures;\n    internal sealed class Views_Home_Watersports : RazorPage<dynamic> {\n        public async override Task ExecuteAsync() {\n            WriteLiteral(""<!DOCTYPE html>\r\n<html>\r\n"");\n576 chapter  21 Using controllers with views, part I \n            WriteLiteral(""<link href=\"""");\n            WriteLiteral(""/lib/bootstrap/css/bootstrap.min.css\"""");\n            WriteLiteral(""rel=\""stylesheet\"" />\r\n"");\n            HeadTagHelper = CreateTagHelper<TagHelpers.HeadTagHelper>();\n            __tagHelperExecutionContext.Add(HeadTagHelper);\n            Write(__tagHelperExecutionContext.Output);\n            WriteLiteral(""\r\n"");\n            __tagHelperExecutionContext =\n                    __tagHelperScopeManager.Begin(""body"", \n                TagMode.StartTagAndEndTag, ""76ad69..."", async() => {\n                WriteLiteral(""<h6 class=\""bg-secondary text-white "");\n                WriteLiteral(""text-center m-2 p-2\"">Watersports</h6>\n"");\n                WriteLiteral(""<div class=\""m-2\""><table class=\""table "");\n                WriteLiteral(""table-sm table-striped table-bordered\"">"");           \n                WriteLiteral(""<tbody>\r\n <tr>"");\n                WriteLiteral(""<th>Name</th><td>"");\n                Write(Model.Name);\n                WriteLiteral(""</td></tr>\r\n<tr><th>Price</th><td>"");\n                Write(Model.Price.ToString(""c""));\n                WriteLiteral(""</td></tr>\r\n<tr><th>Category ID</th><td>"");\n                Write(Model.CategoryId);\n                WriteLiteral(""</td></tr>\r\n</tbody>\r\n</table>\r\n"");\n                WriteLiteral(""</div>\r\n"");\n            });\n            BodyTagHelper = CreateTagHelper<TagHelpers.BodyTagHelper>();\n            __tagHelperExecutionContext.Add(BodyTagHelper);\n            Write(__tagHelperExecutionContext.Output);\n            WriteLiteral(""\r\n</html>\r\n"");\n        }\n        public IModelExpressionProvider ModelExpressionProvider \n           { get; private set; }\n        public IUrlHelper Url { get; private set; }\n        public IViewComponentHelper Component { get; private set; }\n        public IJsonHelper Json { get; private set; }\n        public IHtmlHelper<dynamic> Html { get; private set; }        \n    }\n}\nThis class is a simplification of the code that is generated so that I can focus on the \nfeatures that are most important for this chapter. The first point to note is that the class \ngenerated from the view inherits from the RazorPage<T>  class .\n...\ninternal sealed class Views_Home_Watersports : RazorPage<dynamic>  {\n...\nTable 21.3 describes the most useful properties and methods defined by RazorPage<T> .\nCaching responses\nResponses from views can be cached by applying the ResponseCache  attribute to \naction methods (or to the controller class, which caches the responses from all the action \nmethods). See chapter 17 for details of how response caching is enabled.\n 577 Working with Razor Views\nTable 21.3    Useful RazorPage<T> members\nName Description\nContext This property returns the HttpContext  object for the cur-\nrent request.\nExecuteAsync() This method is used to generate the output from the view.\nLayout This property is used to set the view layout, as described in \nchapter 22.\nModel This property returns the view model passed to the View  \nmethod by the action.\nRenderBody() This method is used in layouts to include content from a \nview, as described in chapter 22.\nRenderSection() This method is used in layouts to include content from a \nsection in a view, as described in chapter 22.\nTempData This property is used to access the temp data feature, which \nis described in chapter 22.\nViewBag This property is used to access the view bag, which is \ndescribed in chapter 22.\nViewContext This property returns a ViewContext  object that provides \ncontext data.\nViewData This property returns the view data, which I used for unit \ntesting controllers in the SportsStore application.\nWrite(str) This method writes a string, which will be safely encoded for \nuse in HTML.\nWriteLiteral(str) This method writes a string without encoding it for safe use \nin HTML.\nThe expressions in the view are translated into calls to the Write  method, which \nencodes the result of the expression so that it can be included safely in an HTML doc-\nument. The WriteLiteral  method is used to deal with the static HTML regions of the \nview, which don’t need further encoding. The result is a fragment like this from the \nCSHTML  file:\n...\n<tr><th>Name</th><td>@Model.Name</td></tr>\n...\nThis is converted into a series of C# statements like these in the ExecuteAsync  method:\n...\nWriteLiteral(""<th>Name</th><td>"");\nWrite(Model.Name);\nWriteLiteral(""</td></tr>"");\n...\nWhen the ExecuteAsync  method is invoked, the response is generated with a mix of \nthe static HTML and the expressions contained in the view. The results from evaluat-\ning the expressions are written to the response, producing HTML like this:",7005
246-21.3.1 Setting the view model type.pdf,246-21.3.1 Setting the view model type,"578 chapter  21 Using controllers with views, part I \n...\n<th>Name</th><td>Kayak</td></tr>\n...\nIn addition to the properties and methods inherited from the RazorPage<T>  class, the \ngenerated view class defines the properties described in table 21.4, some of which are \nused for features described in later chapters.  \nTable 21.4    The additional View properties\nName Description\nComponent This property returns a helper for working with view com-\nponents, which is accessed through the vc tag helper \ndescribed in chapter 25.\nHtml This property returns an implementation of the IHtml-\nHelper  interface. This property is used to manage HTML \nencoding, as described in chapter 22.\nJson This property returns an implementation of the IJson-\nHelper  interface, which is used to encode data as JSON, \nas described in chapter 22. \nModelExpressionProvider This property provides access to expressions that select \nproperties from the model, which is used through tag  \nhelpers, described in chapters 25–27.\nUrl This property returns a helper for working with URLs, as \ndescribed in chapter 26.\n21.3.1  Setting the view model type \nThe generated class for the Watersports.cshtml  file is derived from RazorPage<T> , \nbut Razor doesn’t know what type will be used by the action method for the view model, \nso it has selected dynamic  as the generic type argument. This means that the @Model  \nexpression can be used with any property or method name, which is evaluated at run-\ntime when a response is generated. To demonstrate what happens when a nonexistent \nmember is used, add the content shown in listing 21.14 to the Watersports.cshtml  \nfile. \nListing 21.14    Adding content in the Watersports.cshtml file in the Views/Home folder \n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n 579 Working with Razor Views\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model.CategoryId</td></tr>\n                <tr><th>Tax Rate</th><td>@Model.TaxRate</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nUse a browser to request http://localhost:5000, and you will see the exception shown \nin figure 21.8. You may need to start ASP.NET Core to see this error because the \ndotnet watch  command can be confused when it is unable to load the compiled view.\nFigure 21.8    Using a nonexistent property in a view expression\nTo check expressions during development, the type of the Model  object can be speci-\nfied using the model  keyword, as shown in listing 21.15.  \nTIP    It is easy to get the two terms confused. Model , with an uppercase M, is used \nin expressions to access the view model object provided by the action method, \nwhile model , with a lowercase m, is used to specify the type of the view model.\nListing 21.15    Declaring the type in the Watersports.cshtml file in the Views/Home \nfolder\n@model WebApp.Models.Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n580 chapter  21 Using controllers with views, part I \n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model.CategoryId</td></tr>\n                <tr><th>Tax Rate</th><td>@Model.TaxRate</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nAn error warning will appear in the editor after a few seconds, as Visual Studio or \nVisual Studio Code checks the view in the background, as shown in figure 21.9. When \nthe dotnet watch  command is used, an error will be displayed in the browser, also \nshown in figure 21.9. The compiler will also report an error if you build the project or \nuse the dotnet build  or dotnet run  command. \nFigure 21.9    An error warning in a view file \nWhen the C# class for the view is generated, the view model type is used as the generic \ntype argument for the base class, like this:\n...\ninternal sealed class Views_Home_Watersports :  \nRazorPage< WebApp.Models.Product > {\n...\nSpecifying a view model type allows Visual Studio and Visual Studio Code to suggest \nproperty and method names as you edit views. Replace the nonexistent property with \nthe one shown in listing 21.16.\nListing 21.16    Using a property in the Watersports.cshtml file in the Views/Home folder\n@model WebApp.Models.Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n 581 Working with Razor Views\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model.CategoryId</td></tr>\n                <tr><th>Supplier ID</th><td>@Model.SupplierId</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nAs you type, the editor will prompt you with the possible member names defined by \nthe view model class, as shown in figure 21.10. This figure shows the Visual Studio code \neditor, but Visual Studio Code has a comparable feature.\nFigure 21.10    Editor suggestions when using a view model type\nusing a view imports  file\nWhen I declared the view model object at the start of the Watersports.cshtml  file,  \nI had to include the namespace that contains the class, like this:  \n582 chapter  21 Using controllers with views, part I \n...\n@model WebApp.Models .Product\n...\nBy default, all types that are referenced in a Razor View must be qualified with a name-\nspace. This isn’t a big deal when the only type reference is for the model object, but it \ncan make a view more difficult to read when writing more complex Razor expressions \nsuch as the ones I describe later in this chapter.\nYou can specify a set of namespaces that should be searched for types by adding a \nview imports  file to the project. The view imports file is placed in the Views  folder and is \nnamed _ViewImports.cshtml . \nNOTE     Files in the Views  folder whose names begin with an underscore (the \n_ character) are not returned to the user, which allows the file name to differ-\nentiate between views that you want to render and the files that support them. \nView imports files and layouts (which I describe shortly) are prefixed with an \nunderscore. \nIf you are using Visual Studio, right-click the Views  folder in the Solution Explorer, \nselect Add > New Item from the pop-up menu, and select the Razor View Imports tem-\nplate from the ASP.NET Core category, as shown in figure 21.11.\nFigure 21.11    Creating a view imports file \nVisual Studio will automatically set the name of the file to _ViewImports.cshtml , and \nclicking the Add button will create the file, which will be empty. If you are using Visual \nStudio Code, simply select the Views  folder and add a new file called _ViewImports \n.cshtml . Regardless of which editor you used, add the expression shown listing 21.17.\nListing 21.17    The contents of the _ViewImports.cshtml file in the Views folder\n@using WebApp.Models\nThe namespaces that should be searched for classes used in Razor Views are specified \nusing the @using  expression, followed by the namespace. In listing 21.17, I have added \n 583 Working with Razor Views\nan entry for the WebApp.Models  namespace that contains the view model class used in \nthe Watersports.cshtml  view. \nNow that the namespace is included in the view imports file, I can remove the name-\nspace from the view, as shown in listing 21.18. \nTIP    You can also add an @using  expression to individual view files, which allows \ntypes to be used without namespaces in a single view. \nListing 21.18    Changing type in the Watersports.cshtml file in the Views/Home folder\n@model Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model.CategoryId</td></tr>\n                <tr><th>Supplier ID</th><td>@Model.SupplierId</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nSave the view file and use a browser to request http://localhost:5000, and you will see \nthe response shown in figure 21.12.\nFigure 21.12    \nUsing a view \nimports file",9775
247-21.3.2 Understanding the view model type pitfall.pdf,247-21.3.2 Understanding the view model type pitfall,"584 chapter  21 Using controllers with views, part I \n21.3.2  Understanding the view model type pitfall\nThere is a pitfall waiting for the unwary, which is that the object passed to the View  \nmethod to set the view model isn’t type checked before it is used. Here is the definition \nof the View  method in the Controller  class:\n...\npublic virtual ViewResult View( object? model) {\n    return View(viewName: null, model: model);\n}\n...\nWhen the @model  expression is used to set the view model type, it changes the base \nclass for the view, and allows the expressions in the view to be checked by the compiler, \nbut it doesn’t prevent a controller from using an object with a completely different as \nthe view model. As a simple demonstration, listing 21.19 defines an action method that \nuses the Watersports  view but doesn’t use the Product  model type the view expects.\nListing 21.19    Adding an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n        // ...other actions omitted for brevity...\n        public IActionResult WrongModel() {\n            return View(""Watersports"", ""Hello, World!"");\n        }\n    }\n}\nThis mistake isn’t detected by the compiler because the WrongModel  action method is \nable to pass any object to the View  method. The problem will only become apparent \nat runtime, which you can see by using a browser to request http://localhost:5000/\nhome/wrongmodel. When the view is rendered, the mismatch between type of view \nmodel and the type expected by the view is detected, producing the error shown in \nfigure 21.13.\n 585 Working with Razor Views\nFigure 21.13    \nA view model \ntype mismatch\nunderstanding  the nullable  type pitfall  \nA complete type mismatch produces the kind of error shown in figure 21.13. This kind \nof problem is easy to detect and fix because the error is displayed as soon as the action \nmethod is invoked. There is, however, a more subtle mismatch, which can be harder \nto detect because it doesn’t always produce an error. To help illustrate the issue, listing \n21.20 sets the view model type in the Index  view.\nListing 21.20    Setting the model type in the Index.cshtml file in the Views/Home folder\n@model Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        Product Table\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model.CategoryId</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nRestart ASP.NET Core and use a browser to request two URLs: http://localhost:5000/\nhome/index/1 and http://localhost:5000/home/index/100. These URLs target the \nsame action method, which renders the same view, but the second one produces an \nerror, as shown in figure 21.14.\n586 chapter  21 Using controllers with views, part I \nFigure 21.14    An error caused by a view model type mismatch\nThis issue arises when an action method uses a nullable type as the view model, which \nis how I wrote the Index  action method in the Home  controller in listing 21.9:\n...\npublic async Task<IActionResult> Index(long id = 1) {\n    Product? prod  = await context.Products.FindAsync(id);\n    if (prod?.CategoryId == 1) {\n        return View(""Watersports"", prod);\n    } else {\n        return View(prod);\n    }\n}\n...\nThe result of the LINQ query is a nullable Product , which allows for queries for which \nthere is no data in the database. The action method passes on the result to the View  \nmethod without filtering out the null  values, which mean that requests for which the \ndatabase contains data work, because they product a Product  object, but requests for \nwhich there is no data fail, because they produce a null  value.\nOne way to deal with this is to ensure that the action method doesn’t pass null  values \nto the View  method. But another approach is to update the view so that expects a nul-\nlable view model type, as shown in listing 21.21.\nListing 21.21    Changing type in the Index.cshtml file in the Views/Home folder\n@model Product?\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        Product Table\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model?.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model?.Price.ToString(""c"")</td>",5242
248-21.4 Understanding the Razor syntax.pdf,248-21.4 Understanding the Razor syntax,,0
249-21.4.5 Using conditional expressions.pdf,249-21.4.5 Using conditional expressions,"587 Understanding the Razor syntax\n                </tr>\n                <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe listing changes the view model type to Product? , which is a nullable type. This \nchange requires the use of the null conditional operator to safely deal with null values, \nlike this:\n...\n<tr><th>Name</th><td>@ Model?.Name</td></tr>\n...\nThis technique is useful when you want to render the view even when the action \nmethod produces a null value. Save the changes to the view and use the browser to \nrequest http://localhost:5000/home/index/100. The view will be rendered without \nan exception, but the null conditional operator will produce an empty table, because \nthe null values the operator produces are discarded, as shown in figure 21.15.\nFigure 21.15    Using a nullable view model type \n21.4 Understanding the Razor syntax\nThe Razor compiler separates the static fragments of HTML from the C# expressions, \nwhich are then handled separately in the generated class file. There are several types \nof expression that can be included in views, which I describe in the sections that follow.  \n21.4.1  Understanding directives \nDirectives are expressions that give instructions to the Razor view engine. The @model  \nexpression is a directive, for example, that tells the view engine to use a specific type \nfor the view model, while the @using  directive tells the view engine to import a name-\nspace. Table 21.5 describes the most useful Razor directives.  \n588 chapter  21 Using controllers with views, part I \nTable 21.5    Useful Razor directives\nName Description\n@model This directive specifies the type of the view model.\n@using This directive imports a namespace.\n@page This directive denotes a Razor Page, described in chapter 23.\n@section This directive denotes a layout section, as described in chapter 22.\n@addTagHelper This directive adds tag helpers to a view, as described in chapter 25.\n@namespace This directive sets the namespace for the C# class generated from a view.\n@functions This directive adds C# properties and methods to the C# class generated from a \nview and is commonly used in Razor Pages, as described in chapter 23.\n@attribute This directive adds an attribute to the C# class generated from a view. I use this \nfeature to apply authorization restrictions in chapter 38.\n@implements This directive declares that the C# class generated from a view implements an \ninterface. This feature is demonstrated in chapter 36.\n@inherits This directive sets the base class for the C# class generated from a view. This fea-\nture is demonstrated in chapter 36.\n@inject This directive provides a view with direct access to a service through dependency \ninjection. This feature is demonstrated in chapter 23.\n21.4.2  Understanding content expressions\nRazor content expressions produce content that is included in the output generated \nby a view. Table 21.6 describes the most useful content expressions, which are demon-\nstrated in the sections that follow.  \nTable 21.6    Useful Razor content expressions\nName Description\n@<expression> This is the basic Razor expression, which is evaluated, and the result it produces is \ninserted into the response. \n@if This expression is used to select regions of content based on the result of an expres-\nsion. See the “Using Conditional Expressions” section for examples.\n@switch This expression is used to select regions of content based on the result of an expres-\nsion. See the “Using Conditional Expressions” section for examples.\n@foreach This expression generates the same region of content for each element in a \nsequence. See the “Enumerating Sequences” for examples.\n@{ ... } This expression defines a code block. See the “Using Razor Code Blocks” section for \nan example.\n@: This expression denotes a section of content that is not enclosed in HTML elements. \nSee the “Using Conditional Expressions” section for an example.\n@try This expression is used to catch exceptions. \n@await This expression is used to perform an asynchronous operation, the result of which is \ninserted into the response. See chapter 24 for examples.\n 589 Understanding the Razor syntax\n21.4.3  Setting element content \nThe simplest expressions are evaluated to produce a single value that is used as the \ncontent for an HTML element in the response sent to the client. The most common \ntype of expression inserts a value from the view model object, like these expressions \nfrom the Watersports.cshtml  view file:  \n...\n<tr><th>Name</th><td> @Model.Name </td></tr>\n<tr><th>Price</th><td> @Model.Price.ToString(""c"") </td></tr>\n...\nThis type of expression can read property values or invoke methods, as these exam-\nples demonstrate. Views can contain more complex expressions, but these need to be \nenclosed in parentheses so that the Razor compiler can differentiate between the code \nand static content, as shown in listing 21.22.\nListing 21.22    Expressions in the Watersports.cshtml file in the Views/Home folder\n@model Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Tax</th><td>@Model.Price * 0.2m</td></tr>\n                <tr><th>Tax</th><td>@(Model.Price * 0.2m)</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nUse a browser to request http://localhost:5000; the response, shown in figure 21.16, \nshows why parentheses are important.\n590 chapter  21 Using controllers with views, part I \nFigure 21.16    Expressions with and without parentheses \nThe Razor View compiler matches expressions conservatively and has assumed that the \nasterisk and the numeric value in the first expression are static content. This problem \nis avoided by parentheses for the second expression.\n21.4.4  Setting attribute values\nAn expression can be used to set the values of element attributes, as shown in listing \n21.23.  \nListing 21.23    Setting Attributes in the Watersports.cshtml File in the Views/Home \nFolder \n@model Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered""\n               data-id=""@Model.ProductId"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Tax</th><td>@Model.Price * 0.2m</td></tr>\n                <tr><th>Tax</th><td>@(Model.Price * 0.2m)</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nI used the Razor expressions to set the value for a data  attribute on the table  element. \n 591 Understanding the Razor syntax\nTIP    Data attributes, which are attributes whose names are prefixed by data- , \nhave been an informal way of creating custom attributes for many years and \nwere made part of the formal standard as part of HTML5. They are most often \napplied so that JavaScript code can locate specific elements or so that CSS styles \ncan be more narrowly applied. \nIf you request http://localhost:5000 and look at the HTML source that is sent to the \nbrowser, you will see that Razor has set the values of the attribute, like this:\n...\n<table class=""table table-sm table-striped table-bordered"" data-id=""1""> \n    <tbody> \n        <tr><th>Name</th><td>Kayak</td></tr> \n        <tr><th>Price</th><td>$275.00</td></tr> \n        <tr><th>Tax</th><td>275.00 * 0.2m</td></tr> \n        <tr><th>Tax</th><td>55.000</td></tr> \n    </tbody> \n</table>\n...\n21.4.5  Using conditional expressions\nRazor supports conditional expressions, which means that the output can be tailored \nbased on the view model. This technique is at the heart of Razor and allows you to cre-\nate complex and fluid responses from views that are simple to read and maintain. In \nlisting 21.24, I have added a conditional statement to the Watersports  view.  \nListing 21.24    An if expression in the Watersports.cshtml file in the Views/Home folder \n@model Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered""\n               data-id=""@Model.ProductId"">\n            <tbody>\n                @if (Model.Price > 200) {\n                        <tr><th>Name</th><td>Luxury @Model.Name</td></tr>\n                } else {\n                        <tr><th>Name</th><td>Basic @Model.Name</td></tr>\n                }\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Tax</th><td>@Model.Price * 0.2m</td></tr>\n592 chapter  21 Using controllers with views, part I \n                <tr><th>Tax</th><td>@(Model.Price * 0.2m)</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe @ character is followed by the if keyword and a condition that will be evaluated at \nruntime. The if expression supports optional else  and elseif  clauses and is termi-\nnated with a close brace (the } character). If the condition is met, then the content in \nthe if clause is inserted into the response; otherwise, the content in the else  clause is \nused instead. \nNotice that the @ prefix isn’t required to access a Model  property in the condition.\n...\n@if (Model.Price > 200) {\n...\nBut the @ prefix is required inside the if and else  clauses, like this:\n...\n<tr><th>Name</th><td>Luxury @Model.Name </td></tr>\n...\nTo see the effect of the conditional statement, use a browser to request http://  \nlocalhost:5000/home/index/1 and http://localhost:5000/home/index/2. The con-\nditional statement will produce different HTML elements for these URLs, as shown in \nfigure 21.17.\nFigure 21.17    Using a conditional statement \nRazor also supports @switch  expressions, which can be a more concise way of han-\ndling multiple conditions, as shown in listing 21.25.  \nListing 21.25    A switch in the Watersports.cshtml file in the Views/Home folder\n@model Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n 593 Understanding the Razor syntax\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered""\n               data-id=""@Model.ProductId"">\n            <tbody>\n                @switch (Model.Name) {\n                    case ""Kayak"":\n                        <tr><th>Name</th><td>Small Boat</td></tr>\n                        break;\n                    case ""Lifejacket"":\n                        <tr><th>Name</th><td>Flotation Aid</td></tr>\n                        break;\n                    default:\n                        <tr><th>Name</th><td>@Model.Name</td></tr>\n                        break;\n                }\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Tax</th><td>@Model.Price * 0.2m</td></tr>\n                <tr><th>Tax</th><td>@(Model.Price * 0.2m)</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nConditional expressions can lead to the same blocks of content being duplicated for \neach result clause. In the switch  expression, for example, each case  clause differs \nonly in the content of the td element, while the tr and th elements remain the same. \nTo remove this duplication, conditional expressions can be used within an element, as \nshown in listing 21.26.\nListing 21.26    Setting content in the Watersports.cshtml file in the Views/Home folder\n@model Product\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">\n        Watersports\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered""\n               data-id=""@Model.ProductId"">\n            <tbody>\n                 <tr><th>Name</th><td>\n                    @switch (Model.Name) {\n                        case ""Kayak"":\n                            @:Small Boat",13289
250-21.4.6 Enumerating sequences.pdf,250-21.4.6 Enumerating sequences,"594 chapter  21 Using controllers with views, part I \n                            break;\n                        case ""Lifejacket"":\n                            @:Flotation Aid\n                            break;\n                        default:\n                            @Model.Name\n                            break;\n                    }\n                </td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>@Model.Price.ToString(""c"")</td>\n                </tr>\n                <tr><th>Tax</th><td>@Model.Price * 0.2m</td></tr>\n                <tr><th>Tax</th><td>@(Model.Price * 0.2m)</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe Razor compiler needs help with literal values that are not enclosed in HTML ele-\nments, requiring the @: prefix, like this:\n...\n@:Small Boat\n...\nThe compiler copes with HTML elements because it detects the open tag, but this \nadditional help is required for text content. To see the effect of the switch  statement, \nuse a web browser to request http://localhost:5000/home/index/2, which produces \nthe response shown in figure 21.18.\nFigure 21.18    Using a switch expression with literal content \n21.4.6  Enumerating sequences\nThe Razor @foreach  expression generates content for each object in an array or a col-\nlection, which is a common requirement when processing data. Listing 21.27 adds an \naction method to the Home  controller that produces a sequence of objects.L   \n 595 Understanding the Razor syntax\nListing 21.27    Adding an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            Product? prod = await context.Products.FindAsync(id);\n            if (prod?.CategoryId == 1) {\n                return View(""Watersports"", prod);\n            } else {\n                return View(prod);\n            }\n        }\n        public IActionResult Common() {\n            return View();\n        }\n        public IActionResult WrongModel() {\n            return View(""Watersports"", ""Hello, World!"");\n        }\n        public IActionResult List() {\n            return View(context.Products);\n        }\n    }\n}\nThe new action is called List , and it provides its view with the sequence of Product  \nobjects obtained from the Entity Framework Core data context. Add a Razor View file \nnamed List.cshtml  to the Views/Home  folder and add the content shown in listing \n21.28.\nListing 21.28    The contents of the List.cshtml file in the Views/Home folder\n@model IEnumerable<Product>\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">",3179
251-21.4.7 Using Razor code blocks.pdf,251-21.4.7 Using Razor code blocks,"596 chapter  21 Using controllers with views, part I \n            <thead>\n                <tr><th>Name</th><th>Price</th></tr>\n            </thead>\n            <tbody>\n                @foreach (Product p in Model) {\n                    <tr><td>@p.Name</td><td>@p.Price</td></tr>\n                }\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe foreach  expression follows the same format as the C# foreach  statement, and \nI used the ?? operator to fall back to an empty collection when the model is null . In \nthe example, the variable p is assigned each object in the sequence provided by the \naction method. The content within the expression is duplicated for each object and \ninserted into the response after the expressions it contains are evaluated. In this case, \nthe content in the foreach  expression generates a table row with cells that have their \nown expressions.\n...\n<td>@p.Name</td><td> @p.Price </td>\n...\nRestart ASP.NET Core so that the new action method will be available and use a \nbrowser to request http://localhost:5000/home/list, which produces the result shown \nin figure 21.19, showing how the foreach  expression populates a table body.\nFigure 21.19    Using a foreach expression \n21.4.7  Using Razor code blocks \nCode blocks are regions of C# content that do not generate content but that can be \nuseful to perform tasks that support the expressions that do. Listing 21.29 adds a code \nblock that calculates an average value.\n 597 Understanding the Razor syntax\nTIP    The most common use of code blocks is to select a layout, which is described \nin chapter 22.\nListing 21.29    Using a code block in the List.cshtml file in the Views/Home folder\n@model IEnumerable<Product>\n@{ \n    decimal average = Model.Average(p => p.Price);\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead>\n                <tr><th>Name</th><th>Price</th></tr>\n            </thead>\n            <tbody>\n                @foreach (Product p in Model) {\n                    <tr>\n                        <td>@p.Name</td><td>@p.Price</td>\n                        <td>@((p.Price / average * 100).ToString(""F1""))\n                            % of average\n                        </td>\n                    </tr>\n                }\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe code block is denoted by @{ and } and contains standard C# statements. The code \nblock in listing 21.29 uses LINQ to calculate a value that is assigned to a variable named \naverage , which is used in an expression to set the contents of a table cell, avoiding the \nneed to repeat the average calculation for each object in the view model sequence. Use \na browser to request http://localhost:5000/home/list, and you will see the response \nshown in figure 21.20.\nNOTE    Code blocks can become difficult to manage if they contain more than a \nfew statements. For more complex tasks, consider using the view bag, described \nin chapter 22, or adding a nonaction method to the controller.",3321
252-22.1.1 Dropping the database.pdf,252-22.1.1 Dropping the database,"598 chapter  21 Using controllers with views, part I \nFigure 21.20    Using a code block\nSummary\n¡ Razor views are files that combine HTML and code expressions.\n¡ Views are compiled into C# classes whose methods are invoked to generate \nHTML content.\n¡ Views are selected as results in action methods, optionally passing data that will \nbe used to generate the HTML result.\n¡ Views can be defined with a view model, which allows the code expressions in the \nview to be type-checked.\n59922Using controllers with  \nviews, part II\nThis chapter covers\n¡ Using the view bag and temp data to pass data  \n from an action to a view\n¡ Using layouts to define common content\n¡ Using partial views to define reusable sections  \n of content\n¡ Encoding data within views\nIn this chapter, I describe more of the features provided by Razor Views. I show you \nhow to pass additional data to a view using the view bag and how to use layouts and \nlayout sections to reduce duplication. I also explain how the results from expres-\nsions are encoded and how to disable the encoding process. Table 22.1 provides a \nguide to the chapter.\n600 chapter  22 Using controllers with views, part II \nTable 22.1    Chapter guide\nProblem Solution Listing\nProviding unstructured data to a view Use the view bag. 5, 6\nProviding temporary data to a view Use temp data. 7, 8\nUsing the same content in multiple views Use a layout. 9–12, \n15–18\nSelecting the default layout for views Use a view start file. 13, 14\nInterleaving unique and common content Use layout sections. 19–24\nCreating reusable sections of content Use a partial view. 25–29\nInserting HTML into a response using a \nRazor expressionEncode the HTML. 30–32\nIncluding JSON in a view Use the JSON encoder. 33\n22.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 21. To prepare for this chapter, \nreplace the contents of the HomeController.cs  file with the code shown in listing \n22.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 22.1    The contents of the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            return View(await context.Products.FindAsync(id));\n        }\n        public IActionResult List() {\n            return View(context.Products);\n        }\n    }\n}",2819
253-22.2 Using the view bag.pdf,253-22.2 Using the view bag,"601 Preparing for this chapter\nOne of the features used in this chapter requires the session feature, which was \ndescribed in chapter 16. To enable sessions, add the statements shown in listing 22.2 to \nthe Program.cs  file. \nListing 22.2    Enabling sessions in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(options => {\n    options.Cookie.IsEssential = true;\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllers();\napp.MapDefaultControllerRoute();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\n22.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 22.3 to drop the database.\nListing 22.3    Dropping the database\ndotnet ef database drop --force\n22.1.2  Running the example application \nOnce the database has been dropped, use the PowerShell command prompt to run \nthe command shown in listing 22.4. \n602 chapter  22 Using controllers with views, part II \nListing 22.4    Running the example application \ndotnet watch\nThe database will be seeded as part of the application startup. Once ASP.NET Core is \nrunning, use a web browser to request http://localhost:5000, which will produce the \nresponse shown in figure 22.1.\nFigure 22.1    Running the example application\nAs noted in chapter 21, the dotnet watch  command is useful when working with \nviews, but when you make a change that cannot be handled without restarting ASP.\nNET Core, you will see a message like this at the command prompt:\nwatch : Unable to apply hot reload because of a rude edit. \nwatch : Do you want to restart your app - Yes (y) / No (n) /  \n    Always (a) / Never (v)?\nThe point at which this arises depends on the editor you have chosen, but when this \nhappens, select the Always  option so that the application will always be restarted when \na reload cannot be performed.\n22.2 Using the view bag\nAction methods provide views with data to display with a view model, but sometimes \nadditional information is required. Action methods can use the view bag to provide a \nview with extra data, as shown in listing 22.5.  \nListing 22.5    Using the view bag in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n 603 Using the view bag\n        public async Task<IActionResult> Index(long id = 1) {\n            ViewBag.AveragePrice = \n                await context.Products.AverageAsync(p => p.Price);\n            return View(await context.Products.FindAsync(id));\n        }\n        public IActionResult List() {\n            return View(context.Products);\n        }\n    }\n}\nThe ViewBag  property is inherited from the Controller  base class and returns a \ndynamic  object. This allows action methods to create new properties just by assigning \nvalues to them, as shown in the listing. The values assigned to the ViewBag  property by \nthe action method are available to the view through a property also called ViewBag , as \nshown in listing 22.6.\nListing 22.6    Using the view bag in the Index.cshtml file in the Views/Home folder\n@model Product?\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        Product Table\n    </h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model?.Name</td></tr>\n                <tr>\n                    <th>Price</th>\n                    <td>\n                        @Model?.Price.ToString(""c"")\n                        (@(((Model?.Price / ViewBag.AveragePrice)\n                               * 100).ToString(""F2""))% of average price)     \n                    </td>\n                </tr>\n                <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe ViewBag  property conveys the object from the action to the view, alongside the \nview model object. In the listing, the action method queries for the average of the \nProduct.Price  properties in the database and assigns it to a view bag property named \nAveragePrice , which the view uses in an expression. Use a browser to request http://\nlocalhost:5000, which produces the response shown in figure 22.2.",5235
254-22.3 Using temp data.pdf,254-22.3 Using temp data,"604 chapter  22 Using controllers with views, part II \nFigure 22.2    Using the view bag\nWhen to use the view bag\nThe view bag works best when it is used to provide the view with small amounts of \nsupplementary data without having to create new view model classes for each action \nmethod. The problem with the view bag is that the compiler cannot check the use of the \nproperties on dynamic objects, much like views that don’t use an @model  expression. \nIt can be difficult to judge when a new view model class should be used, and my rule of \nthumb is to create a new view model class when the same view bag property is used by \nmultiple actions or when an action method adds more than two or three properties to the \nview bag.\n22.3 Using temp data \nThe temp data feature allows a controller to preserve data from one request to another, \nwhich is useful when performing redirections. Temp data is stored using a cookie \nunless session state is enabled when it is stored as session data. Unlike session data, \ntemp data values are marked for deletion when they are read and removed when the \nrequest has been processed. \nAdd a class file called CubedController.cs  to the WebApp/Controllers  folder \nand use it to define the controller shown in listing 22.7.\nListing 22.7    The contents of the CubedController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n    public class CubedController: Controller {\n        \n        public IActionResult Index() {\n            return View(""Cubed"");\n        }\n        public IActionResult Cube(double num) {\n            TempData[""value""] = num.ToString();\n 605 Using temp data \n            TempData[""result""] = Math.Pow(num, 3).ToString();\n            return RedirectToAction(nameof(Index));\n        }\n    }\n}\nThe Cubed  controller defines an Index  method that selects a view named Cubed . There \nis also a Cube  action, which relies on the model binding process to obtain a value for \nits num parameter from the request (a process described in detail in chapter 28). The \nCubed  action method performs its calculation and stores the num value and the calcu-\nlation result using TempData  property, which returns a dictionary that is used to store \nkey-value pairs.  Since the temp data feature is built on top of the sessions feature, only \nvalues that can be serialized to strings can be stored, which is why I convert both dou-\nble values to strings in listing 22.7. Once the values are stored as temp data, the Cube  \nmethod performs a redirection to the Index  method. To provide the controller with a \nview, add a Razor View file named Cubed.cshtml  to the WebApp/Views/Shared  folder \nwith the content shown in listing 22.8.\nListing 22.8    The contents of the Cubed.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">Cubed</h6>\n    <form method=""get"" action=""/cubed/cube"" class=""m-2"">\n        <div class=""form-group"">\n            <label>Value</label>\n            <input name=""num"" class=""form-control"" \n            value=""@(TempData[""value""])"" />\n        </div>\n        <button class=""btn btn-primary mt-1"" type=""submit"">\n            Submit\n        </button>\n    </form>\n    @if (TempData[""result""] != null) {\n            <div class=""bg-info text-white m-2 p-2"">\n                The cube of @TempData[""value""] is @TempData[""result""]\n            </div>\n    } \n</body>\n</html>\nThe base class used for Razor Views provides access to the temp data through a  \nTempData  property, allowing values to be read within expressions. In this case, temp \ndata is used to set the content of an input  element and display a results summary. \nReading a temp data value doesn’t remove it immediately, which means that values can \nbe read repeatedly in the same view. It is only once the request has been processed that \nthe marked values are removed.\n606 chapter  22 Using controllers with views, part II \nTo see the effect, use a browser to navigate to http://localhost:5000/cubed, enter a \nvalue into the form field, and click the Submit button. The browser will send a request \nthat will set the temp data and trigger the redirection. The temp data values are pre-\nserved for the new request, and the results are displayed to the user. But reading the \ndata values marks them for deletion, and if you reload the browser, the contents of the \ninput  element and the results summary are no longer displayed, as shown in figure \n22.3.\nTIP    The object returned by the TempData  property provides a Peek  method, \nwhich allows you to get a data value without marking it for deletion, and a \nKeep  method, which can be used to prevent a previously read value from being \ndeleted. The Keep  method doesn’t protect a value forever. If the value is read \nagain, it will be marked for removal once more. Use session data if you want to \nstore items so that they won’t be removed when the request is processed.  \nFigure 22.3    Using temp data\nUsing the temp data attribute \nControllers can define properties that are decorated with the TempData  attribute, which \nis an alternative to using the TempData  property, like this:  \nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n    public class CubedController: Controller {\n        \n        public IActionResult Index() {\n            return View(""Cubed"");\n        }\n        public IActionResult Cube(double num) {\n            Value = num.ToString();\n            Result = Math.Pow(num, 3).ToString();\n            return RedirectToAction(nameof(Index));\n        }\n        [TempData]",5794
255-22.4 Working with layouts.pdf,255-22.4 Working with layouts,"607 Working with layouts\n(continued)\n        public string? Value { get; set; }\n        [TempData]\n        public string? Result { get; set; }\n    }\n}\nThe values assigned to these properties are automatically added to the temp data store, \nand there is no difference in the way they are accessed in the view. My preference is to \nuse the TempData  dictionary to store values because it makes the intent of the action \nmethod obvious to other developers. However, both approaches are entirely valid, and \nchoosing between them is a matter of preference.\n22.4 Working with layouts\nThe views in the example application contain duplicate elements that deal with setting \nup the HTML document, defining the head  section, loading the Bootstrap CSS file, \nand so on. Razor supports layouts , which consolidate common content in a single file \nthat can be used by any view.  \nLayouts are typically stored in the Views/Shared  folder because they are usually \nused by the action methods of more than one controller. If you are using Visual Studio, \nright-click the Views/Shared  folder, select Add > New Item from the pop-up menu, \nand choose the Razor Layout template, as shown in figure 22.4. Make sure the name of \nthe file is _Layout.cshtml  and click the Add button to create the new file. Replace the \ncontent added to the file by Visual Studio with the elements shown in listing 22.9.\nFigure 22.4    Creating a layout \nIf you are using Visual Studio Code, create a file named _Layout.cshtml  in the \nViews/Shared folder and add the content shown in listing 22.9.\n608 chapter  22 Using controllers with views, part II \nListing 22.9   The contents of the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">Shared View</h6>\n    @RenderBody()\n</body>\n</html>\nThe layout contains the common content that will be used by multiple views. The con-\ntent that is unique to each view is inserted into the response by calling the RenderBody  \nmethod, which is inherited by the RazorPage<T>  class, as described in chapter 21. \nViews that use layouts can focus on just their unique content, as shown in listing 22.10.  \nListing 22.10    Using a layout in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_Layout"";\n}\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <tbody>\n            <tr><th>Name</th><td>@Model?.Name</td></tr>\n            <tr>\n                <th>Price</th>\n                <td>\n                    @Model?.Price.ToString(""c"")\n                    (@(((Model?.Price / ViewBag.AveragePrice)\n                            * 100).ToString(""F2""))% of average price)     \n                </td>\n            </tr>\n            <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n        </tbody>\n    </table>\n</div>\nThe layout is selected by adding a code block, denoted by the @{ and } characters, \nthat sets the Layout  property inherited from the RazorPage<T>  class. In this case, the \nLayout  property is set to the name of the layout file. As with normal views, the layout \nis specified without a path or file extension, and the Razor engine will search in the \n/Views/[controller]  and /Views/Shared  folders to find a matching file. Restart \nASP.NET Core and use the browser to request http://localhost:5000, and you will see \nthe response shown in figure 22.5.",3582
256-22.4.2 Using a view start file.pdf,256-22.4.2 Using a view start file,"609 Working with layouts\nFigure 22.5    Using a layout \n22.4.1  Configuring layouts using the view bag\nThe view can provide the layout with data values, allowing the common content pro-\nvided by the view to be customized. The view bag properties are defined in the code \nblock that selects the layout, as shown in listing 22.11.  \nListing 22.11    Setting a property in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_Layout"";\n    ViewBag.Title = ""Product Table"";\n}\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <tbody>\n            <tr><th>Name</th><td>@Model?.Name</td></tr>\n            <tr>\n                <th>Price</th>\n                <td>\n                    @Model?.Price.ToString(""c"")\n                    (@(((Model?.Price / ViewBag.AveragePrice)\n                            * 100).ToString(""F2""))% of average price)     \n                </td>\n            </tr>\n            <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n        </tbody>\n    </table>\n</div>\nThe view sets a Title  property, which can be used in the layout, as shown in listing \n22.12.\nListing 22.12    Using a property in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n610 chapter  22 Using controllers with views, part II \n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        @(ViewBag.Title ?? ""Layout"")\n    </h6>\n    @RenderBody()\n</body>\n</html>\nThe Title  property is used to set the content of the title  element and h6 element \nin the body  section. Layouts cannot rely on view bag properties being defined, which \nis why the expression in the h6 element provides a fallback value if the view doesn’t \ndefine a Title  property. To see the effect of the view bag property, use a browser to \nrequest http://localhost:5000, which produces the response shown in figure 22.6.\nFigure 22.6    Using a view bag property to configure a layout \nUnderstanding view bag precedence \nThe values defined by the view take precedence if the same view bag property is defined \nby the view and the action method. If you want to allow the action to override the value \ndefined in the view, then use a statement like this in the view code block:\n...\n@{  \n    Layout = ""_Layout"";\n    ViewBag.Title = ViewBag.Title ?? ""Product Table"";\n}\n...\nThis statement will set the value for the Title  property only if it has not already been \ndefined by the action method.\n22.4.2  Using a view start file \nInstead of setting the Layout  property in every view, you can add a view start  file to the \nproject that provides a default Layout  value. If you are using Visual Studio, right-click \nthe Views  folder item in the Solution Explorer, select Add > New Item, and locate the \n 611 Working with layouts\nRazor View Start template, as shown in figure 22.7. Make sure the name of the file is \n_ViewStart.cshtml  and click the Add button to create the file, which will have the \ncontent shown in listing 22.13.  \nFigure 22.7    Creating a view start file\nIf you are using Visual Studio Code, then add a file named _ViewStart.cshtml  to the \nViews  folder and add the content shown in listing 22.13.\nListing 22.13    The contents of the _ViewStart.cshtml file in the Views folder\n@{\n    Layout = ""_Layout"";\n}\nThe file sets the Layout  property, and the value will be used as the default. Listing \n22.14 simplifies the Common.cshtml  file, leaving just content that is unique to the view. \nListing 22.14    Removing content in the Common.cshtml file in the Views/Shared folder\n<h6 class=""bg-secondary text-white text-center m-2 p-2"">Shared View</h6>\nThe view doesn’t define a view model type and doesn’t need to set the Layout  property \nbecause the project contains a view start file. The result is that the content in listing \n22.14 will be added to the body  section of the HTML content of the response. Use a \nbrowser to navigate to http://localhost:5000/second, and you will see the response in \nfigure 22.8.\nFigure 22.8    \nUsing a view \nstart file",4246
257-22.4.3 Overriding the default layout.pdf,257-22.4.3 Overriding the default layout,"612 chapter  22 Using controllers with views, part II \n22.4.3  Overriding the default layout \nThere are two situations where you may need to define a Layout  property in a view \neven when there is a view start file in the project. In the first situation, a view requires \na different layout from the one specified by the view start file. To demonstrate, add a \nRazor layout file named _ImportantLayout.cshtml  to the Views/Shared  folder with \nthe content shown in listing 22.15.  \nListing 22.15    The  _ImportantLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h3 class=""bg-warning text-white text-center p-2 m-2"">Important</h3>\n    @RenderBody()\n</body>\n</html>\nIn addition to the HTML document structure, this file contains a header element that \ndisplays Important  in large text. Views can select this layout by assigning its name to \nthe Layout  property, as shown in listing 22.16.\nTIP    If you need to use a different layout for all the actions of a single controller, \nthen add a view start file to the Views/[controller]  folder that selects the view \nyou require. The Razor engine will use the layout specified by the controller-spe-\ncific view start file.\nListing 22.16    Using a specific layout in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_ImportantLayout"";\n    ViewBag.Title = ""Product Table"";\n}\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <tbody>\n            <tr><th>Name</th><td>@Model?.Name</td></tr>\n            <tr>\n                <th>Price</th>\n                <td>\n                    @Model?.Price.ToString(""c"")\n                    (@(((Model?.Price / ViewBag.AveragePrice)\n                            * 100).ToString(""F2""))% of average price)     \n                </td>\n            </tr>\n            <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n        </tbody>\n    </table>\n</div>\n 613 Working with layouts\nThe Layout  value in the view start file is overridden by the value in the view, allowing \ndifferent layouts to be applied. Restart ASP.NET Core and use a browser to request \nhttp://localhost:5000, and the response will be produced using the new layout, as \nshown in figure 22.9. \nSelecting a layout programmatically\nThe value that a view assigns to the Layout  property can be the result of an expression \nthat allows layouts to be selected by the view, similar to the way that action methods can \nselect views. Here is an example that selects the layout based on a property defined by \nthe view model object:  \n...\n@model Product?\n@{\n    Layout = Model.Price > 100 ? ""_ImportantLayout"" : ""_Layout"";\n    ViewBag.Title = ""Product Table"";\n}\n...\nThe layout named _ImportantLayout  is selected when the value of the view model \nobject’s Price  property is greater than 100; otherwise, _Layout  is used.\nFigure 22.9    Specifying a layout in a view \nThe second situation where a Layout  property can be needed is when a view contains \na complete HTML document and doesn’t require a layout at all. To see the problem, \nopen a new PowerShell command prompt and run the command shown in listing \n22.17.\nListing 22.17    Sending an HTTP request \nInvoke-WebRequest http://localhost:5000/home/list |  \n    Select-Object -expand Content\nThis command sends an HTTP GET request whose response will be produced using \nthe List.cshtml  file in the Views/Home  folder. This view contains a complete HTML \n614 chapter  22 Using controllers with views, part II \ndocument, which is combined with the content in the view specified by the view start \nfile, producing a malformed HTML document, like this:\n<!DOCTYPE html>\n<html>\n<head>\n    <title></title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">Layout</h6>\n    <!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead><tr><th>Name</th><th>Price</th></tr></thead>\n            <tbody>\n                <!-- ...table rows omitted for brevity... >\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\n</body>\n</html>\nThe structural elements for the HTML document are duplicated, so there are two \nhtml , head , body , and link  elements. Browsers are adept at handling malformed \nHTML but don’t always cope with poorly structured content. Where a view contains \na complete HTML document, the Layout  property can be set to null , as shown in \nlisting 22.18. \nListing 22.18    Disabling layouts in the List.cshtml file in the Views/Home folder \n@model IEnumerable<Product>\n@{\n    Layout = null;\n    decimal average = Model.Average(p => p.Price);\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">",5430
258-22.4.4 Using layout sections.pdf,258-22.4.4 Using layout sections,"615 Working with layouts\n            <thead>\n                <tr><th>Name</th><th>Price</th></tr>\n            </thead>\n            <tbody>\n                @foreach (Product p in Model) {\n                    <tr>\n                        <td>@p.Name</td><td>@p.Price</td>\n                        <td>@((p.Price / average * 100).ToString(""F1""))\n                            % of average\n                        </td>\n                    </tr>\n                }\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nSave the view and run the command shown in listing 22.17 again, and you will see \nthat the response contains only the elements in the view and that the layout has been \ndisabled.\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead><tr><th>Name</th><th>Price</th></tr></thead>\n            <tbody>\n                <!-- ...table rows omitted for brevity... >\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\n22.4.4  Using layout sections\nThe Razor View engine supports the concept of sections , which allow you to provide \nregions of content within a layout. Razor sections give greater control over which parts \nof the view are inserted into the layout and where they are placed. To demonstrate the \nsections feature, I have edited the /Views/Home/Index.cshtml  file, as shown in list-\ning 22.19. The browser will display an error when you save the changes in this listing, \nwhich will be resolved when you make corresponding changes in the next listing. \nListing 22.19    Defining sections in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_Layout"";\n616 chapter  22 Using controllers with views, part II \n    ViewBag.Title = ""Product Table"";\n}\n@section Header {\n    Product Information\n}\n<tr><th>Name</th><td>@Model?.Name</td></tr>\n<tr>\n    <th>Price</th>\n    <td>@Model?.Price.ToString(""c"")</td>\n</tr>\n<tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n@section Footer {\n    @(((Model?.Price / ViewBag.AveragePrice)\n            * 100).ToString(""F2""))% of average price\n}\nSections are defined using the Razor @section  expression followed by a name for the \nsection. Listing 22.19 defines sections named Header  and Footer , and sections can \ncontain the same mix of HTML content and expressions, just like the main part of the \nview. Sections are applied in a layout with the @RenderSection  expression, as shown \nin listing 22.20.  \nListing 22.20    Using sections in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-info text-white m-2 p-1"">\n        This is part of the layout\n    </div>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        @RenderSection(""Header"")\n    </h6>\n    <div class=""bg-info text-white m-2 p-1"">\n        This is part of the layout\n    </div>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                @RenderBody()\n            </tbody>\n        </table>\n    </div>\n 617 Working with layouts\n    <div class=""bg-info text-white m-2 p-1"">\n        This is part of the layout\n    </div>\n    <h6 class=""bg-primary text-white text-center m-2 p-2"">\n        @RenderSection(""Footer"")\n    </h6>\n    <div class=""bg-info text-white m-2 p-1"">\n        This is part of the layout\n    </div>\n</body>\n</html>\nWhen the layout is applied, the RenderSection  expression inserts the content of the \nspecified section into the response. The regions of the view that are not contained \nwithin a section are inserted into the response by the RenderBody  method. To see how \nthe sections are applied, use a browser to request http://localhost:5000, which pro-\nvides the response shown in figure 22.10.\nFigure 22.10    Using sections in a layout\nNOTE    A view can define only the sections that are referred to in the layout. \nThe view engine throws an exception if you define sections in the view for which \nthere is no corresponding @RenderSection  expression in the layout.\nSections allow views to provide fragments of content to the layout without specifying \nhow they are used. As an example, listing 22.21 redefines the layout to consolidate the \nbody and sections into a single HTML table. \nListing 22.21    Using a table in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n618 chapter  22 Using controllers with views, part II \n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead>\n                <tr>\n                    <th class=""bg-primary text-white text-center""\n                            colspan=""2"">\n                        @RenderSection(""Header"")\n                    </th>\n                </tr>\n            </thead>\n            <tbody>\n                @RenderBody()\n            </tbody>\n            <tfoot>\n                <tr>\n                    <th class=""bg-primary text-white text-center"" \n                            colspan=""2"">\n                        @RenderSection(""Footer"")\n                    </th>\n                </tr>\n            </tfoot>\n        </table>\n    </div>\n</body>\n</html>\nTo see the effect of the change to the view, use a browser to request http://  \nlocalhost:5000, which will produce the response shown in figure 22.11.\nFigure 22.11    Changing how sections are displayed in a layout\nusing optional  layout  sections\nBy default, a view must contain all the sections for which there are RenderSection  \ncalls in the layout, and an exception will be thrown if the layout requires a section that \nthe view hasn’t defined. Listing 22.22 adds a call to the RenderSection  method that \nrequires a section named Summary . \n 619 Working with layouts\nListing 22.22    Adding a section in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead>\n                <tr>\n                    <th class=""bg-primary text-white text-center""\n                            colspan=""2"">\n                        @RenderSection(""Header"")\n                    </th>\n                </tr>\n            </thead>\n            <tbody>\n                @RenderBody()\n            </tbody>\n            <tfoot>\n                <tr>\n                    <th class=""bg-primary text-white text-center"" \n                            colspan=""2"">\n                        @RenderSection(""Footer"")\n                    </th>\n                </tr>\n            </tfoot>\n        </table>\n    </div>\n    @RenderSection(""Summary"")\n</body>\n</html>\nRestart ASP.NET Core and use a browser to request http://localhost:5000, and you will \nsee the exception shown in figure 22.12. You may have to restart the dotnet watch  \ncommand to see this error.\nFigure 22.12    Attempting to render a nonexistent view section\n620 chapter  22 Using controllers with views, part II \nThere are two ways to solve this problem. The first is to create an optional section, \nwhich will be rendered only if it is defined by the view. Optional sections are created by \npassing a second argument to the RenderSection  method, as shown in listing 22.23.\nListing 22.23    An optional section in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead>\n                <tr>\n                    <th class=""bg-primary text-white text-center""\n                            colspan=""2"">\n                        @RenderSection(""Header"", false)\n                    </th>\n                </tr>\n            </thead>\n            <tbody>\n                @RenderBody()\n            </tbody>\n            <tfoot>\n                <tr>\n                    <th class=""bg-primary text-white text-center"" \n                            colspan=""2"">\n                        @RenderSection(""Footer"", false)\n                    </th>\n                </tr>\n            </tfoot>\n        </table>\n    </div>\n    @RenderSection(""Summary"", false)\n</body>\n</html>\nThe second argument specifies whether a section is required, and using false  pre-\nvents an exception when the view doesn’t define the section. \ntesting  for layout  sections\nThe IsSectionDefined  method is used to determine whether a view defines a speci-\nfied section and can be used in an if expression to render fallback content, as shown \nin listing 22.24.\nListing 22.24    Checking a section in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n 621 Working with layouts\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead>\n                <tr>\n                    <th class=""bg-primary text-white text-center""\n                            colspan=""2"">\n                        @RenderSection(""Header"", false)\n                    </th>\n                </tr>\n            </thead>\n            <tbody>\n                @RenderBody()\n            </tbody>\n            <tfoot>\n                <tr>\n                    <th class=""bg-primary text-white text-center"" \n                            colspan=""2"">\n                        @RenderSection(""Footer"", false)\n                    </th>\n                </tr>\n            </tfoot>\n        </table>\n    </div>\n    @if (IsSectionDefined(""Summary"")) {\n        @RenderSection(""Summary"", false)\n    } else {\n        <div class=""bg-info text-center text-white m-2 p-2"">\n            This is the default summary\n        </div>\n    }\n</body>\n</html>\nThe IsSectionDefined  method is invoked with the name of the section you want to \ncheck and returns true  if the view defines that section. In the example, I used this \nhelper to render fallback content when the view does not define the Summary  section. \nTo see the fallback content, use a browser to request http://localhost:5000, which pro-\nduces the response shown in figure 22.13.\nFigure 22.13    \nDisplaying \nfallback content \nfor a view section",11162
259-22.5 Using partial views.pdf,259-22.5 Using partial views,,0
260-22.5.1 Enabling partial views.pdf,260-22.5.1 Enabling partial views,,0
261-22.5.3 Applying a partial view.pdf,261-22.5.3 Applying a partial view,"622 chapter  22 Using controllers with views, part II \n22.5 Using partial views\nYou will often need to use the same set of HTML elements and expressions in several \ndifferent places. Partial views  are views that contain fragments of content that will be \nincluded in other views to produce complex responses without duplication. \n22.5.1  Enabling partial views\nPartial views are applied using a feature called tag helpers , which are described in detail \nin chapter 25; tag helpers are configured in the view imports file, which was added \nto the project in chapter 21. To enable the feature required for partial views, add the \nstatement shown in listing 22.25 to the _ViewImports.cshtml  file. \nListing 22.25    Enabling tag helpers in the _ViewImports.cshtml file in the Views folder\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n22.5.2  Creating a partial view\nPartial views are just regular CSHTML files, and it is only the way they are used that \ndifferentiates them from standard views. If you are using Visual Studio, right-click the \nViews/Home  folder, select Add > New Item, and use the Razor View template to cre-\nate a file named _RowPartial.cshtml . Once the file has been created, replace the \ncontents with those shown in listing 22.26. If you are using Visual Studio Code, add a \nfile named _RowPartial.cshtml  to the Views/Home  folder and add to it the content \nshown in listing 22.26.\nTIP    Visual Studio provides some tooling support for creating prepopulated par-\ntial views, but the simplest way to create a partial view is to create a regular view \nusing the Razor View item template. \nListing 22.26    The contents of the _RowPartial.cshtml file in the Views/Home folder\n@model Product\n<tr>\n    <td>@Model.Name</td>\n    <td>@Model.Price</td>\n</tr>\nThe model  expression is used to define the view model type for the partial view, which \ncontains the same mix of expressions and HTML elements as regular views. The con-\ntent of this partial view creates a table row, using the Name  and Price  properties of a \nProduct  object to populate the table cells.\n 623 Using partial views\n22.5.3  Applying a partial view \nPartial views are applied by adding a partial  element in another view or layout. In list-\ning 22.27, I have added the element to the List.cshtml  file so the partial view is used \nto generate the rows in the table.  \nListing 22.27    Using a partial view in the List.cshtml file in the Views/Home folder\n@model IEnumerable<Product>\n@{\n    Layout = null;\n    decimal average = Model.Average(p => p.Price);\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <thead>\n                <tr><th>Name</th><th>Price</th></tr>\n            </thead>\n            <tbody>\n                @foreach (Product p in Model) {\n                    <partial name=""_RowPartial"" model=""p"" />\n                }\n            </tbody>\n        </table>\n    </div>\n</body>\n</html>\nThe attributes applied to the partial  element control the selection and configuration \nof the partial view, as described in table 22.2.\nTable 22.2    The partial element attributes\nName Description\nname This property specifies the name of the partial view, \nwhich is located using the same search process as regu-\nlar views.\nmodel This property specifies the value that will be used as the \nview model object for the partial view.\nfor This property is used to define an expression that selects \nthe view model object for the partial view, as explained \nnext.\nview-data This property is used to provide the partial view with addi-\ntional data.\n624 chapter  22 Using controllers with views, part II \nThe partial  element in listing 22.27 uses the name  attribute to select the _Row-\nPartial  view and the model  attribute to select the Product  object that will be used as \nthe view model object. The partial  element is applied within the @foreach  expres-\nsion, which means that it will be used to generate each row in the table, which you \ncan see by using a browser to request http://localhost:5000/home/list to produce the \nresponse shown in figure 22.14.\nFigure 22.14    Using a partial view\nselecting  the partial  view model  using  an expression\nThe for attribute is used to set the partial view’s model using an expression that is \napplied to the view’s model, which is a feature more easily demonstrated than \ndescribed. Add a partial view named _CellPartial.cshtml  to the Views/Home  folder \nwith the content shown in listing 22.28.\nListing 22.28    The contents of the _CellPartial.cshtml file in the Views/Home folder \n@model string\n<td class=""bg-info text-white"">@Model</td>\nThis partial view has a string view model object, which it uses as the contents of a table \ncell element; the table cell element is styled using the Bootstrap CSS framework. In list-\ning 22.29, I have added a partial  element to the _RowPartial.cshtml  file that uses \nthe _CellPartial  partial view to display the table cell for the name of the Product  \nobject.\nListing 22.29    Using a partial in the _RowPartial.cshtml file in the Views/Home folder\n@model Product\n<tr>\n    <partial name=""_CellPartial"" for=""Name"" />\n    <td>@Model.Price</td>\n</tr>",5512
262-22.6.1 Understanding HTML encoding.pdf,262-22.6.1 Understanding HTML encoding,"625 Understanding content-encoding\nThe for attribute selects the Name  property as the model for the _CellPartial  par-\ntial view. To see the effect, use a browser to request http://localhost:5000/home/list, \nwhich will produce the response shown in figure 22.15.\nFigure 22.15    Selecting a model property for use in a partial view\nUsing templated delegates\nTemplated delegates are an alternative way of avoiding duplication in a view. Templated \ndelegates are defined in a code block, like this:  \n...\n@{ \n    Func<Product, object> row \n        = @<tr><td>@item.Name</td><td>@item.Price</td></tr>;\n}\n...\nThe template is a function that accepts a Product  input object and returns a dynamic \nresult. Within the template expression, the input object is referred to as item  in expres-\nsions. The templated delegate is invoked as a method expression to generate content.\n...\n<tbody>\n    @foreach (Product p in Model) {\n        @row(p)\n    }\n</tbody>\n...\nI find this feature awkward and prefer using partial views, although this is a matter of \npreference and habit rather than any objective problems with the way that templated \ndelegates work.\n22.6 Understanding content-encoding\nRazor Views provide two useful features for encoding content. The HTML con-\ntent-encoding feature ensures that expression responses don’t change the structure \nof the response sent to the browser, which is an important security feature. The JSON \n626 chapter  22 Using controllers with views, part II \nencoding feature encodes an object as JSON and inserts it into the response, which can \nbe a useful debugging feature and can also be useful when providing data to JavaScript \napplications. Both encoding features are described in the following sections.  \n22.6.1  Understanding HTML encoding \nThe Razor View engine encodes expression results to make them safe to include in an \nHTML document without changing its structure. This is an important feature when \ndealing with content that is provided by users, who may try to subvert the application \nor accidentally enter dangerous content. Listing 22.30 adds an action method to the \nHome  controller that passes a fragment of HTML to the View  method.  \nListing 22.30    Adding an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            ViewBag.AveragePrice =\n                await context.Products.AverageAsync(p => p.Price);\n            return View(await context.Products.FindAsync(id));\n        }\n        public IActionResult List() {\n            return View(context.Products);\n        }\n        public IActionResult Html() {\n            return View((object)""This is a <h3><i>string</i></h3>"");\n        }\n    }\n}\nThe new action passes a string that contains HTML elements. To create the view for \nthe new action method, add a Razor View file named Html.cshtml  to the Views/Home  \nfolder with the content shown in listing 22.31.\nTIP    Notice that I cast the string passed to the View  method as an object, without \nwhich the string is assumed to be the name of a view and not the view model \nobject.\n 627 Understanding content-encoding\nListing 22.31    The contents of the Html.cshtml file in the Views/Home folder\n@model string\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-secondary text-white text-center m-2 p-2"">\n        @Model\n    </div>\n</body>\n</html>\nSave the file and use a browser to request http://localhost:5000/home/html. The \nresponse, which is shown on the left of figure 22.16, shows how the potentially danger-\nous characters in the view model string have been escaped.\nTo include the result of an expression without safe encoding, you can invoke the \nHtml.Raw  method. The Html  property is one of the properties added to the gener-\nated view class, described in chapter 21, which returns an object that implements the  \nIHtmlHelper  interface, as shown in listing 22.32.  \nListing 22.32    Disabling encoding in the Html.cshtml file in the Views/Home folder\n@model string\n@{ \n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-secondary text-white text-center m-2 p-2"">\n        @Html.Raw(Model)\n    </div>\n</body>\n</html>\nSave the changes, and you will see that the view model string is passed on without being \nencoded and is then interpreted by the browser as part of the HTML document, as \nshown on the right of figure 22.16.",4991
263-23 Using Razor Pages.pdf,263-23 Using Razor Pages,"628 chapter  22 Using controllers with views, part II \nFigure 22.16    HTML result encoding \nCAUTION     Do not disable safe encoding unless you are entirely confident that no \nmalicious content will be passed to the view. Careless use of this feature presents \na security risk to your application and your users.\n22.6.2  Understanding JSON encoding\nThe Json  property, which is added to the class generated from the view, as described in \nchapter 21, can be used to encode an object as JSON. The most common use for JSON \ndata is in RESTful web services, as described in earlier chapters, but I find the Razor \nJSON encoding feature useful as a debugging aid when I don’t get the output I expect \nfrom a view. Listing 22.33 adds a JSON representation of the view model object to the \noutput produced by the Index.cshtml view.  \nListing 22.33    Using JSON encoding in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_Layout"";\n    ViewBag.Title = ""Product Table"";\n}\n@section Header {\n    Product Information\n}\n<tr><th>Name</th><td>@Model?.Name</td></tr>\n<tr>\n    <th>Price</th>\n    <td>@Model?.Price.ToString(""c"")</td>\n</tr>\n<tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n@section Footer {\n    @(((Model?.Price / ViewBag.AveragePrice)\n            * 100).ToString(""F2""))% of average price\n}\n@section Summary {\n    <div class=""bg-info text-white m-2 p-2"">\n        @Json.Serialize(Model)\n    </div>\n}\n 629 Summary\nThe Json  property returns an implementation of the IJsonHelper  interface, whose \nSerialize  method produces a JSON representation of an object. Use a browser to \nrequest http://localhost:5000, and you will see the response shown in figure 22.17, \nwhich includes JSON in the Summary  section of the view.\nFigure 22.17    Encoding an expression result as JSON\nSummary\n¡ The view bag is used to pass unstructured data to a view, in addition to the view \nmodel.\n¡ Temp data is similar to the view bag but is deleted once the data values have been \nread.\n¡ Layouts define common content, such as the header of an HTML document.\n¡ The default layout can be specified by creating a view start file.\n¡ Layouts can contain sections, which can be optional or mandatory.\n¡ Partial views define sections of content that can be reused within views.\n63023Using Razor Pages\nThis chapter covers\n¡ Generating HTML content with Razor Pages\n¡ Routing HTTP requests to Razor Pages\n¡ Using single-file Razor Pages and using a  \n separate code-behind class file\n¡ Using layouts and partial views with Razor   \n Pages\nIn this chapter, I introduce how to use Razor Pages, which is a simpler approach to \ngenerating HTML content, intended to capture some of the enthusiasm for the leg-\nacy ASP.NET Web Pages framework. I explain how Razor Pages work, explain how \nthey differ from the controllers and views approach taken by the MVC Framework, \nand show you how they fit into the wider ASP.NET Core platform. \nThe process of explaining how Razor Pages work can minimize the differences \nfrom the controllers and views described in earlier chapters. You might form the \nimpression that Razor Pages are just MVC-lite and dismiss them, which would be a \nshame. Razor Pages are interesting because of the developer experience and not the \nway they are implemented.\nMy advice is to give Razor Pages a chance, especially if you are an experienced \nMVC developer. Although the technology used will be familiar, the process of cre-\nating application features is different and is well-suited to small and tightly focused \nfeatures that don’t require the scale and complexity of controllers and views. I have \n 631  \nbeen using the MVC Framework since it was first introduced, and I admit to ignoring \nthe early releases of Razor Pages. Now, however, I find myself mixing Razor Pages and \nthe MVC Framework in most projects, much as I did in the SportsStore example in part \n1. Table 23.1 puts Razor Pages in context.\nTable 23.1    Putting Razor Pages in context\nQuestion Answer\nWhat are they? Razor Pages are a simplified way of generating HTML \nresponses. \nWhy are they useful? The simplicity of Razor Pages means you can start getting \nresults sooner than with the MVC Framework, which \ncan require a relatively complex preparation process. \nRazor Pages are also easier for less experienced web \ndevelopers to understand because the relationship \nbetween the code and content is more obvious.\nHow are they used? Razor Pages associate a single view with the class that \nprovides it with features and use a file-based routing sys -\ntem to match URLs.\nAre there any pitfalls or limitations? Razor Pages are less flexible than the MVC Framework, \nwhich makes them unsuitable for complex applica-\ntions. Razor Pages can be used only to generate HTML \nresponses and cannot be used to create RESTful web \nservices.\nAre there any alternatives? The MVC Framework’s approach of controllers and views \ncan be used instead of Razor Pages.\nTable 23.2 provides a guide to the chapter.\nTable 23.2    Chapter guide\nProblem Solution Listing\nEnabling Razor Pages Use AddRazorPages  and MapRazor -\nPages  to set up the required services and \nmiddleware.3\nCreating a self-contained \nendpointCreate a Razor Page. 4, 26, 27\nRouting requests to a Razor \nPageUse the name of the page or specify a route \nusing the @page  directive.5–8\nProviding logic to support the \nview section of a Razor PageUse a page model class. 9–12\nCreating results that are not \nrendered using the view section \nof a Razor PageDefine a handler method that returns an \naction result.13–15\nHandling multiple HTTP \nmethodsDefine handlers in the page model class. 16–18\nAvoiding duplication of content Use a layout or a partial view. 19–25",5827
264-23.1 Preparing for this chapter.pdf,264-23.1 Preparing for this chapter,,0
265-23.2 Understanding Razor Pages.pdf,265-23.2 Understanding Razor Pages,"632 chapter  23 Using Razor Pages\n23.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 22. Open a new PowerShell com-\nmand prompt, navigate to the folder that contains the WebApp.csproj  file, and run \nthe command shown in listing 23.1 to drop the database.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 23.1    Dropping the database\ndotnet ef database drop --force\n23.1.1  Running the example application \nOnce the database has been dropped, use the PowerShell command prompt to run \nthe command shown in listing 23.2. \nListing 23.2    Running the example application \ndotnet run\nThe database will be seeded as part of the application startup. Once ASP.NET Core is \nrunning, use a web browser to request http://localhost:5000, which will produce the \nresponse shown in figure 23.1.\nFigure 23.1    Running the example application\nThe dotnet watch  command can be useful with Razor Pages development, but it \ndoesn’t handle the initial configuration of the services and middleware or changes to \nthe routing configuration, which is why I have returned to the dotnet run  command \nin this chapter.",1353
266-23.2.2 Creating a Razor Page.pdf,266-23.2.2 Creating a Razor Page,"633 Understanding Razor Pages\n23.2 Understanding Razor Pages\nAs you learn how Razor Pages work, you will see they share functionality with the MVC \nFramework. In fact, Razor Pages are typically described as a simplification of the  \nMVC Framework—which is true—but that doesn’t give any sense of why Razor Pages \ncan be useful.\nThe MVC Framework solves every problem in the same way: a controller defines \naction methods that select views to produce responses. It is a solution that works because \nit is so flexible: the controller can define multiple action methods that respond to dif-\nferent requests, the action method can decide which view will be used as the request is \nbeing processed, and the view can depend on private or shared partial views to produce \nits response.\nNot every feature in web applications needs the flexibility of the MVC Frame-\nwork. For many features, a single action method will be used to handle a wide range \nof requests, all of which are dealt with using the same view. Razor Pages offer a more \nfocused approach that ties together markup and C# code, sacrificing flexibility for \nfocus. \nBut Razor Pages have limitations. Razor Pages tend to start out focusing on a single \nfeature but slowly grow out of control as enhancements are made. And, unlike MVC \ncontrollers, Razor Pages cannot be used to create web services.\nYou don’t have to choose just one model because the MVC Framework and Razor \nPages coexist, as demonstrated in this chapter. This means that self-contained features \ncan be easily developed with Razor Pages, leaving the more complex aspects of an appli-\ncation to be implemented using the MVC controllers and actions. \nIn the sections that follow, I show you how to configure and use Razor Pages, and \nthen I explain how they work and demonstrate the common foundation they share with \nMVC controllers and actions.  \n23.2.1  Configuring Razor Pages\nTo prepare the application for Razor Pages, statements must be added to the  \nProgram.cs  file to set up services and configure the endpoint routing system, as shown \nin listing 23.3.  \nListing 23.3    Configuring the application in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\n634 chapter  23 Using Razor Pages\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(options => {\n    options.Cookie.IsEssential = true;\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllers();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe AddRazorPages  method sets up the service that is required to use Razor Pages, \nand the MapRazorPages  method creates the routing configuration that matches URLs \nto pages, which is explained later in the chapter.\n23.2.2  Creating a Razor Page \nRazor Pages are defined in the Pages  folder. If you are using Visual Studio, create the \nWebApp/Pages  folder, right-click it in the Solution Explorer, select Add > New Item \nfrom the pop-up menu, and select the Razor Page template, as shown in figure 23.2. \nSet the Name field to Index.cshtml  and click the Add button to create the file and \nreplace the contents of the file with those shown in listing 23.4. \nFigure 23.2    Creating a Razor Page \nIf you are using Visual Studio Code, create the WebApp/Pages  folder and add to it a \nnew file named Index.cshtml  with the content shown in listing 23.4.\n 635 Understanding Razor Pages\nListing 23.4    The contents of the Index.cshtml file in the Pages folder\n@page\n@model IndexModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Models;\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">\n        @Model.Product?.Name\n    </div>\n</body>\n</html>\n@functions {\n    public class IndexModel : PageModel {\n        private DataContext context;\n        public Product? Product { get; set; }\n        public IndexModel(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products.FindAsync(id);\n        }\n    }\n}\nRazor Pages use the Razor syntax that I described in chapters 21 and 22, and Razor \nPages even use the same CSHTML file extension. But there are some important \ndifferences.\nThe @page  directive must be the first thing in a Razor Page, which ensures that the \nfile is not mistaken for a view associated with a controller. But the most important dif-\nference is that the @functions  directive is used to define the C# code that supports the \nRazor content in the same file. I explain how Razor Pages work shortly, but to see the \noutput generated by the Razor Page, restart ASP.NET Core and use a browser to request \nhttp://localhost:5000/index, which produces the response shown in figure 23.3.\nFigure 23.3    \nUsing a Razor \nPage\n636 chapter  23 Using Razor Pages\nunderstanding  the url routing  convention  \nURL routing for Razor Pages is based on the file name and location, relative to the \nPages  folder. The Razor Page in listing 23.4 is in a file named Index.cshtml , in the \nPages  folder, which means that it will handle requests for the /index . The routing \nconvention can be overridden, as described in the “Understanding Razor Pages Rout-\ning” section, but, by default, it is the location of the Razor Page file that determines the \nURLs that it responds to.  \nunderstanding  the page model  \nIn a Razor Page, the @model  directive is used to select a page model  class, rather than \nidentifying the type of the object provided by an action method. The @model  directive \nin listing 23.4 selects the IndexModel  class .\n...\n@model IndexModel\n...\nThe page model is defined within the @functions  directive and is derived from the \nPageModel  class, like this:\n...\n@functions {\n    public class IndexModel: PageModel {\n...\nWhen the Razor Page is selected to handle an HTTP request, a new instance of the page \nmodel class is created, and dependency injection is used to resolve any dependencies \nthat have been declared using constructor parameters, using the features described in \nchapter 14. The IndexModel  class declares a dependency on the DataContext  service \ncreated in chapter 18, which allows it to access the data in the database.\n...\npublic IndexModel( DataContext ctx ) {\n    context = ctx;\n}\n...\nAfter the page model object has been created, a handler method is invoked. The \nname of the handler method is On, followed by the HTTP method for the request \nso that the OnGet  method is invoked when the Razor Page is selected to handle an \nHTTP GET request. Handler methods can be asynchronous, in which case a GET \nrequest will invoke the OnGetAsync  method, which is the method implemented by the  \nIndexModel  class.\n...\npublic async Task OnGetAsync (long id = 1) {\n    Product = await context.Products.FindAsync(id);\n}\n...\nValues for the handler method parameters are obtained from the HTTP request using \nthe model binding process, which is described in detail in chapter 28. The OnGet-\nAsync  method receives the value for its id parameters from the model binder, which it \nuses to query the database and assign the result to its Product  property.\n 637 Understanding Razor Pages\nunderstanding  the page view \nRazor Pages use the same mix of HTML fragments and code expressions to gener-\nate content, which defines the view presented to the user. The page model’s methods \nand properties are accessible in the Razor Page through the @Model  expression. The  \nProduct  property defined by the IndexModel  class is used to set the content of an \nHTML element, like this:  \n...\n<div class=""bg-primary text-white text-center m-2 p-2"">\n    @Model.Product?.Name\n</div>\n...\nThe @Model  expression returns an IndexModel  object, and this expression reads the \nName  property of the object returned by the Product  property. \nThe null conditional operator ( ?) isn’t required for the Model  property because it \nwill always be assigned an instance of the page model class and cannot be null . The \nproperties defined by the page model class can be null , however, which is why I have \nused the operator for the Product  property in the Razor expression:\n...\n<div class=""bg-primary text-white text-center m-2 p-2"">\n    @Model. Product? .Name\n</div>\n...\nunderstanding  the generated  c# class  \nBehind the scenes, Razor Pages are transformed into C# classes, just like regular Razor \nviews. Here is a simplified version of the C# class that is produced from the Razor Page \nin listing 23.4:  \nnamespace AspNetCoreGeneratedDocument {\n    using System;\n    using System.Collections.Generic;\n    using System.Linq;\n    using System.Threading.Tasks;\n    using Microsoft.AspNetCore.Mvc;\n    using Microsoft.AspNetCore.Mvc.Rendering;\n    using Microsoft.AspNetCore.Mvc.ViewFeatures;\n    using Microsoft.AspNetCore.Mvc.RazorPages;\n    using WebApp.Models;\n    internal sealed class Pages_Index : \n            Microsoft.AspNetCore.Mvc.RazorPages.Page {\n        \n        public async override global::System.Threading.Tasks.Task \n                 ExecuteAsync() {\n            WriteLiteral(""\r\n<!DOCTYPE html>\r\n<html>\r\n"");\n            __tagHelperExecutionContext = \n                __tagHelperScopeManager.Begin(""head"", \n                    TagMode.StartTagAndEndTag, ""7d534..."", \n                    async() => {\n638 chapter  23 Using Razor Pages\n                        WriteLiteral(""\r\n<link href=\"""" + \n                            ""/lib/bootstrap/css/bootstrap.min.css\"""" + \n                            ""rel=\""stylesheet\"" />\r\n"");\n                    });\n            HeadTagHelper = CreateTagHelper<TagHelpers.HeadTagHelper>();\n            __tagHelperExecutionContext.Add(HeadTagHelper);\n            Write(__tagHelperExecutionContext.Output);\n            WriteLiteral(""\r\n"");\n            __tagHelperExecutionContext = \n                __tagHelperScopeManager.Begin(""body"", \n                    TagMode.StartTagAndEndTag, ""7d534..."", async() => {\n                WriteLiteral(""\r\n<div class=\""bg-primary text-white "" + \n                    ""text-center m-2 p-2\"">"");\n                Write(Model.Product?.Name);\n                WriteLiteral(""</div>\r\n"");\n            });\n            BodyTagHelper = CreateTagHelper<TagHelpers.BodyTagHelper>();\n            __tagHelperExecutionContext.Add(BodyTagHelper);\n            Write(__tagHelperExecutionContext.Output);\n            WriteLiteral(""\r\n</html>\r\n\r\n"");\n        }\n        public class IndexModel: PageModel {\n            private DataContext context;\n            public Product? Product { get; set; }\n            public IndexModel(DataContext ctx) {\n                context = ctx;\n            }\n            public async Task OnGetAsync(long id = 1) {\n                Product = await context.Products.FindAsync(id);\n            }\n        }\n        \n        public IModelExpressionProvider ModelExpressionProvider \n            { get; private set; }\n        public IUrlHelper Url { get; private set; }\n        public IViewComponentHelper Component { get; private set; }\n        public IJsonHelper Json { get; private set; }\n        public IHtmlHelper<IndexModel> Html { get; private set; }\n        public ViewDataDictionary<IndexModel> ViewData => \n             (ViewDataDictionary<IndexModel>)PageContext?.ViewData;\n        public IndexModel Model => ViewData.Model;\n    }\n}\nIf you compare this code with the equivalent shown in chapter 21, you can see how \nRazor Pages rely on the same features used by the MVC Framework. The HTML frag-\nments and view expressions are transformed into calls to the WriteLiteral  and Write  \nmethods.\nTIP    The process for seeing the generated C# classes for Razor Pages is the same \nas for regular Razor Views, as described in chapter 21.",12537
267-23.3.1 Specifying a routing pattern in a Razor Page.pdf,267-23.3.1 Specifying a routing pattern in a Razor Page,"639 Understanding Razor Pages routing\n23.3 Understanding Razor Pages routing\nRazor Pages rely on the location of the CSHTML file for routing so that a request \nfor http://localhost:5000/index is handled by the Pages/Index.cshtml  file. Adding \na more complex URL structure for an application is done by adding folders whose \nnames represent the segments in the URL you want to support. As an example, create \nthe WebApp/Pages/Suppliers  folder and add to it a Razor Page named List.cshtml  \nwith the contents shown in listing 23.5.  \nListing 23.5    The contents of the List.cshtml file in the Pages/Suppliers folder\n@page\n@model ListModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Models;\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h5 class=""bg-primary text-white text-center m-2 p-2"">Suppliers</h5>\n    <ul class=""list-group m-2"">\n        @foreach (string s in Model.Suppliers) {\n            <li class=""list-group-item"">@s</li>\n        }\n    </ul>\n</body>\n</html>\n@functions {\n    public class ListModel : PageModel {\n        private DataContext context;\n        public IEnumerable<string> Suppliers { get; set; } \n            = Enumerable.Empty<string>();\n        public ListModel(DataContext ctx) {\n            context = ctx;\n        }\n        public void OnGet() {\n            Suppliers = context.Suppliers.Select(s => s.Name);\n        }\n    }\n}\nThe new page model class defines a Suppliers  property that is set to the sequence \nof Name  values for the Supplier  objects in the database. The database operation in \nthis example is synchronous, so the page model class defined the OnGet  method, \nrather than OnGetAsync . The supplier names are displayed in a list using an @foreach  \nexpression. To use the new Razor Page, restart ASP.NET Core and use a browser to \n640 chapter  23 Using Razor Pages\nrequest http://localhost:5000/suppliers/list, which produces the response shown in \nfigure 23.4. The path segments of the request URL correspond to the folder and file \nname of the List.cshtml  Razor Page.\nFigure 23.4    Using a folder structure to route requests\nUnderstanding the default URL handling \nThe MapRazorPages  method sets up a route for the default URL for the Index.cshtml  \nRazor Page, following a similar convention used by the MVC Framework. It is for this \nreason that the first Razor Page added to a project is usually called Index.cshtml . \nHowever, when the application mixes Razor Pages and the MVC Framework together, the \ndefault route defined by Razor Pages takes precedence because it was created with a \nlower order (route ordering is described in chapter 13). This means a request http://\nlocalhost:5000 is handled by the Index.cshtml  Razor Page in the example project and \nnot the Index  action on the Home  controller. \nIf you want the MVC framework to handle the default URL, then you can change the order \nassigned to the Razor Pages routes, like this:\n...\napp.MapRazorPages() .Add(b => ((RouteEndpointBuilder)b).Order = 2) ; \n...\nThe Razor Pages routes are created with an Order  of 0, which gives them precedence \nover the MVC routes, which are created with an Order  of 1. Assigning an Order  of 2 \ngives the MVC framework routes precedence.\nIn my own projects, where I mix Razor Pages and MVC controllers, I tend to rely on the \nMVC Framework to handle the default URL, and I avoid creating the Index.cshtml  \nRazor Page to avoid confusion.\n23.3.1  Specifying a routing pattern in a Razor Page \nUsing the folder and file structure to perform routing means there are no segment \nvariables for the model binding process to use. Instead, values for the request han-\ndler methods are obtained from the URL query string, which you can see by using a \nbrowser to request http://localhost:5000/index?id=2, which produces the response \nshown in figure 23.5. \n 641 Understanding Razor Pages routing\nFigure 23.5    Using a query string parameter\nThe query string provides a parameter named id, which the model binding process \nuses to satisfy the id parameter defined by the OnGetAsync  method in the Index  \nRazor Page.  \n...\npublic async Task OnGetAsync( long id = 1 ) {\n...\nI explain how model binding works in detail in chapter 28, but for now, it is enough \nto know that the query string parameter in the request URL is used to provide the id \nargument when the OnGetAsync  method is invoked, which is used to query the data-\nbase for a product.\nThe @page  directive can be used with a routing pattern, which allows segment vari-\nables to be defined, as shown in listing 23.6.\nListing 23.6    Defining a segment variable in the Index.cshtml file in the Pages folder \n@page ""{id:long?}""\n@model IndexModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Models;\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">\n        @Model.Product?.Name\n    </div>\n</body>\n</html>\n@functions {\n    // ...statements omitted for brevity...\n}\nAll the URL pattern features that are described in chapter 13 can be used with the  \n@page  directive. The route pattern used in listing 23.6 adds an optional segment vari-\nable named id, which is constrained so that it will match only those segments that can \nbe parsed to a long  value. To see the change, restart ASP.NET Core and use a browser",5555
268-23.3.2 Adding routes for a Razor Page.pdf,268-23.3.2 Adding routes for a Razor Page,"642 chapter  23 Using Razor Pages\nto request http://localhost:5000/index/4, which produces the response shown on the \nleft of figure 23.6.\nThe @page  directive can also be used to override the file-based routing convention \nfor a Razor Page, as shown in listing 23.7.\nListing 23.7    Changing the route in the List.cshtml file in the Pages/Suppliers folder\n@page ""/lists/suppliers""\n@model ListModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Models;\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <h5 class=""bg-primary text-white text-center m-2 p-2"">Suppliers</h5>\n    <ul class=""list-group m-2"">\n        @foreach (string s in Model.Suppliers) {\n            <li class=""list-group-item"">@s</li>                \n        }\n    </ul>\n</body>\n</html>\n@functions {\n    // ...statements omitted for brevity...\n}\nThe directive changes the route for the List  page so that it matches URLs whose path \nis /lists/suppliers . To see the effect of the change, restart ASP.NET Core and \nrequest http://localhost:5000/lists/suppliers, which produces the response shown on \nthe right of figure 23.6.\nFigure 23.6    Changing routes using the @page directive\n23.3.2  Adding routes for a Razor Page \nUsing the @page  directive replaces the default file-based route for a Razor Page. If you \nwant to define multiple routes for a page, then configuration statements can be added \nto the Program.cs  file, as shown in listing 23.8.  \n 643 Understanding Razor Pages routing\nListing 23.8    Adding Razor Page routes in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(options => {\n    options.Cookie.IsEssential = true;\n});\nbuilder.Services.Configure<RazorPagesOptions>(opts => {\n    opts.Conventions.AddPageRoute(""/Index"", ""/extra/page/{id:long?}"");\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllers();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe options pattern is used to add additional routes for a Razor Page using the \nRazorPageOptions  class. The AddPageRoute  extension method is called on the  \nConventions  property to add a route for a page. The first argument is the path to the \npage, without the file extension and relative to the Pages  folder. The second argu-\nment is the URL pattern to add to the routing configuration. To test the new route, \nrestart ASP.NET Core and use a browser to request http://localhost:5000/extra/\npage/2, which is matched by the URL pattern added in listing 23.8 and produces the \nresponse shown on the left of figure 23.7. The route added in listing 23.8 supplements \nthe route defined by the @page  attribute, which you can test by requesting http://  \nlocalhost:5000/index/2, which will produce the response shown on the right of figure \n23.7.",3516
269-23.4 Understanding the Page model class.pdf,269-23.4 Understanding the Page model class,,0
270-23.4.1 Using a code-behind class file.pdf,270-23.4.1 Using a code-behind class file,"644 chapter  23 Using Razor Pages\nFigure 23.7    Adding a route for a Razor Page \n23.4 Understanding the Page model class\nPage models are derived from the PageModel  class, which provides the link between \nthe rest of ASP.NET Core and the view part of the Razor Page. The PageModel  class \nprovides methods for managing how requests are handled and properties that provide \ncontext data, the most useful of which are described in table 23.3. I have listed these \nproperties for completeness, but they are not often required in Razor Page develop-\nment, which focuses more on selecting the data that is required to render the view part \nof the page.  \nTable 23.3    Selected PageModel properties for context data\nName Description\nHttpContext This property returns an HttpContext  object, described in chapter 12.\nModelState This property provides access to the model binding and validation features \ndescribed in chapters 28 and 29.\nPageContext This property returns a PageContext  object that provides access to \nmany of the same properties defined by the PageModel  class, along with \nadditional information about the current page selection.\nRequest This property returns an HttpRequest  object that describes the current \nHTTP request, as described in chapter 12.\nResponse This property returns an HttpResponse  object that represents the cur-\nrent response, as described in chapter 12.\nRouteData This property provides access to the data matched by the routing system, \nas described in chapter 13.\nTempData This property provides access to the temp data feature, which is used to \nstore data until it can be read by a subsequent request. See chapter 22 for \ndetails.\nUser This property returns an object that describes the user associated with the \nrequest, as described in chapter 38. \n23.4.1  Using a code-behind class file \nThe @functions  directive allows the page-behind class and the Razor content to be \ndefined in the same file, which is a development approach used by popular client-side \nframeworks, such as React or Vue.js. \n 645 Understanding the Page model class\nDefining code and markup in the same file is convenient but can become difficult to \nmanage for more complex applications. Razor Pages can also be split into separate view \nand code files, which is similar to the MVC examples in previous chapters and is rem-\niniscent of ASP.NET Web Pages, which defined C# classes in files known as code-behind \nfiles. The first step is to remove the page model class from the CSHTML file, as shown in \nlisting 23.9. I have also removed the @using  expressions, which are no longer required.\nListing 23.9    Removing the Page model class in the Index.cshtml file in the Pages folder\n@page ""{id:long?}""\n@model WebApp.Pages.IndexModel\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">\n        @Model.Product?.Name\n    </div>\n</body>\n</html>\nThe @model  expression has been modified to specify the namespace of the page model, \nwhich wasn’t required previously because the @functions  expression defined the \nIndexModel  class within the namespace of the view. When defining the separate page \nmodel class, I define the class in the WebApp.Pages  namespace. This isn’t a require-\nment, but it makes the C# class consistent with the rest of the application. \nThe convention for naming Razor Pages code-behind files is to append the .cs file \nextension to the name of the view file. If you are using Visual Studio, the code-behind \nfile was created by the Razor Page template when the Index.cshtml  file was added to \nthe project. Expand the Index.cshtml  item in the Solution Explorer, and you will see \nthe code-behind file, as shown in figure 23.8. Open the file for editing and replace the \ncontents with the statements shown in listing 23.10.\nFigure 23.8    Revealing the code-behind file in the Visual Studio Solution Explorer \n646 chapter  23 Using Razor Pages\nIf you are using Visual Studio Code, add a file named Index.cshtml.cs  to the \nWebApp/Pages  folder with the content shown in listing 23.10.\nListing 23.10    The contents of the Index.cshtml.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing WebApp.Models;\nnamespace WebApp.Pages {\n    public class IndexModel : PageModel {\n        private DataContext context;\n        public Product? Product { get; set; }\n        public IndexModel(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products.FindAsync(id);\n        }\n    }\n}\nRestart ASP.NET Core and request http://localhost:5000/index to ensure the code-  \nbehind file is used, producing the response shown in figure 23.9.\nFigure 23.9    Using a code-behind file  \nadding  a view imports  file \nA view imports file can be used to avoid using the fully qualified name for the page \nmodel class in the view file, performing the same role as the one I used in chapter 22 \nfor the MVC Framework. If you are using Visual Studio, use the Razor View Imports \ntemplate to add a file named _ViewImports.cshtml  to the WebApp/Pages  folder, \nwith the content shown in listing 23.11. If you are using Visual Studio Code, add the \nfile directly.\nListing 23.11    The contents of the _ViewImports.cshtml file in the Pages folder\n@namespace WebApp.Pages\n@using WebApp.Models\nThe @namespace  directive sets the namespace for the C# class that is generated by a \nview, and using the directive in the view imports file sets the default namespace for all",5710
271-23.4.2 Understanding action results in Razor Pages.pdf,271-23.4.2 Understanding action results in Razor Pages,"647 Understanding the Page model class\nthe Razor Pages in the application, with the effect that the view and its page model \nclass are in the same namespace and the @model  directive does not require a fully qual-\nified type, as shown in listing 23.12.\nListing 23.12    Removing the namespace in the Index.cshtml file in the Pages folder\n@page ""{id:long?}""\n@model IndexModel\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">\n        @Model.Product?.Name\n    </div>\n</body>\n</html>\nRestart ASP.NET Core and use the browser to request http://localhost:5000/index. \nThere is no difference in the response produced by the Razor Page, which is shown in \nfigure 23.9.\n23.4.2  Understanding action results in Razor Pages \nAlthough it is not obvious, Razor Page handler methods use the same IActionResult  \ninterface to control the responses they generate. To make page model classes easier \nto develop, handler methods have an implied result that displays the view part of the \npage. Listing 23.13 makes the result explicit.  \nListing 23.13    Using an explicit result in the Index.cshtml.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Pages {\n    public class IndexModel : PageModel {\n        private DataContext context;\n        public Product? Product { get; set; }\n        public IndexModel(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> OnGetAsync(long id = 1) {\n            Product = await context.Products.FindAsync(id);\n            return Page();\n        }\n    }\n}\n648 chapter  23 Using Razor Pages\nThe Page  method is inherited from the PageModel  class and creates a PageResult  \nobject, which tells the framework to render the view part of the page. Unlike the View  \nmethod used in MVC action methods, the Razor Pages Page  method doesn’t accept \narguments and always renders the view part of the page that has been selected to han-\ndle the request.\nThe PageModel  class provides other methods that create different action results to \nproduce different outcomes, as described in table 23.4.\nTable 23.4    The PageModel action result methods \nName Description\nPage() This IActionResult  returned by this method  \nproduces a 200 OK status code and renders the view \npart of the Razor Page.\nNotFound() The IActionResult  returned by this method pro-\nduces a 404 NOT FOUND status code.\nBadRequest(state) The IActionResult  returned by this method produces \na 400 BAD REQUEST status code. The method accepts \nan optional model state object that describes the prob-\nlem to the client, as demonstrated in chapter 19.\nFile(name, type) The IActionResult  returned by this method pro-\nduces a 200 OK response, sets the Content-Type  \nheader to the specified type, and sends the specified file \nto the client.\nRedirect(path) \nRedirectPermanent(path)The IActionResult  returned by these methods \nproduces 302 FOUND and 301 MOVED PERMANENTLY \nresponses, which redirect the client to the specified URL.\nRedirectToAction(name) \nRedirectToActionPermanent(name)The IActionResult  returned by these methods \nproduces 302 FOUND and 301 MOVED PERMANENTLY \nresponses, which redirect the client to the specified \naction method. The URL used to redirect the client is pro-\nduced using the routing features described in chapter 13.\nRedirectToPage(name) \nRedirectToPagePermanent(name)The IActionResult  returned by these methods \nproduce 302 FOUND and 301 MOVED PERMANENTLY \nresponses that redirect the client to another Razor Page. \nIf no name is supplied, the client is redirected to the  \ncurrent page.\nStatusCode(code) The IActionResult  returned by this method pro-\nduces a response with the specific status code.\nusing an action  result\nExcept for the Page  method, the methods in table 23.4 are the same as those available \nin action methods. However, care must be taken with these methods because sending \na status code response is unhelpful in Razor Pages because they are used only when a \nclient expects the content of the view.\nInstead of using the NotFound  method when requested data cannot be found, \nfor example, a better approach is to redirect the client to another URL that can \n 649 Understanding the Page model class\ndisplay an HTML message for the user. The redirection can be to a static HTML file, to \nanother Razor Page, or to an action defined by a controller. Add a Razor Page named  \nNotFound.cshtml  to the Pages  folder and add the content shown in listing 23.14.\nListing 23.14    The contents of the NotFound.cshtml file in the Pages folder\n@page ""/noid""\n@model NotFoundModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Models;\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <title>Not Found</title>\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">\n        No Matching ID\n    </div>\n    <ul class=""list-group m-2"">\n        @foreach (Product p in Model.Products) {\n                <li class=""list-group-item"">\n                    @p.Name (ID: @p.ProductId)\n                </li>                \n        }\n    </ul>    \n</body>\n</html>\n@functions {\n    public class NotFoundModel : PageModel {\n        private DataContext context;\n        public IEnumerable<Product> Products { get; set; }\n            = Enumerable.Empty<Product>();\n        public NotFoundModel(DataContext ctx) {\n            context = ctx;\n        }\n        public void OnGetAsync(long id = 1) {\n            Products = context.Products;\n        }\n    }\n}\nThe @page  directive overrides the route convention so that this Razor Page will handle \nthe /noid  URL path. The page model class uses an Entity Framework Core context \nobject to query the database and displays a list of the product names and key values \nthat are in the database. \n650 chapter  23 Using Razor Pages\nIn listing 23.15, I have updated the handle method of the IndexModel  class to redi-\nrect the user to the NotFound  page when a request is received that doesn’t match a \nProduct  object in the database.  \nListing 23.15    Using a redirection in the Index.cshtml.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Pages {\n    public class IndexModel : PageModel {\n        private DataContext context;\n        public Product? Product { get; set; }\n        public IndexModel(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task<IActionResult> OnGetAsync(long id = 1) {\n            Product = await context.Products.FindAsync(id);\n            if (Product == null) {\n                return RedirectToPage(""NotFound"");\n            }\n            return Page();\n        }\n    }\n}\nThe RedirectToPage  method produces an action result that redirects the client to a \ndifferent Razor Page. The name of the target page is specified without the file exten-\nsion, and any folder structure is specified relative to the Pages  folder. To test the redi-\nrection, restart ASP.NET Core and request http://localhost:5000/index/500, which \nprovides a value of 500 for the id segment variable and does not match anything in the \ndatabase. The browser will be redirected and produce the result shown in figure 23.10.\nFigure 23.10    Redirecting to a different Razor Page",7653
272-23.4.3 Handling multiple HTTP methods.pdf,272-23.4.3 Handling multiple HTTP methods,"651 Understanding the Page model class\nNotice that the routing system is used to produce the URL to which the client is redi-\nrected, which uses the routing pattern specified with the @page  directive. In this exam-\nple, the argument to the RedirectToPage  method was NotFound , but this has been \ntranslated into a redirection to the /noid  path specified by the @page  directive in list-\ning 23.14.\n23.4.3  Handling multiple HTTP methods\nRazor Pages can define handler methods that respond to different HTTP methods. \nThe most common combination is to support the GET and POST methods that allow \nusers to view and edit data. To demonstrate, add a Razor Page called Editor.cshtml  \nto the Pages  folder and add the content shown in listing 23.16. \nNOTE     I have kept this example as simple as possible, but there are excellent \nASP.NET Core features for creating HTML forms and for receiving data when it \nis submitted, as described in chapter 31. \nListing 23.16    The contents of the Editor.cshtml file in the Pages folder\n@page ""{id:long}""\n@model EditorModel\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">Editor</div>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Product?.Name</td></tr>\n                <tr><th>Price</th><td>@Model.Product?.Price</td></tr>\n            </tbody>\n        </table>\n        <form method=""post"">\n            @Html.AntiForgeryToken()\n            <div class=""form-group"">\n                <label>Price</label>\n                <input name=""price"" class=""form-control""\n                       value=""@Model.Product?.Price"" />\n            </div>\n            <button class=""btn btn-primary mt-2"" type=""submit"">\n                Submit\n            </button>\n        </form>\n    </div>\n</body>\n</html>\n652 chapter  23 Using Razor Pages\nThe elements in the Razor Page view create a simple HTML form that presents \nthe user with an input element containing the value of the Price  property for a  \nProduct  object. The form  element is defined without an action attribute, which means \nthe browser will send a POST request to the Razor Page’s URL when the user clicks the \nSubmit button.\nNOTE    The @Html.AntiForgeryToken()  expression in listing 23.16 adds a hid-\nden form field to the HTML form that ASP.NET Core uses to guard against cross-\nsite request forgery (CSRF) attacks. I explain how this feature works in chapter \n27, but for this chapter, it is enough to know that POST requests that do not \ncontain this form field will be rejected.\nIf you are using Visual Studio, expand the Editor.cshtml  item in the Solution \nExplorer to reveal the Editor.cshtml.cs  class file and replace its contents with the \ncode shown in listing 23.17. If you are using Visual Studio Code, add a file named  \nEditor.cshtml.cs  to the WebApp/Pages  folder and use it to define the class shown \nin listing 23.17.\nListing 23.17    The contents of the Editor.cshtml.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing WebApp.Models;\nnamespace WebApp.Pages {\n    public class EditorModel : PageModel {\n        private DataContext context;\n        public Product? Product { get; set; }\n        public EditorModel(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task OnGetAsync(long id) {\n            Product = await context.Products.FindAsync(id);\n        }\n        public async Task<IActionResult> OnPostAsync(long id, \n                decimal price) {\n            Product? p = await context.Products.FindAsync(id);\n            if (p != null) {\n                p.Price = price;\n            }\n            await context.SaveChangesAsync();\n            return RedirectToPage();\n        }\n    }\n}\nThe page model class defines two handler methods, and the name of the method \ntells the Razor Pages framework which HTTP method each handles. The OnGetAsync",4171
273-23.4.4 Selecting a handler method.pdf,273-23.4.4 Selecting a handler method,"653 Understanding the Page model class\nmethod is used to handle GET requests, which it does by locating a Product , whose \ndetails are displayed by the view. \nThe OnPostAsync  method is used to handle POST requests, which will be sent by the \nbrowser when the user submits the HTML form. The parameters for the OnPostAsync  \nmethod are obtained from the request so that the id value is obtained from the URL \nroute and the price  value is obtained from the form. (The model binding feature that \nextracts data from forms is described in chapter 28.)\nUnderstanding the POST Redirection\nNotice that the last statement in the OnPostAsync  method invokes the Redirect -\nToPage  method without an argument, which redirects the client to the URL for the Razor \nPage. This may seem odd, but the effect is to tell the browser to send a GET request to \nthe URL it used for the POST request. This type of redirection means that the browser \nwon’t resubmit the POST request if the user reloads the browser, preventing the same \naction from being accidentally performed more than once.\nTo see how the page model class handles different HTTP methods, restart ASP.NET \nCore and use a browser to navigate to http://localhost:5000/editor/1. Edit the field to \nset the price to 100 and click the Submit button. The browser will send a POST request \nthat is handled by the OnPostAsync  method. The database will be updated, and the \nbrowser will be redirected so that the updated data is displayed, as shown in figure \n23.11.\nFigure 23.11    Handling multiple HTTP methods\n23.4.4  Selecting a handler method\nThe page model class can define multiple handler methods, allowing the request to \nselect a method using a handler  query string parameter or routing segment variable. \nTo demonstrate this feature, add a Razor Page file named HandlerSelector.cshtml  \nto the Pages  folder with the content shown in listing 23.18.  \n654 chapter  23 Using Razor Pages\nListing 23.18    The contents of the HandlerSelector.cshtml file in the Pages folder\n@page\n@model HandlerSelectorModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">Selector</div>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr><th>Name</th><td>@Model.Product?.Name</td></tr>\n                <tr><th>Price</th><td>@Model.Product?.Price</td></tr>\n                <tr>\n                    <th>Category</th>\n                    <td>@Model.Product?.Category?.Name</td>\n                </tr>\n                <tr>\n                    <th>Supplier</th>\n                    <td>@Model.Product?.Supplier?.Name</td>\n                </tr>\n            </tbody>\n        </table>\n        <a href=""/handlerselector"" class=""btn btn-primary"">Standard</a>\n        <a href=""/handlerselector?handler=related"" \n                class=""btn btn-primary"">\n            Related\n        </a>\n    </div>\n</body>\n</html>\n@functions {\n    public class HandlerSelectorModel : PageModel {\n        private DataContext context;\n        public Product? Product { get; set; }\n        public HandlerSelectorModel(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products.FindAsync(id);\n        }\n        public async Task OnGetRelatedAsync(long id = 1) {\n            Product = await context.Products\n                .Include(p => p.Supplier)\n 655 Understanding the Page model class\n                .Include(p => p.Category)\n                .FirstOrDefaultAsync(p => p.ProductId == id);\n            if (Product != null && Product.Supplier != null) {\n                Product.Supplier.Products = null;\n            }\n            if (Product != null && Product.Category != null) {\n                Product.Category.Products = null;\n            }\n        }\n    }\n}\nThe page model class in this example defines two handler methods: OnGetAsync  and \nOnGetRelatedAsync . The OnGetAsync  method is used by default, which you can see \nby restarting ASP.NET Core and using a browser to request http://localhost:5000/\nhandlerselector. The handler method queries the database and presents the result to \nthe user, as shown on the left of figure 23.12.\nOne of the anchor elements rendered by the page targets a URL with a handler \nquery string parameter, like this:\n...\n<a href="" /handlerselector?handler=related "" class=""btn btn-primary""> \n    Related \n</a>\n...\nThe name of the handler method is specified without the On[method]  prefix and with-\nout the Async  suffix so that the OnGetRelatedAsync  method is selected using a han-\ndler value of related . This alternative handler method includes related data in its \nquery and presents additional data to the user, as shown on the right of figure 23.12.\nFigure 23.12    Selecting handler methods\nUsing rate limiting and output caching \nIn chapters 19 and 21, I demonstrated the use of the ASP.NET Core attributes for apply-\ning rate limits and output caching to controllers. These attributes can also be applied to \npage model classes, providing Razor Pages with the same features available in the MVC \nFramework.",5448
274-23.5 Understanding the Razor Page view.pdf,274-23.5 Understanding the Razor Page view,,0
275-23.5.1 Creating a layout for Razor Pages.pdf,275-23.5.1 Creating a layout for Razor Pages,"656 chapter  23 Using Razor Pages\n23.5 Understanding the Razor Page view \nThe view part of a Razor Page uses the same syntax and has the same features as the \nviews used with controllers. Razor Pages can use the full range of expressions and fea-\ntures such as sessions, temp data, and layouts. Aside from the use of the @page  directive \nand the page model classes, the only differences are a certain amount of duplication \nto configure features such as layouts and partial views, as described in the sections that \nfollow.\n23.5.1  Creating a layout for Razor Pages\nLayouts for Razor Pages are created in the same way as for controller views but in the \nPages/Shared  folder. If you are using Visual Studio, create the Pages/Shared  folder \nand add to it a file named _Layout.cshtml  using the Razor Layout template with the \ncontents shown in listing 23.19. If you are using Visual Studio Code, create the Pages/\nShared  folder, create the _ Layout.cshtml  file in the new folder, and add the content \nshown in listing 23.19.  \nNOTE    Layouts can be created in the same folder as the Razor Pages that use \nthem, in which case they will be used in preference to the files in the Shared  \nfolder. \nListing 23.19    The contents of the _Layout.cshtml file in the Pages/Shared folder \n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <title>@ViewBag.Title</title>\n</head>\n<body>\n    <h5 class=""bg-secondary text-white text-center m-2 p-2"">\n        Razor Page\n    </h5>\n    @RenderBody()\n</body>\n</html>\nThe layout doesn’t use any features that are specific to Razor Pages and contains the \nsame elements and expressions used in chapter 22 when I created a layout for the con-\ntroller views. \nNext, use the Razor View Start template to add a file named _ViewStart.cshtml  \nto the Pages  folder. Visual Studio will create the file with the content shown in listing \n23.20. If you are using Visual Studio Code, create the _ViewStart.cshtml  file and add \nthe content shown in listing 23.20.\nListing 23.20    The contents of the _ViewStart.cshtml file in the Pages folder \n@{\n    Layout = ""_Layout"";\n}\n 657 Understanding the Razor Page view \nThe C# classes generated from Razor Pages are derived from the Page  class, which pro-\nvides the Layout  property used by the view start file, which has the same purpose as the \none used by controller views. In listing 23.21, I have updated the Index  page to remove \nthe elements that will be provided by the layout.\nListing 23.21    Removing elements in the Index.cshtml file in the Pages folder\n@page ""{id:long?}""\n@model IndexModel\n<div class=""bg-primary text-white text-center m-2 p-2"">\n    @Model.Product?.Name\n</div>\nUsing a view start file applies the layout to all pages that don’t override the value \nassigned to the Layout  property. In listing 23.22, I have added a code block to the  \nEditor  page so that it doesn’t use a layout.\nListing 23.22    Disabling layouts in the Editor.cshtml file in the Pages folder\n@page ""{id:long}""\n@model EditorModel\n@{ \n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <! ...elements omitted for brevity ... />\n</body>\n</html>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/index, and \nyou will see the effect of the new layout, which is shown on the left of figure 23.13. Use \nthe browser to request http://localhost:5000/editor/1, and you will receive content \nthat is generated without the layout, as shown on the right of figure 23.13.\nFigure 23.13    \nUsing a layout in \nRazor Pages",3726
276-23.5.3 Creating Razor Pages without page models.pdf,276-23.5.3 Creating Razor Pages without page models,"658 chapter  23 Using Razor Pages\n23.5.2  Using partial views in Razor Pages\nRazor Pages can use partial views so that common content isn’t duplicated. The exam-\nple in this section relies on the tag helpers feature, which I describe in detail in chapter \n25. For this chapter, add the directive shown in listing 23.23 to the view imports file, \nwhich enables the custom HTML element used to apply partial views.  \nListing 23.23    Enabling tag helpers in the _ViewImports.cshtml file in the Pages folder \n@namespace WebApp.Pages\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\nNext, add a Razor view named _ProductPartial.cshtml  in the Pages/Shared  folder \nand add the content shown in listing 23.24.\nListing 23.24    The _ProductPartial.cshtml File in the Pages/Shared Folder\n@model Product\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <tbody>\n            <tr><th>Name</th><td>@Model?.Name</td></tr>\n            <tr><th>Price</th><td>@Model?.Price</td></tr>\n        </tbody>\n    </table>\n</div>\nNotice there is nothing specific to Razor Pages in the partial view. Partial views use the \n@model  directive to receive a view model object and do not use the @page  directive or \nhave page models, both of which are specific to Razor Pages. This allows Razor Pages to \nshare partial views with MVC controllers, as described in the sidebar.\nUnderstanding the partial method search path\nThe Razor view engine starts looking for a partial view in the same folder as the Razor \nPage that uses it. If there is no matching file, then the search continues in each par -\nent directory until the Pages  folder is reached. For a partial view used by a Razor Page \ndefined in the Pages/App/Data  folder, for example, the view engine looks in the \nPages/App/Data  folder, the Page/App  folder, and then the Pages  folder. If no file is \nfound, the search continues to the Pages/Shared  folder and, finally, to the Views/\nShared  folder.\nThe last search location allows partial views defined for use with controllers to be used \nby Razor Pages, which is a useful feature for avoiding duplicate content in applications \nwhere MVC controllers and Razor Pages are both used.\nPartial views are applied using the partial  element, as shown in listing 23.25, with the \nname  attribute specifying the name of the view and the model  attribute providing the \nview model.\n 659 Understanding the Razor Page view \nCAUTION     Partial views receive a view model through their @model  directive and \nnot a page model. It is for this reason that the value of the model attribute is \nModel.Product  and not just Model .\nListing 23.25    Using a partial view in the Index.cshtml file in the Pages folder\n@page ""{id:long?}""\n@model IndexModel\n<div class=""bg-primary text-white text-center m-2 p-2"">\n    @Model.Product?.Name\n</div>\n<partial name=""_ProductPartial"" model=""Model.Product"" />\nWhen the Razor Page is used to handle a response, the contents of the partial view are \nincorporated into the response. Restart ASP.NET Core and use a browser to request \nhttp://localhost:5000/index, and the response includes the table defined in the par-\ntial view, as shown in figure 23.14.\nFigure 23.14    Using a partial view \n23.5.3  Creating Razor Pages without page models\nIf a Razor Page is simply presenting data to the user, the result can be a page model \nclass that simply declares a constructor dependency to set a property that is consumed \nin the view. To understand this pattern, add a Razor Page named Data.cshtml  to the \nWebApp/Pages  folder with the content shown in listing 23.26.\nListing 23.26    The contents of the Data.cshtml file in the Pages folder\n@page\n@model DataPageModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n<h5 class=""bg-primary text-white text-center m-2 p-2"">Categories</h5>\n<ul class=""list-group m-2"">\n    @foreach (Category c in Model.Categories) {\n        <li class=""list-group-item"">@c.Name</li>                \n660 chapter  23 Using Razor Pages\n    }\n</ul>\n@functions {\n    public class DataPageModel : PageModel {\n        private DataContext context;\n        public IEnumerable<Category> Categories { get; set; }\n            = Enumerable.Empty<Category>();\n        public DataPageModel(DataContext ctx) {\n            context = ctx;\n        }\n        public void OnGet() {\n            Categories = context.Categories;\n        }\n    }\n}\nThe page model in this example doesn’t transform data, perform calculations, or do \nanything other than giving the view access to the data through dependency injection. \nTo avoid this pattern, where a page model class is used only to access a service, the  \n@inject  directive can be used to obtain the service in the view, without the need for a \npage model, as shown in listing 23.27.  \nCAUTION     The @inject  directive should be used sparingly and only when the \npage model class adds no value other than to provide access to services. In all \nother situations, using a page model class is easier to manage and maintain.\nListing 23.27    Accessing a service in the Data.cshtml file in the Pages folder\n@page\n@inject DataContext context;\n<h5 class=""bg-primary text-white text-center m-2 p-2"">Categories</h5>\n<ul class=""list-group m-2"">\n    @foreach (Category c in context.Categories) {\n        <li class=""list-group-item"">@c.Name</li>                \n    }\n</ul>\nThe @inject  expression specifies the service type and the name by which the service is \naccessed. In this example, the service type is DataContext , and the name by which it is \naccessed is context . Within the view, the @foreach  expression generates elements for \neach object returned by the DataContext.Categories  properties. Since there is no \npage model in this example, I have removed the @model  and @using  directives. Restart \nASP.NET Core and use a browser to navigate to http://localhost:5000/data, and you \nwill see the response shown in figure 23.15.",6050
277-24.1 Preparing for this chapter.pdf,277-24.1 Preparing for this chapter,"661 Summary\nFigure 23.15    Using a Razor Page without a page model \nSummary\n¡ Razor Pages combines markup and code to generate HTML responses without \nthe setup required by the MVC Framework.\n¡ Razor Pages use the same syntax as regular Razor views, with additional expres-\nsions to define the page model.\n¡ The page model is usually embedded within the markup using the @functions  \nexpression but can be defined in a separate C# class file.\n¡ The routes supported by Razor Pages are defined using the @page  expression.\n¡ Razor Pages can use regular Razor features, such as layouts, view start files, and \npartial views.\n66224Using view components\nThis chapter covers\n¡ Using view components to generate content  \n that is orthogonal to the main purpose of the  \n application\n¡ Applying view components in views\n¡ Passing data to view components from the  \n parent view\n¡ Using partial views to generate HTML content\n¡ Creating classes that are controllers and view  \n components\nI describe view components  in this chapter, which are classes that provide action-style \nlogic to support partial views; this means view components provide complex content \nto be embedded in views while allowing the C# code that supports it to be easily \nmaintained. Table 24.1 puts view components in context.\n 663 Preparing for this chapter\nTable 24.1    Putting view components in context\nQuestion Answer\nWhat are they? View components are classes that provide application \nlogic to support partial views or to inject small fragments \nof HTML or JSON data into a parent view.\nWhy are they useful? Without view components, it is hard to create embedded \nfunctionality such as shopping baskets or login panels in \na way that is easy to maintain.\nHow are they used? View components are typically derived from the View-\nComponent  class and are applied in a parent view using \nthe custom vc HTML element or the @await   \nComponent.InvokeAsync  expression.\nAre there any pitfalls or \nlimitations?View components are a simple and predictable feature. \nThe main pitfall is not using them and trying to include \napplication logic within views where it is difficult to test \nand maintain.\nAre there any alternatives? You could put the data access and processing logic \ndirectly in a partial view, but the result is difficult to work \nwith and hard to maintain.\nTable 24.2 provides a guide to the chapter.\nTable 24.2    Chapter guide\nProblem Solution Listing\nCreating a reusable unit of \ncode and contentDefine a view component. 7–13\nCreating a response from \na view componentUse one of the IViewComponentResult  \nimplementation classes.14–18\nGetting context data Use the properties inherited from the base \nclass or use the parameters of the Invoke  \nor InvokeAsync  method.19–25\nGenerating view  \ncomponent responses \nasynchronouslyOverride the InvokeAsync  method. 26–28\nIntegrating a view  \ncomponent into another \nendpointCreate a hybrid controller or Razor Page. 29–36\n24.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 23. To prepare for this chapter, \nadd a class file named City.cs  to the WebApp/Models  folder with the content shown \nin listing 24.1.\n664 chapter  24 Using view components\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from  https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 24.1    The contents of the City.cs file in the Models folder\nnamespace WebApp.Models {\n    public class City {\n        public string? Name { get; set; }\n        public string? Country { get; set; }\n        public int? Population { get; set; }\n    }\n}\nAdd a class named CitiesData.cs  to the WebApp/Models  folder with the content \nshown in listing 24.2.\nListing 24.2    The contents of the CitiesData.cs file in the WebApp/Models folder\nnamespace WebApp.Models {\n    public class CitiesData {\n        private List<City> cities = new List<City> {\n            new City { \n                Name = ""London"", \n                Country = ""UK"", \n                Population = 8539000\n            },\n            new City { \n                Name = ""New York"", \n                Country = ""USA"", \n                Population = 8406000 \n            },\n            new City { \n                Name = ""San Jose"", \n                Country = ""USA"", \n                Population = 998537 \n            },\n            new City { \n                Name = ""Paris"", \n                Country = ""France"", \n                Population = 2244000 \n            }\n        };\n        public IEnumerable<City> Cities => cities;\n        public void AddCity(City newCity) {\n            cities.Add(newCity);\n        }\n    }\n}\n 665 Preparing for this chapter\nThe CitiesData  class provides access to a collection of City  objects and provides an \nAddCity  method that adds a new object to the collection. Add the statement shown in \nlisting 24.3 to the Program.cs  file to create a service for the CitiesData  class. \nListing 24.3    Defining a service in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDistributedMemoryCache();\nbuilder.Services.AddSession(options => {\n    options.Cookie.IsEssential = true;\n});\nbuilder.Services.Configure<RazorPagesOptions>(opts => {\n    opts.Conventions.AddPageRoute(""/Index"", ""/extra/page/{id:long?}"");\n});\nbuilder.Services.AddSingleton<CitiesData>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseSession();\napp.MapControllers();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe new statement uses the AddSingleton  method to create a CitiesData  service. \nThere is no interface/implementation separation in this service, which I have created \nto easily distribute a shared CitiesData  object. Add a Razor Page named Cities \n.cshtml  to the WebApp/Pages  folder and add the content shown in listing 24.4.",6610
278-24.1.1 Dropping the database.pdf,278-24.1.1 Dropping the database,,0
279-24.2 Understanding view components.pdf,279-24.2 Understanding view components,"666 chapter  24 Using view components\nListing 24.4    The contents of the Cities.cshtml file in the Pages folder\n@page\n@inject CitiesData Data\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <tbody>\n            @foreach (City c in Data.Cities) {\n                <tr>\n                    <td>@c.Name</td>\n                    <td>@c.Country</td>\n                    <td>@c.Population</td>\n                </tr>\n            }\n        </tbody>\n    </table>\n</div>\n24.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 24.5 to drop the database.\nListing 24.5    Dropping the database\ndotnet ef database drop --force\n24.1.2  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 24.6. \nListing 24.6    Running the example application \ndotnet run\nThe database will be seeded as part of the application startup. Once ASP.NET Core \nis running, use a web browser to request http://localhost:5000/cities, which will pro-\nduce the response shown in figure 24.1.\nFigure 24.1    \nRunning the \nexample \napplication",1236
280-24.3.1 Applying a view component.pdf,280-24.3.1 Applying a view component,"667 Creating and using a view component \n24.2 Understanding view components\nApplications commonly need to embed content in views that isn’t related to the main \npurpose of the application. Common examples include site navigation tools and \nauthentication panels that let the user log in without visiting a separate page. \nThe data for this type of feature isn’t part of the model data passed from the action \nmethod or page model to the view. It is for this reason that I have created two sources of \ndata in the example project: I am going to display some content generated using City  \ndata, which isn’t easily done in a view that receives data from the Entity Framework Core \nrepository and the Product , Category , and Supplier  objects it contains.\nPartial views are used to create reusable markup that is required in views, avoiding \nthe need to duplicate the same content in multiple places in the application. Partial \nviews are a useful feature, but they just contain fragments of HTML and Razor direc-\ntives, and the data they operate on is received from the parent view. If you need to \ndisplay different data, then you run into a problem. You could access the data you need \ndirectly from the partial view, but this breaks the development model and produces an \napplication that is difficult to understand and maintain. Alternatively, you could extend \nthe view models used by the application so that it includes the data you require, but this \nmeans you have to change every action method, which makes it hard to isolate the func-\ntionality of action methods for effective maintenance and testing.\nThis is where view components come in. A view component is a C# class that provides \na partial view with the data that it needs, independently from the action method or Razor \nPage. In this regard, a view component can be thought of as a specialized action or page, \nbut one that is used only to provide a partial view with data; it cannot receive HTTP \nrequests, and the content that it provides will always be included in the parent view.\n24.3 Creating and using a view component \nA view component is any class whose name ends with ViewComponent  and that defines \nan Invoke  or InvokeAsync  method or any class that is derived from the View-\nComponent  base class or that has been decorated with the ViewComponent  attribute. \nI demonstrate the use of the attribute in the “Getting Context Data” section, but the \nother examples in this chapter rely on the base class.\nView components can be defined anywhere in a project, but the convention is to \ngroup them in a folder named Components . Create the WebApp/Components  folder \nand add to it a class file named CitySummary.cs  with the content shown in listing 24.7.  \nListing 24.7    The contents of the CitySummary.cs file in the Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Components {\n    public class CitySummary : ViewComponent {\n        private CitiesData data;\n        public CitySummary(CitiesData cdata) {\n668 chapter  24 Using view components\n            data = cdata;\n        }\n        public string Invoke() {\n            return $""{data.Cities.Count()} cities, ""\n            + $""{data.Cities.Sum(c => c.Population)} people"";\n        }\n    }\n}\nView components can take advantage of dependency injection to receive the services \nthey require. In this example, the view component declares a dependency on the  \nCitiesData  class, which is then used in the Invoke  method to create a string  that \ncontains the number of cities and the population total.\n24.3.1  Applying a view component \nView components can be applied in two different ways. The first technique is to use the \nComponent  property that is added to the C# classes generated from views and Razor \nPages. This property returns an object that implements the IViewComponentHelper  \ninterface, which provides the InvokeAsync  method. Listing 24.8 uses this technique to \napply the view component in the Index.cshtml  file in the Views/Home  folder.  \nListing 24.8    Using a view component in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_Layout"";\n    ViewBag.Title = ""Product Table"";\n}\n@section Header {\n    Product Information\n}\n<tr><th>Name</th><td>@Model?.Name</td></tr>\n<tr>\n    <th>Price</th>\n    <td>@Model?.Price.ToString(""c"")</td>\n</tr>\n<tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n@section Footer {\n    @(((Model?.Price / ViewBag.AveragePrice)\n            * 100).ToString(""F2""))% of average price\n}\n@section Summary {\n    <div class=""bg-info text-white m-2 p-2"">\n        @await Component.InvokeAsync(""CitySummary"")\n    </div>\n}\nView components are applied using the Component.InvokeAsync  method, using \nthe name of the view component class as the argument. The syntax for this technique \n 669 Creating and using a view component \ncan be confusing. View component classes define either an Invoke  or InvokeAsync  \nmethod, depending on whether their work is performed synchronously or asyn-\nchronously. But the Component.InvokeAsync  method is always used, even to apply \nview components that define the Invoke  method and whose operations are entirely \nsynchronous. \nTo add the namespace for the view components to the list that are included in views, \nI added the statement shown in listing 24.9 to the _ViewImports.cshtml  file in the \nViews  folder.\nListing 24.9    Adding a namespace in the _ViewImports.cshtml file in the Views folder\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@using WebApp.Components\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1, which will produce the result shown in figure 24.2.\n Figure 24.2    \nUsing a view \ncomponent\napplying  view components  using  a tag helper\nRazor Views and Pages can contain tag helpers, which are custom HTML elements \nthat are managed by C# classes. I explain how tag helpers work in detail in chapter 25, \nbut view components can be applied using an HTML element that is implemented \nas a tag helper. To enable this feature, add the directive shown in listing 24.10 to the \n_ViewImports.cshtml  file in the Views  folder.  \nNOTE    View components can be used only in controller views or Razor Pages \nand cannot be used to handle requests directly.\nListing 24.10    Adding tag helper in the _ViewImports.cshtml file in the Views folder\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@using WebApp.Components\n@addTagHelper *, WebApp\nThe new directive adds tag helper support for the example project, which is specified \nby name, and which is WebApp  for this example. In listing 24.11, I have used the custom \nHTML element to apply the view component.\n670 chapter  24 Using view components\nListing 24.11    Applying a component in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_Layout"";\n    ViewBag.Title = ""Product Table"";\n}\n@section Header {\n    Product Information\n}\n<tr><th>Name</th><td>@Model?.Name</td></tr>\n<tr>\n    <th>Price</th>\n    <td>@Model?.Price.ToString(""c"")</td>\n</tr>\n<tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n@section Footer {\n    @(((Model?.Price / ViewBag.AveragePrice)\n            * 100).ToString(""F2""))% of average price\n}\n@section Summary {\n    <div class=""bg-info text-white m-2 p-2"">\n        <vc:city-summary />\n    </div>\n}\nThe tag for the custom element is vc, followed by a colon, followed by the name of \nthe view component class, which is transformed into kebab-case. Each capitalized \nword in the class name is converted to lowercase and separated by a hyphen so that \nCitySummary  becomes city-summary , and the CitySummary  view component is \napplied using the vc:city-summary  element.\napplying  view components  in razor  pages\nRazor Pages use view components in the same way, either through the Component  \nproperty or through the custom HTML element. Since Razor Pages have their own \nview imports file, a separate @addTagHelper  directive is required, as shown in listing \n24.12.  \nListing 24.12    Adding a directive in the _ViewImports.cshtml file in the Pages folder\n@namespace WebApp.Pages\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@addTagHelper *, WebApp\nListing 24.13 applies the CitySummary  view component to the Data  page.",8501
281-24.4.1 Returning a partial view.pdf,281-24.4.1 Returning a partial view,"671 Understanding view component results\nListing 24.13    Using a view component in the Data.cshtml file in the Pages folder\n@page\n@inject DataContext context;\n<h5 class=""bg-primary text-white text-center m-2 p-2"">Categories</h5>\n<ul class=""list-group m-2"">\n    @foreach (Category c in context.Categories) {\n        <li class=""list-group-item"">@c.Name</li>                \n    }\n</ul>\n<div class=""bg-info text-white m-2 p-2"">\n    <vc:city-summary />\n</div>\nUse a browser to request http://localhost:5000/data, and you will see the response \nshown in figure 24.3, which displays the city data alongside the categories in the \ndatabase.\nFigure 24.3    Using a view component in a Razor Page\n24.4 Understanding view component results\nThe ability to insert simple string values into a view or page isn’t especially useful, \nbut fortunately, view components are capable of much more. More complex effects \ncan be achieved by having the Invoke  or InvokeAsync  method return an object that \nimplements the IViewComponentResult  interface. There are three built-in classes \nthat implement the IViewComponentResult  interface, and they are described in table \n24.3, along with the convenience methods for creating them provided by the View-\nComponent  base class. I describe the use of each result type in the sections that follow.  \n672 chapter  24 Using view components\nTable 24.3    The built-in IViewComponentResult implementation classes\nName Description\nViewViewComponent  Result This class is used to specify a Razor View, with \noptional view model data. Instances of this \nclass are created using the View  method.\nContentViewComponent  Result This class is used to specify a text result that \nwill be safely encoded for inclusion in an HTML \ndocument. Instances of this class are created \nusing the Content  method.\nHtmlContentView  ComponentResult This class is used to specify a fragment of \nHTML that will be included in the HTML doc-\nument without further encoding. There is no \nViewComponent  method to create this type \nof result.\nThere is special handling for two result types. If a view component returns a string , \nthen it is used to create a ContentViewComponentResult  object, which is what I relied \non in earlier examples. If a view component returns an IHtmlContent  object, then it is \nused to create an HtmlContentViewComponentResult  object.\n24.4.1  Returning a partial view \nThe most useful response is the awkwardly named ViewViewComponentResult  object, \nwhich tells Razor to render a partial view and include the result in the parent view. The \nViewComponent  base class provides the View  method for creating ViewViewCompo-\nnentResult  objects, and four versions of the method are available, described in table \n24.4.  \nTable 24.4    The ViewComponent.View methods\nName Description\nView() Using this method selects the default view for the \nview component and does not provide a view model.\nView(model) Using the method selects the default view and uses \nthe specified object as the view model. \nView(viewName) Using this method selects the specified view and \ndoes not provide a view model.\nView(viewName, model) Using this method selects the specified view and \nuses the specified object as the view model.\nThese methods correspond to those provided by the Controller  base class and are \nused in much the same way. To create a view model class that the view component can \nuse, add a class file named CityViewModel.cs  to the WebApp/Models  folder and use it \nto define the class shown in listing 24.14.\n 673 Understanding view component results\nListing 24.14    The contents of the CityViewModel.cs file in the Models folder\nnamespace WebApp.Models {\n    public class CityViewModel {\n        public int? Cities { get; set; }\n        public int? Population { get; set; }\n    }\n}\nListing 24.15 modifies the Invoke  method of the CitySummary  view component so it \nuses the View  method to select a partial view and provides view data using a CityView-\nModel  object.\nListing 24.15    Selecting a view in the CitySummary.cs file in the Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Components {\n    public class CitySummary : ViewComponent {\n        private CitiesData data;\n        public CitySummary(CitiesData cdata) {\n            data = cdata;\n        }\n        public IViewComponentResult Invoke() {\n            return View(new CityViewModel {\n                Cities = data.Cities.Count(),\n                Population = data.Cities.Sum(c => c.Population)\n            });\n        }\n    }\n}\nThere is no view available for the view component currently, but the error message \nthis produces reveals the locations that are searched. Restart ASP.NET Core and use \na browser to request http://localhost:5000/home/index/1 to see the locations that \nare searched when the view component is used with a controller. Request http://  \nlocalhost:5000/data to see the locations searched when a view component is used with \na Razor Page. Figure 24.4 shows both responses.\nFigure 24.4    The search locations for view component views\n674 chapter  24 Using view components\nRazor searches for a view named Default.cshtml  when a view component invokes \nthe View  method without specifying a name. If the view component is used with a con-\ntroller, then the search locations are as follows:  \n¡ /Views/[controller]/Components/[viewcomponent]/Default.cshtml\n¡ /Views/Shared/Components/[viewcomponent]/Default.cshtml\n¡ /Pages/Shared/Components/[viewcomponent]/Default.cshtml\nWhen the CitySummary  component is rendered by a view selected through the Home  \ncontroller, for example, [controller]  is Home  and [viewcomponent]  is City Summary , \nwhich means the first search location is /Views/Home/Components/CitySummary/\nDefault.cshtml . If the view component is used with a Razor Page, then the search \nlocations are as follows:\n¡ /Pages/Components/[viewcomponent]/Default.cshtml\n¡ /Pages/Shared/Components/[viewcomponent]/Default.cshtml\n¡ /Views/Shared/Components/[viewcomponent]/Default.cshtml\nIf the search paths for Razor Pages do not include the page name but a Razor Page \nis defined in a subfolder, then the Razor view engine will look for a view in the  \nComponents/[viewcomponent]  folder, relative to the location in which the Razor \nPage is defined, working its way up the folder hierarchy until it finds a view or reaches \nthe Pages  folder.\nTIP    Notice that view components used in Razor Pages will find views defined \nin the Views/Shared/Components  folder and that view components defined in \ncontrollers will find views in the Pages/Shared/Components  folder. This means \nyou don’t have to duplicate views when a view component is used by controllers \nand Razor Pages. \nCreate the WebApp/Views/Shared/Components/CitySummary  folder and add to it a \nRazor View named Default.cshtml  with the content shown in listing 24.16.\nListing 24.16    The Default.cshtml file in the Views/Shared/Components/\nCitySummary folder\n@model CityViewModel\n<table class=""table table-sm table-bordered text-white bg-secondary"">\n    <thead>\n        <tr><th colspan=""2"">Cities Summary</th></tr>\n    </thead>\n    <tbody>\n        <tr>\n            <td>Cities:</td>\n            <td class=""text-right"">\n                @Model?.Cities\n            </td>",7430
282-24.4.2 Returning HTML fragments.pdf,282-24.4.2 Returning HTML fragments,"675 Understanding view component results\n        </tr>\n        <tr>\n            <td>Population:</td>\n            <td class=""text-right"">\n                @Model?.Population?.ToString(""#,###"")\n            </td>\n        </tr>\n    </tbody>\n</table>\nViews for view components are similar to partial views and use the @model  directive \nto set the type of the view model object. This view receives a CityViewModel  object \nfrom its view component, which is used to populate the cells in an HTML table. Restart \nASP.NET Core and a browser to request http://localhost:5000/home/index/1 and \nhttp://localhost:5000/data, and you will see the view incorporated into the responses, \nas shown in figure 24.5.\nFigure 24.5    Using a view with a view component  \n24.4.2  Returning HTML fragments\nThe ContentViewComponentResult  class is used to include fragments of HTML in \nthe parent view without using a view. Instances of the ContentViewComponentResult  \nclass are created using the Content  method inherited from the ViewComponent  base \nclass, which accepts a string  value. Listing 24.17 demonstrates the use of the Content  \nmethod. \nTIP    In addition to the Content  method, the Invoke  method can return a string , \nwhich will be automatically converted to a ContentViewComponentResult . This \nis the approach I took in the view component when it was first defined.\n676 chapter  24 Using view components\nListing 24.17    Using the content method in the CitySummary.cs file in the \nComponents folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Components {\n    public class CitySummary : ViewComponent {\n        private CitiesData data;\n        public CitySummary(CitiesData cdata) {\n            data = cdata;\n        }\n        public IViewComponentResult Invoke() {\n            return Content(""This is a <h3><i>string</i></h3>"");\n        }\n    }\n}\nThe string received by the Content  method is encoded to make it safe to include in an \nHTML document. This is particularly important when dealing with content that has \nbeen provided by users or external systems because it prevents JavaScript content from \nbeing embedded into the HTML generated by the application. \nIn this example, the string  that I passed to the Content  method contains some basic \nHTML tags. Restart ASP.NET Core and use a browser to request http://  localhost:5000/\nhome/index/1. The response will include the encoded HTML fragment, as shown in \nfigure 24.6.\nFigure 24.6    Returning an encoded HTML fragment using a view component \nIf you look at the HTML that the view component produced, you will see that the \nangle brackets have been replaced so that the browser doesn’t interpret the content as \nHTML elements, as follows:\n...\n<div class=""bg-info text-white m-2 p-2"">\n    This is a &lt;h3&gt;&lt;i&gt;string&lt;/i&gt;&lt;/h3&gt;\n</div>\n...\n 677 Understanding view component results\nYou don’t need to encode content if you trust its source and want it to be interpreted \nas HTML. The Content  method always encodes its argument, so you must create the \nHtmlContentViewComponentResult  object directly and provide its constructor with \nan HtmlString  object, which represents a string that you know is safe to display, either \nbecause it comes from a source that you trust or because you are confident that it has \nalready been encoded, as shown in listing 24.18.\nListing 24.18    Returning a fragment in the CitySummary.cs file in the Components \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc.ViewComponents;\nusing Microsoft.AspNetCore.Html;\nnamespace WebApp.Components {\n    public class CitySummary : ViewComponent {\n        private CitiesData data;\n        public CitySummary(CitiesData cdata) {\n            data = cdata;\n        }\n        public IViewComponentResult Invoke() {\n            return new HtmlContentViewComponentResult(\n                new HtmlString(""This is a <h3><i>string</i></h3>""));\n        }\n    }\n}\nThis technique should be used with caution and only with sources of content that can-\nnot be tampered with and that perform their own encoding. Restart ASP.NET Core \nand use a browser to request http://localhost:5000/home/index/1, and you will see \nthe response isn’t encoded and is interpreted as HTML elements, as shown in figure \n24.7.\nFigure 24.7    Returning an unencoded HTML fragment using a view component",4471
283-24.5.1 Providing context from the parent view using arguments.pdf,283-24.5.1 Providing context from the parent view using arguments,"678 chapter  24 Using view components\n24.5 Getting context data \nDetails about the current request and the parent view are provided to a view com-\nponent through properties defined by the ViewComponent  base class, as described in \ntable 24.5.  \nTable 24.5    The ViewComponentContext properties\nName Description\nHttpContext This property returns an HttpContext  object that describes the \ncurrent request and the response that is being prepared. \nRequest This property returns an HttpRequest  object that describes the \ncurrent HTTP request.\nUser This property returns an IPrincipal  object that describes the \ncurrent user, as described in chapters 37 and 38.\nRouteData This property returns a RouteData  object that describes the rout-\ning data for the current request.\nViewBag This property returns the dynamic  view bag object, which can be \nused to pass data between the view component and the view, as \ndescribed in chapter 22.\nModelState This property returns a ModelStateDictionary , which pro-\nvides details of the model binding process, as described in chapter \n29.\nViewData This property returns a ViewDataDictionary , which provides \naccess to the view data provided for the view component.\nThe context data can be used in whatever way helps the view component do its work, \nincluding varying the way that data is selected or rendering different content or views. \nIt is hard to devise a representative example of using context data in a view component \nbecause the problems it solves are specific to each project. In listing 24.19, I check the \nroute data for the request to determine whether the routing pattern contains a con-\ntroller segment variable, which indicates a request that will be handled by a controller \nand view. \nListing 24.19    Using request data in the CitySummary.cs file in the Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc.ViewComponents;\nusing Microsoft.AspNetCore.Html;\nnamespace WebApp.Components {\n    public class CitySummary : ViewComponent {\n        private CitiesData data;\n        public CitySummary(CitiesData cdata) {\n            data = cdata;\n        }\n        public string Invoke() {\n 679 Getting context data \n            if (RouteData.Values[""controller""] != null) {\n                return ""Controller Request"";\n            } else {\n                return ""Razor Page Request"";\n            }\n        }\n    }\n}\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1 and http://localhost:5000/data, and you will see that the view component \nalters its output, as shown in figure 24.8.\nFigure 24.8    Using context data in a view component \n24.5.1  Providing context from the parent view using arguments \nParent views can provide additional context data to view components, providing them \nwith either data or guidance about the content that should be produced. The con-\ntext data is received through the Invoke  or InvokeAsync  method, as shown in listing \n24.20.  \nListing 24.20    Receiving a value in the CitySummary.cs file in the Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc.ViewComponents;\nusing Microsoft.AspNetCore.Html;\nnamespace WebApp.Components {\n    public class CitySummary : ViewComponent {\n        private CitiesData data;\n        public CitySummary(CitiesData cdata) {\n            data = cdata;\n        }\n        public IViewComponentResult Invoke(string themeName) {\n            ViewBag.Theme = themeName;\n            return View(new CityViewModel {\n                Cities = data.Cities.Count(),\n680 chapter  24 Using view components\n                Population = data.Cities.Sum(c => c.Population)\n            });\n        }\n    }\n}\nThe Invoke  method defines a themeName  parameter that is passed on to the partial \nview using the view bag, which was described in chapter 22. Listing 24.21 updates the \nDefault  view to use the received value to style the content it produces.\nListing 24.21    Styling content in the Default.cshtml file in the Views/Shared/\nComponents/CitySummary folder\n@model CityViewModel\n<table class=""table table-sm table-bordered text-white bg-@ViewBag.Theme"">\n    <thead>\n        <tr><th colspan=""2"">Cities Summary</th></tr>\n    </thead>\n    <tbody>\n        <tr>\n            <td>Cities:</td>\n            <td class=""text-right"">\n                @Model?.Cities\n            </td>\n        </tr>\n        <tr>\n            <td>Population:</td>\n            <td class=""text-right"">\n                @Model?.Population?.ToString(""#,###"")\n            </td>\n        </tr>\n    </tbody>\n</table>\nA value for all parameters defined by a view component’s Invoke  or InvokeAsync  \nmethod must always be provided. Listing 24.22 provides a value for themeName  param-\neter in the view selected by the Home  controller.\nTIP    The view component will not be used if you do not provide values for all the \nparameters it defines, but no error message is displayed. If you don’t see any con-\ntent from a view component, then the likely cause is a missing parameter value.\nListing 24.22    Supplying a value in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_Layout"";\n    ViewBag.Title = ""Product Table"";\n}\n@section Header {\n    Product Information\n}\n 681 Getting context data \n<tr><th>Name</th><td>@Model?.Name</td></tr>\n<tr>\n    <th>Price</th>\n    <td>@Model?.Price.ToString(""c"")</td>\n</tr>\n<tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n@section Footer {\n    @(((Model?.Price / ViewBag.AveragePrice)\n            * 100).ToString(""F2""))% of average price\n}\n@section Summary {\n    <div class=""bg-info text-white m-2 p-2"">\n        <vc:city-summary theme-name=""secondary"" />\n    </div>\n}\nThe name of each parameter is expressed an attribute using kebab-case so that the \ntheme-name  attribute provides a value for the themeName  parameter. Listing 24.23 sets \na value in the Data.cshtml  Razor Page.\nListing 24.23    Supplying a value in the Data.cshtml file in the Pages folder\n@page\n@inject DataContext context;\n<h5 class=""bg-primary text-white text-center m-2 p-2"">Categories</h5>\n<ul class=""list-group m-2"">\n    @foreach (Category c in context.Categories) {\n        <li class=""list-group-item"">@c.Name</li>                \n    }\n</ul>\n<div class=""bg-info text-white m-2 p-2"">\n    <vc:city-summary theme-name=""danger"" />\n</div>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1 and http://localhost:5000/data. The view component is provided with dif-\nferent values for the themeName  parameter, producing the responses shown in figure \n24.9.\nFigure 24.9    \nUsing context \ndata in a view \ncomponent\n682 chapter  24 Using view components\nProviding values using the component helper\nIf you prefer applying view components using the Component.InvokeAsync  helper, \nthen you can provide context using method arguments, like this:\n...\n<div cla""s=""bg-info text-white m-2 p-2"">\n    @await Component.InvokeAsync(""CitySummary"",\n        new { themeName= ""danger"" } )\n</div>\n... \nThe first argument to the InvokeAsync  method is the name of the view component \nclass. The second argument is an object whose names correspond to the parameters \ndefined by the view component.\nusing a default  parameter  value\nDefault values can be defined for the Invoke  method parameters, as shown in listing \n24.24, which provides a fallback if the parent view doesn’t provide a value. \nListing 24.24    A default value in the CitySummary.cs file in the Components folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Mvc.ViewComponents;\nusing Microsoft.AspNetCore.Html;\nnamespace WebApp.Components {\n    public class CitySummary : ViewComponent {\n        private CitiesData data;\n        public CitySummary(CitiesData cdata) {\n            data = cdata;\n        }\n        public IViewComponentResult Invoke(string themeName=""success"") {\n            ViewBag.Theme = themeName;\n            return View(new CityViewModel {\n                Cities = data.Cities.Count(),\n                Population = data.Cities.Sum(c => c.Population)\n            });\n        }\n    }\n}\nThe default value is success , and it will be used if the view component is applied with-\nout a theme-name  attribute, as shown in Listing 24.25.",8506
284-24.5.2 Creating asynchronous view components.pdf,284-24.5.2 Creating asynchronous view components,"683 Getting context data \nListing 24.25    Omitting the attribute in the Data.cshtml file in the Pages folder \n@page\n@inject DataContext context;\n<h5 class=""bg-primary text-white text-center m-2 p-2"">Categories</h5>\n<ul class=""list-group m-2"">\n    @foreach (Category c in context.Categories) {\n        <li class=""list-group-item"">@c.Name</li>                \n    }\n</ul>\n<div class=""bg-info text-white m-2 p-2"">\n    <vc:city-summary />\n</div>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/data. The \ndefault value is used to select the theme, as shown in figure 24.10.\nFigure 24.10    \nUsing a \ndefault value\n24.5.2  Creating asynchronous view components\nAll the examples so far in this chapter have been synchronous view components, which \ncan be recognized because they define the Invoke  method. If your view component \nrelies on asynchronous APIs, then you can create an asynchronous view component by \ndefining an InvokeAsync  method that returns a Task . When Razor receives the Task  \nfrom the InvokeAsync  method, it will wait for it to complete and then insert the result \ninto the main view. To create a new component, add a class file named PageSize.cs  to \nthe Components  folder and use it to define the class shown in listing 24.26.\nListing 24.26    The contents of the PageSize.cs file in the Components folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Components {\n    public class PageSize : ViewComponent {\n        public async Task<IViewComponentResult> InvokeAsync() {\n684 chapter  24 Using view components\n            HttpClient client = new HttpClient();\n            HttpResponseMessage response\n                = await client.GetAsync(""http://microsoft.com"");\n            return View(response.Content.Headers.ContentLength);\n        }\n    }\n}\nThe InvokeAsync  method uses the async  and await  keywords to consume the asyn-\nchronous API provided by the HttpClient  class and get the length of the content \nreturned by sending a GET request to microsoft.com . The length is passed to the View  \nmethod, which selects the default partial view associated with the view component. \nCreate the Views/Shared/Components/PageSize  folder and add to it a Razor View \nnamed Default.cshtml  with the content shown in listing 24.27.\nListing 24.27    The Default.cshtml file in the Views/Shared/Components/PageSize \nfolder\n@model long\n<div class=""m-1 p-1 bg-light text-dark"">Page size: @Model</div>\nThe final step is to use the component, which I have done in the Index  view used by \nthe Home  controller, as shown in listing 24.28. No change is required in the way that \nasynchronous view components are used.\nListing 24.28    Using an asynchronous component in the Index.cshtml file in the \nViews/Home folder \n@model Product?\n@{\n    Layout = ""_Layout"";\n    ViewBag.Title = ""Product Table"";\n}\n@section Header {\n    Product Information\n}\n<tr><th>Name</th><td>@Model?.Name</td></tr>\n<tr>\n    <th>Price</th>\n    <td>@Model?.Price.ToString(""c"")</td>\n</tr>\n<tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n@section Footer {\n    @(((Model?.Price / ViewBag.AveragePrice)\n            * 100).ToString(""F2""))% of average price\n}\n@section Summary {\n    <div class=""bg-info text-white m-2 p-2"">\n        <vc:city-summary theme-name=""secondary"" />\n        <vc:page-size />\n    </div>\n}",3401
285-24.6 Creating view components classes.pdf,285-24.6 Creating view components classes,"685 Creating view components classes\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1, which will produce a response that includes the size of the Microsoft home \npage, as shown in figure 24.11. At the time of writing, the response sent by the Micro-\nsoft website is a concise message used for requests that don’t include a browser user-\nagent header, but you may see a different response.\nFigure 24.11    Using an asynchronous component \n24.6 Creating view components classes\nView components often provide a summary or snapshot of functionality that is han-\ndled in-depth by a controller or Razor Page. For a view component that summarizes a \nshopping basket, for example, there will often be a link that targets a controller that \nprovides a detailed list of the products in the basket and that can be used to check out \nand complete the purchase.  \nIn this situation, you can create a class that is a view component as well as a con-\ntroller or Razor Page. If you are using Visual Studio, expand the Cities.cshtml  item \nin the Solution Explorer to show the Cities.cshtml.cs  file and replace its contents \nwith those shown in listing 24.29. If you are using Visual Studio Code, add a file named  \nCities.cshtml.cs  to the Pages  folder with the content shown in listing 24.29.\nListing 24.29    The contents of the Cities.cshtml.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing Microsoft.AspNetCore.Mvc.ViewComponents;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing WebApp.Models;\nnamespace WebApp.Pages {\n    [ViewComponent(Name = ""CitiesPageHybrid"")]\n    public class CitiesModel : PageModel {\n        public CitiesModel(CitiesData cdata) {\n            Data = cdata;\n        }\n        public CitiesData? Data { get; set; }\n        [ViewComponentContext]\n        public ViewComponentContext Context { get; set; } = new();\n        public IViewComponentResult Invoke() {\n686 chapter  24 Using view components\n            return new ViewViewComponentResult() {\n                ViewData = new ViewDataDictionary<CityViewModel>(\n                    Context.ViewData,\n                    new CityViewModel {\n                        Cities = Data?.Cities.Count(),\n                        Population = Data?.Cities.Sum(c => c.Population)\n                    })\n            };\n        }\n    }\n}\nThis page model class is decorated with the ViewComponent  attribute, which allows it \nto be used as a view component. The Name  argument specifies the name by which the \nview component will be applied. Since a page model cannot inherit from the View-\nComponent  base class, a property whose type is ViewComponentContext  is decorated \nwith the ViewComponentContext  attribute, which signals that it should be assigned \nan object that defines the properties described in table 24.5 before the Invoke  or \nInvokeAsync  method is invoked. The View  method isn’t available, so I have to cre-\nate a ViewViewComponentResult  object, which relies on the context object received \nthrough the decorated property. Listing 24.30 updates the view part of the page to use \nthe new page model class.\nListing 24.30    Updating the view in the Cities.cshtml file in the Pages folder\n@page\n@model WebApp.Pages.CitiesModel\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <tbody>\n            @foreach (City c in Model.Data?.Cities ?? \n                     Enumerable.Empty<City>()) {\n                <tr>\n                    <td>@c.Name</td>\n                    <td>@c.Country</td>\n                    <td>@c.Population</td>\n                </tr>\n            }\n        </tbody>\n    </table>\n</div>\nThe changes update the directives to use the page model class. To create the view for the \nhybrid view component, create the Pages/Shared/Components/CitiesPageHybrid  \nfolder and add to it a Razor View named Default.cshtml  with the content shown in \nlisting 24.31.\nListing 24.31    The Default.cshtml file in the Pages/Shared/Components/\nCitiesPageHybrid folder\n@model CityViewModel\n<table class=""table table-sm table-bordered text-white bg-dark"">\n 687 Creating view components classes\n    <thead><tr><th colspan=""2"">Hybrid Page Summary</th></tr></thead>\n    <tbody>\n        <tr>\n            <td>Cities:</td>\n            <td class=""text-right"">@Model?.Cities</td>\n        </tr>\n        <tr>\n            <td>Population:</td>\n            <td class=""text-right"">\n                @Model?.Population?.ToString(""#,###"")\n            </td>\n        </tr>\n    </tbody>\n</table>\nListing 24.32 applies the view component part of the hybrid class in another page.\nListing 24.32    Using a view component in the Data.cshtml file in the Pages folder\n@page\n@inject DataContext context;\n<h5 class=""bg-primary text-white text-center m-2 p-2"">Categories</h5>\n<ul class=""list-group m-2"">\n    @foreach (Category c in context.Categories) {\n        <li class=""list-group-item"">@c.Name</li>                \n    }\n</ul>\n<div class=""bg-info text-white m-2 p-2"">\n    <vc:cities-page-hybrid />\n</div>\nHybrids are applied just like any other view component. Restart ASP.NET Core and \nrequest http://localhost:5000/cities and http://localhost:5000/data. Both URLs are \nprocessed by the same class. For the first URL, the class acts as a page model; for the \nsecond URL, the class acts as a view component. Figure 24.12 shows the output for \nboth URLs.\nFigure 24.12    A hybrid page model and view component class",5610
286-24.6.1 Creating a hybrid controller class.pdf,286-24.6.1 Creating a hybrid controller class,"688 chapter  24 Using view components\n24.6.1  Creating a hybrid controller class\nThe same technique can be applied to controllers. Add a class file named \nCitiesController.cs  to the Controllers  folder and add the statements shown in \nlisting 24.33.  \nListing 24.33    The contents of the CitiesController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.ViewComponents;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ViewComponent(Name = ""CitiesControllerHybrid"")]\n    public class CitiesController : Controller {\n        private CitiesData data;\n        public CitiesController(CitiesData cdata) {\n            data = cdata;\n        }\n        public IActionResult Index() {\n            return View(data.Cities);\n        }\n        public IViewComponentResult Invoke() {\n            return new ViewViewComponentResult() {\n                ViewData = new ViewDataDictionary<CityViewModel>(\n                    ViewData,\n                    new CityViewModel {\n                        Cities = data.Cities.Count(),\n                        Population = data.Cities.Sum(c => c.Population)\n                    })\n            };\n        }\n    }\n}\nA quirk in the way that controllers are instantiated means that a property decorated \nwith the ViewComponentContext  attribute isn’t required and the ViewData  property \ninherited from the Controller  base class can be used to create the view component \nresult.\nTo provide a view for the action method, create the Views/Cities  folder and add to \nit a file named Index.cshtml  with the content shown in listing 24.34.\nListing 24.34     The contents of the Index.cshtml file in the Views/Cities folder\n@model IEnumerable<City>\n@{\n    Layout = ""_ImportantLayout"";\n}\n<div class=""m-2"">\n 689 Creating view components classes\n    <table class=""table table-sm table-striped table-bordered"">\n        <tbody>\n            @foreach (City c in Model) {\n                <tr>\n                    <td>@c.Name</td>\n                    <td>@c.Country</td>\n                    <td>@c.Population</td>\n                </tr>\n            }\n        </tbody>\n    </table>\n</div>\nTo provide a view for the view component, create the Views/Shared/Components/\nCitiesControllerHybrid folder and add to it a Razor View named Default.cshtml  \nwith the content shown in listing 24.35.\nListing 24.35    The Default.cshtml file in the Views/Shared/Components/\nCitiesControllerHybrid folder\n@model CityViewModel\n<table class=""table table-sm table-bordered text-white bg-dark"">\n    <thead><tr><th colspan=""2"">Hybrid Controller Summary</th></tr></thead>\n    <tbody>\n        <tr>\n            <td>Cities:</td>\n            <td class=""text-right"">@Model.Cities</td>\n        </tr>\n        <tr>\n            <td>Population:</td>\n            <td class=""text-right"">\n                @Model.Population?.ToString(""#,###"")\n            </td>\n        </tr>\n    </tbody>\n</table>\nListing 24.36 applies the hybrid view component in the Data.cshtml  Razor Page, \nreplacing the hybrid class created in the previous section.\nListing 24.36    Applying the view component in the Data.cshtml file in the Pages folder\n@page\n@inject DataContext context;\n<h5 class=""bg-primary text-white text-center m-2 p-2"">Categories</h5>\n<ul class=""list-group m-2"">\n    @foreach (Category c in context.Categories) {\n        <li class=""list-group-item"">@c.Name</li>                \n    }\n</ul>\n<div class=""bg-info text-white m-2 p-2"">\n    <vc:cities-controller-hybrid  />\n</div>",3637
287-25.1 Preparing for this chapter.pdf,287-25.1 Preparing for this chapter,"690 chapter  24 Using view components\nRestart ASP.NET Core and use a browser to request http://localhost:5000/cities/\nindex and http://localhost:5000/data. For the first URL, the class in listing 24.36 is \nused as a controller; for the second URL, the class is used as a view component. Figure \n24.13 shows the responses for both URLs.\nFigure 24.13    A hybrid controller and view component class\nSummary\n¡ View components are self-contained and generate content that isn’t related to \nthe main purpose of the application.\n¡ View components are C# classes that are derived from ViewComponent  and \nwhose Invoke  method is called to generate content.\n¡ View components are applied using the Component  property, which returns a \nhelper or using the vc tag helper.\n¡ View components can use partial views to generate HTML content.\n¡ View components can receive data from the view in which they are applied and \ncan use standard platform features such as dependency injection.\n69125Using tag helpers\nThis chapter covers\n¡ Transforming HTML elements using tag helpers\n¡ Receiving context data in a tag helper class\n¡ Registering and applying tag helpers\n¡ Selecting elements to transform with tag helper  \n scope\n¡ Creating custom shorthand elements\n¡ Generating content for view model properties\n¡ Creating tag helpers that can be consumed  \n through dependency injection\nTag helpers are C# classes that transform HTML elements in a view or page. Com-\nmon uses for tag helpers include generating URLs for forms using the application’s \nrouting configuration, ensuring that elements of a specific type are styled consis-\ntently, and replacing custom shorthand elements with commonly used fragments of \ncontent. In this chapter, I describe how tag helpers work and how custom tag help-\ners are created and applied. In chapter 26, I describe the built-in tag helpers, and \nin chapter 27, I use tag helpers to explain how HTML forms are created. Table 25.1 \nputs tag helpers in context.\n692 chapter  25 Using tag helpers\nTable 25.1    Putting tag helpers in context\nQuestion Answer\nWhat are they? Tag helpers are classes that manipulate HTML elements, either to \nchange them in some way, to supplement them with additional content, \nor to replace them entirely with new content. \nWhy are they useful? Tag helpers allow view content to be generated or transformed using C# \nlogic, ensuring that the HTML sent to the client reflects the state of the \napplication. \nHow are they used? The HTML elements to which tag helpers are applied are selected \nbased on the name of the class or with the HTMLTargetElement  \nattribute. When a view is rendered, elements are transformed by tag \nhelpers and included in the HTML sent to the client.\nAre there any pitfalls or \nlimitations?It can be easy to get carried away and generate complex sections of \nHTML content using tag helpers, which is something that is more read-\nily achieved using view components, described in chapter 24.\nAre there any alternatives? You don’t have to use tag helpers, but they make it easy to generate \ncomplex HTML in ASP.NET Core applications. \nTable 25.2 provides a guide to the chapter.\nTable 25.2   Chapter guide\nProblem Solution Listing\nCreating a tag helper Define a class that is derived from the TagHelper  \nclass.1–7\nControlling the scope of a tag helper Alter the range of elements specified by the  \nHtmlTargetElement  attribute.8–11\nCreating custom HTML elements that \nare replaced with contentUse shorthand elements. 12, 13\nCreating elements programmatically Use the TagBuilder  class. 14\nControlling where content is inserted Use the prepend and append features. 15–18\nGetting context data Use the context object. 19, 20\nOperating on the view model or page \nmodel Use a model expression. 21–25\nCreating coordinating tag helpers Use the Items  property. 26, 27\nSuppressing content Use the SuppressOutput  method. 28, 29\nDefining tag helper as services Create tag helper components. 30–33\n25.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 24. To prepare for this chapter, \nreplace the contents of the Program.cs  file with those in listing 25.1, removing some \nof the configuration statements used in earlier chapters. \n 693 Preparing for this chapter\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 25.1    The contents of the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddSingleton<CitiesData>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nNext, replace the contents of the Index.cshtml  file in the Views/Home  folder with the \ncontent shown in listing 25.2.\nListing 25.2    The contents of the Index.cshtml file in the Views/Home folder\n@model Product?\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<table class=""table table-striped table-bordered table-sm"">\n    <thead>\n        <tr>\n            <th colspan=""2"">Product Summary</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr><th>Name</th><td>@Model?.Name</td></tr>\n        <tr><th>Price</th><td>@Model?.Price.ToString(""c"")</td></tr>",5923
288-25.1.1 Dropping the database.pdf,288-25.1.1 Dropping the database,,0
289-25.2 Creating a tag helper.pdf,289-25.2 Creating a tag helper,"694 chapter  25 Using tag helpers\n        <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n    </tbody>\n</table>\nThe view in listing 25.2 relies on a new layout. Add a Razor View file named  \n_SimpleLayout.cshtml  in the Views/Shared  folder with the content shown in listing \n25.3.\nListing 25.3    The contents of the _SimpleLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\n25.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 25.4 to drop the database.\nListing 25.4    Dropping the database\ndotnet ef database drop --force\n25.1.2  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 25.5. \nListing 25.5    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/home, which will produce the \nresponse shown in figure 25.1.\nFigure 25.1    Running the example application",1236
290-25.2.1 Defining the tag helper class.pdf,290-25.2.1 Defining the tag helper class,"695 Creating a tag helper\n25.2 Creating a tag helper\nThe best way to understand tag helpers is to create one, which reveals how they operate \nand how they fit into an ASP.NET Core application. In the sections that follow, I go \nthrough the process of creating and applying a tag helper that will set the Bootstrap \nCSS classes for a tr element so that an element like this:\n...\n<tr bg-color=""primary"">\n    <th colspan=""2"">Product Summary</th>\n</tr>\n...\nwill be transformed into this:\n...\n<tr class=""bg-primary text-white text-center"" >\n    <th colspan=""2"">Product Summary</th>\n</tr>\n...\nThe tag helper will recognize the tr-color  attribute and use its value to set the class  \nattribute on the element sent to the browser. This isn’t the most dramatic—or useful—\ntransformation, but it provides a foundation for explaining how tag helpers work. \n25.2.1  Defining the tag helper class\nTag helpers can be defined anywhere in the project, but it helps to keep them together \nbecause they need to be registered before they can be used. Create the WebApp/\nTagHelpers  folder and add to it a class file named TrTagHelper.cs  with the code \nshown in listing 25.6.  \nListing 25.6    The contents of the TrTagHelper.cs file in the TagHelpers folder \nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    public class TrTagHelper: TagHelper {\n        public string BgColor { get; set; } = ""dark"";\n        public string TextColor { get; set; } = ""white"";\n        public override void Process(TagHelperContext context, \n                TagHelperOutput output) {\n            output.Attributes.SetAttribute(""class"", \n                $""bg-{BgColor} text-center text-{TextColor}"");\n        }\n    }\n}\nTag helpers are derived from the TagHelper  class, which is defined in the Microsoft \n.AspNetCore.Razor.TagHelpers  namespace. The TagHelper  class defines a \nProcess  method, which is overridden by subclasses to implement the behavior that \ntransforms elements. \n696 chapter  25 Using tag helpers\nThe name of the tag helper combines the name of the element it transforms fol-\nlowed by TagHelper . In the case of the example, the class name TrTagHelper  indicates \nthis is a tag helper that operates on tr elements. The range of elements to which a tag \nhelper can be applied can be broadened or narrowed using attributes, as described \nlater in this chapter, but the default behavior is defined by the class name.  \nTIP    Asynchronous tag helpers can be created by overriding the ProcessAsync  \nmethod instead of the Process  method, but this isn’t required for most helpers, \nwhich tend to make small and focused changes to HTML elements. You can see \nan example of an asynchronous tag helper in the ""Advanced Tag Helper Fea-\ntures"" section.\nreceiving  context  data\nTag helpers receive information about the element they are transforming through \nan instance of the TagHelperContext  class, which is received as an argument to the  \nProcess  method and which defines the properties described in table 25.3.  \nTable 25.3    The TagHelperContext properties\nName Description\nAllAttributes This property returns a read-only dictionary of the \nattributes applied to the element being transformed, \nindexed by name and by index.\nItems This property returns a dictionary that is used to coordi-\nnate between tag helpers, as described in the “Coordi-\nnating Between Tag Helpers” section.\nUniqueId This property returns a unique identifier for the element \nbeing transformed.\nAlthough you can access details of the element’s attributes through the All Attributes  \ndictionary, a more convenient approach is to define a property whose name corre-\nsponds to the attribute you are interested in, like this:\n...\npublic string BgColor { get; set; } = ""dark"";\npublic string TextColor { get; set; } = ""white"";\n...\nWhen a tag helper is being used, the properties it defines are inspected and assigned \nthe value of any whose name matches attributes applied to the HTML element. As part \nof this process, the attribute value will be converted to match the type of the C# prop-\nerty so that bool  properties can be used to receive true  and false  attribute values and \nso int properties can be used to receive numeric attribute values such as 1 and 2.\nProperties for which there are no corresponding HTML element attributes are not \nset, which means you should check to ensure that you are not dealing with null  or pro-\nvide default values, which is the approach taken in listing 25.6.  \nThe name of the attribute is automatically converted from the default HTML style, \nbg-color , to the C# style, BgColor . You can use any attribute prefix except asp-  (which \n 697 Creating a tag helper\nMicrosoft uses) and data-  (which is reserved for custom attributes that are sent to the \nclient). The example tag helper will be configured using bg-color  and text-color  \nattributes, which will provide values for the BgColor  and TextColor  properties and be \nused to configure the tr element in the Process  method, as follows:\n...\noutput.Attributes.SetAttribute(""class"", \n    $""bg-{ BgColor} text-center text-{ TextColor }"");\n...\nTIP    Using the HTML attribute name for tag helper properties doesn’t always lead \nto readable or understandable classes. You can break the link between the name \nof the property and the attribute it represents using the HtmlAttributeName  \nattribute, which can be used to specify the HTML attribute that the property \nrepresents.  \nproducing  output  \nThe Process  method transforms an element by configuring the TagHelperOutput  \nobject that is received as an argument. The TagHelperOuput  object starts by describ-\ning the HTML element as it appears in the view and is modified through the properties \nand methods described in table 25.4.  \nTable 25.4    The TagHelperOutput properties and methods\nName Description\nTagName This property is used to get or set the tag name for the output element.\nAttributes This property returns a dictionary containing the attributes for the out-\nput element.\nContent This property returns a TagHelperContent  object that is used to set \nthe content of the element. \nGetChildContentAsync() This asynchronous method provides access to the content of the ele-\nment that will be transformed, as demonstrated in the “Creating Short-\nhand Elements” section.\nPreElement This property returns a TagHelperContext  object that is used to \ninsert content in the view before the output element. See the “Prepend-\ning and Appending Content and Elements”  section.\nPostElement This property returns a TagHelperContext  object that is used to \ninsert content in the view after the output element. See the “Prepending \nand Appending Content and Elements”  section.\nPreContent This property returns a TagHelperContext  object that is used to \ninsert content before the output element’s content. See the “Prepend-\ning and Appending Content and Elements”  section.\nPostContent This property returns a TagHelperContext  object that is used to \ninsert content after the output element’s content. See the “Prepending \nand Appending Content and Elements”  section.\nTagMode This property specifies how the output element will be written, using a \nvalue from the TagMode  enumeration. See the “Creating Shorthand \nElements” section.\nSupressOuput() Calling this method excludes an element from the view. See the “Sup-\npressing the Output Element” section.",7519
291-25.2.2 Registering tag helpers.pdf,291-25.2.2 Registering tag helpers,,0
292-25.2.3 Using a tag helper.pdf,292-25.2.3 Using a tag helper,"698 chapter  25 Using tag helpers\nIn the TrTagHelper  class, I used the Attributes  dictionary to add a class  attri-\nbute to the HTML element that specifies Bootstrap styles, including the value of the \nBgColor  and TextColor  properties. The effect is that the background color for tr \nelements can be specified by setting bg-color  and text-color  attributes to Bootstrap \nnames, such as primary , info , and danger .\n25.2.2  Registering tag helpers\nTag helper classes must be registered with the @addTagHelper  directive before they \ncan be used. The set of views or pages to which a tag helper can be applied depends on \nwhere the @addTagHelper  directive is used. \nFor a single view or page, the directive appears in the CSHTML file itself. To make \na tag helper available more widely, it can be added to the view imports file, which is \ndefined in the Views  folder for controllers and the Pages  folder for Razor Pages.\nI want the tag helpers that I create in this chapter to be available anywhere in the \napplication, which means that the @addTagHelper  directive is added to the _View-\nImports.cshtml  files in the Views  and Pages  folders. The vc element used in chap-\nter 24 to apply view components is a tag helper, which is why the directive required to \nenable tag helpers is already in the _ViewImports.cshtml  file.\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@using WebApp.Components\n@addTagHelper *, WebApp\nThe first part of the argument specifies the names of the tag helper classes, with sup-\nport for wildcards, and the second part specifies the name of the assembly in which \nthey are defined. This @addTagHelper  directive uses the wildcard to select all name-\nspaces in the WebApp  assembly, with the effect that tag helpers defined anywhere in the \nproject can be used in any controller view. There is an identical statement in the Razor \nPages _ViewImports.cshtml  file in the Pages  folder.\n@namespace WebApp.Pages\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@addTagHelper *, WebApp\nThe other @addTagHelper  directive enables the built-in tag helpers that Microsoft \nprovides, which are described in chapter 26.\n25.2.3  Using a tag helper\nThe final step is to use the tag helper to transform an element. In listing 25.7, I have \nadded the attribute to the tr element, which will apply the tag helper.\nListing 25.7    Using a tag helper in the Index.cshtml file in the Views/Home folder \n@model Product?\n@{  \n    Layout = ""_SimpleLayout"";\n}\n 699 Creating a tag helper\n<table class=""table table-striped table-bordered table-sm"">\n    <thead>\n        <tr bg-color=""info"" text-color=""white"">\n            <th colspan=""2"">Product Summary</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr><th>Name</th><td>@Model?.Name</td></tr>\n        <tr><th>Price</th><td>@Model?.Price.ToString(""c"")</td></tr>\n        <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n    </tbody>\n</table>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home, \nwhich produces the response shown in figure 25.2.\nFigure 25.2    \nUsing a tag \nhelper\nThe tr element to which the attributes were applied in listing 25.7 has been trans-\nformed, but that isn’t the only change shown in the figure. By default, tag helpers \napply to all elements of a specific type, which means that all the tr elements in the view \nhave been transformed using the default values defined in the tag helper class, since \nno attributes were defined. (The reason that some table rows show no text is because \nof the Bootstrap table-striped  class, which applies different styles to alternate rows.)\nIn fact, the problem is more serious because the @addTagHelper  directives in the \nview import files mean that the example tag helper is applied to all tr elements used \nin any view rendered by controllers and Razor Pages. Use a browser to request http://\nlocalhost:5000/cities, for example, and you will see the tr elements in the response \nfrom the Cities  Razor Page have also been transformed, as shown in figure 25.3.\nFigure 25.3    \nUnexpectedly \nmodifying elements \nwith a tag helper",4224
293-25.2.5 Widening the scope of a tag helper.pdf,293-25.2.5 Widening the scope of a tag helper,"700 chapter  25 Using tag helpers\n25.2.4  Narrowing the scope of a tag helper\nThe range of elements that are transformed by a tag helper can be controlled using the \nHtmlTargetElement  element, as shown in listing 25.8.  \nListing 25.8    Narrowing scope in the TrTagHelper.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""tr"", Attributes = ""bg-color,text-color"", \n        ParentTag = ""thead"")]\n    public class TrTagHelper : TagHelper {\n        public string BgColor { get; set; } = ""dark"";\n        public string TextColor { get; set; } = ""white"";\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            output.Attributes.SetAttribute(""class"",\n                $""bg-{BgColor} text-center text-{TextColor}"");\n        }\n    }\n}\nThe HtmlTargetElement  attribute describes the elements to which the tag helper \napplies. The first argument specifies the element type and supports the additional \nnamed properties described in table 25.5.  \nTable 25.5    The HtmlTargetElement properties\nName Description\nAttributes This property is used to specify that a tag helper should be \napplied only to elements that have a given set of attributes, \nsupplied as a comma-separated list. An attribute name that \nends with an asterisk will be treated as a prefix so that bg-*  \nwill match bg-color , bg-size , and so on. \nParentTag This property is used to specify that a tag helper should be \napplied only to elements that are contained within an element \nof a given type. \nTagStructure This property is used to specify that a tag helper should be \napplied only to elements whose tag structure corresponds \nto the given value from the TagStructure  enumeration, \nwhich defines Unspecified , NormalOrSelfClosing , and \nWithoutEndTag . \nThe Attributes  property supports CSS attribute selector syntax so that [bg-color]  \nmatches elements that have a bg-color  attribute, [bg-color=primary]  matches ele-\nments that have a bg-color  attribute whose value is primary , and [bg-color^=p]  \nmatches elements with a bg-color  attribute whose value begins with p. The attribute \n 701 Creating a tag helper\napplied to the tag helper in listing 25.8 matches tr elements with both bg-color  and \ntext-color  attributes that are children of a thead  element. Restart ASP.NET Core \nand use a browser to request http://localhost:5000/home/index/1, and you will see \nthe scope of the tag helper has been narrowed, as shown in figure 25.4.\nFigure 25.4    Narrowing the scope of a tag helper\n25.2.5  Widening the scope of a tag helper \nThe HtmlTargetElement  attribute can also be used to widen the scope of a tag helper \nso that it matches a broader range of elements. This is done by setting the attribute’s \nfirst argument to an asterisk (the * character), which matches any element. Listing \n25.9 changes the attribute applied to the example tag helper so that it matches any \nelement that has bg-color  and text-color  attributes.  \nListing 25.9    Widening scope in the TrTagHelper.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""*"", Attributes = ""bg-color,text-color"")]\n    public class TrTagHelper : TagHelper {\n        public string BgColor { get; set; } = ""dark"";\n        public string TextColor { get; set; } = ""white"";\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            output.Attributes.SetAttribute(""class"",\n                $""bg-{BgColor} text-center text-{TextColor}"");\n        }\n    }\n}\nCare must be taken when using the asterisk because it is easy to match too widely and \nselect elements that should not be transformed. A safer middle ground is to apply the \nHtmlTargetElement  attribute for each type of element, as shown in listing 25.10.\n702 chapter  25 Using tag helpers\nListing 25.10    Balancing scope in the TrTagHelper.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""tr"", Attributes = ""bg-color,text-color"")]\n    [HtmlTargetElement(""td"", Attributes = ""bg-color"")]\n    public class TrTagHelper : TagHelper {\n        public string BgColor { get; set; } = ""dark"";\n        public string TextColor { get; set; } = ""white"";\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            output.Attributes.SetAttribute(""class"",\n                $""bg-{BgColor} text-center text-{TextColor}"");\n        }\n    }\n}\nEach instance of the attribute can use different selection criteria. This tag helper \nmatches tr elements with bg-color  and text-color  attributes and matches td ele-\nments with bg-color  attributes. Listing 25.11 adds an element to be transformed to \nthe Index  view to demonstrate the revised scope.\nListing 25.11    Adding attributes in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<table class=""table table-striped table-bordered table-sm"">\n    <thead>\n        <tr bg-color=""info"" text-color=""white"">\n            <th colspan=""2"">Product Summary</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr><th>Name</th><td>@Model?.Name</td></tr>\n        <tr>\n            <th>Price</th>\n            <td bg-color=""dark"">@Model?.Price.ToString(""c"")</td>\n        </tr>\n        <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n    </tbody>\n</table>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1. The response will contain two transformed elements, as shown in figure 25.5.",5807
294-25.3 Advanced tag helper features.pdf,294-25.3 Advanced tag helper features,,0
295-25.3.1 Creating shorthand elements.pdf,295-25.3.1 Creating shorthand elements,"703 Advanced tag helper features\nFigure 25.5    Managing the scope of a tag helper\nOrdering tag helper execution \nIf you need to apply multiple tag helpers to an element, you can control the sequence \nin which they execute by setting the Order  property, which is inherited from the \nTagHelper  base class. Managing the sequence can help minimize the conflicts \nbetween tag helpers, although it is still easy to encounter problems.\n25.3 Advanced tag helper features\nThe previous section demonstrated how to create a basic tag helper, but that just \nscratches the surface of what’s possible. In the sections that follow, I show more \nadvanced uses for tag helpers and the features they provide.\n25.3.1  Creating shorthand elements \nTag helpers are not restricted to transforming the standard HTML elements and can \nalso be used to replace custom elements with commonly used content. This can be a \nuseful feature for making views more concise and making their intent more obvious. \nTo demonstrate, listing 25.12 replaces the thead  element in the Index  view with a cus-\ntom HTML element.  \nListing 25.12    Adding a custom element in the Index.cshtml file in the Views/Home \nfolder\n@model Product?\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<table class=""table table-striped table-bordered table-sm"">\n    <tablehead bg-color=""dark"">Product Summary</tablehead>    \n    <tbody>\n        <tr><th>Name</th><td>@Model?.Name</td></tr>\n        <tr>\n            <th>Price</th>\n            <td bg-color=""dark"">@Model?.Price.ToString(""c"")</td>\n704 chapter  25 Using tag helpers\n        </tr>\n        <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n    </tbody>\n</table>\nThe tablehead  element isn’t part of the HTML specification and won’t be understood \nby browsers. Instead, I am going to use this element as shorthand for generating the \nthead  element and its content for the HTML table. Add a class named TableHead -\nTagHelper.cs  to the TagHelpers  folder and use it to define the class shown in listing \n25.13.\nTIP    When dealing with custom elements that are not part of the HTML speci-\nfication, you must apply the HtmlTargetElement  attribute and specify the ele-\nment name, as shown in listing 25.13. The convention of applying tag helpers to \nelements based on the class name works only for standard element names.\nListing 25.13    The contents of TableHeadTagHelper.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""tablehead"")]\n    public class TableHeadTagHelper : TagHelper {\n        public string BgColor { get; set; } = ""light"";\n        public override async Task ProcessAsync(TagHelperContext context,\n                TagHelperOutput output) {\n            output.TagName = ""thead"";\n            output.TagMode = TagMode.StartTagAndEndTag;\n            output.Attributes.SetAttribute(""class"",\n                $""bg-{BgColor} text-white text-center"");\n            string content = \n                (await output.GetChildContentAsync()).GetContent();\n            output.Content.SetHtmlContent(\n                $""<tr><th colspan=\""2\"">{content}</th></tr>"");\n        }\n    }\n}\nThis tag helper is asynchronous and overrides the ProcessAsync  method so that it can \naccess the existing content of the elements it transforms. The ProcessAsync  method \nuses the properties of the TagHelperOuput  object to generate a completely differ-\nent element: the TagName  property is used to specify a thead element, the TagMode  \nproperty is used to specify that the element is written using start and end tags, the  \nAttributes.SetAttribute  method is used to define a class  attribute, and the  \nContent  property is used to set the element content.\nThe existing content of the element is obtained through the asynchronous \nGetChildContentAsync  method, which returns a TagHelperContent  object. This \n 705 Advanced tag helper features\nis the same object that is returned by the TagHelperOutput.Content  property and \nallows the content of the element to be inspected and changed using the same type, \nthrough the methods described in table 25.6.\nTable 25.6    Useful TagHelperContent methods\nName Description\nGetContent() This method returns the contents of the HTML element as a \nstring.\nSetContent(text) This method sets the content of the output element. The \nstring  argument is encoded so that it is safe for inclusion \nin an HTML element. \nSetHtmlContent(html) This method sets the content of the output element. The \nstring  argument is assumed to be safely encoded. Use \nwith caution.\nAppend(text) This method safely encodes the specified string  and adds \nit to the content of the output element. \nAppendHtml(html) This method adds the specified string  to the content of \nthe output element without performing any encoding. Use \nwith caution.\nClear() This method removes the content of the output element.\nIn listing 25.13, the existing content of the element is read through the GetContent  \nelement and then set using the SetHtmlContent  method. The effect is to wrap the \nexisting content in the transformed element in tr and th elements.\nRestart ASP.NET Core and navigate to http://localhost:5000/home/index/1, and \nyou will see the effect of the tag helper, which is shown in figure 25.6.\nFigure 25.6    \nUsing a shorthand \nelement\nThe tag helper transforms this shorthand element:\n...\n<tablehead bg-color=""dark"">Product Summary</tablehead>\n...\ninto these elements:\n...\n<thead class=""bg-dark text-white text-center"">\n    <tr>",5623
296-25.3.3 Prepending and appending content and elements.pdf,296-25.3.3 Prepending and appending content and elements,"706 chapter  25 Using tag helpers\n        <th colspan=""2"">Product Summary</th>\n    </tr>\n</thead>\n...\nNotice that the transformed elements do not include the bg-color  attribute. Attri-\nbutes matched to properties defined by the tag helper are removed from the output \nelement and must be explicitly redefined if they are required.\n25.3.2  Creating elements programmatically \nWhen generating new HTML elements, you can use standard C# string formatting \nto create the content you require, which is the approach I took in listing 25.13. This \nworks, but it can be awkward and requires close attention to avoid typos. A more \nrobust approach is to use the TagBuilder  class, which is defined in the Microsoft \n. AspNetCore.Mvc.Rendering  namespace and allows elements to be created in a \nmore structured manner. The TagHelperContent  methods described in table 25.6 \naccept TagBuilder  objects, which makes it easy to create HTML content in tag help-\ners, as shown in listing 25.14.  \nListing 25.14    HTML elements in the TableHeadTagHelper.cs file in the  \nTagHelpers folder\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""tablehead"")]\n    public class TableHeadTagHelper: TagHelper {\n        \n        public string BgColor { get; set; } = ""light"";\n        public override async Task ProcessAsync(TagHelperContext context, \n                TagHelperOutput output) {\n            output.TagName = ""thead"";\n            output.TagMode = TagMode.StartTagAndEndTag;\n            output.Attributes.SetAttribute(""class"", \n                $""bg-{BgColor} text-white text-center"");\n            string content =\n                (await output.GetChildContentAsync()).GetContent();\n            TagBuilder header = new TagBuilder(""th"");\n            header.Attributes[""colspan""] = ""2"";\n            header.InnerHtml.Append(content);\n            TagBuilder row = new TagBuilder(""tr"");\n            row.InnerHtml.AppendHtml(header);\n            output.Content.SetHtmlContent(row);\n        }\n    }\n}\n 707 Advanced tag helper features\nThis example creates each new element using a TagBuilder  object and composes \nthem to produce the same HTML structure as the string-based version in listing 25.13.\n25.3.3  Prepending and appending content and elements\nThe TagHelperOutput  class provides four properties that make it easy to inject \nnew content into a view so that it surrounds an element or the element’s content, as \ndescribed in table 25.7. In the sections that follow, I explain how you can insert content \naround and inside the target element.\nTable 25.7    The TagHelperOutput properties for appending context and elements\nName Description\nPreElement This property is used to insert elements into the view \nbefore the target element.\nPostElement This property is used to insert elements into the view after \nthe target element.\nPreContent This property is used to insert content into the target ele-\nment, before any existing content.\nPostContent This property is used to insert content into the target ele-\nment, after any existing content.\ninserting  content  around  the output  element  \nThe first TagHelperOuput  properties are PreElement  and PostElement , which are \nused to insert elements into the view before and after the output element. To demon-\nstrate the use of these properties, add a class file named ContentWrapperTagHelper \n.cs to the WebApp/TagHelpers  folder with the content shown in listing 25.15.\nListing 25.15    The contents of the WrapperTagHelper.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""*"", Attributes = ""[wrap=true]"")]\n    public class ContentWrapperTagHelper: TagHelper {\n        public override void Process(TagHelperContext context, \n                TagHelperOutput output) {\n            TagBuilder elem = new TagBuilder(""div"");\n            elem.Attributes[""class""] = ""bg-primary text-white p-2 m-2"";\n            elem.InnerHtml.AppendHtml(""Wrapper"");\n            output.PreElement.AppendHtml(elem);\n            output.PostElement.AppendHtml(elem);\n        }\n    }\n}\n708 chapter  25 Using tag helpers\nThis tag helper transforms elements that have a wrap  attribute whose value is true , \nwhich it does using the PreElement  and PostElement  properties to add a div ele-\nment before and after the output element. Listing 25.16 adds an element to the Index  \nview that is transformed by the tag helper.\nListing 25.16    Adding an element in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{\n    Layout = ""_SimpleLayout"";\n}\n<div class=""m-2"" wrap=""true"">Inner Content</div>\n<table class=""table table-striped table-bordered table-sm"">\n    <tablehead bg-color=""dark"">Product Summary</tablehead>    \n    <tbody>\n        <tr><th>Name</th><td>@Model?.Name</td></tr>\n        <tr>\n            <th>Price</th>\n            <td bg-color=""dark"">@Model?.Price.ToString(""c"")</td>\n        </tr>\n        <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n    </tbody>\n</table>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1. The response includes the transformed element, as shown in figure 25.7.\nFigure 25.7    Inserting content around the output element\nIf you examine the HTML sent to the browser, you will see that this element:\n...\n<div class=""m-2"" wrap=""true"">Inner Content</div>\n...\nhas been transformed into these elements:\n 709 Advanced tag helper features\n...\n<div class=""bg-primary text-white p-2 m-2"">Wrapper</div>\n<div class=""m-2"" wrap=""true"">Inner Content</div>\n<div class=""bg-primary text-white p-2 m-2"">Wrapper</div>\n...\nNotice that the wrap  attribute has been left on the output element. This is because I \ndidn’t define a property in the tag helper class that corresponds to this attribute. If you \nwant to prevent attributes from being included in the output, then define a property \nfor them in the tag helper class, even if you don’t use the attribute value. \ninserting  content  inside  the output  element  \nThe PreContent  and PostContent  properties are used to insert content inside the \noutput element, surrounding the original content. To demonstrate this feature, add \na class file named HighlightTagHelper.cs  to the TagHelpers  folder and use it to \ndefine the tag helper shown in listing 25.17.\nListing 25.17    The contents of the HighlightTagHelper.cs file in the TagHelpers folder \nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""*"", Attributes = ""[highlight=true]"")]\n    public class HighlightTagHelper: TagHelper {\n        public override void Process(TagHelperContext context, \n                TagHelperOutput output) {\n            output.PreContent.SetHtmlContent(""<b><i>"");\n            output.PostContent.SetHtmlContent(""</i></b>"");\n        }\n    }\n}\nThis tag helper inserts b and i elements around the output element’s content. Listing \n25.18 adds the wrap attribute to one of the table cells in the Index  view.\nListing 25.18    Adding an attribute in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<div class=""m-2"" wrap=""true"">Inner Content</div>\n<table class=""table table-striped table-bordered table-sm"">\n    <tablehead bg-color=""dark"">Product Summary</tablehead>    \n    <tbody>\n        <tr><th>Name</th><td highlight=""true"">@Model?.Name</td></tr>\n        <tr>\n            <th>Price</th>\n            <td bg-color=""dark"">@Model?.Price.ToString(""c"")</td>",7740
297-25.3.4 Getting view context data.pdf,297-25.3.4 Getting view context data,"710 chapter  25 Using tag helpers\n        </tr>\n        <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n    </tbody>\n</table>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1. The response includes the transformed element, as shown in figure 25.8.\nFigure 25.8    Inserting content inside an element\nIf you examine the HTML sent to the browser, you will see that this element:\n...\n<td highlight=""true"">@Model?.Name</td>\n...\nhas been transformed into these elements:\n...\n<td highlight=""true""><b><i>Kayak</i></b></td>\n...\n25.3.4  Getting view context data\nA common use for tag helpers is to transform elements so they contain details of the \ncurrent request or the view model/page model, which requires access to context data. \nTo create this type of tag helper, add a file named RouteDataTagHelper.cs  to the \nTagHelpers  folder, with the content shown in listing 25.19.  \nListing 25.19    The contents of the RouteDataTagHelper.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""div"", Attributes = ""[route-data=true]"")]\n    public class RouteDataTagHelper : TagHelper {\n        [ViewContext]\n 711 Advanced tag helper features\n        [HtmlAttributeNotBound]\n        public ViewContext Context { get; set; } = new();\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            output.Attributes.SetAttribute(""class"", ""bg-primary m-2 p-2"");\n            TagBuilder list = new TagBuilder(""ul"");\n            list.Attributes[""class""] = ""list-group"";\n            RouteValueDictionary rd = Context.RouteData.Values;\n            if (rd.Count > 0) {\n                foreach (var kvp in rd) {\n                    TagBuilder item = new TagBuilder(""li"");\n                    item.Attributes[""class""] = ""list-group-item"";\n                    item.InnerHtml.Append($""{kvp.Key}: {kvp.Value}"");\n                    list.InnerHtml.AppendHtml(item);\n                }\n                output.Content.AppendHtml(list);\n            } else {\n                output.Content.Append(""No route data"");\n            }\n        }\n    }\n}\nThe tag helper transforms div elements that have a route-data  attribute whose value \nis true  and populates the output element with a list of the segment variables obtained \nby the routing system.  \nTo get the route data, I added a property called Context  and decorated it with two \nattributes, like this:\n...\n[ViewContext]\n[HtmlAttributeNotBound]\npublic ViewContext Context { get; set; } = new();\n...\nThe ViewContext  attribute denotes that the value of this property should be assigned \na ViewContext  object when a new instance of the tag helper class is created, which pro-\nvides details of the view that is being rendered, including the routing data, as described \nin chapter 13. \nThe HtmlAttributeNotBound  attribute prevents a value from being assigned to this \nproperty if there is a matching attribute defined on the div element. This is good prac-\ntice, especially if you are writing tag helpers for other developers to use.\nTIP    Tag helpers can declare dependencies on services in their constructors, \nwhich are resolved using the dependency injection feature described in chapter \n14.\nListing 25.20 adds an element to the Home  controller’s Index  view that will be trans-\nformed by the new tag helper.",3568
298-25.3.5 Working with model expressions.pdf,298-25.3.5 Working with model expressions,"712 chapter  25 Using tag helpers\nListing 25.20    Adding an element in the Index.cshtml file in the Views/Home folder\n@model Product?\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<div route-data=""true""></div>\n<table class=""table table-striped table-bordered table-sm"">\n    <tablehead bg-color=""dark"">Product Summary</tablehead>    \n    <tbody>\n        <tr><th>Name</th><td highlight=""true"">@Model?.Name</td></tr>\n        <tr>\n            <th>Price</th>\n            <td bg-color=""dark"">@Model?.Price.ToString(""c"")</td>\n        </tr>\n        <tr><th>Category ID</th><td>@Model?.CategoryId</td></tr>\n    </tbody>\n</table>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/1. The response will include a list of the segment variables the routing system \nhas matched, as shown in figure 25.9.\nFigure 25.9    Displaying context data with a tag helper\n25.3.5  Working with model expressions\nTag helpers can operate on the view model, tailoring the transformations they per-\nform or the output they create. To see how this feature works, add a class file named  \nModelRowTagHelper.cs  to the TagHelpers  folder, with the code shown in listing \n25.21.  \n 713 Advanced tag helper features\nListing 25.21    The contents of the ModelRowTagHelper.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""tr"", Attributes = ""for"")]\n    public class ModelRowTagHelper : TagHelper {\n        public string Format { get; set; } = """";\n        public ModelExpression? For { get; set; }\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            output.TagMode = TagMode.StartTagAndEndTag;\n            TagBuilder th = new TagBuilder(""th"");\n            th.InnerHtml.Append(For?.Name ?? String.Empty);\n            output.Content.AppendHtml(th);\n            TagBuilder td = new TagBuilder(""td"");\n            if (Format != null && \n                    For?.Metadata.ModelType == typeof(decimal)) {\n                td.InnerHtml.Append(((decimal)For.Model)\n                    .ToString(Format));\n            } else {\n                td.InnerHtml.Append(For?.Model.ToString() \n                    ?? String.Empty);\n            }\n            output.Content.AppendHtml(td);\n        }\n    }\n}\nThis tag helper transforms tr elements that have a for attribute. The important part \nof this tag helper is the type of the For property, which is used to receive the value of \nthe for attribute.\n...\npublic ModelExpression?  For { get; set; }\n...\nThe ModelExpression  class is used when you want to operate on part of the view \nmodel, which is most easily explained by jumping forward and showing how the tag \nhelper is applied in the view, as shown in listing 25.22.\nNOTE    The ModelExpression  feature can be used only on view models or page \nmodels. It cannot be used on variables that are created within a view, such as with \na @foreach  expression. \n714 chapter  25 Using tag helpers\nListing 25.22    Using the tag helper in the Index.cshtml file in the Views/Home folder\n@model Product\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<div route-data=""true""></div>\n<table class=""table table-striped table-bordered table-sm"">\n    <tablehead bg-color=""dark"">Product Summary</tablehead>    \n    <tbody>\n        <tr for=""Name"" />\n        <tr for=""Price"" format=""c"" />\n        <tr for=""CategoryId"" />\n    </tbody>\n</table>\nThe value of the for attribute is the name of a property defined by the view model \nclass. When the tag helper is created, the type of the For property is detected and \nassigned a ModelExpression  object that describes the selected property. \nNotice that I have changed the view model type in listing 25.22. This is important \nbecause the ModelExpression  feature works on non-nullable types. This is a useful fea-\nture, but it presents the problems with null values that I described in chapter 21.\nI am not going to describe the ModelExpression  class in any detail because any \nintrospection on types leads to endless lists of classes and properties. Further, ASP.NET \nCore provides a useful set of built-in tag helpers that use the view model to transform \nelements, as described in chapter 26, which means you don’t need to create your own. \nFor the example tag helper, I use three basic features that are worth describing. The \nfirst is to get the name of the model property so that I can include it in the output ele-\nment, like this:\n...\nth.InnerHtml.Append( For?.Name  ?? String.Empty);\n...\nThe Name  property returns the name of the model property. The second feature is to \nget the type of the model property so that I can determine whether to format the value, \nlike this:\n...\nif (Format != null && For?.Metadata.ModelType  == typeof(decimal)) {\n...\nThe third feature is to get the value of the property so that it can be included in the \nresponse.\n...\ntd.InnerHtml.Append( For?.Model .ToString() ?? String.Empty);\n...\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/\nindex/2, and you will see the response shown in figure 25.10.\n 715 Advanced tag helper features\nFigure 25.10    Using the view model in a tag helper\nworking  with the page model  \nTag helpers with model expressions can be applied in Razor Pages, although the \nexpression that selects the property must account for the way that the Model  property \nreturns the page model class. Listing 25.23 applies the tag helper to the Editor  Razor \nPage, whose page model defines a Product  property.\nListing 25.23    Applying a tag helper in the Editor.cshtml file in the Pages folder \n@page ""{id:long}""\n@model EditorModel\n@{\n    Layout = null;\n}\n<!DOCTYPE html>\n<html>\n<head>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""bg-primary text-white text-center m-2 p-2"">Editor</div>\n    <div class=""m-2"">\n        <table class=""table table-sm table-striped table-bordered"">\n            <tbody>\n                <tr for=""Product.Name"" />\n                <tr for=""Product.Price"" format=""c"" />\n            </tbody>\n        </table>\n        <form method=""post"">\n            @Html.AntiForgeryToken()\n            <div class=""form-group"">\n                <label>Price</label>\n                <input name=""price"" class=""form-control""\n                       value=""@Model.Product?.Price"" />\n            </div>\n716 chapter  25 Using tag helpers\n            <button class=""btn btn-primary mt-2"" type=""submit"">\n                Submit\n            </button>\n        </form>\n    </div>\n</body>\n</html>\nThe value for the for attribute selects the nested properties through the Product  \nproperty, which provides the tag helper with the ModelExpression  it requires. \nModel expressions cannot be used with the null conditional operator, which \npresents a problem for this example because the type of the Product  property is  \nProduct? . Listing 25.24 changes the property type to Product  and assigns a default \nvalue. (I demonstrate a different way of resolving this issue in chapter 27.)\nListing 25.24    Changing a property type in the Editor.cshtml.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing WebApp.Models;\nnamespace WebApp.Pages {\n    public class EditorModel : PageModel {\n        private DataContext context;\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        public EditorModel(DataContext ctx) {\n            context = ctx;\n        }\n        public async Task OnGetAsync(long id) {\n            Product = await context.Products.FindAsync(id) \n                ?? new() { Name = string.Empty };\n        }\n        public async Task<IActionResult> OnPostAsync(long id, \n                decimal price) {\n            Product? p = await context.Products.FindAsync(id);\n            if (p != null) {\n                p.Price = price;\n            }\n            await context.SaveChangesAsync();\n            return RedirectToPage();\n        }\n    }\n}\nRestart ASP.NET Core and a browser to request http://localhost:5000/editor/1 to see \nthe response from the page, which is shown on the left of figure 25.11.\n 717 Advanced tag helper features\nFigure 25.11    Using a model expression tag helper with a Razor Page\nOne consequence of the page model is that the ModelExpression.Name  property will \nreturn Product.Name , for example, instead of just Name . Listing 25.25 updates the tag \nhelper so that it will display just the last part of the model expression name.\nNOTE     This example is intended to highlight the effect of the page model on \nmodel expressions. Instead of displaying just the last part of the name, a more \nflexible approach is to add support for another attribute that allows the display \nvalue to be overridden as needed.\nListing 25.25    Handling names in the ModelRowTagHelper.cs file in the TagHelpers \nfolder \nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""tr"", Attributes = ""for"")]\n    public class ModelRowTagHelper : TagHelper {\n        public string Format { get; set; } = """";\n        public ModelExpression? For { get; set; }\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            output.TagMode = TagMode.StartTagAndEndTag;\n            TagBuilder th = new TagBuilder(""th"");\n            th.InnerHtml.Append(For?.Name.Split(""."").Last() \n                ?? String.Empty);\n            output.Content.AppendHtml(th);\n            TagBuilder td = new TagBuilder(""td"");\n            if (Format != null && \n                    For?.Metadata.ModelType == typeof(decimal)) {\n                td.InnerHtml.Append(((decimal)For.Model)\n                    .ToString(Format));\n            } else {",10196
299-25.3.6 Coordinating between tag helpers.pdf,299-25.3.6 Coordinating between tag helpers,"718 chapter  25 Using tag helpers\n                td.InnerHtml.Append(For?.Model.ToString() \n                    ?? String.Empty);\n            }\n            output.Content.AppendHtml(td);\n        }\n    }\n}\nRestart ASP.NET Core and use a browser to request http://localhost:5000/editor/1; \nyou will see the revised response, which is shown on the right of figure 25.11.\n25.3.6  Coordinating between tag helpers\nThe TagHelperContext.Items  property provides a dictionary used by tag helpers \nthat operate on elements and those that operate on their descendants. To demonstrate \nthe use of the Items  collection, add a class file named CoordinatingTagHelpers.cs  \nto the WebApp/TagHelpers  folder and add the code shown in listing 25.26.  \nListing 25.26    The CoordinatingTagHelpers.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""tr"", Attributes = ""theme"")]\n    public class RowTagHelper : TagHelper {\n        public string Theme { get; set; } = String.Empty;\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            context.Items[""theme""] = Theme;\n        }\n    }\n    [HtmlTargetElement(""th"")]\n    [HtmlTargetElement(""td"")]\n    public class CellTagHelper : TagHelper {\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            if (context.Items.ContainsKey(""theme"")) {\n                output.Attributes.SetAttribute(""class"",\n                    $""bg-{context.Items[""theme""]} text-white"");\n            }\n        }\n    }\n}\nThe first tag helper operates on tr elements that have a theme  attribute. Coordinating \ntag helpers can transform their own elements, but this example simply adds the value \nof the theme  attribute to the Items  dictionary so that it is available to tag helpers that \noperate on elements contained within the tr element. The second tag helper operates \non th and td elements and uses the theme  value from the Items  dictionary to set the \nBootstrap style for its output elements. \n 719 Advanced tag helper features\nListing 25.27 adds elements to the Home  controller’s Index  view that apply the coor-\ndinating tag helpers.\nNOTE     Notice that I have added the th and td elements that are transformed \nin listing 25.27, instead of relying on a tag helper to generate them. Tag helpers \nare not applied to elements generated by other tag helpers and affect only the \nelements defined in the view.\nListing 25.27    Applying a tag helper in the Index.cshtml file in the Views/Home folder\n@model Product\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<div route-data=""true""></div>\n<table class=""table table-striped table-bordered table-sm"">\n    <tablehead bg-color=""dark"">Product Summary</tablehead>    \n    <tbody>\n        <tr theme=""primary"">\n            <th>Name</th><td>@Model?.Name</td>\n        </tr>\n        <tr theme=""secondary"">\n            <th>Price</th><td>@Model?.Price.ToString(""c"")</td>\n        </tr>\n        <tr theme=""info"">\n            <th>Category</th><td>@Model?.CategoryId</td>\n        </tr>\n    </tbody>\n</table>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home, \nwhich produces the response shown in figure 25.12. The value of the theme  element \nhas been passed from one tag helper to another, and a color theme is applied without \nneeding to define attributes on each of the elements that is transformed.\nFigure 25.12    Coordination between tag helpers",3592
300-25.4 Using tag helper components.pdf,300-25.4 Using tag helper components,"720 chapter  25 Using tag helpers\n25.3.7  Suppressing the output element \nTag helpers can be used to prevent an element from being included in the HTML \nresponse by calling the SuppressOuput  method on the TagHelperOutput  object that \nis received as an argument to the Process  method. In listing 25.28, I have added an \nelement to the Home  controller’s Index  view that should be displayed only if the Price  \nproperty of the view model exceeds a specified value.  \nListing 25.28    Adding an element in the Index.cshtml file in the Views/Home folder\n@model Product\n@{  \n    Layout = ""_SimpleLayout"";\n}\n<div show-when-gt=""500"" for=""Price"">\n    <h5 class=""bg-danger text-white text-center p-2"">\n        Warning: Expensive Item\n    </h5>\n</div>\n<table class=""table table-striped table-bordered table-sm"">\n    <tablehead bg-color=""dark"">Product Summary</tablehead>    \n    <tbody>\n        <tr theme=""primary"">\n            <th>Name</th><td>@Model?.Name</td>\n        </tr>\n        <tr theme=""secondary"">\n            <th>Price</th><td>@Model?.Price.ToString(""c"")</td>\n        </tr>\n        <tr theme=""info"">\n            <th>Category</th><td>@Model?.CategoryId</td>\n        </tr>\n    </tbody>\n</table>\nThe show-when-gt  attribute specifies the value above which the div element should \nbe displayed, and the for property selects the model property that will be inspected. \nTo create the tag helper that will manage the elements, including the response, add a \nclass file named SelectiveTagHelper.cs  to the WebApp/TagHelpers  folder with the \ncode shown in listing 25.29.\nListing 25.29    The contents of the SelectiveTagHelper.cs file in the TagHelpers folder \nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""div"", Attributes = ""show-when-gt, for"")]\n    public class SelectiveTagHelper : TagHelper {\n        public decimal ShowWhenGt { get; set; }",1982
301-25.4.1 Creating a tag helper component.pdf,301-25.4.1 Creating a tag helper component,"721 Using tag helper components \n        public ModelExpression? For { get; set; }\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            if (For?.Model.GetType() == typeof(decimal)\n                    && (decimal)For.Model <= ShowWhenGt) {\n                output.SuppressOutput();\n            }\n        }\n    }\n}\nThe tag helper uses the model expression to access the property and calls the  \nSuppressOutput  method unless the threshold is exceeded. To see the effect, restart \nASP.NET Core and use a browser to request http://localhost:5000/home/index/1 \nand http://localhost:5000/home/index/5. The value for the Price  property of the \nProduct  selected by the first URL is less than the threshold, so the element is sup-\npressed. The value for the Price  property of the Product  selected by the second \nURL is more than the threshold, so the element is displayed. figure 25.13 shows both \nresponses.\nFigure 25.13    Suppressing output elements\n25.4 Using tag helper components \nTag helper components  provide an alternative approach to applying tag helpers as services. \nThis feature can be useful when you need to set up tag helpers to support another ser-\nvice or middleware component, which is typically the case for diagnostic tools or func-\ntionality that has both a client-side component and a server-side component, such as \nBlazor, which is described in part 4. In the sections that follow, I show you how to create \nand apply tag helper components.  \n25.4.1  Creating a tag helper component \nTag helper components are derived from the TagHelperComponent  class, which pro-\nvides a similar API to the TagHelper  base class used in earlier examples. To create a \ntag helper component, add a class file called TimeTagHelperComponent.cs  in the \nTagHelpers  folder with the content shown in listing 25.30.  \n722 chapter  25 Using tag helpers\nListing 25.30    The TimeTagHelperComponent.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    public class TimeTagHelperComponent : TagHelperComponent {\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            string timestamp = DateTime.Now.ToLongTimeString();\n            if (output.TagName == ""body"") {\n                TagBuilder elem = new TagBuilder(""div"");\n                elem.Attributes.Add(""class"", \n                    ""bg-info text-white m-2 p-2"");\n                elem.InnerHtml.Append($""Time: {timestamp}"");\n                output.PreContent.AppendHtml(elem);\n            }\n        }\n    }\n}\nTag helper components do not specify the elements they transform, and the Process  \nmethod is invoked for every element for which the tag helper component feature has \nbeen configured. By default, tag helper components are applied to transform head  \nand body  elements. This means that tag helper component classes must check the \nTagName  property of the output element to ensure they perform only their intended \ntransformations. The tag helper component in listing 25.30 looks for body  elements \nand uses the PreContent  property to insert a div element containing a timestamp \nbefore the rest of the element’s content.\nTIP    I show you how to increase the range of elements handled by tag helper \ncomponents in the next section.\nTag helper components are registered as services that implement the ITagHelper-\nComponent  interface, as shown in listing 25.31.\nListing 25.31    Registering a component in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nusing WebApp.TagHelpers;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);",4028
302-25.4.2 Expanding tag helper component element selection.pdf,302-25.4.2 Expanding tag helper component element selection,"723 Using tag helper components \n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddSingleton<CitiesData>();\nbuilder.Services.AddTransient<ITagHelperComponent, \n    TimeTagHelperComponent>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe AddTransient  method is used to ensure that each request is handled using its own \ninstance of the tag helper component class. To see the effect of the tag helper compo-\nnent, restart ASP.NET Core and use a browser to request http://localhost:5000/home. \nThis response—and all other HTML responses from the application—contain the con-\ntent generated by the tag helper component, as shown in figure 25.14.\nFigure 25.14    \nUsing a tag helper \ncomponent\n \n25.4.2  Expanding tag helper component element selection \nBy default, only the head  and body  elements are processed by the tag helper compo-\nnents, but additional elements can be selected by creating a class derived from the \nterribly named TagHelperComponentTagHelper  class. Add a class file named Table-\nFooterTagHelperComponent.cs  to the TagHelpers  folder and use it to define the \nclasses shown in listing 25.32.  \n724 chapter  25 Using tag helpers\nListing 25.32    The TableFooterTagHelperComponent.cs file in the TagHelpers folder\nusing Microsoft.AspNetCore.Mvc.Razor.TagHelpers;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing Microsoft.AspNetCore.Razor.TagHelpers;\nnamespace WebApp.TagHelpers {\n    [HtmlTargetElement(""table"")]\n    public class TableFooterSelector : TagHelperComponentTagHelper {\n        public TableFooterSelector(ITagHelperComponentManager mgr,\n            ILoggerFactory log) : base(mgr, log) { }\n    }\n    public class TableFooterTagHelperComponent : TagHelperComponent {\n        public override void Process(TagHelperContext context,\n                TagHelperOutput output) {\n            if (output.TagName == ""table"") {\n                TagBuilder cell = new TagBuilder(""td"");\n                cell.Attributes.Add(""colspan"", ""2"");\n                cell.Attributes.Add(""class"", \n                    ""bg-dark text-white text-center"");\n                cell.InnerHtml.Append(""Table Footer"");\n                TagBuilder row = new TagBuilder(""tr"");\n                row.InnerHtml.AppendHtml(cell);\n                TagBuilder footer = new TagBuilder(""tfoot"");\n                footer.InnerHtml.AppendHtml(row);\n                output.PostContent.AppendHtml(footer);\n            }\n        }\n    }\n}\nThe TableFooterSelector  class is derived from TagHelperComponentTagHelper , \nand it is decorated with the HtmlTargetElement  attribute that expands the range of \nelements processed by the application’s tag helper components. In this case, the attri-\nbute selects table  elements.\nThe TableFooterTagHelperComponent  class, defined in the same file, is a tag \nhelper component that transforms table  elements by adding a tfoot  element, which \nrepresents a table footer. \nCAUTION   Bear in mind that when you create a new TagHelperComponent \nTagHelper , all the tag helper components will receive the elements selected by \nthe HtmlTargetAttribute  element. \nThe tag helper component must be registered as a service to receive elements for \ntransformation, but the tag helper component tag helper (which is one of the worst \nnaming choices I have seen for some years) is discovered and applied automatically. \nListing 25.33 adds the tag helper component service.",3766
303-26.1 Preparing for this chapter.pdf,303-26.1 Preparing for this chapter,"725 Summary\nListing 25.33    Registering a component in the Program.cs file in the WebApp folder\n...\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddSingleton<CitiesData>();\nbuilder.Services.AddTransient<ITagHelperComponent, \n    TimeTagHelperComponent>();\nbuilder.Services.AddTransient<ITagHelperComponent, \n    TableFooterTagHelperComponent>();\n...\nRestart ASP.NET Core and use a browser to request a URL that renders a table, such as \nhttp://localhost:5000/home or http://localhost:5000/cities. Each table will contain a \ntable footer, as shown in figure 25.15.\nFigure 25.15    Expanding tag helper component element selection \nSummary\n¡ Tag helpers are C# classes that transform HTML elements in a response or \nreplace a shorthand element with standard HTML content.\n¡ Tag helpers can be configured using attributes, which are received through a \nTagHelperContext  object.\n¡ Tag helpers must be registered in the view imports file using the @addTagHelper  \ndirective.\n¡ The scope of a tag helper can be controlled with the HTMLTargetElement  attri-\nbute, which allows the elements that are transformed to be specified precisely.\n¡ Tag helpers can use model expressions to generate content for the view model of \nthe view to which they are applied.\n¡ Tag helpers can be registered as services for dependency injection, using the tag \nhelper component function. \n72626Using the built-in  \ntag helpers\nThis chapter covers\n¡ Creating anchor elements that target actions  \n and Razor Pages\n¡ Managing JavaScript and CSS files\n¡ Working with image elements\n¡ Caching fragments of content\n¡ Generating content based on the hosting   \n environment\nASP.NET Core provides a set of built-in tag helpers that apply the most commonly \nrequired element transformations. In this chapter, I explain those tag helpers that \ndeal with anchor, script , link , and image elements, as well as features for caching \ncontent and selecting content based on the environment. In chapter 27, I describe \nthe tag helpers that support HTML forms. Table 26.1 puts the built-in tag helpers in \ncontext.\n 727 Preparing for this chapter\nTable 26.1    Putting the built-in tag helpers in context\nQuestion Answer\nWhat are they? The built-in tag helpers perform commonly required \ntransformations on HTML elements.\nWhy are they \nuseful?Using the built-in tag helpers means you don’t have to \ncreate custom helpers using the techniques in chapter \n25.\nHow are they used? The tag helpers are applied using attributes on standard \nHTML elements or through custom HTML elements.\nAre there any pit-\nfalls or limitations?No, these tag helpers are well-tested and easy to use. \nUnless you have unusual needs, using these tag helpers \nis preferable to custom implementation.\nAre there any \nalternatives?These tag helpers are optional, and their use is not \nrequired.\nTable 26.2 provides a guide to the chapter.\nTable 26.2   Chapter guide\nProblem Solution Listing\nCreating elements that \ntarget endpointsUse the anchor element tag helper \nattributes. 7, 8\nIncluding JavaScript files in \na responseUse the JavaScript tag helper \nattributes.9–13\nIncluding CSS files in a \nresponseUse the CSS tag helper attributes. 14, 15\nManaging image caching Use the image tag helper attributes. 16\nCaching sections of a view Use the caching tag helper. 17–21\nVarying content based \non the application \nenvironmentUse the environment tag helper. 22\n26.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 25. To prepare for this chapter, \ncomment out the statements that register the tag component helpers, as shown in list-\ning 26.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\n728 chapter  26 Using the built-in tag helpers \nListing 26.1    The contents of the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\n//using Microsoft.AspNetCore.Razor.TagHelpers;\n//using WebApp.TagHelpers;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddSingleton<CitiesData>();\n//builder.Services.AddTransient<ITagHelperComponent, \n//    TimeTagHelperComponent>();\n//builder.Services.AddTransient<ITagHelperComponent, \n//    TableFooterTagHelperComponent>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nNext, update the _RowPartial.cshtml  partial view in the Views/Home  folder, making \nthe changes shown in listing 26.2.\nListing 26.2    Making changes in the _RowPartial.cshtml file in the Views/Home folder\n@model Product\n<tr>\n    <td>@Model.Name</td>\n    <td>@Model.Price.ToString(""c"")</td>\n    <td>@Model.CategoryId</td>\n    <td>@Model.SupplierId</td>\n    <td></td>\n</tr>\nReplace the contents of the List.cshtml  file in the Views/Home  folder, which applies \na layout and adds additional columns to the table rendered by the view, as shown in \nlisting 26.3.",5651
304-26.1.1 Adding an image file.pdf,304-26.1.1 Adding an image file,,0
305-26.1.3 Dropping the database.pdf,305-26.1.3 Dropping the database,"729 Preparing for this chapter\nListing 26.3    Making changes in the List.cshtml file in the Views/Home folder\n@model IEnumerable<Product>\n@{ Layout = ""_SimpleLayout""; }\n<h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead>\n            <tr>\n                <th>Name</th><th>Price</th>\n                <th>Category</th><th>Supplier</th><th></th>\n            </tr>\n        </thead>\n        <tbody>\n            @foreach (Product p in Model) {\n                <partial name=""_RowPartial"" model=""p"" />\n            }\n        </tbody>\n    </table>\n</div>\n26.1.1  Adding an image file\nOne of the tag helpers described in this chapter provides services for images. I created \nthe wwwroot/images  folder and added an image file called city.png . This is a public \ndomain panorama of the New York City skyline, as shown in figure 26.1.\nFigure 26.1    Adding an image to the project \nThis image file is included in the source code for this chapter, which is available in the \nGitHub repository for this book. You can substitute your own image if you don’t want \nto download the example project. \n26.1.2  Installing a client-side package\nSome of the examples in this chapter demonstrate the tag helper support for working \nwith JavaScript files, for which I use the jQuery package. Use a PowerShell command \nprompt to run the command shown in listing 26.4 in the project folder, which contains \nthe WebApp.csproj  file. \nListing 26.4    Installing a package \nlibman install jquery@3.6.3 -d wwwroot/lib/jquery",1643
306-26.1.4 Running the example application.pdf,306-26.1.4 Running the example application,,0
307-26.3 Transforming anchor elements.pdf,307-26.3 Transforming anchor elements,"730 chapter  26 Using the built-in tag helpers \n26.1.3  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 26.5 to drop the database.\nListing 26.5    Dropping the database\ndotnet ef database drop --force\n26.1.4  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 26.6. \nListing 26.6    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/home/list, which will display a list of \nproducts, as shown in figure 26.2.\nFigure 26.2    Running the example application \n26.2 Enabling the built-in tag helpers\nThe built-in tag helpers are all defined in the Microsoft.AspNetCore.Mvc.Tag -\nHelpers  namespace and are enabled by adding an @addTagHelpers  directive to indi-\nvidual views or pages or, as in the case of the example project, to the view imports \nfile. Here is the required directive from the _ViewImports.cshtml  file in the Views  \nfolder, which enables the built-in tag helpers for controller views:\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@using WebApp.Components\n@addTagHelper *, WebApp\nHere is the corresponding directive in the _ViewImports.cshtml  file in the Pages  \nfolder, which enables the built-in tag helpers for Razor Pages:\n 731 Transforming anchor elements\n@namespace WebApp.Pages\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@addTagHelper *, WebApp\nThese directives were added to the example project in chapter 24 to enable the view \ncomponents feature.  \n26.3 Transforming anchor elements\nThe a element is the basic tool for navigating around an application and sending GET \nrequests to the application. The AnchorTagHelper  class is used to transform the href  \nattributes of a elements so they target URLs generated using the routing system, which \nmeans that hard-coded URLs are not required and a change in the routing configu-\nration will be automatically reflected in the application’s anchor elements. Table 26.3 \ndescribes the attributes the AnchorTagHelper  class supports.  \nTable 26.3    The built-in tag helper attributes for anchor elements\nName Description\nasp-action This attribute specifies the action method that the URL will \ntarget.\nasp-controller This attribute specifies the controller that the URL will target. If \nthis attribute is omitted, then the URL will target the controller \nor page that rendered the current view.\nasp-page This attribute specifies the Razor Page that the URL will target.\nasp-page-handler This attribute specifies the Razor Page handler function that \nwill process the request, as described in chapter 23.\nasp-fragment This attribute is used to specify the URL fragment (which \nappears after the # character).\nasp-host This attribute specifies the name of the host that the URL will \ntarget.\nasp-protocol This attribute specifies the protocol that the URL will use.\nasp-route This attribute specifies the name of the route that will be used \nto generate the URL.\nasp-route-* Attributes whose name begins with asp-route-  are used \nto specify additional values for the URL so that the asp-\nroute-id  attribute is used to provide a value for the id  \nsegment to the routing system.\nasp-all-route-data This attribute provides values used for routing as a single value, \nrather than using individual attributes.\nThe AnchorTagHelper  is simple and predictable and makes it easy to generate URLs \nin a elements that use the application’s routing configuration. Listing 26.7 adds an \nanchor element that uses attributes from the table to create a URL that targets another \naction defined by the Home  controller.\n732 chapter  26 Using the built-in tag helpers \nListing 26.7    Transforming an element in the Views/Home/_RowPartial.cshtml file \n@model Product\n<tr>\n    <td>@Model.Name</td>\n    <td>@Model.Price.ToString(""c"")</td>\n    <td>@Model.CategoryId</td>\n    <td>@Model.SupplierId</td>\n    <td>\n        <a asp-action=""index"" asp-controller=""home"" \n            asp-route-id=""@Model?.ProductId""\n                class=""btn btn-sm btn-info text-white"">\n            Select\n        </a>\n    </td>\n</tr>\nThe asp-action  and asp-controller  attributes specify the name of the action \nmethod and the controller that defines it. Values for segment variables are defined \nusing asp-route-[name]  attributes, such that the asp-route-id  attribute provides \na value for the id segment variable that is used to provide an argument for the action \nmethod selected by the asp-action  attribute.\nTIP    The class  attributes added to the anchor elements in listing 26.7 apply \nBootstrap CSS Framework styles that give the elements the appearance of but-\ntons. This is not a requirement for using the tag helper.\nTo see the anchor element transformations, restart ASP.NET Core and use a browser \nto request http://localhost:5000/home/list, which will produce the response shown \nin figure 26.3. \nFigure 26.3    Transforming anchor elements",5144
308-26.3.1 Using anchor elements for Razor Pages.pdf,308-26.3.1 Using anchor elements for Razor Pages,"733 Transforming anchor elements\nIf you examine the Select  anchor elements, you will see that each href  attribute \nincludes the ProductId  value of the Product  object it relates to, like this:\n...\n<a class=""btn btn-sm btn-info text-white"" href="" /Home/index/3 "">Select</a>\n...\nIn this case, the value provided by the asp-route-id  attribute means the default URL \ncannot be used, so the routing system has generated a URL that includes segments \nfor the controller and action name, as well as a segment that will be used to provide \na parameter to the action method. Clicking the anchor elements will send an HTTP \nGET request that targets the Home  controller’s Index  method.\n26.3.1  Using anchor elements for Razor Pages \nThe asp-page  attribute is used to specify a Razor Page as the target for an anchor \nelement’s href  attribute. The path to the page is prefixed with the / character, and \nvalues for route segments defined by the @page  directive are defined using asp-route \n-[name]  attributes. Listing 26.8 adds an anchor element that targets the List  page \ndefined in the Pages/Suppliers  folder.  \nNOTE    The asp-page-handler  attribute can be used to specify the name of the \npage model handler method that will process the request. \nListing 26.8    Targeting a Razor Page in the List.cshtml file in the Views/Home folder\n@model IEnumerable<Product>\n@{ Layout = ""_SimpleLayout""; }\n<h6 class=""bg-secondary text-white text-center m-2 p-2"">Products</h6>\n<div class=""m-2"">\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead>\n            <tr>\n                <th>Name</th><th>Price</th>\n                <th>Category</th><th>Supplier</th><th></th>\n            </tr>\n        </thead>\n        <tbody>\n            @foreach (Product p in Model) {\n                <partial name=""_RowPartial"" model=""p"" />\n            }\n        </tbody>\n    </table>\n    <a asp-page=""/suppliers/list"" class=""btn btn-secondary"">Suppliers</a>\n</div>\nRestart ASP.NET Core and a browser to request http://localhost:5000/home/list, and \nyou will see the anchor element, which is styled to appear as a button. If you examine \nthe HTML sent to the client, you will see the anchor element has been transformed \nlike this:\n734 chapter  26 Using the built-in tag helpers \n...\n<a class=""btn btn-secondary"" href=""/lists/suppliers"" >Suppliers</a>\n...\nThis URL used in the href  attribute reflects the @page  directive, which has been used \nto override the default routing convention in this page. Click the element, and the \nbrowser will display the Razor Page, as shown in figure 26.4. \nFigure 26.4    Targeting a Razor Page with an anchor element \nGenerating URLs (and NOT LINKS)\nThe tag helper generates URLs only in anchor elements. If you need to generate a \nURL, rather than a link, then you can use the Url property, which is available in con-\ntrollers, page models, and views. This property returns an object that implements the  \nIUrlHelper  interface, which provides a set of methods and extension methods that \ngenerate URLs. Here is a Razor fragment that generates a URL in a view:  \n...\n<div>@Url.Page(""/suppliers/list"")</div>\n...\nThis fragment produces a div element whose content is the URL that targets the  \n/Suppliers/List  Razor Page. The same interface is used in controllers or page model \nclasses, such as with this statement:\n...\nstring url = Url.Action(""List"", ""Home"");\n...\nThe statement generates a URL that targets the List  action on the Home  controller and \nassigns it to the string  variable named url.",3604
309-26.4 Using the JavaScript and CSS tag helpers.pdf,309-26.4 Using the JavaScript and CSS tag helpers,,0
310-26.4.1 Managing JavaScript files.pdf,310-26.4.1 Managing JavaScript files,"735 Using the JavaScript and CSS tag helpers\n26.4 Using the JavaScript and CSS tag helpers\nASP.NET Core provides tag helpers that are used to manage JavaScript files and CSS \nstylesheets through the script  and link  elements. As you will see in the sections that \nfollow, these tag helpers are powerful and flexible but require close attention to avoid \ncreating unexpected results.\n26.4.1  Managing JavaScript files\nThe ScriptTagHelper  class is the built-in tag helper for script  elements and is used \nto manage the inclusion of JavaScript files in views using the attributes described in \ntable 26.4, which I describe in the sections that follow. \nTable 26.4    The built-in tag helper attributes for script elements\nName Description\nasp-src-include This attribute is used to specify JavaScript files \nthat will be included in the view.\nasp-src-exclude This attribute is used to specify JavaScript files \nthat will be excluded from the view.\nasp-append-version This attribute is used for cache busting, as \ndescribed in the “Understanding Cache Busting” \nsidebar.\nasp-fallback-src This attribute is used to specify a fallback  \nJava Script file to use if there is a problem with a \ncontent delivery network.\nasp-fallback-src-include This attribute is used to select JavaScript files \nthat will be used if there is a content delivery  \nnetwork problem.\nasp-fallback-src-exclude This attribute is used to exclude JavaScript files to \npresent their use when there is a content delivery \nnetwork problem.\nasp-fallback-test This attribute is used to specify a fragment of \nJavaScript that will be used to determine whether \nJavaScript code has been correctly loaded from a \ncontent delivery network.\nselecting  javascript files\nThe asp-src-include  attribute is used to include JavaScript files in a view using glob-\nbing patterns. Globbing patterns support a set of wildcards that are used to match files, \nand table 26.5 describes the most common globbing patterns.  \n736 chapter  26 Using the built-in tag helpers \nTable 26.5    Common globbing patterns\nPattern Example Description\n? js/src?.js This pattern matches any single character except /. The \nexample matches any file contained in the js directory \nwhose name is src, followed by any character, followed by \n.js, such as js/src1.js  and js/srcX.js  but not js/\nsrc123.js  or js/mydir/src1.js .\n* js/*.js This pattern matches any number of characters except /. \nThe example matches any file contained in the js directory \nwith the .js file extension, such as js/src1.js  and js/\nsrc123.js  but not js/mydir/src1.js .\n** js/**/*.js This pattern matches any number of characters including /. \nThe example matches any file with the .js extension that is \ncontained within the js directory or any subdirectory, such \nas /js/src1.js  and /js/mydir/src1.js .\nGlobbing is a useful way of ensuring that a view includes the JavaScript files that the \napplication requires, even when the exact path to the file changes, which usually hap-\npens when the version number is included in the file name or when a package adds \nadditional files.\nListing 26.9 uses the asp-src-include  attribute to include all the JavaScript files in \nthe wwwroot/lib/jquery  folder, which is the location of the jQuery package installed \nwith the command in listing 26.4.\nListing 26.9    Selecting files in the _SimpleLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <script asp-src-include=""lib/jquery/**/*.js""></script>\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nPatterns are evaluated within the wwwroot  folder, and the pattern I used locates any \nfile with the js file extension, regardless of its location within the wwwroot  folder; this \nmeans that any JavaScript package added to the project will be included in the HTML \nsent to the client.\nRestart ASP.NET Core and a browser to request http://localhost:5000/home/list \nand examine the HTML sent to the browser. You will see the single script  element \nin the layout has been transformed into a script  element for each JavaScript file, like \nthis:\n 737 Using the JavaScript and CSS tag helpers\n...\n<head>\n  <title></title>\n  <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"">\n  <script src=""/lib/jquery/jquery.js""></script>\n  <script src=""/lib/jquery/jquery.min.js""></script>\n  <script src=""/lib/jquery/jquery.slim.js""></script>\n  <script src=""/lib/jquery/jquery.slim.min.js""></script> \n</head>\n...\nIf you are using Visual Studio, you may not have realized that the jQuery packages con-\ntain so many JavaScript files because Visual Studio hides them in the Solution Explorer. \nTo reveal the full contents of the client-side package folders, you can either expand the \nindividual nested entries in the Solution Explorer window or disable file nesting by \nclicking the button at the top of the Solution Explorer window, as shown in figure 26.5. \n(Visual Studio Code does not nest files.)\nFigure 26.5    Disabling file nesting in the Visual Studio Solution Explorer \nUnderstanding source maps\nJavaScript files are minified to make them smaller, which means they can be delivered \nto the client faster and using less bandwidth. The minification process removes all the \nwhitespace from the file and renames functions and variables so that meaningful names \nsuch as myHelpfullyNamedFunction  will be represented by a smaller number of \ncharacters, such as x1. When using the browser’s JavaScript debugger to track down \nproblems in your minified code, names like x1 make it almost impossible to follow prog-\nress through the code.  \nThe files that have the map file extension are source maps , which browsers use to help \ndebug minified code by providing a map between the minified code and the develop -\ner-readable, unminified source file. When you open the browser’s F12 developer tools, \nthe browser will automatically request source maps and use them to help debug the \napplication’s client-side code.\n738 chapter  26 Using the built-in tag helpers \nnarrowing  the globbing  pattern  \nNo application would require all the files selected by the pattern in listing 26.9. Many \npackages include multiple JavaScript files that contain similar content, often remov-\ning less popular features to save bandwidth. The jQuery package includes the jquery \n.slim.js  file, which contains the same code as the jquery.js  file but without the \nfeatures that handle asynchronous HTTP requests and animation effects. \nEach of these files has a counterpart with the min.js  file extension, which denotes a \nminified file. Minification reduces the size of a JavaScript file by removing all whitespace \nand renaming functions and variables to use shorter names. \nOnly one JavaScript file is required for each package and if you only require the \nminified versions, which will be the case in most projects, then you can restrict the set of \nfiles that the globbing pattern matches, as shown in listing 26.10. \nListing 26.10    Selecting files in the _SimpleLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <script asp-src-include=""lib/jquery/**/*.min.js""></script>\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nRestart ASP.NET Core and a browser to request http://localhost:5000/home/list \nagain and examine the HTML sent by the application. You will see that only the mini-\nfied files have been selected.\n...\n<head>\n  <title></title>\n  <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"">\n  <script src=""/lib/jquery/jquery.min.js""></script> \n  <script src=""/lib/jquery/jquery.slim.min.js""></script>\n</head>\n... \nNarrowing the pattern for the JavaScript files has helped, but the browser will still end \nup with the normal and slim versions of jQuery and the bundled and unbundled ver-\nsions of the Bootstrap JavaScript files. To narrow the selection further, I can include \nslim  in the pattern, as shown in listing 26.11.\nListing 26.11    Narrowing the focus in the Views/Shared/_SimpleLayout.cshtml file \n<!DOCTYPE html>\n<html>\n<head>\n 739 Using the JavaScript and CSS tag helpers\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <script asp-src-include=""lib/jquery**/*slim.min.js""></script>\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nRestart ASP.NET Core and use the browser to request http://localhost:5000/home/\nlist and examine the HTML the browser receives. The script  element has been trans-\nformed like this:\n...\n<head>\n  <title></title>\n  <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"">\n  <script src=""/lib/jquery/jquery.slim.min.js""></script>\n</head>\n...\nOnly one version of the jQuery file will be sent to the browser while preserving the flex-\nibility for the location of the file. \nExcluding files \nNarrowing the pattern for the JavaScript files helps when you want to select a file whose \nname contains a specific term, such as slim . It isn’t helpful when the file you want \ndoesn’t have that term, such as when you want the full version of the minified file. \nFortunately, you can use the asp-src-exclude  attribute to remove files from the list \nmatched by the asp-src-include  attribute, as shown in listing 26.12.\nListing 26.12    Excluding files in the _SimpleLayout.cshtml file in the Views/Shared \nfolder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <script asp-src-include=""/lib/jquery/**/*.min.js"" \n         asp-src-exclude=""**.slim.**"">\n    </script>\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nIf you restart ASP.NET Core and use the browser to request http://localhost:5000/\nhome/list and examine the HTML response, you will see that the script  element \nlinks only to the full minified version of the jQuery library, like this:\n740 chapter  26 Using the built-in tag helpers \n...\n<head>\n    <title></title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"">\n    <script src=""/lib/jquery/jquery.min.js""></script>\n</head>\n... \nUnderstanding cache busting \nStatic content, such as images, CSS stylesheets, and JavaScript files, is often cached to stop \nrequests for content that rarely changes from reaching the application servers. Caching can \nbe done in different ways: the browser can be told to cache content by the server, the appli-\ncation can use cache servers to supplement the application servers, or the content can be \ndistributed using a content delivery network. Not all caching will be under your control. Large \ncorporations, for example, often install caches to reduce their bandwidth demands since a \nsubstantial percentage of requests tend to go to the same sites or applications.  \nOne problem with caching is that clients don’t immediately receive new versions of static \nfiles when you deploy them because their requests are still being serviced by previously \ncached content. Eventually, the cached content will expire, and the new content will be \nused, but that leaves a period where the dynamic content generated by the application’s \ncontrollers is out of step with the static content being delivered by the caches. This can \nlead to layout problems or unexpected application behavior, depending on the content \nthat has been updated.\nAddressing this problem is called cache busting . The idea is to allow caches to handle \nstatic content but immediately reflect any changes that are made at the server. The tag \nhelper classes support cache busting by adding a query string to the URLs for static \ncontent that includes a checksum that acts as a version number. For JavaScript files, \nfor example, the ScriptTagHelper  class supports cache busting through the asp \n- append-version  attribute, like this:\n...\n<script asp-src-include=""/lib/jquery/**/*.min.js"" \n    asp-src-exclude=""**.slim.**"" asp-append-version=""true"" >\n</script>\n...\nEnabling the cache busting feature produces an element like this in the HTML sent to the \nbrowser:\n...\n<script src=""/lib/jquery/jquery.min.js?v=_xUj3OJU5yExlq6GSYGSHk7tPXikyn""> \n</script>\n...\nThe same version number will be used by the tag helper until you change the contents \nof the file, such as by updating a JavaScript library, at which point a different checksum \nwill be calculated. The addition of the version number means that each time you change \nthe file, the client will request a different URL, which caches treat as a request for new \ncontent that cannot be satisfied with the previously cached content and pass on to the \napplication server. The content is then cached as normal until the next update, which \nproduces another URL with a different version.\n 741 Using the JavaScript and CSS tag helpers\nworking  with content  delivery  networks  \nContent delivery networks (CDNs) are used to offload requests for application con-\ntent to servers that are closer to the user. Rather than requesting a JavaScript file from \nyour servers, the browser requests it from a hostname that resolves to a geographically \nlocal server, which reduces the amount of time required to load files and reduces the \namount of bandwidth you have to provision for your application. If you have a large, \ngeographically disbursed set of users, then it can make commercial sense to sign up to \na CDN, but even the smallest and simplest application can benefit from using the free \nCDNs operated by major technology companies to deliver common JavaScript pack-\nages, such as jQuery.  \nFor this chapter, I am going to use CDNJS, which is the same CDN used by the \nLibrary Manager tool to install client-side packages in the ASP.NET Core project. You \ncan search for packages at https://cdnjs.com ; for jQuery 3.6.3, which is the package \nand version installed in listing 26.4, there are six CDNJS URLs, all of which are accessi-\nble via HTTPS.\n¡ cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.js\n¡ cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js\n¡ cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.map\n¡ cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.slim.js\n¡ cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.slim.min.js\n¡ cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.slim.min.map\nThese URLs provide the regular JavaScript file, the minified JavaScript file, and the \nsource map for the minified file for both the full and slim versions of jQuery. \nThe problem with CDNs is that they are not under your organization’s control, \nand that means they can fail, leaving your application running but unable to work as \nexpected because the CDN content isn’t available. The ScriptTagHelper  class pro-\nvides the ability to fall back to local files when the CDN content cannot be loaded by the \nclient, as shown in listing 26.13.\nListing 26.13    CDN fallback in the _SimpleLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <script src=\n      ""https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js""\n         asp-fallback-src=""/lib/jquery/jquery.min.js"" \n         asp-fallback-test=""window.jQuery"">\n    </script>\n</head>\n<body>    \n    <div class=""m-2"">\n742 chapter  26 Using the built-in tag helpers \n        @RenderBody()\n    </div>\n</body>\n</html>\nThe src attribute is used to specify the CDN URL. The asp-fallback-src  attribute \nis used to specify a local file that will be used if the CDN is unable to deliver the file \nspecified by the regular src attribute. To figure out whether the CDN is working, the \nasp-fallback-test  attribute is used to define a fragment of JavaScript that will be \nevaluated at the browser. If the fragment evaluates as false , then the fallback files will \nbe requested. \nTIP    The asp-fallback-src-include  and asp-fallback-src-exclude  \nattributes can be used to select the local files with globbing patterns. However, \ngiven that CDN script  elements select a single file, I recommend using the asp \n-fallback-src  attribute to select the corresponding local file, as shown in the \nexample.\nRestart ASP.NET Core and a browser to request http://localhost:5000/home/list, and \nyou will see that the HTML response contains two script  elements, like this:\n...\n<head>\n    <title></title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <script src=\n      ""https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"">\n    </script>\n    <script>\n        (window.jQuery||document.write(\n          ""\u003Cscript src=\u0022/lib/jquery/jquery.min.js\u0022\\n              u003E\u003C/script\u003E""));\n    </script>\n</head>\n...\nThe first script  element requests the JavaScript file from the CDN. The second \nscript  element evaluates the JavaScript fragment specified by the asp-fallback \n-test  attribute, which checks to see whether the first script  element has worked. \nIf the fragment evaluates to true , then no action is taken because the CDN worked.  \nIf the fragment evaluates to false , a new script  element is added to the HTML docu-\nment that instructs the browser to load the JavaScript file from the fallback URL.\nIt is important to test your fallback settings because you won’t find out if they fail \nuntil the CDN has stopped working and your users cannot access your application. The \nsimplest way to check the fallback is to change the name of the file specified by the src \nattribute to something that you know doesn’t exist (I append the word FAIL  to the file \nname) and then look at the network requests that the browser makes using the F12 \ndeveloper tools. You should see an error for the CDN file followed by a request for the \nfallback file.",18395
311-26.4.2 Managing CSS stylesheets.pdf,311-26.4.2 Managing CSS stylesheets,"743 Using the JavaScript and CSS tag helpers\nCAUTION    The CDN fallback feature relies on browsers loading and execut-\ning the contents of script  elements synchronously and in the order in which \nthey are defined. There are a number of techniques in use to speed up Java -\nScript loading and execution by making the process asynchronous, but these can \nlead to the fallback test being performed before the browser has retrieved a file \nfrom the CDN and executed its contents, resulting in requests for the fallback \nfiles even when the CDN is working perfectly and defeating the use of a CDN in \nthe first place. Do not mix asynchronous script loading with the CDN fallback \nfeature.\n26.4.2  Managing CSS stylesheets\nThe LinkTagHelper  class is the built-in tag helper for link  elements and is used to \nmanage the inclusion of CSS style sheets in a view. This tag helper supports the attri-\nbutes described in table 26.6, which I demonstrate in the following sections. \nTable 26.6.    The built-in tag helper attributes for link elements\nName Description\nasp-href-include This attribute is used to select files for the href  \nattribute of the output element.\nasp-href-exclude This attribute is used to exclude files from the href  \nattribute of the output element.\nasp-append-version This attribute is used to enable cache busting, as \ndescribed in the “Understanding Cache Busting” \nsidebar.\nasp-fallback-href This attribute is used to specify a fallback file if \nthere is a problem with a CDN.\nasp-fallback-href-include This attribute is used to select files that will be used \nif there is a CDN problem.\nasp-fallback-href-exclude This attribute is used to exclude files from the set \nthat will be used when there is a CDN problem.\nasp-fallback-href-test-class This attribute is used to specify the CSS class that \nwill be used to test the CDN.\nasp-fallback-href-test-property This attribute is used to specify the CSS property \nthat will be used to test the CDN.\nasp-fallback-href-test-value This attribute is used to specify the CSS value that \nwill be used to test the CDN.\nselecting  stylesheets  \nThe LinkTagHelper  shares many features with the ScriptTagHelper , including sup-\nport for globbing patterns to select or exclude CSS files so they do not have to be \nspecified individually. Being able to accurately select CSS files is as important as it is \nfor JavaScript files because stylesheets can come in regular and minified versions and \nsupport source maps. The popular Bootstrap package, which I have been using to style \n744 chapter  26 Using the built-in tag helpers \nHTML elements throughout this book, includes its CSS stylesheets in the wwwroot/\nlib/bootstrap/css  folder. These will be visible in Visual Studio Code, but you will \nhave to expand each item in the Solution Explorer or disable nesting to see them in \nthe Visual Studio Solution Explorer, as shown in figure 26.6.\nFigure 26.6     \nThe Bootstrap \nCSS files\nThe bootstrap.css  file is the regular stylesheet, the bootstrap.min.css  file is the \nminified version, and the bootstrap.css.map  file is a source map. The other files \ncontain subsets of the CSS features to save bandwidth in applications that don’t use \nthem.\nListing 26.14 replaces the regular link  element in the layout with one that uses the \nasp-href-include  and asp-href-exclude  attributes. (I removed the script  ele-\nment for jQuery, which is no longer required.)\nListing 26.14    Selecting a stylesheet in the Views/Shared/_SimpleLayout.cshtml file \n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link asp-href-include=""/lib/bootstrap/css/*.min.css""\n          asp-href-exclude=\n            ""**/*-reboot*,**/*-grid*,**/*-utilities*, **/*.rtl.*""\n          rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nThe same attention to detail is required as when selecting JavaScript files because it is \neasy to generate link  elements for multiple versions of the same file or files that you \ndon’t want. Restart ASP.NET Core and use a browser to request http://localhost:5000/\n 745 Using the JavaScript and CSS tag helpers\nhome/list. Inspect the HTML received by the browser, and you will see that there is \none link  element, like this:\n...\n<head>\n    <title></title>\n    <link rel=""stylesheet"" href=""/lib/bootstrap/css/bootstrap.min.css"" />\n</head>\n...\nworking  with content  delivery  networks\nThe LinkTag  helper class provides a set of attributes for falling back to local content \nwhen a CDN isn’t available, although the process for testing to see whether a stylesheet \nhas loaded is more complex than testing for a JavaScript file. Listing 26.15 uses the \nCDNJS URL for the Bootstrap CSS stylesheet.  (The CDN URL is too long to fit on the \nprinted page, but should be on a single line in the code file).\nListing 26.15    Using a CDN for CSS in the Views/Shared/_SimpleLayout.cshtml file \n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/\ncss/bootstrap.min.css""\n        asp-fallback-href=""/lib/bootstrap/css/bootstrap.min.css""\n        asp-fallback-test-class=""btn""\n        asp-fallback-test-property=""display""\n        asp-fallback-test-value=""inline-block""\n        rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nThe href  attribute is used to specify the CDN URL, and I have used the asp-fallback \n-href  attribute to select the file that will be used if the CDN is unavailable. Testing \nwhether the CDN works, however, requires the use of three different attributes and an \nunderstanding of the CSS classes defined by the CSS stylesheet that is being used.\nUse a browser to request http://localhost:5000/home/list and examine the HTML \nelements in the response. You will see that the link  element from the layout has been \ntransformed into three separate elements, like this:\n...\n<head>\n        <title></title>\n        <link href=""https://cdnjs.cloudflare.com/.../bootstrap.min.css"" \n            rel=""stylesheet""/>\n        <meta name=""x-stylesheet-fallback-test"" content="""" class=""btn"" />\n        <script>\n          !function(a,b,c,d){var e,f=document,",6363
312-26.5 Working with image elements.pdf,312-26.5 Working with image elements,"746 chapter  26 Using the built-in tag helpers \n          g=f.getElementsByTagName(""SCRIPT""),\n          h=g[g.length1].previousElementSibling,\n          i=f.defaultView&&f.defaultView.getComputedStyle ?            \n          f.defaultView.getComputedStyle(h) : h.currentStyle;\n          if(i&&i[a]!==b)for(e=0;e<c.length;e++)\n              f.write('<link href=""'+c[e]+'"" '+d+""/>"")}(\n                 ""display"",""inline-block"",\n                 [""/lib/bootstrap/css/bootstrap.min.css""], \n                 ""rel=\u0022stylesheet\u0022 "");\n        </script>\n</head>\n...\nTo make the transformation easier to understand, I have formatted the JavaScript code \nand shortened the URL.\nThe first element is a regular link  whose href  attribute specifies the CDN file. The \nsecond element is a meta  element, which specifies the class from the asp-fallback \n-test-class  attribute in the view. I specified the btn class in the listing, which means \nthat an element like this is added to the HTML sent to the browser:\n<meta name=""x-stylesheet-fallback-test"" content="""" class=""btn"" >\nThe CSS class that you specify must be defined in the stylesheet that will be loaded \nfrom the CDN. The btn class that I specified provides the basic formatting for Boot-\nstrap button elements. \nThe asp-fallback-test-property  attribute is used to specify a CSS property that \nis set when the CSS class is applied to an element, and the asp-fallback-test-value  \nattribute is used to specify the value that it will be set to. \nThe script  element created by the tag helper contains JavaScript code that adds an \nelement to the specified class and then tests the value of the CSS property to determine \nwhether the CDN stylesheet has been loaded. If not, a link  element is created for the \nfallback file. The Bootstrap btn class sets the display  property to inline-block , and \nthis provides the test to see whether the browser has been able to load the Bootstrap \nstylesheet from the CDN.\nTIP    The easiest way to figure out how to test for third-party packages like Boot-\nstrap is to use the browser’s F12 developer tools. To determine the test in listing \n26.15, I assigned an element to the btn class and then inspected it in the browser, \nlooking at the individual CSS properties that the class changes. I find this easier \nthan trying to read through long and complex style sheets. \n26.5 Working with image elements \nThe ImageTagHelper  class is used to provide cache busting for images through the \nsrc attribute of img elements, allowing an application to take advantage of caching \nwhile ensuring that modifications to images are reflected immediately. The Image-\nTagHelper  class operates in img elements that define the asp-append-version  attri-\nbute, which is described in table 26.7 for quick reference.  \n 747 Working with image elements \nTable 26.7    The built-in tag helper attribute for image elements\nName Description\nasp-append-version This attribute is used to enable cache busting, as \ndescribed in the “Understanding Cache Busting” \nsidebar.\nIn listing 26.16, I have added an img element to the shared layout for the city skyline \nimage that I added to the project at the start of the chapter. I have also reset the link  \nelement to use a local file for brevity.\nListing 26.16    Adding an image in the Views/Shared/_SimpleLayout.cshtml file \n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""m-2"">\n        <img src=""/images/city.png"" asp-append-version=""true"" \n            class=""m-2"" />\n        @RenderBody()\n    </div>\n</body>\n</html>\nRestart ASP.NET Core and a browser to request http://localhost:5000/home/list, \nwhich will produce the response shown in figure 26.7. \nFigure 26.7    Using an image\nExamine the HTML response, and you will see that the URL used to request the image \nfile includes a version checksum, like this:\n...\n<img src=""/images/city.png ?v=KaMNDSZFAJufRcRDpKh0K_IIPNc7E "" class=""m-2"">\n...",4105
313-26.6 Using the data cache.pdf,313-26.6 Using the data cache,"748 chapter  26 Using the built-in tag helpers \nThe addition of the checksum ensures that any changes to the file will pass through \nany caches, avoiding stale content.\n26.6 Using the data cache \nThe CacheTagHelper  class allows fragments of content to be cached to speed up ren-\ndering of views or pages. The content to be cached  is denoted using the cache  ele-\nment, which is configured using the attributes shown in table 26.8.  \nNOTE     Caching is a useful tool for reusing sections of content so they don’t have \nto be generated for every request. But using caching effectively requires careful \nthought and planning. While caching can improve the performance of an appli-\ncation, it can also create odd effects, such as users receiving stale content, mul-\ntiple caches containing different versions of content, and update deployments \nthat are broken because content cached from the previous version of the appli-\ncation is mixed with content from the new version. Don’t enable caching unless \nyou have a clearly defined performance problem to resolve, and make sure you \nunderstand the impact that caching will have. \nTable 26.8     The built-in tag helper attributes for cache elements\nName Description\nenabled This bool  attribute is used to control whether the contents of the \ncache  element are cached. Omitting this attribute enables caching.\nexpires-on This attribute is used to specify an absolute time at which the cached \ncontent will expire, expressed as a DateTime  value.\nexpires-after This attribute is used to specify a relative time at which the cached con-\ntent will expire, expressed as a TimeSpan  value.\nexpires-sliding This attribute is used to specify the period since it was last used when \nthe cached content will expire, expressed as a TimeSpan  value.\nvary-by-header This attribute is used to specify the name of a request header that will \nbe used to manage different versions of the cached content.\nvary-by-query This attribute is used to specify the name of a query string key that will \nbe used to manage different versions of the cached content.\nvary-by-route This attribute is used to specify the name of a routing variable that will \nbe used to manage different versions of the cached content.\nvary-by-cookie This attribute is used to specify the name of a cookie that will be used to \nmanage different versions of the cached content.\nvary-by-user This bool  attribute is used to specify whether the name of the authen-\nticated user will be used to manage different versions of the cached \ncontent.\nvary-by This attribute is evaluated to provide a key used to manage different \nversions of the content.\npriority This attribute is used to specify a relative priority that will be taken into \naccount when the memory cache runs out of space and purges unex-\npired cached content.\n 749 Using the data cache \nListing 26.17 replaces the img element from the previous section with content that \ncontains timestamps.\nListing 26.17    Caching in the _SimpleLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <h6 class=""bg-primary text-white m-2 p-2"">\n            Uncached timestamp: @DateTime.Now.ToLongTimeString()\n        </h6>            \n        <cache>\n            <h6 class=""bg-primary text-white m-2 p-2"">\n                Cached timestamp: @DateTime.Now.ToLongTimeString()\n            </h6>            \n        </cache>\n        @RenderBody()\n    </div>\n</body>\n</html>\nThe cache  element is used to denote a region of content that should be cached and \nhas been applied to one of the h6 elements that contains a timestamp. Restart ASP.\nNET Core and a browser to request http://localhost:5000/home/list, and both time-\nstamps will be the same. Reload the browser, and you will see that the cached content is \nused for one of the h6 elements and the timestamp doesn’t change, as shown in figure \n26.8.\nFigure 26.8    Using the caching tag helper\nUsing distributed caching for content\nThe cache used by the CacheTagHelper  class is memory-based, which means that \nits capacity is limited by the available RAM and that each application server maintains",4347
314-26.6.1 Setting cache expiry.pdf,314-26.6.1 Setting cache expiry,"750 chapter  26 Using the built-in tag helpers \n(continued)\na separate cache. Content will be ejected from the cache when there is a shortage of \ncapacity available, and the entire contents are lost when the application is stopped or \nrestarted. \nThe distributed-cache  element can be used to store content in a shared cache, \nwhich ensures that all application servers use the same data and that the cache survives \nrestarts. The distributed-cache  element is configured with the same attributes as \nthe cache element, as described in table 26.8. See chapter 17 for details of setting up a \ndistributed cache.\n26.6.1  Setting cache expiry\nThe expires-*  attributes allow you to specify when cached content will expire, \nexpressed either as an absolute time or as a time relative to the current time, or to \nspecify a duration during which the cached content isn’t requested. In listing 26.18, I \nhave used the expires-after  attribute to specify that the content should be cached \nfor 15 seconds.  \nListing 26.18    Setting expiry in the _SimpleLayout.cshtml file in the Views/ \nShared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <h6 class=""bg-primary text-white m-2 p-2"">\n            Uncached timestamp: @DateTime.Now.ToLongTimeString()\n        </h6>            \n        <cache expires-after=""@TimeSpan.FromSeconds(15)"">\n            <h6 class=""bg-primary text-white m-2 p-2"">\n                Cached timestamp: @DateTime.Now.ToLongTimeString()\n            </h6>            \n        </cache>\n        @RenderBody()\n    </div>\n</body>\n</html>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/home/list \nand then reload the page. After 15 seconds the cached content will expire, and a new \nsection of content will be created.\nsetting  a fixed expiry  point\nYou can specify a fixed time at which cached content will expire using the expires-on  \nattribute, which accepts a DateTime  value, as shown in listing 26.19.\n 751 Using the data cache \nListing 26.19    Setting expiry in the _SimpleLayout.cshtml file in the Views/ \nShared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <h6 class=""bg-primary text-white m-2 p-2"">\n            Uncached timestamp: @DateTime.Now.ToLongTimeString()\n        </h6>            \n        <cache expires-on=""@DateTime.Parse(""2100-01-01"")"">\n            <h6 class=""bg-primary text-white m-2 p-2"">\n                Cached timestamp: @DateTime.Now.ToLongTimeString()\n            </h6>            \n        </cache>\n        @RenderBody()\n    </div>\n</body>\n</html>\nI have specified that that data should be cached until the year 2100. This isn’t a useful \ncaching strategy since the application is likely to be restarted before the next century \nstarts, but it does illustrate how you can specify a fixed point in the future rather than \nexpressing the expiry point relative to the moment when the content is cached.\nsetting  a last-used expiry  period  \nThe expires-sliding  attribute is used to specify a period after which content is \nexpired if it hasn’t been retrieved from the cache. In listing 26.20, I have specified a \nsliding expiry of 10 seconds.\nListing 26.20    Sliding expiry in the _SimpleLayout.cshtml file in the Views/ \nShared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <h6 class=""bg-primary text-white m-2 p-2"">\n            Uncached timestamp: @DateTime.Now.ToLongTimeString()\n        </h6>            \n        <cache expires-sliding=""@TimeSpan.FromSeconds(10)"">\n            <h6 class=""bg-primary text-white m-2 p-2"">\n                Cached timestamp: @DateTime.Now.ToLongTimeString()\n            </h6>            \n752 chapter  26 Using the built-in tag helpers \n        </cache>\n        @RenderBody()\n    </div>\n</body>\n</html>\nYou can see the effect of the express-sliding  attribute by restarting ASP.NET Core \nand requesting http://localhost:5000/home/list and periodically reloading the page. \nIf you reload the page within 10 seconds, the cached content will be used. If you wait \nlonger than 10 seconds to reload the page, then the cached content will be discarded, \nthe view component will be used to generate new content, and the process will begin \nanew. \nusing cache  variations\nBy default, all requests receive the same cached content. The CacheTagHelper  class \ncan maintain different versions of cached content and use them to satisfy different \ntypes of HTTP requests, specified using one of the attributes whose name begins with \nvary-by . Listing 26.21 shows the use of the vary-by-route  attribute to create cache \nvariations based on the action  value matched by the routing system.  \nListing 26.21    Variation in the _SimpleLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <h6 class=""bg-primary text-white m-2 p-2"">\n            Uncached timestamp: @DateTime.Now.ToLongTimeString()\n        </h6>            \n        <cache expires-sliding=""@TimeSpan.FromSeconds(10)"" \n                vary-by-route=""action"">\n            <h6 class=""bg-primary text-white m-2 p-2"">\n                Cached timestamp: @DateTime.Now.ToLongTimeString()\n            </h6>            \n        </cache>\n        @RenderBody()\n    </div>\n</body>\n</html>\nIf you restart ASP.NET Core and use two browser tabs to request http://  localhost:5000/\nhome/index and http://localhost:5000/home/list, you will see that each window \nreceives its own cached content with its own expiration, since each request produces a \ndifferent action  routing value. \nTIP    If you are using Razor Pages, then you can achieve the same effect using \npage  as the value matched by the routing system.",6297
315-27.1 Preparing for this chapter.pdf,315-27.1 Preparing for this chapter,"753 Using the hosting environment tag helper\n26.7 Using the hosting environment tag helper\nThe EnvironmentTagHelper  class is applied to the custom environment  element and \ndetermines whether a region of content is included in the HTML sent to the brows-\ner-based on the hosting environment, which I described in chapters 15 and 16. The \nenvironment  element relies on the names  attribute, which I have described in table \n26.9.  \nTable 26.9   The built-in tag helper attribute for environment elements\nName Description\nnames This attribute is used to specify a comma-separated list of \nhosting environment names for which the content  \ncontained within the environment  element will be \nincluded in the HTML sent to the client.\nIn listing 26.22, I have added environment  elements to the shared layout including dif-\nferent content in the view for the development and production hosting environments.\nListing 26.22    Using environment in the Views/Shared/_SimpleLayout.cshtml file \n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <environment names=""development"">\n            <h2 class=""bg-info text-white m-2 p-2"">\n                This is Development\n            </h2>\n        </environment>\n        <environment names=""production"">\n            <h2 class=""bg-danger text-white m-2 p-2"">\n                This is Production\n            </h2>\n        </environment>\n        @RenderBody()\n    </div>\n</body>\n</html>\nThe environment  element checks the current hosting environment name and either \nincludes the content it contains or omits it (the environment  element itself is always \nomitted from the HTML sent to the client). Figure 26.9 shows the output for the devel-\nopment and production environments. (See chapter 15 for details of how to set the \nenvironment.)\n754 chapter  26 Using the built-in tag helpers \nFigure 26.9    Managing content using the hosting environment\nSummary\n¡ The built-in tag helpers are enabled using the view imports files.\n¡ The AnchorTagHelper  class transforms anchor elements to target action meth-\nods or Razor Pages.\n¡ The ScriptTagHelper  and LinkTagHelper  classes transform script  and link  \nelements, using local files or those provided by a content delivery network.\n¡ The ImageTagHelper  class transforms img elements, introducing cache-busting \nvalues to file names.\n¡ The CacheTagHelper  class is used to cache fragments of content.\n¡ The EnvironmentTagHelper  class incorporates content into the response for \nspecific hosting environments. \n75527Using the forms  \ntag helpers\nThis chapter covers\n¡ Using ASP.NET Core tag helpers to transform  \n form elements\n¡ Transforming input elements and formatting  \n their contents\n¡ Generating label elements from model   \n properties\n¡ Generating select and option elements\n¡ Protecting forms against cross-site request  \n forgery\nIn this chapter, I describe the built-in tag helpers that are used to create HTML \nforms. These tag helpers ensure forms are submitted to the correct action or page \nhandler method and that elements accurately represent specific model properties. \nTable 27.1 puts the form tag helpers in context.\n756 chapter  27 Using the forms tag helpers \nTable 27.1    Putting form tag helpers in context\nQuestion Answer\nWhat are they? These built-in tag helpers transform HTML \nform elements.\nWhy are they useful? These tag helpers ensure that HTML forms \nreflect the application’s routing configuration \nand data model.\nHow are they used? Tag helpers are applied to HTML elements \nusing asp-*  attributes.\nAre there any pitfalls or \nlimitations?These tag helpers are reliable and predictable \nand present no serious issues.\nAre there any \nalternatives?You don’t have to use tag helpers and can \ndefine forms without them if you prefer.\nTable 27.2 provides a guide to the chapter.\nTable 27.2    Chapter guide\nProblem Solution Listing\nSpecifying how a form will be submitted Use the form tag helper \nattributes.10–13\nTransforming input  elements Use the input tag helper \nattributes.14–22\nTransforming label  elements Use the label tag helper \nattributes.23\nPopulating select  elements Use the select tag helper \nattributes.24–26\nTransforming text areas Use the text area tag helper \nattributes.27\nProtecting against cross-site request forgery Enable the anti-forgery \nfeature.28–32\n27.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 26. To prepare for this chapter, \nreplace the contents of the _SimpleLayout.cshtml  file in the Views/Shared  folder \nwith those shown in listing 27.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\n 757 Preparing for this chapter\nListing 27.1    The contents of the _SimpleLayout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nThis chapter uses controller views and Razor Pages to present similar content. To dif-\nferentiate more readily between controllers and pages, add the route shown in listing \n27.2 to the Program.cs  file.\nListing 27.2    Adding a route in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddSingleton<CitiesData>();\nvar app = builder.Build();\napp.UseStaticFiles();\n//app.MapControllers();\n//app.MapDefaultControllerRoute();\napp.MapControllerRoute(""forms"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe new route introduces a static path segment that makes it obvious that a URL tar-\ngets a controller.",6579
316-27.1.1 Dropping the database.pdf,316-27.1.1 Dropping the database,,0
317-27.1.2 Running the example application.pdf,317-27.1.2 Running the example application,,0
318-27.2.1 Creating a controller to handle forms.pdf,318-27.2.1 Creating a controller to handle forms,"758 chapter  27 Using the forms tag helpers \n27.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 27.3 to drop the database.\nListing 27.3    Dropping the database\ndotnet ef database drop --force\n27.1.2  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 27.4. \nListing 27.4    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers/home/list, which will dis-\nplay a list of products, as shown in figure 27.1.\nFigure 27.1    Running the example application  \n27.2 Understanding the form handling pattern\nMost HTML forms exist within a well-defined pattern, shown in figure 27.2. First, the \nbrowser sends an HTTP GET request, which results in an HTML response containing \na form, making it possible for the user to provide the application with data. The user \nclicks a button that submits the form data with an HTTP POST request, which allows \nthe application to receive and process the user’s data. Once the data has been pro-\ncessed, a response is sent that redirects the browser to a URL that confirms the user’s \nactions.\n 759 Understanding the form handling pattern\nFigure 27.2    The HTML Post/Redirect/Get pattern\nThis is known as the Post/Redirect/Get pattern, and the redirection is important \nbecause it means the user can click the browser’s reload button without sending \nanother POST request, which can lead to inadvertently repeating an operation.\nIn the sections that follow, I show how to follow the pattern with controllers and \nRazor Pages. I start with a basic implementation of the pattern and then demonstrate \nimprovements using tag helpers and, in chapter 28, the model binding feature.  \n27.2.1  Creating a controller to handle forms \nControllers that handle forms are created by combining features described in earlier \nchapters. Add a class file named FormController.cs  to the Controllers  folder with \nthe code shown in listing 27.5.\nListing 27.5    The contents of the FormController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            return View(""Form"", await context.Products.FindAsync(id)\n                ?? new () { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm() {\n            foreach (string key in \n                    Request.Form.Keys.Where(k => !k.StartsWith(""_""))) {\n760 chapter  27 Using the forms tag helpers \n                TempData[key] = string.Join("", "", \n                    (string?)Request.Form[key]);\n            }\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nThe Index  action method selects a view named Form , which will render an HTML \nform to the user. When the user submits the form, it will be received by the Submit-\nForm  action, which has been decorated with the HttpPost  attribute so that it can only \nreceive HTTP POST requests. This action method processes the HTML form data \navailable through the HttpRequest.Form  property so that it can be stored using the \ntemp data feature. The temp data feature can be used to pass data from one request \nto another but can be used only to store simple data types. Each form data value is pre-\nsented as a string array, which I convert to a single comma-separated string for storage. \nThe browser is redirected to the Results  action method, which selects the default \nview. \nTIP    Only form data values whose name doesn’t begin with an underscore are \ndisplayed. I explain why in the “Using the Anti-forgery Feature” section, later in \nthis chapter.\nTo provide the controller with views, create the Views/Form  folder and add to it a \nRazor View file named Form.cshtml  with the content shown in listing 27.6. \nListing 27.6    The contents of the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form action=""/controllers/form/submitform"" method=""post"">\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" name=""Name"" value=""@Model.Name"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nThis view contains a simple HTML form that is configured to submit its data to the  \nSubmitForm  action method using a POST request. The form contains an input  ele-\nment whose value is set using a Razor expression. Next, add a Razor View named \nResults.cshtml  to the Views/Form  folder with the content shown in listing 27.7.",5092
319-27.2.2 Creating a Razor Page to handle forms.pdf,319-27.2.2 Creating a Razor Page to handle forms,"761 Understanding the form handling pattern\nListing 27.7    The contents of the Results.cshtml file in the Views/Form folder\n@{ Layout = ""_SimpleLayout""; }\n<table class=""table table-striped table-bordered table-sm"">\n    <thead>\n        <tr class=""bg-primary text-white text-center"">\n            <th colspan=""2"">Form Data</th>\n        </tr>\n    </thead>\n    <tbody>\n        @foreach (string key in TempData.Keys) {\n            <tr>\n                <th>@key</th>\n                <td>@TempData[key]</td>\n            </tr>\n        }        \n    </tbody>\n</table>\n<a class=""btn btn-primary"" asp-action=""Index"">Return</a>\nThis view displays the form data back to the user. I’ll show you how to process form \ndata in more useful ways in chapter 31, but for this chapter the focus is on creating the \nforms, and seeing the data contained in the form is enough to get started.\nRestart ASP.NET Core and use a browser to request http://localhost:5000/\ncontrollers/  form to see the HTML form. Enter a value into the text field and click \nSubmit to send a POST request, which will be handled by the SubmitForm  action. The \nform data will be stored as temp data, and the browser will be redirected, producing the \nresponse shown in figure 27.3.\nFigure 27.3    Using a controller to render and process an HTML form\n27.2.2  Creating a Razor Page to handle forms\nThe same pattern can be implemented using Razor Pages. One page is required to \nrender and process the form data, and a second page displays the results. Add a Razor \nPage named FormHandler.cshtml  to the Pages  folder with the contents shown in \nlisting 27.8.\n762 chapter  27 Using the forms tag helpers \nListing 27.8    The contents of the FormHandler.cshtml file in the Pages folder\n@page ""/pages/form/{id:long?}""\n@model FormHandlerModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n    <form action=""/pages/form"" method=""post"">\n        <div class=""form-group"">\n            <label>Name</label>\n            <input class=""form-control"" name=""Name""\n                   value=""@Model.Product?.Name"" />\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n</div>\n@functions {\n    [IgnoreAntiforgeryToken]\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        public Product? Product { get; set; }\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products.FindAsync(id);\n        }\n        public IActionResult OnPost() {\n            foreach (string key in Request.Form.Keys\n                    .Where(k => !k.StartsWith(""_""))) {\n                TempData[key] = string.Join("", "", \n                    (string?)Request.Form[key]);\n            }\n            return RedirectToPage(""FormResults"");\n        }\n    }\n}\nThe OnGetAsync  handler methods retrieves a Product  from the database, which is \nused by the view to set the value for the input  element in the HTML form. The form \nis configured to send an HTTP POST request that will be processed by the OnPost  \nhandler method. The form data is stored as temp data, and the browser is sent a redi-\nrection to a form named FormResults . To create the page to which the browser will be \nredirected, add a Razor Page named FormResults.cshtml  to the Pages  folder with \nthe content shown in listing 27.9.\n 763 Understanding the form handling pattern\nTIP    The page model class in listing 27.8 is decorated with the IgnoreAnti \n forgeryToken  attribute, which is described in the “Using the Anti-forgery Fea-\nture” section.\nListing 27.9    The contents of the FormResults.cshtml file in the Pages folder\n@page ""/pages/results""\n<div class=""m-2"">\n    <table class=""table table-striped table-bordered table-sm"">\n        <thead>\n            <tr class=""bg-primary text-white text-center"">\n                <th colspan=""2"">Form Data</th>\n            </tr>\n        </thead>\n        <tbody>\n            @foreach (string key in TempData.Keys) {\n                <tr>\n                    <th>@key</th>\n                    <td>@TempData[key]</td>\n                </tr>\n            }        \n        </tbody>\n    </table>\n    <a class=""btn btn-primary"" asp-page=""FormHandler"">Return</a>\n</div>\nNo code is required for this page, which accesses temp data directly and displays it in a \ntable. Restart ASP.NET Core and use a browser to navigate to http://localhost:5000/\npages/form, enter a value into the text field, and click the Submit button. The form \ndata will be processed by the OnPost  method defined in listing 27.9, and the browser \nwill be redirected to /pages/results , which displays the form data, as shown in figure \n27.4.\nTIP    If you receive a RuntimeBinderException  exception that tells you that \nSystem.Dynamic.DynamicObject  does not contain a definition for Title , then \nyou need to clear your browser’s cookies, start ASP.NET Core, and try again. \nFigure 27.4    Using Razor Pages to render and process an HTML form",5236
320-27.3 Using tag helpers to improve HTML forms.pdf,320-27.3 Using tag helpers to improve HTML forms,,0
321-27.3.1 Working with form elements.pdf,321-27.3.1 Working with form elements,"764 chapter  27 Using the forms tag helpers \n27.3 Using tag helpers to improve HTML forms\nThe examples in the previous section show the basic mechanisms for dealing with \nHTML forms, but ASP.NET Core includes tag helpers that transform form elements. \nIn the sections that follow, I describe the tag helpers and demonstrate their use.\n27.3.1  Working with form elements \nThe FormTagHelper  class is the built-in tag helper for form  elements and is used to \nmanage the configuration of HTML forms so that they target the right action or page \nhandler without the need to hard-code URLs. This tag helper supports the attributes \ndescribed in table 27.3.  \nTable 27.3    The built-in tag helper attributes for form elements\nName Description\nasp-controller This attribute is used to specify the controller  value to the \nrouting system for the action  attribute URL. If omitted, then \nthe controller rendering the view will be used.\nasp-action This attribute is used to specify the action method for the \naction  value to the routing system for the action  attribute \nURL. If omitted, then the action rendering the view will be \nused.\nasp-page This attribute is used to specify the name of a Razor Page.\nasp-page-handler This attribute is used to specify the name of the handler \nmethod that will be used to process the request. You can see \nan example of this attribute in the SportsStore application in \nchapter 9.\nasp-route-* Attributes whose name begins with asp-route-  are used to \nspecify additional values for the action attribute URL so that \nthe asp-route-id  attribute is used to provide a value for \nthe id segment to the routing system.\nasp-route This attribute is used to specify the name of the route that will \nbe used to generate the URL for the action  attribute.\nasp-antiforgery This attribute controls whether anti-forgery information is \nadded to the view, as described in the “Using the Anti-forgery \nFeature” section.\nasp-fragment This attribute specifies a fragment for the generated URL.\nsetting  the form target\nThe FormTagHelper  transforms form  elements so they target an action method or \nRazor Page without the need for hard-coded URLs. The attributes supported by this \ntag helper work in the same way as for anchor elements, described in chapter 26, and \nuse attributes to provide values that help generate URLs through the ASP.NET Core \nrouting system. Listing 27.10 modifies the form  element in the Form  view to apply the \ntag helper.  \n 765 Using tag helpers to improve HTML forms\nNOTE    If a form  element is defined without a method  attribute, then the tag \nhelper will add one with the post  value, meaning that the form will be submitted \nusing an HTTP POST request. This can lead to surprising results if you omit-\nted the method  attribute because you expect the browser to follow the HTML5 \nspecification and send the form using an HTTP GET request. It is a good idea to \nalways specify the method  attribute so that it is obvious how the form should be \nsubmitted.\nListing 27.10    Using a tag helper in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"">\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" name=""Name"" value=""@Model.Name"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nThe asp-action  attribute is used to specify the name of the action that will receive the \nHTTP request. The routing system is used to generate the URLs, just as for the anchor \nelements described in chapter 26. The asp-controller  attribute has not been used \nin listing 27.10, which means the controller that rendered the view will be used in the \nURL. \nThe asp-page  attribute is also used to select a Razor Page as the target for the form, \nas shown in listing 27.11.  \nListing 27.11    Setting the form target in the FormHandler.cshtml file in the Pages folder\n...\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n    <form asp-page=""FormHandler"" method=""post"">\n        <div class=""form-group"">\n            <label>Name</label>\n            <input class=""form-control"" name=""Name"" \n                value=""@Model.Product?.Name"" />\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n</div>\n...\nRestart ASP.NET Core, use a browser to navigate to http://localhost:5000/  controllers/\nform, and examine the HTML received by the browser; you will see that the tag helper \nhas added the action  attribute to the form  element like this:",4774
322-27.4 Working with input elements.pdf,322-27.4 Working with input elements,"766 chapter  27 Using the forms tag helpers \n...\n<form method=""post"" action=""/controllers/Form/submitform"" >\n...\nThe routing system is used to generate a URL that will target the specified action \nmethod, which means that changes to the routing configuration will be reflected auto-\nmatically in the form URL. Request http://localhost:5000/pages/form, and you will \nsee that the form  element has been transformed to target the page URL, like this:\n...\n<form method=""post"" action=""/pages/form "">\n...\n27.3.2  Transforming form buttons \nThe buttons that send forms can be defined outside of the form  element. In these sit-\nuations, the button has a form  attribute whose value corresponds to the id attribute of \nthe form element it relates to and a formaction  attribute that specifies the target URL \nfor the form. \nThe tag helper will generate the formaction  attribute through the asp-action , \nasp-controller , or asp-page  attributes, as shown in listing 27.12.  \nListing 27.12    Transforming a button in the Form.cshtml file in the Views/Form folder \n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" name=""Name"" value=""@Model.Name"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nThe value of the id attribute added to the form  element is used by the button  as the \nvalue of the form  attribute, which tells the browser which form to submit when the but-\nton is clicked. The attributes described in table 27.3 are used to identify the target for \nthe form, and the tag helper will use the routing system to generate a URL when the \nview is rendered. Listing 27.13 applies the same technique to the Razor Page.\nListing 27.13    Transforming a button in the FormHandler.cshtml file in the Pages folder \n...\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n 767 Working with input elements\n    <form asp-page=""FormHandler"" method=""post"" id=""htmlform"">\n        <div class=""form-group"">\n            <label>Name</label>\n            <input class=""form-control"" name=""Name"" \n                value=""@Model.Product?.Name"" />\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n    <button form=""htmlform"" asp-page=""FormHandler"" \n            class=""btn btn-primary mt-2"">\n        Submit (Outside Form)\n    </button>\n</div>\n...\nRestart ASP.NET Core, use a browser to request http://localhost:5000/  controllers/\nform or http://localhost:5000/pages/form, and inspect the HTML sent to the \nbrowser. You will see the button  element outside of the form has been transformed \nlike this:\n...\n<button form=""htmlform"" class=""btn btn-primary mt-2"" \n        formaction=""/controller/Form/submitform"" >\n    Submit (Outside Form)\n</button>\n...\nClicking the button submits the form, just as for a button that is defined within the \nform element, as shown in figure 27.5. \nFigure 27.5    Defining a button outside of a form element\n27.4 Working with input elements\nThe input  element is the backbone of HTML forms and provides the main means by \nwhich a user can provide an application with unstructured data. The InputTagHelper  \nclass is used to transform input  elements so they reflect the data type and format of \nthe view model property they are used to gather, using the attributes described in table \n27.4.  \n768 chapter  27 Using the forms tag helpers \nTable 27.4    The built-in tag helper attributes for input elements\nName Description\nasp-for This attribute is used to specify the view model property \nthat the input  element represents.\nasp-format This attribute is used to specify a format used for the \nvalue of the view model property that the input  element \nrepresents.\nThe asp-for  attribute is set to the name of a view model property, which is then used \nto set the name , id, type , and value  attributes of the input  element. Listing 27.14 \nmodifies the input  element in the controller view to use the asp-for  attribute.\nListing 27.14    Configuring an input element in the Form.cshtml file in the Views/Form \nfolder \n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nThis tag helper uses a model expression, described in chapter 25, which is why the \nvalue for the asp-for  attribute is specified without the @ character. If you restart ASP.\nNET Core and inspect the HTML the application returns when using a browser to \nrequest http://localhost:5000/controllers/form, you will see the tag helper has trans-\nformed the input  element like this:  \n...\n<div class=""form-group"">\n    <label>Name</label>\n    <input class=""form-control"" type=""text"" data-val=""true"" \n        data-val-required=""The Name field is required."" id=""Name"" \n        name=""Name"" value=""Kayak"" >\n</div>\n...\nThe values for the id and name  attributes are obtained through the model expression, \nensuring that you don’t introduce typos when creating the form. The other attributes \nare more complex and are described in the sections that follow or in chapter 29, where \nI explain the ASP.NET Core support for validating data.",5936
323-27.4.1 Transforming the input element type attribute.pdf,323-27.4.1 Transforming the input element type attribute,"769 Working with input elements\nSelecting Model Properties in Razor Pages\nThe asp-for  attribute for this and the other tag helpers described in this chapter can \nbe used for Razor Pages, but the value for the name  and id attributes in the transformed \nelement includes the name of the page model property. For example, this element \nselects the Name  property through the page model’s Product  property:\n...\n<input class=""form-control"" asp-for=""Product.Name""  />\n...\nThe transformed element will have the following id and name  attributes:\n...\n<input class=""form-control"" type=""text"" id=""Product_Name"" \n    name=""Product.Name""  >\n...\nThis difference is important when using the model binding feature to receive form data, \nas described in chapter 28.\n27.4.1  Transforming the input element type attribute \nThe input  element’s type  attribute tells the browser how to display the element and \nhow it should restrict the values the user enters. The input  element in listing 27.14 \nis configured to the text  type, which is the default input  element type and offers no \nrestrictions. Listing 27.15 adds another input  element to the form, which will provide \na more useful demonstration of how the type  attribute is handled.  \nListing 27.15    Adding an input element in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label>Id</label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\n770 chapter  27 Using the forms tag helpers \nThe new element uses the asp-for  attribute to select the view model’s ProductId  \nproperty. Restart ASP.NET Core and a browser to request http://localhost:5000/  \ncontrollers/form to see how the tag helper has transformed the element.\n...\n<div class=""form-group"">\n    <label>Id</label>\n    <input class=""form-control"" type=""number"" data-val=""true"" \n        data-val-required=""The ProductId field is required."" \n        id=""ProductId"" name=""ProductId"" value=""1"">\n</div>\n...\nThe value of the type  attribute is determined by the type of the view model property \nspecified by the asp-for  attribute. The type of the ProductId  property is the C# long  \ntype, which has led the tag helper to set the input  element’s type attribute to number , \nwhich restricts the element so it will accept only numeric characters. The data-val  \nand data-val-required  attributes are added to the input  element to assist with val-\nidation, which is described in chapter 29. Table 27.5 describes how different C# types \nare used to set the type  attribute of input  elements.\nNOTE     There is latitude in how the type  attribute is interpreted by browsers. \nNot all browsers respond to all the type  values that are defined in the HTML \nspecification, and when they do, there are differences in how they are imple-\nmented. The type  attribute can be a useful hint for the kind of data that you are \nexpecting in a form, but you should use the model validation feature to ensure \nthat users provide usable data, as described in chapter 29.\nTable 27.5    C# property types and the input type elements they generate\nC# Type input Element type Attribute \nbyte , sbyte , int, uint , \nshort , ushort , long , ulongnumber\nfloat , double , decimal text , with additional attributes for \nmodel validation, as described in \nchapter 29\nbool checkbox\nstring text\nDateTime datetime\nThe float , double , and decimal  types produce input  elements whose type  is text  \nbecause not all browsers allow the full range of characters that can be used to express \nlegal values of this type. To provide feedback to the user, the tag helper adds attributes \nto the input  element that are used with the validation features described in chapter \n29.",4274
324-27.4.2 Formatting input element values.pdf,324-27.4.2 Formatting input element values,"771 Working with input elements\nYou can override the default mappings shown in table 27.5 by explicitly defining the \ntype  attribute on input  elements. The tag helper won’t override the value you define, \nwhich allows you to specify a type  attribute value. \nThe drawback of this approach is that you must remember to set the type  attribute \nin all the views where input  elements are generated for a given model property. A more \nelegant—and reliable approach—is to apply one of the attributes described in table \n27.6 to the property in the C# model class. \nTIP    The tag helper will set the type  attribute of input  elements to text  if the \nmodel property isn’t one of the types in table 27.5 and has not been decorated \nwith an attribute.\nTable 27.6    The input type elements attributes \nAttribute input Element type Attribute \n[HiddenInput] hidden\n[Text] text\n[Phone] tel\n[Url] url\n[EmailAddress] email\n[DataType(DataType.Password)] password\n[DataType(DataType.Time)] time \n[DataType(DataType.Date)] date\n27.4.2  Formatting input element values \nWhen the action method provides the view with a view model object, the tag helper \nuses the value of the property given to the asp-for  attribute to set the input  element’s \nvalue  attribute. The asp-format  attribute is used to specify how that data value is \nformatted. To demonstrate the default formatting, listing 27.16 adds a new input  ele-\nment to the Form  view.  \nListing 27.16    Adding an element in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label>Id</label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label>Name</label>\n772 chapter  27 Using the forms tag helpers \n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label>Price</label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nRestart ASP.NET Core, use a browser to navigate to http://localhost:5000/controllers/\nform/index/5, and examine the HTML the browser receives. By default, the value  of \nthe input  element is set using the value of the model property, like this:\n...\n<input class=""form-control"" type=""text"" data-val=""true"" \n    data-val-number=""The field Price must be a number."" \n    data-val-required=""The Price field is required."" \n    id=""Price"" name=""Price"" value=""79500.00"" >\n...\nThis format, with two decimal places, is how the value is stored in the database. In \nchapter 26, I used the Column  attribute to select a SQL type to store Price  values, like \nthis: \n...\n[Column(TypeName = ""decimal(8, 2)"")]\npublic decimal Price { get; set; }\n...\nThis type specifies a maximum precision of eight digits, two of which will appear after \nthe decimal place. This allows a maximum value of 999,999.99, which is enough to \nrepresent prices for most online stores. The asp-format  attribute accepts a format \nstring that will be passed to the standard C# string formatting system, as shown in list-\ning 27.17.\nListing 27.17    Formatting a data value in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label>Id</label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" asp-for=""Name"" />\n 773 Working with input elements\n    </div>\n    <div class=""form-group"">\n        <label>Price</label>\n        <input class=""form-control"" \n            asp-for=""Price"" asp-format=""{0:#,###.00}"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nThe attribute value is used verbatim, which means you must include the curly brace \ncharacters and the 0: reference, as well as the format you require. Refresh the browser, \nand you will see that the value for the input  element has been formatted, like this:\n...\n<input class=""form-control"" type=""text"" data-val=""true"" \n    data-val-number=""The field Price must be a number."" \n    data-val-required=""The Price field is required."" \n    id=""Price"" name=""Price"" value=""79,500.00"" >\n... \nThis feature should be used with caution because you must ensure that the rest of the \napplication is configured to support the format you use and that the format you create \ncontains only legal characters for the input  element type.\napplying  formatting  via the model  class\nIf you always want to use the same formatting for a model property, then you can \ndecorate the C# class with the DisplayFormat  attribute, which is defined in the  \nSystem.ComponentModel.DataAnnotations  namespace. The DisplayFormat  attri-\nbute requires two arguments to format a data value: the DataFormatString  argument \nspecifies the formatting string, and setting the ApplyFormatInEditMode  to true  spec-\nifies that formatting should be used when values are being applied to elements used \nfor editing, including the input  element. Listing 27.18 applies the attribute to the \nPrice  property of the Product  class, specifying a different formatting string from ear-\nlier examples.  \nListing 27.18    Applying a formatting attribute to the Product.cs file in the Models \nfolder\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n774 chapter  27 Using the forms tag helpers \n        public required string Name { get; set; }\n        [Column(TypeName = ""decimal(8, 2)"")]\n        [DisplayFormat(DataFormatString = ""{0:c2}"", \n            ApplyFormatInEditMode = true)]\n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nThe asp-format  attribute takes precedence over the DisplayFormat  attribute, so I \nhave removed the attribute from the view, as shown in listing 27.19.\nListing 27.19    Removing an attribute in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label>Id</label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label>Price</label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/  controllers/\nform/index/5, and you will see that the formatting string defined by the attribute has \nbeen applied, as shown in figure 27.6.",7991
325-27.4.3 Displaying values from related data in input elements.pdf,325-27.4.3 Displaying values from related data in input elements,"775 Working with input elements\nFigure 27.6    Formatting data values\nI chose this format to demonstrate the way the formatting attribute works, but as noted \npreviously, care must be taken to ensure that the application is able to process the for-\nmatted values using the model binding and validation features described in chapters \n28 and 29.\n27.4.3  Displaying values from related data in input elements\nWhen using Entity Framework Core, you will often need to display data values that are \nobtained from related data, which is easily done using the asp-for  attribute because \na model expression allows the nested navigation properties to be selected. First, listing \n27.20 includes related data in the view model object provided to the view. \nListing 27.20    Including related data in the FormController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Controllers {\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id)\n776 chapter  27 Using the forms tag helpers \n            ?? new() { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm() {\n            foreach (string key in\n                    Request.Form.Keys.Where(k => !k.StartsWith(""_""))) {\n                TempData[key] = string.Join("", "",\n                    (string?)Request.Form[key]);\n            }\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nNotice that I don’t need to worry about dealing with circular references in the related \ndata because the view model object isn’t serialized. The circular reference issue is \nimportant only for web service controllers. In listing 27.21, I have updated the Form  \nview to include input  elements that use the asp-for  attribute to select related data.\nListing 27.21    Displaying related data in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label>Id</label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label>Name</label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label>Price</label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>Category</label>\n        @{ #pragma warning disable CS8602 } \n        <input class=""form-control"" asp-for=""Category.Name"" />\n        @{ #pragma warning restore CS8602 } \n    </div>\n    <div class=""form-group"">\n        <label>Supplier</label>\n        @{ #pragma warning disable CS8602 } \n        <input class=""form-control"" asp-for=""Supplier.Name"" />\n        @{ #pragma warning restore CS8602 } \n 777 Working with input elements\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nThe value of the asp-for  attribute is expressed relative to the view model object and \ncan include nested properties, allowing me to select the Name  properties of the related \nobjects that Entity Framework Core has assigned to the Category  and Supplier  navi-\ngation properties. \nAs I explained in chapter 25, the null conditional operator cannot be used in model \nexpressions. This presents a problem when selecting nullable-related data properties, \nsuch as the Product.Category  and Product.Supplier  properties. In chapter 25, I \naddressed this limitation by changing the type of a property so that it was not nullable, \nbut this isn’t always possible, especially when a nullable property has been used to indi-\ncate a specific condition.\nIn listing 27.21, I used the #pragma warning  expression to disable code analysis for \nwarning CS8602 , which is the warning generated when a nullable value isn’t accessed \nsafely. The tag helper is able to deal with null  values when processing the asp-for  \nattribute, which means that the warning doesn’t indicate a potential problem. \nTIP    You can elect to simply ignore the warnings the compiler produces, but I \nprefer to either address the underlying issue or explicitly disable the warning so \nthat it is obvious that the warning has been investigated and deliberately ignored, \nrather than not noticed. \nThe same technique is used in Razor Pages, except that the properties are expressed \nrelative to the page model object, as shown in listing 27.22.\nListing 27.22    Displayed related data in the FormHandler.cshtml file in the Pages folder\n@page ""/pages/form/{id:long?}""\n@model FormHandlerModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n    <form asp-page=""FormHandler"" method=""post"" id=""htmlform"">\n        <div class=""form-group"">\n            <label>Name</label>\n            <input class=""form-control"" asp-for=""Product.Name"" />\n        </div>\n        <div class=""form-group"">\n            <label>Price</label>\n            <input class=""form-control"" asp-for=""Product.Price"" />\n        </div>\n778 chapter  27 Using the forms tag helpers \n        <div class=""form-group"">\n            <label>Category</label>\n            @{ #pragma warning disable CS8602 }\n            <input class=""form-control"" asp-for=""Product.Category.Name"" />\n            @{ #pragma warning restore CS8602 }\n        </div>\n        <div class=""form-group"">\n            <label>Supplier</label>\n            @{ #pragma warning disable CS8602 }\n            <input class=""form-control"" asp-for=""Product.Supplier.Name"" />\n            @{ #pragma warning restore CS8602 }\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n    <button form=""htmlform"" asp-page=""FormHandler""\n            class=""btn btn-primary mt-2"">\n        Submit (Outside Form)\n    </button>\n</div>\n@functions {\n    [IgnoreAntiforgeryToken]\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id);\n        }\n        public IActionResult OnPost() {\n            foreach (string key in Request.Form.Keys\n                    .Where(k => !k.StartsWith(""_""))) {\n                TempData[key] = string.Join("", "", \n                    (string?)Request.Form[key]);\n            }\n            return RedirectToPage(""FormResults"");\n        }\n    }\n}\nTo see the effect, restart ASP.NET Core so the changes to the controller take effect, \nand use a browser to request http://localhost:5000/controllers/form, which pro-\nduces the response shown on the left of figure 27.7. Use the browser to request http://  \nlocalhost:5000/pages/form, and you will see the same features used by the Razor Page, \nas shown on the right of figure 27.7.",8009
326-27.5 Working with label elements.pdf,326-27.5 Working with label elements,"779 Working with label elements \nFigure 27.7    Displaying related data \n27.5 Working with label elements \nThe LabelTagHelper  class is used to transform label  elements so the for attribute \nis set consistently with the approach used to transform input  elements. Table 27.7 \ndescribes the attribute supported by this tag helper.  \nTable 27.7    The built-in tag helper attribute for label elements\nName Description\nasp-for This attribute is used to specify the view model property \nthat the label  element describes.\nThe tag helper sets the content of the label  element so that it contains the name of the \nselected view model property. The tag helper also sets the for attribute, which denotes \nan association with a specific input  element. This aids users who rely on screen read-\ners and allows an input  element to gain the focus when its associated label  is clicked.\nListing 27.23 applies the asp-for  attribute to the Form  view to associate each label  \nelement with the input  element that represents the same view model property.\n780 chapter  27 Using the forms tag helpers \nListing 27.23    Transforming label elements in the Form.cshtml file in the Views/Form \nfolder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""ProductId""></label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Category.Name"">Category</label>\n        <input class=""form-control"" asp-for=""Category.Name"" />\n        @{ #pragma warning restore CS8602 } \n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Supplier.Name"">Supplier</label>\n        <input class=""form-control"" asp-for=""Supplier.Name"" />\n        @{ #pragma warning restore CS8602 } \n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nYou can override the content for a label  element by defining it yourself, which is what \nI have done for the related data properties in listing 27.23. The tag helper would have \nset the content for both these label  elements to be Name , which is not a useful descrip-\ntion. Defining the element content means the for attribute will be applied, but a more \nuseful name will be displayed to the user. Restart ASP.NET Core and use a browser to \nrequest http://localhost:5000/controllers/form to see the names used for each ele-\nment, as shown in figure 27.8.",3082
327-27.6 Working with select and option elements.pdf,327-27.6 Working with select and option elements,"781 Working with select and option elements\nFigure 27.8 Transforming label elements\n27.6 Working with select and option elements\nThe select  and option  elements are used to provide the user with a fixed set of \nchoices, rather than the open data entry that is possible with an input  element. The \nSelectTagHelper  is responsible for transforming select  elements and supports the \nattributes described in table 27.8.  \nTable 27.8    The built-in tag helper attributes for select elements\nName Description\nasp-for This attribute is used to specify the view or page model \nproperty that the select  element represents.\nasp-items This attribute is used to specify a source of values for the \noption elements contained within the select  element.\nThe asp-for  attribute sets the value of the for and id attributes to reflect the model \nproperty that it receives. In listing 27.24, I have replaced the input  element for the cat-\negory with a select  element that presents the user with a fixed range of values.\nListing 27.24    Using a select element in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n782 chapter  27 Using the forms tag helpers \n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""ProductId""></label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Category.Name"">Category</label>\n        @{ #pragma warning restore CS8602 } \n        <select class=""form-control"" asp-for=""CategoryId"">\n            <option value=""1"">Watersports</option>\n            <option value=""2"">Soccer</option>\n            <option value=""3"">Chess</option>\n        </select>\n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Supplier.Name"">Supplier</label>\n        <input class=""form-control"" asp-for=""Supplier.Name"" />\n        @{ #pragma warning restore CS8602 } \n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nI have manually populated the select  element with option  elements that provide a \nrange of categories for the user to choose from. If you use a browser to request http://\nlocalhost:5000/controllers/form/index/5 and examine the HTML response, you will \nsee that the tag helper has transformed the select  element like this:\n...\n<div class=""form-group"">\n    <label for=""Category_Name"">Category</label>\n    <select class=""form-control"" data-val=""true"" \n            data-val-required=""The CategoryId field is required."" \n            id=""CategoryId"" name=""CategoryId"">\n        <option value=""1"">Watersports</option>\n        <option value=""2"" selected=""selected"">Soccer</option>\n        <option value=""3"">Chess</option>\n    </select>\n</div>\n...",3392
328-27.6.1 Populating a select element.pdf,328-27.6.1 Populating a select element,"783 Working with select and option elements\nNotice that selected attribute has been added to the option  element that corresponds \nto the view model’s CategoryId  value, like this:\n...\n<option value=""2"" selected=""selected"" >Soccer</option>\n...\nThe task of selecting an option  element is performed by the OptionTagHelper  class, \nwhich receives instructions from the SelectTagHelper  through the TagHelper -\nContext.Items  collection, described in chapter 25. The result is that the select  \nelement displays the name of the category associated with the Product  object’s \nCategoryId  value.\n27.6.1  Populating a select element \nExplicitly defining the option  elements for a select  element is a useful approach for \nchoices that always have the same possible values but doesn’t help when you need to \nprovide options that are taken from the data model or where you need the same set \nof options in multiple views and don’t want to manually maintain duplicated content.\nThe asp-items  attribute is used to provide the tag helper with a list sequence of \nSelectListItem  objects for which option elements will be generated. Listing 27.25 \nmodifies the Index  action of the Form  controller to provide the view with a sequence of \nSelectListItem  objects through the view bag.  \nListing 27.25    Providing a sequence in the FormController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nnamespace WebApp.Controllers {\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            ViewBag.Categories = new SelectList(context.Categories, \n                ""CategoryId"", ""Name"");\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id)\n            ?? new() { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm() {\n784 chapter  27 Using the forms tag helpers \n            foreach (string key in\n                    Request.Form.Keys.Where(k => !k.StartsWith(""_""))) {\n                TempData[key] = string.Join("", "",\n                    (string?)Request.Form[key]);\n            }\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nSelectListItem  objects can be created directly, but ASP.NET Core provides the \nSelectList  class to adapt existing data sequences. In this case, I pass the sequence of \nCategory  objects obtained from the database to the SelectList  constructor, along \nwith the names of the properties that should be used as the values and labels for option  \nelements. In listing 27.26, I have updated the Form  view to use the SelectList .\nListing 27.26    Using a SelectList in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""ProductId""></label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Category.Name"">Category</label>\n        @{ #pragma warning restore CS8602 } \n        <select class=""form-control"" asp-for=""CategoryId"" \n            asp-items=""@ViewBag.Categories"">\n        </select>\n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Supplier.Name"">Supplier</label>\n        <input class=""form-control"" asp-for=""Supplier.Name"" />\n        @{ #pragma warning restore CS8602 } \n    </div>",4355
329-27.7 Working with text areas.pdf,329-27.7 Working with text areas,"785 Working with text areas\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/control-\nlers/form/index/5. There is no visual change to the content presented to the user, but \nthe option  elements used to populate the select  element have been generated from \nthe database, like this:\n...\n<div class=""form-group"">\n    <label for=""Category_Name"">Category</label>\n    <select class=""form-control"" data-val=""true"" \n            data-val-required=""The CategoryId field is required."" \n            id=""CategoryId"" name=""CategoryId"">\n        <option value=""1"">Watersports</option>\n        <option selected=""selected"" value=""2"">Soccer</option>\n        <option value=""3"">Chess</option>\n    </select>\n</div>\n...\nThis approach means that the options presented to the user will automatically reflect \nnew categories added to the database.\n27.7 Working with text areas\nThe textarea  element is used to solicit a larger amount of text from the user and is \ntypically used for unstructured data, such as notes or observations. The TextArea -\nTagHelper  is responsible for transforming textarea  elements and supports the single \nattribute described in table 27.9.  \nTable 27.9    The built-in tag helper attributes for textarea elements\nName Description\nasp-for This attribute is used to specify the view model property \nthat the textarea  element represents.\nThe TextAreaTagHelper  is relatively simple, and the value provided for the asp-\nfor attribute is used to set the id and name  attributes on the textarea  element. The \nvalue of the property selected by the asp-for  attribute is used as the content for the \ntextarea  element. Listing 27.27 replaces the input  element for the Supplier.Name  \nproperty with a text area to which the asp-for  attribute has been applied.\n786 chapter  27 Using the forms tag helpers \nListing 27.27    Using a text area in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""ProductId""></label>\n        <input class=""form-control"" asp-for=""ProductId"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Category.Name"">Category</label>\n        @{ #pragma warning restore CS8602 } \n        <select class=""form-control"" asp-for=""CategoryId"" \n            asp-items=""@ViewBag.Categories"">\n        </select>\n    </div>\n    <div class=""form-group"">\n        @{ #pragma warning disable CS8602 } \n        <label asp-for=""Supplier.Name"">Supplier</label>\n        <textarea class=""form-control"" asp-for=""Supplier.Name""></textarea>\n        @{ #pragma warning restore CS8602 } \n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\n<button form=""htmlform"" asp-action=""submitform"" \n        class=""btn btn-primary mt-2"">\n    Submit (Outside Form)\n</button>\nRestart ASP.NET Core and use a browser to request http://localhost:5000/  controllers/\nform and examine the HTML received by the browser to see the transformation of the \ntextarea  element.\n...\n<div class=""form-group"">\n    <label for=""Supplier_Name"">Supplier</label>\n    <textarea class=""form-control"" data-val=""true"" \n            data-val-required=""The Name field is required.""  \n            id=""Supplier_Name""   \n            name=""Supplier.Name"">\n        Splash Dudes\n    </textarea>\n</div>\n...",4054
330-27.8 Using the anti-forgery feature.pdf,330-27.8 Using the anti-forgery feature,"787 Using the anti-forgery feature \nThe TextAreaTagHelper  is relatively simple, but it provides consistency with the rest \nof the form element tag helpers that I have described in this chapter. \n27.8 Using the anti-forgery feature \nWhen I defined the controller action method and page handler methods that process \nform data, I filtered out form data whose name begins with an underscore, like this:  \n...\n[HttpPost]\npublic IActionResult SubmitForm() {\n    foreach (string key in Request.Form.Keys\n            .Where(k => !k.StartsWith(""_""))) {\n        TempData[key] = string.Join("", "", Request.Form[key]);\n    }\n    return RedirectToAction(nameof(Results));\n}\n...\nI applied this filter to focus on the values provided by the HTML elements in the form. \nListing 27.28 removes the filter from the action method so that all the data received \nfrom the HTML form is stored in temp data.\nListing 27.28    Removing a filter in the FormController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nnamespace WebApp.Controllers {\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            ViewBag.Categories = new SelectList(context.Categories, \n                ""CategoryId"", ""Name"");\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id)\n            ?? new() { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm() {\n            foreach (string key in Request.Form.Keys) {\n                TempData[key] = string.Join("", "",\n                    (string?)Request.Form[key]);\n            }\n788 chapter  27 Using the forms tag helpers \n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nRestart ASP.NET Core and use a browser to request http://localhost:5000/  controllers/\nform. Click the Submit button to send the form to the application, and you will see a \nnew item in the results, as shown in figure 27.9.\nFigure 27.9    Showing all form data\nThe _RequestVerificationToken  form value displayed in the results is a security fea-\nture that is applied by the FormTagHelper  to guard against cross-site request forgery. \nCross-site request forgery (CSRF) exploits web applications by taking advantage of the \nway that user requests are typically authenticated. Most web applications—including \nthose created using ASP.NET Core—use cookies to identify which requests are related \nto a specific session, with which a user identity is usually associated. \nCSRF—also known as XSRF —relies on the user visiting a malicious website after \nusing your web application and without explicitly ending their session. The applica-\ntion still regards the user’s session as being active, and the cookie that the browser has \nstored has not yet expired. The malicious site contains JavaScript code that sends a \nform request to your application to perform an operation without the user’s consent—\nthe exact nature of the operation will depend on the application being attacked. Since \nthe JavaScript code is executed by the user’s browser, the request to the application \nincludes the session cookie, and the application performs the operation without the \nuser’s knowledge or consent.\nTIP    CSRF is described in detail at http://en.wikipedia.org/wiki/Cross-  site \n_   request  _forgery .",3829
331-27.8.2 Enabling the anti-forgery feature in a Razor Page.pdf,331-27.8.2 Enabling the anti-forgery feature in a Razor Page,"789 Using the anti-forgery feature \nIf a form  element doesn’t contain an action  attribute—because it is being generated \nfrom the routing system with the asp-controller , asp-action , and asp-page attri-\nbutes—then the FormTagHelper  class automatically enables an anti-CSRF feature, \nwhereby a security token is added to the response as a cookie. A hidden input  element \ncontaining the same security token is added to the HTML form, and it is this token that \nis shown in figure 27.9.\n27.8.1  Enabling the anti-forgery feature in a controller \nBy default, controllers accept POST requests even when they don’t contain the \nrequired security tokens. To enable the anti-forgery feature, an attribute is applied to \nthe controller class, as shown in listing 27.29.  \nListing 27.29    Enabling the anti-forgery feature in the Controllers/FormController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            ViewBag.Categories = new SelectList(context.Categories, \n                ""CategoryId"", ""Name"");\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id)\n            ?? new() { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm() {\n            foreach (string key in Request.Form.Keys) {\n                TempData[key] = string.Join("", "",\n                    (string?)Request.Form[key]);\n            }\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}",2085
332-27.8.3 Using anti-forgery tokens with JavaScript clients.pdf,332-27.8.3 Using anti-forgery tokens with JavaScript clients,"790 chapter  27 Using the forms tag helpers \nNot all requests require an anti-forgery token, and the AutoValidateAntiforgery-\nToken  ensures that checks are performed for all HTTP methods except GET, HEAD, \nOPTIONS, and TRACE.\nTIP    Two other attributes can be used to control token validation. The Ignore-\nValidationToken  attribute suppresses validation for an action method or \ncontroller. The ValidateAntiForgeryToken  attribute does the opposite and \nenforces validation, even for requests that would not normally require valida-\ntion, such as HTTP GET requests. I recommend using the AutoValidate -\nAntiforgeryToken  attribute, as shown in the listing.  \nTesting the anti-CSRF feature is a little tricky. I do it by requesting the URL that con-\ntains the form (http://localhost:5000/controllers/forms for this example) and then \nusing the browser’s F12 developer tools to locate and remove the hidden input  ele-\nment from the form (or change the element’s value). When I populate and submit the \nform, it is missing one part of the required data, and the request will fail.\n27.8.2  Enabling the anti-forgery feature in a Razor Page\nThe anti-forgery feature is enabled by default in Razor Pages, which is why I applied \nthe IgnoreAntiforgeryToken  attribute to the page handler method in listing 27.29 \nwhen I created the FormHandler  page. Listing 27.30 removes the attribute to enable \nthe validation feature.  \nListing 27.30    Enabling Request Validation in the Pages/FormHandler.cshtml File \n...\n@functions {\n    //[IgnoreAntiforgeryToken]\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n...\nTesting the validation feature is done in the same way as for controllers and requires \naltering the HTML document using the browser’s developer tools before submitting \nthe form to the application.\n27.8.3  Using anti-forgery tokens with JavaScript clients\nBy default, the anti-forgery feature relies on the ASP.NET Core application being able \nto include an element in an HTML form that the browser sends back when the form is \nsubmitted. This doesn’t work for JavaScript clients because the ASP.NET Core applica-\ntion provides data and not HTML, so there is no way to insert the hidden element and \nreceive it in a future request.  \nFor web services, the anti-forgery token can be sent as a JavaScript-readable cookie, \nwhich the JavaScript client code reads and includes as a header in its POST requests. \nSome JavaScript frameworks, such as Angular, will automatically detect the cookie and \n 791 Using the anti-forgery feature \ninclude a header in requests. For other frameworks and custom JavaScript code, addi-\ntional work is required. \nListing 27.31 shows the changes required to the ASP.NET Core application to config-\nure the anti-forgery feature for use with JavaScript clients.  \nListing 27.31    Configuring the anti-forgery token in the WebApp/Program.cs file \nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Antiforgery;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddSingleton<CitiesData>();\nbuilder.Services.Configure<AntiforgeryOptions>(opts => {\n    opts.HeaderName = ""X-XSRF-TOKEN"";\n});\nvar app = builder.Build();\napp.UseStaticFiles();\nIAntiforgery antiforgery \n    = app.Services.GetRequiredService<IAntiforgery>();\napp.Use(async (context, next) => {\n    if (!context.Request.Path.StartsWithSegments(""/api"")) {\n        string? token = \n            antiforgery.GetAndStoreTokens(context).RequestToken;\n        if (token != null) {\n            context.Response.Cookies.Append(""XSRF-TOKEN"",\n               token,\n               new CookieOptions { HttpOnly = false });\n        }\n    }\n    await next();\n});\napp.MapControllerRoute(""forms"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\n792 chapter  27 Using the forms tag helpers \nThe options pattern is used to configure the anti-forgery feature, through the \nAntiforgeryOptions  class. The HeaderName  property is used to specify the name of \na header through which anti-forgery tokens will be accepted, which is X-XSRF-TOKEN  \nin this case.\nA custom middleware component is required to set the cookie, which is named \nXSRF-TOKEN  in this example. The value of the cookie is obtained through the  \nIAntiForgery  service and must be configured with the HttpOnly  option set to false  \nso that the browser will allow JavaScript code to read the cookie.\nTIP    I have followed the names that are supported by Angular in this example. \nOther frameworks follow their own conventions but can usually be configured to \nuse any set of cookie and header names.\nTo create a simple JavaScript client that uses the cookie and header, add a Razor Page \nnamed JavaScriptForm.cshtml  to the Pages  folder with the content shown in listing \n27.32.\nListing 27.32    The contents of the JavaScriptForm.cshtml file in the Pages folder\n@page ""/pages/jsform""\n<script type=""text/javascript"">\n    async function sendRequest() {\n        const token = document.cookie.replace(\n           /(?:(?:^|.*;\s*)XSRF-TOKEN\s*\=\s*([^;]*).*$)|^.*$/, ""$1"");\n        let form = new FormData();\n        form.append(""name"", ""Paddle"");\n        form.append(""price"", 100);\n        form.append(""categoryId"", 1);\n        form.append(""supplierId"", 1);\n        let response = await fetch(""@Url.Page(""FormHandler"")"", {\n            method: ""POST"",\n            headers: { ""X-XSRF-TOKEN"": token },\n            body: form\n        });\n        document.getElementById(""content"").innerHTML \n            = await response.text();\n    }\n    document.addEventListener(""DOMContentLoaded"",\n        () => document.getElementById(""submit"").onclick = sendRequest);\n</script>\n<button class=""btn btn-primary m-2"" id=""submit"">\n    Submit JavaScript Form\n</button>\n<div id=""content""></div>\n 793 Using the anti-forgery feature \nThe JavaScript code in this Razor Page responds to a button click by sending an HTTP \nPOST request to the FormHandler  Razor Page. The value of the XSRF-TOKEN  cookie \nis read and included in the X-XSRF-TOKEN  request header. The response from the \nFormHandler  page is a redirection to the Results  page, which the browser will fol-\nlow automatically. The response from the Results  page is read by the JavaScript code \nand inserted into an element so it can be displayed to the user. To test the JavaScript \ncode, restart ASP.NET Core, use a browser to request http://localhost:5000/pages/\njsform, and click the button. The JavaScript code will submit the form and display the \nresponse, as shown in figure 27.10.\nFigure 27.10    Using a security token in JavaScript code\nSummary\n¡ The FormTagHelper  class transforms form  elements so they target specific action \nmethods or Razor pages.\n¡ The InputTagHelper  class transforms input  elements, generating form con-\ntent from model properties and their values.\n¡ The LabelTagHelper  class transforms label  elements, setting their content \nfrom model property names.\n¡ The TextAreaTagHelper  transforms textarea  elements.\n¡ The AutoValidateAntiforgeryToken  and IgnoreAntiforgeryToken  attri-\nbutes are used to control the anti-cross site request forgery feature.",7737
333-28 Using model binding.pdf,333-28 Using model binding,"79428Using model binding\nThis chapter covers\n¡ Understanding how the ASP.NET Core model  \n binder reads data values from HTTP requests\n¡ Finding data values during model binding\n¡ Customizing the model binding process and  \n performing model binding manually\nModel binding  is the process of creating .NET objects using the values from the HTTP \nrequest to provide easy access to the data required by action methods and Razor \nPages. In this chapter, I describe the way the model binding system works; show how \nit binds simple types, complex types, and collections; and demonstrate how you can \ntake control of the process to specify which part of the request provides the data val-\nues your application requires. Table 28.1 puts model binding in context.\n 795  \nTable 28.1    Putting model binding in context\nQuestion Answer\nWhat is it? Model binding is the process of creating the objects that \naction methods and page handlers require using data \nvalues obtained from the HTTP request.\nWhy is it useful? Model binding lets controllers or page handlers declare \nmethod parameters or properties using C# types and \nautomatically receive data from the request without hav -\ning to inspect, parse, and process the data directly. \nHow is it used? In its simplest form, methods declare parameters, or \nclasses define properties whose names are used to \nretrieve data values from the HTTP request. The part of \nthe request used to obtain the data can be configured \nby applying attributes to the method parameters or \nproperties.\nAre there any pitfalls \nor limitations?The main pitfall is getting data from the wrong part of the \nrequest. I explain the way that requests are searched for \ndata in the  \n“Understanding Model Binding” section, and the search \nlocations can be specified explicitly using the attributes \nthat I describe in the “Specifying a Model Binding Source” \nsection.\nAre there any \nalternatives?Data can be obtained without model binding using con-\ntext objects. However, the result is more complicated code \nthat is hard to read and maintain. \nTable 28.2 provides a guide to the chapter.\nTable 28.2    Chapter guide\nProblem Solution Listing\nBinding simple types Define method parameters with primitive \ntypes.5–9\nBinding complex \ntypesDefine method parameters with class types. 10\nBinding to a property Use the BindProperty  attribute. 11, 12\nBinding nested types Ensure the form value types follow the dotted \nnotation.13–18\nSelecting properties \nfor bindingUse the Bind  and BindNever  attributes. 19–21\nBinding collections Follow the sequence binding conventions. 22–27\nSpecifying the source \nfor bindingUse one of the source attributes. 28–33\nManually performing \nbindingUse the TryUpdateModel  method. 34",2784
334-28.1.1 Dropping the database.pdf,334-28.1.1 Dropping the database,"796 chapter  28 Using model binding\n28.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 27. To prepare for this chapter, \nreplace the contents of the Form.cshtml  file in the Views/Form  folder with the con-\ntent shown in listing 28.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 28.1    The contents of the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nNext, comment out the DisplayFormat  attribute that has been applied to the  \nProduct  model class, as shown in listing 28.2.\nListing 28.2    Removing an attribute in the Product.cs file in the Models folder \nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n        public required string Name { get; set; }\n        [Column(TypeName = ""decimal(8, 2)"")]\n        //[DisplayFormat(DataFormatString = ""{0:c2}"", \n        //    ApplyFormatInEditMode = true)]\n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }",1916
335-28.1.2 Running the example application.pdf,335-28.1.2 Running the example application,,0
336-28.2 Understanding model binding.pdf,336-28.2 Understanding model binding,"797 Understanding model binding\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\n28.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 28.3 to drop the database.\nListing 28.3    Dropping the database\ndotnet ef database drop --force\n28.1.2  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 28.4. \nListing 28.4    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers/form, which will display \nan HTML form. Click the Submit button, and the form data will be displayed, as shown \nin figure 28.1.\nFigure 28.1    Running the example application  \n28.2 Understanding model binding\nModel binding is an elegant bridge between the HTTP request and action or page han-\ndler methods. Most ASP.NET Core applications rely on model binding to some extent, \nincluding the example application for this chapter. \nYou can see model binding at work by using the browser to request http://  \nlocalhost:5000/controllers/form/index/5. This URL contains the value of the \nProductId  property of the Product  object that I want to view, like this:\n798 chapter  28 Using model binding\nhttp://localhost:5000/controllers/form/index/ 5\nThis part of the URL corresponds to the id segment variable defined by the controller \nrouting pattern and matches the name of the parameter defined by the Form  control-\nler’s Index  action:\n...\npublic async Task<IActionResult> Index(long id = 1) {\n...\nA value for the id parameter is required before the MVC Framework can invoke the \naction method, and finding a suitable value is the responsibility of the model binding  sys-\ntem. The model binding system relies on model binders , which are components respon-\nsible for providing data values from one part of the request or application. The default \nmodel binders look for data values in these four places:  \n¡ Form data \n¡ The request body (only for controllers decorated with ApiController )\n¡ Routing segment variables\n¡ Query strings\nEach source of data is inspected in order until a value for the argument is found. There \nis no form data in the example application, so no value will be found there, and the \nForm  controller isn’t decorated with the ApiController  attribute, so the request body \nwon’t be checked. The next step is to check the routing data, which contains a segment \nvariable named id. This allows the model binding system to provide a value that allows \nthe Index  action method to be invoked. The search stops after a suitable data value has \nbeen found, which means that the query string isn’t searched for a data value.\nTIP    In the “Specifying a Model Binding Source” section, I explain how you \ncan specify the source of model binding data using attributes. This allows you to \nspecify that a data value is obtained from, for example, the query string, even if \nthere is also suitable data in the routing data.\nKnowing the order in which data values are sought is important because a request can \ncontain multiple values, like this URL:\nhttp://localhost:5000/controllers/Form/Index/ 5?id=1\nThe routing system will process the request and match the id segment in the URL tem-\nplate to the value 5, and the query string contains an id value of 1. Since the routing \ndata is searched for data before the query string, the Index  action method will receive \nthe value 5, and the query string value will be ignored.\nOn the other hand, if you request a URL that doesn’t have an id segment, then the \nquery string will be examined, which means that a URL like this one will also allow the \nmodel binding system to provide a value for the id argument so that it can invoke the \nIndex  method.\nhttp://localhost:5000/controllers/Form/Index?id= 4\nYou can see the effect of both these URLs in figure 28.2.",4092
337-28.3.1 Binding simple data types in Razor Pages.pdf,337-28.3.1 Binding simple data types in Razor Pages,"799 Binding simple data types\nFigure 28.2    The effect of model binding data source order\n28.3 Binding simple data types\nRequest data values must be converted into C# values so they can be used to invoke \naction or page handler methods. Simple types  are values that originate from one item \nof data in the request that can be parsed from a string. This includes numeric values, \nbool  values, dates, and, of course, string  values.  \nData binding for simple types makes it easy to extract single data items from the \nrequest without having to work through the context data to find out where it is defined. \nListing 28.5 adds parameters to the SubmitForm  action method defined by the  \nSubmitForm  action method so that the model binder will be used to provide name  and \nprice  values.\nListing 28.5    Adding parameters in the FormController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long id = 1) {\n            ViewBag.Categories = new SelectList(context.Categories, \n                ""CategoryId"", ""Name"");\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id)\n            ?? new() { Name = string.Empty });\n        }\n800 chapter  28 Using model binding\n        [HttpPost]\n        public IActionResult SubmitForm(string name, decimal price) {\n            TempData[""name param""] = name;\n            TempData[""price param""] = price.ToString();\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nThe model binding system will be used to obtain name  and price  values when ASP \n.NET Core receives a request that will be processed by the SubmitForm  action method. \nThe use of parameters simplifies the action method and takes care of converting the \nrequest data into C# data types so that the price  value will be converted to the C#  \ndecimal  type before the action method is invoked. (I had to convert the decimal  back \nto a string to store it as temp data in this example. I demonstrate more useful ways \nof dealing with form data in chapter 31.) Restart ASP.NET Core and use a browser \nto request http://localhost:5000/controllers/form. Click the Submit button, and you \nwill see the values that were extracted from the request by the model binding feature, \nas shown in figure 28.3.\nFigure 28.3    Model binding for simple types\n28.3.1  Binding simple data types in Razor Pages \nRazor Pages can use model binding, but care must be taken to ensure that the value of \nthe form element’s name  attribute matches the name of the handler method parame-\nter, which may not be the case if the asp-for  attribute has been used to select a nested \nproperty. To ensure the names match, the name  attribute can be defined explicitly, as \nshown in listing 28.6, which also simplifies the HTML form so that it matches the con-\ntroller example.  \n 801 Binding simple data types\nListing 28.6    Using model binding in the FormHandler.cshtml file in the Pages folder\n@page ""/pages/form/{id:long?}""\n@model FormHandlerModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n    <form asp-page=""FormHandler"" method=""post"" id=""htmlform"">\n        <div class=""form-group"">\n            <label>Name</label>\n            <input class=""form-control"" asp-for=""Product.Name"" \n                name=""name"" />\n        </div>\n        <div class=""form-group"">\n            <label>Price</label>\n            <input class=""form-control"" asp-for=""Product.Price"" \n                name=""price"" />\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n</div>\n@functions {\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id);\n        }\n        public IActionResult OnPost(string name, decimal price) {\n            TempData[""name param""] = name;\n            TempData[""price param""] = price.ToString();\n            return RedirectToPage(""FormResults"");\n        }\n    }\n}\nThe tag helper would have set the name attributes of the input elements to Product \n. Name  and Product.Price , which prevents the model binder from matching the",5279
338-28.3.2 Understanding default binding values.pdf,338-28.3.2 Understanding default binding values,"802 chapter  28 Using model binding\nvalues. Explicitly setting the name  attribute overrides the tag helper and ensures the \nmodel binding process works correctly. Restart ASP.NET Core, use a browser to request \nhttp://localhost:5000/pages/form, and click the Submit button, and you will see the \nvalues found by the model binder, as shown in figure 28.4.\nFigure 28.4    Model binding in a Razor Page\n28.3.2  Understanding default binding values\nModel binding is a best-effort feature, which means the model binder will try to get \nvalues for method parameters but will still invoke the method if data values cannot be \nlocated. You can see how this works by removing the default value for the id parameter \nin the Form  controller’s Index  action method, as shown in listing 28.7.  \nListing 28.7    Removing a parameter value in the Controllers/FormController.cs file \n...\npublic async Task<IActionResult> Index(long id) {\n    ViewBag.Categories = new SelectList(context.Categories, \n        ""CategoryId"", ""Name"");\n    return View(""Form"", await context.Products\n        .Include(p => p.Category)\n        .Include(p => p.Supplier)\n        .FirstAsync(p => p.ProductId == id)\n    ?? new() { Name = string.Empty });\n}\n...\nRestart ASP.NET Core and request http://localhost:5000/controllers/form. The URL \ndoesn’t contain a value that the model binder can use for the id parameter, and there \nis no query string or form data, but the method is still invoked, producing the error \nshown in figure 28.5.\n 803 Binding simple data types\nFigure 28.5    An error caused by a missing data value  \nThis exception isn’t reported by the model binding system. Instead, it occurred when \nthe Entity Framework Core query was executed. The MVC Framework must provide \nsome value for the id argument to invoke the Index  action method, so it uses a default \nvalue and hopes for the best. For long  arguments, the default value is 0, and this is \nwhat leads to the exception. The Index  action method uses the id value as the key to \nquery the database for a Product  object, like this:\n...\npublic async Task<IActionResult> Index(long id) {\n    ViewBag.Categories = new SelectList(context.Categories, \n        ""CategoryId"", ""Name"");\n    return View(""Form"", await context.Products\n        .Include(p => p.Category)\n        .Include(p => p.Supplier)\n        .FirstAsync(p => p.ProductId == id)\n    ?? new() { Name = string.Empty });\n}\n...\nWhen there is no value available for model binding, the action method tries to query \nthe database with an id of zero. There is no such object, which causes the error shown \nin the figure when Entity Framework Core tries to process the result. \nApplications must be written to cope with default argument values, which can be \ndone in several ways. You can add fallback values to the routing URL patterns used by \ncontrollers (as shown in chapter 21) or pages (as shown in chapter 23). You can assign \ndefault values when defining the parameter in the action or page handler method, \nwhich is the approach that I have taken so far in this part of the book. Or you can simply \nwrite methods that accommodate the default values without causing an error, as shown \nin listing 28.8.\n804 chapter  28 Using model binding\nListing 28.8    Avoiding a query error in the FormController.cs file in the Controllers folder \n...\npublic async Task<IActionResult> Index(long id) {\n    ViewBag.Categories = new SelectList(context.Categories, \n        ""CategoryId"", ""Name"");\n    return View(""Form"", await context.Products\n        .Include(p => p.Category)\n        .Include(p => p.Supplier)\n        .FirstOrDefaultAsync(p => p.ProductId == id)\n    ?? new() { Name = string.Empty });\n}\n...\nThe Entity Framework Core FirstOrDefaultAsync  method will return null  if there \nis no matching object in the database and won’t attempt to load related data. The tag \nhelpers cope with null  values and display empty fields, which you can see by restarting \nASP.NET Core and requesting http://localhost:5000/controllers/form, which pro-\nduces the result shown in figure 28.6.\nFigure 28.6    \nAvoiding an \nerror\nSome applications need to differentiate between a missing value and any value pro-\nvided by the user. In these situations, a nullable parameter type can be used, as shown \nin listing 28.9.  \nListing 28.9.   A nullable parameter in the FormController.cs file in the Controllers folder\n...\npublic async Task<IActionResult> Index(long? id) {\n    ViewBag.Categories = new SelectList(context.Categories, \n        ""CategoryId"", ""Name"");\n    return View(""Form"", await context.Products.Include(p => p.Category)\n        .Include(p => p.Supplier)\n        .FirstOrDefaultAsync(p => id == null || p.ProductId == id));\n}\n...\nThe id parameter will be null  only if the request doesn’t contain a suitable value, \nwhich allows the expression passed to the FirstOrDefaultAsync  method to default",4967
339-28.4 Binding complex types.pdf,339-28.4 Binding complex types,"805 Binding complex types\nto the first object in the database when there is no value and to query for any other \nvalue. To see the effect, restart ASP.NET Core and request http://localhost:5000/\ncontrollers/form and http://localhost:5000/controllers/form/index/0. The first \nURL contains no id value, so the first object in the database is selected. The second \nURL provides an id value of zero, which doesn’t correspond to any object in the \ndatabase. Figure 28.7 shows both results.\nFigure 28.7    Using a nullable type to determine whether a request contains a value  \n28.4 Binding complex types\nThe model binding system shines when dealing with complex types, which are any type \nthat cannot be parsed from a single string value. The model binding process inspects \nthe complex type and performs the binding process on each of the public  properties \nit defines. This means that instead of dealing with individual values such as name  and \nprice , I can use the binder to create complete Product  objects, as shown in listing \n28.10.  \nListing 28.10.    Binding a complex type in the Controllers/FormController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing System.Text.Json;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long? id) {\n            ViewBag.Categories = new SelectList(context.Categories, \n806 chapter  28 Using model binding\n                ""CategoryId"", ""Name"");\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstOrDefaultAsync(p => id == null || p.ProductId == id)\n            ?? new() { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm(Product product) {\n            TempData[""product""] = JsonSerializer.Serialize(product);\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nThe listing changes the SubmitForm  action method so that it defines a Product  param-\neter. Before the action method is invoked, a new Product  object is created, and the \nmodel binding process is applied to each of its public  properties. The SubmitForm  \nmethod is then invoked, using the Product  object as its argument.\nTo see the model binding process, restart ASP.NET Core, navigate to http://  \nlocalhost:5000/controllers/form, and click the Submit button. The model binding \nprocess will extract the data values from the request and produce the result shown in \nfigure 28.8. The Product  object created by the model binding process is serialized as \nJSON data so that it can be stored as temp data, making it easy to see the request data.\nFigure 28.8    Data binding a complex type\nThe data binding process for complex types remains a best-effort feature, meaning \nthat a value will be sought for each public property defined by the Product  class, but \nmissing values won’t prevent the action method from being invoked. Instead, prop-\nerties for which no value can be located will be left as the default value for the prop-\nerty type. The example provided values for the Name  and Price  properties, but the \nProductId , CategoryId , and SupplierId  properties are zero, and the Category  and \nSupplier  properties are null.",3697
340-28.4.1 Binding to a property.pdf,340-28.4.1 Binding to a property,"807 Binding complex types\n28.4.1  Binding to a property \nUsing parameters for model binding doesn’t fit with the Razor Pages development \nstyle because the parameters often duplicate properties defined by the page model \nclass, as shown in listing 28.11.  \nListing 28.11    Binding a complex type in the FormHandler.cshtml file in the Pages folder\n...\n@functions {\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id);\n        }\n        public IActionResult OnPost(Product product) {\n            TempData[""product""] = \n                System.Text.Json.JsonSerializer.Serialize(product);\n            return RedirectToPage(""FormResults"");\n        }\n    }\n}\n...\nThis code works, but the OnPost  handler method has its own version of the Product  \nobject, mirroring the property used by the OnGetAsync  handler. A more elegant \napproach is to use the existing property for model binding, as shown in listing 28.12.  \nListing 28.12    Using a property for model binding in the Pages/FormHandler.cshtml file \n@page ""/pages/form/{id:long?}""\n@model FormHandlerModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n    <form asp-page=""FormHandler"" method=""post"" id=""htmlform"">\n        <div class=""form-group"">\n            <label>Name</label>\n            <input class=""form-control"" asp-for=""Product.Name"" />\n808 chapter  28 Using model binding\n        </div>\n        <div class=""form-group"">\n            <label>Price</label>\n            <input class=""form-control"" asp-for=""Product.Price"" />\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n</div>\n@functions {\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        [BindProperty]\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id);\n        }\n        public IActionResult OnPost() {\n            TempData[""product""] = \n                System.Text.Json.JsonSerializer.Serialize(Product);\n            return RedirectToPage(""FormResults"");\n        }\n    }\n}\nDecorating a property with the BindProperty  attribute indicates that its properties \nshould be subject to the model binding process, which means the OnPost  handler \nmethod can get the data it requires without declaring a parameter. When the Bind-\nProperty  attribute is used, the model binder uses the property name when locat-\ning data values, so the explicit name  attributes added to the input  element are not \nrequired. By default, BindProperty  won’t bind data for GET requests, but this can be \nchanged by setting the BindProperty  attribute’s SupportsGet  argument to true . \nNOTE    The BindProperties  attribute can be applied to classes that require the \nmodel binding process for all the public  properties they define, which can be \nmore convenient than applying BindProperty  to many individual properties. \nDecorate properties with the BindNever  attribute to exclude them from model \nbinding.",3929
341-28.4.2 Binding nested complex types.pdf,341-28.4.2 Binding nested complex types,"809 Binding complex types\n28.4.2  Binding nested complex types \nIf a property that is subject to model binding is defined using a complex type, then the \nmodel binding process is repeated using the property name as a prefix. For example, \nthe Product  class defines the Category  property, whose type is the complex Category  \ntype. Listing 28.13 adds elements to the HTML form to provide the model binder with \nvalues for the properties defined by the Category  class.  \nListing 28.13    Nested form elements in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>Category Name</label>\n        @{ #pragma warning disable CS8602 } \n        <input class=""form-control"" name=""Category.Name"" \n             value=""@Model.Category.Name"" />\n        @{ #pragma warning restore CS8602 } \n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nThe name  attribute combines the property names, separated by periods. In this \ncase, the element is for the Name  property of the object assigned to the view model’s  \nCategory  property, so the name  attribute is set to Category.Name . The input element \ntag helper will automatically use this format for the name  attribute when the asp-for  \nattribute is applied, as shown in listing 28.14.\nListing 28.14    Using a tag helper in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n810 chapter  28 Using model binding\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>Category Name</label>\n        @{ #pragma warning disable CS8602 } \n        <input class=""form-control"" asp-for=""Category.Name"" />\n        @{ #pragma warning restore CS8602 } \n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nThe tag helper is a more reliable method of creating elements for nested properties \nand avoids the risk of typos producing elements that are ignored by the model bind-\ning process. To see the effect of the new elements, request http://localhost:5000/  \ncontrollers/form and click the Submit button, which will produce the response shown \nin figure 28.9.\nFigure 28.9    \nModel binding a \nnested property\nDuring the model binding process, a new Category  object is created and assigned to \nthe Category  property of the Product  object. The model binder locates the value for \nthe Category  object’s Name  property, which can be seen in the figure, but there is no \nvalue for the CategoryId  property, which is left as the default value.\nspecifying  custom  prefixes  for nested  complex  types\nThere are occasions when the HTML you generate relates to one type of object but \nyou want to bind it to another. This means that the prefixes containing the view won’t \ncorrespond to the structure that the model binder is expecting, and your data won’t be \nproperly processed. Listing 28.15 demonstrates this problem by changing the type of \nthe parameter defined by the controller’s SubmitForm  action method.\nListing 28.15    Changing a parameter in the Controllers/FormController.cs file \n...\n[HttpPost]\npublic IActionResult SubmitForm(Category category) {\n    TempData[""category""] = JsonSerializer.Serialize(category);\n    return RedirectToAction(nameof(Results));\n}\n...\nThe new parameter is a Category , which means that the model binder will look for \nform data using the category prefix. This process fails if the form data doesn’t conform \n 811 Binding complex types\nto that naming convention. To demonstrate, listing 28.16 overrides the name attribute \ninput element that provides the category name.\nListing 28.16    Setting the name in the Form.cshtml file in the Views/Forms folder\n...\n@{ #pragma warning disable CS8602 } \n<input class=""form-control"" asp-for=""Category.Name"" name=""cat.name""  />\n@{ #pragma warning restore CS8602 }\n...\nThis change creates a mismatch between the structure of the form data that is received \nby the application and the property names used by the model binder. The model \nbinding process isn’t able to identify the modified input  element. Instead, the model \nbinder will find the Name  value for the Product  object and use that instead, which you \ncan see by restarting ASP.NET Core, requesting http://localhost:5000/controllers/\nform, and submitting the form data, which will produce the first response shown in \nfigure 28.10. \nThis problem is solved by applying the Bind  attribute to the parameter and using the \nPrefix  argument to specify a prefix for the model binder, as shown in listing 28.17.\nListing 28.17.   Setting a prefix in the FormController.cs file in the Controllers folder \n...\n[HttpPost]\npublic IActionResult SubmitForm([Bind(Prefix =""cat"")]Category category) {\n    TempData[""category""] = JsonSerializer.Serialize(category);\n    return RedirectToAction(nameof(Results));\n}\n...\nThe syntax is awkward, but the attribute ensures the model binder can locate the data \nthe action method requires. In this case, setting the prefix to cat ensures the correct \ndata values are used to bind the Category  parameter. Restart ASP.NET Core, request \nhttp://localhost:5000/controllers/form, and submit the form, which produces the \nsecond response shown in figure 28.10.\nFigure 28.10    Specifying a model binding prefix\nWhen using the BindProperty  attribute, the prefix is specified using the Name  argu-\nment, as shown in listing 28.18.\n812 chapter  28 Using model binding\nListing 28.18    Specifying a model binding prefix in the Pages/FormHandler.cshtml file \n@page ""/pages/form/{id:long?}""\n@model FormHandlerModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n    <form asp-page=""FormHandler"" method=""post"" id=""htmlform"">\n        <div class=""form-group"">\n            <label>Name</label>\n            <input class=""form-control"" asp-for=""Product.Name"" />\n        </div>\n        <div class=""form-group"">\n            <label>Price</label>\n            <input class=""form-control"" asp-for=""Product.Price"" />\n        </div>\n        <div class=""form-group"">\n            <label>Category Name</label>\n            @{ #pragma warning disable CS8602 } \n            <input class=""form-control"" asp-for=""Product.Category.Name""  />\n            @{ #pragma warning restore CS8602 } \n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n</div>\n@functions {\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        [BindProperty]\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        [BindProperty(Name = ""Product.Category"")]\n        public Category Category { get; set; } \n            = new() { Name = string.Empty };\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstAsync(p => p.ProductId == id);\n        }\n        public IActionResult OnPost() {\n            TempData[""product""] = \n                System.Text.Json.JsonSerializer.Serialize(Product);",8261
342-28.4.3 Selectively binding properties.pdf,342-28.4.3 Selectively binding properties,"813 Binding complex types\n            TempData[""category""] = \n                System.Text.Json.JsonSerializer.Serialize(Category);\n            return RedirectToPage(""FormResults"");\n        }\n    }\n}\nThis listing adds an input  element that uses the asp-for  attribute to select the \nProduct.  Category  property. A page handler class defined a Category  property that \nis decorated with the BindProperty  attribute and configured with the Name  argument. \nTo see the result of the model binding process, restart ASP.NET Core, use a browser to \nrequest http://localhost:5000/pages/form, and click the Submit button. The model \nbinding finds values for both the decorated properties, which produces the response \nshown in figure 28.11.\nFigure 28.11    \nSpecifying a \nmodel binding \nprefix in a Razor \nPage\n28.4.3  Selectively binding properties\nSome model classes define properties that are sensitive and for which the user should \nnot be able to specify values. A user may be able to change the category for a Product  \nobject, for example, but should not be able to alter the price.\nYou might be tempted to simply create views that omit HTML elements for sensitive \nproperties but that won’t prevent malicious users from crafting HTTP requests that \ncontain values anyway, which is known as an over-binding attack . To prevent the model \nbinder from using values for sensitive properties, the list of properties that should be \nbound can be specified, as shown in listing 28.19.  \nListing 28.19    Selectively binding properties in the Controllers/FormController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing System.Text.Json;\nnamespace WebApp.Controllers {\n814 chapter  28 Using model binding\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long? id) {\n            ViewBag.Categories = new SelectList(context.Categories, \n                ""CategoryId"", ""Name"");\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstOrDefaultAsync(p => id == null || p.ProductId == id)\n            ?? new() { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm([Bind(""Name"", ""Category"")] \n                Product product) {\n            TempData[""name""] = product.Name;\n            TempData[""price""] = product.Price.ToString();\n            TempData[""category name""] = product.Category?.Name;\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nI have returned to the Product  type for the action method parameter, which has been \ndecorated with the Bind  attribute to specify the names of the properties that should be \nincluded in the model binding process. This example tells the model binding feature \nto look for values for the Name  and Category  properties, which excludes any other \nproperty from the process. \nListing 28.20 removes the custom name  attribute I added earlier so that the model \nbinder can find the values it needs using the standard naming conventions.\nListing 28.20    Removing an attribute in the Form.cshtml file in the Views/Forms folder\n...\n@{ #pragma warning disable CS8602 } \n<input class=""form-control"" asp-for=""Category.Name"" />\n@{ #pragma warning restore CS8602 }\n...\nRestart ASP.NET Core, navigate to http://localhost:5000/controllers/form, and sub-\nmit the form. Even though the browser sends a value for the Price  property as part of \nthe HTTP POST request, it is ignored by the model binder, as shown in figure 28.12.\n 815 Binding complex types\nFigure 28.12    \nSelectively \nbinding \nproperties\nselectively  binding  in the model  class  \nIf you are using Razor Pages or you want to use the same set of properties for model \nbinding throughout the application, you can apply the BindNever  attribute directly to \nthe model class, as shown in listing 28.21.  \nListing 28.21    Decorating a property in the Product.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n        public required string Name { get; set; }\n        [Column(TypeName = ""decimal(8, 2)"")]\n        [BindNever]        \n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nThe BindNever  attribute excludes a property from the model binder, which has the \nsame effect as omitting it from the list used in the previous section. To see the effect, \nrestart ASP.NET Core so the change to the Product  class takes effect, request http://",5403
343-28.5 Binding to arrays and collections.pdf,343-28.5 Binding to arrays and collections,,0
344-28.5.1 Binding to arrays.pdf,344-28.5.1 Binding to arrays,"816 chapter  28 Using model binding\nlocalhost:5000/pages/form, and submit the form. Just as with the previous example, \nthe model binder ignores the value for the Price  property, as shown in figure 28.13.\nTIP    There is also a BindRequired  attribute that tells the model binding process \nthat a request must include a value for a property. If the request doesn’t have a \nrequired value, then a model validation error is produced, as described in chap-\nter 29.\nFigure 28.13    \nExcluding a \nproperty from \nmodel binding\n \n28.5 Binding to arrays and collections\nThe model binding process has some nice features for binding request data to arrays \nand collections, which I demonstrate in the following sections. \n28.5.1  Binding to arrays\nOne elegant feature of the default model binder is how it supports arrays. To see how \nthis feature works, add a Razor Page named Bindings.cshtml  to the Pages  folder \nwith the content shown in listing 28.22.\nListing 28.22    The contents of the Bindings.cshtml file in the Pages folder\n@page ""/pages/bindings""\n@model BindingsModel\n@using Microsoft.AspNetCore.Mvc\n@using Microsoft.AspNetCore.Mvc.RazorPages\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col"">\n            <form asp-page=""Bindings"" method=""post"">\n                <div class=""form-group"">\n                    <label>Value #1</label>\n                    <input class=""form-control"" name=""Data"" \n                        value=""Item 1"" />\n 817 Binding to arrays and collections\n                </div>\n                <div class=""form-group"">\n                    <label>Value #2</label>\n                    <input class=""form-control"" name=""Data"" \n                        value=""Item 2"" />\n                </div>\n                <div class=""form-group"">\n                    <label>Value #3</label>\n                    <input class=""form-control"" name=""Data"" \n                        value=""Item 3"" />\n                </div>\n                <button type=""submit"" class=""btn btn-primary"">\n                    Submit\n                </button>\n                <a class=""btn btn-secondary"" asp-page=""Bindings"">Reset</a>\n            </form>\n        </div>\n        <div class=""col"">\n            <ul class=""list-group"">\n                @foreach (string s in Model.Data.Where(s => s != null)) {\n                    <li class=""list-group-item"">@s</li>\n                }\n            </ul>\n        </div>\n    </div>\n</div>\n@functions {\n    public class BindingsModel : PageModel {\n        [BindProperty(Name = ""Data"")]\n        public string[] Data { get; set; } = Array.Empty<string>();\n    }\n}\nModel binding for an array requires setting the name  attribute to the same value for all \nthe elements that will provide an array value. This page displays three input  elements, \nall of which have a name  attribute value of Data . To allow the model binder to find the \narray values, I have decorated the page model’s Data  property with the BindProperty  \nattribute and used the Name  argument. \nTIP    Notice that the page model class in listing 28.22 defines no handler meth-\nods. This is unusual, but it works because there is no explicit processing required \nfor any requests since requests only provide values for and display the Data  array.\nWhen the HTML form is submitted, a new array is created and populated with the val-\nues from all three input  elements, which are displayed to the user. To see the binding \nprocess, restart ASP.NET Core, request http://localhost:5000/pages/bindings, edit \nthe form fields, and click the Submit button. The contents of the Data  array are dis-\nplayed in a list using an @foreach  expression, as shown in figure 28.14.\n818 chapter  28 Using model binding\nFigure 28.14    \nModel binding for \narray values\nNotice that I filter out null  values when displaying the array contents.\n...\n@foreach (string s in Model.Data. Where(s => s != null) ) {\n    <li class=""list-group-item"">@s</li>\n}\n...\nEmpty form fields produce null  values in the array, which I don’t want to show in the \nresults. In chapter 29, I show you how to ensure that values are provided for model \nbinding properties.\nspecifying  index  positions  for array  values\nBy default, arrays are populated in the order in which the form values are received \nfrom the browser, which will generally be the order in which the HTML elements are \ndefined. The name  attribute can be used to specify the position of values in the array if \nyou need to override the default, as shown in listing 28.23.  \nListing 28.23    Specifying array position in the Bindings.cshtml file in the Pages folder\n@page ""/pages/bindings""\n@model BindingsModel\n@using Microsoft.AspNetCore.Mvc\n@using Microsoft.AspNetCore.Mvc.RazorPages\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col"">\n            <form asp-page=""Bindings"" method=""post"">\n                <div class=""form-group"">\n                    <label>Value #1</label>\n                    <input class=""form-control"" name=""Data[1]"" \n                        value=""Item 1"" />\n                </div>\n                <div class=""form-group"">\n                    <label>Value #2</label>\n                    <input class=""form-control"" name=""Data[0]"" \n                        value=""Item 2"" />\n                </div>\n                <div class=""form-group"">\n 819 Binding to arrays and collections\n                    <label>Value #3</label>\n                    <input class=""form-control"" name=""Data[2]"" \n                        value=""Item 3"" />\n                </div>\n                <button type=""submit"" class=""btn btn-primary"">\n                    Submit\n                </button>\n                <a class=""btn btn-secondary"" asp-page=""Bindings"">Reset</a>\n            </form>\n        </div>\n        <div class=""col"">\n            <ul class=""list-group"">\n                @foreach (string s in Model.Data.Where(s => s != null)) {\n                    <li class=""list-group-item"">@s</li>\n                }\n            </ul>\n        </div>\n    </div>\n</div>\n@functions {\n    public class BindingsModel : PageModel {\n        [BindProperty(Name = ""Data"")]\n        public string[] Data { get; set; } = Array.Empty<string>();\n    }\n}\nThe array index notation is used to specify the position of a value in the data-bound \narray. Restart ASP.NET Core, use a browser to request http://localhost:5000/pages/\nbindings, and submit the form; you will see the items appear in the order dictated by \nthe name  attributes, as shown in figure 28.15. The index notation must be applied to all \nthe HTML elements that provide array values, and there must not be any gaps in the \nnumbering sequence.\nFigure 28.15    \nSpecifying \narray position",6838
345-28.5.2 Binding to simple collections.pdf,345-28.5.2 Binding to simple collections,,0
346-28.5.3 Binding to dictionaries.pdf,346-28.5.3 Binding to dictionaries,"820 chapter  28 Using model binding\n28.5.2  Binding to simple collections\nThe model binding process can create collections as well as arrays. For sequence col-\nlections, such as lists and sets, only the type of the property or parameter that is used by \nthe model binder is changed, as shown in listing 28.24.  \nListing 28.24    Binding to a list in the Bindings.cshtml file in the Pages folder \n...\n@functions {\n    public class BindingsModel : PageModel {\n        [BindProperty(Name = ""Data"")]\n        public SortedSet<string> Data { get; set; } \n            = new SortedSet<string>();\n    }\n}\n...\nI changed the type of the Data  property to SortedSet<string> . The model bind-\ning process will populate the set with the values from the input  elements, which will \nbe sorted alphabetically. I have left the index notation on the input  element name  \nattributes, but they have no effect since the collection class will sort its values alpha-\nbetically. To see the effect, restart ASP.NET Core, use a browser to request http://\nlocalhost:5000/pages/bindings, edit the text fields, and click the Submit button. The \nmodel binding process will populate the sorted set with the form values, which will be \npresented in order, as shown in figure 28.16.\nFigure 28.16    \nModel binding to \na collection\n28.5.3  Binding to dictionaries\nFor elements whose name  attribute is expressed using the index notation, the model \nbinder will use the index as the key when binding to a Dictionary , allowing a series of \nelements to be transformed into key-value pairs, as shown in listing 28.25.  \n 821 Binding to arrays and collections\nListing 28.25    Binding to a dictionary in the Bindings.cshtml file in the Pages folder\n@page ""/pages/bindings""\n@model BindingsModel\n@using Microsoft.AspNetCore.Mvc\n@using Microsoft.AspNetCore.Mvc.RazorPages\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col"">\n            <form asp-page=""Bindings"" method=""post"">\n                <div class=""form-group"">\n                    <label>Value #1</label>\n                    <input class=""form-control"" name=""Data[first]"" \n                        value=""Item 1"" />\n                </div>\n                <div class=""form-group"">\n                    <label>Value #2</label>\n                    <input class=""form-control"" name=""Data[second]"" \n                        value=""Item 2"" />\n                </div>\n                <div class=""form-group"">\n                    <label>Value #3</label>\n                    <input class=""form-control"" name=""Data[third]"" \n                        value=""Item 3"" />\n                </div>\n                <button type=""submit"" class=""btn btn-primary"">\n                    Submit\n                </button>\n                <a class=""btn btn-secondary"" asp-page=""Bindings"">Reset</a>\n            </form>\n        </div>\n        <div class=""col"">\n            <table class=""table table-sm table-striped"">\n                <tbody>\n                    @foreach (string key in Model.Data.Keys) {\n                        <tr>\n                            <th>@key</th>\n                            <td>@Model.Data[key]</td>\n                        </tr>\n                    }\n                </tbody>\n            </table>\n        </div>\n    </div>\n</div>\n@functions {\n    public class BindingsModel : PageModel {\n        [BindProperty(Name = ""Data"")]\n        public Dictionary<string, string> Data { get; set; }\n            = new Dictionary<string, string>();\n    }\n}",3563
347-28.5.4 Binding to collections of complex types.pdf,347-28.5.4 Binding to collections of complex types,"822 chapter  28 Using model binding\nAll elements that provide values for the collection must share a common prefix, which \nis Data  in this example, followed by the key value in square brackets. The keys for this \nexample are the strings first , second , and third , and they will be used as the keys for \nthe content the user provides in the text fields. To see the binding process, restart ASP.\nNET Core, request http://localhost:5000/pages/bindings, edit the text fields, and \nsubmit the form. The keys and values from the form data will be displayed in a table, as \nshown in figure 28.17.\nFigure 28.17    Model binding to a dictionary\n28.5.4  Binding to collections of complex types\nThe examples in this section have all been collections of simple types, but the same \nprocess can be used for complex types, too. To demonstrate, listing 28.26 revises the \nRazor Page to gather details used to bind to an array of Product  objects.  \nListing 28.26    Binding to complex types in the Bindings.cshtml file in the Pages folder \n@page ""/pages/bindings""\n@model BindingsModel\n@using Microsoft.AspNetCore.Mvc\n@using Microsoft.AspNetCore.Mvc.RazorPages\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col"">\n            <form asp-page=""Bindings"" method=""post"">\n                @for (int i = 0; i < 2; i++) {\n                    <div class=""form-group"">\n                        <label>Name #@i</label>\n                        <input class=""form-control"" name=""Data[@i].Name""\n                           value=""Product-@i"" />\n                    </div>\n                    <div class=""form-group"">\n                        <label>Price #@i</label>\n                        <input class=""form-control"" name=""Data[@i].Price""\n                           value=""@(100 + i)"" />\n                    </div>\n 823 Binding to arrays and collections\n                }\n                <button type=""submit"" class=""btn btn-primary"">\n                    Submit\n                </button>\n                <a class=""btn btn-secondary"" asp-page=""Bindings"">Reset</a>\n            </form>\n        </div>\n        <div class=""col"">\n            <table class=""table table-sm table-striped"">\n                <tbody>\n                    <tr><th>Name</th><th>Price</th></tr>\n                    @foreach (Product p in Model.Data) {\n                        <tr>\n                            <td>@p.Name</td>\n                            <td>@p.Price</td>\n                        </tr>\n                    }\n                </tbody>\n            </table>\n        </div>\n    </div>\n</div>\n@functions {\n    public class BindingsModel : PageModel {\n        [BindProperty(Name = ""Data"")]\n        public Product[] Data { get; set; } = Array.Empty<Product>();\n    }\n}\nThe name  attributes for the input  elements use the array notation, followed by a \nperiod, followed by the name of the complex type properties they represent. To define \nelements for the Name  and Price  properties, this requires elements like this:\n...\n<input class=""form-control"" name=""Data[0].Name""  />\n...\n<input class=""form-control"" name=""Data[0].Price""  />\n...\nDuring the binding process, the model binder will attempt to locate values for all the \npublic  properties defined by the target type, repeating the process for each set of val-\nues in the form data. \nThis example relies on model binding for the Price  property defined by the  \nProduct  class, which was excluded from the binding process with the BindNever  attri-\nbute. Remove the attribute from the property, as shown in listing 28.27.\nListing 28.27    Removing an attribute in the Product.cs file in the Models folder \nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;",3891
348-28.6 Specifying a model binding source.pdf,348-28.6 Specifying a model binding source,"824 chapter  28 Using model binding\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n        public required string Name { get; set; }\n        [Column(TypeName = ""decimal(8, 2)"")]\n        //[BindNever]        \n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nRestart ASP.NET Core and use a browser to request http://localhost:5000/pages/\nbindings. Enter names and prices into the text fields and submit the form, and you \nwill see the details of the Product  objects created from the data displayed in a table, as \nshown in figure 28.18.\nFigure 28.18    \nBinding to a \ncollection of \ncomplex types\n28.6 Specifying a model binding source\nAs I explained at the start of the chapter, the default model binding process looks for \ndata in four places: the form data values, the request body (for web service controllers \nonly), the routing data, and the request query string. \nThe default search sequence isn’t always helpful, either because you always want data \nto come from a specific part of the request or because you want to use a data source that \nisn’t searched by default. The model binding feature includes a set of attributes used to \noverride the default search behavior, as described in table 28.3.  \n 825 Specifying a model binding source\nTIP    There is also the FromService  attribute, which doesn’t get a value from the \nrequest, but through the dependency injection feature described in chapter 14. \nTable 28.3    The model binding source attributes \nName Description\nFromForm This attribute is used to select form data as the source of binding data. The name of the \nparameter is used to locate a form value by default, but this can be changed using the \nName  property, which allows a different name to be specified.\nFromRoute This attribute is used to select the routing system as the source of binding data. The \nname of the parameter is used to locate a route data value by default, but this can be \nchanged using the Name  property, which allows a different name to be specified.\nFromQuery This attribute is used to select the query string as the source of binding data. The \nname of the parameter is used to locate a query string value by default, but this can \nbe changed using the Name  property, which allows a different query string key to be \nspecified. \nFromHeader This attribute is used to select a request header as the source of binding data. The \nname of the parameter is used as the header name by default, but this can be changed \nusing the Name  property, which allows a different header name to be specified.\nFromBody This attribute is used to specify that the request body should be used as the source of \nbinding data, which is required when you want to receive data from requests that are \nnot form-encoded, such as in API controllers that provide web services.\nThe FromForm , FromRoute , and FromQuery  attributes allow you to specify that the \nmodel binding data will be obtained from one of the standard locations but without \nthe normal search sequence. Earlier in the chapter, I used this URL:\nhttp://localhost:5000/controllers/Form/Index/ 5?id=1\nThis URL contains two possible values that can be used for the id parameter of the \nIndex  action method on the Form  controller. The routing system will assign the final \nsegment of the URL to a variable called id, which is defined in the default URL pattern \nfor controllers, and the query string also contains an id value. The default search pat-\ntern means that the model binding data will be taken from the route data and the query \nstring will be ignored. \nIn listing 28.28, I have applied the FromQuery  attribute to the id parameter defined \nby the Index  action method, which overrides the default search sequence.\nListing 28.28    Selecting the query string in the Controllers/FormController.cs file\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing System.Text.Json;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n826 chapter  28 Using model binding\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index([FromQuery] long? id) {\n            ViewBag.Categories = new SelectList(context.Categories, \n                ""CategoryId"", ""Name"");\n            return View(""Form"", await context.Products\n                .Include(p => p.Category)\n                .Include(p => p.Supplier)\n                .FirstOrDefaultAsync(p => id == null || p.ProductId == id)\n            ?? new() { Name = string.Empty });\n        }\n        [HttpPost]\n        public IActionResult SubmitForm([Bind(""Name"", ""Category"")] \n                Product product) {\n            TempData[""name""] = product.Name;\n            TempData[""price""] = product.Price.ToString();\n            TempData[""category name""] = product.Category?.Name;\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View();\n        }\n    }\n}\nThe attribute specifies the source for the model binding process, which you can see \nby restarting ASP.NET Core and using a browser to request http://localhost:5000/  \ncontrollers/form/index/5?id=1. Instead of using the value that has been matched \nby the routing system, the query string will be used instead, producing the response \nshown in figure 28.19. No other location will be used if the query string doesn’t con-\ntain a suitable value for the model binding process.\nTIP    You can still bind complex types when specifying a model binding source \nsuch as the query string. For each simple property in the parameter type, the \nmodel binding process will look for a query string key with the same name.\nFigure 28.19    \nSpecifying a \nmodel binding \ndata source",6312
349-28.6.1 Selecting a binding source for a property.pdf,349-28.6.1 Selecting a binding source for a property,,0
350-28.6.2 Using headers for model binding.pdf,350-28.6.2 Using headers for model binding,"827 Specifying a model binding source\n28.6.1  Selecting a binding source for a property \nThe same attributes can be used to model bind properties defined by a page model or \na controller, as shown in listing 28.29.\nListing 28.29    Selecting the query string in the Bindings.cshtml file in the Pages folder\n...\n@functions {\n    public class BindingsModel : PageModel {\n        //[BindProperty(Name = ""Data"")]\n        [FromQuery(Name = ""Data"")]\n        public Product[] Data { get; set; } = Array.Empty<Product>();\n    }\n}\n...\nThe use of the FromQuery  attribute means the query string is used as the source of \nvalues for the model binder as it creates the Product  array, which you can see by start-\ning ASP.NET Core and requesting http://localhost:5000/pages/bindings?data[0].\nname=Skis&data[0].price=500, which produces the response shown in figure 28.20.\nNOTE    In this example, I have used a GET request because it allows the query \nstring to be easily set. Although it is harmless in such a simple example, care \nmust be taken when sending GET requests that modify the state of the applica-\ntion. As noted previously, making changes in GET requests can lead to problems. \nFigure 28.20    Specifying a model binding data source in a Razor Page\nTIP    Although it is rarely used, you can bind complex types using header values \nby applying the FromHeader  attribute to the properties of a model class. \n28.6.2  Using headers for model binding \nThe FromHeader  attribute allows HTTP request headers to be used as the source \nfor binding data. In listing 28.30, I have added a simple action method to the Form  \ncontroller that defines a parameter that will be model bound from a standard HTTP \nrequest header.  \n828 chapter  28 Using model binding\nListing 28.30    Model binding from a header in the Controllers/FormController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing System.Text.Json;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        // ...other actions omitted for brevity...\n        public string Header([FromHeader] string accept) {\n            return $""Header: {accept}"";\n        }\n    }\n}\nThe Header  action method defines an accept  parameter, the value for which will be \ntaken from the Accept  header in the current request and returned as the method \nresult. Restart ASP.NET Core and request http://localhost:5000/controllers/form/\nheader, and you will see a result like this:\nHeader: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp, \n    image/apng,*/*;q=0.8,application/signed-exchange;v=b3\nNot all HTTP header names can be easily selected by relying on the name of the action \nmethod parameter because the model binding system doesn’t convert from C# naming \nconventions to those used by HTTP headers. In these situations, you must configure \nthe FromHeader  attribute using the Name  property to specify the name of the header, \nas shown in listing 28.31.\nListing 28.31    Selecting a header by name in the Controllers/FormController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing System.Text.Json;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;",3666
351-28.7 Manual model binding.pdf,351-28.7 Manual model binding,"829 Specifying a model binding source\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        // ...other actions omitted for brevity...\n        public string Header([FromHeader(Name = ""Accept-Language"")] \n                string accept) {\n            return $""Header: {accept}"";\n        }\n    }\n}\nI can’t use Accept-Language  as the name of a C# parameter, and the model binder \nwon’t automatically convert a name like AcceptLanguage  into Accept-Language  so \nthat it matches the header. Instead, I used the Name  property to configure the attribute \nso that it matches the right header. If you restart ASP.NET Core and request http://\nlocalhost:5000/controllers/form/header, you will see a result like this, which will vary \nbased on your locale settings:\nHeader: en-GB,en-US;q=0.9,en;q=0.8\n28.6.3  Using request bodies as binding sources \nNot all data sent by clients is sent as form data, such as when a JavaScript client sends \nJSON data to an API controller. The FromBody  attribute specifies that the request body \nshould be decoded and used as a source of model binding data. In listing 28.32, I have \nadded a new action method to the Form  controller with a parameter that is decorated \nwith the FromBody  attribute.  \nTIP    The FromBody  attribute isn’t required for controllers that are decorated \nwith the ApiController  attribute.\nListing 28.32    Adding an action method in the FormController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.Rendering;\nusing System.Text.Json;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n830 chapter  28 Using model binding\n        // ...other actions omitted for brevity...\n        [HttpPost]\n        [IgnoreAntiforgeryToken]\n        public Product Body([FromBody] Product model) {\n            return model;\n        }\n    }\n}\nTo test the model binding process, restart ASP.NET Core, open a new PowerShell \ncommand prompt, and run the command in listing 28.33 to send a request to the \napplication.\nNOTE     I added the IgnoreAntiforgeryToken  to the action method in listing \n28.32 because the request that I am going to send won’t include an anti-forgery \ntoken, which I described in chapter 27.\nListing 28.33    Sending a request \nInvoke-RestMethod http://localhost:5000/controllers/form/body -Method POST  \n‰-Body  (@{ Name=""Soccer Boots""; Price=89.99} | ConvertTo-Json)  \n‰-ContentType ""application/json""\nThe JSON-encoded request body is used to model bind the action method parameter, \nwhich produces the following response:\nproductId  : 0 \nname       : Soccer Boots \nprice      : 89.99 \ncategoryId : 0 \ncategory   : \nsupplierId : 0 \nsupplier   :\n28.7 Manual model binding\nModel binding is applied automatically when you define a parameter for an action \nor handler method or apply the BindProperty  attribute. Automatic model binding \nworks well if you can consistently follow the name conventions and you always want the \nprocess to be applied. If you need to take control of the binding process or you want to \nperform binding selectively, then you can perform model binding manually, as shown \nin listing 28.34.  \nListing 28.34    Manually binding in the Bindings.cshtml file in the Pages folder\n@page ""/pages/bindings""\n@model BindingsModel\n@using Microsoft.AspNetCore.Mvc\n@using Microsoft.AspNetCore.Mvc.RazorPages\n<div class=""container-fluid"">\n    <div class=""row"">\n 831 Manual model binding\n        <div class=""col"">\n            <form asp-page=""Bindings"" method=""post"">\n                <div class=""form-group"">\n                    <label>Name</label>\n                    <input class=""form-control"" asp-for=""Data.Name"" />\n                </div>\n                <div class=""form-group"">\n                    <label>Price</label>\n                    <input class=""form-control"" asp-for=""Data.Price""\n                           value=""@(Model.Data.Price + 1)"" />\n                </div>\n                <div class=""form-check m-2"">\n                    <input class=""form-check-input"" type=""checkbox"" \n                        name=""bind"" value=""true"" checked />\n                    <label class=""form-check-label"">Model Bind?</label>\n                </div>\n                <button type=""submit"" class=""btn btn-primary"">\n                    Submit\n                </button>\n                <a class=""btn btn-secondary"" asp-page=""Bindings"">Reset</a>\n            </form>\n        </div>\n        <div class=""col"">\n            <table class=""table table-sm table-striped"">\n                <tbody>\n                    <tr><th>Name</th><th>Price</th></tr>\n                    <tr>\n                        <td>@Model.Data.Name</td>\n                        <td>@Model.Data.Price</td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n    </div>\n</div>\n@functions {\n    public class BindingsModel : PageModel {\n        public Product Data { get; set; }\n            = new Product() { Name = ""Skis"", Price = 500 };\n        public async Task OnPostAsync([FromForm] bool bind) {\n            if (bind) {\n                await TryUpdateModelAsync<Product>(Data,\n                    ""data"", p => p.Name, p => p.Price);\n            }\n        }\n    }\n}\nManual model binding is performed using the TryUpdateModelAsync  method, which \nis provided by the PageModel  and ControllerBase  classes, which means it is available \nfor both Razor Pages and MVC controllers.  \n832 chapter  28 Using model binding\nThis example mixes automatic and manual model binding. The OnPostAsync  \nmethod uses automatic model binding to receive a value for its bind  parameter, which \nhas been decorated with the FromForm  attribute. If the value of the parameter is true , \nthe TryUpdateModelAsync  method is used to apply model binding. The arguments \nto the TryUpdateModelAsync  method are the object that will be model bound, the \nprefix for the values, and a series of expressions that select the properties that will be \nincluded in the process, although there are other versions of the TryUpdateModel -\nAsync  method available. \nThe result is that the model binding process for the Data  property is performed only \nwhen the user checks the checkbox added to the form in listing 28.34. If the checkbox \nis unchecked, then no model binding occurs, and the form data is ignored. To make it \nobvious when model binding is used, the value of the Price  property is incremented \nwhen the form is rendered. To see the effect, restart ASP.NET Core, request http://\nlocalhost:5000/pages/bindings, and submit the form with the checkbox checked and \nthen unchecked, as shown in figure 28.21.\nFigure 28.21    \nUsing manual \nmodel binding\nSummary\n¡ Model binding is the process by which request data is converted into parameters \nfor action methods or page-handler methods.\n¡ The model binder is integrated into ASP.NET Core and follows well-defined con-\nventions to bind to simple and complex data types.\n¡ ASP.NET Core provides attributes for fine-tuning the model binding process \nwhen the request data doesn’t match the expected conventions.\n¡ The model-binding process can read values from form data, the current route, \nthe query string, the request header, and request body.\n¡ Model binding is performed automatically but can be performed manually, \nwhich provides precise control over the binding process.",7777
352-29 Using model validation.pdf,352-29 Using model validation,"83329Using model validation\nThis chapter covers\n¡ Understanding the ASP.NET Core data  \n validation features\n¡ Applying validation to form data\n¡ Displaying validation errors to the user\n¡ Explicitly validating data in a controller or  \n Razor Page\n¡ Specifying validation rules using attributes\n¡ Using JavaScript to perform client-side   \n validation\nIn the previous chapter, I showed you how the model binding process creates objects \nfrom HTTP requests. Throughout that chapter, I simply displayed the data that the \napplication received. That’s because the data that users provide should not be used \nuntil it has been inspected to ensure that the application is able to use it. The reality \nis that users will often enter data that isn’t valid and cannot be used, which leads me \nto the topic of this chapter: model validation.\nModel validation  is the process of ensuring the data received by the application \nis suitable for binding to the model and, when this is not the case, providing useful \ninformation to the user that will help explain the problem. \n834 chapter  29 Using model validation\nThe first part of the process, checking the data received, is one of the most important \nways to preserve the integrity of an application’s data. Rejecting data that cannot be \nused can prevent odd and unwanted states from arising in the application. The second \npart of the validation process is helping the user correct the problem and is equally \nimportant. Without the feedback needed to correct the problem, users become frus-\ntrated and confused. In public-facing applications, this means users will simply stop \nusing the application. In corporate applications, this means the user’s workflow will be \nhindered. Neither outcome is desirable, but fortunately, ASP.NET Core provides exten-\nsive support for model validation. Table 29.1 puts model validation in context.\nTable 29.1    Putting model validation in context\nQuestion Answer\nWhat is it? Model validation is the process of ensuring \nthat the data provided in a request is valid for \nuse in the application.\nWhy is it useful? Users do not always enter valid data, and \nusing unvalidated data can produce unex-\npected and undesirable errors. \nHow is it used? Controllers and Razor Pages check the out-\ncome of the validation process, and tag help-\ners are used to include validation feedback \nin views displayed to the user. Validation can \nbe performed automatically during the model \nbinding process and can be supplemented \nwith custom validation. \nAre there any pit-\nfalls or limitations?It is important to test the efficacy of your \nvalidation code to ensure that it covers the \nfull range of values that the application can \nreceive. \nAre there any \nalternatives?Model validation is optional, but it is a good \nidea to use it whenever using model binding.\nTable 29.2 provides a guide to the chapter.\nTable 29.2    Chapter guide\nProblem Solution Listing\nValidating data Manually use the ModelState  \nfeatures or apply validation \nattributes5, 9, \n14–22\nDisplaying valida-\ntion messagesUse the classes to which form \nelements are assigned and the \nvalidation tag helpers6–8, \n10–13\nValidating data \nbefore the form is \nsubmittedUse client-side and remote \nvalidation 23–27",3311
353-29.1.1 Dropping the database.pdf,353-29.1.1 Dropping the database,"835 Preparing for this chapter\n29.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 28. To prepare for this chapter, \nchange the contents of the Form  controller’s Form  view so it contains input  elements \nfor each of the properties defined by the Product  class, excluding the navigation prop-\nerties used by Entity Framework Core, as shown in listing 29.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 29.1    Changing elements in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>CategoryId</label>\n        <input class=""form-control"" asp-for=""CategoryId""  />\n    </div>\n    <div class=""form-group"">\n        <label>SupplierId</label>\n        <input class=""form-control"" asp-for=""SupplierId""  />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nReplace the contents of the FormController.cs  file with those shown in listing 29.2, \nwhich adds support for displaying the properties defined in listing 29.1 and removes \nmodel binding attributes and action methods that are no longer required.\nListing 29.2    Replacing the FormController.cs file’s contents in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]",2036
354-29.2 Understanding the need for model validation.pdf,354-29.2 Understanding the need for model validation,"836 chapter  29 Using model validation\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long? id) {\n            return View(""Form"", await context.Products\n                .OrderBy(p => p.ProductId)\n                .FirstOrDefaultAsync(p => id == null \n                    || p.ProductId == id));\n        }\n        [HttpPost]\n        public IActionResult SubmitForm(Product product) {\n            TempData[""name""] = product.Name;\n            TempData[""price""] = product.Price.ToString();\n            TempData[""categoryId""] = product.CategoryId.ToString();\n            TempData[""supplierId""] = product.SupplierId.ToString();\n            return RedirectToAction(nameof(Results));\n        }\n        public IActionResult Results() {\n            return View(TempData);\n        }\n    }\n}\n29.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 29.3 to drop the database.\nListing 29.3    Dropping the database\ndotnet ef database drop --force\n29.1.2  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 29.4. \nListing 29.4    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers/form, which will display \nan HTML form. Click the Submit button, and the form data will be displayed, as shown \nin figure 29.1.",1626
355-29.3 Validating data.pdf,355-29.3 Validating data,"837 Validating data\nFigure 29.1    \nRunning the \nexample \napplication\n29.2 Understanding the need for model validation \nModel validation is the process of enforcing the requirements that an application has \nfor the data it receives from clients. Without validation, an application will try to oper-\nate on any data it receives, which can lead to exceptions and unexpected behaviors \nthat appear immediately or long-term problems that appear gradually as the database \nis populated with bad, incomplete, or malicious data.\nCurrently, the action and handler methods that receive form data will accept any \ndata that the user submits, which is why the examples just display the form data and \ndon’t store it in the database. \nMost data values have constraints of some sort. This can involve requiring a value \nto be provided, requiring the value to be a specific type, and requiring the value to fall \nwithin a specific range.\nBefore I can safely store a Product  object in the database, for example, I need \nto make sure that the user provides values for the Name , Price , CategoryId , and  \nSupplierId  properties. The Name  value can be any valid string, the Price  property \nmust be a valid currency amount, and the CategoryId  and SupplierId  properties \nmust correspond to existing Supplier  and Category  products in the database. In the \nfollowing sections, I demonstrate how model validation can be used to enforce these \nrequirements by checking the data that the application receives and providing feed-\nback to the user when the application cannot use the data the user has submitted. \n29.3 Validating data\nAlthough it is not evident, ASP.NET Core is already performing some basic data vali-\ndation during the model binding process, but the errors it detects are being discarded \nbecause ASP.NET Core hasn’t been told how to respond to them. Listing 29.5 checks \nthe outcome of the validation process so that the data values the user has provided will \nbe used only if they are valid.\n838 chapter  29 Using model validation\nListing 29.5    Checking the outcome in the FormController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long? id) {\n            return View(""Form"", await context.Products\n                .OrderBy(p => p.ProductId)\n                .FirstOrDefaultAsync(p => id == null \n                    || p.ProductId == id));\n        }\n        [HttpPost]\n        public IActionResult SubmitForm(Product product) {\n            if (ModelState.IsValid) {\n                TempData[""name""] = product.Name;\n                TempData[""price""] = product.Price.ToString();\n                TempData[""categoryId""] = product.CategoryId.ToString();\n                TempData[""supplierId""] = product.SupplierId.ToString();\n                return RedirectToAction(nameof(Results));\n            } else {\n                return View(""Form"");\n            }\n        }\n        public IActionResult Results() {\n            return View(TempData);\n        }\n    }\n}\nI determine if the data provided by the user is valid using the ModelStateDictionary  \nobject that is returned by the ModelState  property inherited from the Controller-\nBase  class. \nAs its name suggests, the ModelStateDictionary  class is a dictionary used to track \ndetails of the state of the model object, with an emphasis on validation errors. Table \n29.3 describes the most important ModelStateDictionary  members.  \n 839 Validating data\nTable 29.3    Selected ModelStateDictionary members\nName Description\nAddModelError(property, message) This method is used to record a model  \nvalidation error for the specified property.\nGetValidationState(property) This method is used to determine whether \nthere are model validation errors for a specific \nproperty, expressed as a value from the  \nModelValidationState  enumeration.\nIsValid This property returns true  if all the model \nproperties are valid and returns false  \notherwise.\nClear() This property clears the validation state.\nIf the validation process has detected problems, then the IsValid  property will return \nfalse . The SubmitForm  action method deals with invalid data by returning the same \nview, like this:\n...\nif (ModelState.IsValid) {\n   TempData[""name""] = product.Name;\n   TempData[""price""] = product.Price.ToString();\n   TempData[""category name""] = product.Category?.Name;\n   return RedirectToAction(nameof(Results));\n} else {\n    return View(""Form"");\n}\n...\nIt may seem odd to deal with a validation error by calling the View  method, but the \ncontext data provided to the view contains details of the model validation errors; these \ndetails are used by the tag helper to transform the input  elements.  \nTo see how this works, restart ASP.NET Core and use a browser to request http://\nlocalhost:5000/controllers/form. Clear the contents of the Name field and click the \nSubmit button. There won’t be any visible change in the content displayed by the \nbrowser, but if you examine the input  element for the Name  field, you will see the ele-\nment has been transformed. Here is the input  element before the form was submitted:\n<input class=""form-control"" type=""text"" data-val=""true""  \n    data-val-required=""The Name field is required."" id=""Name""  \n    name=""Name"" value=""Kayak"">\nHere is the input  element after the form has been submitted: \n<input class=""form-control input-validation-error "" type=""text"" \n    data-val=""true"" data-val-required=""The Name field is required.""\n    id=""Name"" name=""Name"" value="""">\nThe tag helper adds elements whose values have failed validation to the input \n- validation-error  class, which can then be styled to highlight the problem to the \nuser. \nYou can do this by defining custom CSS styles in a stylesheet, but a little extra work is \nrequired if you want to use the built-in validation styles that CSS libraries like Bootstrap \n840 chapter  29 Using model validation\nprovides. The name of the class added to the input  elements cannot be changed, which \nmeans that some JavaScript code is required to map between the name used by ASP.\nNET Core and the CSS error classes provided by Bootstrap.\nTIP    Using JavaScript code like this can be awkward, and it can be tempting \nto use custom CSS styles, even when working with a CSS library like Bootstrap. \nHowever, the colors used for validation classes in Bootstrap can be overridden by \nusing themes or by customizing the package and defining your own styles, which \nmeans you have to ensure that any changes to the theme are matched by corre-\nsponding changes to any custom styles you define. Ideally, Microsoft will make \nthe validation class names configurable in a future release of ASP.NET Core, but \nuntil then, using JavaScript to apply Bootstrap styles is a more robust approach \nthan creating custom stylesheets.\nTo define the JavaScript code so that it can be used by both controllers and Razor \nPages, use the Razor View - Empty template in Visual Studio to add a file named  \n_Validation.cshtml  to the Views/Shared  folder with the content shown in listing \n29.6. Visual Studio Code doesn’t require templates, and you can just add a file named \n_Validation.cshtml  in the Views/Shared  folder with the code shown in the listing.  \nListing 29.6    The contents of the _Validation.cshtml file in the Views/Shared folder \n<script type=""text/javascript"">\n    window.addEventListener(""DOMContentLoaded"", () => {\n        document.querySelectorAll(""input.input-validation-error"")\n            .forEach((elem) => { elem.classList.add(""is-invalid""); }\n        );\n    });\n</script>\nI will use the new file as a partial view, which contains a script element that uses the \nbrowser’s JavaScript Document Object Model (DOM) API to locate input  elements \nthat are members of the input-validation-error  class and adds them to the  \nis- invalid class (which Bootstrap uses to set the error color for form elements). \nListing 29.7 uses the partial  tag helper to incorporate the new partial view into the \nHTML form so that fields with validation errors are highlighted.\nListing 29.7    Including a partial view in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<partial name=""_Validation"" />\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />",8940
356-29.3.1 Displaying validation messages.pdf,356-29.3.1 Displaying validation messages,"841 Validating data\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>CategoryId</label>\n        <input class=""form-control"" asp-for=""CategoryId""  />\n    </div>\n    <div class=""form-group"">\n        <label>SupplierId</label>\n        <input class=""form-control"" asp-for=""SupplierId""  />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nThe JavaScript code runs when the browser has finished parsing all the elements in \nthe HTML document, and the effect is to highlight the input  elements that have been \nassigned to the input-validaton-error  class. You can see the effect by restarting \nASP.NET Core, navigating to http://localhost:5000/controllers/form, clearing the \ncontents of the Name field, and submitting the form, which produces the response \nshown in figure 29.2.\nFigure 29.2    \nHighlighting a \nvalidation error\n29.3.1  Displaying validation messages\nFigure 29.2 makes it clear that something is wrong with the Name  field but doesn’t pro-\nvide any details about what problem has been detected. Providing the user with more \ninformation requires the use of a different tag helper, which adds a summary of the \nproblems to the view, as shown in listing 29.8. \nListing 29.8    Displaying a summary in the Form.cshtml file in the Views/Form folder\n@model Product\n@{  Layout = ""_SimpleLayout""; }\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n842 chapter  29 Using model validation\n<partial name=""_Validation"" />\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div asp-validation-summary=""All"" class=""text-danger""></div>\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>CategoryId</label>\n        <input class=""form-control"" asp-for=""CategoryId""  />\n    </div>\n    <div class=""form-group"">\n        <label>SupplierId</label>\n        <input class=""form-control"" asp-for=""SupplierId""  />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nThe ValidationSummaryTagHelper  class detects the asp-validation-summary  \nattribute on div elements and responds by adding messages that describe any valida-\ntion errors that have been recorded. The value of the asp-validation-summary  attri-\nbute is a value from the ValidationSummary  enumeration, which defines the values \nshown in table 29.4 and which I demonstrate shortly.  \nTable 29.4    The ValidationSummary values\nName Description\nAll This value is used to display all the valida-\ntion errors that have been recorded.\nModelOnly This value is used to display only the valida-\ntion errors for the entire model, excluding \nthose that have been recorded for individ-\nual properties, as described in the ""Display-\ning Model-Level Messages"" section.\nNone This value is used to disable the tag helper \nso that it does not transform the HTML \nelement.\nPresenting error messages helps the user understand why the form cannot be pro-\ncessed. Restart ASP.NET Core, request http://localhost:5000/controllers/form, clear \nthe Name field, and submit the form. As figure 29.3 shows, there is now an error mes-\nsage that explains the problem has been detected.",3591
357-29.3.3 Performing explicit validation.pdf,357-29.3.3 Performing explicit validation,"843 Validating data\nFigure 29.3    \nDisplaying \na validation \nmessage\n29.3.2  Understanding the implicit validation checks  \nThe error message displayed in figure 29.3 is generated by the implicit validation pro-\ncess, which is performed automatically during model binding. \nImplicit validation is simple but effective, and there are two basic checks: the user \nmust provide a value for all properties that are defined with a non-nullable type, and \nASP.NET Core must be able to parse the string  values received in the HTTP request \ninto the corresponding property type.\nAs a reminder, here is the definition of the Product  class, which is the class used to \nreceive the form data:\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n        public required string Name { get; set; }\n        [Column(TypeName = ""decimal(8, 2)"")]\n        //[BindNever]        \n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nThe required keyword has been applied to the Name  property, which is why a valida-\ntion error was reported when the field was cleared in the previous section. There are \n844 chapter  29 Using model validation\nno parsing issues for the Name  property because the string  value received from the \nHTTP request does not need any type conversion. \nEnter ten into the Price  field and submit the form; you will see an error that shows \nthat ASP.NET Core cannot parse the string in the HTTP request into the decimal  value \nrequired by the Price  property, as shown in figure 29.4.\nFigure 29.4    \nDisplaying \na parsing \nvalidation \nmessage\n29.3.3  Performing explicit validation \nImplicit validation takes care of the basics, but most applications require additional \nchecks to ensure that they receive useful data. This is known as explicit validation , and it \nis done using the ModelStateDictionary  methods described in table 29.4.\nTo avoid displaying conflicting error messages, explicit validation is typically done \nonly when the user has provided a value that has passed the implicit checks. The  \nModelStateDictionary.GetValidationState  method is used to see whether there \nhave been any errors recorded for a model property. The GetValidationState  \nmethod returns a value from the ModelValidationState  enumeration, which defines \nthe values described in table 29.5.  \nTable 29.5    The ModelValidationState values\nName Description\nUnvalidated This value means that no validation has been performed \non the model property, usually because there was no value \nin the request that corresponded to the property name.\nValid This value means that the request value associated with \nthe property is valid.\nInvalid This value means that the request value associated with \nthe property is invalid and should not be used.\nSkipped This value means that the model property has not been \nprocessed, which usually means that there have been so \nmany validation errors that there is no point continuing to \nperform validation checks.\n 845 Validating data\nListing 29.9 defines explicit validation checks for some of the properties defined by the \nProduct  class.\nListing 29.9    Explicit validation in the FormController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long? id) {\n            return View(""Form"", await context.Products\n                .OrderBy(p => p.ProductId)\n                .FirstOrDefaultAsync(p => id == null \n                    || p.ProductId == id));\n        }\n        [HttpPost]\n        public IActionResult SubmitForm(Product product) {\n            if (ModelState.GetValidationState(nameof(Product.Price))\n                    == ModelValidationState.Valid && product.Price <= 0) {\n                ModelState.AddModelError(nameof(Product.Price),\n                    ""Enter a positive price"");\n            }\n            if (ModelState.GetValidationState(nameof(Product.CategoryId))\n                == ModelValidationState.Valid && \n                        !context.Categories.Any(c =>\n                            c.CategoryId == product.CategoryId)) {\n                ModelState.AddModelError(nameof(Product.CategoryId),\n                    ""Enter an existing category ID"");\n            }\n            if (ModelState.GetValidationState(nameof(Product.SupplierId))\n                    == ModelValidationState.Valid && \n                        !context.Suppliers.Any(s =>\n                            s.SupplierId == product.SupplierId)) {\n                ModelState.AddModelError(nameof(Product.SupplierId),\n                    ""Enter an existing supplier ID"");\n            }\n            if (ModelState.IsValid) {\n                TempData[""name""] = product.Name;\n846 chapter  29 Using model validation\n                TempData[""price""] = product.Price.ToString();\n                TempData[""categoryId""] = product.CategoryId.ToString();\n                TempData[""supplierId""] = product.SupplierId.ToString();\n                return RedirectToAction(nameof(Results));\n            } else {\n                return View(""Form"");\n            }\n        }\n        public IActionResult Results() {\n            return View(TempData);\n        }\n    }\n}\nAs an example of using the ModelStateDictionary , consider how the Price  prop-\nerty is validated. One of the validation requirements for the Product  class is to ensure \nthe user provides a positive value for the Price  property. This is something that ASP.\nNET Core cannot infer from the Product  class and so explicit validation is required.\nI start by ensuring that there are no existing validation errors for the Price  property:\n...\nif (ModelState.GetValidationState(nameof(Product.Price))\n        == ModelValidationState.Valid  && product.Price <= 0) {\n    ModelState.AddModelError(nameof(Product.Price),\n        ""Enter a positive price"");\n}\n...\nI want to make sure that the user provides a Price  value that is greater than zero, but \nthere is no point in recording an error about zero or negative values if the user has \nprovided a value that the model binder cannot convert into a decimal  value. I use the \nGetValidationState  method to determine the validation status of the Price  prop-\nerty before performing my own validation check:\n...\nif (ModelState.GetValidationState(nameof(Product.Price))\n        == ModelValidationState.Valid && product.Price <= 0 ) {\n    ModelState.AddModelError(nameof(Product.Price),\n        ""Enter a positive price"");\n}\n...\nIf the user has provided a value that is less than or equal to zero, then I use the Add-\nModelError  method to record a validation error:\n...\nif (ModelState.GetValidationState(nameof(Product.Price))\n        == ModelValidationState.Valid && product.Price <= 0) {\n    ModelState.AddModelError(nameof(Product.Price),\n        ""Enter a positive price"");\n}\n...\nThe arguments to the AddModelError  method are the name of the property and a \nstring that will be displayed to the user to describe the validation issue.",7902
358-29.3.4 Configuring the default validation error messages.pdf,358-29.3.4 Configuring the default validation error messages,"847 Validating data\nFor the CategoryId  and SupplierId  properties, I follow a similar process and use \nEntity Framework Core to ensure that the value the user has provided corresponds to \nan ID stored in the database. \nAfter performing the explicit validation checks, I use the ModelState.IsValid  \nproperty to see whether there were errors, which means that implicit or explicit valida-\ntion errors will be reported in the same way.\nTo see the effect of explicit validation, restart ASP.NET Core, request http://  \nlocalhost:5000/controllers/form, and enter 0 into the Price , CategoryId , and  \nSupplierId  fields. Submit the form, and you will see the validation errors shown in \nfigure 29.5.\nFigure 29.5     \nExplicit  \nvalidation \nmessages\n29.3.4  Configuring the default validation error messages \nThe validation process has some inconsistencies when it comes to the validation mes-\nsages that are displayed. Not all the validation messages produced by the model binder \nare helpful to the user, which you can see by clearing the Price field and submitting the \nform. The empty field produces the following message:  \nThe value '' is invalid\nThis message is added to the ModelStateDictionary  by the implicit validation pro-\ncess when it can’t find a value for a property. A missing value for a decimal  property, \nfor example, causes a different—and less useful—message than a missing value for a \nstring  property. This is because of differences in the way that the validation checks \nare performed. The default messages for some validation errors can be replaced with \ncustom messages using the methods defined by the DefaultModelBindingMessage-\nProvider  class, the most useful of which are described in table 29.6.\n848 chapter  29 Using model validation\nTable 29.6    Useful DefaultModelBindingMessageProvider methods\nName Description\nSetValueMustNotBeNullAccessor The function assigned to this property is used to \ngenerate a validation error message when a value is \nnull  for a model property that is non-nullable.\nSetMissingBindRequiredValue  Accessor The function assigned to this property is used to gen-\nerate a validation error message when the request \ndoes not contain a value for a required property.\nSetMissingKeyOrValueAccessor The function assigned to this property is used to \ngenerate a validation error message when the data \nrequired for dictionary model object contains null \nkeys or values.\nSetAttemptedValueIsInvalid  Accessor The function assigned to this property is used to \ngenerate a validation error message when the model \nbinding system cannot convert the data value into \nthe required C# type. \nSetUnknownValueIsInvalidAccessor The function assigned to this property is used to  \ngenerate a validation error message when the model \nbinding system cannot convert the data value into \nthe required C# type. \nSetValueMustBeANumberAccessor The function assigned to this property is used to \ngenerate a validation error message when the data \nvalue cannot be parsed into a C# numeric type. \nSetValueIsInvalidAccessor The function assigned to this property is used to  \ngenerate a fallback validation error message that is \nused as a last resort.\nEach of the methods described in the table accepts a function that is invoked to get \nthe validation message to display to the user. These methods are applied through \nthe options pattern in the Program.cs  file, as shown in listing 29.10, in which I \nhave replaced the default message that is displayed when a value is null or cannot be \nconverted.\nListing 29.10    Changing a validation message in the Program.cs file in the WebApp folder \nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing Microsoft.AspNetCore.Antiforgery;\nusing Microsoft.AspNetCore.Mvc;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddSingleton<CitiesData>();\n 849 Validating data\nbuilder.Services.Configure<AntiforgeryOptions>(opts => {\n    opts.HeaderName = ""X-XSRF-TOKEN"";\n});\nbuilder.Services.Configure<MvcOptions>(opts => \n    opts.ModelBindingMessageProvider\n    .SetValueMustNotBeNullAccessor(value => ""Please enter a value""));\nvar app = builder.Build();\napp.UseStaticFiles();\nIAntiforgery antiforgery \n    = app.Services.GetRequiredService<IAntiforgery>();\napp.Use(async (context, next) => {\n    if (!context.Request.Path.StartsWithSegments(""/api"")) {\n        string? token = \n            antiforgery.GetAndStoreTokens(context).RequestToken;\n        if (token != null) {\n            context.Response.Cookies.Append(""XSRF-TOKEN"",\n               token,\n               new CookieOptions { HttpOnly = false });\n        }\n    }\n    await next();\n});\napp.MapControllerRoute(""forms"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe function that you specify receives the value that the user has supplied, although \nthat is not especially useful when dealing with null  values. To see the custom message, \nrestart ASP.NET Core, use the browser to request http://localhost:5000/controllers/\nform, and submit the form with an empty Price field. The response will include the \ncustom error message, as shown in figure 29.6.\nFigure 29.6    \nChanging the \ndefault validation \nmessages",5729
359-29.3.6 Displaying model-level messages.pdf,359-29.3.6 Displaying model-level messages,"850 chapter  29 Using model validation\nFigure 29.6 also shows the message displayed for a missing Name  field, which isn’t \naffected by the settings in table 29.6. This is a quirk of the way that non-nullable model \nproperties are validated, which behaves as though the Required  attribute has been \napplied to the non-nullable property. I describe the Required  attribute later in this \nchapter and explain how it can be used to change the error message for non-nullable \nproperties.\n29.3.5  Displaying property-level validation messages\nAlthough the custom error message is more meaningful than the default one, it still \nisn’t that helpful because it doesn’t clearly indicate which field the problem relates \nto. For this kind of error, it is more useful to display the validation error messages \nalongside the HTML elements that contain the problem data. This can be done using \nthe ValidationMessageTag  tag helper, which looks for span  elements that have the \nasp-validation-for  attribute, which is used to specify the property for which error \nmessages should be displayed. \nIn listing 29.11, I have added property-level validation message elements for each of \nthe input  elements in the form. \nListing 29.11    Property-level messages in the Form.cshtml file in the Views/Form folder\n@model Product\n@{\n    Layout = ""_SimpleLayout"";\n}\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<partial name=""_Validation"" />\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div asp-validation-summary=""All"" class=""text-danger""></div>\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <div>\n            <span asp-validation-for=""Name"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <div>\n            <span asp-validation-for=""Price"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>CategoryId</label>\n 851 Validating data\n        <div>\n            <span asp-validation-for=""CategoryId"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""CategoryId"" />\n    </div>\n    <div class=""form-group"">\n        <label>SupplierId</label>\n        <div>\n            <span asp-validation-for=""SupplierId"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""SupplierId"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nSince span  elements are displayed inline, care must be taken to present the validation \nmessages to make it obvious which element the message relates to. You can see the \neffect of the new validation messages by restarting ASP.NET Core, requesting http://\nlocalhost:5000/controllers/form, clearing the Name  and Price  fields, and submitting \nthe form. The response, shown in figure 29.7, includes validation messages alongside \nthe text fields.\nFigure 29.7    \nDisplaying  \nproperty-level \nvalidation  \nmessages\n29.3.6  Displaying model-level messages\nIt may seem that the validation summary message is superfluous because it duplicates \nthe property-level messages. But the summary has a useful trick, which is the ability to \ndisplay messages that apply to the entire model and not just individual properties. This \nmeans you can report errors that arise from a combination of individual properties, \nwhich would otherwise be hard to express with a property-level message.\nIn listing 29.12, I have added a check to the FormController.SubmitForm  action \nthat records a validation error when the Price  value exceeds 100 at the time that the \nName  value starts with Small . \n852 chapter  29 Using model validation\nListing 29.12    Model-level validation in the FormController.cs file in the Controllers folder\n...\n[HttpPost]\npublic IActionResult SubmitForm(Product product) {\n    if (ModelState.GetValidationState(nameof(Product.Price))\n            == ModelValidationState.Valid && product.Price <= 0) {\n        ModelState.AddModelError(nameof(Product.Price),\n            ""Enter a positive price"");\n    }\n    if (ModelState.GetValidationState(nameof(Product.Name))\n            == ModelValidationState.Valid\n        && ModelState.GetValidationState(nameof(Product.Price))\n            == ModelValidationState.Valid\n        && product.Name.ToLower().StartsWith(""small"") \n        && product.Price > 100) {\n            ModelState.AddModelError("""", \n                ""Small products cannot cost more than $100"");\n    }\n    if (ModelState.GetValidationState(nameof(Product.CategoryId))\n        == ModelValidationState.Valid && \n                !context.Categories.Any(c =>\n                    c.CategoryId == product.CategoryId)) {\n        ModelState.AddModelError(nameof(Product.CategoryId),\n            ""Enter an existing category ID"");\n    }\n    if (ModelState.GetValidationState(nameof(Product.SupplierId))\n            == ModelValidationState.Valid && \n                !context.Suppliers.Any(s =>\n                    s.SupplierId == product.SupplierId)) {\n        ModelState.AddModelError(nameof(Product.SupplierId),\n            ""Enter an existing supplier ID"");\n    }\n    if (ModelState.IsValid) {\n        TempData[""name""] = product.Name;\n        TempData[""price""] = product.Price.ToString();\n        TempData[""categoryId""] = product.CategoryId.ToString();\n        TempData[""supplierId""] = product.SupplierId.ToString();\n        return RedirectToAction(nameof(Results));\n    } else {\n        return View(""Form"");\n    }\n}\n...\nIf the user enters a Name  value that starts with Small  and a Price  value that is greater \nthan 100, then a model-level validation error is recorded. I check for the combination \nof values only if there are no validation problems with the individual property values, \nwhich ensures the user doesn’t see conflicting messages. Validation errors that relate \nto the entire model are recorded using the AddModelError  with the empty string as \nthe first argument. \n 853 Validating data\nListing 29.13 changes the value of the asp-validation-summary  attribute to  \nModelOnly , which excludes property-level errors, meaning that the summary will dis-\nplay only those errors that apply to the entire model. \nListing 29.13    Configuring the validation summary in the Views/Form/Form.cshtml file \n@model Product\n@{\n    Layout = ""_SimpleLayout"";\n}\n<h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n<partial name=""_Validation"" />\n<form asp-action=""submitform"" method=""post"" id=""htmlform"">\n    <div asp-validation-summary=""ModelOnly"" class=""text-danger""></div>\n    <div class=""form-group"">\n        <label asp-for=""Name""></label>\n        <div>\n            <span asp-validation-for=""Name"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Name"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Price""></label>\n        <div>\n            <span asp-validation-for=""Price"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Price"" />\n    </div>\n    <div class=""form-group"">\n        <label>CategoryId</label>\n        <div>\n            <span asp-validation-for=""CategoryId"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""CategoryId"" />\n    </div>\n    <div class=""form-group"">\n        <label>SupplierId</label>\n        <div>\n            <span asp-validation-for=""SupplierId"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""SupplierId"" />\n    </div>\n    <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n</form>\nRestart ASP.NET Core and request http://localhost:5000/controllers/form. Enter \nSmall Kayak into the Name field and 150 into the Price field and submit the form. The \nresponse will include the model-level error message, as shown in figure 29.8.",8271
360-29.4 Explicitly validating data in a Razor Page.pdf,360-29.4 Explicitly validating data in a Razor Page,"854 chapter  29 Using model validation\nFigure 29.8    \nDisplaying a  \nmodel-level \nvalidation  \nmessage\n29.4 Explicitly validating data in a Razor Page \nRazor Page validation relies on the same features used in the controller in the previ-\nous section. Listing 29.14 adds explicit validation checks and error summaries to the  \nFormHandler  page.  \nListing 29.14    Validating data in the FormHandler.cshtml file in the Pages folder\n@page ""/pages/form/{id:long?}""\n@model FormHandlerModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n@using Microsoft.AspNetCore.Mvc.ModelBinding\n<partial name=""_Validation"" />\n<div class=""m-2"">\n    <h5 class=""bg-primary text-white text-center p-2"">HTML Form</h5>\n    <form asp-page=""FormHandler"" method=""post"" id=""htmlform"">\n        <div asp-validation-summary=""ModelOnly"" class=""text-danger""></div>\n        <div class=""form-group"">\n            <label>Name</label>\n            <div>\n                <span asp-validation-for=""Product.Name"" \n                    class=""text-danger""></span>\n            </div>\n            <input class=""form-control"" asp-for=""Product.Name"" />\n        </div>\n        <div class=""form-group"">\n            <label>Price</label>\n            <div>\n                <span asp-validation-for=""Product.Price"" \n                    class=""text-danger""></span>\n            </div>\n            <input class=""form-control"" asp-for=""Product.Price"" />\n        </div>\n        <div class=""form-group"">\n            <label>CategoryId</label>\n            <div>\n                <span asp-validation-for=""Product.CategoryId"" \n                    class=""text-danger"">\n 855 Explicitly validating data in a Razor Page \n                </span>\n            </div>\n            <input class=""form-control"" asp-for=""Product.CategoryId"" />\n        </div>\n        <div class=""form-group"">\n            <label>SupplierId</label>\n            <div>\n                <span asp-validation-for=""Product.SupplierId"" \n                    class=""text-danger"">\n                </span>\n            </div>\n            <input class=""form-control"" asp-for=""Product.SupplierId"" />\n        </div>\n        <button type=""submit"" class=""btn btn-primary mt-2"">Submit</button>\n    </form>\n</div>\n@functions {\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        [BindProperty]\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        //[BindProperty(Name = ""Product.Category"")]\n        //public Category Category { get; set; } = new();\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products\n                .OrderBy(p => p.ProductId)\n                .FirstAsync(p => p.ProductId == id);\n        }\n        public IActionResult OnPost() {\n            if (ModelState.GetValidationState(""Product.Price"")\n                    == ModelValidationState.Valid && Product.Price < 1) {\n                ModelState.AddModelError(""Product.Price"", \n                    ""Enter a positive price"");\n            }\n            if (ModelState.GetValidationState(""Product.Name"")\n                    == ModelValidationState.Valid\n                && ModelState.GetValidationState(""Product.Price"")\n                    == ModelValidationState.Valid\n                && Product.Name.ToLower().StartsWith(""small"")\n                && Product.Price > 100) {\n                ModelState.AddModelError("""",\n                    ""Small products cannot cost more than $100"");\n            }\n856 chapter  29 Using model validation\n            if (ModelState.GetValidationState(""Product.CategoryId"")\n                    == ModelValidationState.Valid &&\n                !context.Categories\n                    .Any(c => c.CategoryId == Product.CategoryId)) {\n                        ModelState.AddModelError(""Product.CategoryId"",\n                            ""Enter an existing category ID"");\n            }\n            if (ModelState.GetValidationState(""Product.SupplierId"")\n                    == ModelValidationState.Valid &&\n                !context.Suppliers\n                    .Any(s => s.SupplierId == Product.SupplierId)) {\n                        ModelState.AddModelError(""Product.SupplierId"",\n                            ""Enter an existing supplier ID"");\n            }\n            if (ModelState.IsValid) {\n                TempData[""name""] = Product.Name;\n                TempData[""price""] = Product.Price.ToString();\n                TempData[""categoryId""] = Product.CategoryId.ToString();\n                TempData[""supplierId""] = Product.SupplierId.ToString();\n                return RedirectToPage(""FormResults"");\n            } else {\n                return Page();\n            }\n        }\n    }\n}\nThe PageModel  class defines a ModelState  property that is the equivalent of the one I \nused in the controller and allows validation errors to be recorded. The process for val-\nidation is the same, but you must take care when recording errors to ensure the names \nmatch the pattern used by Razor Pages. When I recorded an error in the controller, \nI used the nameof  keyword to select the property to which the error relates, like this:\n...\nModelState.AddModelError( nameof(Product.Price) ,""Enter a positive price""); \n...\nThis is a common convention because it ensures that a typo won’t cause errors to be \nrecorded incorrectly. This expression won’t work in the Razor Page, where the error \nmust be recorded against Product.Price , rather than Price , to reflect that @Model  \nexpressions in Razor Pages return the page model object, like this:\n...\nModelState.AddModelError( ""Product.Price"" , ""Enter a positive price"");\n...\nTo test the validation process, restart ASP.NET Core, use a browser to request http://\nlocalhost:5000/pages/form, and submit the form with empty fields or with values that \ncannot be converted into the C# types required by the Product  class. The error mes-\nsages are displayed just as they are for controllers, as shown in figure 29.9. (The values \n1, 2, and 3 are valid for both the CategoryId  and SupplierId  fields.)\nTIP    The methods described in table 29.6 that change the default validation mes-\nsages affect Razor Pages as well as controllers.",6447
361-29.5 Specifying validation rules using metadata.pdf,361-29.5 Specifying validation rules using metadata,"857 Specifying validation rules using metadata\nFigure 29.9    \nValidating data in \na Razor Page\n29.5 Specifying validation rules using metadata\nOne problem with putting validation logic into an action method is that it ends up \nbeing duplicated in every action or handler method that receives data from the user. \nTo help reduce duplication, the validation process supports the use of attributes to \nexpress model validation rules directly in the model class, ensuring that the same set of \nvalidation rules will be applied regardless of which action method is used to process a \nrequest. In listing 29.15, I have applied attributes to the Product  class to describe the \nvalidation required for the Name  and Price  properties. \nListing 29.15    Applying validation attributes in the Product.cs file in the Models folder \nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace WebApp.Models {\n    public class Product {\n        public long ProductId { get; set; }\n        [Required(ErrorMessage = ""Please enter a name"")]\n        public required string Name { get; set; }\n        [Range(1, 999999, ErrorMessage = ""Please enter a positive price"")]\n        [Column(TypeName = ""decimal(8, 2)"")]\n        public decimal Price { get; set; }\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        public long SupplierId { get; set; }\n858 chapter  29 Using model validation\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nI used two validation attributes in the listing: Required  and Range . The Required  \nattribute specifies that it is a validation error if the user doesn’t submit a value for a \nproperty, which is useful when you have a nullable property but want to require a value \nfrom the user.\nI used the Required  attribute in listing 29.15 to change the error message that is \ndisplayed when the user doesn’t provide a value for the Name  property. As noted earlier, \nthe implicit validation checks are inconsistent in the way that non-nullable properties \nare processed, but this can be corrected using the ErrorMessage  argument that all of \nthe validation attributes define.\nI also applied the Range  attribute in listing 29.15, which allows me to specify the set \nof acceptable values for the Price  property. Table 29.7 shows the set of built-in valida-\ntion attributes available. \nTable 29.7    The Built-in Validation attributes\nAttribute Example Description\nCompare [Compare \n    \n(""OtherProperty"")]This attribute ensures that properties must have the \nsame value, which is useful when you ask the user \nto provide the same information twice, such as an \ne-mail address or a password.\nRange [Range(10, 20)] This attribute ensures that a numeric value (or any \nproperty type that implements IComparable ) is \nnot outside the range of specified minimum and \nmaximum values. To specify a boundary on only one \nside, use a MinValue  or MaxValue  constant.\nRegular-\nExpression[RegularExpression \n    (""pattern"")]This attribute ensures that a string value matches \nthe specified regular expression pattern. Note that \nthe pattern must match the entire  user-supplied \nvalue, not just a substring within it. By default, it \nmatches case sensitively, but you can make it case \ninsensitive by applying the (?i)  modifier—that is, \n[RegularExpression(""(?i)mypattern"")] .\nRequired [Required] This attribute ensures that the value is not empty or \na string consisting only of spaces. If you want to treat \nwhitespace as valid, use [Required(Allow -\nEmptyStrings = true)] .\nString-\nLength[StringLength(10)] This attribute ensures that a string value is no lon-\nger than a specified maximum length. You can also \nspecify a minimum length: [StringLength(10, \nMinimumLength=2)] .\nThe use of the validation attribute allows me to remove some of the explicit validation \nfrom the action method, as shown in listing 29.16.\n 859 Specifying validation rules using metadata\nListing 29.16    Removing explicit validation in the Controllers/FormController.cs file \n...\n[HttpPost]\npublic IActionResult SubmitForm(Product product) {\n    //if (ModelState.GetValidationState(nameof(Product.Price))\n    //        == ModelValidationState.Valid && product.Price <= 0) {\n    //    ModelState.AddModelError(nameof(Product.Price),\n    //        ""Enter a positive price"");\n    //}\n    if (ModelState.GetValidationState(nameof(Product.Name))\n            == ModelValidationState.Valid\n        && ModelState.GetValidationState(nameof(Product.Price))\n            == ModelValidationState.Valid\n        && product.Name.ToLower().StartsWith(""small"") \n        && product.Price > 100) {\n            ModelState.AddModelError("""", \n                ""Small products cannot cost more than $100"");\n    }\n    if (ModelState.GetValidationState(nameof(Product.CategoryId))\n        == ModelValidationState.Valid && \n                !context.Categories.Any(c =>\n                    c.CategoryId == product.CategoryId)) {\n        ModelState.AddModelError(nameof(Product.CategoryId),\n            ""Enter an existing category ID"");\n    }\n    if (ModelState.GetValidationState(nameof(Product.SupplierId))\n            == ModelValidationState.Valid && \n                !context.Suppliers.Any(s =>\n                    s.SupplierId == product.SupplierId)) {\n        ModelState.AddModelError(nameof(Product.SupplierId),\n            ""Enter an existing supplier ID"");\n    }\n    if (ModelState.IsValid) {\n        TempData[""name""] = product.Name;\n        TempData[""price""] = product.Price.ToString();\n        TempData[""categoryId""] = product.CategoryId.ToString();\n        TempData[""supplierId""] = product.SupplierId.ToString();\n        return RedirectToAction(nameof(Results));\n    } else {\n        return View(""Form"");\n    }\n}\n...\nTo see the validation attributes in action, restart ASP.NET Core MVC, request http://\nlocalhost:5000/controllers/form, clear the Name and Price fields, and submit the \nform. The response will include the validation errors produced by the attributes for \nthe Price field and the new message for the Name field, as shown in figure 29.10. The \n860 chapter  29 Using model validation\nvalidation attributes are applied before the action method is called, which means that \nI can still rely on the model state to determine whether individual properties are valid \nwhen performing model-level validation.\nValidation work arounds\nGetting the validation results you require can take some care when using the validation \nattributes. For example, you cannot use the Required  attribute if you want to ensure \nthat a user has checked a checkbox because the browser will send a false  value when \nthe checkbox is unchecked, which will always pass the checks applied by the Required  \nattribute. Instead, use the Range  attribute and specify the minimum and maximum val-\nues as true , like this:  \n...\n[Range(typeof(bool), ""true"", ""true"",  \n    ErrorMessage=""You must check the box"")]\n...\nIf this sort of workaround feels uncomfortable, then you can create custom validation \nattributes, as described in the next section. \nTo see the validation attributes in action, restart ASP.NET Core MVC, request http://\nlocalhost:5000/controllers/form, clear the Name and Price fields, and submit the \nform. The response will include the validation errors produced by the attributes, as \nshown in figure 29.10.\nFigure 29.10    \nUsing validation \nattributes\nUnderstanding web service controller validation\nControllers that have been decorated with the ApiController  attribute do not need to \ncheck the ModelState.IsValid  property. Instead, the action method is invoked only \nif there are no validation errors, which means you can always rely on receiving validated \nobjects through the model binding feature. If any validation errors are detected, then the \nrequest is terminated, and an error response is sent to the browser.",8191
362-29.5.2 Creating a custom model validation attribute.pdf,362-29.5.2 Creating a custom model validation attribute,"861 Specifying validation rules using metadata\n29.5.1  Creating a custom property validation attribute\nThe validation process can be extended by creating an attribute that extends the  \nValidationAttribute  class. To demonstrate, I created the WebApp/Validation  \nfolder and added to it a class file named PrimaryKeyAttribute.cs , which I used to \ndefine the class shown in listing 29.17.  \nListing 29.17    The contents of the PrimaryKeyAttribute.cs file in the Validation folder\nusing Microsoft.EntityFrameworkCore;\nusing System.ComponentModel.DataAnnotations;\nnamespace WebApp.Validation {\n    public class PrimaryKeyAttribute : ValidationAttribute {\n        public Type? ContextType { get; set; }\n        public Type? DataType { get; set; }\n        protected override ValidationResult? IsValid(object? value,\n                ValidationContext validationContext) {\n            if (ContextType != null && DataType != null) {\n                DbContext? context =\n                    validationContext.GetRequiredService(ContextType) \n                        as DbContext;\n                if (context != null \n                        && context.Find(DataType, value) == null) {\n                    return new ValidationResult(ErrorMessage ??\n                        ""Enter an existing key value"");\n                }\n            }\n            return ValidationResult.Success;\n        }\n    }\n}\nCustom attributes override the IsValid  method, which is called with the value to \ncheck, and a ValidationContext  object that provides context about the validation \nprocess and provides access to the application’s services through its GetService  \nmethod.\nIn listing 29.17, the custom attribute receives the type of an Entity Framework Core \ndatabase context class and the type of a model class. In the IsValid  method, the attri-\nbute obtains an instance of the context class and uses it to query the database to deter-\nmine whether the value has been used as a primary key value.\nRevalidating data \nYou may need to perform the validation process again if you modify the object received \nfrom the model binder. For these situations, use the ModelState.Clear  method to \nclear any existing validation errors and call the TryValidateModel  method.\n862 chapter  29 Using model validation\n29.5.2  Creating a custom model validation attribute \nCustom validation attributes can also be used to perform model-level validation. \nTo demonstrate, I added a class file named PhraseAndPriceAttribute.cs  to the  \nValidation  folder and used it to define the class shown in listing 29.18.\nListing 29.18    The contents of the PhraseAndPriceAttribute.cs file in the Validation folder\nusing System.ComponentModel.DataAnnotations;\nusing WebApp.Models;\nnamespace WebApp.Validation {\n    public class PhraseAndPriceAttribute : ValidationAttribute {\n        public string? Phrase { get; set; }\n        public string? Price { get; set; }\n        protected override ValidationResult? IsValid(object? value,\n                ValidationContext validationContext) {\n            if (value != null && Phrase != null && Price != null) {\n                Product? product = value as Product;\n                if (product != null\n                    && product.Name.StartsWith(Phrase,\n                        StringComparison.OrdinalIgnoreCase)\n                    && product.Price > decimal.Parse(Price)) {\n                        return new ValidationResult(ErrorMessage ?? \n                            $""{Phrase} products cannot cost more than $"" \n                            + Price);\n                }\n            }\n            return ValidationResult.Success;\n        }\n    }\n}\nThis attribute is configured with Phrase  and Price  properties, which are used in the \nIsValid  method to check the Name  and Price  properties of the model object. Proper-\nty-level custom validation attributes are applied directly to the properties they validate, \nand model-level attributes are applied to the entire class, as shown in listing 29.19.\nListing 29.19    Applying validation attributes in the Product.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing WebApp.Validation;\nnamespace WebApp.Models {\n    [PhraseAndPrice(Phrase = ""Small"", Price = ""100"")]\n    public class Product {\n 863 Specifying validation rules using metadata\n        public long ProductId { get; set; }\n        [Required(ErrorMessage = ""Please enter a name"")]\n        public required string Name { get; set; }\n        [Range(1, 999999, ErrorMessage = ""Please enter a positive price"")]\n        [Column(TypeName = ""decimal(8, 2)"")]\n        public decimal Price { get; set; }\n        [PrimaryKey(ContextType = typeof(DataContext), \n            DataType = typeof(Category))]\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        [PrimaryKey(ContextType = typeof(DataContext), \n            DataType = typeof(Supplier))]\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nThe custom attributes allow the remaining explicit validation statements to be removed \nfrom the Form  controller’s action method, as shown in listing 29.20.\nListing 29.20    Removing explicit validation in the Controllers/FormController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class FormController : Controller {\n        private DataContext context;\n        public FormController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public async Task<IActionResult> Index(long? id) {\n            return View(""Form"", await context.Products\n                .OrderBy(p => p.ProductId)\n                .FirstOrDefaultAsync(p => id == null \n                    || p.ProductId == id));\n        }\n        [HttpPost]\n        public IActionResult SubmitForm(Product product) {\n            if (ModelState.IsValid) {\n                TempData[""name""] = product.Name;\n                TempData[""price""] = product.Price.ToString();\n                TempData[""categoryId""] = product.CategoryId.ToString();\n864 chapter  29 Using model validation\n                TempData[""supplierId""] = product.SupplierId.ToString();\n                return RedirectToAction(nameof(Results));\n            } else {\n                return View(""Form"");\n            }\n        }\n        public IActionResult Results() {\n            return View(TempData);\n        }\n    }\n}\nThe validation attributes are applied automatically before the action method is \ninvoked, which means that the validation outcome can be determined simply by read-\ning the ModelState.IsValid  property. \nusing a custom  model  validation  attribute  in a razor page \nAn adaptation is required to support custom model validation attributes in Razor \nPages. When the validation attribute is applied in a Razor Page, the errors it generates \nare associated with the Product  property, rather than with the entire model, which \nmeans that the errors are not displayed by the validation summary tag helper.\nTo resolve this issue, add a class file named ModelStateExtensions.cs  to the \nWebApp/Validation  folder and use it to define the extension method shown in listing \n29.21.\nListing 29.21    The contents of the ModelStateExtensions.cs file in the Validation folder\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nnamespace WebApp.Validation {\n    public static class ModelStateExtensions {\n        public static void PromotePropertyErrors(\n                this ModelStateDictionary modelState,\n                string propertyName) {\n            foreach (var err in modelState) {\n                if (err.Key == propertyName && err.Value.ValidationState\n                        == ModelValidationState.Invalid) {\n                    foreach (var e in err.Value.Errors) {\n                        modelState.AddModelError(string.Empty, \n                            e.ErrorMessage);\n                    }\n                }\n            }\n        }\n    }\n}\nThe PromotePropertyErrors  extension method locates validation errors associated \nwith a specified property and adds corresponding model-level errors. Listing 29.22 \nremoves the explicit validation from the Razor Page and applies the new extension \nmethod.\n 865 Specifying validation rules using metadata\nListing 29.22    Removing explicit validation in the Pages/FormHandler.cshtml file \n@page ""/pages/form/{id:long?}""\n@model FormHandlerModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n@using Microsoft.AspNetCore.Mvc.ModelBinding\n@using WebApp.Validation\n<partial name=""_Validation"" />\n<div class=""m-2"">\n    <!-- ...markup omitted for brevity... -->\n</div>\n@functions {\n    public class FormHandlerModel : PageModel {\n        private DataContext context;\n        public FormHandlerModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        [BindProperty]\n        public Product Product { get; set; } \n            = new() { Name = string.Empty };\n        public async Task OnGetAsync(long id = 1) {\n            Product = await context.Products\n                .OrderBy(p => p.ProductId)\n                .FirstAsync(p => p.ProductId == id);\n        }\n        public IActionResult OnPost() {\n            if (ModelState.IsValid) {\n                TempData[""name""] = Product.Name;\n                TempData[""price""] = Product.Price.ToString();\n                TempData[""categoryId""] = Product.CategoryId.ToString();\n                TempData[""supplierId""] = Product.SupplierId.ToString();\n                return RedirectToPage(""FormResults"");\n            } else {\n                ModelState.PromotePropertyErrors(nameof(Product));\n                return Page();\n            }\n        }\n    }\n}\nExpressing the validation through the custom attributes removes the code duplication \nbetween the controller and the Razor Page and ensures that validation is applied con-\nsistently wherever model binding is used for Product  objects. To test the validation \nattributes, restart ASP.NET Core and navigate to http://localhost:5000/controllers/",10619
363-29.6 Performing client-side validation.pdf,363-29.6 Performing client-side validation,"866 chapter  29 Using model validation\nform or http://localhost:5000/pages/form. Clear the form fields or enter bad key val-\nues and submit the form, and you will see the error messages produced by the attri-\nbutes, some of which are shown in figure 29.11. (The values 1, 2, and 3 are valid for \nboth the CategoryId and SupplierId fields.)\nFigure 29.11    \nUsing custom \nvalidation \nattributes\n29.6 Performing client-side validation\nThe validation techniques I have demonstrated so far have all been examples of serv-\ner-side validation . This means the user submits their data to the server, and the server \nvalidates the data and sends back the results of the validation (either success in pro-\ncessing the data or a list of errors that need to be corrected).\nIn web applications, users typically expect immediate validation feedback—with-\nout having to submit anything to the server. This is known as client-side validation  and is \nimplemented using JavaScript. The data that the user has entered is validated before \nbeing sent to the server, providing the user with immediate feedback and an opportu-\nnity to correct any problems. \nASP.NET Core supports unobtrusive client-side validation . The term unobtrusive  means \nthat validation rules are expressed using attributes added to the HTML elements that \nviews generate. These attributes are interpreted by a JavaScript library distributed by \nMicrosoft that, in turn, configures the jQuery Validation library, which does the actual \nvalidation work. In the following sections, I will show you how the built-in validation \nsupport works and demonstrate how I can extend the functionality to provide custom \nclient-side validation. \nThe first step is to install the JavaScript packages that deal with validation. Open a \nnew PowerShell command prompt, navigate to the WebApp  project folder, and run the \ncommand shown in listing 29.23. \nTIP    The core jQuery command was added to the project in chapter 26. \nRun the following command if you need to install it again: libman install \njquery@3.6.3 -d wwwroot/lib/jquery .\n 867 Performing client-side validation\nListing 29.23    Installing the validation packages\nlibman install jquery-validate@1.19.5 -d wwwroot/lib/jquery-validate\nlibman install jquery-validation-unobtrusive@4.0.0  \n    -d wwwroot/lib/jquery-validation-unobtrusive\nOnce the packages are installed, add the elements shown in listing 29.24 to the  \n_Validation.cshtml  file in the Views/Shared  folder, which provides a convenient \nway to introduce the validation alongside the existing jQuery code in the application. \nTIP    The elements must be defined in the order in which they are shown.\nListing 29.24    Adding elements in the _Validation.cshtml file in the Views/Shared folder \n<script type=""text/javascript"">\n    window.addEventListener(""DOMContentLoaded"", () => {\n        document.querySelectorAll(""input.input-validation-error"")\n            .forEach((elem) => { elem.classList.add(""is-invalid""); }\n        );\n    });\n</script>\n<script src=""/lib/jquery/jquery.min.js""></script>\n<script src=""/lib/jquery-validate/jquery.validate.min.js""></script>\n<script src=\n  ""/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"">\n</script>\nThe ASP.NET Core form tag helpers add data-val*  attributes to input  elements that \ndescribe validation constraints for fields. Here are the attributes added to the input  \nelement for the Name  field, for example:\n...\n<input class=""form-control input-validation-error is-invalid"" type=""text"" \n  data-val=""true"" data-val-required=""Please enter a value""  id=""Name"" \n  name=""Name"" value="""">\n...\nThe unobtrusive validation JavaScript code looks for these attributes and performs val-\nidation in the browser when the user attempts to submit the form. The form won’t be \nsubmitted, and an error will be displayed if there are validation problems. The data \nwon’t be sent to the application until there are no outstanding validation issues.\nThe JavaScript code looks for elements with the data-val  attribute and performs \nlocal validation in the browser when the user submits the form, without sending an \nHTTP request to the server. You can see the effect by running the application and sub-\nmitting the form while using the F12 tools to note that validation error messages are \ndisplayed even though no HTTP request is sent to the server.\n868 chapter  29 Using model validation\nAvoiding conflicts with browser validation\nSome of the current generation of browsers support simple client-side validation based \non the attributes applied to input  elements. The general idea is that, say, an input  \nelement to which the required  attribute has been applied, for example, will cause the \nbrowser to display a validation error when the user tries to submit the form without pro-\nviding a value.\nIf you are generating form elements using tag helpers, as I have been doing in this chap-\nter, then you won’t have any problems with browser validation because the elements that \nare assigned data  attributes are ignored by the browser. \nHowever, you may run into problems if you are unable to completely control the markup \nin your application, something that often happens when you are passing on content \ngenerated elsewhere. The result is that the jQuery validation and the browser validation \ncan both operate on the form, which is just confusing to the user. To avoid this problem, \nASP.NET Core adds the novalidate  attribute to the form  element to disable browser \nvalidation.\nOne of the nice client-side validation features is that the same attributes that specify \nvalidation rules are applied at the client and at the server. This means that data from \nbrowsers that do not support JavaScript are subject to the same validation as those that \ndo, without requiring any additional effort. \nTo test the client-side validation feature, restart ASP.NET Core, request http://  \nlocalhost:5000/controllers/form or http://localhost:5000/pages/form, clear the \nName field, and click the Submit button. \nThe error message looks like the ones generated by server-side validation, but if you \nenter text into the field, you will see the error message disappear immediately as the \nJavaScript code responds to the user interaction, as shown in figure 29.12.\nFigure 29.12    Performing client-side validation",6420
364-29.7 Performing remote validation.pdf,364-29.7 Performing remote validation,"869 Performing remote validation\nExtending client-side validation \nThe client-side validation feature supports the built-in property-level attributes. The fea-\nture can be extended but requires fluency in JavaScript and requires working directly \nwith the jQuery Validation package. See https://jqueryvalidation.org/documentation  for \ndetails. \nIf you don’t want to start writing JavaScript code, then you can follow the common pattern \nof using client-side validation for the built-in validation checks and server-side validation \nfor custom validation.\n29.7 Performing remote validation\nRemote validation blurs the line between client- and server-side validation: the valida-\ntion checks are enforced by the client-side JavaScript code, but the validation checking \nis performed by sending an asynchronous HTTP request to the application to test the \nvalue entered into the form by the user.\nA common example of remote validation is to check whether a username is available \nin applications when such names must be unique, the user submits the data, and the cli-\nent-side validation is performed. As part of this process, an asynchronous HTTP request \nis made to the server to validate the username that has been requested. If the username \nhas been taken, a validation error is displayed so that the user can enter another value. \nThis may seem like regular server-side validation, but there are some benefits to this \napproach. First, only some properties will be remotely validated; the client-side valida-\ntion benefits still apply to all the other data values that the user has entered. Second, the \nrequest is relatively lightweight and is focused on validation, rather than processing an \nentire model object. \nThe third difference is that the remote validation is performed in the background. \nThe user doesn’t have to click the submit button and then wait for a new view to be ren-\ndered and returned. It makes for a more responsive user experience, especially when \nthere is a slow network between the browser and the server.\nThat said, remote validation is a compromise. It strikes a balance between client-side \nand server-side validation, but it does require requests to the application server, and it is \nnot as quick to validate as normal client-side validation.\nFor the example application, I am going to use remote validation to ensure the \nuser enters existing key values for the CategoryId  and SupplierId  properties. The \nfirst step is to create a web service controller whose action methods will perform the \nvalidation checks. I added a class file named ValidationController.cs  to the  \nControllers  folder with the code shown in listing 29.25.  \n870 chapter  29 Using model validation\nListing 29.25    The contents of the ValidationController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""api/[controller]"")]\n    public class ValidationController: ControllerBase {\n        private DataContext dataContext;\n        public ValidationController(DataContext context) {\n            dataContext = context;\n        }\n        [HttpGet(""categorykey"")]\n        public bool CategoryKey(string categoryId) {\n            long keyVal;\n            return long.TryParse(categoryId, out keyVal)\n                && dataContext.Categories.Find(keyVal) != null;\n        }\n        [HttpGet(""supplierkey"")]\n        public bool SupplierKey(string supplierId) {\n            long keyVal;\n            return long.TryParse(supplierId, out keyVal)\n                && dataContext.Suppliers.Find(keyVal) != null;\n        }\n    }\n}\nValidation action methods must define a parameter whose name matches the field they \nwill validate, which allows the model binding process to extract the value to test from \nthe request query string. The response from the action method must be JSON and can \nbe only true or false, indicating whether a value is acceptable. The action methods in \nlisting 29.25 receive candidate values and check they have been used as database keys \nfor Category  or Supplier  objects.\nTIP    I could have taken advantage of model binding so that the parameter to \nthe action methods would be converted to a long  value, but doing so would \nmean that the validation method wouldn’t be called if the user entered a value \nthat cannot be converted to the long  type. If the model binder cannot convert \na value, then the MVC Framework is unable to invoke the action method and \nvalidation can’t be performed. As a rule, the best approach to remote validation \nis to accept a string  parameter in the action method and perform any type con-\nversion, parsing, or model binding explicitly.\nTo use the remote validation method, I apply the Remote  attribute to the CategoryId  \nand SupplierId  properties in the Product  class, as shown in listing 29.26.\n 871 Performing remote validation\nListing 29.26    Using the remote attribute in the Product.cs file in the Models folder \nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing WebApp.Validation;\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Models {\n    [PhraseAndPrice(Phrase = ""Small"", Price = ""100"")]\n    public class Product {\n        public long ProductId { get; set; }\n        [Required(ErrorMessage = ""Please enter a name"")]\n        public required string Name { get; set; }\n        [Range(1, 999999, ErrorMessage = ""Please enter a positive price"")]\n        [Column(TypeName = ""decimal(8, 2)"")]\n        public decimal Price { get; set; }\n        [PrimaryKey(ContextType = typeof(DataContext), \n            DataType = typeof(Category))]\n        [Remote(""CategoryKey"", ""Validation"",\n            ErrorMessage = ""Enter an existing key"")]\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        [PrimaryKey(ContextType = typeof(DataContext), \n            DataType = typeof(Supplier))]\n        [Remote(""SupplierKey"", ""Validation"", \n            ErrorMessage = ""Enter an existing key"")]\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nThe arguments to the Remote  attribute specify the name of the validation controller \nand its action method. I have also used the optional ErrorMessage  argument to spec-\nify the error message that will be displayed when validation fails. To see the remote \nvalidation, restart ASP.NET Core, navigate to http://localhost:5000/controllers/form, \nenter an invalid key value, and submit the form. You will see an error message, and the \nvalue of the input  element will be validated after each key press, as shown in figure \n29.13. (Only the values 1, 2, and 3 are valid for both the CategoryId  and SupplierId  \nfields.)",7038
365-29.7.1 Performing remote validation in Razor Pages.pdf,365-29.7.1 Performing remote validation in Razor Pages,"872 chapter  29 Using model validation\nFigure 29.13    Performing remote validation \nCAUTION     The validation action method will be called when the user first sub-\nmits the form and again each time the data is edited. For text input elements, \nevery keystroke will lead to a call to the server. For some applications, this can be \na significant number of requests and must be accounted for when specifying the \nserver capacity and bandwidth that an application requires in production. Also, \nyou might choose not to use remote validation for properties that are expensive \nto validate (the example repeatedly queries the database for key values, which \nmay not be sensible for all applications or databases).\n29.7.1  Performing remote validation in Razor Pages \nRemote validation works in Razor Pages, but attention must be paid to the names used \nin the asynchronous HTTP request used to validate values. For the controller example \nin the previous section, the browser will send requests to URLs like this:\nhttp://localhost:5000/api/Validation/categorykey? CategoryId =1\nBut for the example Razor Page, the URL will be like this, reflecting the use of the \npage model:\nhttp://localhost:5000/api/Validation/categorykey? Product.CategoryId =1\nThe way I prefer to address this difference is by adding parameters to the validation \naction methods that will accept both types of request, which is easy to do using the \nmodel binding features described in previous chapters, as shown in listing 29.27.\nListing 29.27    Adding parameters in the ValidationController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [ApiController]\n    [Route(""api/[controller]"")]\n    public class ValidationController : ControllerBase {\n 873 Performing remote validation\n        private DataContext dataContext;\n        public ValidationController(DataContext context) {\n            dataContext = context;\n        }\n        [HttpGet(""categorykey"")]\n        public bool CategoryKey(string? categoryId, \n                [FromQuery] KeyTarget target) {\n            long keyVal;\n            return long.TryParse(categoryId ?? target.CategoryId, \n                    out keyVal)\n                && dataContext.Categories.Find(keyVal) != null;\n        }\n        [HttpGet(""supplierkey"")]\n        public bool SupplierKey(string? supplierId, \n                [FromQuery] KeyTarget target) {\n            long keyVal;\n            return long.TryParse(supplierId ?? target.SupplierId, \n                    out keyVal)\n                && dataContext.Suppliers.Find(keyVal) != null;\n        }\n    }\n    [Bind(Prefix = ""Product"")]\n    public class KeyTarget {\n        public string? CategoryId { get; set; }\n        public string? SupplierId { get; set; }\n    }\n}\nThe KeyTarget  class is configured to bind to the Product  part of the request, with \nproperties that will match the two types of remote validation request. Each action \nmethod has been given a KeyTarget  parameter, which is used if no value is received \nfor existing parameters. This allows the same action method to accommodate both \ntypes of request, which you can see by restarting ASP.NET Core, navigating to http://\nlocalhost:5000/pages/form, entering a nonexistent key value, and clicking the Submit \nbutton, which will produce the response shown in figure 29.14.\nFigure 29.14    \nPerforming remote \nvalidation using a \nRazor Page\n874 chapter  29 Using model validation\nSummary\n¡ ASP.NET Core provides integrated support for validating data to ensure it can be \nused by the application.\n¡ Validation messages can be displayed for the entire model or individual fields.\n¡ Basic validation is performed automatically and can be complemented by explicit \ncustom validation.\n¡ Validation rules can be specified using attributes applied to model classes.\n¡ Validation is usually performed when data is sent to the server, but there is sup-\nport for client-side validation using a JavaScript library.\n¡ Validation can also be performed by using JavaScript code to send individual \ndata values to an ASP.NET Core controller for inspection.",4221
366-30.1 Preparing for this chapter.pdf,366-30.1 Preparing for this chapter,"87530Using filters\nThis chapter covers\n¡ Injecting logic into request pipelines\n¡ Understanding the different filter types and  \n when each is executed\n¡ Creating and applying filters\n¡ Managing the filter lifecycle and execution   \n order\nFilters  inject extra logic into request processing. Filters are like middleware that is \napplied to a single endpoint, which can be an action or a page handler method, and \nthey provide an elegant way to manage a specific set of requests. In this chapter, I \nexplain how filters work, describe the different types of filters that ASP.NET Core \nsupports, and demonstrate the use of custom filters and the filters provided by ASP \n.NET Core. Table 30.1 provides a guide to the chapter.\n876 chapter  30 Using filters\nTable 30.1    Chapter guide\nProblem Solution Listing\nImplementing a security policy Use an authorization filter. 16, 17\nImplementing a resource policy, \nsuch as cachingUse a resource filter. 18–20\nAltering the request or response \nfor an action method Use an action filter. 21–24\nAltering the request or response \nfor a page handler methodUse a page filter. 25–27\nInspecting or altering the result \nproduced by an endpointUse a result filter. 28–30\nInspecting or altering uncaught \nexceptionsUse an exception filter. 31, 32\nAltering the filter lifecycle Use a filter factory or define a \nservice.33–36\nApplying filters throughout an \napplicationUse a global filter. 37, 38\nChanging the order in which  \nfilters are appliedImplement the IOrdered -\nFilter  interface.39–43\n30.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 29. To prepare for this chapter, \nopen a new PowerShell command prompt, navigate to the WebApp  project folder, and \nrun the command shown in listing 30.1 to remove the files that are no longer required. \nListing 30.1    Removing files from the project\nRemove-Item -Path Controllers,Views,Pages -Recurse -Exclude _*,Shared\nThis command removes the controllers, views, and Razor Pages, leaving behind the \nshared layouts, data model, and configuration files.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nCreate the WebApp/Controllers  folder and add a class file named HomeController \n.cs to the Controllers  folder with the code shown in listing 30.2.\nListing 30.2    The contents of the HomeController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n 877 Preparing for this chapter\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n    }\n}\nThe action method renders a view called Message  and passes a string as the view data. \nI added a Razor view named Message.cshtml  to the Views/Shared  folder with the \ncontent shown in listing 30.3.\nListing 30.3    The contents of the Message.cshtml file in the Views/Shared folder\n@{ Layout = ""_SimpleLayout""; }\n@if (Model is string) {\n    @Model\n} else if (Model is IDictionary<string, string>) {\n    var dict = Model as IDictionary<string, string>;\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>Name</th><th>Value</th></tr></thead>\n        <tbody>\n            @foreach (var kvp in dict ??  \n                   new Dictionary<string, string>()) {\n                <tr><td>@kvp.Key</td><td>@kvp.Value</td></tr>\n            }\n        </tbody>\n    </table>\n}\nAdd a Razor Page named Message.cshtml  to the Pages  folder and add the content \nshown in listing 30.4. \nListing 30.4    The contents of the Message.cshtml file in the Pages folder\n@page ""/pages/message""\n@model MessageModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@if (Model.Message is string) {\n    @Model.Message\n} else if (Model.Message is IDictionary<string, string>) {\n    var dict = Model.Message as IDictionary<string, string>;\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>Name</th><th>Value</th></tr></thead>\n        <tbody>\n            @if (dict != null) {\n                foreach (var kvp in dict) {\n                    <tr><td>@kvp.Key</td><td>@kvp.Value</td></tr>\n                }\n            }\n        </tbody>\n    </table>\n}",4529
367-30.1.3 Running the example application.pdf,367-30.1.3 Running the example application,"878 chapter  30 Using filters\n@functions {\n    public class MessageModel : PageModel {\n        public object Message { get; set; } \n            = ""This is the Message Razor Page"";\n    }\n}\n30.1.1  Enabling HTTPS Connections\nSome of the examples in this chapter require the use of SSL. Add the configuration \nentries shown in listing 30.5 to the launchSettings.json  file in the Properties  \nfolder to enable SSL and set the port to 44350.\nListing 30.5    Enabling HTTPS in the launchSettings.json file in the Properties folder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""WebApp"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": false,\n      ""applicationUrl"": ""http://localhost:5000;https://localhost:44350"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\nThe .NET Core runtime includes a test certificate that is used for HTTPS requests. Run \nthe commands shown in listing 30.6 in the WebApp  folder to regenerate and trust the \ntest certificate.  \nListing 30.6    Regenerating the development certificates \ndotnet dev-certs https --clean \n \ndotnet dev-certs https --trust\n 879 Preparing for this chapter\nClick Yes to the prompts to delete the existing certificate that has already been trusted \nand click Yes to trust the new certificate, as shown in figure 30.1.\nFigure 30.1    Regenerating the HTTPS certificate\nListing 30.7 replaces the contents of the Program.cs  file to use the default controller \nroutes and remove some of the services and components used in earlier chapters.\nListing 30.7    Configuring the platform in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\n30.1.2  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 30.8 to drop the database.",2905
368-30.2 Using filters.pdf,368-30.2 Using filters,"880 chapter  30 Using filters\nListing 30.8    Dropping the database\ndotnet ef database drop --force\n30.1.3  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 30.9. \nListing 30.9    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000 and https://localhost:44350. Both \nURLs will be handled by the Index  action defined by the Home  controller, producing \nthe responses shown in figure 30.2.\nFigure 30.2    Responses from the Home controller\nRequest http://localhost:5000/pages/message and https://localhost:44350/pages/\nmessage to see the response from the Message  Razor Page, delivered over HTTP and \nHTTPS, as shown in figure 30.3.\nFigure 30.3    Responses from the Message Razor Page\n30.2 Using filters\nFilters allow logic that would otherwise be applied in a middleware component or \naction method to be defined in a class where it can be easily reused.  \nImagine that you want to enforce HTTPS requests for some action methods. In chap-\nter 16, I showed you how this can be done in middleware by reading the IsHttps  prop-\nerty of the HttpRequest  object. The problem with this approach is that the middleware \nwould have to understand the configuration of the routing system to know how to inter-\ncept requests for specific action methods. A more focused approach would be to read \nthe HttpRequest.IsHttps  property within action methods, as shown in listing 30.10.\n 881 Using filters\nListing 30.10    Selective HTTPS in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            if (Request.IsHttps) {\n                return View(""Message"",\n                    ""This is the Index action on the Home controller"");\n            } else {\n                return new StatusCodeResult(\n                    StatusCodes.Status403Forbidden);\n            }\n        }\n    }\n}\nRestart ASP.NET Core and request http://localhost:5000. This method now requires \nHTTPS, and you will see an error response. Request https://localhost:44350, and you \nwill see the message output. Figure 30.4 shows both responses.\nTIP    Clear your browser’s history if you don’t get the results you expect from the \nexamples in this section. Browsers will often refuse to send requests to servers \nthat have previously generated HTTPS errors, which is a good security practice \nbut can be frustrating during development.\nFigure 30.4    Enforcing HTTPS in an action method\nThis approach works but has problems. The first problem is that the action method \ncontains code that is more about implementing a security policy than about handling \nthe request. A more serious problem is that including the HTTP-detecting code within \nthe action method doesn’t scale well and must be duplicated in every action method in \nthe controller, as shown in listing 30.11. \n882 chapter  30 Using filters\nListing 30.11    Adding actions in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            if (Request.IsHttps) {\n                return View(""Message"",\n                    ""This is the Index action on the Home controller"");\n            } else {\n                return new StatusCodeResult(\n                    StatusCodes.Status403Forbidden);\n            }\n        }\n        public IActionResult Secure() {\n            if (Request.IsHttps) {\n                return View(""Message"",\n                    ""This is the Secure action on the Home controller"");\n            } else {\n                return new StatusCodeResult(\n                    StatusCodes.Status403Forbidden);\n            }\n        }\n    }\n}\nI must remember to implement the same check in every action method in every con-\ntroller for which I want to require HTTPS. The code to implement the security policy \nis a substantial part of the—admittedly simple—controller, which makes the controller \nharder to understand, and it is only a matter of time before I forget to add it to a new \naction method, creating a hole in my security policy. \nThis is the type of problem that filters address. Listing 30.12 replaces my checks for \nHTTPS and implements a filter instead. \nListing 30.12    Applying a filter in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n    public class HomeController : Controller {\n        [RequireHttps]\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n        [RequireHttps]\n        public IActionResult Secure() {\n 883 Using filters\n            return View(""Message"",\n                ""This is the Secure action on the Home controller"");\n        }\n    }\n}\nThe RequireHttps  attribute applies one of the built-in filters provided by ASP.NET \nCore. This filter restricts access to action methods so that only HTTPS requests are \nsupported and allows me to remove the security code from each method and focus on \nhandling the successful requests.\nNOTE     The RequireHttps  filter doesn’t work the same way as my custom code. \nFor GET requests, the RequireHttps  attribute redirects the client to the originally \nrequested URL, but it does so by using the https  scheme so that a request to \nhttp://localhost:5000 will be redirected to https://localhost:5000. This makes \nsense for most deployed applications but not during development because \nHTTP and HTTPS are on different local ports. The RequireHttpsAttribute  \nclass defines a protected method called HandleNonHttpsRequest  that you \ncan override to change the behavior. Alternatively, I re-create the original \nfunctionality from scratch in the “Understanding Authorization Filters” section.\nI must still remember to apply the RequireHttps  attribute to each action method, \nwhich means that I might forget. But filters have a useful trick: applying the attribute to \na controller class has the same effect as applying it to each individual action method, as \nshown in listing 30.13.\nListing 30.13    Filtering all actions in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Controllers {\n    [RequireHttps]\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n        public IActionResult Secure() {\n            return View(""Message"",\n                ""This is the Secure action on the Home controller"");\n        }\n    }\n}\nFilters can be applied with differing levels of granularity. If you want to restrict access \nto some actions but not others, then you can apply the RequireHttps  attribute to just \nthose methods. If you want to protect all the action methods, including any that you \nadd to the controller in the future, then the RequireHttps  attribute can be applied to \n884 chapter  30 Using filters\nthe class. If you want to apply a filter to every action in an application, then you can use \nglobal filters , which I describe later in this chapter.\nFilters can also be used in Razor Pages. To implement the HTTPS-only policy in the \nMessage  Razor Pages, for example, I would have to add a handler method that inspects \nthe connection, as shown in listing 30.14.\nListing 30.14    Checking connections in the Message.cshtml file in the Pages folder\n@page ""/pages/message""\n@model MessageModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@if (Model.Message is string) {\n    @Model.Message\n} else if (Model.Message is IDictionary<string, string>) {\n    var dict = Model.Message as IDictionary<string, string>;\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>Name</th><th>Value</th></tr></thead>\n        <tbody>\n            @if (dict != null) {\n                foreach (var kvp in dict) {\n                    <tr><td>@kvp.Key</td><td>@kvp.Value</td></tr>\n                }\n            }\n        </tbody>\n    </table>\n}\n@functions {\n    public class MessageModel : PageModel {\n        public object Message { get; set; } \n            = ""This is the Message Razor Page"";\n        public IActionResult OnGet() {\n            if (!Request.IsHttps) {\n                return new StatusCodeResult(\n                    StatusCodes.Status403Forbidden);\n            } else {\n                return Page();\n            }\n        }\n    }\n}\nThe handler method works, but it is awkward and presents the same problems encoun-\ntered with action methods. When using filters in Razor Pages, the attribute can be \napplied to the handler method or, as shown in listing 30.15, to the entire class.\nListing 30.15    Applying a filter in the Message.cshtml file in the Pages folder \n...\n@functions {\n    [RequireHttps]",9194
369-30.3 Understanding filters.pdf,369-30.3 Understanding filters,"885 Understanding filters\n    public class MessageModel : PageModel {\n        public object Message { get; set; } \n            = ""This is the Message Razor Page"";\n        //public IActionResult OnGet() {\n        //    if (!Request.IsHttps) {\n        //        return new StatusCodeResult(\n        //            StatusCodes.Status403Forbidden);\n        //    } else {\n        //        return Page();\n        //    }\n        //}\n    }\n}\n...\nYou will see a normal response if you request https://localhost:44350/pages/  message. \nIf you request the regular HTTP URL, http://localhost:5000/pages/messages, \nthe filter will redirect the request, and you will see an error (as noted earlier, the \nRequireHttps  filter redirects the browser to a port that is not enabled in the example \napplication).\n30.3 Understanding filters\nASP.NET Core supports different types of filters, each of which is intended for a differ-\nent purpose. Table 30.2 describes the filter categories.  \nTable 30.2    The filter types\nName Description\nAuthorization filters This type of filter is used to apply the application’s \nauthorization policy. \nResource filters This type of filter is used to intercept requests, typi -\ncally to implement features such as caching.\nAction filters This type of filter is used to modify the request before \nit is received by an action method or to modify the \naction result after it has been produced. This type of \nfilter can be applied only to controllers and actions.\nPage filters This type of filter is used to modify the request before \nit is received by a Razor Page handler method or to \nmodify the action result after it has been produced. \nThis type of filter can be applied only to Razor Pages.\nResult filters This type of filter is used to alter the action result \nbefore it is executed or to modify the result after \nexecution.\nException filters This type of filter is used to handle exceptions that \noccur during the execution of the action method or \npage handler. \n886 chapter  30 Using filters\nFilters have their own pipeline and are executed in a specific order, as shown in figure \n30.5. \nFigure 30.5    The filter pipeline\nFilters can short-circuit the filter pipeline to prevent a request from being forwarded \nto the next filter. For example, an authorization filter can short-circuit the pipeline \nand return an error response if the user is unauthenticated. The resource, action, and \npage filters are able to inspect the request before and after it has been handled by the \nendpoint, allowing these types of filter to short-circuit the pipeline; to alter the request \nbefore it is handled; or to alter the response. (I have simplified the flow of filters in fig-\nure 30.5. Page filters run before and after the model binding process, as described in \nthe “Understanding Page Filters” section.)\nEach type of filter is implemented using interfaces defined by ASP.NET Core, which \nalso provides base classes that make it easy to apply some types of filters as attributes. I \ndescribe each interface and the attribute classes in the sections that follow, but they are \nshown in table 30.3 for quick reference.  \nTable 30.3    The filter types, interfaces, and attribute base classes\nFilter Type Interfaces Attribute Class\nAuthorization \nfiltersIAuthorizationFilter \nIAsyncAuthorizationFilterNo attribute class is provided.\nResource \nfiltersIResourceFilter  \nIAsyncResourceFilterNo attribute class is provided.\nAction filters IActionFilter \nIAsyncActionFilterActionFilterAttribute\nPage filters IPageFilter \nIAsyncPageFilterNo attribute class is provided.\nResult filters IResultFilter \nIAsyncResultFilter \nIAlwaysRunResultFilter \nIAsyncAlwaysRunResultFilterResultFilterAttribute\nException \nFiltersIExceptionFilter \nIAsyncExceptionFilterExceptionFilterAttribute",3861
370-30.4 Creating custom filters.pdf,370-30.4 Creating custom filters,,0
371-30.4.1 Understanding authorization filters.pdf,371-30.4.1 Understanding authorization filters,"887 Creating custom filters\n30.4 Creating custom filters\nFilters implement the IFilterMetadata  interface, which is in the Microsoft.Asp -\nNetCore.Mvc.Filters  namespace. Here is the interface:\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IFilterMetadata { }\n}\nThe interface is empty and doesn’t require a filter to implement any specific behaviors. \nThis is because each of the categories of filter described in the previous section works in a \ndifferent way. Filters are provided with context data in the form of a Filter Context  object. \nFor convenience, Table 30.4 describes the properties that FilterContext  provides.  \nTable 30.4    The FilterContext properties\nName Description\nActionDescriptor This property returns an ActionDescriptor  \nobject, which describes the action method.\nHttpContext This property returns an HttpContext  object, \nwhich provides details of the HTTP request and the \nHTTP response that will be sent in return.\nModelState This property returns a ModelStateDictionary  \nobject, which is used to validate data sent by the \nclient.\nRouteData This property returns a RouteData  object that \ndescribes the way that the routing system has pro-\ncessed the request.\nFilters This property returns a list of filters that have been \napplied to the action method, expressed as an \nIList<IFilterMetadata> .\n30.4.1  Understanding authorization filters\nAuthorization filters are used to implement an application’s security policy. Authoriza-\ntion filters are executed before other types of filter and before the endpoint handles \nthe request. Here is the definition of the IAuthorizationFilter  interface:  \nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IAuthorizationFilter : IFilterMetadata {\n        void OnAuthorization(AuthorizationFilterContext context);\n    }\n}\nThe OnAuthorization  method is called to provide the filter with the opportunity to \nauthorize the request. For asynchronous authorization filters, here is the definition of \nthe IAsyncAuthorizationFilter  interface:\n888 chapter  30 Using filters\nusing System.Threading.Tasks;\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IAsyncAuthorizationFilter : IFilterMetadata {\n        Task OnAuthorizationAsync(AuthorizationFilterContext context);\n    }\n}\nThe OnAuthorizationAsync  method is called so that the filter can authorize the \nrequest. Whichever interface is used, the filter receives context data describing the \nrequest through an AuthorizationFilterContext  object, which is derived from the \nFilterContext  class and adds one important property, as described in table 30.5.\nTable 30.5    The AuthorizationFilterContext property\nName Description\nResult This IActionResult  property is set by authorization fil -\nters when the request doesn’t comply with the application’s \nauthorization policy. If this property is set, then ASP.NET \nCore executes the IActionResult  instead of invoking \nthe endpoint.\nTo demonstrate how authorization filters work, I created a Filters  folder in the \nWebApp  folder, added a class file called HttpsOnlyAttribute.cs , and used it to define \nthe filter shown in listing 30.16.\nListing 30.16    The contents of the HttpsOnlyAttribute.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Filters {\n    public class HttpsOnlyAttribute : Attribute, IAuthorizationFilter {\n        public void OnAuthorization(AuthorizationFilterContext context) {\n            if (!context.HttpContext.Request.IsHttps) {\n                context.Result = \n                    new StatusCodeResult(StatusCodes.Status403Forbidden);\n            }\n        }\n    }\n}\nAn authorization filter does nothing if a request complies with the authorization pol-\nicy, and inaction allows ASP.NET Core to move on to the next filter and, eventually, \nto execute the endpoint. If there is a problem, the filter sets the Result  property of \nthe AuthorizationFilterContext  object that is passed to the OnAuthorization  \nmethod. This prevents further execution from happening and provides a result to \nreturn to the client. In the listing, the HttpsOnlyAttribute  class inspects the IsHttps  \n 889 Creating custom filters\nproperty of the HttpRequest  context object and sets the Result  property to interrupt \nexecution if the request has been made without HTTPS. Authorization filters can be \napplied to controllers, action methods, and Razor Pages. Listing 30.17 applies the new \nfilter to the Home  controller.\nListing 30.17    Applying a filter in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nnamespace WebApp.Controllers {\n    //[RequireHttps]\n    [HttpsOnly]\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n        public IActionResult Secure() {\n            return View(""Message"",\n                ""This is the Secure action on the Home controller"");\n        }\n    }\n}\nThis filter re-creates the functionality that I included in the action methods in list-\ning 30.11. This is less useful in real projects than doing a redirection like the built-in \nRequireHttps  filter because users won’t understand the meaning of a 403 status code, \nbut it does provide a useful example of how authorization filters work. Restart ASP.\nNET Core and request http://localhost:5000, and you will see the effect of the filter, \nas shown in figure 30.6. Request https://localhost:44350, and you will receive the \nresponse from the action method, also shown in the figure.\nFigure 30.6    Applying a custom authorization filter",5842
372-30.4.2 Understanding resource filters.pdf,372-30.4.2 Understanding resource filters,"890 chapter  30 Using filters\n30.4.2  Understanding resource filters\nResource filters are executed twice for each request: before the ASP.NET Core model \nbinding process and again before the action result is processed to generate the result. \nHere is the definition of the IResourceFilter  interface:  \nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IResourceFilter : IFilterMetadata {\n        void OnResourceExecuting(ResourceExecutingContext context);\n        void OnResourceExecuted(ResourceExecutedContext context);\n    }\n}\nThe OnResourceExecuting  method is called when a request is being processed, and \nthe OnResourceExecuted  method is called after the endpoint has handled the request \nbut before the action result is executed. For asynchronous resource filters, here is the \ndefinition of the IAsyncResourceFilter  interface:\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IAsyncResourceFilter : IFilterMetadata {\n        Task OnResourceExecutionAsync(ResourceExecutingContext context,\n            ResourceExecutionDelegate next);\n    }\n}\nThis interface defines a single method that receives a context object and a delegate to \ninvoke. The resource filter is able to inspect the request before invoking the delegate \nand inspect the response before it is executed. The OnResourceExecuting  method \nis provided with context using the ResourceExecutingContext  class, which defines \nthe properties shown in table 30.6 in addition to those defined by the FilterContext  \nclass.  \nTable 30.6    The properties defined by the ResourceExecutingContext class\nName Description\nResult This IActionResult  property is used to provide a result to \nshort-circuit the pipeline. \nValueProviderFactories This property returns an IList<IValueProviderFactory> , \nwhich provides access to the objects that provide values for the \nmodel binding process.\nThe OnResourceExecuted  method is provided with context using the Resource -\nExecutedContext  class, which defines the properties shown in table 30.7, in addition \nto those defined by the FilterContext  class.\n 891 Creating custom filters\nTable 30.7    The properties defined by the ResourceExecutedContext class\nName Description\nResult This IActionResult  property provides the action \nresult that will be used to produce a response. \nCanceled This bool  property is set to true  if another filter has \nshort-circuited the pipeline by assigning an action \nresult to the Result  property of the Action-\nExecutingContext  object. \nException This property is used to store an exception thrown \nduring execution.\nExceptionDispatchInfo This method returns an ExceptionDispatchInfo  \nobject that contains the stack trace details of any \nexception thrown during execution.\nExceptionHandled Setting this property to true  indicates that the filter \nhas handled the exception, which will not be propa-\ngated any further.\ncreating  a resource  filter\nResource filters are usually used where it is possible to short-circuit the pipeline and \nprovide a response early, such as when implementing data caching. To create a simple \ncaching filter, add a class file called SimpleCacheAttribute.cs  to the Filters  folder \nwith the code shown in listing 30.18.\nFilters and dependency injection \nFilters that are applied as attributes cannot declare dependencies in their constructors \nunless they implement the IFilterFactory  interface and take responsibility for creat-\ning instances directly, as explained in the ""Creating Filter Factories"" section later in this \nchapter.  \nListing 30.18    The contents of the SimpleCacheAttribute.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Filters {\n    public class SimpleCacheAttribute : Attribute, IResourceFilter {\n        private Dictionary<PathString, IActionResult> CachedResponses\n            = new Dictionary<PathString, IActionResult>();\n        public void OnResourceExecuting(\n                ResourceExecutingContext context) {\n            PathString path = context.HttpContext.Request.Path;\n            if (CachedResponses.ContainsKey(path)) {\n                context.Result = CachedResponses[path];\n892 chapter  30 Using filters\n                CachedResponses.Remove(path);\n            }\n        }\n        public void OnResourceExecuted(ResourceExecutedContext context) {\n            if (context.Result != null) {\n                CachedResponses.Add(context.HttpContext.Request.Path, \n                    context.Result);\n            }\n        }\n    }\n}\nThis filter isn’t an especially useful cache, but it does show how a resource filter \nworks. The OnResourceExecuting  method provides the filter with the opportunity \nto short-circuit the pipeline by setting the context object’s Result  property to a previ-\nously cached action result. If a value is assigned to the Result  property, then the filter \npipeline is short-circuited, and the action result is executed to produce the response \nfor the client. Cached action results are used only once and then discarded from the \ncache. If no value is assigned to the Result  property, then the request passes to the \nnext step in the pipeline, which may be another filter or the endpoint.\nThe OnResourceExecuted  method provides the filter with the action results that \nare produced when the pipeline is not short-circuited. In this case, the filter caches \nthe action result so that it can be used for subsequent requests. Resource filters can \nbe applied to controllers, action methods, and Razor Pages. Listing 30.19 applies the \ncustom resource filter to the Message  Razor Page and adds a timestamp that will help \ndetermine when an action result is cached.\nListing 30.19    Applying a resource filter in the Message.cshtml file in the Pages folder\n@page ""/pages/message""\n@model MessageModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Filters\n@if (Model.Message is string) {\n    @Model.Message\n} else if (Model.Message is IDictionary<string, string>) {\n    var dict = Model.Message as IDictionary<string, string>;\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>Name</th><th>Value</th></tr></thead>\n        <tbody>\n            @if (dict != null) {\n                foreach (var kvp in dict) {\n                    <tr><td>@kvp.Key</td><td>@kvp.Value</td></tr>\n                }\n            }\n        </tbody>\n    </table>\n}\n 893 Creating custom filters\n@functions {\n    [RequireHttps]\n    [SimpleCache]\n    public class MessageModel : PageModel {\n        public object Message { get; set; } =\n            DateTime.Now.ToLongTimeString() \n                + "" This is the Message Razor Page"";\n    }\n}\nTo see the effect of the resource filter, restart ASP.NET Core and request https://  \nlocalhost:44350/pages/message. Since this is the first request for the path, there will \nbe no cached result, and the request will be forwarded along the pipeline. As the \nresponse is processed, the resource filter will cache the action result for future use. \nReload the browser to repeat the request, and you will see the same timestamp, indi-\ncating that the cached action result has been used. The cached item is removed when \nit is used, which means that reloading the browser will generate a response with a fresh \ntimestamp, as shown in figure 30.7.\nFigure 30.7    Using a resource filter\ncreating  an asynchronous  resource  filter  \nThe interface for asynchronous resource filters uses a single method that receives \na delegate used to forward the request along the filter pipeline. Listing 30.20 reim-\nplements the caching filter from the previous example so that it implements the  \nIAsyncResourceFilter  interface.\nListing 30.20    An asynchronous filter in the Filters/SimpleCacheAttribute.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Filters {\n    public class SimpleCacheAttribute : Attribute, IAsyncResourceFilter {\n        private Dictionary<PathString, IActionResult> CachedResponses\n            = new Dictionary<PathString, IActionResult>();\n        public async Task OnResourceExecutionAsync(\n                ResourceExecutingContext context,\n                ResourceExecutionDelegate next) {\n            PathString path = context.HttpContext.Request.Path;",8474
373-30.4.3 Understanding action filters.pdf,373-30.4.3 Understanding action filters,"894 chapter  30 Using filters\n            if (CachedResponses.ContainsKey(path)) {\n                context.Result = CachedResponses[path];\n                CachedResponses.Remove(path);\n            } else {\n                ResourceExecutedContext execContext = await next();\n                if (execContext.Result != null) {\n                    CachedResponses.Add(context.HttpContext.Request.Path,\n                        execContext.Result);\n                }\n            }\n        }\n    }\n}\nThe OnResourceExecutionAsync  method receives a ResourceExecutingContext  \nobject, which is used to determine whether the pipeline can be short-circuited. If it \ncannot, the delegate is invoked without arguments and asynchronously produces a \nResourceExecutedContext  object when the request has been handled and is mak-\ning its way back along the pipeline. Restart ASP.NET Core and repeat the requests \ndescribed in the previous section, and you will see the same caching behavior, as shown \nin figure 30.7.\nCAUTION    It is important not to confuse the two context objects. The action \nresult produced by the endpoint is available only in the context object that is \nreturned by the delegate.\n30.4.3  Understanding action filters\nLike resource filters, action filters are executed twice. The difference is that action \nfilters are executed after the model binding process, whereas resource filters are exe-\ncuted before model binding. This means that resource filters can short-circuit the \npipeline and minimize the work that ASP.NET Core does on the request. Action filters \nare used when model binding is required, which means they are used for tasks such as \naltering the model or enforcing validation. Action filters can be applied only to con-\ntrollers and action methods, unlike resource filters, which can also be used with Razor \nPages. (The Razor Pages equivalent to action filters is the page filter, described in the \n""Understanding Page Filters"" section.) Here is the IActionFilter  interface:  \nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IActionFilter : IFilterMetadata {\n        void OnActionExecuting(ActionExecutingContext context);\n        void OnActionExecuted(ActionExecutedContext context);\n    }\n}\nWhen an action filter has been applied to an action method, the OnActionExecuting  \nmethod is called just before the action method is invoked, and the  \nOnActionExecuted  method is called just after. Action filters are provided with \n 895 Creating custom filters\ncontext data through two different context classes: ActionExecutingContext  \nfor the OnActionExecuting  method and ActionExecutedContext  for the \nOnActionExecuted  method. \nThe ActionExecutingContext  class, which is used to describe an action that is \nabout to be invoked, defines the properties described in table 30.8, in addition to the \nFilterContext  properties.  \nTable 30.8    The ActionExecutingContext properties\nName Description\nController This property returns the controller whose action method \nis about to be invoked. (Details of the action method are \navailable through the ActionDescriptor  property \ninherited from the base classes.) \nActionArguments This property returns a dictionary of the arguments that \nwill be passed to the action method, indexed by name. The \nfilter can insert, remove, or change the arguments.\nResult If the filter assigns an IActionResult  to this property, \nthen the pipeline will be short-circuited, and the action \nresult will be used to generate the response to the client \nwithout invoking the action method. \nThe ActionExecutedContext  class is used to represent an action that has been exe-\ncuted and defines the properties described in table 30.9, in addition to the Filter-\nContext  properties.\nTable 30.9    The ActionExecutedContext properties\nName Description\nController This property returns the Controller  object whose action \nmethod will be invoked.\nCanceled This bool  property is set to true  if another action filter has \nshort-circuited the pipeline by assigning an action result to \nthe Result  property of the ActionExecutingContext  \nobject. \nException This property contains any Exception  that was thrown by the \naction method.\nExceptionDispatchInfo This method returns an ExceptionDispatchInfo  object \nthat contains the stack trace details of any exception thrown by \nthe action method.\nExceptionHandled Setting this property to true  indicates that the filter has han -\ndled the exception, which will not be propagated any further.\nResult This property returns the IActionResult  produced by the \naction method. The filter can change or replace the action \nresult if required. \nAsynchronous action filters are implemented using the IAsyncActionFilter  \ninterface.\n896 chapter  30 Using filters\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IAsyncActionFilter : IFilterMetadata {\n        Task OnActionExecutionAsync(ActionExecutingContext context, \n            ActionExecutionDelegate next);\n    }\n}\nThis interface follows the same pattern as the IAsyncResourceFilter  interface \ndescribed earlier in the chapter. The OnActionExecutionAsync  method \nis provided with an ActionExecutingContext  object and a delegate. The \nActionExecutingContext  object describes the request before it is received by the \naction method. The filter can short-circuit the pipeline by assigning a value to the \nActionExecuting  Context.Result  property or pass it along by invoking the delegate. \nThe delegate asynchronously produces an ActionExecutedContext  object that \ndescribes the result from the action method.\ncreating  an action  filter  \nAdd a class file called ChangeArgAttribute.cs  to the Filters  folder and use it to \ndefine the action filter shown in listing 30.21.\nListing 30.21    The contents of the ChangeArgAttribute.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Filters {\n    public class ChangeArgAttribute : Attribute, IAsyncActionFilter {\n        public async Task OnActionExecutionAsync(\n                ActionExecutingContext context,\n                ActionExecutionDelegate next) {\n            if (context.ActionArguments.ContainsKey(""message1"")) {\n                context.ActionArguments[""message1""] = ""New message"";\n            }\n            await next();\n        }\n    }\n}\nThe filter looks for an action argument named message1  and changes the value that \nwill be used to invoke the action method. The values that will be used for the action \nmethod arguments are determined by the model binding process. Listing 30.22 adds \nan action method to the Home  controller and applies the new filter.\nListing 30.22    Applying a filter in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nnamespace WebApp.Controllers {\n 897 Creating custom filters\n    [HttpsOnly]\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n        public IActionResult Secure() {\n            return View(""Message"",\n                ""This is the Secure action on the Home controller"");\n        }\n        [ChangeArg]\n        public IActionResult Messages(string message1, \n                string message2 = ""None"") {\n            return View(""Message"", $""{message1}, {message2}"");\n        }\n    }\n}\nRestart ASP.NET Core and request https://localhost:44350/home/messages \n ?message1=hello&message2=world. The model binding process will locate values for \nthe parameters defined by the action method from the query string. One of those val-\nues is then modified by the action filter, producing the response shown in figure 30.8.\nFigure 30.8    Using an action filter\nimplementing  an action  filter  using  the attribute  base class\nAction attributes can also be implemented by deriving from the ActionFilter -\nAttribute  class, which extends Attribute  and inherits both the IActionFilter  \nand IAsyncActionFilter  interfaces so that implementation classes override just the \nmethods they require. In listing 30.23, I have reimplemented the ChangeArg  filter so \nthat it is derived from ActionFilterAttribute .\nListing 30.23    Using a filter base class in the Filters/ChangeArgsAttribute.cs file \nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Filters {\n    public class ChangeArgAttribute : ActionFilterAttribute {\n        public override async Task OnActionExecutionAsync( \n            ActionExecutingContext context, \n                ActionExecutionDelegate next) {\n            if (context.ActionArguments.ContainsKey(""message1"")) {\n898 chapter  30 Using filters\n                context.ActionArguments[""message1""] = ""New message"";\n            }\n            await next();\n        }\n    }\n}\nThis attribute behaves in just the same way as the earlier implementation, and the use \nof the base class is a matter of preference. Restart ASP.NET Core and request https://\nlocalhost:44350/home/messages?message1=hello&message2=world, and you will see \nthe response shown in figure 30.8.\nusing the controller  filter  methods  \nThe Controller  class, which is the base for controllers that render Razor views, imple-\nments the IActionFilter  and IAsyncActionFilter  interfaces, which means you can \ndefine functionality and apply it to the actions defined by a controller and any derived \ncontrollers. Listing 30.24 implements the ChangeArg  filter functionality directly in the \nHomeController  class.\nListing 30.24    Using action filter methods in the Controllers/HomeController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Controllers {\n    [HttpsOnly]\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n        public IActionResult Secure() {\n            return View(""Message"",\n                ""This is the Secure action on the Home controller"");\n        }\n        //[ChangeArg]\n        public IActionResult Messages(string message1, \n                string message2 = ""None"") {\n            return View(""Message"", $""{message1}, {message2}"");\n        }\n        public override void OnActionExecuting(\n                ActionExecutingContext context) {\n            if (context.ActionArguments.ContainsKey(""message1"")) {\n                context.ActionArguments[""message1""] = ""New message"";\n            }\n        }\n    }\n}",10773
374-30.4.4 Understanding page filters.pdf,374-30.4.4 Understanding page filters,"899 Creating custom filters\nThe Home  controller overrides the Controller  implementation of the OnAction -\nExecuting  method and uses it to modify the arguments that will be passed to the exe-\ncution method. Restart ASP.NET Core and request https://localhost:44350/home/\nmessages?message1=hello&message2=world, and you will see the response shown in \nfigure 30.8.\n30.4.4  Understanding page filters\nPage filters are the Razor Page equivalent of action filters. Here is the IPageFilter  \ninterface, which is implemented by synchronous page filters:  \nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IPageFilter : IFilterMetadata {\n        void OnPageHandlerSelected(PageHandlerSelectedContext context);\n        void OnPageHandlerExecuting(PageHandlerExecutingContext context);\n        void OnPageHandlerExecuted(PageHandlerExecutedContext context);\n    }\n}\nThe OnPageHandlerSelected  method is invoked after ASP.NET Core has selected the \npage handler method but before model binding has been performed, which means the \narguments for the handler method have not been determined. This method receives \ncontext through the PageHandlerSelectedContext  class, which defines the proper-\nties shown in table 30.10, in addition to those defined by the FilterContext  class. \nThis method cannot be used to short-circuit the pipeline, but it can alter the handler \nmethod that will receive the request.  \nTable 30.10    The PageHandlerSelectedContext properties\nName Description\nActionDescriptor This property returns the description of the Razor Page.\nHandlerMethod This property returns a HandlerMethodDescriptor  \nobject that describes the selected handler method.\nHandlerInstance This property returns the instance of the Razor Page that \nwill handle the request.\nThe OnPageHandlerExecuting  method is called after the model binding process has \ncompleted but before the page handler method is invoked. This method receives con-\ntext through the PageHandlerExecutingContext  class, which defines the properties \nshown in table 30.11, in addition to those defined by the PageHandlerSelected -\nContext  class.\n900 chapter  30 Using filters\nTable 30.11    The PageHandlerExecutingContext properties\nName Description\nHandlerArguments This property returns a dictionary containing \nthe page handler arguments, indexed by \nname.\nResult The filter can short-circuit the pipeline by \nassigning an IActionResult  object to this \nproperty.\nThe OnPageHandlerExecuted  method is called after the page handler method \nhas been invoked but before the action result is processed to create a response. \nThis method receives context through the PageHandlerExecutedContext  class, \nwhich defines the properties shown in table 30.12 in addition to the PageHandler -\nExecutingContext  properties.\nTable 30.12    The PageHandlerExecutedContext properties\nName Description\nCanceled This property returns true  if another filter \nshort-circuited the filter pipeline.\nException This property returns an exception if one was \nthrown by the page handler method.\nExceptionHandled This property is set to true  to indicate that \nan exception thrown by the page handler has \nbeen handled by the filter.\nResult This property returns the action result that will \nbe used to create a response for the client.\nAsynchronous page filters are created by implementing the IAsyncPageFilter  inter-\nface, which is defined like this:\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IAsyncPageFilter : IFilterMetadata {\n        Task OnPageHandlerSelectionAsync(\n            PageHandlerSelectedContext context);\n        Task OnPageHandlerExecutionAsync(\n            PageHandlerExecutingContext context, \n            PageHandlerExecutionDelegate next);\n    }\n}\nThe OnPageHandlerSelectionAsync  is called after the handler method is selected \nand is equivalent to the synchronous OnPageHandlerSelected  method. The OnPage-\nHandlerExecutionAsync  is provided with a PageHandlerExecutingContext  object \nthat allows it to short-circuit the pipeline and with a delegate that is invoked to pass on \nthe request. The delegate produces a PageHandlerExecutedContext  object that can \nbe used to inspect or alter the action result produced by the handler method.\n 901 Creating custom filters\ncreating  a page filter\nTo create a page filter, add a class file named ChangePageArgs.cs  to the Filters  \nfolder and use it to define the class shown in listing 30.25.\nListing 30.25    The contents of the ChangePageArgs.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Filters {\n    public class ChangePageArgs : Attribute, IPageFilter {\n        public void OnPageHandlerSelected(\n                PageHandlerSelectedContext context) {\n            // do nothing\n        }\n        public void OnPageHandlerExecuting(\n                PageHandlerExecutingContext context) {\n            if (context.HandlerArguments.ContainsKey(""message1"")) {\n                context.HandlerArguments[""message1""] = ""New message"";\n            }\n        }\n        public void OnPageHandlerExecuted(\n                PageHandlerExecutedContext context) {\n            // do nothing\n        }\n    }\n}\nThe page filter in listing 30.25 performs the same task as the action filter I created \nin the previous section. In listing 30.26, I have modified the Message  Razor Page to \ndefine a handler method and have applied the page filter. Page filters can be applied \nto individual handler methods or, as in the listing, to the page model class, in which \ncase the filter is used for all handler methods. (I also disabled the SimpleCache  filter \nin listing 30.26. Resource filters can work alongside page filters. I disabled this filter \nbecause caching responses makes some of the examples more difficult to follow.)\nListing 30.26    Using a page filter in the Message.cshtml file in the Pages folder\n@page ""/pages/message""\n@model MessageModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Filters\n@if (Model.Message is string) {\n    @Model.Message\n} else if (Model.Message is IDictionary<string, string>) {\n    var dict = Model.Message as IDictionary<string, string>;\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>Name</th><th>Value</th></tr></thead>\n        <tbody>\n            @if (dict != null) {\n902 chapter  30 Using filters\n                foreach (var kvp in dict) {\n                    <tr><td>@kvp.Key</td><td>@kvp.Value</td></tr>\n                }\n            }\n        </tbody>\n    </table>\n}\n@functions {\n    [RequireHttps]\n    //[SimpleCache]\n    [ChangePageArgs]\n    public class MessageModel : PageModel {\n        public object Message { get; set; } =\n            DateTime.Now.ToLongTimeString() \n                + "" This is the Message Razor Page"";\n        public void OnGet(string message1, string message2) {\n            Message = $""{message1}, {message2}"";\n        }\n    }\n}\nRestart ASP.NET Core and request https://localhost:44350/pages/message -\n?message1=hello&message2=world. The page filter will replace the value of the \nmessage1  argument for the OnGet  handler method, which produces the response \nshown in figure 30.9.\nFigure 30.9    Using a page filter\nusing the page model  filter  methods\nThe PageModel  class, which is used as the base for page model classes, implements \nthe IPageFilter  and IAsyncPageFilter  interfaces, which means you can add filter \nfunctionality directly to a page model, as shown in listing 30.27.\nListing 30.27    Using the filter methods in the Message.cshtml file in the Pages folder\n@page ""/pages/message""\n@model MessageModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using WebApp.Filters\n@using Microsoft.AspNetCore.Mvc.Filters\n@if (Model.Message is string) {",7913
375-30.4.5 Understanding result filters.pdf,375-30.4.5 Understanding result filters,"903 Creating custom filters\n    @Model.Message\n} else if (Model.Message is IDictionary<string, string>) {\n    var dict = Model.Message as IDictionary<string, string>;\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>Name</th><th>Value</th></tr></thead>\n        <tbody>\n            @if (dict != null) {\n                foreach (var kvp in dict) {\n                    <tr><td>@kvp.Key</td><td>@kvp.Value</td></tr>\n                }\n            }\n        </tbody>\n    </table>\n}\n@functions {\n    [RequireHttps]\n    //[SimpleCache]\n    //[ChangePageArgs]\n    public class MessageModel : PageModel {\n        public object Message { get; set; } =\n            DateTime.Now.ToLongTimeString() \n                + "" This is the Message Razor Page"";\n        public void OnGet(string message1, string message2) {\n            Message = $""{message1}, {message2}"";\n        }\n        public override void OnPageHandlerExecuting(\n                PageHandlerExecutingContext context) {\n            if (context.HandlerArguments.ContainsKey(""message1"")) {\n                context.HandlerArguments[""message1""] = ""New message"";\n            }\n        }\n    }\n}\nRequest https://localhost:44350/pages/message?message1=hello&message2=world. \nThe method implemented by the page model class in listing 30.27 will produce the \nsame result as shown in figure 30.9.\n30.4.5  Understanding result filters\nResult filters are executed before and after an action result is used to generate a \nresponse, allowing responses to be modified after they have been handled by the end-\npoint. Here is the definition of the IResultFilter  interface:  \nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IResultFilter : IFilterMetadata {\n        void OnResultExecuting(ResultExecutingContext context);\n904 chapter  30 Using filters\n        void OnResultExecuted(ResultExecutedContext context);\n    }\n}\nThe OnResultExecuting  method is called after the endpoint has produced an action \nresult. This method receives context through the ResultExecutingContext  class, \nwhich defines the properties described in table 30.13, in addition to those defined by \nthe FilterContext  class.  \nTable 30.13    The ResultExecutingContext class properties\nName Description\nController This property returns the object that contains the \nendpoint.\nCancel Setting this property to true  will short-circuit the \nresult filter pipeline.\nResult This property returns the action result produced \nby the endpoint.\nThe OnResultExecuted  method is called after the action result has been executed \nto generate the response for the client. This method receives context through the \nResultExecutedContext  class, which defines the properties shown in table 30.14, in \naddition to those it inherits from the FilterContext  class.\nTable 30.14    The ResultExecutedContext class\nName Description\nCanceled This property returns true  if another filter short-  \ncircuited the filter pipeline.\nController This property returns the object that contains the \nendpoint.\nException This property returns an exception if one was thrown \nby the page handler method.\nExceptionHandled This property is set to true  to indicate that an  \nexception thrown by the page handler has been han-\ndled by the filter.\nResult This property returns the action result that will be used \nto create a response for the client. This property is \nread-only.\nAsynchronous result filters implement the IAsyncResultFilter  interface, which is \ndefined like this:\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n \n    public interface IAsyncResultFilter : IFilterMetadata {\n        Task OnResultExecutionAsync(ResultExecutingContext context, \n            ResultExecutionDelegate next);\n    }\n}\n 905 Creating custom filters\nThis interface follows the pattern established by the other filter types. The OnResult-\nExecutionAsync  method is invoked with a context object whose Result  property can \nbe used to alter the response and a delegate that will forward the response along the \npipeline. \nunderstanding  always -run result  filters\nFilters that implement the IResultFilter  and IAsyncResultFilter  interfaces are \nused only when a request is handled normally by the endpoint. They are not used if \nanother filter short-circuits the pipeline or if there is an exception. Filters that need to \ninspect or alter the response, even when the pipeline is short-circuited, can implement \nthe IAlwaysRunResultFilter  or IAsyncAlwaysRunResultFilter  interface. These \ninterfaces derived from IResultFilter  and IAsyncResultFilter  but define no new \nfeatures. Instead, ASP.NET Core detects the always-run interfaces and always applies \nthe filters.  \ncreating  a result  filter\nAdd a class file named ResultDiagnosticsAttribute.cs  to the Filters  folder and \nuse it to define the filter shown in listing 30.28.\nListing 30.28    The contents of the ResultDiagnosticsAttribute.cs file in the Filters \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nnamespace WebApp.Filters {\n    public class ResultDiagnosticsAttribute : \n            Attribute, IAsyncResultFilter {\n        public async Task OnResultExecutionAsync(\n                ResultExecutingContext context, \n                ResultExecutionDelegate next) {\n            if (context.HttpContext.Request.Query.ContainsKey(""diag"")) {\n                Dictionary<string, string?> diagData =\n                    new Dictionary<string, string?> {\n                        {""Result type"", context.Result.GetType().Name }\n                    };\n                if (context.Result is ViewResult vr) {\n                    diagData[""View Name""] = vr.ViewName;\n                    diagData[""Model Type""] \n                        = vr.ViewData?.Model?.GetType().Name;\n                    diagData[""Model Data""] \n                        = vr.ViewData?.Model?.ToString();\n                } else if (context.Result is PageResult pr) {\n                    diagData[""Model Type""] = pr.Model.GetType().Name;\n                    diagData[""Model Data""] \n                        = pr.ViewData?.Model?.ToString();\n906 chapter  30 Using filters\n                }\n                context.Result = new ViewResult() {\n                    ViewName = ""/Views/Shared/Message.cshtml"",\n                    ViewData = new ViewDataDictionary(\n                                       new EmptyModelMetadataProvider(),\n                                       new ModelStateDictionary()) {\n                        Model = diagData\n                    }\n                };\n            }\n            await next();\n        }\n    }\n}\nThis filter examines the request to see whether it contains a query string parameter \nnamed diag . If it does, then the filter creates a result that displays diagnostic infor-\nmation instead of the output produced by the endpoint. The filter in listing 30.28 will \nwork with the actions defined by the Home  controller or the Message  Razor Page. List-\ning 30.29 applies the result filter to the Home  controller.\nTIP    Notice that I use a fully qualified name for the view when I create the action \nresult in listing 30.28. This avoids a problem with filters applied to Razor Pages, \nwhere ASP.NET Core tries to execute the new result as a Razor Page and throws \nan exception about the model type.\nListing 30.29    Applying a result filter in the Controllers/HomeController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Controllers {\n    [HttpsOnly]\n    [ResultDiagnostics]\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n        public IActionResult Secure() {\n            return View(""Message"",\n                ""This is the Secure action on the Home controller"");\n        }\n        //[ChangeArg]\n        public IActionResult Messages(string message1, \n                string message2 = ""None"") {\n            return View(""Message"", $""{message1}, {message2}"");\n        }\n 907 Creating custom filters\n        public override void OnActionExecuting(\n                ActionExecutingContext context) {\n            if (context.ActionArguments.ContainsKey(""message1"")) {\n                context.ActionArguments[""message1""] = ""New message"";\n            }\n        }\n    }\n}\nRestart ASP.NET Core and request https://localhost:44350/?diag. The query string \nparameter will be detected by the filter, which will generate the diagnostic information \nshown in figure 30.10.\nFigure 30.10    \nUsing a result \nfilter\nimplementing  a result  filter  using  the attribute  base class\nThe ResultFilterAttribute  class is derived from Attribute  and implements the \nIResultFilter  and IAsyncResultFilter  interfaces and can be used as the base \nclass for result filters, as shown in listing 30.30. There is no attribute base class for the \nalways-run interfaces.\nListing 30.30    Using the base class in the Filters/ResultDiagnosticsAttribute.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nnamespace WebApp.Filters {\n    public class ResultDiagnosticsAttribute : ResultFilterAttribute {\n        public override async Task OnResultExecutionAsync(\n                ResultExecutingContext context,\n                ResultExecutionDelegate next) {\n            if (context.HttpContext.Request.Query.ContainsKey(""diag"")) {\n                Dictionary<string, string?> diagData =\n                    new Dictionary<string, string?> {\n                        {""Result type"", context.Result.GetType().Name }\n                    };\n                if (context.Result is ViewResult vr) {\n                    diagData[""View Name""] = vr.ViewName;\n                    diagData[""Model Type""] \n                        = vr.ViewData?.Model?.GetType().Name;",10369
376-30.4.7 Creating an exception filter.pdf,376-30.4.7 Creating an exception filter,"908 chapter  30 Using filters\n                    diagData[""Model Data""] \n                        = vr.ViewData?.Model?.ToString();\n                } else if (context.Result is PageResult pr) {\n                    diagData[""Model Type""] = pr.Model.GetType().Name;\n                    diagData[""Model Data""] \n                        = pr.ViewData?.Model?.ToString();\n                }\n                context.Result = new ViewResult() {\n                    ViewName = ""/Views/Shared/Message.cshtml"",\n                    ViewData = new ViewDataDictionary(\n                                       new EmptyModelMetadataProvider(),\n                                       new ModelStateDictionary()) {\n                        Model = diagData\n                    }\n                };\n            }\n            await next();\n        }\n    }\n}\nRestart ASP.NET Core and request https://localhost:44350/?diag. The filter will pro-\nduce the output shown in figure 30.10.\n30.4.6  Understanding exception filters\nException filters allow you to respond to exceptions without having to write try...\ncatch  blocks in every action method. Exception filters can be applied to controller \nclasses, action methods, page model classes, or handler methods. They are invoked \nwhen an exception is not handled by the endpoint or by the action, page, and result \nfilters that have been applied to the endpoint. (Action, page, and result filters can deal \nwith an unhandled exception by setting the ExceptionHandled  property of their con-\ntext objects to true .) Exception filters implement the IExceptionFilter  interface, \nwhich is defined as follows:  \nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IExceptionFilter : IFilterMetadata {\n        void OnException(ExceptionContext context);\n    }\n}\nThe OnException  method is called if an unhandled exception is encountered. The \nIAsyncExceptionFilter  interface can be used to create asynchronous exception fil-\nters. Here is the definition of the asynchronous interface:\nusing System.Threading.Tasks;\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IAsyncExceptionFilter : IFilterMetadata {\n        Task OnExceptionAsync(ExceptionContext context);\n    }\n}\n 909 Creating custom filters\nThe OnExceptionAsync  method is the asynchronous counterpart to the  OnException  \nmethod from the IExceptionFilter  interface and is called when there is an \nunhandled exception. For both interfaces, context data is provided through the  \nExceptionContext  class, which is derived from FilterContext  and defines the addi-\ntional properties shown in table 30.15.  \nTable 30.15    The ExceptionContext properties\nName Description\nException This property contains any Exception  that was \nthrown.\nExceptionHandled This bool  property is used to indicate if the  \nexception has been handled.\nResult This property sets the IActionResult  that will \nbe used to generate the response.\n30.4.7  Creating an exception filter \nException filters can be created by implementing one of the filter interfaces or \nby deriving from the ExceptionFilterAttribute  class, which is derived from  \nAttribute  and implements both the IExceptionFilter  and IAsyncException  fil-\nters. The most common use for an exception filter is to present a custom error page \nfor a specific exception type to provide the user with more useful information than the \nstandard error-handling capabilities can provide. \nTo create an exception filter, add a class file named RangeExceptionAttribute.cs  \nto the Filters  folder with the code shown in listing 30.31.\nListing 30.31    The contents of the RangeExceptionAttribute.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nnamespace WebApp.Filters {\n    public class RangeExceptionAttribute : ExceptionFilterAttribute {\n        public override void OnException(ExceptionContext context) {\n            if (context.Exception is ArgumentOutOfRangeException) {\n                context.Result = new ViewResult() {\n                    ViewName = ""/Views/Shared/Message.cshtml"",\n                    ViewData = new ViewDataDictionary(\n                        new EmptyModelMetadataProvider(),\n                        new ModelStateDictionary()) {\n                        Model = @""The data received by the\n                                application cannot be processed""\n                    }\n                };\n            }\n910 chapter  30 Using filters\n        }\n    }\n}\nThis filter uses the ExceptionContext  object to get the type of the unhandled excep-\ntion and, if the type is ArgumentOutOfRangeException , creates an action result that \ndisplays a message to the user. Listing 30.32 adds an action method to the Home  con-\ntroller to which I have applied the exception filter. \nListing 30.32    Applying an exception filter in the Controllers/HomeController.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nusing Microsoft.AspNetCore.Mvc.Filters;\nnamespace WebApp.Controllers {\n    [HttpsOnly]\n    [ResultDiagnostics]\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n        public IActionResult Secure() {\n            return View(""Message"",\n                ""This is the Secure action on the Home controller"");\n        }\n        //[ChangeArg]\n        public IActionResult Messages(string message1, \n                string message2 = ""None"") {\n            return View(""Message"", $""{message1}, {message2}"");\n        }\n        public override void OnActionExecuting(\n                ActionExecutingContext context) {\n            if (context.ActionArguments.ContainsKey(""message1"")) {\n                context.ActionArguments[""message1""] = ""New message"";\n            }\n        }\n        [RangeException]\n        public ViewResult GenerateException(int? id) {\n            if (id == null) {\n                throw new ArgumentNullException(nameof(id));\n            } else if (id > 10) {\n                throw new ArgumentOutOfRangeException(nameof(id));\n            } else {\n                return View(""Message"", $""The value is {id}"");\n            }\n        }\n    }\n}",6465
377-30.5 Managing the filter lifecycle.pdf,377-30.5 Managing the filter lifecycle,"911 Managing the filter lifecycle\nThe GenerateException  action method relies on the default routing pattern to \nreceive a nullable int value from the request URL. The action method throws an \nArgumentNullException  if there is no matching URL segment and throws an  \nArgumentOutOfRangeException  if its value is greater than 10. If there is a value and it \nis in range, then the action method returns a ViewResult .\nRestart ASP.NET Core and request https://localhost:44350/Home/Generate -\nException  /100. The final segment will exceed the range expected by the action \nmethod, which will throw the exception type that is handled by the filter, producing \nthe result shown in figure 30.11. If you request /Home/GenerateException , then the \nexception thrown by the action method won’t be handled by the filter, and the default \nerror handling will be used.\nFigure 30.11    Using an exception filter\n30.5 Managing the filter lifecycle\nBy default, ASP.NET Core manages the filter objects it creates and will reuse them for \nsubsequent requests. This isn’t always the desired behavior, and in the sections that fol-\nlow, I describe different ways to take control of how filters are created. To create a filter \nthat will show the lifecycle, add a class file called GuidResponseAttribute.cs  to the \nFilters  folder, and use it to define the filter shown in listing 30.33.  \nListing 30.33    The contents of the GuidResponseAttribute.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nnamespace WebApp.Filters {\n    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Class,\n         AllowMultiple = true)]\n    public class GuidResponseAttribute \n            : Attribute, IAsyncAlwaysRunResultFilter {\n        private int counter = 0;\n        private string guid = Guid.NewGuid().ToString();\n        public async Task OnResultExecutionAsync(\n            ResultExecutingContext context,\n912 chapter  30 Using filters\n            ResultExecutionDelegate next) {\n            Dictionary<string, string> resultData;\n            if (context.Result is ViewResult vr\n                && vr.ViewData.Model is Dictionary<string, string> data) {\n                resultData = data;\n            } else {\n                resultData = new Dictionary<string, string>();\n                context.Result = new ViewResult() {\n                    ViewName = ""/Views/Shared/Message.cshtml"",\n                    ViewData = new ViewDataDictionary(\n                                        new EmptyModelMetadataProvider(),\n                                        new ModelStateDictionary()) {\n                        Model = resultData\n                    }\n                };\n            }\n            while (resultData.ContainsKey($""Counter_{counter}"")) {\n                counter++;\n            }\n            resultData[$""Counter_{counter}""] = guid;\n            await next();\n        }\n    }\n}\nThis result filter replaces the action result produced by the endpoint with one that will \nrender the Message  view and display a unique GUID value. The filter is configured so \nthat it can be applied more than once to the same target and will add a new message if \na filter earlier in the pipeline has created a suitable result. Listing 30.34 applies the fil-\nter twice to the Home  controller. (I have also removed all but one of the action methods \nfor brevity.)\nListing 30.34    Applying a filter in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nnamespace WebApp.Controllers {\n    [HttpsOnly]\n    [ResultDiagnostics]\n    [GuidResponse]\n    [GuidResponse]\n    public class HomeController : Controller {\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n    }\n}",4019
378-30.5.1 Creating filter factories.pdf,378-30.5.1 Creating filter factories,"913 Managing the filter lifecycle\nTo confirm that the filter is being reused, restart ASP.NET Core and request https://\nlocalhost:44350/?diag. The response will contain GUID values from the two Guid-\nResponse  filter attributes. Two instances of the filter have been created to handle the \nrequest. Reload the browser, and you will see the same GUID values displayed, indicat-\ning that the filter objects created to handle the first request have been reused (Figure \n30.12).\nFigure 30.12    Demonstrating filter reuse\n30.5.1  Creating filter factories\nFilters can implement the IFilterFactory  interface to take responsibility for cre-\nating instances of filters and specify whether those instances can be reused. The  \nIFilterFactory  interface defines the members described in table 30.16.  \nTable 30.16    The IFilterFactory members\nName Description\nIsReusable This bool  property indicates whether \ninstances of the filter can be reused.\nCreateInstance(serviceProvider) This method is invoked to create new \ninstances of the filter and is provided \nwith an IServiceProvider  object.\nListing 30.35 implements the IFilterFactory  interface and returns false  for the \nIsReusable  property, which prevents the filter from being reused. \nListing 30.35    Implementing an interface in the Filters/GuidResponseAttribute.cs file \nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nnamespace WebApp.Filters {\n    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Class,\n         AllowMultiple = true)]\n914 chapter  30 Using filters\n    public class GuidResponseAttribute : Attribute,\n            IAsyncAlwaysRunResultFilter, IFilterFactory {\n        private int counter = 0;\n        private string guid = Guid.NewGuid().ToString();\n        public bool IsReusable => false;\n        public IFilterMetadata CreateInstance(\n                IServiceProvider serviceProvider) {\n            return ActivatorUtilities\n                .GetServiceOrCreateInstance\n                    <GuidResponseAttribute>(serviceProvider);\n        }\n        public async Task OnResultExecutionAsync(\n                ResultExecutingContext context,\n                ResultExecutionDelegate next) {\n            Dictionary<string, string> resultData;\n            if (context.Result is ViewResult vr\n                && vr.ViewData.Model is Dictionary<string, string> data) {\n                resultData = data;\n            } else {\n                resultData = new Dictionary<string, string>();\n                context.Result = new ViewResult() {\n                    ViewName = ""/Views/Shared/Message.cshtml"",\n                    ViewData = new ViewDataDictionary(\n                                        new EmptyModelMetadataProvider(),\n                                        new ModelStateDictionary()) {\n                        Model = resultData\n                    }\n                };\n            }\n            while (resultData.ContainsKey($""Counter_{counter}"")) {\n                counter++;\n            }\n            resultData[$""Counter_{counter}""] = guid;\n            await next();\n        }\n    }\n}\nI create new filter objects using the GetServiceOrCreateInstance  method, defined \nby the ActivatorUtilities  class in the Microsoft.Extensions.Dependency-\nInjection  namespace. Although you can use the new keyword to create a filter, this \napproach will resolve any dependencies on services that are declared through the fil-\nter’s constructor.\nTo see the effect of implementing the IFilterFactory  interface, restart ASP.NET \nCore and request https://localhost:44350/?diag. Reload the browser, and each time \nthe request is handled, new filters will be created, and new GUIDs will be displayed, as \nshown in figure 30.13.",3896
379-30.6 Creating global filters.pdf,379-30.6 Creating global filters,"915 Managing the filter lifecycle\nFigure 30.13    Preventing filter reuse\n30.5.2  Using dependency injection scopes to manage filter lifecycles\nFilters can be registered as services, which allows their lifecycle to be controlled \nthrough dependency injection, which I described in chapter 14. Listing 30.36 registers \nthe GuidResponse  filter as a scoped service. \nListing 30.36    Creating a filter service in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing WebApp.Filters;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddScoped<GuidResponseAttribute>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nBy default, ASP.NET Core creates a scope for each request, which means that a single \ninstance of the filter will be created for each request. To see the effect, restart ASP.NET \nCore and request https://localhost:44350/?diag. Both attributes applied to the Home  \ncontroller are processed using the same instance of the filter, which means that both \n916 chapter  30 Using filters\nGUIDs in the response are the same. Reload the browser; a new scope will be created, \nand a new filter object will be used, as shown in figure 30.14.\nFigure 30.14    Using dependency injection to manage filters\nUsing filters as services without the IFilterFactory interface\nThe change in lifecycle took effect immediately in this example because I used the \nActivatorUtilities.GetServiceOrCreateInstance  method to create the filter \nobject when I implemented the IFilterFactory  interface. This method will check to \nsee whether there is a service available for the requested type before invoking its con -\nstructor. If you want to use filters as services without implementing IFilterFactory  \nand using ActivatorUtilities , you can apply the filter using the ServiceFilter  \nattribute, like this:  \n...\n[ServiceFilter(typeof(GuidResponseAttribute))]\n...\nASP.NET Core will create the filter object from the service and apply it to the request. \nFilters that are applied in this way do not have to be derived from the Attribute  class.\n30.6 Creating global filters\nGlobal filters are applied to every request that ASP.NET Core handles, which means \nthey don’t have to be applied to individual controllers or Razor Pages. Any filter can be \nused as a global filter; however, action filters will be applied to requests only where the \nendpoint is an action method, and page filters will be applied to requests only where \nthe endpoint is a Razor Page.\nGlobal filters are set up using the options pattern in the Program.cs  file, as shown \nin listing 30.37.  \nListing 30.37    Creating a global filter in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing WebApp.Filters;\n 917 Creating global filters\nusing Microsoft.AspNetCore.Mvc;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddScoped<GuidResponseAttribute>();\nbuilder.Services.Configure<MvcOptions>(opts =>\n    opts.Filters.Add<HttpsOnlyAttribute>());\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe MvcOptions.Filters  property returns a collection to which filters are added to \napply them globally, either using the Add<T>  method or using the AddService<T>  \nmethod for filters that are also services. There is also an Add method without a generic \ntype argument that can be used to register a specific object as a global filter.\nThe statement in listing 30.37 registers the HttpsOnly  filter I created earlier in the \nchapter, which means that it no longer needs to be applied directly to individual con-\ntrollers or Razor Pages, so listing 30.38 removes the filter from the Home  controller.\nNOTE     Notice that I have disabled the GuidResponse  filter in listing 30.38. This \nis an always-run result filter and will replace the result generated by the global \nfilter.\nListing 30.38    Removing a filter in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nnamespace WebApp.Controllers {\n    //[HttpsOnly]\n    [ResultDiagnostics]\n    //[GuidResponse]\n    //[GuidResponse]\n    public class HomeController : Controller {",5211
380-30.7 Understanding and changing filter order.pdf,380-30.7 Understanding and changing filter order,"918 chapter  30 Using filters\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n    }\n}\nRestart ASP.NET Core and request http://localhost:5000 to confirm that the HTTPS-\nonly policy is being applied even though the attribute is no longer used to decorate \nthe controller. The global authorization filter will short-circuit the filter pipeline and \nproduce the response shown in figure 30.15.\nFigure 30.15    \nUsing a global \nfilter\n30.7 Understanding and changing filter order\nFilters run in a specific sequence: authorization, resource, action, or page, and then \nresult. But if there are multiple filters of a given type, then the order in which they are \napplied is driven by the scope through which the filters have been applied. \nTo demonstrate how this works, add a class file named MessageAttribute.cs  to the \nFilters  folder and use it to define the filter shown in listing 30.39.  \nListing 30.39    The contents of the MessageAttribute.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nnamespace WebApp.Filters {\n    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Class,\n        AllowMultiple = true)]\n    public class MessageAttribute \n            : Attribute, IAsyncAlwaysRunResultFilter {\n        private int counter = 0;\n        private string msg;\n        public MessageAttribute(string message) => msg = message;\n        public async Task OnResultExecutionAsync(\n                ResultExecutingContext context,\n 919 Understanding and changing filter order\n               ResultExecutionDelegate next) {\n            Dictionary<string, string> resultData;\n            if (context.Result is ViewResult vr\n                && vr.ViewData.Model is Dictionary<string, string> data) {\n                resultData = data;\n            } else {\n                resultData = new Dictionary<string, string>();\n                context.Result = new ViewResult() {\n                    ViewName = ""/Views/Shared/Message.cshtml"",\n                    ViewData = new ViewDataDictionary(\n                                        new EmptyModelMetadataProvider(),\n                                        new ModelStateDictionary()) {\n                        Model = resultData\n                    }\n                };\n            }\n            while (resultData.ContainsKey($""Message_{counter}"")) {\n                counter++;\n            }\n            resultData[$""Message_{counter}""] = msg;\n            await next();\n        }\n    }\n}\nThis result filter uses techniques shown in earlier examples to replace the result from \nthe endpoint and allows multiple filters to build up a series of messages that will be \ndisplayed to the user. Listing 30.40 applies several instances of the Message  filter to the \nHome  controller.\nListing 30.40    Applying a filter in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nnamespace WebApp.Controllers {\n    [Message(""This is the controller-scoped filter"")]\n    public class HomeController : Controller {\n        [Message(""This is the first action-scoped filter"")]\n        [Message(""This is the second action-scoped filter"")]\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n    }\n}\nListing 30.41 registers the Message  filter globally.\n920 chapter  30 Using filters\nListing 30.41    Creating a global filter in the Program.cs file in the WebApp folder \nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing WebApp.Filters;\nusing Microsoft.AspNetCore.Mvc;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddScoped<GuidResponseAttribute>();\nbuilder.Services.Configure<MvcOptions>(opts => {\n    opts.Filters.Add<HttpsOnlyAttribute>();\n    opts.Filters.Add(new MessageAttribute(\n        ""This is the globally-scoped filter""));\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThere are four instances of the same filter. To see the order in which they are applied, \nrestart ASP.NET Core and request https://localhost:44350, which will produce the \nresponse shown in figure 30.16.\nFigure 30.16    \nApplying the \nsame filter in \ndifferent scopes\nBy default, ASP.NET Core runs global filters, then filters applied to controllers or page \nmodel classes, and finally filters applied to action or handler methods. \n 921 Understanding and changing filter order\nThe default order can be changed by implementing the IOrderedFilter  interface, \nwhich ASP.NET Core looks for when it is working out how to sequence filters. Here is \nthe definition of the interface:\nnamespace Microsoft.AspNetCore.Mvc.Filters {\n    public interface IOrderedFilter : IFilterMetadata {\n        int Order { get; }\n    }\n}\nThe Order  property returns an int value, and filters with low values are applied before \nthose with higher Order  values. In listing 30.42, I have implemented the interface in \nthe Message  filter and defined a constructor argument that will allow the value for the \nOrder  property to be specified when the filter is applied.\nListing 30.42    Adding ordering in the MessageAttribute.cs file in the Filters folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing Microsoft.AspNetCore.Mvc.ViewFeatures;\nnamespace WebApp.Filters {\n    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Class,\n        AllowMultiple = true)]\n    public class MessageAttribute : Attribute, \n            IAsyncAlwaysRunResultFilter,\n            IOrderedFilter {\n        private int counter = 0;\n        private string msg;\n        public MessageAttribute(string message) => msg = message;\n        public int Order { get; set; }\n        public async Task OnResultExecutionAsync(\n                ResultExecutingContext context,\n               ResultExecutionDelegate next) {\n            Dictionary<string, string> resultData;\n            if (context.Result is ViewResult vr\n                && vr.ViewData.Model is Dictionary<string, string> data) {\n                resultData = data;\n            } else {\n                resultData = new Dictionary<string, string>();\n                context.Result = new ViewResult() {\n                    ViewName = ""/Views/Shared/Message.cshtml"",\n                    ViewData = new ViewDataDictionary(\n                                        new EmptyModelMetadataProvider(),\n                                        new ModelStateDictionary()) {\n                        Model = resultData\n                    }\n922 chapter  30 Using filters\n                };\n            }\n            while (resultData.ContainsKey($""Message_{counter}"")) {\n                counter++;\n            }\n            resultData[$""Message_{counter}""] = msg;\n            await next();\n        }\n    }\n}\nIn listing 30.43, I have used the constructor argument to change the order in which the \nfilters are applied.\nListing 30.43    Setting filter order in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing WebApp.Filters;\nnamespace WebApp.Controllers {\n    [Message(""This is the controller-scoped filter"", Order = 10)]\n    public class HomeController : Controller {\n        [Message(""This is the first action-scoped filter"", Order = 1)]\n        [Message(""This is the second action-scoped filter"", Order = -1)]\n        public IActionResult Index() {\n            return View(""Message"",\n                ""This is the Index action on the Home controller"");\n        }\n    }\n}\nOrder  values can be negative, which is a helpful way of ensuring that a filter is applied \nbefore any global filters with the default order (although you can also set the order \nwhen creating global filters, too). Restart ASP.NET Core and request https://  \nlocalhost:44350 to see the new filter order, which is shown in figure 30.17.\nFigure 30.17    \nChanging filter \norder\n 923 Understanding and changing filter order\nSummary\n¡ Filters allow request processing logic to be defined in a class where it can be \napplied to specific endpoints and easily reused.\n¡ Filters have a well-defined lifecycle and can be used to perform the same tasks as \nmiddleware components.\n¡ There are six types of filters: authorization, resource, action, page, result, and \nexception.\n¡ Authorization filters are used to implement a security policy.\n¡ Resource filters are executed before the model-binding process.\n¡ Action and page filters are executed after the model-binding process.\n¡ Result filters are executed before and after a result is used to generate a response.\n¡ Exception filters are executed when an exception is thrown.",9538
381-31 Creating form applications.pdf,381-31 Creating form applications,,0
382-31.1 Preparing for this chapter.pdf,382-31.1 Preparing for this chapter,"92431Creating form  \napplications\nThis chapter covers\n¡ Using ASP.NET Core form features with Entity  \n Framework Core to create, read, update, and  \n delete data\n¡ Managing the use of related data in Entity   \n Framework Core results\nThe previous chapters have focused on individual features that deal with one aspect \nof HTML forms, and it can sometimes be difficult to see how they fit together to per-\nform common tasks. In this chapter, I go through the process of creating control-\nlers, views, and Razor Pages that support an application with create, read, update, \nand delete (CRUD) functionality. There are no new features described in this chap-\nter, and the objective is to demonstrate how features such as tag helpers, model \nbinding, and model validation can be used in conjunction with Entity Framework \nCore. \n31.1 Preparing for this chapter\nThis chapter uses the WebApp project from chapter 30. To prepare for this chap-\nter, replace the contents of the HomeController.cs  file in the Controllers  folder \nwith those shown in listing 31.1.\n 925 Preparing for this chapter\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 31.1    The contents of the HomeController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class HomeController : Controller {\n        private DataContext context;\n        private IEnumerable<Category> Categories => context.Categories;\n        private IEnumerable<Supplier> Suppliers => context.Suppliers;\n        public HomeController(DataContext data) {\n            context = data;\n        }\n        public IActionResult Index() {\n            return View(context.Products.\n                Include(p => p.Category).Include(p => p.Supplier));\n        }\n    }\n}\nCreate the Views/Home  folder and add to it a Razor View file named Index.cshtml  \nfiles, with the content shown in listing 31.2.\nListing 31.2    The contents of the Index.cshtml file in the Views/Home folder\n@model IEnumerable<Product>\n@{\n    Layout = ""_SimpleLayout"";\n}\n<h4 class=""bg-primary text-white text-center p-2"">Products</h4>\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Price</th>\n            <th>Category</th>\n            <th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @foreach (Product p in Model ?? Enumerable.Empty<Product>()) {\n926 chapter  31 Creating form applications \n            <tr>\n                <td>@p.ProductId</td>\n                <td>@p.Name</td>\n                <td>@p.Price</td>\n                <td>@p.Category?.Name</td>\n                <td class=""text-center"">\n                    <a asp-action=""Details"" asp-route-id=""@p.ProductId""\n                            class=""btn btn-sm btn-info"">\n                        Details\n                    </a>\n                    <a asp-action=""Edit"" asp-route-id=""@p.ProductId""\n                            class=""btn btn-sm btn-warning"">\n                        Edit\n                    </a>\n                    <a asp-action=""Delete"" asp-route-id=""@p.ProductId""\n                            class=""btn btn-sm btn-danger"">\n                        Delete\n                    </a>\n                </td>\n            </tr>\n        }\n    </tbody>\n</table>\n<a asp-action=""Create"" class=""btn btn-primary"">Create</a>\nNext, update the Product  class as shown in listing 31.3 to change the validation con-\nstraints to remove the model-level checking and disable remote validation.\nListing 31.3    Changing validation in the Product.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing System.Text.Json.Serialization;\nusing Microsoft.AspNetCore.Mvc.ModelBinding;\nusing WebApp.Validation;\nusing Microsoft.AspNetCore.Mvc;\nnamespace WebApp.Models {\n    //[PhraseAndPrice(Phrase = ""Small"", Price = ""100"")]\n    public class Product {\n        public long ProductId { get; set; }\n        [Required(ErrorMessage = ""Please enter a name"")]\n        public required string Name { get; set; }\n        [Range(1, 999999, ErrorMessage = ""Please enter a positive price"")]\n        [Column(TypeName = ""decimal(8, 2)"")]\n        public decimal Price { get; set; }\n        [PrimaryKey(ContextType = typeof(DataContext), \n            DataType = typeof(Category))]\n        //[Remote(""CategoryKey"", ""Validation"",\n        //    ErrorMessage = ""Enter an existing key"")]\n 927 Preparing for this chapter\n        public long CategoryId { get; set; }\n        public Category? Category { get; set; }\n        [PrimaryKey(ContextType = typeof(DataContext), \n            DataType = typeof(Supplier))]\n        //[Remote(""SupplierKey"", ""Validation"", \n        //    ErrorMessage = ""Enter an existing key"")]\n        public long SupplierId { get; set; }\n        [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]\n        public Supplier? Supplier { get; set; }\n    }\n}\nFinally, disable the global filters in the Program.cs  file, as shown in listing 31.4. This \nlisting also defines a route that makes it obvious when a URL targets a controller.\nListing 31.4    Disabling filters in the Program.cs file in the WebApp folder\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nusing WebApp.Filters;\n//using Microsoft.AspNetCore.Mvc;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:ProductConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddScoped<GuidResponseAttribute>();\n//builder.Services.Configure<MvcOptions>(opts => {\n//    opts.Filters.Add<HttpsOnlyAttribute>();\n//    opts.Filters.Add(new MessageAttribute(\n//        ""This is the globally-scoped filter""));\n//});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapDefaultControllerRoute();\napp.MapControllerRoute(""forms"", \n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();",6678
383-31.1.1 Dropping the database.pdf,383-31.1.1 Dropping the database,,0
384-31.1.2 Running the example application.pdf,384-31.1.2 Running the example application,,0
385-31.2 Creating an MVC forms application.pdf,385-31.2 Creating an MVC forms application,,0
386-31.2.1 Preparing the view model and the view.pdf,386-31.2.1 Preparing the view model and the view,"928 chapter  31 Creating form applications \n31.1.1  Dropping the database\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nWebApp.csproj  file, and run the command shown in listing 31.5 to drop the database.\nListing 31.5    Dropping the database\ndotnet ef database drop --force\n31.1.2  Running the example application \nUse the PowerShell command prompt to run the command shown in listing 31.6. \nListing 31.6    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers, which will display a list \nof products, as shown in figure 31.1. There are anchor elements styled to appear as \nbuttons, but these will not work until later when I add the features to create, edit, and \ndelete objects.\nFigure 31.1    \nRunning the \nexample \napplication\n31.2 Creating an MVC forms application \nIn the sections that follow, I show you how to perform the core data operations using \nMVC controllers and views. Later in the chapter, I create the same functionality using \nRazor Pages.  \n31.2.1  Preparing the view model and the view\nI am going to define a single form that will be used for multiple operations, configured \nthrough its view model class. To create the view model class, add a class file named \nProductViewModel.cs  to the Models  folder and add the code shown in listing 31.7.\n 929 Creating an MVC forms application \nListing 31.7    The contents of the ProductViewModel.cs file in the Models folder\nnamespace WebApp.Models {\n    public class ProductViewModel {\n        public Product Product { get; set; } \n            = new () { Name = string.Empty };\n        public string Action { get; set; } = ""Create"";\n        public bool ReadOnly { get; set; } = false;\n        public string Theme { get; set; } = ""primary"";\n        public bool ShowAction { get; set; } = true;\n        public IEnumerable<Category> Categories { get; set; }\n            = Enumerable.Empty<Category>();\n        public IEnumerable<Supplier> Suppliers { get; set; }\n            = Enumerable.Empty<Supplier>();\n    }\n}\nThis class will allow the controller to pass data and display settings to its view. The \nProduct  property provides the data to display, and the Categories  and Suppliers  \nproperties provide access to the Category  and Suppliers  objects when they are \nrequired. The other properties configure aspects of how the content is presented to \nthe user: the Action  property specifies the name of the action method for the current \ntask, the ReadOnly  property specifies whether the user can edit the data, the Theme  \nproperty specifies the Bootstrap theme for the content, and the ShowAction  property \nis used to control the visibility of the button that submits the form.\nTo create the view that will allow the user to interact with the application’s data, add a \nRazor View named ProductEditor.cshtml  to the Views/Home  folder with the content \nshown in listing 31.8.\nListing 31.8    The contents of the ProductEditor.cshtml file in the Views/Home folder \n@model ProductViewModel\n@{\n    Layout = ""_SimpleLayout"";\n}\n<partial name=""_Validation"" />\n<h5 class=""bg-@Model?.Theme text-white text-center p-2"">\n    @Model?.Action\n</h5>\n<form asp-action=""@Model?.Action"" method=""post"">\n    <div class=""form-group"">\n        <label asp-for=""Product.ProductId""></label>\n        <input class=""form-control"" \n930 chapter  31 Creating form applications \n            asp-for=""Product.ProductId"" readonly />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.Name""></label>\n        <div>\n            <span asp-validation-for=""Product.Name"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Product.Name""\n               readonly=""@Model?.ReadOnly"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.Price""></label>\n        <div>\n            <span asp-validation-for=""Product.Price"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Product.Price""\n               readonly=""@Model?.ReadOnly"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.CategoryId"">Category</label>\n        <div>\n            <span asp-validation-for=""Product.CategoryId"" \n                class=""text-danger""></span>\n        </div>\n        <select asp-for=""Product.CategoryId"" class=""form-control""\n                disabled=""@Model?.ReadOnly""\n                asp-items=""@(new SelectList(Model?.Categories,\n                    ""CategoryId"", ""Name""))"">\n            <option value="""" disabled selected>Choose a Category</option>\n        </select>\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.SupplierId"">Supplier</label>\n        <div>\n            <span asp-validation-for=""Product.SupplierId"" \n                class=""text-danger""></span>\n        </div>\n        <select asp-for=""Product.SupplierId"" class=""form-control""\n                disabled=""@Model?.ReadOnly""\n                asp-items=""@(new SelectList(Model?.Suppliers,\n                    ""SupplierId"", ""Name""))"">\n            <option value="""" disabled selected>Choose a Supplier</option>\n        </select>\n    </div>\n    @if (Model?.ShowAction == true) {\n        <button class=""btn btn-@Model?.Theme mt-2"" type=""submit"">\n            @Model?.Action\n        </button>\n    }\n    <a class=""btn btn-secondary mt-2"" asp-action=""Index"">Back</a>\n</form>\nThis view can look complicated, but it combines only the features you have seen in ear-\nlier chapters and will become clearer once you see it in action. The model for this view",5706
387-31.2.2 Reading data.pdf,387-31.2.2 Reading data,"931 Creating an MVC forms application \nis a ProductViewModel  object, which provides both the data that is displayed to the \nuser and some direction about how that data should be presented. \nFor each of the properties defined by the Product  class, the view contains a set of ele-\nments: a label  element that describes the property, an input  or select  element that \nallows the value to be edited, and a span  element that will display validation messages. \nEach of the elements is configured with the asp-for  attribute, which ensures tag help-\ners will transform the elements for each property. There are div elements to define the \nview structure, and all the elements are members of Bootstrap CSS classes to style the \nform.\n31.2.2  Reading data\nThe simplest operation is reading data from the database and presenting it to the user. \nIn most applications, this will allow the user to see additional details that are not pres-\nent in the list view. Each task performed by the application will require a different set of \nProductViewModel  properties. To manage these combinations, add a class file named \nViewModelFactory.cs  to the Models  folder with the code shown in listing 31.9.  \nListing 31.9    The contents of the ViewModelFactory.cs file in the Models folder \nnamespace WebApp.Models {\n    public static class ViewModelFactory {\n        public static ProductViewModel Details(Product p) {\n            return new ProductViewModel {\n                Product = p, Action = ""Details"",\n                ReadOnly = true, Theme = ""info"", ShowAction = false,\n                Categories = p == null || p.Category == null \n                    ? Enumerable.Empty<Category>()\n                    : new List<Category> { p.Category },\n                Suppliers = p == null || p.Supplier == null \n                    ? Enumerable.Empty<Supplier>()\n                    : new List<Supplier> { p.Supplier },\n            };\n        }\n    }\n}\nThe Details  method produces a ProductViewModel  object configured for viewing \nan object. When the user views the details, the category and supplier details will be \nread-only, which means that I need to provide only the current category and supplier \ninformation. \nNext, add an action method to the Home  controller that uses the ViewModel -\nFactory.Details  method to create a ProductViewModel  object and display it to the \nuser with the ProductEditor  view, as shown in listing 31.10.\n932 chapter  31 Creating form applications \nListing 31.10    Adding an action in the HomeController.cs file in the Controllers folder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class HomeController : Controller {\n        private DataContext context;\n        private IEnumerable<Category> Categories => context.Categories;\n        private IEnumerable<Supplier> Suppliers => context.Suppliers;\n        public HomeController(DataContext data) {\n            context = data;\n        }\n        public IActionResult Index() {\n            return View(context.Products.\n                Include(p => p.Category).Include(p => p.Supplier));\n        }\n        public async Task<IActionResult> Details(long id) {\n            Product? p = await context.Products.\n                Include(p => p.Category).Include(p => p.Supplier)\n                .FirstOrDefaultAsync(p => p.ProductId == id) \n                    ?? new () { Name = string.Empty };\n            ProductViewModel model = ViewModelFactory.Details(p);\n            return View(""ProductEditor"", model);\n        }\n    }\n}\nThe action method uses the id parameter, which will be model bound from the rout-\ning data, to query the database and passes the Product  object to the ViewModel -\nFactory.Details  method. Most of the operations are going to require the Category  \nand Supplier  data, so I have added properties that provide direct access to the data.\nTo test the details feature, restart ASP.NET Core and request http://localhost:5000/\ncontrollers. Click one of the Details buttons, and you will see the selected object pre-\nsented in read-only form using the ProductEditor  view, as shown in figure 31.2. \nFigure 31.2    \nViewing data",4310
388-31.2.3 Creating data.pdf,388-31.2.3 Creating data,"933 Creating an MVC forms application \nIf the user navigates to a URL that doesn’t correspond to an object in the database, \nsuch as http://localhost:5000/controllers/Home/Details/100, for example, then an \nempty form will be displayed. \n31.2.3  Creating data\nCreating data relies on model binding to get the form data from the request and relies \non validation to ensure the data can be stored in the database. The first step is to add \na factory method that will create the view model object for creating data, as shown in \nlisting 31.11.  \nListing 31.11    Adding a method in the ViewModelFactory.cs file in the Models folder\nnamespace WebApp.Models {\n    public static class ViewModelFactory {\n        public static ProductViewModel Details(Product p) {\n            return new ProductViewModel {\n                Product = p, Action = ""Details"",\n                ReadOnly = true, Theme = ""info"", ShowAction = false,\n                Categories = p == null || p.Category == null\n                    ? Enumerable.Empty<Category>()\n                    : new List<Category> { p.Category },\n                Suppliers = p == null || p.Supplier == null\n                    ? Enumerable.Empty<Supplier>()\n                    : new List<Supplier> { p.Supplier },\n            };\n        }\n        public static ProductViewModel Create(Product product,\n                IEnumerable<Category> categories, \n                IEnumerable<Supplier> suppliers) {\n            return new ProductViewModel {\n                Product = product, Categories = categories, \n                Suppliers = suppliers\n            };\n        }\n    }\n}\nThe defaults I used for the ProductViewModel  properties were set for creating \ndata, so the Create  method in listing 31.11 sets only the Product , Categories , and  \nSuppliers  properties. Listing 31.12 adds the action methods that will create data to \nthe Home  controller.\nListing 31.12    Adding actions in the HomeController.cs file in the Controllers folder \nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n934 chapter  31 Creating form applications \n    [AutoValidateAntiforgeryToken]\n    public class HomeController : Controller {\n        private DataContext context;\n        private IEnumerable<Category> Categories => context.Categories;\n        private IEnumerable<Supplier> Suppliers => context.Suppliers;\n        public HomeController(DataContext data) {\n            context = data;\n        }\n        public IActionResult Index() {\n            return View(context.Products.\n                Include(p => p.Category).Include(p => p.Supplier));\n        }\n        public async Task<IActionResult> Details(long id) {\n            Product? p = await context.Products.\n                Include(p => p.Category).Include(p => p.Supplier)\n                .FirstOrDefaultAsync(p => p.ProductId == id) \n                    ?? new () { Name = string.Empty };\n            ProductViewModel model = ViewModelFactory.Details(p);\n            return View(""ProductEditor"", model);\n        }\n        public IActionResult Create() {\n            return View(""ProductEditor"",\n                ViewModelFactory.Create(new () { Name = string.Empty }, \n                    Categories, Suppliers));\n        }\n        [HttpPost]\n        public async Task<IActionResult> Create(\n                [FromForm] Product product) {\n            if (ModelState.IsValid) {\n                product.ProductId = default;\n                product.Category = default;\n                product.Supplier = default;\n                context.Products.Add(product);\n                await context.SaveChangesAsync();\n                return RedirectToAction(nameof(Index));\n            }\n            return View(""ProductEditor"",\n                ViewModelFactory.Create(product, Categories, Suppliers));\n        }\n    }\n}\nThere are two Create  methods, which are differentiated by the HttpPost  attribute \nand method parameters. HTTP GET requests will be handled by the first method, \nwhich selects the ProductEditor  view and provides it with a ProductViewModel  \nobject. When the user submits the form, it will be received by the second method, \nwhich relies on model binding to receive the data and model validation to ensure the \ndata is valid. \n 935 Creating an MVC forms application \nIf the data passes validation, then I prepare the object for storage in the database by \nresetting three properties, like this:\n...\nproduct.ProductId = default;\nproduct.Category = default;\nproduct.Supplier = default;\n...\nEntity Framework Core configures the database so that primary keys are allocated by \nthe database server when new data is stored. If you attempt to store an object and pro-\nvide a ProductId  value other than zero, then an exception will be thrown. \nI reset the Category  and Supplier  properties to prevent Entity Framework Core \nfrom trying to deal with related data when storing an object. Entity Framework Core is \ncapable of processing related data, but it can produce unexpected outcomes. (I show \nyou how to create related data in the “Creating New Related Data Objects” section, later \nin this chapter.)\nNotice I call the View  method with arguments when validation fails, like this:  \n...\nreturn View(""ProductEditor"", \n    ViewModelFactory.Create(product, Categories, Suppliers) );\n...\nI do this because the view model object expected by the view isn’t the same data type \nthat I have extracted from the request using model binding. Instead, I create a new \nview model object that incorporates the model bound data and passes this to the View  \nmethod.\nRestart ASP.NET Core, request http://localhost:5000/controllers, and click Create. \nFill out the form and click the Create button to submit the data. The new object will \nbe stored in the database and displayed when the browser is redirected to the Index  \naction, as shown in figure 31.3.\nFigure 31.3    \nCreating a \nnew object\nNotice that select  elements allow the user to select the values for the CategoryId  \nand SupplierId  properties, using the category and supplier names, like this:",6235
389-31.2.4 Editing data.pdf,389-31.2.4 Editing data,"936 chapter  31 Creating form applications \n...\n<select asp-for=""Product.SupplierId"" class=""form-control"" \n        disabled=""@Model?.ReadOnly""\n        asp-items=""@(new SelectList(Model?.Suppliers, \n            ""SupplierId"", ""Name""))"">\n    <option value="""" disabled selected>Choose a Supplier</option>\n</select>\n...\nIn chapter 30, I used input  elements to allow the value of these properties to be set \ndirectly, but that was because I wanted to demonstrate different types of validation. In \nreal applications, it is a good idea to provide the user with restricted choices when the \napplication already has the data it expects the user to choose from. Making the user \nenter a valid primary key, for example, makes no sense in a real project because the \napplication can easily provide the user with a list of those keys to choose from, as shown \nin figure 31.4. \nTIP    I show you different techniques for creating related data in the “Creating \nnew related data objects” section.\nFigure 31.4    \nPresenting the \nuser with a \nchoice\n31.2.4  Editing data\nThe process for editing data is similar to creating data. The first step is to add a new \nmethod to the view model factory that will configure the way the data is presented to \nthe user, as shown in listing 31.13.  \nListing 31.13    Adding a method in the ViewModelFactory.cs file in the Models folder \nnamespace WebApp.Models {\n    public static class ViewModelFactory {\n        public static ProductViewModel Details(Product p) {\n            return new ProductViewModel {\n                Product = p, Action = ""Details"",\n                ReadOnly = true, Theme = ""info"", ShowAction = false,\n                Categories = p == null || p.Category == null\n                    ? Enumerable.Empty<Category>()\n 937 Creating an MVC forms application \n                    : new List<Category> { p.Category },\n                Suppliers = p == null || p.Supplier == null\n                    ? Enumerable.Empty<Supplier>()\n                    : new List<Supplier> { p.Supplier },\n            };\n        }\n        public static ProductViewModel Create(Product product,\n                IEnumerable<Category> categories, \n                IEnumerable<Supplier> suppliers) {\n            return new ProductViewModel {\n                Product = product, Categories = categories, \n                Suppliers = suppliers\n            };\n        }\n        public static ProductViewModel Edit(Product product,\n                IEnumerable<Category> categories, \n                IEnumerable<Supplier> suppliers) {\n            return new ProductViewModel {\n                Product = product, Categories = categories, \n                Suppliers = suppliers,\n                Theme = ""warning"", Action = ""Edit""\n            };\n        }\n    }\n}\nThe next step is to add the action methods to the Home  controller that will display the \ncurrent properties of a Product  object to the user and receive the changes the user \nmakes, as shown in listing 31.14.\nListing 31.14    Adding action methods in the HomeController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class HomeController : Controller {\n        private DataContext context;\n        private IEnumerable<Category> Categories => context.Categories;\n        private IEnumerable<Supplier> Suppliers => context.Suppliers;\n        public HomeController(DataContext data) {\n            context = data;\n        }\n        // ...other action methods omitted for brevity...\n        public async Task<IActionResult> Edit(long id) {\n938 chapter  31 Creating form applications \n            Product? p = await context.Products.FindAsync(id);\n            if (p != null) {\n                ProductViewModel model = \n                    ViewModelFactory.Edit(p, Categories, Suppliers);\n                return View(""ProductEditor"", model);\n            } \n            return NotFound();\n        }\n        [HttpPost]\n        public async Task<IActionResult> Edit(\n                [FromForm] Product product) {\n            if (ModelState.IsValid) {\n                product.Category = default;\n                product.Supplier = default;\n                context.Products.Update(product);\n                await context.SaveChangesAsync();\n                return RedirectToAction(nameof(Index));\n            }\n            return View(""ProductEditor"",\n                ViewModelFactory.Edit(product, Categories, Suppliers));\n        }\n    }\n}\nTo see the editing feature at work, restart ASP.NET Core, navigate to http://  \nlocalhost:5000/controllers, and click one of the Edit buttons. Change one or more \nproperty values and submit the form. The changes will be stored in the database and \nreflected in the list displayed when the browser is redirected to the Index  action, as \nshown in figure 31.5.\nFigure 31.5    \nEditing a product\nNotice that the ProductId  property cannot be changed. Attempting to change the \nprimary key of an object should be avoided because it interferes with the Entity Frame-\nwork Core understanding of the identity of its objects. If you can’t avoid changing the \nprimary key, then the safest approach is to delete the existing object and store a new \none.",5414
390-31.3 Creating a Razor Pages forms application.pdf,390-31.3 Creating a Razor Pages forms application,"939 Creating an MVC forms application \n31.2.5  Deleting data \nThe final basic operation is removing objects from the database. By now the pattern \nwill be clear, and the first step is to add a method to create a view model object to deter-\nmine how the data is presented to the user, as shown in listing 31.15.  \nListing 31.15    Adding a method in the ViewModelFactory.cs file in the Models folder\nnamespace WebApp.Models {\n    public static class ViewModelFactory {\n        // ...other methods omitted for brevity...\n        public static ProductViewModel Delete(Product p,\n                IEnumerable<Category> categories, \n                IEnumerable<Supplier> suppliers) {\n            return new ProductViewModel {\n                Product = p, Action = ""Delete"",\n                ReadOnly = true, Theme = ""danger"",\n                Categories = categories, Suppliers = suppliers\n            };\n        }\n    }\n}\nListing 31.16 adds the action methods to the Home  controller that will respond to the \nGET request by displaying the selected object and the POST request to remove that \nobject from the database.\nListing 31.16    Adding action methods in the HomeController.cs file in the Controllers \nfolder\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing WebApp.Models;\nnamespace WebApp.Controllers {\n    [AutoValidateAntiforgeryToken]\n    public class HomeController : Controller {\n        private DataContext context;\n        private IEnumerable<Category> Categories => context.Categories;\n        private IEnumerable<Supplier> Suppliers => context.Suppliers;\n        public HomeController(DataContext data) {\n            context = data;\n        }\n        // ...other action methods removed for brevity...\n        public async Task<IActionResult> Delete(long id) {\n            Product? p = await context.Products.FindAsync(id);\n940 chapter  31 Creating form applications \n            if (p != null) {\n                ProductViewModel model = ViewModelFactory.Delete(\n                    p, Categories, Suppliers);\n                return View(""ProductEditor"", model);\n            }\n            return NotFound();\n        }\n        [HttpPost]\n        public async Task<IActionResult> Delete(Product product) {\n            context.Products.Remove(product);\n            await context.SaveChangesAsync();\n            return RedirectToAction(nameof(Index));\n        }\n    }\n}\nThe model binding process creates a Product  object from the form data, which is \npassed to Entity Framework Core to remove from the database. Once the data has \nbeen removed from the database, the browser is redirected to the Index  action, as \nshown in figure 31.6.\nFigure 31.6    \nDeleting data\n31.3 Creating a Razor Pages forms application \nWorking with Razor Forms relies on similar techniques as the controller examples, \nalbeit broken up into smaller chunks of functionality. As you will see, the main diffi-\nculty is preserving the modular nature of Razor Pages without duplicating code and \nmarkup. The first step is to create the Razor Page that will display the list of Product  \nobjects and provide the links to the other operations. Add a Razor Page named Index \n.cshtml  to the Pages  folder with the content shown in listing 31.17.  \nListing 31.17    The contents of the Index.cshtml file in the Pages folder\n@page ""/pages/{id:long?}""\n@model IndexModel\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n 941 Creating a Razor Pages forms application \n<div class=""m-2"">\n    <h4 class=""bg-primary text-white text-center p-2"">Products</h4>\n    <table class=""table table-sm table-bordered table-striped"">\n        <thead>\n            <tr>\n                <th>ID</th><th>Name</th><th>Price</th>\n                <th>Category</th><th></th>\n            </tr>\n        </thead>\n        <tbody>\n            @foreach (Product p in Model.Products) {\n                <tr>\n                    <td>@p.ProductId</td>\n                    <td>@p.Name</td>\n                    <td>@p.Price</td>\n                    <td>@p.Category?.Name</td>\n                    <td class=""text-center"">\n                        <a asp-page=""Details"" asp-route-id=""@p.ProductId""\n                           class=""btn btn-sm btn-info"">Details</a>\n                        <a asp-page=""Edit"" asp-route-id=""@p.ProductId""\n                           class=""btn btn-sm btn-warning"">Edit</a>\n                        <a asp-page=""Delete"" asp-route-id=""@p.ProductId""\n                           class=""btn btn-sm btn-danger"">Delete</a>\n                    </td>\n                </tr>\n            }\n        </tbody>\n    </table>\n    <a asp-page=""Create"" class=""btn btn-primary"">Create</a>\n</div>\n@functions {\n    public class IndexModel: PageModel {\n        private DataContext context;\n        public IndexModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        public IEnumerable<Product> Products { get; set; }\n            = Enumerable.Empty<Product>();\n        public void OnGetAsync(long id = 1) {\n            Products = context.Products\n                .Include(p => p.Category).Include(p => p.Supplier);\n        }\n    }\n}\nThis view part of the page displays a table populated with the details of the Prod-\nuct objects obtained from the database by the page model. Use a browser to request \nhttp://localhost:5000/pages, and you will see the response shown in figure 31.7.",5517
391-31.3.1 Creating common functionality.pdf,391-31.3.1 Creating common functionality,"942 chapter  31 Creating form applications \nAlongside the details of the Product  objects, the page displays anchor elements that \nnavigate to other Razor Pages, which I define in the sections that follow.\nFigure 31.7    \nListing data \nusing a Razor \nPage\n31.3.1  Creating common functionality \nI don’t want to duplicate the same HTML form and supporting code in each of the \npages required by the example application. Instead, I am going to define a partial view \nthat defines the HTML form and a base class that defines the common code required \nby the page model classes. For the partial view, add a Razor View named _Product -\nEditor.cshtml  to the Pages  folder with the content shown in listing 31.18.\nUsing multiple page handler methods\nThe asp-page-handler  attribute can be used to specify the name of a handler \nmethod, which allows a Razor Page to be used for more than one operation. I don’t like \nthis feature because the result is too close to a standard MVC controller and undermines \nthe self-contained and modular aspects of Razor Page development that I like. \nThe approach I prefer is, of course, the one that I have taken in this chapter, which is to \nconsolidate common content in partial views and a shared base class. Either approach \nworks, and I recommend you try both to see which suits you and your project. \nListing 31.18    The contents of the _ProductEditor.cshtml file in the Pages folder\n@model ProductViewModel\n<partial name=""_Validation"" />\n<h5 class=""bg-@Model?.Theme text-white text-center p-2"">@Model?.Action</h5>\n<form asp-page=""@Model?.Action"" method=""post"">\n    <div class=""form-group"">\n 943 Creating a Razor Pages forms application \n        <label asp-for=""Product.ProductId""></label>\n        <input class=""form-control"" asp-for=""Product.ProductId"" \n            readonly />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.Name""></label>\n        <div>\n            <span asp-validation-for=""Product.Name"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Product.Name""\n               readonly=""@Model?.ReadOnly"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.Price""></label>\n        <div>\n            <span asp-validation-for=""Product.Price"" class=""text-danger"">\n            </span>\n        </div>\n        <input class=""form-control"" asp-for=""Product.Price""\n               readonly=""@Model?.ReadOnly"" />\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.CategoryId"">Category</label>\n        <div>\n            <span asp-validation-for=""Product.CategoryId"" \n                class=""text-danger"">\n            </span>\n        </div>\n        <select asp-for=""Product.CategoryId"" class=""form-control""\n                disabled=""@Model?.ReadOnly""\n                asp-items=""@(new SelectList(Model?.Categories,\n                    ""CategoryId"", ""Name""))"">\n            <option value="""" disabled selected>Choose a Category</option>\n        </select>\n    </div>\n    <div class=""form-group"">\n        <label asp-for=""Product.SupplierId"">Supplier</label>\n        <div>\n            <span asp-validation-for=""Product.SupplierId"" \n                class=""text-danger"">\n            </span>\n        </div>\n        <select asp-for=""Product.SupplierId"" class=""form-control""\n                disabled=""@Model?.ReadOnly""\n                asp-items=""@(new SelectList(Model?.Suppliers,\n                    ""SupplierId"", ""Name""))"">\n            <option value="""" disabled selected>Choose a Supplier</option>\n        </select>\n    </div>\n    @if (Model?.ShowAction == true) {\n        <button class=""btn btn-@Model.Theme mt-2"" type=""submit"">\n            @Model.Action\n        </button>\n    }\n    <a class=""btn btn-secondary mt-2"" asp-page=""Index"">Back</a>\n</form>\n944 chapter  31 Creating form applications \nThe partial view uses the ProductViewModel  class as its model type and relies on the \nbuilt-in tag helpers to present input  and select  elements for the properties defined \nby the Product  class. This is the same content used earlier in the chapter, except with \nthe asp-action  attribute replaced with asp-page  to specify the target for the form  \nand anchor  elements.\nTo define the page model base class, add a class file named EditorPageModel.cs  to \nthe Pages  folder and use it to define the class shown in listing 31.19.  \nListing 31.19    The contents of the EditorPageModel.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing WebApp.Models;\nnamespace WebApp.Pages {\n    public class EditorPageModel : PageModel {\n        public EditorPageModel(DataContext dbContext) {\n            DataContext = dbContext;\n        }\n        public DataContext DataContext { get; set; }\n        public IEnumerable<Category> Categories => DataContext.Categories;\n        public IEnumerable<Supplier> Suppliers => DataContext.Suppliers;\n        public ProductViewModel? ViewModel { get; set; }\n    }\n}\nThe properties defined by this class are simple, but they will help simplify the page \nmodel classes of the Razor Pages that handle each operation.\nAll the Razor Pages required for this example depend on the same namespaces. Add \nthe expressions shown in listing 31.20 to the _ViewImports.cshtml  file in the Pages  \nfolder to avoid duplicate expressions in the individual pages. \nTIP    Make sure you alter the _ViewImports.cshtml  file in the Pages  folder and \nnot the file with the same name in the Views  folder.\nListing 31.20    Adding namespaces in the _ViewImports.cshtml file in the Pages folder\n@namespace WebApp.Pages\n@using WebApp.Models\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@addTagHelper *, WebApp\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n@using System.Text.Json\n@using Microsoft.AspNetCore.Http",5941
392-31.3.2 Defining pages for the CRUD operations.pdf,392-31.3.2 Defining pages for the CRUD operations,"945 Creating a Razor Pages forms application \n31.3.2  Defining pages for the CRUD operations\nWith the partial view and shared base class in place, the pages that handle individual \noperations are simple. Add a Razor Page named Details.cshtml  to the Pages  folder \nwith the code and content shown in listing 31.21.  \nListing 31.21    The contents of the Details.cshtml file in the Pages folder\n@page ""/pages/details/{id}""\n@model DetailsModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n    public class DetailsModel : EditorPageModel {\n        public DetailsModel(DataContext dbContext) : base(dbContext) { }\n        public async Task OnGetAsync(long id) {\n            Product? p = await DataContext.Products.\n                Include(p => p.Category).Include(p => p.Supplier)\n                .FirstOrDefaultAsync(p => p.ProductId == id);\n            ViewModel = ViewModelFactory.Details(p \n                    ?? new () { Name = string.Empty});\n        }\n    }\n}\nThe constructor receives an Entity Framework Core context object, which it passes to \nthe base class. The handler method responds to requests by querying the database \nand using the response to create a ProductViewModel  object using the ViewModel -\nFactory  class. \nAdd a Razor Page named Create.cshtml  to the Pages  folder with the code and \ncontent shown in listing 31.22.  \nTIP    Using a partial view means that the asp-for  attributes set element names \nwithout an additional prefix. This allows me to use the FromForm  attribute for \nmodel binding without using the Name  argument.\nListing 31.22    The contents of the Create.cshtml file in the Pages folder \n@page ""/pages/create""\n@model CreateModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n946 chapter  31 Creating form applications \n    public class CreateModel : EditorPageModel {\n        public CreateModel(DataContext dbContext) : base(dbContext) { }\n        public void OnGet() {\n            ViewModel = ViewModelFactory.Create(\n                new () { Name = string.Empty }, Categories, Suppliers);\n        }\n        public async Task<IActionResult> OnPostAsync(\n                [FromForm] Product product) {\n            if (ModelState.IsValid) {\n                product.ProductId = default;\n                product.Category = default;\n                product.Supplier = default;\n                DataContext.Products.Add(product);\n                await DataContext.SaveChangesAsync();\n                return RedirectToPage(nameof(Index));\n            }\n            ViewModel = ViewModelFactory.Create(product, \n                Categories, Suppliers);\n            return Page();\n        }\n    }\n}\nAdd a Razor Page named Edit.cshtml  to the Pages  folder with the code and content \nshown in listing 31.23.  \nListing 31.23    The contents of the Edit.cshtml file in the Pages folder \n@page ""/pages/edit/{id}""\n@model EditModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n    public class EditModel : EditorPageModel {\n        public EditModel(DataContext dbContext) : base(dbContext) { }\n        public async Task OnGetAsync(long id) {\n            Product p = await this.DataContext.Products.FindAsync(id)\n                ?? new () { Name = string.Empty };\n            ViewModel = ViewModelFactory.Edit(p, Categories, Suppliers);\n        }\n        public async Task<IActionResult> OnPostAsync(\n                [FromForm] Product product) {\n            if (ModelState.IsValid) {\n                product.Category = default;\n                product.Supplier = default;\n 947 Creating a Razor Pages forms application \n                DataContext.Products.Update(product);\n                await DataContext.SaveChangesAsync();\n                return RedirectToPage(nameof(Index));\n            }\n            ViewModel = ViewModelFactory.Edit(product, \n                Categories, Suppliers);\n            return Page();\n        }\n    }\n}\nAdd a Razor Page named Delete.cshtml  to the Pages  folder with the code and con-\ntent shown in listing 31.24.  \nListing 31.24    The contents of the Delete.cshtml file in the Pages folder\n@page ""/pages/delete/{id}""\n@model DeleteModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n    public class DeleteModel : EditorPageModel {\n        public DeleteModel(DataContext dbContext) : base(dbContext) { }\n        public async Task OnGetAsync(long id) {\n            ViewModel = ViewModelFactory.Delete(\n                await DataContext.Products.FindAsync(id) \n                    ?? new () { Name = string.Empty },\n                Categories, Suppliers);\n        }\n        public async Task<IActionResult> OnPostAsync(\n                [FromForm] Product product) {\n            DataContext.Products.Remove(product);\n            await DataContext.SaveChangesAsync();\n            return RedirectToPage(nameof(Index));\n        }\n    }\n}\nRestart ASP.NET Core and navigate to http://localhost:5000/pages, and you will be \nable to click the links to view, create, edit, and remove data, as shown in figure 31.8.",5305
393-31.4 Creating new related data objects.pdf,393-31.4 Creating new related data objects,,0
394-31.4.1 Providing the related data in the same request.pdf,394-31.4.1 Providing the related data in the same request,"948 chapter  31 Creating form applications \nFigure 31.8    Using Razor Pages\n31.4 Creating new related data objects\nSome applications will need to allow the user to create new related data so that, for \nexample, a new Category  can be created along with a Product  in that Category . \nThere are two ways to approach this problem, as described in the sections that follow.  \n31.4.1  Providing the related data in the same request\nThe first approach is to ask the user to provide the data required to create the related \ndata in the same form. For the example application, this means collecting details for \na Category  object in the same form that the user enters the values for the Product  \nobject.\nThis can be a useful approach for simple data types, where only a small amount of \ndata is required to create the related object but is not well suited for types with many \nproperties. \nI prefer to define the HTML elements for the related data type in their own partial \nview. Add a Razor View named _CategoryEditor.cshtml  to the Pages  folder with the \ncontent shown in listing 31.25.  \nListing 31.25    The contents of the _CategoryEditor.cshtml file in the Pages folder\n@model Product\n<script type=""text/javascript"">\n    window.addEventListener(""DOMContentLoaded"", () => {\n        function setVisibility(visible) {\n            document.getElementById(""categoryGroup"").hidden = !visible;\n            input = document.getElementById(""categoryInput"")\n            if (visible) {\n                input.removeAttribute(""disabled"");\n            } else {\n                input.setAttribute(""disabled"", ""disabled"");\n 949 Creating new related data objects\n            }                \n        }\n        setVisibility(false);\n        document.querySelector(""select[name='Product.CategoryId']"")\n            .addEventListener(""change"", (event) => \n                setVisibility(event.target.value === ""-1"")\n            );\n    });\n</script>\n<div class=""form-group bg-info mt-2 p-1"" id=""categoryGroup"">\n    @{ #pragma warning disable CS8602 } \n    <label class=""text-white"" asp-for=""Category.Name"">\n        New Category Name\n    </label>\n    <input class=""form-control"" asp-for=""Category.Name"" value="""" \n        id=""categoryInput"" />\n    @{ #pragma warning restore CS8602 } \n</div>\nThe Category  type requires only one property, which the user will provide using a stan-\ndard input  element. The script  element in the partial view contains JavaScript code \nthat hides the new elements until the user selects an option  element that sets a value \nof -1 for the Product.CategoryId  property. (Using JavaScript is entirely optional, \nbut it helps to emphasize the purpose of the new elements.)\nListing 31.26 adds the partial view to the editor, along with the option  element that \nwill display the elements for creating a new Category  object.\nListing 31.26    Adding elements in the _ProductEditor.cshtml file in the Pages folder\n...\n<div class=""form-group"">\n    <label asp-for=""Product.CategoryId"">Category</label>\n    <div>\n        <span asp-validation-for=""Product.CategoryId"" \n            class=""text-danger"">\n        </span>\n    </div>\n    <select asp-for=""Product.CategoryId"" class=""form-control""\n            disabled=""@Model?.ReadOnly""\n            asp-items=""@(new SelectList(Model?.Categories,\n                ""CategoryId"", ""Name""))"">\n        <option value=""-1"">Create New Category...</option>\n        <option value="""" disabled selected>Choose a Category</option>\n    </select>\n</div>\n<partial name=""_CategoryEditor"" for=""Product"" />\n<div class=""form-group"">\n    <label asp-for=""Product.SupplierId"">Supplier</label>\n    <div>\n        <span asp-validation-for=""Product.SupplierId"" \n            class=""text-danger"">\n        </span>\n    </div>\n950 chapter  31 Creating form applications \n    <select asp-for=""Product.SupplierId"" class=""form-control""\n            disabled=""@Model?.ReadOnly""\n            asp-items=""@(new SelectList(Model?.Suppliers,\n                ""SupplierId"", ""Name""))"">\n        <option value="""" disabled selected>Choose a Supplier</option>\n    </select>\n</div>\n...\nI need the new functionality in multiple pages, so to avoid code duplication, I have \nadded a method that handles the related data to the page model base class, as shown \nin listing 31.27.\nListing 31.27    Adding a method in the EditorPageModel.cs file in the Pages folder\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing WebApp.Models;\nnamespace WebApp.Pages {\n    public class EditorPageModel : PageModel {\n        public EditorPageModel(DataContext dbContext) {\n            DataContext = dbContext;\n        }\n        public DataContext DataContext { get; set; }\n        public IEnumerable<Category> Categories => DataContext.Categories;\n        public IEnumerable<Supplier> Suppliers => DataContext.Suppliers;\n        public ProductViewModel? ViewModel { get; set; }\n        protected async Task CheckNewCategory(Product product) {\n            if (product.CategoryId == -1\n                    && !string.IsNullOrEmpty(product.Category?.Name)) {\n                DataContext.Categories.Add(product.Category);\n                await DataContext.SaveChangesAsync();\n                product.CategoryId = product.Category.CategoryId;\n                ModelState.Clear();\n                TryValidateModel(product);\n            }\n        }\n    }\n}\nThe new code creates a Category  object using the data received from the user and \nstores it in the database. The database server assigns a primary key to the new object, \nwhich Entity Framework Core uses to update the Category  object. This allows me to \nupdate the CategoryId  property of the Product  object and then re-validate the model \ndata, knowing that the value assigned to the CategoryId  property will pass validation \nbecause it corresponds to the newly allocated key. To integrate the new functionality \ninto the Create  page, add the statement shown in listing 31.28.\n 951 Creating new related data objects\nListing 31.28    Adding a statement in the Create.cshtml file in the Pages folder \n@page ""/pages/create""\n@model CreateModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n    public class CreateModel : EditorPageModel {\n        public CreateModel(DataContext dbContext) : base(dbContext) { }\n        public void OnGet() {\n            ViewModel = ViewModelFactory.Create(\n                new () { Name = string.Empty }, Categories, Suppliers);\n        }\n        public async Task<IActionResult> OnPostAsync(\n                [FromForm] Product product) {\n            await CheckNewCategory(product);\n            if (ModelState.IsValid) {\n                product.ProductId = default;\n                product.Category = default;\n                product.Supplier = default;\n                DataContext.Products.Add(product);\n                await DataContext.SaveChangesAsync();\n                return RedirectToPage(nameof(Index));\n            }\n            ViewModel = ViewModelFactory.Create(product, \n                Categories, Suppliers);\n            return Page();\n        }\n    }\n}\nAdd the same statement to the handler method in the Edit  page, as shown in listing \n31.29.\nListing 31.29    Adding a statement in the Edit.cshtml file in the Pages folder\n@page ""/pages/edit/{id}""\n@model EditModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n    public class EditModel : EditorPageModel {\n        public EditModel(DataContext dbContext) : base(dbContext) { }",7675
395-31.4.2 Breaking out to create new data.pdf,395-31.4.2 Breaking out to create new data,"952 chapter  31 Creating form applications \n        public async Task OnGetAsync(long id) {\n            Product p = await this.DataContext.Products.FindAsync(id)\n                ?? new () { Name = string.Empty };\n            ViewModel = ViewModelFactory.Edit(p, Categories, Suppliers);\n        }\n        public async Task<IActionResult> OnPostAsync(\n                [FromForm] Product product) {\n            await CheckNewCategory(product);\n            if (ModelState.IsValid) {\n                product.Category = default;\n                product.Supplier = default;\n                DataContext.Products.Update(product);\n                await DataContext.SaveChangesAsync();\n                return RedirectToPage(nameof(Index));\n            }\n            ViewModel = ViewModelFactory.Edit(product, \n                Categories, Suppliers);\n            return Page();\n        }\n    }\n}\nRestart ASP.NET Core so the page model base class is recompiled and use a browser \nto request http://localhost:5000/pages/edit/1. Click the Category select  element \nand choose Create New Category from the list of options. Enter a new category name \ninto the input element and click the Edit button. When the request is processed, a new \nCategory  object will be stored in the database and associated with the Product  object, \nas shown in figure 31.9.\nFigure 31.9    Creating related data\n31.4.2  Breaking out to create new data\nFor related data types that have their own complex creation process, adding elements \nto the main form can be overwhelming to the user; a better approach is to navigate \n 953 Creating new related data objects\naway from the main form to another controller or page, let the user create the new \nobject, and then return to complete the original task. I will demonstrate this technique \nfor the creation of Supplier  objects, even though the Supplier  type is simple and \nrequires only two values from the user.  \nTo create a form that will let the user create Supplier  objects, add a Razor Page \nnamed SupplierBreakOut.cshtml  to the Pages  folder with the content shown in list-\ning 31.30.\nListing 31.30    The contents of the SupplierBreakOut.cshtml file in the Pages folder\n@page ""/pages/supplier""\n@model SupplierPageModel\n<div class=""m-2"">\n    <h5 class=""bg-secondary text-white text-center p-2"">New Supplier</h5> \n    <form asp-page=""SupplierBreakOut"" method=""post"">\n        <div class=""form-group"">\n            @{ #pragma warning disable CS8602 } \n            <label asp-for=""Supplier.Name""></label>\n            <input class=""form-control"" asp-for=""Supplier.Name""  />\n            @{ #pragma warning restore CS8602 } \n        </div>\n        <div class=""form-group"">\n            @{ #pragma warning disable CS8602 } \n            <label asp-for=""Supplier.City""></label>\n            <input class=""form-control"" asp-for=""Supplier.City""  />\n            @{ #pragma warning restore CS8602 } \n        </div>\n        <button class=""btn btn-secondary mt-2"" type=""submit"">\n            Create\n        </button>\n        <a class=""btn btn-outline-secondary mt-2"" \n                asp-page=""@Model.ReturnPage"" \n                asp-route-id=""@Model.ProductId"">\n            Cancel\n        </a>\n    </form>\n</div>\n@functions {\n    public class SupplierPageModel: PageModel {\n        private DataContext context;\n        public SupplierPageModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        [BindProperty]\n        public Supplier? Supplier { get; set; }\n        public string? ReturnPage { get; set; }\n        public string? ProductId { get; set; }\n954 chapter  31 Creating form applications \n        public void OnGet([FromQuery(Name=""Product"")] Product product, \n                string returnPage) {\n            TempData[""product""] = Serialize(product);\n            TempData[""returnAction""] =  ReturnPage = returnPage;\n            TempData[""productId""] = ProductId \n                = product.ProductId.ToString();\n        }\n        public async Task<IActionResult> OnPostAsync() {\n            if (ModelState.IsValid && Supplier != null) {\n                context.Suppliers.Add(Supplier);\n                await context.SaveChangesAsync();\n                Product? product \n                    = Deserialize(TempData[""product""] as string);\n                if (product != null) {\n                    product.SupplierId = Supplier.SupplierId;\n                    TempData[""product""] = Serialize(product);\n                    string? id = TempData[""productId""] as string;\n                    return RedirectToPage(TempData[""returnAction""] \n                        as string, new { id = id });\n                }\n            }\n            return Page();\n        }\n        private string Serialize(Product p) => \n            JsonSerializer.Serialize(p);\n        private Product? Deserialize(string? json) =>\n            json == null ? null \n                : JsonSerializer.Deserialize<Product>(json);\n    }\n}\nThe user will navigate to this page using a GET request that will contain the details of \nthe Product  the user has provided and the name of the page that the user should be \nreturned to. This data is stored using the temp data feature.\nThis page presents the user with a form containing fields for the Name  and City  \nproperties required to create a new Supplier  object. When the form is submitted, the \nPOST handler method stores a new Supplier  object and uses the key assigned by the \ndatabase server to update the Product  object, which is then stored as temp data again. \nThe user is redirected back to the page from which they arrived.\nListing 31.31 adds elements to the _ProductEditor  partial view that will allow the \nuser to navigate to the new page.\nListing 31.31    Adding elements in the _ProductEditor.cshtml file in the Pages folder \n...\n<div class=""form-group"">\n    <label asp-for=""Product.SupplierId"">\n        Supplier\n        @if (Model?.ReadOnly == false) {\n            <input type=""hidden"" name=""returnPage"" \n                value=""@Model?.Action"" />\n 955 Creating new related data objects\n            <button class=""btn btn-sm btn-outline-primary ml-3 my-1""\n                asp-page=""SupplierBreakOut"" formmethod=""get"" \n                    formnovalidate>\n                Create New Supplier\n            </button>\n        }\n    </label>\n    <div>\n        <span asp-validation-for=""Product.SupplierId"" \n            class=""text-danger"">\n        </span>\n    </div>\n    <select asp-for=""Product.SupplierId"" class=""form-control""\n            disabled=""@Model?.ReadOnly""\n            asp-items=""@(new SelectList(Model?.Suppliers,\n                ""SupplierId"", ""Name""))"">\n        <option value="""" disabled selected>Choose a Supplier</option>\n    </select>\n</div>\n...\nThe new elements add a hidden input  element that captures the page to return to and \na button  element that submits the form data to the SupplierBreakOut  page using a \nGET request, which means the form values will be encoded in the query string (and \nis the reason I used the FromQuery  attribute in listing 31.30). Listing 31.32 shows the \nchange required to the Create  page to add support for retrieving the temp data and \nusing it to populate the Product  form.\nListing 31.32    Retrieving data in the Create.cshtml file in the Pages folder \n@page ""/pages/create""\n@model CreateModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n    public class CreateModel : EditorPageModel {\n        public CreateModel(DataContext dbContext) : base(dbContext) { }\n        public void OnGet() {\n            Product p = TempData.ContainsKey(""product"")\n                ? JsonSerializer.Deserialize<Product>(\n                        (TempData[""product""] as string)!)!\n                : new () { Name = string.Empty };\n            ViewModel = ViewModelFactory.Create(p, Categories, Suppliers);\n        }\n        public async Task<IActionResult> OnPostAsync(\n                [FromForm] Product product) {\n            await CheckNewCategory(product);\n956 chapter  31 Creating form applications \n            if (ModelState.IsValid) {\n                product.ProductId = default;\n                product.Category = default;\n                product.Supplier = default;\n                DataContext.Products.Add(product);\n                await DataContext.SaveChangesAsync();\n                return RedirectToPage(nameof(Index));\n            }\n            ViewModel = ViewModelFactory.Create(product, \n                Categories, Suppliers);\n            return Page();\n        }\n    }\n}\nA similar change is required in the Edit  page, as shown in listing 31.33. (The other \npages do not require a change since the breakout is required only when the user is able \nto create or edit Product  data.)\nListing 31.33    Retrieving data in the Edit.cshtml file in the Pages folder\n@page ""/pages/edit/{id}""\n@model EditModel\n<div class=""m-2"">\n    <partial name=""_ProductEditor"" model=""@Model.ViewModel"" />\n</div>\n@functions {\n    public class EditModel : EditorPageModel {\n        public EditModel(DataContext dbContext) : base(dbContext) { }\n        public async Task OnGetAsync(long id) {\n            Product? p = TempData.ContainsKey(""product"")\n                ? JsonSerializer.Deserialize<Product>(\n                    (TempData[""product""] as string)!)\n                : await this.DataContext.Products.FindAsync(id);\n            ViewModel = ViewModelFactory.Edit(p \n                    ?? new () { Name = string.Empty },\n                Categories, Suppliers);\n        }\n        public async Task<IActionResult> OnPostAsync(\n                [FromForm] Product product) {\n            await CheckNewCategory(product);\n            if (ModelState.IsValid) {\n                product.Category = default;\n                product.Supplier = default;\n                DataContext.Products.Update(product);\n                await DataContext.SaveChangesAsync();\n                return RedirectToPage(nameof(Index));\n            }\n            ViewModel = ViewModelFactory.Edit(product, \n 957 Creating new related data objects\n                Categories, Suppliers);\n            return Page();\n        }\n    }\n}\nThe effect is that the user is presented with a Create New Supplier button, which \nsends the browser to a form that can be used to create a Supplier  object. Once the  \nSupplier  has been stored in the database, the browser is sent back to the originating \npage, and the form is populated with the data the user had entered, and the Supplier  \nselect element is set to the newly created object, as shown in figure 31.10.\nFigure 31.10    Breaking out to create related data\nSummary\n¡ The ASP.NET Core form-handling features can be combined with Entity  \nFramework Core to perform CRUD operations.\n¡ Forms can be created using Razor Views and Razor Pages.\n¡ Care must be taken to ensure consistency when creating related data.",11103
396-Part 4.pdf,396-Part 4,Part 4\nXXXX,12
397-32.1.1 Adding NuGet packages to the project.pdf,397-32.1.1 Adding NuGet packages to the project,"96132Creating the  \nexample project\nThis chapter covers\n¡ Creating an ASP.NET Core project \n¡ Creating a simple data model\n¡ Adding Entity Framework Core to the ASP.NET  \n Core project\n¡ Creating and applying an Entity Framework  \n Core migration\n¡ Adding the Bootstrap CSS package to the   \n project\n¡ Defining a simple request pipeline and services  \n configuration \n¡ Creating an MVC controller and Razor View\n¡ Creating a Razor Page\nIn this chapter, you will create the example project used throughout this part of the \nbook. The project contains a data model that is displayed using simple controllers \nand Razor Pages.\n962 chapter  32 Creating the example project \n32.1 Creating the project\nOpen a new PowerShell command prompt from the Windows Start menu and run the \ncommands shown in listing 32.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 32.1    Creating the project\ndotnet new globaljson --sdk-version 7.0.100 --output Advanced\ndotnet new web --no-https --output Advanced --framework net7.0\ndotnet new sln -o Advanced\ndotnet sln Advanced add Advanced\nIf you are using Visual Studio, open the Advanced.sln  file in the Advanced folder. \nIf you are using Visual Studio Code, open the Advanced folder. Click the Yes button \nwhen prompted to add the assets required for building and debugging the project, as \nshown in figure 32.1. \nFigure 32.1    \nAdding project \nassets\nOpen the launchSettings.json  file in the WebApp/Properties  folder and change \nthe HTTP port and disable automatic browser launching, as shown in listing 32.2.\nListing 32.2    Setting the HTTP port in the launchSettings.json file in the Properties \nfolder\n{\n  ""iisSettings"": {\n    ""windowsAuthentication"": false,\n    ""anonymousAuthentication"": true,\n    ""iisExpress"": {\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""sslPort"": 0\n    }\n  },\n  ""profiles"": {\n    ""WebApp"": {\n      ""commandName"": ""Project"",\n      ""dotnetRunMessages"": true,\n      ""launchBrowser"": false,\n      ""applicationUrl"": ""http://localhost:5000"",\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    },\n    ""IIS Express"": {",2392
398-32.2 Adding a data model.pdf,398-32.2 Adding a data model,"963 Adding a data model\n      ""commandName"": ""IISExpress"",\n      ""launchBrowser"": true,\n      ""environmentVariables"": {\n        ""ASPNETCORE_ENVIRONMENT"": ""Development""\n      }\n    }\n  }\n}\n32.1.1  Adding NuGet packages to the project \nThe data model will use Entity Framework Core to store and query data in a SQL Server \nLocalDB database. To add the NuGet packages for Entity Framework Core, use a Pow-\nerShell command prompt to run the commands shown in listing 32.3 in the Advanced  \nproject folder.  \nListing 32.3    Adding packages to the project \ndotnet add package Microsoft.EntityFrameworkCore.Design --version 7.0.0 \ndotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 7.0.0\nIf you have not followed the examples in earlier chapters, you will need to install the \nglobal tool package that is used to create and manage Entity Framework Core migra-\ntions. Run the commands shown in listing 32.4 to remove any existing version of the \npackage and install the version required for this book.  \nListing 32.4    Installing a global tool package \ndotnet tool uninstall --global dotnet-ef\ndotnet tool install --global dotnet-ef --version 7.0.0\n32.2 Adding a data model\nThe data model for this application will consist of three classes, representing people, \nthe department in which they work, and their location. Create a Models  folder and \nadd to it a class file named Person.cs  with the code in listing 32.5.\nListing 32.5    The contents of the Person.cs file in the Models folder\nnamespace Advanced.Models {\n    public class Person {\n        public long PersonId { get; set; }\n        public string Firstname { get; set; } = String.Empty;\n        public string Surname { get; set; } = String.Empty;\n        public long DepartmentId { get; set; }\n        public long LocationId { get; set; }\n        public Department? Department { get; set; }\n        public Location? Location { get; set; }\n    }\n}\n964 chapter  32 Creating the example project \nAdd a class file named Department.cs  to the Models  folder and use it to define the \nclass shown in listing 32.6.\nListing 32.6    The contents of the Department.cs file in the Models folder \nnamespace Advanced.Models {\n    public class Department {\n        public long Departmentid { get; set; }\n        public string Name { get; set; } = String.Empty;\n        public IEnumerable<Person>? People { get; set; }\n    }\n}\nAdd a class file named Location.cs  to the Models  folder and use it to define the class \nshown in listing 32.7.\nListing 32.7    The contents of the Location.cs file in the Models folder \nnamespace Advanced.Models {\n    public class Location {\n        public long LocationId { get; set; }\n        public string City { get; set; } = string.Empty;\n        public string State { get; set; } = String.Empty;\n        public IEnumerable<Person>? People { get; set; }\n    }\n}\nEach of the three data model classes defines a key property whose value will be allo-\ncated by the database when new objects are stored and defines foreign key properties \nthat define the relationships between the classes. These are supplemented by naviga-\ntion properties that will be used with the Entity Framework Core Include  method to \nincorporate related data into queries. \nTo create the Entity Framework Core context class that will provide access to the \ndatabase, add a file called DataContext.cs  to the Models  folder and add the code \nshown in listing 32.8.  \nListing 32.8    The contents of the DataContext.cs file in the Models folder\nusing Microsoft.EntityFrameworkCore;\nnamespace Advanced.Models {\n    public class DataContext : DbContext {\n        public DataContext(DbContextOptions<DataContext> opts)\n            : base(opts) { }\n        public DbSet<Person> People => Set<Person>();\n        public DbSet<Department> Departments => Set<Department>();\n        public DbSet<Location> Locations => Set<Location>();\n    }\n}",3975
399-32.2.3 Creating and applying the migration.pdf,399-32.2.3 Creating and applying the migration,"965 Adding a data model\nThe context class defines properties that will be used to query the database for Person , \nDepartment , and Location  data. \n32.2.1  Preparing the seed data\nAdd a class called SeedData.cs  to the Models  folder and add the code shown in listing \n32.9 to define the seed data that will be used to populate the database.  \nListing 32.9    The contents of the SeedData.cs file in the Models folder \nusing Microsoft.EntityFrameworkCore;\nnamespace Advanced.Models {\n    public static class SeedData {\n        public static void SeedDatabase(DataContext context) {\n            context.Database.Migrate();\n            if (context.People.Count() == 0 \n                    && context.Departments.Count() == 0 \n                    && context.Locations.Count() == 0) {\n                Department d1 = new () { Name = ""Sales"" };\n                Department d2 = new () { Name = ""Development"" };\n                Department d3 = new () { Name = ""Support"" };\n                Department d4 = new () { Name = ""Facilities"" };\n                context.Departments.AddRange(d1, d2, d3, d4);\n                context.SaveChanges();\n                Location l1 = new () { City = ""Oakland"", State = ""CA"" };\n                Location l2 = new () { City = ""San Jose"", State = ""CA"" };\n                Location l3 = new () { City = ""New York"", State = ""NY"" };\n                context.Locations.AddRange(l1, l2, l3);\n                context.People.AddRange(\n                    new Person {\n                        Firstname = ""Francesca"", Surname = ""Jacobs"",\n                        Department = d2, Location = l1\n                    },\n                    new Person {\n                        Firstname = ""Charles"", Surname = ""Fuentes"",\n                        Department = d2, Location = l3\n                    },\n                    new Person {\n                        Firstname = ""Bright"", Surname = ""Becker"",\n                        Department = d4, Location = l1\n                    },\n                    new Person {\n                        Firstname = ""Murphy"", Surname = ""Lara"",\n                        Department = d1, Location = l3\n                    },\n                    new Person {\n                        Firstname = ""Beasley"", Surname = ""Hoffman"",\n                        Department = d4, Location = l3\n                    },\n                    new Person {\n966 chapter  32 Creating the example project \n                        Firstname = ""Marks"", Surname = ""Hays"",\n                        Department = d4, Location = l1\n                    },\n                    new Person {\n                        Firstname = ""Underwood"", Surname = ""Trujillo"",\n                        Department = d2, Location = l1\n                    },\n                    new Person {\n                        Firstname = ""Randall"", Surname = ""Lloyd"",\n                        Department = d3, Location = l2\n                    },\n                    new Person {\n                        Firstname = ""Guzman"", Surname = ""Case"",\n                        Department = d2, Location = l2\n                    });\n                context.SaveChanges();\n            }\n        }\n    }\n}\nThe static SeedDatabase  method ensures that all pending migrations have been \napplied to the database. If the database is empty, it is seeded with data. Entity Frame-\nwork Core will take care of mapping the objects into the tables in the database, and the \nkey properties will be assigned automatically when the data is stored.\n32.2.2  Configuring Entity Framework Core \nMake the changes to the Program.cs  file shown in listing 32.10, which configure \nEntity Framework Core and set up the DataContext  services that will be used through-\nout this part of the book to access the database.  \nListing 32.10    Configuring the application in the Program.cs file in the Advanced folder\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nvar app = builder.Build();\napp.MapGet(""/"", () => ""Hello World!"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();",4447
400-32.5 Creating a controller and view.pdf,400-32.5 Creating a controller and view,"967 Adding the Bootstrap CSS framework \nTo define the connection string that will be used for the application’s data, add the \nconfiguration settings shown in listing 32.11 in the appsettings.json  file. The con-\nnection string should be entered on a single line.  \nListing 32.11    Defining a connection string in the Advanced/appsettings.json file \n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning"" ,\n      ""Microsoft.EntityFrameworkCore"": ""Information""\n    }\n  },\n  ""AllowedHosts"": ""*"" ,\n  ""ConnectionStrings"": {\n    ""PeopleConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=People; \n‰MultipleActiveResultSets=True""\n  }\n}\nIn addition to the connection string, listing 32.11 increases the logging detail for Entity \nFramework Core so that the SQL queries sent to the database are logged.\n32.2.3  Creating and applying the migration \nTo create the migration that will set up the database schema, use a PowerShell com-\nmand prompt to run the command shown in listing 32.12 in the Advanced  project \nfolder.  \nListing 32.12    Creating an Entity Framework Core migration \ndotnet ef migrations add Initial\nOnce the migration has been created, apply it to the database using the command \nshown in listing 32.13.\nListing 32.13    Applying the migration to the database \ndotnet ef database update\nThe logging messages displayed by the application will show the SQL commands that \nare sent to the database.\nNOTE     If you need to reset the database, then run the dotnet ef database \ndrop --force  command and then the command in listing 32.13.\n32.3 Adding the Bootstrap CSS framework \nFollowing the pattern established in earlier chapters, I will use the Bootstrap CSS frame-\nwork to style the HTML elements produced by the example application. To install the \nBootstrap package, run the commands shown in listing 32.14 in the Advanced  project \nfolder. These commands rely on the Library Manager package.  \n968 chapter  32 Creating the example project \nListing 32.14    Installing the Bootstrap CSS framework \nlibman init -p cdnjs\nlibman install bootstrap@5.2.3 -d wwwroot/lib/bootstrap\nIf you are using Visual Studio, you can install client-side packages by right-clicking \nthe Advanced project item in the Solution Explorer and selecting Add > Client-Side \nLibrary from the pop-up menu. \n32.4 Configuring the services and middleware\nThe example application in this part of the book will respond to requests using both \nMVC controllers and Razor Pages. Add the statements shown in listing 32.15 to the \nProgram.cs  file to configure the services and middleware the application will use.\nListing 32.15    Configuring the application in the Program.cs file in the Advanced folder\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nvar app = builder.Build();\n//app.MapGet(""/"", () => ""Hello World!"");\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nIn addition to mapping the controller route, I have added a route that matches URL \npaths that begin with controllers , which will make it easier to follow the examples \nin later chapters as they switch between controllers and Razor Pages. This is the same \nconvention I adopted in earlier chapters, and I will route URL paths beginning with  \n/pages  to Razor Pages.\n 969 Creating a controller and view\n32.5 Creating a controller and view\nTo display the application’s data using a controller, create a folder named Controllers  \nin the Advanced  project folder and add to it a class file named HomeController.cs , \nwith the content shown in listing 32.16.\nListing 32.16    The contents of the HomeController.cs file in the Controllers folder\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nnamespace Advanced.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        public HomeController(DataContext dbContext) {\n            context = dbContext;\n        }\n        public IActionResult Index([FromQuery] string selectedCity) {\n            return View(new PeopleListViewModel {\n                People = context.People\n                    .Include(p => p.Department).Include(p => p.Location),\n                Cities = context.Locations.Select(l => l.City).Distinct(),\n                SelectedCity = selectedCity\n            });\n        }\n    }\n    public class PeopleListViewModel {\n        public IEnumerable<Person> People { get; set; } \n            = Enumerable.Empty<Person>();\n        public IEnumerable<string> Cities { get; set; } \n            = Enumerable.Empty<string>();\n        public string SelectedCity { get; set; } = String.Empty;\n        public string GetClass(string? city) =>\n            SelectedCity == city ? ""bg-info text-white"" : """";\n    }\n}\nTo provide the controller with a view, create the Views/Home  folder and add to it a \nRazor View named Index.cshtml  with the content shown in listing 32.17.\nListing 32.17    The contents of the Index.cshtml file in the Views/Home folder\n@model PeopleListViewModel\n<h4 class=""bg-primary text-white text-center p-2"">People</h4>\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n970 chapter  32 Creating the example project \n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Dept</th>\n            <th>Location</th>\n        </tr>\n    </thead>\n    <tbody>\n        @foreach (Person p in Model.People) {\n            <tr class=""@Model.GetClass(p.Location?.City)"">\n                <td>@p.PersonId</td>\n                <td>@p.Surname, @p.Firstname</td>\n                <td>@p.Department?.Name</td>\n                <td>@p.Location?.City, @p.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<form asp-action=""Index"" method=""get"">\n    <div class=""form-group"">\n        <label for=""selectedCity"">City</label>\n        <select name=""selectedCity"" class=""form-control"">\n            <option disabled selected>Select City</option>\n            @foreach (string city in Model.Cities) {\n                <option selected=""@(city == Model.SelectedCity)"">\n                    @city\n                </option>\n            }\n        </select>\n    </div>\n    <button class=""btn btn-primary mt-2"" type=""submit"">Select</button>\n</form>\nTo enable tag helpers and add the namespaces that will be available by default in views, \nadd a Razor View Imports file named _ViewImports.cshtml  to the Views  folder with \nthe content shown in listing 32.18.\nListing 32.18    The contents of the _ViewImports.cshtml file in the Views folder\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@using Advanced.Models\n@using Advanced.Controllers\nTo specify the default layout for controller views, add a Razor View Start start file named \n_ViewStart.cshtml  to the Views  folder with the content shown in listing 32.19.\nListing 32.19    The contents of the _ViewStart.cshtml file in the Views folder \n@{\n    Layout = ""_Layout"";\n}\nTo create the layout, create the Views/Shared  folder and add to it a Razor Layout \nnamed _Layout.cshtml  with the content shown in listing 32.20.",7811
401-32.6 Creating a Razor Page.pdf,401-32.6 Creating a Razor Page,"971 Creating a Razor Page\nListing 32.20    The contents of the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\n32.6 Creating a Razor Page\nTo display the application’s data using a Razor Page, create the Pages  folder and add \nto it a Razor Page named Index.cshtml  with the content shown in listing 32.21.\nListing 32.21    The contents of the Index.cshtml file in the Pages folder \n@page ""/pages""\n@model IndexModel\n<h4 class=""bg-primary text-white text-center p-2"">People</h4>\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Dept</th>\n            <th>Location</th>\n        </tr>\n    </thead>\n    <tbody>\n        @foreach (Person p in Model.People) {\n            <tr class=""@Model.GetClass(p.Location?.City)"">\n                <td>@p.PersonId</td>\n                <td>@p.Surname, @p.Firstname</td>\n                <td>@p.Department?.Name</td>\n                <td>@p.Location?.City, @p.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<form asp-page=""Index"" method=""get"">\n    <div class=""form-group"">\n        <label for=""selectedCity"">City</label>\n        <select name=""selectedCity"" class=""form-control"">\n            <option disabled selected>Select City</option>\n972 chapter  32 Creating the example project \n            @foreach (string city in Model.Cities) {\n                <option selected=""@(city == Model.SelectedCity)"">\n                    @city\n                </option>\n            }\n        </select>\n    </div>\n    <button class=""btn btn-primary mt-2"" type=""submit"">Select</button>\n</form>\n@functions {\n    public class IndexModel : PageModel {\n        private DataContext context;\n        public IndexModel(DataContext dbContext) {\n            context = dbContext;\n        }\n        public IEnumerable<Person> People { get; set; } \n            = Enumerable.Empty<Person>();\n        public IEnumerable<string> Cities { get; set; } \n            = Enumerable.Empty<string>();\n        [FromQuery]\n        public string SelectedCity { get; set; } = String.Empty;\n        public void OnGet() {\n            People = context.People.Include(p => p.Department)\n                .Include(p => p.Location);\n            Cities = context.Locations.Select(l => l.City).Distinct();\n        }\n        public string GetClass(string? city) =>\n            SelectedCity == city ? ""bg-info text-white"" : """";\n    }\n}\nTo enable tag helpers and add the namespaces that will be available by default in the \nview section of the Razor Pages, add a Razor View imports file named _ViewImports \n.cshtml  to the Pages  folder with the content shown in listing 32.22.\nListing 32.22    The contents of the _ViewImports.cshtml file in the Pages folder\n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@using Advanced.Models\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\nTo specify the default layout for Razor Pages, add a Razor View start file named  \n_ViewStart.cshtml  to the Pages  folder with the content shown in listing 32.23.",3385
402-33 Using Blazor Server part 1.pdf,402-33 Using Blazor Server part 1,"973 Running the example application \nListing 32.23    The contents of the _ViewStart.cshtml file in the Pages folder \n@{\n    Layout = ""_Layout"";\n}\nTo create the layout, add a Razor Layout named _Layout.cshtml  to the Pages  folder \nwith the content shown in listing 32.24.\nListing 32.24    The contents of the _Layout.cshtml file in the Pages folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        <h5 class=""bg-secondary text-white text-center p-2"">Razor Page</h5>\n        @RenderBody()\n    </div>\n</body>\n</html>\n32.7 Running the example application \nStart the application by running the command shown in listing 32.25 in the Advanced  \nproject folder.\nListing 32.25    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers and http://  localhost:5000/\npages. Select a city using the select element and click the Select button to highlight \nrows in the table, as shown in figure 32.2.\nFigure 32.2 \nRunning the \nexample \napplication\n97433Using Blazor  \nServer, part 1\nThis chapter covers\n¡ Creating Razor Components to add client-side  \n interactivity to ASP.NET Core applications\n¡ Understanding how JavaScript events are used  \n to respond to user interaction\n¡ Managing event propagation in a Razor   \n Component\n¡ Understanding how to define Razor   \n Components \nBlazor adds client-side interactivity to web applications. There are two varieties of \nBlazor, and in this chapter, I focus on Blazor Server. I explain the problem it solves \nand how it works. I show you how to configure an ASP.NET Core application to \nuse Blazor Server and describe the basic features available when using Razor Com-\nponents, which are the building blocks for Blazor Server projects. I describe more \nadvanced Blazor Server features in chapters 34–36, and in chapter 37, I describe \nBlazor WebAssembly, which is the other variety of Blazor. Table 33.1 puts Blazor \nServer in context.\n 975  \nTable 33.1    Putting Blazor Server in context\nQuestion Answer\nWhat is it? Blazor Server uses JavaScript to receive browser events, \nwhich are forwarded to ASP.NET Core and evaluated \nusing C# code. The effect of the event on the state of the \napplication is sent back to the browser and displayed to \nthe user.\nWhy is it useful? Blazor Server can produce a richer and more responsive \nuser experience compared to standard web applications. \nHow is it used? The building block for Blazor Server is the Razor Com-\nponent, which uses a syntax similar to Razor Pages. The \nview section of the Razor Component contains special \nattributes that specify how the application will respond to \nuser interaction.\nAre there any pitfalls \nor limitations?Blazor Server relies on a persistent HTTP connection to \nthe server and cannot function when that connection \nis interrupted. Blazor Server is not supported by older \nbrowsers.\nAre there any \nalternatives?The features described in part 3 of this book can be used \nto create web applications that work broadly but that offer \na less responsive experience. You could also consider a \nclient-side JavaScript framework, such as Angular, React, \nor Vue.js.\nTable 33.2 provides a guide to the chapter.\nTable 33.2    Chapter guide\nProblem Solution Listing\nConfiguring Blazor Use the AddServerSideBlazor  and  \nMapBlazorHub  methods to set up the \nrequired services and middleware and  \nconfigure the JavaScript file.3–6\nCreating a Blazor Component Create a .blazor  file and use it to define \ncode and markup.7\nApplying a component Use a component  element. 8, 9\nHandling events Use an attribute to specify the method or \nexpression that will handle an event.10–15\nCreating a two-way  \nrelationship with an elementCreate a data binding. 16–20\nDefining the code separately \nfrom the markupUse a code-behind class. 21–23\nDefining a component  \nwithout declarative markupUse a Razor Component class. 24, 25",4099
403-33.1 Preparing for this chapter.pdf,403-33.1 Preparing for this chapter,,0
404-33.2 Understanding Blazor Server.pdf,404-33.2 Understanding Blazor Server,"976 chapter  33 Using Blazor Server, part 1 \n33.1 Preparing for this chapter\nThis chapter uses the Advanced project from chapter 32. No changes are required to \nprepare for this chapter.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nAdvanced.csproj  file, and run the command shown in listing 33.1 to drop the \ndatabase.\nListing 33.1    Dropping the database\ndotnet ef database drop --force\nUse the PowerShell command prompt to run the command shown in listing 33.2. \nListing 33.2    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers, which will display a list of \ndata items. Pick a city from the drop-down list and click the Select button to highlight \nelements, as shown in figure 33.1. \nFigure 33.1    \nRunning the \nexample \napplication\n33.2 Understanding Blazor Server\nConsider what happens when you choose a city and click the Select button presented \nby the example application. The browser sends an HTTP GET request that submits a \nform, which is received by either an action method or a handler method, depending \non whether you use the controller or Razor Page. The action or handler renders its \n 977 Understanding Blazor Server\nview, which sends a new HTML document that reflects the selection to the browser, as \nillustrated by figure 33.2.  \nFigure 33.2    Interacting with the example application \nThis cycle is effective but can be inefficient. Each time the Submit button is clicked, \nthe browser sends a new HTTP request to ASP.NET Core. Each request contains a \ncomplete set of HTTP headers that describe the request and the types of responses the \nbrowser is willing to receive. In its response, the server includes HTTP headers that \ndescribe the response and includes a complete HTML document for the browser to \ndisplay. \nThe amount of data sent by the example application is about 3KB on my system, and \nalmost all of it is duplicated between requests. The browser only wants to tell the server \nwhich city has been selected, and the server only wants to indicate which table rows \nshould be highlighted; however, each HTTP request is self-contained, so the browser \nmust parse a complete HTML document each time. The root issue that every interac-\ntion is the same: send a request and get a complete HTML document in return. \nBlazor takes a different approach. A JavaScript library is included in the HTML \ndocument that is sent to the browser. When the JavaScript code is executed, it opens \nan HTTP connection back to the server and leaves it open, ready for user interaction. \nWhen the user picks a value using the select element, for example, details of the selec-\ntion are sent to the server, which responds with just the changes to apply to the existing \nHTML, as shown in figure 33.3. \nFigure 33.3    Interacting with Blazor\nThe persistent HTTP connection minimizes the delay, and replying with just the differ-\nences reduces the amount of data sent between the browser and the server.",3300
405-33.2.1 Understanding the Blazor Server advantages.pdf,405-33.2.1 Understanding the Blazor Server advantages,,0
406-33.2.2 Understanding the Blazor Server disadvantages.pdf,406-33.2.2 Understanding the Blazor Server disadvantages,,0
407-33.2.3 Choosing between Blazor Server and AngularReactVue.js.pdf,407-33.2.3 Choosing between Blazor Server and AngularReactVue.js,,0
408-33.3.1 Configuring ASP.NET Core for Blazor Server.pdf,408-33.3.1 Configuring ASP.NET Core for Blazor Server,"978 chapter  33 Using Blazor Server, part 1 \n33.2.1  Understanding the Blazor Server advantages \nThe biggest attraction of Blazor is that it is based on Razor Pages written in C#. This \nmeans you can increase efficiency and responsiveness without having to learn a new \nframework, such as Angular or React, and a new language, such as TypeScript or Java -\nScript. Blazor is nicely integrated into the rest of ASP.NET Core and is built on features \ndescribed in earlier chapters, which makes it easy to use (especially when compared to \na framework like Angular, which has a dizzyingly steep learning curve).  \n33.2.2  Understanding the Blazor Server disadvantages \nBlazor requires a modern browser to establish and maintain its persistent HTTP con-\nnection. And, because of this connection, applications that use Blazor stop working if \nthe connection is lost, which makes them unsuitable for offline use, where connectiv-\nity cannot be relied on or where connections are slow. These issues are addressed by \nBlazor WebAssembly, described in chapter 36, but, as I explain, this has its own set of \nlimitations.  \n33.2.3  Choosing between Blazor Server and Angular/React/Vue.js\nDecisions between Blazor and one of the JavaScript frameworks should be driven by \nthe development team’s experience and the users’ expected connectivity. If you have \nno JavaScript expertise and have not used one of the JavaScript frameworks, then you \nshould use Blazor, but only if you can rely on good connectivity and modern browsers. \nThis makes Blazor a good choice for line-of-business applications, for example, where \nthe browser demographic and network quality can be determined in advance.\nIf you have JavaScript experience and you are writing a public-facing application, \nthen you should use one of the JavaScript frameworks because you won’t be able to \nmake assumptions about browsers or network quality. (It doesn’t matter which frame-\nwork you choose—I have written books about Angular, React, and Vue.js, and they are \nall excellent. My advice for choosing a framework is to create a simple app in each of \nthem and pick the one whose development model appeals to you the most.)\nIf you are writing a public-facing application and you don’t have JavaScript expe-\nrience, then you have two choices. The safest option is to stick to the ASP.NET Core \nfeatures described in earlier chapters and accept the inefficiencies this can bring. This \nisn’t a terrible choice to make, and you can still produce top-quality applications. A \nmore demanding choice is to learn TypeScript or JavaScript and one of Angular, React, \nor Vue.js—but don’t underestimate the amount of time it takes to master JavaScript or \nthe complexity of these frameworks. \n33.3 Getting started with Blazor \nThe best way to get started with Blazor is to jump right in. In the sections that follow, \nI configure the application to enable Blazor and re-create the functionality offered by \nthe controller and Razor Page. After that, I’ll go right back to basics and explain how \nRazor Components work and the different features they offer.\n 979 Getting started with Blazor \n33.3.1  Configuring ASP .NET Core for Blazor Server\nPreparation is required before Blazor can be used. The first step is to add the services \nand middleware to the Program.cs  file, as shown in listing 33.3.  \nListing 33.3    Configuring the application in the Program.cs file in the Advanced folder\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe “hub” in the MapBlazorHub  method relates to SignalR, which is the part of ASP.\nNET Core that handles the persistent HTTP request. I don’t describe SignalR in this \nbook because it is rarely used directly, but it can be useful if you need ongoing com-\nmunication between clients and the server. See https://docs.microsoft.com/en-us/\naspnet/core/signalr  for details. For this book—and most ASP.NET Core applica-\ntions—it is enough to know that SignalR is used to manage the connections that Blazor \nrelies on.\nadding  the blazor  javascript file to the layout\nBlazor relies on JavaScript code to communicate with the ASP.NET Core server. Add \nthe elements shown in listing 33.4 to the _Layout.cshtml  file in the Views/Shared  \nfolder to add the JavaScript file to the layout used by controller views.  \n980 chapter  33 Using Blazor Server, part 1 \nListing 33.4    Adding elements in the _Layout.cshtml file in the Views/Shared folder\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <base href=""~/"" />  \n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n    <script src=""_framework/blazor.server.js""></script>\n</body>\n</html>\nThe script  element specifies the name of the JavaScript file, and requests for it are \nintercepted by the middleware added to the request pipeline in listing 33.3 so that \nno additional package is required to add the JavaScript code to the project. The base  \nelement must also be added to specify the root URL for the application. The same ele-\nments must be added to the layout used by Razor Pages, as shown in listing 33.5.\nListing 33.5    Adding elements in the _Layout.cshtml file in the Pages folder \n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <base href=""~/"" />\n</head>\n<body>\n    <div class=""m-2"">\n        <h5 class=""bg-secondary text-white text-center p-2"">\n            Razor Page\n        </h5>\n        @RenderBody()\n    </div>\n    <script src=""_framework/blazor.server.js""></script>\n</body>\n</html>\ncreating  the blazor  imports  file \nBlazor requires its own imports file to specify the namespaces that it uses. It is easy \nto forget to add this file to a project, but, without it, Blazor will silently fail. Add a \nfile named _Imports.razor  to the Advanced  folder with the content shown in listing \n33.6. (If you are using Visual Studio, you can use the Razor View imports template to \ncreate this file, but ensure you use the .razor  file extension.)",6937
409-33.3.2 Creating a Razor Component.pdf,409-33.3.2 Creating a Razor Component,"981 Getting started with Blazor \nListing 33.6    The contents of the _Imports.razor file in the Advanced folder\n@using Microsoft.AspNetCore.Components\n@using Microsoft.AspNetCore.Components.Forms\n@using Microsoft.AspNetCore.Components.Routing\n@using Microsoft.AspNetCore.Components.Web\n@using Microsoft.JSInterop\n@using Microsoft.EntityFrameworkCore\n@using Advanced.Models\nThe first five @using  expressions are for the namespaces required for Blazor. The last \ntwo expressions are for convenience in the examples that follow because they will allow \nme to use Entity Framework Core and the classes in the Models  namespace.\n33.3.2  Creating a Razor Component \nThere is a clash in terminology: the technology is Blazor , but the key building block \nis called a Razor Component . Razor Components are defined in files with the .razor  \nextension and must begin with a capital letter. Components can be defined anywhere, \nbut they are usually grouped together to help keep the project organized. Create a \nBlazor  folder in the Advanced  folder and add to it a Razor Component named  \nPeopleList.razor  with the content shown in listing 33.7.  \nListing 33.7    The contents of the PeopleList.razor file in the Blazor folder\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Dept</th>\n            <th>Location</th>\n        </tr>\n    </thead>\n    <tbody>\n        @foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n            <tr class=""@GetClass(p?.Location?.City)"">\n                <td>@p?.PersonId</td>\n                <td>@p?.Surname, @p?.Firstname</td>\n                <td>@p?.Department?.Name</td>\n                <td>@p?.Location?.City, @p?.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<div class=""form-group"">\n    <label for=""city"">City</label>\n    <select name=""city"" class=""form-control"" @bind=""SelectedCity"">\n        <option disabled selected value="""">Select City</option>\n        @foreach (string city in Cities ?? Enumerable.Empty<string>()) {\n            <option value=""@city"" selected=""@(city == SelectedCity)"">\n                @city\n            </option>\n982 chapter  33 Using Blazor Server, part 1 \n        }\n    </select>\n</div>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People =>\n        Context?.People.Include(p => p.Department)\n            .Include(p => p.Location);\n    public IEnumerable<string>? Cities => \n        Context?.Locations.Select(l => l.City);\n    public string SelectedCity { get; set; } = string.Empty;\n    public string GetClass(string? city) =>\n        SelectedCity == city ? ""bg-info text-white"" : """";\n}\nRazor Components are similar to Razor Pages. The view section relies on the Razor \nfeatures you have seen in earlier chapters, with @ expressions to insert data values into \nthe component’s HTML or to generate elements for objects in a sequence, like this:\n...\n@foreach (string city in Cities ?? Enumerable.Empty<string>()) {\n    <option value=""@city"" selected=""@(city == SelectedCity)"">\n        @city\n    </option>\n}\n...\nThis @foreach  expression generates option  elements for each value in the Cities  \nsequence and is identical to the equivalent expression in the controller view and Razor \nPage created in chapter 32.  \nAlthough Razor Components look familiar, there are some important differences. \nThe first is that there is no page model class and no @model  expression. The proper-\nties and methods that support a component’s HTML are defined directly in an @code  \nexpression, which is the counterpart to the Razor Page @functions  expression. To \ndefine the property that will provide the view section with Person  objects, for example, \nI just define a People  property in the @code  section, like this:\n...\npublic IEnumerable<Person>? People =>\n    Context?.People.Include(p => p.Department)\n        .Include(p => p.Location);\n...\nAnd, because there is no page model class, there is no constructor through which to \ndeclare service dependencies. Instead, the dependency injection sets the values of \nproperties that have been decorated with the Inject  attribute, like this:\n...\n[Inject]\npublic DataContext? Context { get; set; }\n...\n 983 Getting started with Blazor \nThe most significant difference is the use of a special attribute on the select  element.\n...\n<select name=""city"" class=""form-control"" @bind=""SelectedCity"" >\n    <option disabled selected value="""">Select City</option>\n...\nThis Blazor attribute creates a data binding between the value of the select  element \nand the SelectedCity  property defined in the @code  section. \nI describe data bindings in more detail in the “Working with Data Bindings” section, \nbut for now, it is enough to know that the value of the SelectedCity  will be updated \nwhen the user changes the value of the select  element.\nRazor components are delivered to the browser as part of a Razor Page or a control-\nler view. Listing 33.8 shows how to use a Razor Component in a controller view. \nListing 33.8    Using a Razor Component in the Index.cshtml file in the Views/ \nHome folder\n@model PeopleListViewModel\n<h4 class=""bg-primary text-white text-center p-2"">People</h4>\n<component type=""typeof(Advanced.Blazor.PeopleList)"" \n    render-mode=""Server"" />\nRazor Components are applied using the component  element, for which there is a tag \nhelper. The component  element is configured using the type  and render-mode  attri-\nbutes. The type  attribute is used to specify the Razor Component. Razor Components \nare compiled into classes just like controller views and Razor Pages. The PeopleList  \ncomponent is defined in the Blazor  folder in the Advanced project, so the type will be \nAdvanced.Blazor.PeopleList , like this:\n...\n<component type="" typeof(Advanced.Blazor.PeopleList) "" \n    render-mode=""Server"" />\n...\nThe render-mode  attribute is used to select how content is produced by the compo-\nnent, using a value from the RenderMode  enum, described in table 33.3.  \nTable 33.3    The RenderMode values\nName Description\nStatic The Razor Component renders its view section as static \nHTML with no client-side support.\nServer The HTML document is sent to the browser with a  \nplaceholder for the component. The HTML displayed by the \ncomponent is sent to the browser over the persistent HTTP \nconnection and displayed to the user.\nServerPrerendered The view section of the component is included in the HTML \nand displayed to the user immediately. The HTML content \nis sent again over the persistent HTTP connection.\n984 chapter  33 Using Blazor Server, part 1 \nFor most applications, the Server  option is a good choice. The Server Prerendered  \nincludes a static rendition of the Razor Component’s view section in the HTML doc-\nument sent to the browser. This acts as placeholder content so that the user isn’t \npresented with an empty browser window while the JavaScript code is loaded and exe-\ncuted. Once the persistent HTTP connection has been established, the placeholder \ncontent is deleted and replaced with a dynamic version sent by Blazor. The idea of \nshowing static content to the user is a good one, but it can be confusing because the \nHTML elements are not wired up to the server-side part of the application, and any \ninteraction from the user either doesn’t work or will be discarded once the live content \narrives. \nTo see Blazor in action, restart ASP.NET Core and use a browser to request http://\nlocalhost:5000/controllers. No form submission is required when using Blazor because \nthe data binding will respond as soon as the select  element’s value is changed, as \nshown in figure 33.4. (You may have to reload the browser to see the Blazor component \nin action.)\nFigure 33.4    \nUsing a Razor \nComponent\nWhen you use the select  element, the value you choose is sent over the persistent \nHTTP connection to the ASP.NET Core server, which updates the Razor Component’s \nSelectedCity  property and re-renders the HTML content. A set of updates is sent to \nthe JavaScript code, which updates the table.\nRazor Components can also be used in Razor Pages. Add a Razor Page named \nBlazor.cshtml  to the Pages  folder and add the content shown in listing 33.9.\nListing 33.9    The contents of the Blazor.cshtml file in the Pages folder\n@page ""/pages/blazor""\n<script type=""text/javascript"">\n    window.addEventListener(""DOMContentLoaded"", () => {\n        document.getElementById(""markElems"").addEventListener(""click"", \n            () => {\n                document.querySelectorAll(""td:first-child"")\n                    .forEach(elem => {\n                        elem.innerText = `M:${elem.innerText}`\n 985 Getting started with Blazor \n                        elem.classList.add(""border"", ""border-dark"");\n                    });\n            });\n    });\n</script>\n<h4 class=""bg-primary text-white text-center p-2"">Blazor People</h4>\n<button id=""markElems"" class=""btn btn-outline-primary mb-2"">\n    Mark Elements\n</button>\n<component type=""typeof(Advanced.Blazor.PeopleList)"" \n    render-mode=""Server"" />\nThe Razor Page in listing 33.9 contains additional JavaScript code that helps demon-\nstrate that only changes are sent, instead of an entirely new HTML table. Restart ASP.\nNET Core and request http://localhost:5000/pages/blazor. Click the Mark Elements \nbutton, and the cells in the ID column will be changed to display different content and \na border. Now use the select  element to pick a different city, and you will see that the \nelements in the table are modified without being deleted, as shown in figure 33.5.\nUnderstanding Blazor connection messages\nWhen you stop ASP.NET Core, you will see an error message in the browser window, which \nindicates the connection to the server has been lost and prevents the user from interact-\ning with the displayed component. Blazor will attempt to reconnect and pick up where it \nleft off when the disconnection is caused by temporary network issues, but it won’t be \nable to do so when the server has been stopped or restarted because the context data \nfor the connection has been lost; you will have to explicitly request a new URL. \nThere is a default reload link in the connection message, but that goes to the default URL \nfor the website, which isn’t useful for this book where I direct you to specific URLs to see \nthe effect of examples. See chapter 34 for details of how to configure the connection \nmessages.\nFigure 33.5    \nDemonstrating \nthat only changes \nare used",10739
410-33.4 Understanding the basic Razor Component features.pdf,410-33.4 Understanding the basic Razor Component features,,0
411-33.4.1 Understanding Blazor events and data bindings.pdf,411-33.4.1 Understanding Blazor events and data bindings,"986 chapter  33 Using Blazor Server, part 1 \n33.4 Understanding the basic Razor Component features\nNow that I have demonstrated how Blazor can be used and how it works, it is time to go \nback to the basics and introduce the features that Razor Components offer. Although \nthe example in the previous section showed how standard ASP.NET Core features can \nbe reproduced using Blazor, there is a much wider set of features available.\n33.4.1  Understanding Blazor events and data bindings\nEvents allow a Razor Component to respond to user interaction, and Blazor uses the \npersistent HTTP connection to send details of the event to the server where it can be \nprocessed. To see Blazor events in action, add a Razor Component named Events \n.razor  to the Blazor  folder with the content shown in listing 33.10.  \nListing 33.10    The contents of the Events.razor file in the Blazor folder\n<div class=""m-2 p-2 border"">\n    <button class=""btn btn-primary"" @onclick=""IncrementCounter"">\n        Increment\n    </button>\n    <span class=""p-2"">Counter Value: @Counter</span>\n</div>\n@code {\n    public int Counter { get; set; } = 1;\n    public void IncrementCounter(MouseEventArgs e) {\n        Counter++;\n    }\n}\nYou register a handler for an event by adding an attribute to an HTML element, where \nthe attribute name is @on, followed by the event name. In the example, I have set up a \nhandler for the click  events generated by a button  element, like this:\n...\n<button class=""btn btn-primary"" @onclick =""IncrementCounter"">\n    Increment\n</button>\n...\nThe value assigned to the attribute is the name of the method that will be invoked \nwhen the event is triggered. The method can define an optional parameter that is \neither an instance of the EventArgs  class or a class derived from EventArgs  that pro-\nvides additional information about the event. \nFor the onclick  event, the handler method receives a MouseEventArgs  object, \nwhich provides additional details, such as the screen coordinates of the click. Table 33.4 \nlists the event description events and the events for which they are used. \n 987 Understanding the basic Razor Component features\nTable 33.4    The EventArgs classes and the events they represent\nClass Events\nChangeEventArgs onchange , oninput\nClipboardEventArgs oncopy , oncut , onpaste\nDragEventArgs ondrag , ondragend , ondragenter , ondragleave , ondragover , \nondragstart , ondrop\nErrorEventArgs onerror\nFocusEventArgs onblur , onfocus , onfocusin , onfocusout\nKeyboardEventArgs onkeydown , onkeypress , onkeyup\nMouseEventArgs onclick , oncontextmenu , ondblclick , onmousedown , onmouse-\nmove , onmouseout , onmouseover , onmouseup , onmousewheel , \nonwheel\nPointerEventArgs ongotpointercapture , onlostpointercapture , onpointer-\ncancel , onpointerdown , onpointerenter , onpointerleave , \nonpointermove , onpointerout , onpointerover , onpointerup\nProgressEventArgs onabort , onload , onloadend , onloadstart , onprogress , \nontimeout\nTouchEventArgs ontouchcancel , ontouchend , ontouchenter , ontouchleave , \nontouchmove , ontouchstart\nEventArgs onactivate , onbeforeactivate , onbeforecopy , onbeforecut , \nonbeforedeactivate , onbeforepaste , oncanplay , oncanplay-\nthrough , oncuechange , ondeactivate , ondurationchange , \nonemptied , onended , onfullscreenchange , onfullscreen -\nerror , oninvalid , onloadeddata , onloadedmetadata , onpause , \nonplay , onplaying , onpointerlockchange , onpointerlock -\nerror , onratechange , onreadystatechange , onreset , \nonscroll , onseeked , onseeking , onselect , onselection-\nchange , onselectstart , onstalled , onstop , onsubmit ,  \nonsuspend , ontimeupdate , onvolumechange , onwaiting\nThe Blazor JavaScript code receives the event when it is triggered and forwards it to \nthe server over the persistent HTTP connection. The handler method is invoked, and \nthe state of the component is updated. Any changes to the content produced by the \ncomponent’s view section will be sent back to the JavaScript code, which will update \nthe content displayed by the browser. \nIn the example, the click  event will be handled by the IncrementCounter  method, \nwhich changes the value of the Counter  property. The value of the Counter  property \nis included in the HTML rendered by the component, so Blazor sends the changes to \nthe browser so that the JavaScript code can update the HTML elements displayed to the \nuser. To display the Events  component, replace the contents of the Blazor.cshtml  \nfile in the Pages  folder, as shown in listing 33.11.\n988 chapter  33 Using Blazor Server, part 1 \nListing 33.11    Using a new component in the Blazor.cshtml file in the Pages folder\n@page ""/pages/blazor""\n<h4 class=""bg-primary text-white text-center p-2"">Events</h4>\n<component type=""typeof(Advanced.Blazor.Events)"" render-mode=""Server"" />\nListing 33.11 changes the type  attribute of the component element and removes the \ncustom JavaScript and the button  element I used to mark elements in the previous \nexample. Restart ASP.NET Core and request http://localhost:5000/pages/blazor \nto see the new component. Click the Increment button, and the click  event will be \nreceived by the Blazor JavaScript code and sent to the server for processing by the \nIncrementCounter  method, as shown in figure 33.6.\nFigure 33.6    \nHandling an \nevent\nhandling  events  from multiple  elements  \nTo avoid code duplication, elements from multiple elements can be received by a sin-\ngle handler method, as shown in listing 33.12.  \nListing 33.12    Handling events in the Events.razor file in the Blazor folder\n<div class=""m-2 p-2 border"">\n    <button class=""btn btn-primary"" \n            @onclick=""@(e => IncrementCounter(e, 0))"">\n        Increment Counter #1\n    </button>\n    <span class=""p-2"">Counter Value: @Counter[0]</span>\n</div>\n<div class=""m-2 p-2 border"">\n    <button class=""btn btn-primary"" \n            @onclick=""@(e => IncrementCounter(e, 1))"">\n        Increment Counter #2\n    </button>\n    <span class=""p-2"">Counter Value: @Counter[1]</span>\n</div>\n@code {\n    public int[] Counter { get; set; } = new int[] { 1, 1 };\n    public void IncrementCounter(MouseEventArgs e, int index) {\n        Counter[index]++;\n    }\n}\n 989 Understanding the basic Razor Component features\nBlazor event attributes can be used with lambda functions that receive the EventArgs  \nobject and invoke a handler method with additional arguments. In this example, I \nhave added an index  parameter to the IncrementCounter  method, which is used \nto determine which counter value should be updated. The value for the argument is \ndefined in the @onclick  attribute, like this:\n...\n<button class=""btn btn-primary"" @onclick="" @(e => IncrementCounter(e, 0)) "">\n...\nThis technique can also be used when elements are generated programmatically, as \nshown in listing 33.13. In this example, I use an @for  expression to generate elements \nand use the loop variable as the argument to the handler method. I have also removed \nthe EventArgs  parameter from the handler method, which isn’t being used.\nAvoiding the handler method name pitfall\nThe most common mistake when specifying an event handler method is to include \nparentheses, like this:  \n...\n<button class=""btn btn-primary"" @onclick="" IncrementCounter() "">\n...\nThe error message this produces will depend on the event handler method. You may see \na warning telling you a formal parameter is missing or that void  cannot be converted to \nan EventCallback . When specifying a handler method, you must specify just the event \nname, like this:\n...\n<button class=""btn btn-primary"" @onclick="" IncrementCounter "">\n...\nYou can specify the method name as a Razor expression, like this:\n...\n<button class=""btn btn-primary"" @onclick="" @IncrementCounter "">\n...\nSome developers find this easier to parse, but the result is the same. A different set \nof rules applies when using a lambda function, which must be defined within a Razor \nexpression, like this:\n...\n<button class=""btn btn-primary"" @onclick="" @( ... ) "">\n...\nWithin the Razor expression, the lambda function is defined as it would be in a C# class, \nwhich means defining the parameters, followed by the ""goes to"" arrow, followed by the \nfunction body, like this:\n...\n<button class=""btn btn-primary"" @onclick="" @((e) => HandleEvent(e, local)) "">\n...\n990 chapter  33 Using Blazor Server, part 1 \n(continued)\nIf you don’t need to use the EventArgs  object, then you can omit the parameter from \nthe lambda function, like this:\n...\n<button class=""btn btn-primary"" @onclick="" @(() =>  \n    IncrementCounter(local)) "">\n...\nYou will quickly become used to these rules as you start to work with Blazor, even if they \nseem inconsistent at first.\nListing 33.13    Generating elements in the Events.razor file in the Blazor folder\n@for (int i = 0; i < ElementCount; i++) {\n    int local = i;\n    <div class=""m-2 p-2 border"">\n        <button class=""btn btn-primary"" \n                @onclick=""@(() => IncrementCounter(local))"">\n            Increment Counter #@(i + 1)\n        </button>\n        <span class=""p-2"">Counter Value: @GetCounter(i)</span>\n    </div>\n}\n@code {\n    public int ElementCount { get; set; } = 4;\n    public Dictionary<int, int> Counters { get; } \n        = new Dictionary<int, int>();\n    public int GetCounter(int index) =>\n        Counters.ContainsKey(index) ? Counters[index] : 0;\n    public void IncrementCounter(int index) =>\n        Counters[index] = GetCounter(index) + 1;\n}\nThe important point to understand about event handlers is that the @onclick  lambda \nfunction isn’t evaluated until the server receives the click  event from the browser. \nThis means care must be taken not to use the loop variable i as the argument to the \nIncrementCounter  method because it will always be the final value produced by the \nloop, which would be 4 in this case. Instead, you must capture the loop variable in a \nlocal variable, like this:\n...\nint local = i;\n...\nThe local variable is then used as the argument to the event handler method in the \nattribute, like this:\n...\n<button class=""btn btn-primary"" @onclick=""@(() => IncrementCounter( local))"">\n...\n 991 Understanding the basic Razor Component features\nThe local variable fixes the value for the lambda function for each of the generated \nelements. Restart ASP.NET Core and use a browser to request http://localhost:5000/\npages/blazor, which will produce the response shown in figure 33.7. The click  events \nproduced by all the button  elements are handled by the same method, but the argu-\nment provided by the lambda function ensures that the correct counter is updated.\nFigure 33.7    \nHandling \nevents from \nmultiple \nelements\nprocessing  events  without  a handler  method  \nSimple event handling can be done directly in a lambda function, without using a han-\ndler method, as shown in listing 33.14.  \nListing 33.14    Handling events in the Events.razor file in the Blazor folder\n@for (int i = 0; i < ElementCount; i++) {\n    int local = i;\n    <div class=""m-2 p-2 border"">\n        <button class=""btn btn-primary"" \n                @onclick=""@(() => IncrementCounter(local))"">\n            Increment Counter #@(i + 1)\n        </button>\n        <button class=""btn btn-info"" \n                @onclick=""@(() => Counters.Remove(local))"">\n            Reset\n        </button>\n        <span class=""p-2"">Counter Value: @GetCounter(i)</span>\n    </div>\n}\n@code {\n    public int ElementCount { get; set; } = 4;\n    public Dictionary<int, int> Counters { get; } \n        = new Dictionary<int, int>();\n    public int GetCounter(int index) => \n        Counters.ContainsKey(index) ? Counters[index] : 0;\n    public void IncrementCounter(int index)  =>\n        Counters[index] = GetCounter(index) + 1;\n}\n992 chapter  33 Using Blazor Server, part 1 \nComplex handlers should be defined as methods, but this approach is more concise \nfor simple handlers. Restart ASP.NET Core and request http://localhost:5000/pages/\nblazor. The Reset buttons remove values from the Counters  collection without relying \non a method in the @code  section of the component, as shown in figure 33.8.\nFigure 33.8    \nHandling events \nin a lambda \nexpression\npreventing  default  events  and event  propagation  \nBlazor provides two attributes that alter the default behavior of events in the browser, \nas described in table 33.5. These attributes, where the name of the event is followed by \na colon and then a keyword, are known as parameters . \nTable 33.5    The event configuration parameters\nName Description\n@on{event}:preventDefault This parameter determines whether the \ndefault event for an element is triggered.\n@on{event}:stopPropagation This parameter determines whether an event \nis propagated to its ancestor elements.\nListing 33.15 demonstrates what these parameters do and why they are useful.\nListing 33.15    Overriding event defaults in the Events.razor file in the Blazor folder\n<form action=""/pages/blazor"" method=""get"">\n    @for (int i = 0; i < ElementCount; i++) {\n        int local = i;\n        <div class=""m-2 p-2 border"">\n            <button class=""btn btn-primary""\n                    @onclick=""@(() => IncrementCounter(local))""\n                    @onclick:preventDefault=""EnableEventParams"">\n                Increment Counter #@(i + 1)\n            </button>\n            <button class=""btn btn-info"" \n                    @onclick=""@(() => Counters.Remove(local))"">\n                Reset\n            </button>\n            <span class=""p-2"">Counter Value: @GetCounter(i)</span>\n        </div>\n    }\n 993 Understanding the basic Razor Component features\n</form>\n<div class=""m-2"" @onclick=""@(() => IncrementCounter(1))"">\n    <button class=""btn btn-primary"" \n            @onclick=""@(() => IncrementCounter(0))""\n            @onclick:stopPropagation=""EnableEventParams"">\n        Propagation Test\n    </button>\n</div>\n<div class=""form-check m-2"">\n    <input class=""form-check-input"" type=""checkbox""\n           @onchange=""@(() => EnableEventParams = !EnableEventParams)"" />\n    <label class=""form-check-label"">Enable Event Parameters</label>\n</div>\n@code {\n    public int ElementCount { get; set; } = 4;\n    public Dictionary<int, int> Counters { get; } \n        = new Dictionary<int, int>();\n    public int GetCounter(int index) =>\n        Counters.ContainsKey(index) ? Counters[index] : 0;\n    public void IncrementCounter(int index) =>\n        Counters[index] = GetCounter(index) + 1;\n    public bool EnableEventParams { get; set; } = false;\n}\nThis example creates two situations in which the default behavior of events in the \nbrowser can cause problems. The first is caused by adding a form  element. By default, \nbutton  elements contained in a form will submit that form when they are clicked, even \nwhen the @onclick  attribute is present. This means that whenever one of the Incre-\nment Counter buttons is clicked, the browser will send the form data to the ASP.NET \nCore server, which will respond with the contents of the Blazor.cshtml  Razor Page. \nThe second problem is demonstrated by an element whose parent also defines an \nevent handler, like this:\n...\n<div class=""m-2"" @onclick=""@(() => IncrementCounter(1))"" >\n    <button class=""btn btn-primary"" @onclick=""@(() => IncrementCounter(0))""\n...\nEvents go through a well-defined lifecycle in the browser, which includes being passed \nup the chain of ancestor elements. In the example, this means clicking the button  will \ncause two counters to be updated, once by the @onclick  handler for the button  ele-\nment and once by the @onclick  handler for the enclosing div element. \nTo see these problems, restart ASP.NET Core and request http://localhost:5000/\npages/blazor. Click an Increment Counter button; you will see that the form is submit-\nted and the page is essentially reloaded. Click the Propagation Test button, and you will \nsee that two counters are updated. Figure 33.9 shows both problems.",16170
412-33.4.2 Working with data bindings.pdf,412-33.4.2 Working with data bindings,"994 chapter  33 Using Blazor Server, part 1 \nFigure 33.9    Problems caused by the default behavior of events in the browser\nThe checkbox in listing 33.15 toggles the property that applies the parameters \ndescribed in table 33.5, with the effect that the form isn’t submitted and only the han-\ndler on the button element receives the event. To see the effect, check the checkbox \nand then click an Increment Counter button and the Propagation Test buttons, which \nproduces the result shown in figure 33.10.\nFigure 33.10    Overriding the default behavior of events in the browser\n33.4.2  Working with data bindings\nEvent handlers and Razor expressions can be used to create a two-way relationship \nbetween an HTML element and a C# value, which is useful for elements that allow \nusers to make changes, such as input  and select  elements. Add a Razor Component \nnamed Bindings.razor  to the Blazor  folder with the content shown in listing 33.16.  \nListing 33.16    The contents of the Bindings.razor file in the Blazor folder\n<div class=""form-group"">\n    <label>City:</label>\n    <input class=""form-control"" value=""@City"" @onchange=""UpdateCity"" />\n</div>\n<div class=""p-2 mb-2"">City Value: @City</div>\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Paris"")"">\n    Paris\n</button>\n 995 Understanding the basic Razor Component features\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Chicago"")"">\n    Chicago\n</button>\n@code {\n    public string? City { get; set; } = ""London"";\n    public void UpdateCity(ChangeEventArgs e) {\n        City = e.Value as string;\n    }\n}\nThe @onchange  attribute registers the UpdateCity  method as a handler for the change  \nevent from the input  element. The events are described using the ChangeEventArgs  \nclass, which provides a Value  property. Each time a change  event is received, the City  \nproperty is updated with the contents of the input  element.\nThe input  element’s value  attribute creates a relationship in the other direction \nso that when the value of the City  property changes, so does the element’s value  attri-\nbute, which changes the text displayed to the user. To apply the new Razor Component, \nchange the component  attribute in the Razor Page, as shown in listing 33.17.\nListing 33.17    Using a Razor Component in the Blazor.cshtml file in the Pages folder \n@page ""/pages/blazor""\n<h4 class=""bg-primary text-white text-center p-2"">Events</h4>\n<component type=""typeof(Advanced.Blazor.Bindings)"" render-mode=""Server"" />\nTo see both parts of the relationship defined by the binding in listing 33.16, restart \nASP.NET Core, navigate to http://localhost:5000/pages/blazor, and edit the content \nof the input  element. The change  event is triggered only when the input  element \nloses the focus, so once you have finished editing, press the Tab key or click outside \nof the input  element; you will see the value you entered displayed through the Razor \nexpression in the div element, as shown on the left of figure 33.11. Click one of the \nbuttons, and the City  property will be changed to Paris  or Chicago , and the selected \nvalue will be displayed by both the div element and the input  element, as shown on \nthe right of the figure.\nFigure 33.11    \nCreating a two-\nway relationship \nbetween an \nelement and a \nproperty\n996 chapter  33 Using Blazor Server, part 1 \nTwo-way relationships involving the change  event can be expressed as data bindings, \nwhich allows both the value and the event to be configured with a single attribute, as \nshown in listing 33.18.  \nListing 33.18    Using a data binding in the Bindings.razor file in the Blazor folder\n<div class=""form-group"">\n    <label>City:</label>\n    <input class=""form-control"" @bind=""City"" />\n</div>\n<div class=""p-2 mb-2"">City Value: @City</div>\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Paris"")"">\n    Paris\n</button>\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Chicago"")"">\n    Chicago\n</button>\n@code {\n    public string? City { get; set; } = ""London"";\n    //public void UpdateCity(ChangeEventArgs e) {\n    //    City = e.Value as string;\n    //}\n}\nThe @bind  attribute is used to specify the property that will be updated when the \nchange event is triggered and that will update the value  attribute when it changes. \nThe effect in listing 33.18 is the same as listing 33.16 but expressed more concisely and \nwithout the need for a handler method or a lambda function to update the property.\nchanging  the binding  event\nBy default, the change  event is used in bindings, which provides reasonable respon-\nsiveness for the user without requiring too many updates from the server. The event \nused in a binding can be changed by using the attributes described in table 33.6.  \nTable 33.6    The binding attributes for specifying an event\nAttribute Description\n@bind-value This attribute is used to select the property for \nthe data binding.\n@bind-value:event This attribute is used to select the event for the \ndata binding.\nThese attributes are used instead of @bind , as shown in listing 33.19, but can be used \nonly with events that are represented with the ChangeEventArgs  class. This means \nthat only the onchange  and oninput  events can be used, at least in the current release. \n 997 Understanding the basic Razor Component features\nListing 33.19    Specifying an event in the Bindings.razor file in the Blazor folder\n<div class=""form-group"">\n    <label>City:</label>\n    <input class=""form-control"" @bind-value=""City""\n           @bind-value:event=""oninput"" />\n</div>\n<div class=""p-2 mb-2"">City Value: @City</div>\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Paris"")"">\n    Paris\n</button>\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Chicago"")"">\n    Chicago\n</button>\n@code {\n    public string? City { get; set; } = ""London"";\n}\nThis combination of attributes creates a binding for the City  property that is updated \nwhen the oninput  event is triggered, which happens after every keystroke, rather \nthan only when the input  element loses the focus. To see the effect, restart ASP.NET \nCore, navigate to http://localhost:5000/pages/blazor, and start typing into the input  \nelement. The City  property will be updated after every keystroke, as shown in figure \n33.12.\nFigure 33.12    \nChanging the \nevent in a data \nbinding\ncreating  datetime bindings\nBlazor has special support for creating bindings for DateTime  properties, allowing \nthem to be expressed using a specific culture or a format string. This feature is applied \nusing the parameters described in table 33.7.  \nT I P     If you have used the @bind-value  and @bind-value:event  attributes \nto select an event, then you must use the @bind-value:culture  and @bind \n-value:format  parameters instead.\n998 chapter  33 Using Blazor Server, part 1 \nTable 33.7    The DateTime parameters\nName Description\n@bind:culture This attribute is used to select a Culture-\nInfo  object that will be used to format the \nDateTime  value.\n@bind:format This attribute is used to specify a data for-\nmatting string that will be used to format the \nDateTime  value.\nListing 33.20 shows the use of these attributes with a DateTime  property.\nNOTE     The formatting strings used in these examples are described at https://\ndocs.microsoft.com/en-us/dotnet/api/system.datetime .\nListing 33.20    Using a DateTime property in the Bindings.razor file in the Blazor folder\n@using System.Globalization\n<div class=""form-group"">\n    <label>City:</label>\n    <input class=""form-control"" @bind-value=""City"" \n        @bind-value:event=""oninput"" />\n</div>\n<div class=""p-2 mb-2"">City Value: @City</div>\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Paris"")"">\n    Paris\n</button>\n<button class=""btn btn-primary"" @onclick=""@(() => City = ""Chicago"")"">\n    Chicago\n</button>\n<div class=""form-group mt-2"">\n    <label>Time:</label>\n    <input class=""form-control my-1"" @bind=""Time"" \n        @bind:culture=""Culture"" @bind:format=""MMM-dd"" />\n    <input class=""form-control my-1"" @bind=""Time"" \n            @bind:culture=""Culture"" />\n    <input class=""form-control"" type=""date"" @bind=""Time"" />\n</div>\n<div class=""p-2 mb-2"">Time Value: @Time</div>\n<div class=""form-group"">\n    <label>Culture:</label>\n    <select class=""form-control"" @bind=""Culture"">\n        <option value=""@CultureInfo.GetCultureInfo(""en-us"")"">\n            en-US\n        </option>\n        <option value=""@CultureInfo.GetCultureInfo(""en-gb"")"">\n            en-GB\n        </option>\n        <option value=""@CultureInfo.GetCultureInfo(""fr-fr"")"">\n 999 Understanding the basic Razor Component features\n            fr-FR\n        </option>\n    </select>\n</div>\n@code {\n    public string? City { get; set; } = ""London"";\n    public DateTime Time { get; set; } \n        = DateTime.Parse(""2050/01/20 09:50"");\n    public CultureInfo Culture { get; set; } \n        = CultureInfo.GetCultureInfo(""en-us"");\n}\nThere are three input elements that are used to display the same DataTime  value, two \nof which have been configured using the attributes from table 33.7. The first element \nhas been configured with a culture and a format string, like this:\n...\n<input class=""form-control my-1"" @bind=""Time"" @bind:culture=""Culture""  \n    @bind:format=""MMM-dd"" />\n...\nThe DateTime  property is displayed using the culture picked in the select  element \nand with a format string that displays an abbreviated month name and the numeric \ndate. The second input  element specifies just a culture, which means the default for-\nmatting string will be used.\n...\n<input class=""form-control my-1"" @bind=""Time"" @bind:culture=""Culture""  />\n...\nTo see how dates are displayed, restart ASP.NET Core, request http://localhost:5000/\npages/blazor, and use the select  element to pick different culture settings. The set-\ntings available represent English as it is used in the United States, English as it used in \nthe United Kingdom, and French as it is used in France. Figure 33.13 shows the format-\nting each produces.\nFigure 33.13    Formatting DateTime values",10227
413-33.5 Using class files to define components.pdf,413-33.5 Using class files to define components,,0
414-33.5.1 Using a code-behind class.pdf,414-33.5.1 Using a code-behind class,"1000 chapter  33 Using Blazor Server, part 1 \nThe initial locale in this example is en-US . When you switch to en-GB , the order in \nwhich the month and date appear changes. When you switch to en-FR , the abbreviated \nmonth name changes. \nLetting the browser format dates \nNotice that the value displayed by the third input  element in listing 33.20 doesn’t \nchange, regardless of the locale you choose. This input  element has neither of the attri-\nbutes described in table 33.7 but does have its type  attribute set to date , like this:\n...\n<input class=""form-control"" type=""date""  @bind=""Time"" />\n...\nYou should not specify a culture or a format string when setting the type attribute to date , \ndatetime-local , month , or time , because Blazor will automatically format date val-\nues into a culture-neutral format that the browser translates into the user’s locale. Figure \n33.11 shows how the date is formatted in the en-US  locale, but the user will see the date \nexpressed in their local convention.\n33.5 Using class files to define components\nIf you don’t like the mix of code and markup that Razor Components supports, you \ncan use C# class files to define part, or all, of the component.\n33.5.1  Using a code-behind class\nThe @code  section of a Razor Component can be defined in a separate class file, known \nas a code-behind class  or code-behind file . Code-behind classes for Razor Components are \ndefined as partial  classes with the same name as the component they provide code \nfor. \nAdd a Razor Component named Split.razor  to the Blazor  folder with the con-\ntent shown in listing 33.21.  \nListing 33.21   The contents of the Split.razor file in the Blazor folder\n<ul class=""list-group"">\n    @foreach (string name in Names) {\n        <li class=""list-group-item"">@name</li>\n    }\n</ul>\nThis file contains only HTML content and Razor expressions and renders a list of \nnames that it expects to receive through a Names  property. To provide the component \nwith its code, add a class file named Split.razor.cs  to the Blazor  folder and use it \nto define the partial class shown in listing 33.22.\n 1001 Using class files to define components\nListing 33.22    The contents of the Split.razor.cs file in the Blazor folder\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Components;\nnamespace Advanced.Blazor {\n    public partial class Split {\n        [Inject]\n        public DataContext? Context { get; set; }\n        public IEnumerable<string> Names => \n            Context?.People.Select(p => p.Firstname) \n                ?? Enumerable.Empty<string>();\n    }\n}\nThe partial class must be defined in the same namespace as its Razor Component \nand have the same name. For this example, that means the namespace is Advanced \n.Blazor , and the class name is Splt . Code-behind classes do not define construc-\ntors and receive services using the Inject  attribute. Listing 33.23 applies the new \ncomponent.\nListing 33.23    Applying a new component in the Blazor.cshtml file in the Pages folder\n@page ""/pages/blazor""\n<h4 class=""bg-primary text-white text-center p-2"">Code-Behind</h4>\n<component type=""typeof(Advanced.Blazor.Split)"" render-mode=""Server"" />\nRestart ASP.NET Core and request http://localhost:5000/pages/blazor, and you will \nsee the response shown in figure 33.14.\nFigure 33.14    \nUsing a code-\nbehind class to \ndefine a Razor \nComponent",3429
415-33.5.2 Defining a Razor Component class.pdf,415-33.5.2 Defining a Razor Component class,"1002 chapter  33 Using Blazor Server, part 1 \n33.5.2  Defining a Razor Component class\nRazor Components can be defined entirely in a class file, although this can be less \nexpressive than using Razor expressions. Add a class file named CodeOnly.cs  to the \nBlazor  folder and use it to define the class shown in listing 33.24.  \nListing 33.24    The contents of the CodeOnly.cs file in the Blazor folder\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Components;\nusing Microsoft.AspNetCore.Components.Rendering;\nusing Microsoft.AspNetCore.Components.Web;\nnamespace Advanced.Blazor {\n    public class CodeOnly : ComponentBase {\n        [Inject]\n        public DataContext? Context { get; set; }\n        public IEnumerable<string> Names => \n            Context?.People.Select(p => p.Firstname)\n                ?? Enumerable.Empty<string>();\n        public bool Ascending { get; set; } = false;\n        protected override void BuildRenderTree(\n            RenderTreeBuilder builder) {\n                IEnumerable<string> data = Ascending\n                    ? Names.OrderBy(n => n) \n                    : Names.OrderByDescending(n => n);\n            builder.OpenElement(1, ""button"");\n            builder.AddAttribute(2, ""class"", ""btn btn-primary mb-2"");\n            builder.AddAttribute(3, ""onclick"",\n                EventCallback.Factory.Create<MouseEventArgs>(this,\n                    () => Ascending = !Ascending));\n            builder.AddContent(4, new MarkupString(""Toggle""));\n            builder.CloseElement();\n            builder.OpenElement(5, ""ul"");\n            builder.AddAttribute(6, ""class"", ""list-group"");\n            foreach (string name in data) {\n                builder.OpenElement(7, ""li"");\n                builder.AddAttribute(8, ""class"", ""list-group-item"");\n                builder.AddContent(9, new MarkupString(name));\n                builder.CloseElement();\n            }\n            builder.CloseElement();\n        }\n    }\n}\nThe base class for components is ComponentBase . The content that would normally \nbe expressed as annotated HTML elements is created by overriding the BuildRender-\nTree  method and using the RenderTreeBuilder  parameter. Creating content can be \n 1003 Using class files to define components\nawkward because each element is created and configured using multiple code state-\nments, and each statement must have a sequence number that the compiler uses to \nmatch up code and content. The OpenElement  method starts a new element, which is \nconfigured using the AddElement  and AddContent  methods and then completed with \nthe CloseElement  method. All the features available in regular Razor Components \nare available, including events and bindings, which are set up by adding attributes to \nelements, just as if they were defined literally in a .razor  file. The component in list-\ning 33.24 displays a list of sorted names, with the sort direction altered when a button  \nelement is clicked. Listing 33.25 applies the component so that it will be displayed to \nthe user.\nListing 33.25    Applying a new component in the Blazor.cshtml file in the Pages folder \n@page ""/pages/blazor""\n<h4 class=""bg-primary text-white text-center p-2"">Class Only</h4>\n<component type=""typeof(Advanced.Blazor.CodeOnly)"" render-mode=""Server"" />\nRestart ASP.NET Core and request http://localhost:5000/pages/blazor to see the con-\ntent produced by the class-based Razor Component. When you click the button, the \nsort direction of the names in the list is changed, as shown in figure 33.15.\nFigure 33.15    \nDefining a \ncomponent \nentirely in code\nSummary\n¡ Blazor adds client-side interactivity to ASP.NET Core by introducing JavaScript to \nefficiently perform updates.\n¡ Blazor functionality is created in Razor Components, which follow a similar syn-\ntax to Razor views and Razor Pages.\n¡ Razor Components can respond to user interaction by handling JavaScript \nevents, which are used to invoke server-side methods and generate selective \nupdates.\n¡ Razor Components are usually defined with the markup and code in a single file \nbut can use a separate class file and even defined entirely in C#.",4201
416-34.2 Combining components.pdf,416-34.2 Combining components,"100434Using Blazor  \nServer, part 2\nThis chapter covers\n¡ Composing elements to combine Blazor   \n components\n¡ Configuring components using attributes\n¡ Displaying child content and creating templates \n¡ Managing connection errors and application  \n errors\nIn this chapter, I continue to describe Blazor Server, focusing on the way that Razor \nComponents can be used together to create more complex features. Table 34.1 pro-\nvides a guide to the chapter.\n 1005 Preparing for this chapter\nTable 34.1    Chapter guide\nProblem Solution Listing\nCreating complex features \nusing BlazorCombine components to reduce \nduplication.3, 4\nConfiguring a component Use the Parameter  attribute to \nreceive a value from an attribute.5–10\nDefining custom events \nand bindingsUse EventCallbacks  to receive \nthe handler for the event and \nfollow the convention to create \nbindings.11–14\nDisplaying child content in \na componentUse a RenderFragment  named \nChildContent .15, 16\nCreating templates Use named RenderFragment  \nproperties.17, 25\nDistributing configuration \nsettings widelyUse a cascading parameter. 26, 27\nResponding to connection \nerrorsUse the connection element and \nclasses.28, 29\nResponding to unhandled \nerrorsUse the error element and classes \nor define an error boundary.30–35\n34.1 Preparing for this chapter\nThis chapter uses the Advanced project from chapter 33. No changes are required to \nprepare for this chapter.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nAdvanced.csproj  file, and run the command shown in listing 34.1 to drop the \ndatabase.\nListing 34.1    Dropping the database\ndotnet ef database drop --force\nUse the PowerShell command prompt to run the command shown in listing 34.2. \nListing 34.2    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers, which will display a list \nof data items. Request http://localhost:5000/pages/blazor, and you will see the com-\nponent from chapter 33 I used to demonstrate data bindings. Figure 34.1 shows both \nresponses.\n1006 chapter  34 Using Blazor Server, part 2 \nFigure 34.1    Running the example application \n34.2 Combining components \nBlazor components can be combined to create more complex features. In the sections \nthat follow, I show you how multiple components can be used together and how com-\nponents can communicate. To get started, add a Razor Component named Select-\nFilter.razor  to the Blazor  folder with the content shown in listing 34.3.  \nListing 34.3    The contents of the SelectFilter.razor file in the Blazor folder\n<div class=""form-group"">\n    <label for=""select-@Title"">@Title</label>\n    <select name=""select-@Title"" class=""form-control"" \n            @bind=""SelectedValue"">\n        <option disabled selected value="""">Select @Title</option>\n        @foreach (string val in Values) {\n                <option value=""@val"" selected=""@(val == SelectedValue)"">\n                @val\n                </option>\n        }\n    </select>\n</div>\n@code {\n    public IEnumerable<string> Values { get; set; } \n        = Enumerable.Empty<string>();\n    public string? SelectedValue { get; set; }\n    public string Title { get; set; } = ""Placeholder"";\n}\nThe component renders a select  element that will allow the user to choose a city. \nIn listing 34.4, I have applied the SelectFilter  component, replacing the existing \nselect  element.\n 1007 Combining components \nListing 34.4    Applying a component in the PeopleList.razor file in the Blazor folder\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </thead>\n    <tbody>\n        @foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n            <tr class=""@GetClass(p?.Location?.City)"">\n                <td>@p?.PersonId</td>\n                <td>@p?.Surname, @p?.Firstname</td>\n                <td>@p?.Department?.Name</td>\n                <td>@p?.Location?.City, @p?.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<div class=""form-group"">\n    <label for=""city"">City</label>\n    <select name=""city"" class=""form-control"" @bind=""SelectedCity"">\n        <option disabled selected value="""">Select City</option>\n        @foreach (string city in Cities ?? Enumerable.Empty<string>()) {\n            <option value=""@city"" selected=""@(city == SelectedCity)"">\n                @city\n            </option>\n        }\n    </select>\n</div>\n<SelectFilter />\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People =>\n        Context?.People.Include(p => p.Department)\n            .Include(p => p.Location);\n    public IEnumerable<string>? Cities => \n        Context?.Locations.Select(l => l.City);\n    public string SelectedCity { get; set; } = string.Empty;\n    public string GetClass(string? city) =>\n        SelectedCity == city ? ""bg-info text-white"" : """";\n}\nWhen a component is added to the content rendered by a controller view or Razor \nPage, the component  element is used, as shown in chapter 33. When a component is \nadded to the content rendered by another component, then the name of the com-\nponent is used as an element instead. In this case, I am adding the SelectFilter",5633
417-34.2.1 Configuring components with attributes.pdf,417-34.2.1 Configuring components with attributes,"1008 chapter  34 Using Blazor Server, part 2 \ncomponent to the content rendered by the PeopleList  component, which I do with \na SelectFilter  element. It is important to pay close attention to the capitalization, \nwhich must match exactly.\nWhen combining components, the effect is that one component delegates responsi-\nbility for part of its layout to another. In this case, I have removed the select  element \nthat the PeopleList  component used to present the user with a choice of cities and \nreplaced it with the SelectFilter  component, which will provide the same feature. \nThe components form a parent-child relationship; the PeopleList  component is the \nparent, and the SelectFilter  component is the child.\nAdditional work is required before everything is properly integrated, but you can \nsee that adding the SelectFilter  element displays the SelectFilter  component \nby restarting ASP.NET Core and requesting http://localhost:5000/controllers, which \nproduces the response shown in figure 34.2.\nFigure 34.2    \nAdding one \ncomponent to the \ncontent rendered \nby another\n34.2.1  Configuring components with attributes\nMy goal with the SelectList  component is to create a general-purpose feature that \nI can use throughout the application, configuring the values it displays each time it is \nused. Razor Components are configured using attributes added to the HTML element \nthat applies them. The values assigned to the HTML element attributes are assigned to \nthe component’s C# properties. The Parameter  attribute is applied to the C# proper-\nties that a component allows to be configured, as shown in listing 34.5.  \nListing 34.5    Configurable properties in the SelectFilter.razor file in the Blazor folder\n<div class=""form-group"">\n    <label for=""select-@Title"">@Title</label>\n    <select name=""select-@Title"" class=""form-control"" \n            @bind=""SelectedValue"">\n        <option disabled selected value="""">Select @Title</option>\n        @foreach (string val in Values) {\n                <option value=""@val"" selected=""@(val == SelectedValue)"">\n                @val\n                </option>\n        }\n    </select>\n</div>\n@code {\n 1009 Combining components \n    [Parameter]\n    public IEnumerable<string> Values { get; set; } \n        = Enumerable.Empty<string>();\n    public string? SelectedValue { get; set; }\n    [Parameter]\n    public string Title { get; set; } = ""Placeholder"";\n}\nComponents can be selective about the properties they allow to be configured. In \nthis case, the Parameter  attribute has been applied to two of the properties defined \nby the SelectFilter  component. In listing 34.6, I have modified the element the  \nPeopleList  component uses to apply the SelectFilter  component to add configu-\nration attributes.\nListing 34.6    Configuring a Component in the PeopleList.razor File in the Blazor Folder\n...\n<SelectFilter values=""@Cities"" title=""City""  />\n...\nFor each property that should be configured, an attribute of the same name is added to \nthe parent’s HTML element. The attribute values can be fixed values, such as the City  \nstring assigned to the title  attribute, or Razor expressions, such as @Cities , which \nassigns the sequence of objects from the Cities  property to the values  attribute.\nTIP    The EditorRequired  attribute can be applied alongside the Parameter  \nattribute to denote properties for which values are required. A warning will be \nproduced if the component is used without the required attribute. \nsetting  and receiving  bulk configuration  settings\nDefining individual properties to receive values can be error-prone if there are many \nconfiguration settings, especially if those values are being received by a component so \nthey can be passed on, either to a child component or to a regular HTML element. \nIn these situations, a single property can be designated to receive any attribute values \nthat have not been matched by other properties, which can then be applied as a set, as \nshown in listing 34.7.  \nListing 34.7    Receiving bulk attributes in the SelectFilter.razor file in the Blazor folder\n<div class=""form-group"">\n    <label for=""select-@Title"">@Title</label>\n    <select name=""select-@Title"" class=""form-control"" \n            @bind=""SelectedValue"" @attributes=""Attrs"">\n        <option disabled selected value="""">Select @Title</option>\n        @foreach (string val in Values) {\n            <option value=""@val"" selected=""@(val == SelectedValue)"">\n                @val\n            </option>\n        }\n1010 chapter  34 Using Blazor Server, part 2 \n    </select>\n</div>\n@code {\n    [Parameter]\n    public IEnumerable<string> Values { get; set; } \n        = Enumerable.Empty<string>();\n    public string? SelectedValue { get; set; }\n    [Parameter]\n    public string Title { get; set; } = ""Placeholder"";\n    [Parameter(CaptureUnmatchedValues = true)]\n    public Dictionary<string, object>? Attrs { get; set; }\n}\nSetting the Parameter  attribute’s CaptureUnmatchedValues  argument to true  iden-\ntifies a property as the catchall for attributes that are not otherwise matched. The type \nof the property must be Dictionary<string, object> , which allows the attribute \nnames and values to be represented.\nProperties whose type is Dictionary<string, object>  can be applied to elements \nusing the @attribute  expression, like this:\n...\n<select name=""select-@Title"" class=""form-control"" @bind=""SelectedValue"" \n    @attributes=""Attrs"" >\n...\nThis is known as attribute splatting , and it allows a set of attributes to be applied in one \ngo. The effect of the changes in listing 34.7 means that the SelectFilter  component \nwill receive the Values  and Title  attribute values and that any other attributes will be \nassigned to the Attrs  property and passed on to the select  element. Listing 34.8 adds \nsome attributes to demonstrate the effect.  \nListing 34.8    Adding element attributes in the PeopleList.razor file in the Blazor folder\n...\n<SelectFilter values=""@Cities"" title=""City"" autofocus=""true"" name=""city"" \n    required=""true"" />\n...\nRestart ASP.NET Core and navigate to http://localhost:5000/controllers. The attri-\nbutes passed on to the select  element do not affect appearance, but if you right-click \nthe select  element and select Inspect from the pop-up menu, you will see the attri-\nbutes added to the SelectFilter  element in the PeopleList  component have been \nadded to the element rendered by the SelectFilter  component, like this:\n...\n<select class=""form-control"" autofocus=""true"" name=""city"" required=""true"" >\n...\n 1011 Combining components \nconfiguring  a component  in a controller  view or razor page\nAttributes are also used to configure components when they are applied using the \ncomponent  element. In listing 34.9, I have added properties to the PeopleList  com-\nponent that specify how many items from the database should be displayed and a string \nvalue that will be passed on to the SelectFilter  component. \nListing 34.9    Adding properties in the PeopleList.razor file in the Blazor folder\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </thead>\n    <tbody>\n        @foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n            <tr class=""@GetClass(p?.Location?.City)"">\n                <td>@p?.PersonId</td>\n                <td>@p?.Surname, @p?.Firstname</td>\n                <td>@p?.Department?.Name</td>\n                <td>@p?.Location?.City, @p?.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<SelectFilter values=""@Cities"" title=""@SelectTitle"" />\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location).Take(ItemCount);\n    public IEnumerable<string>? Cities => \n        Context?.Locations.Select(l => l.City);\n    public string SelectedCity { get; set; } = string.Empty;\n    public string GetClass(string? city) =>\n        SelectedCity == city ? ""bg-info text-white"" : """";\n    [Parameter]\n    public int ItemCount { get; set; } = 4;\n    [Parameter]\n    public string? SelectTitle { get; set; }\n}\nValues for the C# properties are provided by adding attributes whose name begins with \nparam- , followed by the property name, to the component  element, as shown in listing \n34.10.",8562
418-34.2.2 Creating custom events and bindings.pdf,418-34.2.2 Creating custom events and bindings,"1012 chapter  34 Using Blazor Server, part 2 \nListing 34.10    Adding attributes in the Index.cshtml file in the Views/Home folder\n@model PeopleListViewModel\n<h4 class=""bg-primary text-white text-center p-2"">People</h4>\n<component type=""typeof(Advanced.Blazor.PeopleList)"" render-mode=""Server""\n    param-itemcount=""5"" param-selecttitle=""@(""Location"")"" />\nThe param-itemcount  attribute provides a value for the ItemCount  property, and the \nparam-selecttitle  attribute provides a value for the SelectTitle  property.\nWhen using the component  element, attribute values that can be parsed into numeric \nor bool  values are handled as literal values and not Razor expressions, which is why I am \nable to specify the value for the ItemCount  property as 4. Other values are assumed to \nbe Razor expressions and not literal values, even though they are not prefixed with @. \nThis oddity means that since I want to specify the value for the SelectTitle  property \nas a literal string, I need a Razor expression, like this:\n...\n<component type=""typeof(Advanced.Blazor.PeopleList)"" render-mode=""Server""\n    param-itemcount=""5"" param-selecttitle="" @(""Location"") "" />\n...\nTo see the effect of the configuration attributes, restart ASP.NET Core and request \nhttp://localhost:5000/controllers, which will produce the response shown in figure \n34.3. \nFigure 34.3    \nConfiguring \ncomponents with \nattributes\n34.2.2  Creating custom events and bindings\nThe SelectFilter  component receives its data values from its parent component, but \nit has no way to indicate when the user makes a selection. For this, I need to create a \ncustom event for which the parent component can register a handler method, just as \nit would for events from regular HTML elements. Listing 34.11 adds a custom event to \nthe SelectFilter  component.  \n 1013 Combining components \nListing 34.11    Creating an event in the SelectFilter.razor file in the Blazor folder\n<div class=""form-group"">\n    <label for=""select-@Title"">@Title</label>\n    <select name=""select-@Title"" class=""form-control"" \n            @onchange=""HandleSelect"" value=""@SelectedValue"">\n        <option disabled selected value="""">Select @Title</option>\n        @foreach (string val in Values) {\n            <option value=""@val"" selected=""@(val == SelectedValue)"">\n                @val\n            </option>\n        }\n    </select>\n</div>\n@code {\n    [Parameter]\n    public IEnumerable<string> Values { get; set; } \n        = Enumerable.Empty<string>();\n    public string? SelectedValue { get; set; }\n    [Parameter]\n    public string Title { get; set; } = ""Placeholder"";\n    [Parameter(CaptureUnmatchedValues = true)]\n    public Dictionary<string, object>? Attrs { get; set; }\n    [Parameter]\n    public EventCallback<string> CustomEvent { get; set; }\n    public async Task HandleSelect(ChangeEventArgs e) {\n        SelectedValue = e.Value as string;\n        await CustomEvent.InvokeAsync(SelectedValue);\n    }\n}\nThe custom event is defined by adding a property whose type is EventCallback<T> . \nThe generic type argument is the type that will be received by the parent’s event han-\ndler and is string  in this case. I have changed the select  element so the @onchange  \nattribute registers the HandleSelect  method when the select  element triggers its \nonchange  event.\nThe HandleSelect  method updates the SelectedValue  property and triggers the \ncustom event by invoking the EventCallback<T>.InvokeAsync  method, like this:\n...\nawait CustomEvent.InvokeAsync(SelectedValue);\n...\nThe argument to the InvokeAsync  method is used to trigger the event using the value \nreceived from the ChangeEventArgs  object that was received from the select  ele-\nment. Listing 34.12 changes the PeopleList  component so that it receives the custom \nevent emitted by the SelectList  component.\n1014 chapter  34 Using Blazor Server, part 2 \nListing 34.12    Handling an event in the PeopleList.razor file in the Blazor folder\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </thead>\n    <tbody>\n        @foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n            <tr class=""@GetClass(p?.Location?.City)"">\n                <td>@p?.PersonId</td>\n                <td>@p?.Surname, @p?.Firstname</td>\n                <td>@p?.Department?.Name</td>\n                <td>@p?.Location?.City, @p?.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<SelectFilter values=""@Cities"" title=""@SelectTitle"" \n    CustomEvent=""@HandleCustom"" />\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location).Take(ItemCount);\n    public IEnumerable<string>? Cities =>\n        Context?.Locations.Select(l => l.City);\n    public string SelectedCity { get; set; } = string.Empty;\n    public string GetClass(string? city) =>\n        SelectedCity == city ? ""bg-info text-white"" : """";\n    [Parameter]\n    public int ItemCount { get; set; } = 4;\n    [Parameter]\n    public string? SelectTitle { get; set; }\n    public void HandleCustom(string newValue) {\n        SelectedCity = newValue;\n    }\n}\nTo set up the event handler, an attribute is added to the element that applies the child \ncomponent using the name of its EventCallback<T>  property. The value of the attri-\nbute is a Razor expression that selects a method that receives a parameter of type T. \nRestart ASP.NET Core, request http://localhost:5000/controllers, and select a value \nfrom the list of cities. The custom event completes the relationship between the parent \nand child components. The parent configures the child through its attributes to specify \n 1015 Combining components \nthe title and the list of data values that will be presented to the user. The child compo-\nnent uses a custom event to tell the parent when the user selects a value, allowing the \nparent to highlight the corresponding rows in its HTML table, as shown in figure 34.4.\nFigure 34.4    \nUsing a custom \nevent\nA parent component can create a binding on a child component if it defines a pair of \nproperties, one of which is assigned a data value and the other of which is a custom \nevent. The names of the property are important: the name of the event property must \nbe the same as the data property plus the word Changed . Listing 34.13 updates the \nSelectFilter  component so it presents the properties required for the binding.  \nListing 34.13    Preparing for bindings in the SelectFilter.razor file in the Blazor folder\n<div class=""form-group"">\n    <label for=""select-@Title"">@Title</label>\n    <select name=""select-@Title"" class=""form-control"" \n            @onchange=""HandleSelect"" value=""@SelectedValue"">\n        <option disabled selected value="""">Select @Title</option>\n        @foreach (string val in Values) {\n            <option value=""@val"" selected=""@(val == SelectedValue)"">\n                @val\n            </option>\n        }\n    </select>\n</div>\n@code {\n    [Parameter]\n    public IEnumerable<string> Values { get; set; } \n        = Enumerable.Empty<string>();\n    [Parameter]\n    public string? SelectedValue { get; set; }\n    [Parameter]\n    public string Title { get; set; } = ""Placeholder"";\n    [Parameter(CaptureUnmatchedValues = true)]\n    public Dictionary<string, object>? Attrs { get; set; }\n1016 chapter  34 Using Blazor Server, part 2 \n    [Parameter]\n    public EventCallback<string> SelectedValueChanged { get; set; }\n    public async Task HandleSelect(ChangeEventArgs e) {\n        SelectedValue = e.Value as string;\n        await SelectedValueChanged.InvokeAsync(SelectedValue);\n    }\n}\nNotice that the Parameter  attribute must be applied to both the SelectedValue  and \nSelectedValueChanged  properties. If either attribute is omitted, the data binding \nwon’t work as expected. \nThe parent component binds to the child with the @bind-<name>  attribute, where \n<name>  corresponds to the property defined by the child component. In this example, \nthe name of the child component’s property is SelectedValue , and the parent can \ncreate a binding using @bind-SelectedValue , as shown in listing 34.14.\nListing 34.14    Using a custom binding in the PeopleList.razor file in the Blazor folder\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr>\n            <th>ID</th><th>Name</th><th>Dept</th><th>Location</th>\n        </tr>\n    </thead>\n    <tbody>\n        @foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n            <tr class=""@GetClass(p?.Location?.City)"">\n                <td>@p?.PersonId</td>\n                <td>@p?.Surname, @p?.Firstname</td>\n                <td>@p?.Department?.Name</td>\n                <td>@p?.Location?.City, @p?.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<SelectFilter values=""@Cities"" title=""@SelectTitle"" \n    @bind-SelectedValue=""SelectedCity"" />\n<button class=""btn btn-primary mt-2"" \n    @onclick=""@(() => SelectedCity = ""Oakland"")"">\n        Change\n</button>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location).Take(ItemCount);\n    public IEnumerable<string>? Cities =>",9562
419-34.3 Displaying child content in a component.pdf,419-34.3 Displaying child content in a component,"1017 Displaying child content in a component \n        Context?.Locations.Select(l => l.City);\n    public string SelectedCity { get; set; } = string.Empty;\n    public string GetClass(string? city) =>\n        SelectedCity == city ? ""bg-info text-white"" : """";\n    [Parameter]\n    public int ItemCount { get; set; } = 4;\n    [Parameter]\n    public string? SelectTitle { get; set; }\n    //public void HandleCustom(string newValue) {\n    //    SelectedCity = newValue;\n    //}\n}\nRestart ASP.NET Core, request http://localhost:5000/controllers, and select New York \nfrom the list of cities. The custom binding will cause the value chosen in the select  \nelement to be reflected by the highlighting in the table. Click the Change button to \ntest the binding in the other direction, and you will see the highlighted city change, as \nshown in figure 34.5.\nFigure 34.5    \nUsing a custom \nbinding\n34.3 Displaying child content in a component \nComponents that display child content act as wrappers around elements provided by \ntheir parents. To see how child content is managed, add a Razor Component named \nThemeWrapper.razor  to the Blazor  folder with the content shown in listing 34.15.  \nListing 34.15    The contents of the ThemeWrapper.razor file in the Blazor folder\n<div class=""p-2 bg-@Theme border text-white"">\n    <h5 class=""text-center"">@Title</h5>\n    @ChildContent\n</div>\n@code {\n    [Parameter]\n    public string? Theme { get; set; }\n    [Parameter]\n1018 chapter  34 Using Blazor Server, part 2 \n    public string? Title { get; set; }\n    [Parameter]\n    public RenderFragment? ChildContent { get; set; }\n}\nTo receive child content, a component defines a property named ChildContent  \nwhose type is RenderFragment  and that has been decorated with the Parameter  attri-\nbute. The @ChildContent  expression includes the child content in the component’s \nHTML output. The component in the listing wraps its child content in a div element \nthat is styled using a Bootstrap theme color and that displays a title. The name of the \ntheme color and the text of the title are also received as parameters.\nRestricting element reuse \nWhen updating the content presented to the user, Blazor will reuse elements if it can \nbecause creating new elements is a relatively expensive operation. This is particularly \ntrue when displaying elements for a sequence of values, such as with @for  or @foreach  \nexpressions. If the sequence changes, Blazor will reuse the elements it created for the \nold data values to display the new data.  \nThis can cause problems if changes have been made to the elements outside of the con-\ntrol of Blazor, such as with custom JavaScript code. Blazor isn’t aware of the changes, \nwhich will persist when the elements are reused. Although this is a rare situation, you \ncan restrict the reuse of elements by using an @key  attribute and providing an expres-\nsion that associates the element with one of the data values in the sequence, like this:\n...\n@foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n    <tr @key=""p.PersonId""  class=""@GetClass(p?.Location?.City)"">\n        <td>@p?.PersonId</td>\n        <td>@p?.Surname, @p?.Firstname</td>\n        <td>@p?.Department?.Name</td>\n        <td>@p?.Location?.City, @p?.Location?.State</td>\n    </tr>\n}\n...\nBlazor will reuse an element only if there is a data item that has the same key. For other \nvalues, new elements will be created.\nChild content is defined by adding HTML elements between the start and end tags \nwhen applying the component, as shown in listing 34.16.\nListing 34.16    Defining child content in the PeopleList.razor file in the Blazor folder\n<table class=""table table-sm table-bordered table-striped"">\n    <thead>\n        <tr>\n            <th>ID</th><th>Name</th><th>Dept</th><th>Location</th>\n        </tr>",3878
420-34.3.1 Creating template components.pdf,420-34.3.1 Creating template components,"1019 Displaying child content in a component \n    </thead>\n    <tbody>\n        @foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n            <tr class=""@GetClass(p?.Location?.City)"">\n                <td>@p?.PersonId</td>\n                <td>@p?.Surname, @p?.Firstname</td>\n                <td>@p?.Department?.Name</td>\n                <td>@p?.Location?.City, @p?.Location?.State</td>\n            </tr>\n        }\n    </tbody>\n</table>\n<ThemeWrapper Theme=""info"" Title=""Location Selector"">\n    <SelectFilter values=""@Cities"" title=""@SelectTitle"" \n        @bind-SelectedValue=""SelectedCity"" />\n    <button class=""btn btn-primary mt-2"" \n        @onclick=""@(() => SelectedCity = ""Oakland"")"">\n            Change\n    </button>\n</ThemeWrapper>\n@code {\n    // ...statements omitted for brevity...    \n}\nNo additional attributes are required to configure the child content, which is pro-\ncessed and assigned to the ChildContent  property automatically. To see how the \nTheme Wrapper  component presents its child content, restart ASP.NET Core and \nrequest http://localhost:5000/controllers. You will see the configuration attributes \nthat selected the theme and the title text used to produce the response shown in figure \n34.6.\nFigure 34.6    \nUsing child \ncontent\n34.3.1  Creating template components\nTemplate components bring more structure to the presentation of child content, \nallowing multiple sections of content to be displayed. Template components are a \ngood way of consolidating features that are used throughout an application to prevent \nthe duplication of code and content.  \nTo see how this works, add a Razor Component named TableTemplate.razor  to \nthe Blazor  folder with the content shown in listing 34.17.\n1020 chapter  34 Using Blazor Server, part 2 \nListing 34.17    The contents of the TableTemplate.razor file in the Blazor folder\n<table class=""table table-sm table-bordered table-striped"">\n    @if (Header != null) {\n        <thead>@Header</thead>\n    }\n    <tbody>@Body</tbody>\n</table>\n@code {\n    [Parameter]\n    public RenderFragment? Header { get; set; }\n    [Parameter]\n    public RenderFragment? Body { get; set; }\n}\nThe component defines a RenderFragment  property for each region of child content \nit supports. The TableTemplate  component defines two RenderFragment  properties, \nnamed Header  and Body , which represent the content sections of a table. Each region \nof child content is rendered using a Razor expression, @Header  and @Body , and you \ncan check to see whether content has been provided for a specific section by checking \nto see whether the property value is null , which this component does for the Header  \nsection.\nWhen using a template component, the content for each region is enclosed in an \nHTML element whose tag matches the name of the corresponding RenderFragment  \nproperty, as shown in listing 34.18.\nListing 34.18    Applying a template component in the Blazor/PeopleList.razor file \n<TableTemplate>\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </Header>\n    <Body>\n        @foreach (Person p in People ?? Enumerable.Empty<Person>()) {\n            <tr class=""@GetClass(p?.Location?.City)"">\n                <td>@p?.PersonId</td>\n                <td>@p?.Surname, @p?.Firstname</td>\n                <td>@p?.Department?.Name</td>\n                <td>@p?.Location?.City, @p?.Location?.State</td>\n            </tr>\n        }\n    </Body>\n</TableTemplate>\n<ThemeWrapper Theme=""info"" Title=""Location Selector"">\n    <SelectFilter values=""@Cities"" title=""@SelectTitle"" \n        @bind-SelectedValue=""SelectedCity"" />\n    <button class=""btn btn-primary mt-2"" \n        @onclick=""@(() => SelectedCity = ""Oakland"")"">\n 1021 Displaying child content in a component \n            Change\n    </button>\n</ThemeWrapper>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location).Take(ItemCount);\n    public IEnumerable<string>? Cities => \n        Context?.Locations.Select(l => l.City);\n    public string SelectedCity { get; set; } = string.Empty;\n    public string GetClass(string? city) =>\n        SelectedCity == city ? ""bg-info text-white"" : """";\n    [Parameter]\n    public int ItemCount { get; set; } = 4;\n    [Parameter]\n    public string? SelectTitle { get; set; }\n}\nThe child content is structured into sections that correspond to the template com-\nponent’s properties, Header  and Body , which leaves the TableTemplate  component \nresponsible for the table structure and the PeopleList  component responsible for \nproviding the detail. Restart ASP.NET Core and request http://localhost:5000/  \ncontrollers, and you will see the output produced by the template component, as \nshown in figure 34.7. \nFigure 34.7    \nUsing a template \ncomponent",4995
421-34.3.2 Using generic type parameters in template components.pdf,421-34.3.2 Using generic type parameters in template components,"1022 chapter  34 Using Blazor Server, part 2 \n34.3.2  Using generic type parameters in template components\nThe template component I created in the previous section is useful, in the sense that it \nprovides a consistent representation of a table that I can use throughout the example \napplication. But it is also limited because it relies on the parent component to take \nresponsibility for generating the rows for the table body. The template component \ndoesn’t have any insight into the content it presents, which means it cannot do any-\nthing with that content other than display it.\nTemplate components can be made data-aware with the use of a generic type param-\neter, which allows the parent component to provide a sequence of data objects and a \ntemplate for presenting them. The template component becomes responsible for gen-\nerating the content for each data object and, consequently, can provide more useful \nfunctionality. As a demonstration, I am going to add support to the template compo-\nnent for selecting how many table rows are displayed and for selecting table rows. The \nfirst step is to add a generic type parameter to the component and use it to render the \ncontent for the table body, as shown in listing 34.19. \nListing 34.19    Adding a type parameter in the Blazor/TableTemplate.razor file \n@typeparam RowType\n<table class=""table table-sm table-bordered table-striped"">\n    @if (Header != null) {\n        <thead>@Header</thead>\n    }\n    <tbody>\n        @if (RowData != null && RowTemplate != null) {\n            @foreach (RowType item in RowData) {\n                <tr>@RowTemplate(item)</tr>\n            }\n        }\n    </tbody>\n</table>\n@code {\n    [Parameter]\n    public RenderFragment? Header { get; set; }\n    [Parameter]\n    public RenderFragment<RowType>? RowTemplate { get; set; }\n    [Parameter]\n    public IEnumerable<RowType>? RowData { get; set; }\n}\nThe generic type parameter is specified using the @typeparam  attribute, and, in this \ncase, I have given the parameter the name RowType  because it will refer to the data \ntype for which the component will generate table rows. \n 1023 Displaying child content in a component \nTIP    Blazor generic type parameters can be constrained using the C# where  \nkeyword so that only types that have specified characteristics, such as classes \nthat implement a particular interface, can be used. See https://docs.microsoft \n.com/en-us/dotnet/csharp/language-reference/keywords/where-generic-type-  \nconstraint  for details.\nThe data the component will process is received by adding a property whose type is \na sequence of objects of the generic type. I have named the property RowData , and \nits type is IEnumerable<RowType> . The content the component will display for each \nobject is received using a RenderFragment<T>  property. I have named this prop-\nerty RowTemplate , and its type is RenderFragment<RowType> , reflecting the name I \nselected for the generic type parameter.\nWhen a component receives a content section through a RenderFragment<T>  prop-\nerty, it can render it for a single object by invoking the section as a method and using \nthe object as the argument, like this:\n...\n@foreach (RowType item in RowData) {\n    <tr> @RowTemplate(item) </tr>\n}\n...\nThis fragment of code enumerates the RowType  objects in the RowData  sequence and ren-\nders the content section received through the RowTemplate  property for each of them.\nusing a generic  template  component  \nI have simplified the PeopleList  component so it only uses the template component \nto produce a table of Person  objects, and I have removed earlier features, as shown in \nlisting 34.20.\nListing 34.20    Using a generic template component in the Blazor/PeopleList.razor file \n<TableTemplate RowType=""Person"" RowData=""People"">\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </Header>\n    <RowTemplate Context=""p"">\n        <td>@p.PersonId</td>\n        <td>@p.Surname, @p.Firstname</td>\n        <td>@p.Department?.Name</td>\n        <td>@p.Location?.City, @p.Location?.State</td>\n    </RowTemplate>\n</TableTemplate>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location);\n}\n1024 chapter  34 Using Blazor Server, part 2 \nThe RowType  attribute is used to specify the value for the generic type argument. The \nRowData  attribute specifies the data the template component will process. \nThe RowTemplate  element denotes the elements that will be produced for each \ndata object. When defining a content section for a RenderFragment<T>  property, the  \nContext  attribute is used to assign a name to the current object being processed. In this \ncase, the Context  attribute is used to assign the name p to the current object, which \nis then referred to in the Razor expressions used to populate the content section’s \nelements.\nThe overall effect is that the template component is configured to display Person  \nobjects. The component will generate a table row for each Person , which will contain \ntd elements whose content is set using the current Person  object’s properties.\nSince I removed properties that were decorated with the Parameter  attribute in list-\ning 34.20, I need to remove the corresponding attributes from the element that applies \nthe PeopleList  component, as shown in listing 34.21.\nListing 34.21    Removing attributes in the Index.cshtml file in the Views/Home folder\n@model PeopleListViewModel\n<h4 class=""bg-primary text-white text-center p-2"">People</h4>\n<component type=""typeof(Advanced.Blazor.PeopleList)"" \n    render-mode=""Server"" />\nTo see the generic template component, restart ASP.NET Core and request http://\nlocalhost:5000/controllers. The data and content sections provided by the People-\nList  component have been used by the TableTemplate  component to produce the \ntable shown in figure 34.8.\nFigure 34.8    \nUsing a generic \ntemplate \ncomponent\nadding  features  to the generic  template  component  \nThis may feel like a step backward, but, as you will see, giving the template component \ninsight into the data it handles sets the foundation for adding features, as shown in \nlisting 34.22.\n 1025 Displaying child content in a component \nListing 34.22    Adding a feature in the TableTemplate.razor file in the Blazor folder\n@typeparam RowType\n<div class=""container-fluid"">\n    <div class=""row p-2"">\n        <div class=""col"">\n            <SelectFilter Title=""@(""Sort"")"" \n                Values=""@SortDirectionChoices""\n                @bind-SelectedValue=""SortDirectionSelection"" />\n        </div>\n        <div class=""col"">\n            <SelectFilter Title=""@(""Highlight"")"" \n                Values=""@HighlightChoices()""\n                @bind-SelectedValue=""HighlightSelection"" />\n        </div>\n    </div>\n</div>\n<table class=""table table-sm table-bordered table-striped"">\n    @if (Header != null) {\n        <thead>@Header</thead>\n    }\n    <tbody>\n        @if (RowTemplate != null) {\n            @foreach (RowType item in SortedData()) {\n                <tr class=""@IsHighlighted(item)"">@RowTemplate(item)</tr>\n            }\n        }\n    </tbody>\n</table>\n@code {\n    [Parameter]\n    public RenderFragment? Header { get; set; }\n    [Parameter]\n    public RenderFragment<RowType>? RowTemplate { get; set; }\n    [Parameter]\n    public IEnumerable<RowType> RowData { get; set; }\n        = Enumerable.Empty<RowType>();\n    [Parameter]\n    public Func<RowType, string> Highlight { get; set; } \n        = (row) => String.Empty;\n    public IEnumerable<string> HighlightChoices() =>\n        RowData.Select(item => Highlight(item)).Distinct();\n    public string? HighlightSelection { get; set; }\n    public string IsHighlighted(RowType item) =>\n        Highlight(item) == HighlightSelection \n            ? ""table-dark text-white"" : """";\n1026 chapter  34 Using Blazor Server, part 2 \n    [Parameter]\n    public Func<RowType, string> SortDirection { get; set; }\n        = (row) => String.Empty;\n    public string[] SortDirectionChoices =\n        new string[] { ""Ascending"", ""Descending"" };\n    public string SortDirectionSelection { get; set; } = ""Ascending"";\n    public IEnumerable<RowType> SortedData() =>\n        SortDirectionSelection == ""Ascending""\n            ? RowData.OrderBy(SortDirection)\n            : RowData.OrderByDescending(SortDirection);\n}\nThe changes present the user with two select  elements via the SelectFilter  compo-\nnent created earlier in the chapter. These new elements allow the user to sort the data \nin ascending and descending order and to select a value used to highlight rows in the \ntable. The parent component provides additional parameters that give the template \ncomponent functions that select the properties used for sorting and highlighting, as \nshown in listing 34.23.\nListing 34.23    Configuring component features in the Blazor/PeopleList.razor file \n<TableTemplate RowType=""Person"" RowData=""People""\n        Highlight=""@(p => p.Location?.City)"" \n        SortDirection=""@(p => p.Surname)"">\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </Header>\n    <RowTemplate Context=""p"">\n        <td>@p.PersonId</td>\n        <td>@p.Surname, @p.Firstname</td>\n        <td>@p.Department?.Name</td>\n        <td>@p.Location?.City, @p.Location?.State</td>\n    </RowTemplate>\n</TableTemplate>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location);\n}\nThe Highlight  attribute provides the template component with a function that selects \nthe property used for highlighting table rows, and the SortDirection  attribute pro-\nvides a function that selects a property used for sorting. To see the effect, restart ASP \n.NET Core and request http://localhost:5000/controllers. The response will contain \n 1027 Displaying child content in a component \nthe new select  elements, which can be used to change the sort order or select a city \nfor filtering, as shown in figure 34.9.\nFigure 34.9    \nAdding \nfeatures to \na template \ncomponent\nreusing  a generic  template  component  \nThe features added to the template component all relied on the generic type param-\neter, which allows the component to modify the content it presents without being tied \nto a specific class. The result is a component that can be used to display, sort, and \nhighlight any data type wherever a table is required. Add a Razor Component named \nDepartmentList.razor  to the Blazor  folder with the content shown in listing 34.24.\nListing 34.24    The contents of the DepartmentList.razor file in the Blazor folder\n<TableTemplate RowType=""Department"" RowData=""Departments""\n    Highlight=""@(d => d.Name)"" \n    SortDirection=""@(d => d.Name)"">\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>People</th><th>Locations</th></tr>\n    </Header>\n    <RowTemplate Context=""d"">\n        <td>@d.Departmentid</td>\n        <td>@d.Name</td>\n        <td>@(String.Join("", "", d.People!.Select(p => p.Surname)))</td>\n        <td>\n            @(String.Join("", "", d.People!.Select(p => \n                p.Location!.City).Distinct()))\n        </td>\n    </RowTemplate>\n</TableTemplate>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Department>? Departments => Context?.Departments?\n        .Include(d => d.People!).ThenInclude(p => p.Location!);   \n}",11778
422-34.3.3 Cascading parameters.pdf,422-34.3.3 Cascading parameters,"1028 chapter  34 Using Blazor Server, part 2 \nThe TableTemplate  component is used to present the user with a list of the Department  \nobjects in the database, along with details of the related Person  and Location  objects, \nwhich are queried with the Entity Framework Core Include  and ThenInclude  meth-\nods. Listing 34.25 changes the Razor Component displayed by the Razor Page named \nBlazor . \nListing 34.25    Changing the component in the Blazor.cshtml file in the Pages folder\n@page ""/pages/blazor""\n<h4 class=""bg-primary text-white text-center p-2"">Departments</h4>\n<component type=""typeof(Advanced.Blazor.DepartmentList)"" \n    render-mode=""Server"" />\nRestart ASP.NET Core and request http://localhost:5000/pages/blazor. The response \nwill be presented using the templated component, as shown in figure 34.10.\nFigure 34.10    \nReusing a generic \ntemplate component\n34.3.3  Cascading parameters\nAs the number of components increases, it can be useful for a component to provide \nconfiguration data to descendants deep in the hierarchy of components. This can be \ndone by having each component in the chain receive the data and pass it on to all of \nits children, but that is error-prone and requires every component to participate in the \nprocess, even if none of its descendants uses the data it passes on.\nBlazor provides a solution to this problem by supporting cascading parameters , in \nwhich a component provides data values that are available directly to any of its descen-\ndants, without being relayed by intermediate components. Cascading parameters are \ndefined using the CascadingValue  component, which is used to wrap a section of con-\ntent, as shown in listing 34.26.  \n 1029 Displaying child content in a component \nListing 34.26    A cascading parameter in the DepartmentList.razor file in the Blazor folder\n<CascadingValue Name=""BgTheme"" Value=""Theme"" IsFixed=""false"">\n    <TableTemplate RowType=""Department"" RowData=""Departments""\n                   Highlight=""@(d => d.Name)""\n                   SortDirection=""@(d => d.Name)"">\n        <Header>\n        <tr>\n            <th>ID</th><th>Name</th><th>People</th><th>Locations</th>\n        </tr>\n        </Header>\n        <RowTemplate Context=""d"">\n            <td>@d.Departmentid</td>\n            <td>@d.Name</td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p => p.Surname)))\n            </td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p =>\n                    p.Location!.City).Distinct()))\n            </td>\n        </RowTemplate>\n    </TableTemplate>\n</CascadingValue>\n<SelectFilter  Title=""@(""Theme"")"" Values=""Themes""\n              @bind-SelectedValue=""Theme"" />\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Department>? Departments => Context?.Departments?\n        .Include(d => d.People!).ThenInclude(p => p.Location!);\n    public string Theme { get; set; } = ""info"";\n    public string[] Themes = \n        new string[] { ""primary"", ""info"", ""success"" };\n}\nThe CascadingValue  element makes a value available to the components it encom-\npasses and their descendants. The Name  attribute specifies the name of the parameter, \nthe Value  attribute specifies the value, and the isFixed  attribute is used to specify \nwhether the value will change. The CascadingValue  element has been used in list-\ning 34.26 to create a cascading parameter named BgTheme , whose value is set by an \ninstance of the SelectFilter  component that presents the user with a selection of \nBootstrap CSS theme names.\nTIP    Each CascadingValue  element creates one cascading parameter. If you \nneed to pass on multiple values, then you can nest the CascadingValue  or cre-\nate a simple parameter that provides multiple settings through a dictionary.\n1030 chapter  34 Using Blazor Server, part 2 \nCascading parameters are received directly by the components that require them with \nthe CascadingParameter  attribute, as shown in listing 34.27.\nListing 34.27    Receiving a cascading parameter in the SelectFilter.razor file in the \nBlazor folder\n<div class=""form-group p-2 bg-@Theme @TextColor()"">\n    <label for=""select-@Title"">@Title</label>\n    <select name=""select-@Title"" class=""form-control""\n            @onchange=""HandleSelect"" value=""@SelectedValue"">\n        <option disabled selected value="""">Select @Title</option>\n        @foreach (string val in Values) {\n            <option value=""@val"" selected=""@(val == SelectedValue)"">\n                @val\n            </option>\n        }\n    </select>\n</div>\n@code {\n    [Parameter]\n    public IEnumerable<string> Values { get; set; }\n        = Enumerable.Empty<string>();\n    [Parameter]\n    public string? SelectedValue { get; set; }\n    [Parameter]\n    public string Title { get; set; } = ""Placeholder"";\n    [Parameter(CaptureUnmatchedValues = true)]\n    public Dictionary<string, object>? Attrs { get; set; }\n    [Parameter]\n    public EventCallback<string> SelectedValueChanged { get; set; }\n    public async Task HandleSelect(ChangeEventArgs e) {\n        SelectedValue = e.Value as string;\n        await SelectedValueChanged.InvokeAsync(SelectedValue);\n    }\n    [CascadingParameter(Name = ""BgTheme"")]\n    public string Theme { get; set; } = """";\n    public string TextColor() => String.IsNullOrEmpty(Theme)\n        ? ""text-dark"" : ""text-light"";\n}\nThe CascadingParameter  attribute’s Name  argument is used to specify the name of \nthe cascading parameter. The BgTheme  parameter defined in listing 34.26 is received \nby the Theme  property in listing 34.27 and used to set the background for the compo-\nnent. Restart ASP.NET Core and request http://localhost:5000/pages/blazor, which \nproduces the response shown in figure 34.11.",5845
423-34.4 Handling errors.pdf,423-34.4 Handling errors,,0
424-34.4.1 Handling connection errors.pdf,424-34.4.1 Handling connection errors,"1031 Handling errors\nFigure 34.11    Using a cascading parameter \nThere are three instances of the SelectFilter  component used in this example, but \nonly two of them are within the hierarchy contained by the CascadingValue  element. \nThe other instance is defined outside of the CascadingValue  element and does not \nreceive the cascading value.\n34.4 Handling errors\nIn the following sections, I describe the features Blazor provides for dealing with con-\nnection errors and unhandled application errors.  \n34.4.1  Handling connection errors\nBlazor relies on its persistent HTTP connection between the browser and the ASP \n.NET Core server. The application cannot function when the connection is disrupted, \nand a modal error message is displayed that prevents the user from interacting with \ncomponents.  \nBlazor allows the connection errors to be customized by defining an element with a \nspecific id, as shown in listing 34.28.\nListing 34.28    A connection error element in the Blazor.cshtml file in the Pages folder\n@page ""/pages/blazor""\n<h4 class=""bg-primary text-white text-center p-2"">Departments</h4>\n<link rel=""stylesheet"" href=""connectionErrors.css"" />\n<div id=""components-reconnect-modal""\n     class=""h4 bg-dark text-white text-center my-2 p-2 \n            components-reconnect-hide"">\n    Blazor Connection Lost\n    <div class=""reconnect"">\n        Trying to reconnect...\n    </div>\n1032 chapter  34 Using Blazor Server, part 2 \n    <div class=""failed"">\n        Reconnection Failed.\n        <button class=""btn btn-light btn-sm m-1""\n                onclick=""window.Blazor.reconnect()"">\n            Reconnect\n        </button>\n    </div>\n    <div class=""rejected"">\n        Reconnection Rejected.\n        <button class=""btn btn-light btn-sm m-1"" \n                onclick=""location.reload()"">\n            Reload\n        </button>\n    </div>\n</div>\n<component type=""typeof(Advanced.Blazor.DepartmentList)"" \n    render-mode=""Server"" />\nThe id attribute of the custom error element must be components-reconnect-modal . \nWhen there is a connection error, Blazor locates this element and adds it to one of four \nclasses, described in table 34.2. \nTable 34.2    The connection error classes\nName Description\ncomponents-reconnect-show The element is added to this class when the  \nconnection has been lost and Blazor is attempting a \nreconnection. The error message should be displayed \nto the user, and interaction with the Blazor content \nshould be prevented.\ncomponents-reconnect-hide The element is added to this class if the connection is \nreestablished. The error message should be hidden, \nand interaction should be permitted.\ncomponents-reconnect-failed The element is added to this class if Blazor reconnec-\ntion fails. The user can be presented with a button \nthat invokes window.Blazor.reconnect()  to \nattempt reconnection.\ncomponents-reconnect-rejected The element is added to this class if Blazor is able to \nreach the server but the user’s connection state has \nbeen lost. This typically happens when the server has \nbeen restarted. The user can be presented with a \nbutton that invokes location.reload()  to reload \nthe application and try again.\nThe element isn’t added to any of these classes initially, so I have explicitly added it to \nthe components-reconnect-hide  class so that it isn’t visible until a problem occurs.\nI want to present specific messages to the user for each of the conditions that can \narise during reconnection. To this end, I added elements that display a message for \neach condition. To manage their visibility, add a CSS stylesheet named connection-\nErrors.css  to the wwwroot  folder and use it to define the styles shown in listing 34.29.\n 1033 Handling errors\nListing 34.29    The contents of the connectionErrors.css file in the wwwroot folder\n#components-reconnect-modal {\n    position: fixed; top: 0; right: 0; bottom: 0;\n    left: 0; z-index: 1000; overflow: hidden; opacity: 0.9;\n}\n.components-reconnect-hide { display: none; }\n.components-reconnect-show { display: block; }\n.components-reconnect-show > .reconnect { display: block; }\n.components-reconnect-show > .failed, \n.components-reconnect-show > .rejected {\n    display: none;\n}\n.components-reconnect-failed > .failed {\n    display: block;\n}\n.components-reconnect-failed > .reconnect, \n.components-reconnect-failed > .rejected {\n    display: none;\n}\n.components-reconnect-rejected > .rejected {\n    display: block;\n}\n.components-reconnect-rejected > .reconnect, \n.components-reconnect-rejected > .failed {\n    display: none;\n}\nThese styles show the components-reconnect-modal  element as a modal item, \nwith its visibility determined by the components-reconnect-hide  and components \n- reconnect-show  classes. The visibility of the specific messages is toggled based on \nthe application of the classes in table 34.2.\nTo see the effect, restart ASP.NET Core and request http://localhost:5000/pages/\nblazor. Wait until the component is displayed and then stop the ASP.NET Core server. \nYou will see an initial error message as Blazor attempts to reconnect. After a few min-\nutes, you will see the message that indicates that reconnection has failed.\nRestart ASP.NET Core and request http://localhost:5000/pages/blazor. Wait until \nthe component is displayed and then restart ASP.NET Core. This time Blazor will be \nable to connect to the server, but the connection will be rejected because the server \nrestart has caused the connection state to be lost. Figure 34.12 shows both sequences of \nerror messages.\nTIP    It is not possible to test successful connection recovery with just the browser \nbecause there is no way to interrupt the persistent HTTP connection. I use the \nexcellent Fiddler proxy, https://www.telerik.com/fiddler , which allows me to \nterminate the connection without stopping the ASP.NET Core server.",5948
425-34.4.2 Handling uncaught application errors.pdf,425-34.4.2 Handling uncaught application errors,"1034 chapter  34 Using Blazor Server, part 2 \nFigure 34.12    Handling connection errors\n34.4.2  Handling uncaught application errors\nBlazor does not respond well to uncaught application errors, which are almost always \ntreated as terminal. To demonstrate the way that exceptions are handled, listing 34.30 \nintroduces an exception that will be thrown when the user selects a specific value.\nListing 34.30    Introducing an exception in the SelectFilter.razor file in the Blazor folder\n<div class=""form-group p-2 bg-@Theme @TextColor()"">\n    <label for=""select-@Title"">@Title</label>\n    <select name=""select-@Title"" class=""form-control""\n            @onchange=""HandleSelect"" value=""@SelectedValue"">\n        <option disabled selected value="""">Select @Title</option>\n        @foreach (string val in Values) {\n            <option value=""@val"" selected=""@(val == SelectedValue)"">\n                @val\n            </option>\n        }\n    </select>\n</div>\n@code {\n    [Parameter]\n    public IEnumerable<string> Values { get; set; }\n        = Enumerable.Empty<string>();\n    [Parameter]\n    public string? SelectedValue { get; set; }\n    [Parameter]\n    public string Title { get; set; } = ""Placeholder"";\n    [Parameter(CaptureUnmatchedValues = true)]\n    public Dictionary<string, object>? Attrs { get; set; }\n    [Parameter]\n    public EventCallback<string> SelectedValueChanged { get; set; }\n 1035 Handling errors\n    public async Task HandleSelect(ChangeEventArgs e) {\n        SelectedValue = e.Value as string;\n        if (SelectedValue == ""Sales"") {\n            throw new Exception(""Sales cannot be selected"");\n        }\n        await SelectedValueChanged.InvokeAsync(SelectedValue);\n    }\n    [CascadingParameter(Name = ""BgTheme"")]\n    public string Theme { get; set; } = """";\n    public string TextColor() => String.IsNullOrEmpty(Theme)\n        ? ""text-dark"" : ""text-light"";\n}\nRestart ASP.NET Core, request http://localhost:5000/pages/blazor, and select Sales \nfrom the Highlight menu. There is no visible change in the browser, but the exception \nthrown at the server when the button was clicked has proved fatal: the user can still \nchoose values using the select elements because these are presented by the browser, \nbut the event handlers that respond to selections no longer work, and the application \nis essentially dead.\nWhen there is an unhandled application error, Blazor looks for an element whose id \nis blazor-error-ui  and sets its CSS display  property to block . Listing 34.31 adds an \nelement with this id to the Blazor.cshtml  file styled to present a useful message.  \nListing 34.31    Adding an error element in the Blazor.cshtml file in the Pages folder \n@page ""/pages/blazor""\n<h4 class=""bg-primary text-white text-center p-2"">Departments</h4>\n<link rel=""stylesheet"" href=""connectionErrors.css"" />\n<div id=""components-reconnect-modal""\n     class=""h4 bg-dark text-white text-center my-2 p-2 \n            components-reconnect-hide"">\n    Blazor Connection Lost\n    <div class=""reconnect"">\n        Trying to reconnect...\n    </div>\n    <div class=""failed"">\n        Reconnection Failed.\n        <button class=""btn btn-light btn-sm m-1""\n                onclick=""window.Blazor.reconnect()"">\n            Reconnect\n        </button>\n    </div>\n    <div class=""rejected"">\n        Reconnection Rejected.\n        <button class=""btn btn-light btn-sm m-1"" \n                onclick=""location.reload()"">\n            Reload\n        </button>",3520
426-34.4.3 Using error boundaries.pdf,426-34.4.3 Using error boundaries,"1036 chapter  34 Using Blazor Server, part 2 \n    </div>\n</div>\n<div id=""blazor-error-ui"" \n     class=""text-center bg-danger h6 text-white p-2 fixed-top w-100""\n     style=""display:none"">\n    An error has occurred. This application will not respond until reloaded.\n    <button class=""btn btn-sm btn-primary m-1"" onclick=""location.reload()"">\n        Reload\n    </button>\n</div>\n<component type=""typeof(Advanced.Blazor.DepartmentList)"" \n    render-mode=""Server"" />\nWhen the element is shown, the user will be presented with a warning and a button \nthat reloads the browser. To see the effect, restart ASP.NET Core, request http://  \nlocalhost:5000/pages/blazor, and select Sales from the Highlight menu, which will dis-\nplay the message shown in figure 34.13.\nFigure 34.13.   \nDisplaying an \nerror message\n34.4.3  Using error boundaries\nError boundaries are used to contain errors within the component hierarchy so that a \ncomponent can take responsibility for its own exceptions and the exceptions thrown \nby its child components. Listing 34.32 introduces an error boundary to contain the \nexception thrown by the SelectFilter  component.  \nListing 34.32    An error boundary in the TableTemplate.razor file in the Blazor folder\n...\n@typeparam RowType\n<link rel=""stylesheet"" href=""errorBoundaries.css"" />\n<div class=""container-fluid"">\n    <div class=""row p-2"">\n        <div class=""col"">\n            <SelectFilter Title=""@(""Sort"")"" \n                Values=""@SortDirectionChoices""\n                @bind-SelectedValue=""SortDirectionSelection"" />\n        </div>\n        <div class=""col"">\n            <ErrorBoundary>\n                <SelectFilter Title=""@(""Highlight"")"" \n 1037 Handling errors\n                    Values=""@HighlightChoices()""\n                    @bind-SelectedValue=""HighlightSelection"" />\n            </ErrorBoundary>\n        </div>\n    </div>\n</div>\n<table class=""table table-sm table-bordered table-striped"">\n    @if (Header != null) {\n        <thead>@Header</thead>\n    }\n    <tbody>\n        @if (RowTemplate != null) {\n            @foreach (RowType item in SortedData()) {\n                <tr class=""@IsHighlighted(item)"">@RowTemplate(item)</tr>\n            }\n        }\n    </tbody>\n</table>\n...\nError boundaries are defined using the ErrorBoundary  component, which displays its \nchild content normally until an exception is thrown, at which point the child content is \nremoved and a div element assigned to a blazor-error-boundary  class is displayed. \nTo define the content and styles that will be displayed, add a CSS stylesheet named \nerrorBoundaries.css  to the wwwroot  folder with the content shown in listing 34.33.\nListing 34.33    The contents of the errorBoundaries.css file in the wwwroot folder\n.blazor-error-boundary {\n    background-color: darkred;\n    color: white;\n    padding: 1rem;\n    text-align: center;\n    vertical-align: middle;\n    height: 100%;\n    font-size: large;\n    font-weight: bold;\n}\n.blazor-error-boundary::after {\n    content: ""Error: Sales selected""\n}\nThe CSS in the stylesheet displays a basic error message, which is styled in white text on \na red background. (Don’t worry about how these styles work because there are easier \nways to define error messages, as I explain shortly.)\nTo see the effect of the error boundary, restart ASP.NET Core, request http://  \nlocalhost:5000/pages/blazor, and select Sales from the Highlight menu. An exception \nis thrown when the selection is made, which is contained by the error boundary, display-\ning the message shown in figure 34.14. Only the content contained within the Error-\nBoundary  component is affected by the exception, which means that the rest of the \napplication works as normal, which means that the user can still change the sort order.\n1038 chapter  34 Using Blazor Server, part 2 \nFigure 34.14    Using an error boundary\ndefining  error  content  within  the boundary\nDefining the error message in a CSS stylesheet is awkward, and I prefer to define the \nerror content as part of the error boundary, as shown in listing 34.34.\nListing 34.34    Defining error content in the TableTemplate.razor file in the Blazor folder\n...\n<div class=""container-fluid"">\n    <div class=""row p-2"">\n        <div class=""col"">\n            <SelectFilter Title=""@(""Sort"")"" Values=""@SortDirectionChoices"" \n                @bind-SelectedValue=""SortDirectionSelection"" />\n        </div>\n        <div class=""col"">\n            <ErrorBoundary>\n                <ChildContent>\n                    <SelectFilter Title=""@(""Highlight"")"" \n                        Values=""@HighlightChoices()"" \n                        @bind-SelectedValue=""HighlightSelection"" />\n                </ChildContent>\n                <ErrorContent>\n                    <h4 class=""bg-danger text-white text-center h-100 p-2"">\n                        Inline error: Sales Selected\n                    </h4>\n                </ErrorContent>\n            </ErrorBoundary>\n        </div>\n    </div>\n</div>\n...\nThe ChildContent  and ErrorContent  tags are used to specify the content that will be \ndisplayed normally and when an exception has been thrown. Restart ASP.NET Core, \nrequest http://localhost:5000/pages/blazor, and select Sales from the Highlight \nmenu to see the new error message, which is shown in figure 34.15.\n 1039 Handling errors\nFigure 34.15    \nError content \ndefined within the \nboundary\nrecovering  from exceptions\nError boundaries allow an application to recover from exceptions, as shown in listing \n34.35, although care should be taken to ensure that whatever problem caused the issue \noriginally has truly been resolved. \nListing 34.35    A recoverable error boundary in the Blazor/TableTemplate.razor file \n@typeparam RowType\n<link rel=""stylesheet"" href=""errorBoundaries.css"" />\n<div class=""container-fluid"">\n    <div class=""row p-2"">\n        <div class=""col"">\n            <SelectFilter Title=""@(""Sort"")"" \n                Values=""@SortDirectionChoices""\n                @bind-SelectedValue=""SortDirectionSelection"" />\n        </div>\n        <div class=""col"">\n            <ErrorBoundary @ref=""boundary"">\n                <ChildContent>\n                    <SelectFilter Title=""@(""Highlight"")"" \n                        Values=""@HighlightChoices()"" \n                        @bind-SelectedValue=""HighlightSelection"" />\n                </ChildContent>\n                <ErrorContent>\n                    <h4 class=""bg-danger text-white text-center h-100 p-2"">\n                        Inline error: Sales Selected\n                        <div>\n                            <button class=""btn btn-light btn-sm m-1"" \n                                @onclick=""@(() => boundary?.Recover())"">\n                                    Recover\n                            </button>\n                        </div>\n                    </h4>\n                </ErrorContent>\n            </ErrorBoundary>\n        </div>\n    </div>\n1040 chapter  34 Using Blazor Server, part 2 \n</div>\n<table class=""table table-sm table-bordered table-striped"">\n    @if (Header != null) {\n        <thead>@Header</thead>\n    }\n    <tbody>\n        @if (RowTemplate != null) {\n            @foreach (RowType item in SortedData()) {\n                <tr class=""@IsHighlighted(item)"">@RowTemplate(item)</tr>\n            }\n        }\n    </tbody>\n</table>\n@code {\n    ErrorBoundary? boundary;\n    // ...other members omitted for brevity...\n}\nThe @ref  binding is used to obtain a reference to the ErrorBoundary , which defines \na Recover  method. The error content presented to the user contains a button that \ninvokes the Recover  method when clicked, allowing the user to recover from the error. \nRestart ASP.NET Core, request http://localhost:5000/pages/blazor, and select Sales \nfrom the Highlight menu to trigger the error; then click the Recover button, which will \ndisplay the child content once again, as shown in figure 34.16.\nFigure 34.16    Recovering from an error \nSummary\n¡ Blazor components can be combined to present composite features to users.\n¡ Components can be configured using attributes in markup, which are received \nby applying the Parameter  attribute to code properties.\n¡ Components can define custom events, which can be consumed in the parent \ncomponent’s markup. \n 1041 Handling errors\n¡ Components can also be wrappers around content, which is projected using the \n@ChildContent  expression. Multiple sections of content can be presented by \ntemplate components.\n¡ Errors can be presented to the user by defining elements with specific classes, as \ndescribed in table 34.2. These include connection errors and uncaught applica-\ntion errors.\n¡ The effect of errors can be contained using error boundaries.",8851
427-35 Advanced Blazor features.pdf,427-35 Advanced Blazor features,"104235Advanced Blazor features\nThis chapter covers\n¡ Creating routes that map requests to Blazor  \n components\n¡ Navigating between components and receiving  \n route data in a component\n¡ Using a layout with a routed component \n¡ Implementing the component lifecycle methods\n¡ Managing interaction between components and  \n with JavaScript code\nIn this chapter, I explain how Blazor supports URL routing so that multiple compo-\nnents can be displayed through a single request. I show you how to set up the rout-\ning system, how to define routes, and how to create common content in a layout. \nThis chapter also covers the component lifecycle, which allows components to par-\nticipate actively in the Blazor environment, which is especially important once you \nstart using the URL routing feature. Finally, this chapter explains the different ways \nthat components can interact outside of the parent-child relationships described in \nearlier chapters. Table 35.1 puts these features in context.\n 1043  \nTable 35.1    Putting Blazor routing and lifecycle component interactions in context\nQuestion Answer\nWhat are they? The routing feature allows components to respond \nto changes in the URL without requiring a new HTTP \nconnection. The lifecycle feature allows components \nto define methods that are invoked as the applica -\ntion executes, and the interaction features provide \nuseful ways of communicating between components \nand with other JavaScript code. \nWhy are they useful? These features allow the creation of complex \napplications that take advantage of the Blazor \narchitecture. \nHow are they used? URL routing is set up using built-in components and \nconfigured using @page  directives. The lifecycle \nfeatures are used by overriding methods in a compo-\nnent’s @code  section. The interaction features are \nused in different ways depending on what a compo-\nnent is interacting with.\nAre there any pitfalls or \nlimitations?These are advanced features that must be used with \ncare, especially when creating interactions outside \nof Blazor.\nAre there any alternatives? All the features described in this chapter are \noptional, but it is hard to create complex applica-\ntions without them.\nTable 35.2 provides a guide to the chapter.\nTable 35.2    Chapter guide\nProblem Solution Listing\nSelecting components based \non the current URLUse URL routing. 6–12\nDefining content that will be \nused by multiple componentsUse a layout. 13, 14\nResponding to the stages of \nthe component’s lifecycleImplement the lifecycle notification \nmethods.15–17\nCoordinating the activities of \nmultiple componentsRetain references with the @ref  \nexpression.18, 19\nCoordinating with code outside \nof BlazorUse the interoperability features. 20–35",2789
428-35.1 Preparing for this chapter.pdf,428-35.1 Preparing for this chapter,,0
429-35.2.1 Preparing the Razor Page.pdf,429-35.2.1 Preparing the Razor Page,"1044 chapter  35 Advanced Blazor features\n35.1 Preparing for this chapter\nThis chapter uses the Advanced project from chapter 35. No changes are required for \nthis chapter. \nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nOpen a new PowerShell command prompt, navigate to the folder that contains the \nAdvanced.csproj  file, and run the command shown in listing 35.1 to drop the \ndatabase.\nListing 35.1    Dropping the database\ndotnet ef database drop --force\nUse the PowerShell command prompt to run the command shown in listing 35.2. \nListing 35.2    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers, which will display a list \nof data items. Request http://localhost:5000/pages/blazor, and you will see the com-\nponent from chapter 34 that I used to demonstrate bindings. Figure 35.1 shows both \nresponses.\nFigure 35.1    Running the example application \n35.2 Using component routing\nBlazor includes support for selecting the components to display to the user based on \nthe ASP.NET Core routing system so that the application responds to changes in the \nURL by displaying different Razor Components. To get started, add a Razor Compo-\nnent named Routed.razor  to the Blazor  folder with the content shown in listing \n35.3.  \n 1045 Using component routing\nListing 35.3    The contents of the Routed.razor file in the Blazor folder\n<Router AppAssembly=""typeof(Program).Assembly"">\n    <Found>\n        <RouteView RouteData=""@context"" />\n    </Found>\n    <NotFound>\n        <h4 class=""bg-danger text-white text-center p-2"">\n            No Matching Route Found\n        </h4>\n    </NotFound>\n</Router>\nThe Router  component is included with ASP.NET Core and provides the link between \nBlazor and the ASP.NET Core routing features. Router  is a generic template compo-\nnent that defines Found  and NotFound  sections.\nThe Router  component requires the AppAssembly  attribute, which specifies the \n.NET assembly to use. For most projects this is the current assembly, which is specified \nlike this:\n...\n<Router AppAssembly=""typeof(Program).Assembly"" >\n...\nThe type of the Router  component’s Found  property is RenderFragment<Route-\nData> , which is passed on to the RouteView  component through its RouteData  prop-\nerty, like this:\n...\n<Found>\n    <RouteView RouteData=""@context"" />\n</Found>\n...\nThe RouteView  component is responsible for displaying the component matched by \nthe current route and, as I explain shortly, for displaying common content through \nlayouts. The type of the NotFound  property is RenderFragment , without a generic type \nargument, and displays a section of content when no component can be found for the \ncurrent route.\n35.2.1  Preparing the Razor Page\nIndividual components can be displayed in existing controller views and Razor Pages, \nas previous chapters have shown. But when using component routing, it is preferable \nto create a set of URLs that are distinct to working with Blazor because the way that \nURLs are supported is limited and leads to tortured workarounds. Add a Razor Page \nnamed _Host.cshtml  to the Pages  folder and add the content shown in listing 35.4.\nListing 35.4    The contents of the _Host.cshtml file in the Pages folder\n@page ""/""\n@{ Layout = null; }\n<!DOCTYPE html>\n1046 chapter  35 Advanced Blazor features\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <base href=""~/"" />  \n</head>\n<body>    \n    <div class=""m-2"">\n        <component type=""typeof(Advanced.Blazor.Routed)"" \n            render-mode=""Server"" />\n    </div>\n    <script src=""_framework/blazor.server.js""></script>\n</body>\n</html>\nThis page contains a component  element that applies the Routed  component defined \nin listing 35.4 and a script  element for the Blazor JavaScript code. There is also a \nlink  element for the Bootstrap CSS stylesheet. Alter the configuration for the example \napplication to use the _Host.cshtml  file as a fallback when requests are not matched \nby the existing URL routes, as shown in listing 35.5.  \nListing 35.5    Adding the fallback in the Progam.cs file in the Advanced folder\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();",5280
430-35.2.2 Adding routes to components.pdf,430-35.2.2 Adding routes to components,"1047 Using component routing\nThe MapFallbackToPage  method configures the routing system to use the _Host  \npage as a last resort for unmatched requests.  \n35.2.2  Adding routes to components\nComponents declare the URLs for which they should be displayed using @page  direc-\ntives. Listing 35.6 adds the @page  directive to the PeopleList  component.  \nListing 35.6    Adding a directive in the PeopleList.razor file in the Blazor folder\n@page ""/people""\n<TableTemplate RowType=""Person"" RowData=""People""\n        Highlight=""@(p => p.Location?.City)"" \n        SortDirection=""@(p => p.Surname)"">\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </Header>\n    <RowTemplate Context=""p"">\n        <td>@p.PersonId</td>\n        <td>@p.Surname, @p.Firstname</td>\n        <td>@p.Department?.Name</td>\n        <td>@p.Location?.City, @p.Location?.State</td>\n    </RowTemplate>\n</TableTemplate>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location);\n}\nThe directive in listing 35.6 means the PeopleList  component will be displayed for \nthe http://localhost:5000/people URL. Components can declare support for more \nthan one route using multiple @page  directives. Listing 35.7 adds @page  directives to \nthe DepartmentList  component to support two URLs.\nListing 35.7    Adding a directive in the DepartmentList.razor file in the Blazor folder\n@page ""/departments""\n@page ""/depts""\n<CascadingValue Name=""BgTheme"" Value=""Theme"" IsFixed=""false"">\n    <TableTemplate RowType=""Department"" RowData=""Departments""\n                   Highlight=""@(d => d.Name)""\n                   SortDirection=""@(d => d.Name)"">\n        <Header>\n        <tr>\n            <th>ID</th><th>Name</th><th>People</th><th>Locations</th>\n1048 chapter  35 Advanced Blazor features\n        </tr>\n        </Header>\n        <RowTemplate Context=""d"">\n            <td>@d.Departmentid</td>\n            <td>@d.Name</td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p => p.Surname)))\n            </td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p =>\n                    p.Location!.City).Distinct()))\n            </td>\n        </RowTemplate>\n    </TableTemplate>\n</CascadingValue>\n<SelectFilter Title=""@(""Theme"")"" Values=""Themes""\n              @bind-SelectedValue=""Theme"" />\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Department>? Departments => Context?.Departments?\n        .Include(d => d.People!).ThenInclude(p => p.Location!);\n    public string Theme { get; set; } = ""info"";\n    public string[] Themes = \n        new string[] { ""primary"", ""info"", ""success"" };\n}\nMost of the routing pattern features described in chapter 13 can be used in @page  \nexpressions, except catchall segment variables and optional segment variables. Using \ntwo @page  expressions, one with a segment variable, can be used to re-create the \noptional variable feature, as demonstrated in chapter 36, where I show you how to \nimplement a CRUD application using Blazor.\nTo see the basic Razor Component routing feature at work, restart ASP.NET Core \nand request http://localhost:5000/people and http://localhost:5000/depts. Each \nURL displays one of the components in the application, as shown in figure 35.2.\nFigure 35.2    Enabling Razor Component routing in the example application \n 1049 Using component routing\nsetting  a default  component  route  \nThe configuration change in listing 35.5 sets up the fallback route for requests. A \ncorresponding route is required in one of the application’s components to identify \nthe component that should be displayed for the application’s default URL, http://   \nlocalhost:5000, as shown in listing 35.8.  \nListing 35.8    Defining the default route in the PeopleList.razor file in the Blazor folder\n@page ""/people""\n@page ""/""\n<TableTemplate RowType=""Person"" RowData=""People""\n        Highlight=""@(p => p.Location?.City)"" \n        SortDirection=""@(p => p.Surname)"">\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </Header>\n    <RowTemplate Context=""p"">\n        <td>@p.PersonId</td>\n        <td>@p.Surname, @p.Firstname</td>\n        <td>@p.Department?.Name</td>\n        <td>@p.Location?.City, @p.Location?.State</td>\n    </RowTemplate>\n</TableTemplate>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location);\n}\nRestart ASP.NET Core and request http://localhost:5000, and you will see the content \nproduced by the PeopleList  component, as shown in figure 35.3.\nFigure 35.3    \nDisplaying a \ncomponent for \nthe default URL",4970
431-35.2.3 Navigating between routed components.pdf,431-35.2.3 Navigating between routed components,"1050 chapter  35 Advanced Blazor features\n35.2.3  Navigating between routed components\nThe basic routing configuration is in place, but it may not be obvious why using \nroutes offers any advantages over the independent components demonstrated in ear-\nlier chapters. Improvements come through the NavLink  component, which renders \nanchor elements that are wired into the routing system. Listing 35.9 adds NavLink  to \nthe PeopleList  component.  \nListing 35.9    Adding navigation in the PeopleList.razor file in the Blazor folder\n@page ""/people""\n@page ""/""\n<TableTemplate RowType=""Person"" RowData=""People""\n        Highlight=""@(p => p.Location?.City)"" \n        SortDirection=""@(p => p.Surname)"">\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th></tr>\n    </Header>\n    <RowTemplate Context=""p"">\n        <td>@p.PersonId</td>\n        <td>@p.Surname, @p.Firstname</td>\n        <td>@p.Department?.Name</td>\n        <td>@p.Location?.City, @p.Location?.State</td>\n    </RowTemplate>\n</TableTemplate>\n<NavLink class=""btn btn-primary"" href=""/depts"">Departments</NavLink>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location);\n}\nUnlike the anchor elements used in other parts of ASP.NET Core, Navlink  compo-\nnents are configured using URLs and not component, page, or action names. The \nNavLink  in this example navigates to the URL supported by the @page  directive of the \nDepartmentList  component. \nNavigation can also be performed programmatically, which is useful when a compo-\nnent responds to an event and then needs to navigate to a different URL, as shown in \nlisting 35.10.\nListing 35.10.   Navigating in the DepartmentList.razor file in the Blazor folder\n@page ""/departments""\n@page ""/depts""\n 1051 Using component routing\n<CascadingValue Name=""BgTheme"" Value=""Theme"" IsFixed=""false"">\n    <TableTemplate RowType=""Department"" RowData=""Departments""\n                   Highlight=""@(d => d.Name)""\n                   SortDirection=""@(d => d.Name)"">\n        <Header>\n        <tr>\n            <th>ID</th><th>Name</th><th>People</th><th>Locations</th>\n        </tr>\n        </Header>\n        <RowTemplate Context=""d"">\n            <td>@d.Departmentid</td>\n            <td>@d.Name</td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p => p.Surname)))\n            </td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p =>\n                    p.Location!.City).Distinct()))\n            </td>\n        </RowTemplate>\n    </TableTemplate>\n</CascadingValue>\n<SelectFilter Title=""@(""Theme"")"" Values=""Themes""\n    @bind-SelectedValue=""Theme"" />\n<button class=""btn btn-primary"" @onclick=""HandleClick"">People</button>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Department>? Departments => Context?.Departments?\n        .Include(d => d.People!).ThenInclude(p => p.Location!);\n    public string Theme { get; set; } = ""info"";\n    public string[] Themes = \n        new string[] { ""primary"", ""info"", ""success"" };\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    public void HandleClick() => NavManager?.NavigateTo(""/people"");\n}\nThe NavigationManager  class provides programmatic access to navigation. Table 35.3 \ndescribes the most important members provided by the NavigationManager  class.  \n1052 chapter  35 Advanced Blazor features\nTable 35.3    Useful NavigationManager members\nName Description\nNavigateTo(url) This method navigates to the specified \nURL without sending a new HTTP request.\nToAbsoluteUri(path) This method converts a relative path to a \ncomplete URL.\nToBaseRelativePath(url) This method gets a relative path from a \ncomplete URL.\nLocationChanged This event is triggered when the location \nchanges.\nUri This property returns the current URL.\nThe NavigationManager  class is provided as a service and is received by Razor Com-\nponents using the Inject  attribute, which provides access to the dependency injection \nfeatures described in chapter 14. \nThe NavigationManager.NavigateTo  method navigates to a URL and is used in \nthis example to navigate to the /people  URL, which will be handled by the People-\nList  component.\nTo see why routing and navigation are important, restart ASP.NET Core and request \nhttp://localhost:5000/people. Click the Departments link, which is styled as a button, \nand the DepartmentList  component will be displayed. Click the People link, and you \nwill return to the PeopleList  component, as shown in figure 35.4.\nFigure 35.4    \nNavigating \nbetween routed \ncomponents\nIf you perform this sequence with the F12 developer tools open, you will see that the \ntransition from one component to the next is done without needing a separate HTTP \nrequest, even though the URL displayed by the browser changes. Blazor delivers the \ncontent rendered by each component over the persistent HTTP connection that is \nestablished when the first component is displayed and uses a JavaScript API to navigate \nwithout loading a new HTML document.",5265
432-35.2.4 Receiving routing data.pdf,432-35.2.4 Receiving routing data,"1053 Using component routing\nTIP    The NavigationManager.NavigateTo  method accepts an optional argu-\nment that, when true , forces the browser to send a new HTTP request and \nreload the HTML document.\n35.2.4  Receiving routing data\nComponents can receive segment variables by decorating a property with the Parameter  \nattribute. To demonstrate, add a Razor Component named PersonDisplay.razor  to \nthe Blazor  folder with the content shown in listing 35.11.  \nListing 35.11    The contents of the PersonDisplay.razor file in the Blazor folder\n@page ""/person"" \n@page ""/person/{id:long}""\n<h5>Editor for Person: @Id</h5>\n<NavLink class=""btn btn-primary"" href=""/people"">Return</NavLink>\n@code {\n    [Parameter]\n    public long Id { get; set; }\n}\nThis component doesn’t do anything other than displaying the value it receives from \nthe routing data until I add features later in the chapter. The @page  expression includes \na segment variable named id, whose type is specified as long . The component receives \nthe value assigned to the segment variable by defining a property with the same name \nand decorating it with the Parameter  attribute.\nTIP If you don’t specify a type for segment variables in the @page  expression, \nthen you must set the type of the property to be string . \nListing 35.12 uses the NavLink  component to create navigation links for each of the \nPerson  objects displayed by the PeopleList  component.\nListing 35.12    Adding navigation links in the PeopleList.razor file in the Blazor folder\n@page ""/people""\n@page ""/""\n<TableTemplate RowType=""Person"" RowData=""People""\n        Highlight=""@(p => p.Location?.City)"" \n        SortDirection=""@(p => p.Surname)"">\n    <Header>\n        <tr><th>ID</th><th>Name</th><th>Dept</th><th>Location</th>\n            <td></td>\n        </tr>\n    </Header>\n    <RowTemplate Context=""p"">\n1054 chapter  35 Advanced Blazor features\n        <td>@p.PersonId</td>\n        <td>@p.Surname, @p.Firstname</td>\n        <td>@p.Department?.Name</td>\n        <td>@p.Location?.City, @p.Location?.State</td>\n        <td>\n            <NavLink class=""btn btn-sm btn-info"" \n                    href=""@GetEditUrl(p.PersonId)"">\n                Edit\n            </NavLink>\n        </td>\n    </RowTemplate>\n</TableTemplate>\n<NavLink class=""btn btn-primary"" href=""/depts"">Departments</NavLink>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person>? People => Context?.People\n            .Include(p => p.Department)\n            .Include(p => p.Location);\n    public string GetEditUrl(long id) => $""/person/{id}"";\n}\nRazor Components do not support mixing static content and Razor expressions in \nattribute values. Instead, I have defined the GetEditUrl  method to generate the \nnavigation URLs for each Person  object, which is called to produce the value for the \nNavLink  href  attributes.\nRestart ASP.NET Core, request http://localhost:5000/people, and click one of the \nEdit buttons. The browser will navigate to the new URL without reloading the HTML \ndocument and display the placeholder content generated by the PersonDisplay  com-\nponent, as shown in figure 35.5, which shows how a component can receive data from \nthe routing system.\nFigure 35.5    Receiving data from the routing system in a Razor Component",3358
433-35.2.5 Defining common content using layouts.pdf,433-35.2.5 Defining common content using layouts,"1055 Using component routing\n35.2.5  Defining common content using layouts\nLayouts are template components that provide common content for Razor Compo-\nnents. To create a layout, add a Razor Component called NavLayout.razor  to the \nBlazor  folder and add the content shown in listing 35.13.  \nListing 35.13    The contents of the NavLayout.razor file in the Blazor folder\n@inherits LayoutComponentBase\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col-3"">\n            <div class=""d-grid gap-2"">\n                @foreach (string key in NavLinks.Keys) {\n                    <NavLink class=""btn btn-outline-primary""\n                             href=""@NavLinks[key]"" \n                             ActiveClass=""btn-primary text-white"" \n                             Match=""NavLinkMatch.Prefix"">\n                        @key\n                    </NavLink>\n                }\n            </div>\n        </div>\n        <div class=""col"">\n            @Body\n        </div>\n    </div>\n</div>\n@code {\n    public Dictionary<string, string> NavLinks\n        = new Dictionary<string, string> {\n            {""People"", ""/people"" },\n            {""Departments"", ""/depts"" },\n            {""Details"", ""/person"" }\n        };\n}\nLayouts use the @inherits  expression to specify the LayoutComponentBase  class as \nthe base for the class generated from the Razor Component. The LayoutComponent-\nBase  class defines a RenderFragment  class named Body  that is used to specify the con-\ntent from components within the common content displayed by the layout. In this \nexample, the layout component creates a grid layout that displays a set of NavLink  \ncomponents for each of the components in the application. The NavLink  components \nare configured with two new attributes, described in table 35.4.  \n1056 chapter  35 Advanced Blazor features\nTable 35.4    The NavLink configuration attributes\nName Description\nActiveClass This attribute specifies one or more CSS classes that the anchor element \nrendered by the NavLink  component will be added to when the current \nURL matches the href  attribute value.\nMatch This attribute specifies how the current URL is matched to the href  \nattribute, using a value from the NavLinkMatch  enum. The values are \nPrefix , which considers a match if the href  matches the start of the \nURL, and All, which requires the entire URL to be the same.\nThe NavLink  components are configured to use Prefix  matching and to add the \nanchor elements they render to the Bootstrap btn-primary  and text-white  classes \nwhen there is a match.\napplying  a layout  \nThere are three ways that a layout can be applied. A component can select its own lay-\nout using an @layout  expression. A parent can use a layout for its child components by \nwrapping them in the built-in LayoutView  component. A layout can be applied to all \ncomponents by setting the DefaultLayout  attribute of the RouteView  component, as \nshown in listing 35.14.  \nListing 35.14    Applying a layout in the Routed.razor file in the Blazor folder\n<Router AppAssembly=""typeof(Program).Assembly"">\n    <Found>\n        <RouteView RouteData=""@context"" \n            DefaultLayout=""typeof(NavLayout)"" />\n    </Found>\n    <NotFound>\n        <h4 class=""bg-danger text-white text-center p-2"">\n            No Matching Route Found\n        </h4>\n    </NotFound>\n</Router>\nRestart ASP.NET Core and request http://localhost:5000/people. The layout will be \ndisplayed with the content rendered by the PeopleList  component. The navigation \nbuttons on the left side of the layout can be used to navigate through the application, \nas shown in figure 35.6. \nFigure 35.6    Using a layout component",3746
434-35.3 Understanding the component lifecycle methods.pdf,434-35.3 Understanding the component lifecycle methods,"1057 Understanding the component lifecycle methods\nNOTE    If you request http://localhost:5000, you will see the content from the \nPeopleList  component, but the corresponding navigation button will not be \nhighlighted. I show you how to resolve this problem later in the chapter. \n35.3 Understanding the component lifecycle methods\nRazor Components have a well-defined lifecycle, which is represented with methods \nthat components can implement to receive notifications of key transitions. Table 35.5 \ndescribes the lifecycle methods.  \nTable 35.5    The Razor Component lifecycle methods\nName Description\nOnInitialized()\nOnInitializedAsync()These methods are invoked when the component is \nfirst initialized.\nOnParametersSet()\nOnParametersSetAsync()These methods are invoked after the values for \nproperties decorated with the Parameter  attri-\nbute have been applied.\nShouldRender() This method is called before the component’s con-\ntent is rendered to update the content presented to \nthe user. If the method returns false , the compo-\nnent’s content will not be rendered, and the update \nis suppressed. This method does not suppress the \ninitial rendering for the component.\nOnAfterRender(first)\nOnAfterRenderAsync(first)This method is invoked after the component’s \ncontent is rendered. The bool  parameter is true  \nwhen Blazor performs the initial render for the \ncomponent.\nUsing either the OnInitialized  or OnParameterSet  method is useful for setting the \ninitial state of the component. The layout defined in the previous section doesn’t deal \nwith the default URL because the NavLink  component matches only a single URL. \nThe same issue exists for the DepartmentList  component, which can be requested \nusing the /departments  and /depts  paths.\nUnderstanding lifecycles for routed components\nWhen using URL routing, components can be removed from the display when the URL \nchanges. Components can implement the System.IDisposable  interface, and Blazor \nwill call the method when the component is removed. \nCreating a component that matches multiple URLs requires the use of lifecycle meth-\nods. To understand why, add a Razor Component named MultiNavLink.razor  to the \nBlazor  folder with the content shown in listing 35.15.\n1058 chapter  35 Advanced Blazor features\nListing 35.15    The contents of the MultiNavLink.razor file in the Blazor folder\n<a class=""@ComputedClass"" @onclick=""HandleClick""  href="""">\n    @ChildContent\n</a>\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Parameter]\n    public IEnumerable<string> Href { get; set; } \n        = Enumerable.Empty<string>();\n    [Parameter]\n    public string Class { get; set; } = string.Empty;\n    [Parameter]\n    public string ActiveClass { get; set; } = string.Empty;\n    [Parameter]\n    public NavLinkMatch? Match { get; set; }\n    public NavLinkMatch ComputedMatch { get =>\n            Match ?? (Href.Count() == 1 \n                ? NavLinkMatch.Prefix : NavLinkMatch.All); }\n    [Parameter]\n    public RenderFragment? ChildContent { get; set; }\n    public string ComputedClass { get; set; } = string.Empty;\n    public void HandleClick() {\n        NavManager?.NavigateTo(Href.First());\n    }\n    private void CheckMatch(string currentUrl) {\n        string path = NavManager!.ToBaseRelativePath(currentUrl);\n        path = path.EndsWith(""/"") \n            ? path.Substring(0, path.Length - 1) : path;\n        bool match = Href.Any(href => ComputedMatch == NavLinkMatch.All \n                ? path == href : path.StartsWith(href));\n        ComputedClass = match ? $""{Class} {ActiveClass}"" : Class;\n    }\n    protected override void OnParametersSet() {\n        ComputedClass = Class;\n        NavManager!.LocationChanged += \n            (sender, arg) => CheckMatch(arg.Location);\n        Href = Href.Select(h => h.StartsWith(""/"") ? h.Substring(1) : h);\n        CheckMatch(NavManager!.Uri);\n    }\n}\n 1059 Understanding the component lifecycle methods\nThis component works in the same way as a regular NavLink  but accepts an array of \npaths to match. The component relies on the OnParametersSet  lifecycle method \nbecause some initial setup is required that cannot be performed until after values \nhave been assigned to the properties decorated with the Parameter  attribute, such as \nextracting the individual paths.\nThis component responds to changes in the current URL by listening for the  \nLocationChanged  event defined by the NavigationManager  class. The event’s  \nLocation  property provides the component with the current URL, which is used to \nalter the classes for the anchor element. Listing 35.16 applies the new component in \nthe layout.\nTIP    Notice that I have removed the Match  attribute in listing 35.14. The new \ncomponent supports this attribute but defaults to matching based on the num-\nber of paths that it receives through the href  attribute.\nListing 35.16    Applying a new component in the NavLayout.razor file in the Blazor folder\n@inherits LayoutComponentBase\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col-3"">\n            <div class=""d-grid gap-2"">\n                @foreach (string key in NavLinks.Keys) {\n                    <MultiNavLink \n                        class=""btn btn-outline-primary btn-block""\n                        href=""@NavLinks[key]"" \n                        ActiveClass=""btn-primary text-white"">\n                            @key\n                    </MultiNavLink>\n                }\n            </div>\n        </div>\n        <div class=""col"">\n            @Body\n        </div>\n    </div>\n</div>\n@code {\n    public Dictionary<string, string[]> NavLinks\n        = new Dictionary<string, string[]> {\n            {""People"", new string[] {""/people"", ""/"" } },\n            {""Departments"", new string[] {""/depts"", ""/departments"" } },\n            {""Details"", new string[] { ""/person"" } }\n        };\n}\nRestart ASP.NET Core and request http://localhost:5000/people and http://  \nlocalhost:5000/departments. Both URLs are recognized, and the corresponding navi-\ngation buttons are highlighted, as shown in figure 35.7.",6219
435-35.3.1 Using the lifecycle methods for asynchronous tasks.pdf,435-35.3.1 Using the lifecycle methods for asynchronous tasks,"1060 chapter  35 Advanced Blazor features\nFigure 35.7    Using the lifecycle methods \n35.3.1  Using the lifecycle methods for asynchronous tasks\nThe lifecycle methods are also useful for performing tasks that may complete after the \ninitial content from the component has been rendered, such as querying the database. \nListing 35.17 replaces the placeholder content in the PersonDisplay  component and \nuses the lifecycle methods to query the database using values received as parameters.\nListing 35.17    Querying for data in the PersonDisplay.razor file in the Blazor folder \n@page ""/person""\n@page ""/person/{id:long}""\n@if (Person == null) {\n    <h5 class=""bg-info text-white text-center p-2"">Loading...</h5>\n} else {\n    <table class=""table table-striped table-bordered"">\n        <tbody>\n            <tr><th>Id</th><td>@Person.PersonId</td></tr>\n            <tr><th>Surname</th><td>@Person.Surname</td></tr>\n            <tr><th>Firstname</th><td>@Person.Firstname</td></tr>\n        </tbody>\n    </table>\n}\n<button class=""btn btn-outline-primary"" \n        @onclick=""@(() => HandleClick(false))"">\n    Previous\n</button>\n<button class=""btn btn-outline-primary"" \n        @onclick=""@(() => HandleClick(true))"">\n    Next\n</button>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n 1061 Understanding the component lifecycle methods\n    [Parameter]\n    public long Id { get; set; } = 0;\n    public Person? Person { get; set; }\n    protected async override Task OnParametersSetAsync() {\n        await Task.Delay(1000);\n        if (Context != null) {\n            Person = await Context.People\n                .FirstOrDefaultAsync(p => p.PersonId == Id)\n                  ?? new Person();\n        }\n    }\n    public void HandleClick(bool increment) {\n        Person = null;\n        NavManager?.NavigateTo(\n            $""/person/{(increment ? Id + 1 : Id - 1)}"");\n    }\n}\nThe component can’t query the database until the parameter values have been set \nand so the value of the Person  property is obtained in the OnParametersSetAsync  \nmethod. Since the database is running alongside the ASP.NET Core server, I have \nadded a one-second delay before querying the database to help emphasize the way the \ncomponent works.\nThe value of the Person  property is null  until the query has completed, at which \npoint it will be either an object representing the query result or a new Person  object \nif the query doesn’t produce a result. A loading message is displayed while the Person  \nobject is null .\nRestart ASP.NET Core and request http://localhost:5000. Click one of the Edit but-\ntons presented in the table, and the PersonDisplay  component will display a summary \nof the data. Click the Previous and Next buttons to query for the objects with the adja-\ncent primary key values, producing the results shown in figure 35.8.\nFigure 35.8    Performing asynchronous tasks in a component \nNotice that Blazor doesn’t wait for the Task  performed in the OnParametersSet  Async  \nmethod to complete before displaying content to the user, which is why a loading mes-\nsage is useful when the Person  property is null . Once the Task  is complete and a",3288
436-35.4 Managing component interaction.pdf,436-35.4 Managing component interaction,,0
437-35.4.1 Using references to child components.pdf,437-35.4.1 Using references to child components,"1062 chapter  35 Advanced Blazor features\nvalue has been assigned to the Person  property, the component’s view is automatically \nre-rendered, and the changes are sent to the browser over the persistent HTTP con-\nnection to be displayed to the user.\n35.4 Managing component interaction\nMost components work together through parameters and events, allowing the user’s \ninteraction to drive changes in the application. Blazor also provides advanced options \nfor managing interaction with components, which I describe in the following sections.\n35.4.1  Using references to child components \nA parent component can obtain a reference to a child component and use it to con-\nsume the properties and methods it defines. In preparation, listing 35.18 adds a dis-\nabled state to the MultiNavLink  component.  \nListing 35.18    Adding a feature in the MultiNavLink.razor file in the Blazor folder\n<a class=""@ComputedClass"" @onclick=""HandleClick""  href="""">\n    @if (Enabled) {  \n        @ChildContent \n    } else { \n        @(""Disabled"") \n    }\n</a>\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Parameter]\n    public IEnumerable<string> Href { get; set; } \n        = Enumerable.Empty<string>();\n    [Parameter]\n    public string Class { get; set; } = string.Empty;\n    [Parameter]\n    public string ActiveClass { get; set; } = string.Empty;\n    [Parameter]\n    public string DisabledClasses { get; set; } = string.Empty;\n    [Parameter]\n    public NavLinkMatch? Match { get; set; }\n    public NavLinkMatch ComputedMatch { get =>\n            Match ?? (Href.Count() == 1 \n                ? NavLinkMatch.Prefix : NavLinkMatch.All); }\n    [Parameter]\n    public RenderFragment? ChildContent { get; set; }\n 1063 Managing component interaction\n    public string ComputedClass { get; set; } = string.Empty;\n    public void HandleClick() {\n        NavManager?.NavigateTo(Href.First());\n    }\n    private void CheckMatch(string currentUrl) {\n        string path = NavManager!.ToBaseRelativePath(currentUrl);\n        path = path.EndsWith(""/"") \n            ? path.Substring(0, path.Length - 1) : path;\n        bool match = Href.Any(href => ComputedMatch == NavLinkMatch.All \n                ? path == href : path.StartsWith(href));\n        if (!Enabled) {\n            ComputedClass = DisabledClasses;\n        } else {\n            ComputedClass = match ? $""{Class} {ActiveClass}"" : Class;\n        }\n    }\n    protected override void OnParametersSet() {\n        ComputedClass = Class;\n        NavManager!.LocationChanged += \n            (sender, arg) => CheckMatch(arg.Location);\n        Href = Href.Select(h => h.StartsWith(""/"") ? h.Substring(1) : h);\n        CheckMatch(NavManager!.Uri);\n    }\n    private bool Enabled { get; set; } = true;\n    public void SetEnabled(bool enabled) {\n        Enabled = enabled;\n        CheckMatch(NavManager!.Uri);\n    }\n}\nIn listing 35.19, I have updated the shared layout so that it retains references to the \nMultiNavLink  components and a button  that toggles their Enabled  property value.\nListing 35.19    Retaining references in the NavLayout.razor file in the Blazor folder\n@inherits LayoutComponentBase\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col-3"">\n            <div class=""d-grid gap-2"">\n                @foreach (string key in NavLinks.Keys) {\n                    <MultiNavLink class=""btn btn-outline-primary btn-block""\n                        href=""@NavLinks[key]"" \n                        ActiveClass=""btn-primary text-white""\n                        DisabledClasses=""btn btn-dark text-light \n                            btn-block disabled""\n                         @ref=""Refs[key]"">\n                         @key   \n1064 chapter  35 Advanced Blazor features\n                    </MultiNavLink>\n                }\n            <button class=""btn btn-secondary btn-block mt-5"" \n                    @onclick=""ToggleLinks"">\n                Toggle Links\n            </button>\n            </div>\n        </div>\n        <div class=""col"">\n            @Body\n        </div>\n    </div>\n</div>\n@code {\n    public Dictionary<string, string[]> NavLinks\n        = new Dictionary<string, string[]> {\n            {""People"", new string[] {""/people"", ""/"" } },\n            {""Departments"", new string[] {""/depts"", ""/departments"" } },\n            {""Details"", new string[] { ""/person"" } }\n        };\n    public Dictionary<string, MultiNavLink?> Refs \n        = new Dictionary<string, MultiNavLink?>();\n    private bool LinksEnabled = true;\n    public void ToggleLinks() {\n        LinksEnabled = !LinksEnabled;\n        foreach (MultiNavLink? link in Refs.Values) {\n            link?.SetEnabled(LinksEnabled);\n        }\n    }\n}\nReferences to components are created by adding an @ref  attribute and specifying the \nname of a field or property to which the component should be assigned. Since the \nMultiNavLink  components are created in a @foreach  loop driven by a Dictionary , \nthe simplest way to retain references is also in a Dictionary , like this:\n...\n<MultiNavLink class=""btn btn-outline-primary btn-block""\n    href=""@NavLinks[key]"" ActiveClass=""btn-primary text-white"" \n    DisabledClasses=""btn btn-dark text-light btn-block disabled""\n    @ref=""Refs[key]"" >\n...\nAs each MultiNavLink  component is created, it is added to the Refs  dictionary. Razor \nComponents are compiled into standard C# classes, which means that a collection of \nMultiNavLink  components is a collection of MultiNavlink  objects.\n...\npublic Dictionary<string, MultiNavLink > Refs \n        = new Dictionary<string, MultiNavLink >();\n...",5713
438-35.4.2 Interacting with components from other code.pdf,438-35.4.2 Interacting with components from other code,"1065 Managing component interaction\nRestart ASP.NET Core, request http://localhost:5000, and click the Toggle Links but-\nton. The event handler invokes the ToggleLinks  method, which sets the value of the \nEnabled  property for each of the MultiNavLink  components, as shown in figure 35.9.\nCAUTION     References can be used only after the component’s content has been \nrendered and the OnAfterRender /OnAfterRenderAsync  lifecycle methods \nhave been invoked. This makes references ideal for use in event handlers but not \nthe earlier lifecycle methods.\nFigure 35.9    Retaining references to components \n35.4.2  Interacting with components from other code\nComponents can be used by other code in the ASP.NET Core application, allowing a \nricher interaction between parts of complex projects. Listing 35.20 alters the method \nin the MultiNavLink  component so it can be invoked by other parts of the ASP.NET \nCore application to enable and disable navigation.  \nListing 35.20    Replacing a method in the MultiNavLink.razor file in the Blazor folder\n<a class=""@ComputedClass"" @onclick=""HandleClick""  href="""">\n    @if (Enabled) {  \n        @ChildContent \n    } else { \n        @(""Disabled"") \n    }\n</a>\n@code {\n    // ...other properties and methods omitted for brevity...\n    private bool Enabled { get; set; } = true;\n    public void SetEnabled(bool enabled) {\n        InvokeAsync(() => {\n            Enabled = enabled;\n1066 chapter  35 Advanced Blazor features\n            CheckMatch(NavManager!.Uri);\n            StateHasChanged();\n        });\n    }\n}\nRazor Components provide two methods that are used in code that is invoked outside \nof the Blazor environment, as described in table 35.6.  \nTable 35.6    The Razor component external invocation methods\nName Description\nInvokeAsync(func) This method is used to execute a function \ninside the Blazor environment.\nStateHasChanged() This method is called when a change occurs \noutside of the normal lifecycle, as shown in the \nnext section.\nThe InvokeAsync  method is used to invoke a function within the Blazor environ-\nment, ensuring that changes are processed correctly. The StateHasChanged  method \nis invoked when all the changes have been applied, triggering a Blazor update and \nensuring changes are reflected in the component’s output.\nTo create a service that will be available throughout the application, create the \nAdvanced/Services  folder and add to it a class file named ToggleService.cs , with \nthe code shown in listing 35.21.\nListing 35.21    The contents of the ToggleService.cs file in the Services folder\nusing Advanced.Blazor;\nnamespace Advanced.Services {\n    public class ToggleService {\n        private List<MultiNavLink> components = new List<MultiNavLink>();\n        private bool enabled = true;\n        public void EnrolComponents(IEnumerable<MultiNavLink> comps) {\n            components.AddRange(comps);\n        }\n        public bool ToggleComponents() {\n            enabled = !enabled;\n            components.ForEach(c => c.SetEnabled(enabled));\n            return enabled;\n        }\n    }\n}\nThis service manages a collection of components and invokes the SetEnabled  method \non all of them when its ToggleComponents  method is called. There is nothing specific \nto Blazor in this service, which relies on the C# classes that are produced when Razor \nComponent files are compiled. Listing 35.22 updates the application configuration to \nconfigure the ToggleService  class as a singleton service.\n 1067 Managing component interaction\nListing 35.22    Configuring a service in the Program.cs file in the Advanced folder\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddSingleton<Advanced.Services.ToggleService>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nListing 35.23 updates the Blazor layout so that references to the MultiNavLink  com-\nponents are retained and registered with the new service.\nListing 35.23    Using the service in the NavLayout.razor file in the Blazor folder\n@inherits LayoutComponentBase\n@using Advanced.Services\n<div class=""container-fluid"">\n    <div class=""row"">\n        <div class=""col-3"">\n            <div class=""d-grid gap-2"">\n                @foreach (string key in NavLinks.Keys) {\n                    <MultiNavLink class=""btn btn-outline-primary btn-block""\n                        href=""@NavLinks[key]"" \n                        ActiveClass=""btn-primary text-white""\n                        DisabledClasses=""btn btn-dark text-light \n                            btn-block disabled""\n                         @ref=""Refs[key]"">\n1068 chapter  35 Advanced Blazor features\n                         @key   \n                    </MultiNavLink>\n                }\n            <button class=""btn btn-secondary btn-block mt-5"" \n                    @onclick=""ToggleLinks"">\n                Toggle Links\n            </button>\n            </div>\n        </div>\n        <div class=""col"">\n            @Body\n        </div>\n    </div>\n</div>\n@code {\n    [Inject]\n    public ToggleService? Toggler { get; set; }\n    public Dictionary<string, string[]> NavLinks\n        = new Dictionary<string, string[]> {\n            {""People"", new string[] {""/people"", ""/"" } },\n            {""Departments"", new string[] {""/depts"", ""/departments"" } },\n            {""Details"", new string[] { ""/person"" } }\n        };\n    public Dictionary<string, MultiNavLink?> Refs \n        = new Dictionary<string, MultiNavLink?>();\n    //private bool LinksEnabled = true;\n    protected override void OnAfterRender(bool firstRender) {\n        if (firstRender && Toggler != null) {\n            Toggler.EnrolComponents(\n                Refs.Values as IEnumerable<MultiNavLink>);\n        }\n    }\n    public void ToggleLinks() {\n        Toggler?.ToggleComponents();\n    }\n}\nAs noted in the previous section, component references are not available until after the \ncontent has been rendered. Listing 35.23 uses the OnAfterRender  lifecycle method to \nregister the component references with the service, which is received via dependency \ninjection.\nThe final step is to use the service from a different part of the ASP.NET Core applica-\ntion. Listing 35.24 adds a simple action method to the Home  controller that invokes the \nToggleService.ToggleComponents  method every time it handles a request.\n 1069 Managing component interaction\nListing 35.24    Adding an action in the HomeController.cs file in the Controllers folder\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Services;\nnamespace Advanced.Controllers {\n    public class HomeController : Controller {\n        private DataContext context;\n        private ToggleService toggleService;\n        public HomeController(DataContext dbContext, ToggleService ts) {\n            context = dbContext;\n            toggleService = ts;\n        }\n        public IActionResult Index([FromQuery] string selectedCity) {\n            return View(new PeopleListViewModel {\n                People = context.People\n                    .Include(p => p.Department).Include(p => p.Location),\n                Cities = context.Locations.Select(l => l.City).Distinct(),\n                SelectedCity = selectedCity\n            });\n        }\n        public string Toggle() => \n            $""Enabled: {toggleService.ToggleComponents()}"";\n    }\n}\npublic class PeopleListViewModel {\n    public IEnumerable<Person> People { get; set; } \n        = Enumerable.Empty<Person>();\n    public IEnumerable<string> Cities { get; set; } \n        = Enumerable.Empty<string>();\n    public string SelectedCity { get; set; } = String.Empty;\n    public string GetClass(string? city) =>\n        SelectedCity == city ? ""bg-info text-white"" : """";\n}\nRestart ASP.NET Core and request http://localhost:5000. Open a separate browser \nwindow and request http://localhost:5000/controllers/home/toggle. When the sec-\nond request is processed by the ASP.NET Core application, the action method will use \nthe service, which toggles the state of the navigation button. Each time you request  \n/controllers/home/toggle , the state of the navigation buttons will change, as \nshown in figure 35.10.",9036
439-35.4.3 Interacting with components using JavaScript.pdf,439-35.4.3 Interacting with components using JavaScript,"1070 chapter  35 Advanced Blazor features\nFigure 35.10    Invoking component methods \n35.4.3  Interacting with components using JavaScript\nBlazor provides a range of tools for interaction between JavaScript and server-side C# \ncode, as described in the following sections. \ninvoking  a javascript function  from a component  \nTo prepare for these examples, add a JavaScript file named interop.js  to the  \nwwwroot  folder and add the code shown in listing 35.25.\nListing 35.25    The contents of the interop.js file in the wwwroot folder\nfunction addTableRows(colCount) {\n    let elem = document.querySelector(""tbody"");\n    let row = document.createElement(""tr"");\n    elem.append(row);\n    for (let i = 0; i < colCount; i++) {\n        let cell = document.createElement(""td"");\n        cell.innerText = ""New Elements""\n        row.append(cell);\n    }\n}\nThe JavaScript code uses the API provided by the browser to locate a tbody  element, \nwhich denotes the body of a table and adds a new row containing the number of cells \nspecified by the function parameter.\nTo incorporate the JavaScript file into the application, add the element shown in \nlisting 35.26 to the _Host  Razor Page, which was configured as the fallback page that \ndelivers the Blazor application to the browser.\nListing 35.26    Adding an element in the _Host.cshtml file in the Pages folder\n@page ""/""\n@{ Layout = null; }\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n 1071 Managing component interaction\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <base href=""~/"" />  \n</head>\n<body>    \n    <div class=""m-2"">\n        <component type=""typeof(Advanced.Blazor.Routed)""  \n             render-mode=""Server"" />\n    </div>\n    <script src=""_framework/blazor.server.js""></script>\n    <script src=""~/interop.js""></script>\n</body>\n</html>\nListing 35.27 revises the PersonDisplay  component so that it renders a button that \ninvokes the JavaScript function when the onclick  event is triggered. I have also \nremoved the delay that I added earlier to demonstrate the use of the component life-\ncycle methods.\nListing 35.27    Invoking a function in the PersonDisplay.razor file in the Blazor folder\n@page ""/person""\n@page ""/person/{id:long}""\n@if (Person == null) {\n    <h5 class=""bg-info text-white text-center p-2"">Loading...</h5>\n} else {\n    <table class=""table table-striped table-bordered"">\n        <tbody>\n            <tr><th>Id</th><td>@Person.PersonId</td></tr>\n            <tr><th>Surname</th><td>@Person.Surname</td></tr>\n            <tr><th>Firstname</th><td>@Person.Firstname</td></tr>\n        </tbody>\n    </table>\n}\n<button class=""btn btn-outline-primary"" @onclick=""@HandleClick"">\n    Invoke JS Function\n</button>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Inject]\n    public IJSRuntime? JSRuntime { get; set; }\n    [Parameter]\n    public long Id { get; set; } = 0;\n    public Person? Person { get; set; }\n1072 chapter  35 Advanced Blazor features\n    protected async override Task OnParametersSetAsync() {\n        //await Task.Delay(1000);\n        if (Context != null) {\n            Person = await Context.People\n                .FirstOrDefaultAsync(p => p.PersonId == Id)\n                  ?? new Person();\n        }\n    }\n    public async Task HandleClick() {\n        await JSRuntime!.InvokeVoidAsync(""addTableRows"", 2);\n    }\n}\nInvoking a JavaScript function is done through the IJSRuntime  interface, which com-\nponents receive through dependency injection. The service is created automatically \nas part of the Blazor configuration and provides the methods described in table 35.7.  \nTable 35.7    The IJSRuntime methods\nName Description\nInvokeAsync<T>(name, args) This method invokes the specified \nfunction with the arguments provided. \nThe result type is specified by the \ngeneric type parameter.\nInvokeVoidAsync(name, args) This method invokes a function that \ndoesn’t produce a result.\nIn listing 35.27, I use the InvokeVoidAsync  method to invoke the addTableRows  \nJavaScript function, providing a value for the function parameter. Restart ASP.NET \nCore, navigate to http://localhost:5000/person/1, and click the Invoke JS Function \nbutton. Blazor will invoke the JavaScript function, which adds a row to the end of the \ntable, as shown in figure 35.11.\nFigure 35.11    Invoking a JavaScript function \n 1073 Managing component interaction\nretaining  references  to html  elements  \nRazor Components can retain references to the HTML elements they create and pass \nthose references to JavaScript code. Listing 35.28 changes the JavaScript function from \nthe previous example so that it operates on an HTML element it receives through a \nparameter.  \nListing 35.28    Defining a parameter in the interop.js file in the wwwroot folder \nfunction addTableRows(colCount, elem) {\n    //let elem = document.querySelector(""tbody"");\n    let row = document.createElement(""tr"");\n    elem.parentNode.insertBefore(row, elem);\n    for (let i = 0; i < colCount; i++) {\n        let cell = document.createElement(""td"");\n        cell.innerText = ""New Elements""\n        row.append(cell);\n    }\n}\nIn listing 35.29, the PersonDisplay  component retains a reference to one of the \nHTML elements it creates and passes it as an argument to the JavaScript function.\nListing 35.29    Retaining a reference in the PersonDisplay.razor file in the Blazor folder\n@page ""/person""\n@page ""/person/{id:long}""\n@if (Person == null) {\n    <h5 class=""bg-info text-white text-center p-2"">Loading...</h5>\n} else {\n    <table class=""table table-striped table-bordered"">\n        <tbody>\n            <tr><th>Id</th><td>@Person.PersonId</td></tr>\n            <tr @ref=""RowReference"">\n                <th>Surname</th><td>@Person.Surname</td>\n            </tr>\n            <tr><th>Firstname</th><td>@Person.Firstname</td></tr>\n        </tbody>\n    </table>\n}\n<button class=""btn btn-outline-primary"" @onclick=""@HandleClick"">\n    Invoke JS Function\n</button>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n1074 chapter  35 Advanced Blazor features\n    [Inject]\n    public IJSRuntime? JSRuntime { get; set; }\n    [Parameter]\n    public long Id { get; set; } = 0;\n    public Person? Person { get; set; }\n    protected async override Task OnParametersSetAsync() {\n        if (Context != null) {\n            Person = await Context.People\n                .FirstOrDefaultAsync(p => p.PersonId == Id)\n                  ?? new Person();\n        }\n    }\n    public ElementReference RowReference { get; set; }\n    public async Task HandleClick() {\n        await JSRuntime!.InvokeVoidAsync(""addTableRows"", 2, RowReference);\n    }\n}\nThe @ref  attribute assigns the HTML element to a property, whose type must be  \nElementReference . Restart ASP.NET Core, request http://localhost:5000/person/1, \nand click the Invoke JS Function button. The value of the ElementReference  prop-\nerty is passed as an argument to the JavaScript function through the InvokeVoidAsync  \nmethod, producing the result shown in figure 35.12.\nNOTE    The only use for a reference to a regular HTML element is to pass it to \na JavaScript function. Use the binding and event features described in earlier \nchapters to interact with the elements rendered by a component.\nFigure 35.12    Retaining a reference to an HTML element \ninvoking  a component  method  from javascript \nThe basic approach for invoking a C# method from JavaScript is to use a static  \nmethod. Listing 35.30 adds a static method to the MultiNavLink  component that \nchanges the enabled state.\n 1075 Managing component interaction\nListing 35.30    Introducing static members in the MultiNavLink.razor file in the  \nBlazor folder\n<a class=""@ComputedClass"" @onclick=""HandleClick""  href="""">\n    @if (Enabled) {  \n        @ChildContent \n    } else { \n        @(""Disabled"") \n    }\n</a>\n@code {\n    // ...other methods and properties omitted for brevity...\n    [JSInvokable]\n    public static void ToggleEnabled() => \n        ToggleEvent?.Invoke(null, new EventArgs());\n    private static event EventHandler? ToggleEvent;\n    protected override void OnInitialized() {\n        ToggleEvent += (sender, args) => SetEnabled(!Enabled);\n    }\n}\nStatic methods must be decorated with the JSInvokable  attribute before they can be \ninvoked from JavaScript code. The main limitation of using static  methods is that it \nmakes it difficult to update individual components, so I have defined a static  event \nthat each instance of the component will handle. The event is named ToggleEvent , \nand it is triggered by the static method that will be called from JavaScript. To listen for \nthe event, I have used the OnInitialized  lifecycle event. When the event is received, \nthe enabled state of the component is toggled through the instance method Set-\nEnabled , which uses the InvokeAsync  and StateHasChanged  methods required \nwhen a change is made outside of Blazor.\nListing 35.31 adds a function to the JavaScript file that creates a button element that \ninvokes the static C# method when it is clicked.\nListing 35.31    Adding a function in the interop.js file in the wwwroot folder\nfunction addTableRows(colCount, elem) {\n    //let elem = document.querySelector(""tbody"");\n    let row = document.createElement(""tr"");\n    elem.parentNode.insertBefore(row, elem);\n    for (let i = 0; i < colCount; i++) {\n        let cell = document.createElement(""td"");\n        cell.innerText = ""New Elements""\n        row.append(cell);\n    }\n}\nfunction createToggleButton() {\n1076 chapter  35 Advanced Blazor features\n    let sibling = document.querySelector(""button:last-of-type"");\n    let button = document.createElement(""button"");\n    button.classList.add(""btn"", ""btn-secondary"", ""btn-block"");\n    button.innerText = ""JS Toggle"";\n    sibling.parentNode.insertBefore(button, sibling.nextSibling);\n    button.onclick = () => DotNet.invokeMethodAsync(""Advanced"", \n        ""ToggleEnabled"");\n}\nThe new function locates one of the existing button  elements and adds a new button \nafter it. When the button is clicked, the component method is invoked, like this:\n...\nbutton.onclick = () => DotNet.invokeMethodAsync (""Advanced"", \n    ""ToggleEnabled"");\n...\nIt is important to pay close attention to the capitalization of the JavaScript function \nused for C# methods: it is DotNet , followed by a period, followed by invokeMethod -\nAsync , with a lowercase i. The arguments are the name of the assembly and the name \nof the static method. (The name of the component is not required.)\nThe button  element that the function in listing 35.31 looks for isn’t available until \nafter Blazor has rendered content for the user. For this reason, listing 35.32 adds a state-\nment to the OnAfterRenderAsync  method defined by the NavLayout  component to \ninvoke the JavaScript function only when the content has been rendered. (The Nav-\nLayout  component is the parent to the MultiNavLink  components that will be affected \nwhen the static  method is invoked and allows me to ensure the JavaScript function is \ninvoked only once.)\nListing 35.32    Invoking a JavaScript function in the NavLayout.razor file in the  \nBlazor folder\n...\n@code {\n    [Inject]\n    public ToggleService? Toggler { get; set; }\n    [Inject]\n    public IJSRuntime? JSRuntime { get; set; }\n    public Dictionary<string, string[]> NavLinks\n        = new Dictionary<string, string[]> {\n            {""People"", new string[] {""/people"", ""/"" } },\n            {""Departments"", new string[] {""/depts"", ""/departments"" } },\n            {""Details"", new string[] { ""/person"" } }\n        };\n    public Dictionary<string, MultiNavLink?> Refs \n        = new Dictionary<string, MultiNavLink?>();\n    //private bool LinksEnabled = true;\n    protected async override Task OnAfterRenderAsync(bool firstRender) {\n 1077 Managing component interaction\n        if (firstRender && Toggler != null) {\n            Toggler.EnrolComponents(\n                Refs.Values as IEnumerable<MultiNavLink>);\n            await JSRuntime!.InvokeVoidAsync(""createToggleButton"");\n        }\n    }\n    public void ToggleLinks() {\n        Toggler?.ToggleComponents();\n    }\n}\n...\nRestart ASP.NET Core and request http://localhost:5000. Once Blazor has rendered \nits content, the JavaScript function will be called and creates a new button. Clicking the \nbutton invokes the static  method, which triggers the event that toggles the state of \nthe navigation buttons and causes a Blazor update, as shown in figure 35.13.\nFigure 35.13    Invoking a component method from JavaScript \ninvoking  an instance  method  from a javascript function  \nPart of the complexity in the previous example comes from responding to a static  \nmethod to update the Razor Component objects. An alternative approach is to provide \nthe JavaScript code with a reference to an instance method, which it can then invoke \ndirectly. \nThe first step is to add the JSInvokable  attribute to the method that the JavaScript \ncode will invoke. I am going to invoke the ToggleComponents  methods defined by the \nToggleService  class, as shown in listing 35.33.\nListing 35.33    Applying an attribute in the ToggleService.cs file in the Services folder \nusing Advanced.Blazor;\nusing Microsoft.JSInterop;\nnamespace Advanced.Services {\n    public class ToggleService {\n1078 chapter  35 Advanced Blazor features\n        private List<MultiNavLink> components = new List<MultiNavLink>();\n        private bool enabled = true;\n        public void EnrolComponents(IEnumerable<MultiNavLink> comps) {\n            components.AddRange(comps);\n        }\n        [JSInvokable]\n        public bool ToggleComponents() {\n            enabled = !enabled;\n            components.ForEach(c => c.SetEnabled(enabled));\n            return enabled;\n        }\n    }\n}\nThe next step is to provide the JavaScript function with a reference to the object whose \nmethod will be invoked, as shown in listing 35.34.\nListing 35.34    Providing an instance in the NavLayout.razor file in the Blazor folder\n...\nprotected async override Task OnAfterRenderAsync(bool firstRender) {\n    if (firstRender && Toggler != null) {\n        Toggler.EnrolComponents(\n            Refs.Values as IEnumerable<MultiNavLink>);\n        await JSRuntime!.InvokeVoidAsync(""createToggleButton"",\n            DotNetObjectReference.Create(Toggler));\n    }\n}\n...\nThe DotNetObjectReference.Create  method creates a reference to an object, which \nis passed to the JavaScript function as an argument using the JSRuntime.Invoke -\nVoidAsync  method. The final step is to receive the object reference in JavaScript and \ninvoke its method when the button element is clicked, as shown in listing 35.35.  \nListing 35.35   Invoking a C# method in the interop.js file in the wwwroot folder\nfunction addTableRows(colCount, elem) {\n    //let elem = document.querySelector(""tbody"");\n    let row = document.createElement(""tr"");\n    elem.parentNode.insertBefore(row, elem);\n    for (let i = 0; i < colCount; i++) {\n        let cell = document.createElement(""td"");\n        cell.innerText = ""New Elements""\n        row.append(cell);\n    }\n}\nfunction createToggleButton(toggleServiceRef) {\n    let sibling = document.querySelector(""button:last-of-type"");\n    let button = document.createElement(""button"");\n    button.classList.add(""btn"", ""btn-secondary"", ""btn-block"");\n 1079 Managing component interaction\n    button.innerText = ""JS Toggle"";\n    sibling.parentNode.insertBefore(button, sibling.nextSibling);\n    button.onclick = () => \n        toggleServiceRef.invokeMethodAsync(""ToggleComponents"");\n}\nThe JavaScript function receives the reference to the C# object as a parameter and \ninvokes its methods using invokeMethodAsync , specifying the name of the method as \nthe argument. (Arguments to the method can also be provided but are not required in \nthis example.)\nRestart ASP.NET Core, request http://localhost:5000, and click the JS Toggle but-\nton. The result is the same as shown in figure 35.13, but the change in the components \nis managed through the ToggleService  object.\nSummary\n¡ The component used to handle a request can be selected using routes, which are \ndefined using the @page  expression.\n¡ The NavLink  component is used to navigate between components with routes.\n¡ Components have a well-defined lifecycle, through which methods are invoked \nat key moments, including initialization, configuration, and content rendering.\n¡ Parent components can obtain references to child components using the @ref  \nexpression. \n¡ Blazor supports interaction with JavaScript code running the browser. Compo-\nnents can invoke JavaScript functions and JavaScript code can invoke C# compo-\nnent methods.",17138
440-36.1 Preparing for this chapter.pdf,440-36.1 Preparing for this chapter,"108036Blazor forms and data\nThis chapter covers\n¡ Using built-in components to create HTML   \n forms\n¡ Validating form data\n¡ Responding to form events\n¡ Using Entity Framework Core with Blazor   \n components\n¡ Performing CRUD operations\n¡ Extending Blazor\nIn this chapter, I describe the features that Blazor provides for dealing with HTML \nforms, including support for data validation. I describe the built-in components that \nBlazor provides and show you how they are used. In this chapter, I also explain how \nthe Blazor model can cause unexpected results with Entity Framework Core and \nshow you how to address these issues. I finish the chapter by creating a simple form \napplication for creating, reading, updating, and deleting data (the CRUD opera-\ntions) and explain how to extend the Blazor form features to improve the user’s \nexperience. Table 36.1 puts the Blazor form features in context.\n 1081 Preparing for this chapter\nTable 36.1    Putting Blazor form features in context\nQuestion Answer\nWhat are they? Blazor provides a set of built-in components that \npresent the user with a form that can be easily \nvalidated.\nWhy are they useful? Forms remain one of the core building blocks of \nweb applications, and these components provide \nfunctionality that most projects will require. \nHow are they used? The EditForm  component is used as a parent \nfor individual form field components.\nAre there any pitfalls or \nlimitations?There can be issues with the way that Entity \nFramework Core and Blazor work together, and \nthese become especially apparent when using \nforms. \nAre there any alternatives? You could create your own form components \nand validation features, although the features \ndescribed in this chapter are suitable for most \nprojects and, as I demonstrate, can be easily \nextended.\nTable 36.2 provides a guide to the chapter.\nTable 36.2    Chapter guide\nProblem Solution Listing\nCreating an HTML form Use the EditForm  and Input*  \ncomponents.7–9, 13\nValidating data Use the standard validation attri-\nbutes and the events emitted by the \nEditForm  component.10–12\nDiscarding unsaved data Explicitly release the data or create \nnew scopes for components.14–16\nAvoiding repeatedly querying \nthe databaseManage query execution explicitly. 17–19\n36.1 Preparing for this chapter\nThis chapter uses the Advanced project from chapter 35. To prepare for this chap-\nter, create the Blazor/Forms  folder and add to it a Razor Component named Empty-\nLayout.razor  with the content shown in listing 36.1. I will use this component as the \nmain layout for this chapter.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\n1082 chapter  36 Blazor forms and data\nListing 36.1    The contents of the EmptyLayout.razor file in the Blazor/Forms folder \n@inherits LayoutComponentBase\n<div class=""m-2"">\n    @Body\n</div>\nAdd a RazorComponent  named FormSpy.razor  to the Blazor/Forms  folder with the \ncontent shown in listing 36.2. This is a component I will use to display form elements \nalongside the values that are being edited.\nListing 36.2    The contents of the FormSpy.razor file in the Blazor/Forms folder\n<div class=""container-fluid no-gutters"">\n    <div class=""row"">\n        <div class=""col"">\n            @ChildContent\n        </div>\n        <div class=""col"">\n            <table class=""table table-sm table-striped table-bordered"">\n                <thead>\n                    <tr>\n                        <th colspan=""2"" class=""text-center"">\n                            Data Summary\n                        </th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <th>ID</th><td>@PersonData?.PersonId</td>\n                    </tr>\n                    <tr>\n                        <th>Firstname</th><td>@PersonData?.Firstname</td>\n                    </tr>\n                    <tr>\n                        <th>Surname</th><td>@PersonData?.Surname</td>\n                    </tr>\n                    <tr>\n                        <th>Dept ID</th>\n                        <td>@PersonData?.DepartmentId</td>\n                    </tr>\n                    <tr>\n                        <th>Location ID</th>\n                        <td>@PersonData?.LocationId</td>\n                    </tr>\n                </tbody>\n            </table>            \n        </div>\n    </div>\n</div>\n@code {\n    [Parameter]\n 1083 Preparing for this chapter\n    public RenderFragment? ChildContent { get; set; }\n    [Parameter]\n    public Person PersonData { get; set; } = new();\n}\nNext, add a component named Editor.razor  to the Blazor/Forms  folder and add \nthe content shown in listing 36.3. This component will edit existing Person  objects \nand create new ones.\nCAUTION     Do not use the Editor  and List  components in real projects until \nyou have read the rest of the chapter. I have included common pitfalls that I \nexplain later in the chapter.\nListing 36.3    The contents of the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n<h4 class=""bg-primary text-center text-white p-2"">Edit</h4>\n<FormSpy PersonData=""PersonData"">\n    <h4 class=""text-center"">Form Placeholder</h4>\n    <div class=""text-center"">\n        <NavLink class=""btn btn-secondary mt-2"" href=""/forms"">\n            Back\n        </NavLink>\n    </div>\n</FormSpy>\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Inject]\n    DataContext? Context { get; set; }\n    [Parameter]\n    public long Id { get; set; }\n    public Person PersonData { get; set; } = new();\n    protected async override Task OnParametersSetAsync() {\n        if (Context != null) {\n            PersonData = await Context.People.FindAsync(Id) \n                ?? new Person();\n        }\n    }\n}\nThe component in listing 36.3 uses an @layout  expression to override the default lay-\nout and select EmptyLayout . The side-by-side layout is used to present the Person-\nTable  component alongside a placeholder, which is where I will add a form.\n1084 chapter  36 Blazor forms and data\nFinally, create a component named List.razor  in the Blazor/Forms  folder and add \nthe content shown in listing 36.4 to define a component that will present the user with a \ntable that lists Person  objects.\nListing 36.4    The contents of the List.razor file in the Blazor/Forms folder\n@page ""/forms""\n@page ""/forms/list""\n@layout EmptyLayout\n<h5 class=""bg-primary text-white text-center p-2"">People</h5>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Dept</th>\n            <th>Location</th>\n            <th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @if (People.Count() == 0) {\n            <tr>\n                <th colspan=""5"" class=""p-4 text-center"">\n                    Loading Data...\n                </th>\n            </tr>\n        } else {\n            @foreach (Person p in People) {\n                <tr>\n                    <td>@p.PersonId</td>\n                    <td>@p.Surname, @p.Firstname</td>\n                    <td>@p.Department?.Name</td>\n                    <td>@p.Location?.City</td>\n                    <td>\n                        <NavLink class=""btn btn-sm btn-warning""\n                         href=""@GetEditUrl(p.PersonId)"">\n                            Edit\n                        </NavLink>\n                    </td>\n                </tr>\n            }\n        }\n    </tbody>\n</table>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person> People { get; set; }",7994
441-36.1.1 Dropping the database and running the application.pdf,441-36.1.1 Dropping the database and running the application,,0
442-36.2 Using the Blazor form components.pdf,442-36.2 Using the Blazor form components,"1085 Using the Blazor form components\n        = Enumerable.Empty<Person>();\n    protected override void OnInitialized() {\n        People = Context?.People?.Include(p => p.Department)\n            .Include(p => p.Location)\n                ?? Enumerable.Empty<Person>();\n    }\n    string GetEditUrl(long id) => $""/forms/edit/{id}"";\n}\n36.1.1  Dropping the database and running the application \nOpen a new PowerShell command prompt, navigate to the folder that contains the \nAdvanced.csproj  file, and run the command shown in listing 36.5 to drop the \ndatabase.\nListing 36.5    Dropping the database\ndotnet ef database drop --force\nUse the PowerShell command prompt to run the command shown in listing 36.6. \nListing 36.6    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/forms, which will produce a data table. \nClick one of the Edit buttons, and you will see a placeholder for the form and a sum-\nmary showing the current property values of the selected Person  object, as shown in \nfigure 36.1.\nFigure 36.1    Running the example application \n36.2 Using the Blazor form components\nBlazor provides a set of built-in components that are used to render form elements, \nensuring that the server-side component properties are updated after user interaction \nand integrating validation. Table 36.3 describes the components that Blazor provides.  \n1086 chapter  36 Blazor forms and data\nTable 36.3    The Blazor form components\nName Description\nEditForm This component renders a form  element that is wired \nup for data validation.\nInputText This component renders an input  element that is \nbound to a C# string  property.\nInputCheckbox This component renders an input element whose type  \nattribute is checkbox  and that is bound to a C# bool  \nproperty.\nInputDate This component renders an input element those type  \nattribute is date  and that is bound to a C# DateTime  \nor DateTimeOffset  property.\nInputNumber This component renders an input element those type  \nattribute is number  and that is bound to a C# int, \nlong , float , double , or decimal  value.\nInputTextArea This component renders a textarea  component that \nis bound to a C# string property.\nThe EditForm  component must be used for any of the other components to work. In \nlisting 36.7, I have added an EditForm , along with InputText  components that repre-\nsent two of the properties defined by the Person  class.\nListing 36.7    Using form components in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n<h4 class=""bg-primary text-center text-white p-2"">Edit</h4>\n<FormSpy PersonData=""PersonData"">\n    <EditForm Model=""PersonData"">\n        <div class=""form-group"">\n            <label>Person ID</label>\n            <InputNumber class=""form-control""\n                @bind-Value=""PersonData.PersonId"" disabled />\n        </div>\n        <div class=""form-group"">\n            <label>Firstname</label>\n            <InputText class=""form-control"" \n                @bind-Value=""PersonData.Firstname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Surname</label>\n            <InputText class=""form-control"" \n                @bind-Value=""PersonData.Surname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Dept ID</label>\n            <InputNumber class=""form-control""\n                         @bind-Value=""PersonData.DepartmentId"" />\n        </div>\n 1087 Using the Blazor form components\n        <div class=""text-center"">\n            <NavLink class=""btn btn-secondary"" href=""/forms"">\n                Back\n            </NavLink>\n        </div>\n    </EditForm>\n</FormSpy>\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Inject]\n    DataContext? Context { get; set; }\n    [Parameter]\n    public long Id { get; set; }\n    public Person PersonData { get; set; } = new();\n    protected async override Task OnParametersSetAsync() {\n        if (Context != null) {\n            PersonData = await Context.People.FindAsync(Id) \n                ?? new Person();\n        }\n    }\n}\nThe EditForm  component renders a form  element and provides the foundation for \nthe validation features described in the “Validating Form Data” section. The Model  \nattribute provides the EditForm  with the object that the form uses to edit and validate. \nThe components in table 36.3 whose names begin with Input  are used to display an \ninput  or textarea  element for a single model property. These components define \na custom binding named Value  that is associated with the model property using the  \n@bind-Value  attribute. The property-level components must be matched to the type of \nthe property they present to the user. It is for this reason that I have used the InputText  \ncomponent for the Firstname  and Surname  properties of the Person  class, while the \nInputNumber  component is used for the PersonId  and DepartmentId  properties. If \nyou use a property-level component with a model property of the wrong type, you will \nreceive an error when the component attempts to parse a value entered into the HTML \nelement. \nRestart ASP.NET Core and request http://localhost:5000/forms/edit/2, and you \nwill see the three input  elements displayed. Edit the values and move the focus by press-\ning the Tab key, and you will see the summary data on the right of the window update, \nas shown in figure 36.2. The built-in form components support attribute splatting, \nwhich is why the disabled  attribute applied to the InputNumber  component for the  \nPersonId  property has been applied to the input  element.",5733
443-36.2.1 Creating custom form components.pdf,443-36.2.1 Creating custom form components,"1088 chapter  36 Blazor forms and data\nFigure 36.2    Using the Blazor form elements \n36.2.1  Creating custom form components\nBlazor provides built-in components for only input  and textarea  elements. Fortu-\nnately, creating a custom component that integrates into the Blazor form features is a \nsimple process. Add a Razor Component named CustomSelect.razor  to the Blazor/\nForms  folder and use it to define the component shown in listing 36.8.  \nListing 36.8    The contents of the CustomSelect.razor file in the Blazor/Forms folder \n@typeparam TValue\n@inherits InputBase<TValue>\n@using System.Diagnostics.CodeAnalysis\n<select class=""form-control @CssClass"" value=""@CurrentValueAsString"" \n            @onchange=""@(ev => CurrentValueAsString = ev.Value as string)"">\n        @ChildContent\n        @foreach (KeyValuePair<string, TValue> kvp in Values) {\n            <option value=""@kvp.Value"">@kvp.Key</option>\n        }\n</select>\n@code {\n    [Parameter]\n    public RenderFragment? ChildContent { get; set; }\n    [Parameter]\n    public IDictionary<string, TValue> Values { get; set; }\n        = new Dictionary<string, TValue>();\n    [Parameter]\n    public Func<string, TValue>? Parser { get; set; }\n    protected override bool TryParseValueFromString(string? value, \n           [MaybeNullWhen(false)] out TValue? result, \n           [NotNullWhen(false)] out string? validationErrorMessage) {\n        try {\n            if (Parser != null && value != null) {\n                result = Parser(value);\n                validationErrorMessage = null;\n 1089 Using the Blazor form components\n                return true;    \n            }\n            result = default(TValue);\n            validationErrorMessage = ""Value or parser not defined"";\n            return false;\n        } catch {\n            result = default(TValue);\n            validationErrorMessage = ""The value is not valid"";\n            return false;\n        }\n    }\n}\nThe base class for form components is InputBase<TValue> , where the generic type \nargument is the model property type the component represents. \nThe base class takes care of most of the work and provides the CurrentValue -\nAsString  property, which is used to provide the current value in event handlers when \nthe user selects a new value, like this:\n...\n<select class=""form-control @CssClass"" value=""@CurrentValueAsString""  \n            @onchange=""@(ev => CurrentValueAsString = ev.Value as string) "">\n...\nIn preparation for data validation, which I describe in the next section, this compo-\nnent includes the value of the CssClass  property in the select  element’s class  attri-\nbute, like this:\n...\n<select class=""form-control @CssClass "" value=""@CurrentValueAsString"" \n            @onchange=""@(ev => CurrentValueAsString = ev.Value as string)"">\n...\nThe abstract TryParseValueFromString  method has to be implemented so that the \nbase class is able to map between string values used by HTML elements and the cor-\nresponding value for the C# model property. I don’t want to implement my custom \nselect  element to any specific C# data type, so I have used an @typeparam  expression \nto define a generic type parameter.\nNOTE      At the time of writing, typing override and selecting the TryParse \nValueFromString  from the list of options in Visual Studio creates a method \nwith the wrong signature. It is important to pay close attention to the param-\neters, especially when the code analysis attributes, described in chapter 5, are \nused.\nThe Values  property is used to receive a dictionary mapping string values that will be \ndisplayed to the user and TValue  values that will be used as C# values. The method \nreceives two out parameters that are used to set the parsed value and a parser valida-\ntion error message that will be displayed to the user if there is a problem. Since I am \nworking with generic types, the Parser  property receives a function that is invoked to \nparse a string value into a TValue  value. \nListing 36.9 applies the new form component so the user can select values for the \nDepartmentId  and LocationId  properties defined by the Person  class.\n1090 chapter  36 Blazor forms and data\nListing 36.9    Using a custom element in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n<h4 class=""bg-primary text-center text-white p-2"">Edit</h4>\n<FormSpy PersonData=""PersonData"">\n    <EditForm Model=""PersonData"">\n        <div class=""form-group"">\n            <label>Person ID</label>\n            <InputNumber class=""form-control""\n                         @bind-Value=""PersonData.PersonId"" disabled />\n        </div>\n        <div class=""form-group"">\n            <label>Firstname</label>\n            <InputText class=""form-control""\n                       @bind-Value=""PersonData.Firstname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Surname</label>\n            <InputText class=""form-control""\n                       @bind-Value=""PersonData.Surname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Dept ID</label>\n            <CustomSelect TValue=""long"" Values=""Departments""\n                          Parser=""@((string str) => long.Parse(str))""\n                          @bind-Value=""PersonData.DepartmentId"">\n                <option selected disabled value=""0"">\n                    Choose a Department\n                </option>\n            </CustomSelect>\n        </div>\n        <div class=""form-group"">\n            <label>Location ID</label>\n            <CustomSelect TValue=""long"" Values=""Locations""\n                          Parser=""@((string str) => long.Parse(str))""\n                          @bind-Value=""PersonData.LocationId"">\n                <option selected disabled value=""0"">\n                    Choose a Location\n                </option>\n            </CustomSelect>\n        </div>\n        <div class=""text-center"">\n            <NavLink class=""btn btn-secondary mt-2"" href=""/forms"">\n                Back\n            </NavLink>\n        </div>\n    </EditForm>\n</FormSpy>\n@code {\n    [Inject]\n 1091 Using the Blazor form components\n    public NavigationManager? NavManager { get; set; }\n    [Inject]\n    DataContext? Context { get; set; }\n    [Parameter]\n    public long Id { get; set; }\n    public Person PersonData { get; set; } = new();\n    public IDictionary<string, long> Departments { get; set; }\n        = new Dictionary<string, long>();\n    public IDictionary<string, long> Locations { get; set; }\n        = new Dictionary<string, long>();\n    protected async override Task OnParametersSetAsync() {\n        if (Context != null) {\n            PersonData = await Context.People.FindAsync(Id) \n                ?? new Person();\n            Departments = await Context.Departments\n                .ToDictionaryAsync(d => d.Name, d => d.Departmentid);\n            Locations = await Context.Locations\n                .ToDictionaryAsync(l => $""{l.City}, {l.State}"", \n                    l => l.LocationId);\n        }\n    }\n}\nI use the Entity Framework Core ToDictionaryAsync  method to create collections \nof values and labels from the Department  and Location  data and use them to con-\nfigure the CustomSelect  components. Restart ASP.NET Core and request http://\nlocalhost:5000/forms/edit/2; you will see the select  elements shown in figure 36.3. \nWhen you pick a new value, the CustomSelect  component will update the Current-\nValueAsString  property, which will result in a call to the TryParseValueFromString  \nmethod, with the result used to update the Value  binding.\nFigure 36.3    Using a custom form element",7738
444-36.2.2 Validating form data.pdf,444-36.2.2 Validating form data,"1092 chapter  36 Blazor forms and data\n36.2.2  Validating form data\nBlazor provides components that perform validation using the standard attributes. \nTable 36.4 describes the validation components.  \nTable 36.4    The Blazor validation components\nName Description\nDataAnnotationsValidator This component integrates the validation  \nattributes applied to the model class into the \nBlazor form features.\nValidationMessage This component displays validation error  \nmessages for a single property.\nValidationSummary This component displays validation error  \nmessages for the entire model object.\nThe validation components generate elements assigned to classes, described in table \n36.5, which can be styled with CSS to draw the user’s attention.  \nTable 36.5    The classes used by the Blazor validation components\nName Description\nvalidation-errors The ValidationSummary  component  \ngenerates a ul element that is assigned to this \nclass and is the top-level container for the  \nsummary of validation messages.\nvalidation-message The ValidationSummary  component  \npopulates its ul element with li elements \nassigned to this class for each validation  \nmessage. The ValidationMessage   \ncomponent renders a div element assigned to \nthis class for its property-level messages.\nThe Blazor Input*  components add the HTML elements they generate to the classes \ndescribed in table 36.6 to indicate validation status. This includes the InputBase -\n<TValue>  class from which I derived the CustomSelect  component and is the pur-\npose of the CssClass  property in listing 36.8.\nTable 36.6    The validation classes added to form elements \nName Description\nmodified Elements are added to this class once the user has edited the \nvalue.\nvalid Elements are added to this class if the value they contain \npasses validation.\ninvalid Elements are added to this class if the value they contain fails \nvalidation.\n 1093 Using the Blazor form components\nThis combination of components and classes can be confusing at first, but the key is to \nstart by defining the CSS styles you require based on the classes in table 36.5 and 36.6. \nAdd a CSS Stylesheet named blazorValidation.css  to the wwwroot  folder with the \ncontent shown in listing 36.10.\nListing 36.10    The Contents of the blazorValidation.css File in the wwwroot Folder\n.validation-errors {\n    background-color: rgb(220, 53, 69); color: white; padding: 8px; \n    text-align: center; font-size: 16px; font-weight: 500;\n}\ndiv.validation-message { color: rgb(220, 53, 69); font-weight: 500 }\n.modified.valid { border: solid 3px rgb(40, 167, 69); }\n.modified.invalid { border: solid 3px rgb(220, 53, 69); }\nThese styles format error messages in red and apply a red or green border to individual \nform elements. Listing 36.11 imports the CSS stylesheet and applies the Blazor valida-\ntion components.\nListing 36.11    Applying validation in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n<link href=""/blazorValidation.css"" rel=""stylesheet"" />\n<h4 class=""bg-primary text-center text-white p-2"">Edit</h4>\n<FormSpy PersonData=""PersonData"">\n    <EditForm Model=""PersonData"">\n        <DataAnnotationsValidator />\n        <ValidationSummary />\n        <div class=""form-group"">\n            <label>Person ID</label>\n            <InputNumber class=""form-control""\n                         @bind-Value=""PersonData.PersonId"" disabled />\n        </div>\n        <div class=""form-group"">\n            <label>Firstname</label>\n            <ValidationMessage For=""@(() => PersonData.Firstname)"" />\n            <InputText class=""form-control"" \n                @bind-Value=""PersonData.Firstname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Surname</label>\n            <ValidationMessage For=""@(() => PersonData.Surname)"" />\n            <InputText class=""form-control"" \n                @bind-Value=""PersonData.Surname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Dept ID</label>\n            <ValidationMessage For=""@(() => PersonData.DepartmentId)"" />\n            <CustomSelect TValue=""long"" Values=""Departments""\n1094 chapter  36 Blazor forms and data\n                          Parser=""@((string str) => long.Parse(str))""\n                          @bind-Value=""PersonData.DepartmentId"">\n                <option selected disabled value=""0"">\n                    Choose a Department\n                </option>\n            </CustomSelect>\n        </div>\n        <div class=""form-group"">\n            <label>Location ID</label>\n            <ValidationMessage For=""@(() => PersonData.LocationId)"" />\n            <CustomSelect TValue=""long"" Values=""Locations""\n                          Parser=""@((string str) => long.Parse(str))""\n                          @bind-Value=""PersonData.LocationId"">\n                <option selected disabled value=""0"">\n                    Choose a Location\n                </option>\n            </CustomSelect>\n        </div>\n        <div class=""text-center"">\n            <NavLink class=""btn btn-secondary mt-2"" href=""/forms"">\n                Back\n            </NavLink>\n        </div>\n    </EditForm>\n</FormSpy>\n@code {\n   // ...members omitted for brevity...\n}\nThe DataAnnotationsValidator  and ValidationSummary  components are applied \nwithout any configuration attributes. The ValidationMessage  attribute is configured \nusing the For attribute, which receives a function that returns the property the com-\nponent represents. For example, here is the expression that selects the Firstname  \nproperty:\n...\n<ValidationMessage For=""@(() => PersonData.Firstname) "" />\n...\nThe expression defines no parameters and selects the property from the object used \nfor the Model  attribute of the EditForm  component and not the model type. For this \nexample, this means the expression operates on the PersonData  object and not the \nPerson  class.\nTIP    Blazor isn’t always able to determine the type of the property for the \nValidation  Message  component. If you receive an exception, then you can \nadd a TValue  attribute to set the type explicitly. For example, if the type of the \nproperty the ValidationMessage  component represents is long , then add a \nTValue=""long""  attribute.\n 1095 Using the Blazor form components\nThe final step for enabling data validation is to apply attributes to the model class, as \nshown in listing 36.12.\nListing 36.12    Applying validation attributes in the Person.cs file in the Models folder\nusing System.ComponentModel.DataAnnotations;\nnamespace Advanced.Models {\n    public class Person {\n        public long PersonId { get; set; }\n        [Required(ErrorMessage = ""A firstname is required"")]\n        [MinLength(3, ErrorMessage \n            = ""Firstnames must be 3 or more characters"")]\n        public string Firstname { get; set; } = String.Empty;\n        [Required(ErrorMessage = ""A surname is required"")]\n        [MinLength(3, ErrorMessage \n            = ""Surnames must be 3 or more characters"")]\n        public string Surname { get; set; } = String.Empty;\n        [Range(1, long.MaxValue,\n            ErrorMessage = ""A department must be selected"")]\n        public long DepartmentId { get; set; }\n        [Range(1, long.MaxValue,\n            ErrorMessage = ""A location must be selected"")]\n        public long LocationId { get; set; }\n        public Department? Department { get; set; }\n        public Location? Location { get; set; }\n    }\n}\nTo see the effect of the validation components, restart ASP.NET Core and request \nhttp://localhost:5000/forms/edit/2. Clear the Firstname  field and move the focus \nby pressing the Tab key or clicking on another field. As the focus changes, validation is \nperformed, and error messages will be displayed. The Editor  component shows both \nsummary and per-property messages, so you will see the same error message shown \ntwice. Delete all but the first two characters from the Surname field, and a second val-\nidation message will be displayed when you change the focus, as shown in figure 36.4. \n(There is validation support for the other properties, too, but the select  element \ndoesn’t allow the user to select an invalid valid. If you change a value, the select  ele-\nment will be decorated with a green border to indicate a valid selection, but you won’t \nbe able to see an invalid response until I demonstrate how the form components can \nbe used to create new data objects.)",8577
445-36.2.3 Handling form events.pdf,445-36.2.3 Handling form events,"1096 chapter  36 Blazor forms and data\nFigure 36.4    \nUsing the Blazor \nvalidation \nfeatures\n36.2.3  Handling form events\nThe EditForm  component defines events that allow an application to respond to user \naction, as described in table 36.7.\nTable 36.7    The EditForm events\nName Description\nOnValidSubmit This event is triggered when the form \nis submitted and the form data passes \nvalidation.\nOnInvalidSubmit This event is triggered when the form \nis submitted and the form data fails \nvalidation.\nOnSubmit This event is triggered when the form \nis submitted and before validation is \nperformed. \nThese events are triggered by adding a conventional submit button within the con-\ntent contained by the EditForm  component. The EditForm  component handles the \nonsubmit  event sent by the form  element it renders, applies validation, and triggers \nthe events described in the table. Listing 36.13 adds a submit button to the Editor  \ncomponent and handles the EditForm  events.\nListing 36.13    Handling events in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n<link href=""/blazorValidation.css"" rel=""stylesheet"" />\n<h4 class=""bg-primary text-center text-white p-2"">Edit</h4>\n<h6 class=""bg-info text-center text-white p-2"">@FormSubmitMessage</h6>\n 1097 Using the Blazor form components\n<FormSpy PersonData=""PersonData"">\n    <EditForm Model=""PersonData"" OnValidSubmit=""HandleValidSubmit"" \n            OnInvalidSubmit=""HandleInvalidSubmit"">\n        <DataAnnotationsValidator />\n        <ValidationSummary />\n        <div class=""form-group"">\n            <label>Person ID</label>\n            <InputNumber class=""form-control""\n                         @bind-Value=""PersonData.PersonId"" disabled />\n        </div>\n        <div class=""form-group"">\n            <label>Firstname</label>\n            <ValidationMessage For=""@(() => PersonData.Firstname)"" />\n            <InputText class=""form-control"" \n                @bind-Value=""PersonData.Firstname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Surname</label>\n            <ValidationMessage For=""@(() => PersonData.Surname)"" />\n            <InputText class=""form-control"" \n                @bind-Value=""PersonData.Surname"" />\n        </div>\n        <div class=""form-group"">\n            <label>Dept ID</label>\n            <ValidationMessage For=""@(() => PersonData.DepartmentId)"" />\n            <CustomSelect TValue=""long"" Values=""Departments""\n                          Parser=""@((string str) => long.Parse(str))""\n                          @bind-Value=""PersonData.DepartmentId"">\n                <option selected disabled value=""0"">\n                    Choose a Department\n                </option>\n            </CustomSelect>\n        </div>\n        <div class=""form-group"">\n            <label>Location ID</label>\n            <ValidationMessage For=""@(() => PersonData.LocationId)"" />\n            <CustomSelect TValue=""long"" Values=""Locations""\n                          Parser=""@((string str) => long.Parse(str))""\n                          @bind-Value=""PersonData.LocationId"">\n                <option selected disabled value=""0"">\n                    Choose a Location\n                </option>\n            </CustomSelect>\n        </div>\n        <div class=""text-center"">\n            <button type=""submit"" class=""btn btn-primary mt-2"">\n                Submit\n            </button>\n            <NavLink class=""btn btn-secondary mt-2"" href=""/forms"">\n                Back\n            </NavLink>\n        </div>\n    </EditForm>\n</FormSpy>\n@code {",3649
446-36.3 Using Entity Framework Core with Blazor.pdf,446-36.3 Using Entity Framework Core with Blazor,,0
447-36.3.1 Understanding the EF Core context scope issue.pdf,447-36.3.1 Understanding the EF Core context scope issue,"1098 chapter  36 Blazor forms and data\n    // ...members omitted brevity...\n    public string FormSubmitMessage { get; set; } \n        = ""Form Data Not Submitted"";\n    public void HandleValidSubmit() => FormSubmitMessage \n        = ""Valid Data Submitted"";\n    public void HandleInvalidSubmit() => FormSubmitMessage \n        = ""Invalid Data Submitted"";\n}\nRestart ASP.NET Core and request http://localhost:5000/forms/edit/2. Clear the \nFirstname field, and click the Submit button. In addition to the validation error, you \nwill see a message indicating that the form was submitted with invalid data. Enter a \nname into the field and click Submit again, and the message will change, as shown in \nfigure 36.5. \nFigure 36.5    \nHandling  \nEditForm  \nevents\n36.3 Using Entity Framework Core with Blazor\nThe Blazor model changes the way that Entity Framework Core behaves, which can \nlead to unexpected results if you are used to writing conventional ASP.NET Core appli-\ncations. In the sections that follow, I explain the issues and how to avoid the problems \nthat can arise.  \n36.3.1  Understanding the EF Core context scope issue\nTo see the first issue, request http://localhost:5000/forms/edit/4, clear the Firstname \nfield, change the contents of the Surname field to La, and press Tab to change the focus.\nNeither of the new values passes validation, and you will see error messages as you move \nbetween the form elements. Click the Back button, and you will see that the data table \nreflects the changes you made, as shown in figure 36.6, even though they were not valid.\n 1099 Using Entity Framework Core with Blazor\nFigure 36.6    \nThe effect of \nediting data\nIn a conventional ASP.NET Core application, written using controllers or Razor Pages, \nclicking a button triggers a new HTTP request. Each request is handled in isolation, \nand each request receives its own Entity Framework Core context object, which is con-\nfigured as a scoped service. The result is that the data created when handling one \nrequest affects other requests only once it has been written to the database.\nIn a Blazor application, the routing system responds to URL changes without send-\ning new HTTP requests, which means that multiple components are displayed using \nonly the persistent HTTP connection that Blazor maintains to the server. This results \nin a single dependency injection scope being shared by multiple components, as shown \nin figure 36.7, and the changes made by one component will affect other components \neven if the changes are not written to the database.\nFigure 36.7    The use of an Entity Framework Core context in a Blazor application\nEntity Framework Core is trying to be helpful, and this approach allows complex data \noperations to be performed over time before being stored (or discarded). Unfortu-\nnately, much like the helpful approach Entity Framework Core takes to dealing with \nrelated data, which I described in chapter 35, it presents a pitfall for the unwary devel-\noper who expects components to handle data like the rest of ASP.NET Core.\n1100 chapter  36 Blazor forms and data\ndiscarding  unsaved  data changes  \nIf sharing a context between components is appealing, which it will be for some appli-\ncations, then you can embrace the approach and ensure that components discard any \nchanges when they are destroyed, as shown in listing 36.14.\nListing 36.14    Discarding unsaved data in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n@implements IDisposable\n<!-- ...elements omitted for brevity...  -->\n@code {\n    // ...members omitted for brevity...\n    public void HandleInvalidSubmit() => FormSubmitMessage \n        = ""Invalid Data Submitted"";\n    public void Dispose() {\n        if (Context != null) {\n            Context.Entry(PersonData).State = EntityState.Detached;\n        }\n    }\n}\nAs I noted in chapter 35, components can implement the System.IDisposable  inter-\nface, and the Dispose  method will be invoked when the component is about to be \ndestroyed, which happens when navigation to another component occurs. In listing \n36.14, the implementation of the Dispose  method tells Entity Framework Core to dis-\nregard the PersonData  object, which means it won’t be used to satisfy future requests. \nTo see the effect, restart ASP.NET Core, request http://localhost:5000/forms/edit/4, \nclear the Firstname field, and click the Back button. The modified Person  object is \ndisregarded when Entity Framework Core provides the List  component with its data, \nas shown in figure 36.8.\nFigure 36.8    \nDiscarding data \nobjects\n 1101 Using Entity Framework Core with Blazor\ncreating  new dependency  injection  scopes\nYou must create new dependency injection scopes if you want to preserve the \nmodel used by the rest of ASP.NET Core and have each component receive its \nown Entity Framework Core context object. This is done by using the @inherits  \nexpression to set the base class for the component to OwningComponentBase  or \nOwningComponentBase<T> . \nThe OwningComponentCase  class defines a ScopedServices  property that is inher-\nited by the component and that provides an IServiceProvider  object that can be \nused to obtain services that are created in a scope that is specific to the component’s \nlifecycle and will not be shared with any other component, as shown in listing 36.15.\nListing 36.15    Using a new scope in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n@inherits OwningComponentBase\n@using Microsoft.Extensions.DependencyInjection\n<!-- ...elements omitted for brevity...  -->\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    //[Inject]\n    DataContext? Context => ScopedServices.GetService<DataContext>();\n    [Parameter]\n    public long Id { get; set; }\n    // ...members omitted for brevity...\n    public void HandleInvalidSubmit() => FormSubmitMessage \n        = ""Invalid Data Submitted"";\n    //public void Dispose() {\n    //    if (Context != null) {\n    //        Context.Entry(PersonData).State = EntityState.Detached;\n    //    }\n    //}\n}\nIn the listing, I commented out the Inject  attribute and set the value of the  \nContext  property by obtaining a DataContext  service. The Microsoft.Extensions     \n.DependencyInjection  namespace contains extension methods that make it easier \nto obtain services from an IServiceProvider  object, as described in chapter 14. \nNOTE     Changing the base class doesn’t affect services that are received using \nthe Inject  attribute, which will still be obtained within the request scope. Each \nservice that you require in the dedicated component’s scope must be obtained \n1102 chapter  36 Blazor forms and data\nthrough the ScopedServices  property, and the Inject  attribute should not be \napplied to that property.\nThe OwningComponentBase<T>  class defines an additional convenience property that \nprovides access to a scoped service of type T and that can be useful if a component \nrequires only a single scoped service, as shown in listing 36.16 (although further ser-\nvices can still be obtained through the ScopedServices  property).\nListing 36.16    Using the typed base in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@layout EmptyLayout\n@inherits OwningComponentBase<DataContext>\n<link href=""/blazorValidation.css"" rel=""stylesheet"" />\n<h4 class=""bg-primary text-center text-white p-2"">Edit</h4>\n<h6 class=""bg-info text-center text-white p-2"">@FormSubmitMessage</h6>\n<!-- ...elements omitted for brevity...  -->\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    //[Inject]\n    DataContext? Context => Service;\n    [Parameter]\n    public long Id { get; set; }\n    // ...statements omitted for brevity...\n}\nThe scoped service is available through a property named Service . In this example, I \nspecified DataContext  as the type argument for the base class. \nRegardless of which base class is used, the result is that the Editor  component has \nits own dependency injection scope and its own DataContext  object. The List  compo-\nnent has not been modified, so it will receive the request-scoped DataContext  object, \nas shown in figure 36.9.\nFigure 36.9    Using scoped services for components",8447
448-36.3.2 Understanding the repeated query issue.pdf,448-36.3.2 Understanding the repeated query issue,"1103 Using Entity Framework Core with Blazor\nRestart ASP.NET Core, navigate to http://localhost:5000/forms/edit/4, clear the \nFirstname field, and click the Back button. The changes made by the Editor compo-\nnent are not saved to the database, and since the Editor  component’s data context is \nseparate from the one used by the List  component, the edited data is discarded, pro-\nducing the same response as shown in figure 36.8.\n36.3.2  Understanding the repeated query issue \nBlazor responds to changes in state as efficiently as possible but still has to render a \ncomponent’s content to determine the changes that should be sent to the browser. \nOne consequence of the way that Blazor works is that it can lead to a sharp increase \nin the number of queries sent to the database. To demonstrate the issue, listing 36.17 \nadds a button that increments a counter to the List  component.  \nListing 36.17    Adding a button in the List.razor file in the Blazor/Forms folder\n@page ""/forms""\n@page ""/forms/list""\n@layout EmptyLayout\n<h5 class=""bg-primary text-white text-center p-2"">People</h5>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th><th>Name</th><th>Dept</th><th>Location</th><th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @if  (People.Count() == 0) {\n            <tr>\n                <th colspan=""5"" class=""p-4 text-center"">\n                    Loading Data...\n                </th>\n            </tr>\n        } else {\n            @foreach (Person p in People) {\n                <tr>\n                    <td>@p.PersonId</td>\n                    <td>@p.Surname, @p.Firstname</td>\n                    <td>@p.Department?.Name</td>\n                    <td>@p.Location?.City</td>\n                    <td>\n                        <NavLink class=""btn btn-sm btn-warning"" \n                             href=""@GetEditUrl(p.PersonId)"">\n                            Edit\n                        </NavLink>\n                    </td>\n                </tr>\n            }\n        }\n    </tbody>\n</table>\n1104 chapter  36 Blazor forms and data\n<button class=""btn btn-primary"" @onclick=""@(() => Counter++)"">\n    Increment\n</button>\n<span class=""h5"">Counter: @Counter</span>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person> People { get; set; } \n        = Enumerable.Empty<Person>();\n    protected override void OnInitialized() {\n        People = Context?.People?.Include(p => p.Department)\n            .Include(p => p.Location) \n                ?? Enumerable.Empty<Person>();\n    }\n    string GetEditUrl(long id) => $""/forms/edit/{id}"";\n    public int Counter { get; set; } = 0;\n}\nRestart ASP.NET Core and request http://localhost:5000/forms. Click the Increment  \nbutton and watch the output from the ASP.NET Core server. Each time you click the \nbutton, the event handler is invoked, and a new database query is sent to the database, \nproducing logging messages like these:\n...\ninfo: Microsoft.EntityFrameworkCore.Database.Command[20101]\n      Executed DbCommand (0ms) [Parameters=[], CommandType='Text', \n      CommandTimeout='30']\n      SELECT [p].[PersonId], [p].[DepartmentId], [p].[Firstname], \n        [p].[LocationId],  [p].[Surname], [d].[Departmentid], \n        [d].[Name], [l].[LocationId], [l].[City], [l].[State]\n      FROM [People] AS [p]\n      INNER JOIN [Departments] AS [d] ON [p].[DepartmentId] \n        = [d].[Departmentid]\n      INNER JOIN [Locations] AS [l] ON [p].[LocationId] = [l].[LocationId]\ninfo: Microsoft.EntityFrameworkCore.Database.Command[20101]\n      Executed DbCommand (0ms) [Parameters=[], CommandType='Text', \n       CommandTimeout='30']\n      SELECT [p].[PersonId], [p].[DepartmentId], [p].[Firstname], \n        [p].[LocationId], [p].[Surname], [d].[Departmentid], [d].[Name],\n        [l].[LocationId], [l].[City], [l].[State]\n      FROM [People] AS [p]\n      INNER JOIN [Departments] AS [d] ON [p].[DepartmentId] = [d].\n[Departmentid]\n      INNER JOIN [Locations] AS [l] ON [p].[LocationId] = [l].[LocationId]\n...\nEach time the component is rendered, Entity Framework Core sends two identical \nrequests to the database, even when the Increment button is clicked where no data \noperations are performed.\n 1105 Using Entity Framework Core with Blazor\nThis issue can arise whenever Entity Framework Core is used and is exacerbated by \nBlazor. Although it is common practice to assign database queries to IEnumerable<T>  \nproperties, doing so masks an important aspect of Entity Framework Core, which is \nthat its LINQ expressions are expressions of queries and not results, and each time the \nproperty is read, a new query is sent to the database. The value of the People  property \nis read twice by the List  component: once by the Count  property to determine whether \nthe data has loaded and once by the @foreach  expression to generate the rows for the \nHTML table. When the user clicks the Increment button, Blazor renders the List  com-\nponent again to figure out what has changed, which causes the People  property to be \nread twice more, producing two additional database queries.\nBlazor and Entity Framework Core are both working the way they should. Blazor \nmust rerender the component’s output to figure out what HTML changes need to \nbe sent to the browser. It has no way of knowing what effect clicking the button has \nuntil after it has rendered the elements and evaluated all the Razor expressions. Entity \nFramework Core is executing its query each time the property is read, ensuring that the \napplication always has fresh data.\nThis combination of features presents two issues. The first is that needless queries \nare sent to the database, which can increase the capacity required by an application \n(although not always because database servers are adept at handling queries). \nThe second issue is that changes to the database will be reflected in the content \npresented to the user after they make an unrelated interaction. If another user adds a \nPerson  object to the database, for example, it will appear in the table the next time the \nuser clicks the Increment button. Users expect applications to reflect only their actions, \nand unexpected changes are confusing and distracting.\nmanaging  Queries  in a component\nThe interaction between Blazor and Entity Framework Core won’t be a problem for all \nprojects, but if it is, then the best approach is to query the database once and requery \nonly for operations where the user might expect an update to occur. Some applications \nmay need to present the user with an explicit option to reload the data, especially for \napplications where updates are likely to occur that the user will want to see, as shown \nin listing 36.18.\nListing 36.18    Controlling queries in the List.razor file in the Blazor/Forms folder\n@page ""/forms""\n@page ""/forms/list""\n@layout EmptyLayout\n<h5 class=""bg-primary text-white text-center p-2"">People</h5>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Dept</th>\n1106 chapter  36 Blazor forms and data\n            <th>Location</th>\n            <th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @if (People.Count() == 0) {\n            <tr>\n                <th colspan=""5"" class=""p-4 text-center"">\n                    Loading Data...\n                </th>\n            </tr>\n        } else {\n            @foreach (Person p in People) {\n                <tr>\n                    <td>@p.PersonId</td>\n                    <td>@p.Surname, @p.Firstname</td>\n                    <td>@p.Department?.Name</td>\n                    <td>@p.Location?.City</td>\n                    <td>\n                        <NavLink class=""btn btn-sm btn-warning""\n                         href=""@GetEditUrl(p.PersonId)"">\n                            Edit\n                        </NavLink>\n                    </td>\n                </tr>\n            }\n        }\n    </tbody>\n</table>\n<button class=""btn btn-danger"" @onclick=""UpdateData"">Update</button>\n<button class=""btn btn-primary"" @onclick=""@(() => Counter++)"">\n    Increment\n</button>\n<span class=""h5"">Counter: @Counter</span>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person> People { get; set; }\n        = Enumerable.Empty<Person>();\n    protected async override Task OnInitializedAsync() {\n        await UpdateData();\n    }\n    private async Task UpdateData() {\n        if (Context != null) {\n            People = await Context.People.Include(p => p.Department)\n                .Include(p => p.Location).ToListAsync<Person>();\n        } else {\n            People = Enumerable.Empty<Person>();\n        }\n 1107 Using Entity Framework Core with Blazor\n    }\n    string GetEditUrl(long id) => $""/forms/edit/{id}"";\n    public int Counter { get; set; } = 0;\n}\nThe UpdateData  method performs the same query but applies the ToListAsync  \nmethod, which forces evaluation of the Entity Framework Core query. The results are \nassigned to the People  property and can be read repeatedly without triggering addi-\ntional queries. To give the user control over the data, I added a button that invokes \nthe UpdateData  method when it is clicked. Restart ASP.NET Core, request http://  \nlocalhost:5000/forms, and click the Increment button. Monitor the output from the \nASP.NET Core server, and you will see that there is a query made only when the compo-\nnent is initialized. To explicitly trigger a query, click the Update button.\nSome operations may require a new query, which is easy to perform. To demonstrate, \nlisting 36.19 adds a sort operation to the List  component, which is implemented both \nwith and without a new query.\nListing 36.19    Adding operations to the List.razor file in the Blazor/Forms folder\n@page ""/forms""\n@page ""/forms/list""\n@layout EmptyLayout\n<h5 class=""bg-primary text-white text-center p-2"">People</h5>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Dept</th>\n            <th>Location</th>\n            <th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @if (People.Count() == 0) {\n            <tr>\n                <th colspan=""5"" class=""p-4 text-center"">\n                    Loading Data...\n                </th>\n            </tr>\n        } else {\n            @foreach (Person p in People) {\n                <tr>\n                    <td>@p.PersonId</td>\n                    <td>@p.Surname, @p.Firstname</td>\n                    <td>@p.Department?.Name</td>\n                    <td>@p.Location?.City</td>\n                    <td>\n                        <NavLink class=""btn btn-sm btn-warning""\n1108 chapter  36 Blazor forms and data\n                         href=""@GetEditUrl(p.PersonId)"">\n                            Edit\n                        </NavLink>\n                    </td>\n                </tr>\n            }\n        }\n    </tbody>\n</table>\n<button class=""btn btn-danger my-2"" @onclick=""@(() => UpdateData())"">\n    Update\n</button>\n<button class=""btn btn-info my-2"" @onclick=""SortWithQuery"">\n    Sort (With Query)\n</button>\n<button class=""btn btn-info my-2"" @onclick=""SortWithoutQuery"">\n    Sort (No Query)\n</button>\n<button class=""btn btn-primary"" @onclick=""@(() => Counter++)"">\n    Increment\n</button>\n<span class=""h5"">Counter: @Counter</span>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Person> People { get; set; }\n        = Enumerable.Empty<Person>();\n    protected async override Task OnInitializedAsync() {\n        await UpdateData();\n    }\n    private IQueryable<Person> Query =>\n        Context!.People.Include(p => p.Department)\n            .Include(p => p.Location);\n    private async Task UpdateData(IQueryable<Person>? query = null) =>\n        People = await (query ?? Query).ToListAsync<Person>();\n    public async Task SortWithQuery() {\n        await UpdateData(Query.OrderBy(p => p.Surname));\n    }\n    public void SortWithoutQuery() {\n        People = People.OrderBy(p => p.Firstname).ToList<Person>();\n    }\n    string GetEditUrl(long id) => $""/forms/edit/{id}"";\n    public int Counter { get; set; } = 0;\n}",12511
449-36.4.2 Creating the details component.pdf,449-36.4.2 Creating the details component,"1109 Performing CRUD operations \nEntity Framework Core queries are expressed as IQueryable<T>  objects, allowing \nthe query to be composed with additional LINQ methods before it is dispatched to \nthe database server. The new operations in the example both use the LINQ OrderBy  \nmethod, but one applies this to the IQueryable<T> , which is then evaluated to send \nthe query with the ToListAsync  method. The other operation applies the OrderBy  \nmethod to the existing result data, sorting it without sending a new query. To see both \noperations, restart ASP.NET Core, request http://localhost:5000/forms, and click the \nSort buttons, as shown in figure 36.10. When the Sort (With Query) button is clicked, \nyou will see a log message indicating that a query has been sent to the database.\nFigure 36.10    \nManaging \ncomponent queries\nAvoiding the overlapping query pitfall\nYou may encounter an exception telling you that “a second operation started on this \ncontext before a previous operation completed.” This happens when a child compo-\nnent uses the OnParametersSetAsync  method to perform an asynchronous Entity \nFramework Core query and a change in the parent’s data triggers a second call to  \nOn  ParametersSetAsync  before the query is complete. The second method call starts \na duplicate query that causes the exception. This problem can be resolved by performing \nthe Entity Framework Core query synchronously. You can see an example in listing 36.23, \nwhere I perform queries synchronously because the parent component will trigger an \nupdate when it receives its data.\n36.4 Performing CRUD operations \nTo show how the features described in previous sections fit together, I am going to \ncreate a simple application that allows the user to perform create, read, update, and \ndelete (CRUD) operations on Person  objects. \n1110 chapter  36 Blazor forms and data\n36.4.1  Creating the list component \nThe List  component contains the basic functionality I require. Listing 36.20 removes \nsome of the features from earlier sections that are no longer required and adds but-\ntons that allow the user to navigate to other functions.\nListing 36.20    Preparing the component in the List.razor file in the Blazor/Forms folder\n@page ""/forms""\n@page ""/forms/list""\n@layout EmptyLayout\n@inherits OwningComponentBase<DataContext>\n<h5 class=""bg-primary text-white text-center p-2"">People</h5>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th><th>Name</th><th>Dept</th><th>Location</th><th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @if (People.Count() == 0) {\n            <tr>\n                <th colspan=""5"" class=""p-4 text-center"">\n                    Loading Data...\n                </th>\n            </tr>\n        } else {\n            @foreach (Person p in People) {\n                <tr>\n                    <td>@p.PersonId</td>\n                    <td>@p.Surname, @p.Firstname</td>\n                    <td>@p.Department?.Name</td>\n                    <td>@p.Location?.City</td>\n                    <td class=""text-center"">\n                        <NavLink class=""btn btn-sm btn-info"" \n                               href=""@GetDetailsUrl(p.PersonId)"">\n                            Details\n                        </NavLink>\n                        <NavLink class=""btn btn-sm btn-warning"" \n                               href=""@GetEditUrl(p.PersonId)"">\n                            Edit\n                        </NavLink>\n                        <button class=""btn btn-sm btn-danger"" \n                                @onclick=""@(() => HandleDelete(p))"">\n                            Delete\n                        </button>\n                    </td>\n                </tr>\n            }\n        }\n    </tbody>\n</table>\n 1111 Performing CRUD operations \n<NavLink class=""btn btn-primary"" href=""/forms/create"">Create</NavLink>\n@code {\n    //[Inject]\n    public DataContext? Context => Service;\n    public IEnumerable<Person> People { get; set; } \n        = Enumerable.Empty<Person>();\n    protected async override Task OnInitializedAsync() {\n        await UpdateData();\n    }\n    private IQueryable<Person> Query => \n        Context!.People.Include(p => p.Department)\n            .Include(p => p.Location);\n    private async Task UpdateData(IQueryable<Person>? query = null) => \n        People = await (query ?? Query).ToListAsync<Person>();\n    public async Task SortWithQuery() {\n        await UpdateData(Query.OrderBy(p => p.Surname));\n    }\n    public void SortWithoutQuery() {\n        People = People.OrderBy(p => p.Firstname).ToList<Person>();\n    }\n    string GetEditUrl(long id) => $""/forms/edit/{id}"";\n    string GetDetailsUrl(long id) => $""/forms/details/{id}"";\n    public async Task HandleDelete(Person p) {\n        if (Context != null) {\n            Context.Remove(p);\n            await Context.SaveChangesAsync();\n            await UpdateData();\n        }\n    }\n}\nThe operations for creating, viewing, and editing objects navigate to other URLs, but \nthe delete operations are performed by the List  component, taking care to reload the \ndata after the changes have been saved to reflect the change to the user.\n36.4.2  Creating the details component \nThe details component displays a read-only view of the data, which doesn’t require the \nBlazor form features or present any issues with Entity Framework Core. Add a Blazor \nComponent named Details.razor  to the Blazor/Forms  folder with the content \nshown in listing 36.21.\n1112 chapter  36 Blazor forms and data\nListing 36.21    The contents of the Details.razor file in the Blazor/Forms folder\n@page ""/forms/details/{id:long}""\n@layout EmptyLayout\n@inherits OwningComponentBase<DataContext>\n<h4 class=""bg-info text-center text-white p-2"">Details</h4>\n<div class=""form-group"">\n    <label>ID</label>\n    <input class=""form-control"" value=""@PersonData.PersonId"" disabled />\n</div>\n<div class=""form-group"">\n    <label>Firstname</label>\n    <input class=""form-control"" value=""@PersonData.Firstname"" disabled />\n</div>\n<div class=""form-group"">\n    <label>Surname</label>\n    <input class=""form-control"" value=""@PersonData.Surname"" disabled />\n</div>\n<div class=""form-group"">\n    <label>Department</label>\n    <input class=""form-control"" value=""@PersonData.Department?.Name"" \n        disabled />\n</div>\n<div class=""form-group"">\n    <label>Location</label>\n    <input class=""form-control""\n           value=""@($""{PersonData.Location?.City}, "" \n                + PersonData.Location?.State)""\n           disabled />\n</div>\n<div class=""text-center p-2"">\n    <NavLink class=""btn btn-info"" href=""@EditUrl"">Edit</NavLink>\n    <NavLink class=""btn btn-secondary"" href=""/forms"">Back</NavLink>\n</div>\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    DataContext Context => Service;\n    [Parameter]\n    public long Id { get; set; }\n    public Person PersonData { get; set; } = new();\n    protected async override Task OnParametersSetAsync() {\n        if (Context != null) {\n            PersonData = await Context.People\n                .Include(p => p.Department)\n                .Include(p => p.Location)\n                .FirstOrDefaultAsync(p => p.PersonId == Id)",7365
450-36.4.3 Creating the editor component.pdf,450-36.4.3 Creating the editor component,"1113 Performing CRUD operations \n                    ?? new();\n        }\n    }\n    public string EditUrl => $""/forms/edit/{Id}"";\n}\nAll the input  elements displayed by this component are disabled, which means there \nis no need to handle events or process user input. \n36.4.3  Creating the editor component\nThe remaining features will be handled by the Editor  component. Listing 36.22 \nremoves the features from earlier examples that are no longer required and adds sup-\nport for creating and editing objects, including persisting the data.\nListing 36.22    Adding features in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@page ""/forms/create""\n@layout EmptyLayout\n@inherits OwningComponentBase<DataContext>\n<link href=""/blazorValidation.css"" rel=""stylesheet"" />\n<h4 class=""bg-@Theme text-center text-white p-2"">@Mode</h4>\n<EditForm Model=""PersonData"" OnValidSubmit=""HandleValidSubmit"" >\n    <DataAnnotationsValidator />\n    @if (Mode == ""Edit"") {\n        <div class=""form-group"">\n            <label>ID</label>\n            <InputNumber class=""form-control""\n                @bind-Value=""PersonData.PersonId"" readonly />\n        </div>\n    }\n    <div class=""form-group"">\n        <label>Firstname</label>\n        <ValidationMessage For=""@(() => PersonData.Firstname)"" />\n        <InputText class=""form-control"" \n            @bind-Value=""PersonData.Firstname"" />\n    </div>\n    <div class=""form-group"">\n        <label>Surname</label>\n        <ValidationMessage For=""@(() => PersonData.Surname)"" />\n        <InputText class=""form-control"" \n            @bind-Value=""PersonData.Surname"" />\n    </div>\n    <div class=""form-group"">\n        <label>Deptartment</label>\n        <ValidationMessage For=""@(() => PersonData.DepartmentId)"" />\n        <CustomSelect TValue=""long"" Values=""Departments"" \n                        Parser=""@((string str) => long.Parse(str))""\n                        @bind-Value=""PersonData.DepartmentId"">\n            <option selected disabled value=""0"">\n1114 chapter  36 Blazor forms and data\n                Choose a Department\n             </option>\n        </CustomSelect>\n    </div>\n    <div class=""form-group"">\n        <label>Location</label>\n        <ValidationMessage For=""@(() => PersonData.LocationId)"" />\n        <CustomSelect TValue=""long"" Values=""Locations"" \n                        Parser=""@((string str) => long.Parse(str))""\n                        @bind-Value=""PersonData.LocationId"">\n            <option selected disabled value=""0"">Choose a Location</option>\n        </CustomSelect>\n    </div>\n    <div class=""text-center"">\n        <button type=""submit"" class=""btn btn-@Theme mt-2"">Save</button>\n        <NavLink class=""btn btn-secondary mt-2"" href=""/forms"">\n            Back\n        </NavLink>\n    </div>\n</EditForm>\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    //[Inject]\n    DataContext? Context => Service;\n    [Parameter]\n    public long Id { get; set; }\n    public Person PersonData { get; set; } = new();\n    public IDictionary<string, long> Departments { get; set; } \n        = new Dictionary<string, long>();\n    public IDictionary<string, long> Locations { get; set; } \n        = new Dictionary<string, long>();\n    protected async override Task OnParametersSetAsync() {\n        if (Context != null) {\n            if (Mode == ""Edit"") {\n                PersonData = await Context.People.FindAsync(Id) \n                    ?? new Person();\n            }\n            Departments = await Context.Departments\n                .ToDictionaryAsync(d => d.Name, d => d.Departmentid);\n            Locations = await Context.Locations\n                .ToDictionaryAsync(l => $""{l.City}, {l.State}"", \n                    l => l.LocationId);\n        }\n    }\n    public string Theme => Id == 0 ? ""primary"" : ""warning"";\n    public string Mode => Id == 0 ? ""Create"" : ""Edit"";",3956
451-36.5.1 Creating a custom validation constraint.pdf,451-36.5.1 Creating a custom validation constraint,"1115 Extending the Blazor form features\n    public async Task HandleValidSubmit()  {\n        if (Context != null) {\n            if (Mode == ""Create"") {\n                Context.Add(PersonData);\n            }\n            await Context.SaveChangesAsync();\n            NavManager?.NavigateTo(""/forms"");\n        }\n    }\n}\nI added support for a new URL and used Bootstrap CSS themes to differentiate between \ncreating a new object and editing an existing one. I removed the validation summary so \nthat only property-level validation messages are displayed and added support for stor-\ning the data through Entity Framework Core. Unlike form applications created using \ncontrollers or Razor Pages, I don’t have to deal with model binding because Blazor lets \nme work directly with the object that Entity Framework Core produces from the ini-\ntial database query. Restart ASP.NET Core and request http://localhost:5000/forms. \nYou will see the list of Person  objects shown in figure 36.11, and clicking the Create, \nDetails, Edit, and Delete buttons will allow you to work with the data in the database.\nTIP    Open a command prompt and run dotnet ef database drop --force  \nin the Advanced  project folder if you need to reset the database to undo the \nchanges you have made. The database will be seeded again when you restart ASP \n.NET Core, and you will see the data shown in the figure.\nFigure 36.11    Using Blazor to work with data\n36.5 Extending the Blazor form features\nThe Blazor form features are effective but have the rough edges that are always found \nin new technology. I expect future releases to round out the feature set, but, in the \nmeantime, Blazor makes it easy to enhance the way that forms work. The EditForm  \ncomponent defines a cascading EditContext  object that provides access to form vali-\ndation and makes it easy to create custom form components through the events, prop-\nerties, and methods described in table 36.8.  \n1116 chapter  36 Blazor forms and data\nTable 36.8    The EditContext features\nName Description\nOnFieldChanged This event is triggered when any of the form fields are \nmodified.\nOnValidationRequested This event is triggered when validation is required and can \nbe used to create custom validation processes. \nOnValidationStateChanged This event is triggered when the validation state of the \noverall form changes.\nModel This property returns the value passed to the EditForm  \ncomponent’s Model  property.\nField(name) This method is used to get a FieldIdentifier  object \nthat describes a single field.\nIsModified() This method returns true  if any of the form fields have \nbeen modified.\nIsModified(field) This method returns true  if the field specified by the \nFieldIdentifier  argument has been modified.\nGetValidationMessages() This method returns a sequence containing the validation \nerror messages for the entire form.\nGetValidationMessages \n(field)This method returns a sequence containing the validation \nerror messages for a single field, using a FieldIdenti-\nfer object obtained from the Field  method.\nMarkAsUnmodified() This method marks the form as unmodified.\nMarkAsUnmodified(field) This method marks a specific field as unmodified, using \na FieldIdentifer  object obtained from the Field  \nmethod.\nNotifyValidation  StateChanged() This method is used to indicate a change in validation \nstatus.\nNotifyFieldChanged(field) This method is used to indicate when a field has changed, \nusing a FieldIdentifer  object obtained from the \nField  method.\nValidate() This method performs validation on the form, returning \ntrue  if all the form fields pass validation and false  \notherwise.\n36.5.1  Creating a custom validation constraint\nYou can create components that apply custom validation constraints if the built-in val-\nidation attributes are not sufficient. This type of component doesn’t render its own \ncontent, and it is more easily defined as a class. Add a class file named DeptState -\nValidator.cs  to the Blazor/Forms  folder and use it to define the component class \nshown in listing 36.23.\nListing 36.23    The contents of the DeptStateValidator.cs file in the Blazor/Forms folder\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Components;\nusing Microsoft.AspNetCore.Components.Forms;\n 1117 Extending the Blazor form features\nnamespace Advanced.Blazor.Forms {\n    public class DeptStateValidator : OwningComponentBase<DataContext> {\n        public DataContext Context => Service;\n        [Parameter]\n        public long DepartmentId { get; set; }\n        [Parameter]\n        public string? State { get; set; }\n        [CascadingParameter]\n        public EditContext? CurrentEditContext { get; set; }\n        private string? DeptName { get; set; }\n        private IDictionary<long, string>? LocationStates { get; set; }\n        protected override void OnInitialized() {\n            if (CurrentEditContext != null) {\n                ValidationMessageStore store =\n                    new ValidationMessageStore(CurrentEditContext);\n                CurrentEditContext.OnFieldChanged += (sender, args) => {\n                    string name = args.FieldIdentifier.FieldName;\n                    if (name == ""DepartmentId"" || name == ""LocationId"") {\n                        Validate(CurrentEditContext.Model as Person, \n                            store);\n                    }\n                };\n            }\n        }\n        protected override void OnParametersSet() {\n            DeptName = Context.Departments.Find(DepartmentId)?.Name;\n            LocationStates = Context.Locations\n                .ToDictionary(l => l.LocationId, l => l.State);\n        }\n        private void Validate(Person? model, \n                ValidationMessageStore store) {\n            if (model?.DepartmentId == DepartmentId\n                    && LocationStates != null \n                    && CurrentEditContext != null\n                    && (!LocationStates.ContainsKey(model.LocationId)\n                        || LocationStates[model.LocationId] != State)) {\n                store.Add(CurrentEditContext.Field(""LocationId""),\n                    $""{DeptName} staff must be in: {State}"");\n            } else {\n                store.Clear();\n            }\n            CurrentEditContext?.NotifyValidationStateChanged();\n        }\n    }\n}\nThis component enforces a restriction on the state in which departments can be \ndefined so that, for example, locations in California are the valid options only when \n1118 chapter  36 Blazor forms and data\nthe Development  department has been chosen, and any other locations will produce \na validation error.\nThe component has its own scoped DataContext  object, which it receives by using \nOwningComponentBase<T>  as its base class. The parent component provides values for \nthe DepartmentId  and State  properties, which are used to enforce the validation rule. \nThe cascading EditContext  property is received from the EditForm  component and \nprovides access to the features described in table 36.8.\nWhen the component is initialized, a new ValidationMessageStore  is created. \nThis object is used to register validation error messages and accepts the EditContext  \nobject as its constructor argument, like this:\n...\nValidationMessageStore store =  \n    new ValidationMessageStore(CurrentEditContext);\n...\nBlazor takes care of processing the messages added to the store, and the custom valida-\ntion component only needs to decide which messages are required, which is handled \nby the Validate  method. This method checks the DepartmentId  and LocationId  \nproperties to make sure that the combination is allowed. If there is an issue, then a new \nvalidation message is added to the store, like this:\n...\nstore.Add(CurrentEditContext.Field(""LocationId""), \n    $""{DeptName} staff must be in: {State}"");\n...\nThe arguments to the Add method are a FieldIdentifier  that identifies the field the \nerror relates to and the validation message. If there are no validation errors, then the \nmessage store’s Clear  method is called, which will ensure that any stale messages that \nhave been previously generated by the component are no longer displayed. \nThe Validation  method is called by the handler for the OnFieldChanged  event, \nwhich allows the component to respond whenever the user makes a change.\n...\nCurrentEditContext. OnFieldChanged  += (sender, args) => {\n    string name = args.FieldIdentifier.FieldName;\n    if (name == ""DepartmentId"" || name == ""LocationId"") {\n        Validate(CurrentEditContext.Model as Person, store);\n     }\n};\n...\nThe handler receives a FieldChangeEventArgs  object, which defines a Field-\nIdentifer  property that indicates which field has been modified. Listing 36.24 applies \nthe new validation to the Editor  component.\nListing 36.24    Applying validation in the Editor.razor file in the Blazor/Forms folder\n@page ""/forms/edit/{id:long}""\n@page ""/forms/create""\n@layout EmptyLayout",9071
452-36.5.2 Creating a valid-only submit button component.pdf,452-36.5.2 Creating a valid-only submit button component,"1119 Extending the Blazor form features\n@inherits OwningComponentBase<DataContext>\n<link href=""/blazorValidation.css"" rel=""stylesheet"" />\n<h4 class=""bg-@Theme text-center text-white p-2"">@Mode</h4>\n<EditForm Model=""PersonData"" OnValidSubmit=""HandleValidSubmit"" >\n    <DataAnnotationsValidator />\n    <DeptStateValidator DepartmentId=""2"" State=""CA"" />\n    @if (Mode == ""Edit"") {\n        <div class=""form-group"">\n            <label>ID</label>\n            <InputNumber class=""form-control""\n                @bind-Value=""PersonData.PersonId"" readonly />\n        </div>\n    }\n    <!-- ...elements omitted for brevity...  -->\n</EditForm>\n@code {\n    // ...statements omitted for brevity...\n}\nThe DepartmentId  and State  attributes specify the restriction that only locations in \nCalifornia can be selected for the Development department. Restart ASP.NET Core \nand request http://localhost:5000/forms/edit/4. Choose Development for the \nDepartment field, and you will see a validation error because the location for this  \nPerson  is New York. This error will remain visible until you select a location in Califor-\nnia or change the department, as shown in figure 36.12.\nFigure 36.12    Creating a custom validation component \n36.5.2  Creating a valid-only submit button component \nTo finish this chapter, I am going to create a component that will render a submit but-\nton for the form that is enabled only when the data is valid. Add a Razor Component \nnamed ValidButton.razor  to the Blazor/Forms  folder with the contents shown in \nlisting 36.25.\n1120 chapter  36 Blazor forms and data\nListing 36.25    The contents of the ValidButton.razor file in the Blazor/Forms folder\n<button class=""@ButtonClass"" @attributes=""Attributes"" \n        disabled=""@Disabled"">\n    @ChildContent\n</button>\n@code {\n    [Parameter]\n    public RenderFragment? ChildContent { get; set; }\n    [Parameter]\n    public string BtnTheme { get; set; } = ""primary"";\n    [Parameter]\n    public string DisabledClass { get; set; } \n        = ""btn-outline-dark disabled"";\n    [Parameter(CaptureUnmatchedValues = true)]\n    public IDictionary<string, object>? Attributes { get; set; }\n    [CascadingParameter]\n    public EditContext? CurrentEditContext { get; set; }\n    public bool Disabled { get; set; }\n    public string ButtonClass =>\n        Disabled ? $""btn btn-{BtnTheme} {DisabledClass} mt-2""\n                : $""btn btn-{BtnTheme} mt-2"";\n    protected override void OnInitialized() {\n        SetButtonState();\n        if (CurrentEditContext != null) {\n            CurrentEditContext.OnValidationStateChanged +=\n                (sender, args) => SetButtonState();\n            CurrentEditContext.Validate();\n        }\n    }\n    public void SetButtonState() {\n        if (CurrentEditContext != null) {\n            Disabled = CurrentEditContext.GetValidationMessages().Any();\n        }\n    }\n}\nThis component responds to the OnValidationStateChanged  method, which is trig-\ngered when the validation state of the form changes. There is no EditContext  prop-\nerty that details the validation state, so the best way to see if there are any validation \nissues is to see whether there are any validation messages. If there are, there are valida-\ntion issues. If there are no validation messages, the form is valid. To ensure the button \nstate is displayed correctly, the Validation  method is called so that a validation check \nis performed as soon as the component is initialized.\n 1121 Extending the Blazor form features\nListing 36.26 uses the new component to replace the conventional button in the \nEditor  component.\nListing 36.26    Applying a component in the Editor.razor file in the Blazor/Forms folder\n...\n<div class=""text-center"">\n    <ValidButton type=""submit"" BtnTheme=""@Theme"">Save</ValidButton>\n    <NavLink class=""btn btn-secondary mt-2"" href=""/forms"">Back</NavLink>\n</div>\n...\nRestart ASP.NET Core and request http://localhost:5000/forms/create; you will see \nthe validation messages displayed for each form element, with the Save button dis-\nabled. The button will be enabled once each validation issue has been resolved, as \nshown in figure 36.13.\nFigure 36.13    \nCreating a \ncustom form \nbutton\nSummary\n¡ Blazor provides built-in components for common HTML form elements, includ-\ning form , input , and textarea  elements.\n¡ Form events are presented through the EditForm  component.\n¡ Entity Framework Core context scopes must be carefully managed to avoid stale \ndata. Scopes can be managed through the IDisposable  interface, or through \nautomatic dependency injection.\n¡ Take care with data read from Entity Framework Core to avoid repeated queries.",4734
453-37.1 Preparing for this chapter.pdf,453-37.1 Preparing for this chapter,"112237Using Blazor  \nWebAssembly\nThis chapter covers\n¡ Using WebAssembly to create self-contained  \n client-side applications \n¡ Creating WebAssembly components \n¡ Navigating between components in a  \n WebAssembly application\n¡ Creating a forms application using  \n WebAssembly components\nIn this chapter, I demonstrate the use of Blazor WebAssembly, which is an imple-\nmentation of Blazor written for WebAssembly.\nWebAssembly is a virtual machine running inside the browser. High-level lan-\nguages are compiled into low-level language-neutral assembler format that can be \nexecuted at close to native performance. WebAssembly provides access to the APIs \navailable to JavaScript applications, which means that WebAssembly applications can \naccess the domain object model, use cascading style sheets, and initiate asynchro-\nnous HTTP requests. \nBlazor WebAssembly breaks the dependency on the server and executes the \nBlazor application entirely in the browser. The result is a true client-side application, \nwith access to all the same features of Blazor Server but without the need for a per-\nsistent HTTP connection.\n 1123 Preparing for this chapter\nIt is early days for both WebAssembly and Blazor WebAssembly, and there are some \nserious restrictions. WebAssembly is a new technology and is supported only by the lat-\nest browser versions. You will not be able to use WebAssembly if your project needs to \nsupport legacy browsers—or even older versions of modern browsers. Blazor WebAs-\nsembly applications are restricted to the set of APIs the browser provides, which means \nthat not all .NET features can be used in a WebAssembly application. This doesn’t disad-\nvantage Blazor when compared to client-side frameworks like Angular, but it does mean \nthat features such as Entity Framework Core are not available because browsers restrict \nWebAssembly applications to making HTTP requests.\nStill, despite the limitations of Blazor WebAssembly, it is an exciting technology, and \nit offers the promise of being able to write true client-side applications using C# and \nASP.NET Core, without the need for a JavaScript framework. Table 37.1 puts Blazor \nWebAssembly in context.\nTable 37.1    Putting Blazor WebAssembly in context\nQuestion Answer\nWhat is it? Blazor WebAssembly is an implementation of Blazor that runs in the browser \nusing WebAssembly.\nWhy is it useful? Blazor WebAssembly allows client-side applications to be written in C# without \nserver-side execution or the persistent HTTP connection required by Blazor Server.\nHow is it used? Blazor components are added to a project that is dedicated to Blazor \nWebAssembly.\nAre there any  \npitfalls or limitations?Not all browsers support WebAssembly. A larger download is required to provide \nthe browser with the code it requires, and not all ASP.NET Core features are avail -\nable in Blazor WebAssembly components.\nAre there any \nalternatives?Blazor WebAssembly is the only combination of true client-side applications \nwritten using ASP.NET Core. Blazor Server can be used if server-side support is \nacceptable; otherwise, a JavaScript framework, such as Angular, React, or Vue.js, \nshould be used.\n37.1 Preparing for this chapter\nThis chapter uses the Advanced project from chapter 36. To prepare for this chapter, \nadd a class file named DataController.cs  to the Controllers  folder and use it to \ndefine the web service controller shown in listing 37.1.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 37.1    The contents of the DataController.cs file in the Controllers folder\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\n1124 chapter  37 Using Blazor WebAssembly \nnamespace Advanced.Controllers {\n    [ApiController]\n    [Route(""/api/people"")]\n    public class DataController : ControllerBase {\n        private DataContext context;\n        public DataController(DataContext ctx) {\n            context = ctx;\n        }\n        [HttpGet]\n        public IEnumerable<Person> GetAll() {\n            IEnumerable<Person> people\n                = context.People\n                    .Include(p => p.Department)\n                    .Include(p => p.Location);\n            foreach (Person p in people) {\n                if (p.Department?.People != null) {\n                    p.Department.People = null;\n                }\n                if (p.Location?.People != null) {\n                    p.Location.People = null;\n                }\n            }\n            return people;\n        }\n        [HttpGet(""{id}"")]\n        public async Task<Person> GetDetails(long id) {\n            Person p = await context.People\n                .Include(p => p.Department)\n                .Include(p => p.Location)\n                .FirstAsync(p => p.PersonId == id);\n            if (p.Department?.People != null) {\n                p.Department.People = null;\n            }\n            if (p.Location?.People != null) {\n                p.Location.People = null;\n            }\n            return p;\n        }\n        [HttpPost]\n        public async Task Save([FromBody] Person p) {\n            await context.People.AddAsync(p);\n            await context.SaveChangesAsync();\n        }\n        [HttpPut]\n        public async Task Update([FromBody] Person p) {\n            context.Update(p);\n            await context.SaveChangesAsync();\n        }\n        [HttpDelete(""{id}"")]",5681
454-37.2 Setting Up Blazor WebAssembly.pdf,454-37.2 Setting Up Blazor WebAssembly,"1125 Preparing for this chapter\n        public async Task Delete(long id) {\n            context.People.Remove(new Person() { PersonId = id });\n            await context.SaveChangesAsync();\n        }\n        [HttpGet(""/api/locations"")]\n        public IAsyncEnumerable<Location> GetLocations() => \n            context.Locations.AsAsyncEnumerable();\n        [HttpGet(""/api/departments"")]\n        public IAsyncEnumerable<Department> GetDepts() => \n            context.Departments.AsAsyncEnumerable();\n    }\n}\nThis controller provides actions that allow Person  objects to be created, read, updated, \nand deleted. I have also added actions that return the Location  and Department  \nobjects. I usually create separate controllers for each type of data, but these actions are \nrequired only in support of the Person  features, so I have combined all the operations \ninto a single controller.\n37.1.1  Dropping the database and running the application \nOpen a new PowerShell command prompt, navigate to the folder that contains the \nAdvanced.csproj  file, and run the command shown in listing 37.2 to drop the \ndatabase.\nListing 37.2    Dropping the database\ndotnet ef database drop --force\nUse the PowerShell command prompt to run the command shown in listing 37.3. \nListing 37.3    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/api/people, which will produce a \nJSON representation of the Person  objects from the database, as shown in figure 37.1.\nFigure 37.1    Running the example application",1563
455-37.2.1 Creating the shared project.pdf,455-37.2.1 Creating the shared project,,0
456-37.2.3 Preparing the ASP.NET Core project.pdf,456-37.2.3 Preparing the ASP.NET Core project,"1126 chapter  37 Using Blazor WebAssembly \n37.2 Setting Up Blazor WebAssembly\nBlazor WebAssembly requires a separate project so that Razor Components can be \ncompiled ready to be executed by the browser. The compiled components can be \ndelivered to the browser by a standard ASP.NET Core server, which can also provide \ndata through web services. To make it easy for the Blazor WebAssembly components to \nconsume the data provided by the ASP.NET Core server, a third project is required that \ncontains those items that are shared between them. \nThe process for creating the three projects is involved, partly because I am going to \nmove some of the existing classes from the Advanced project into the data model proj-\nect. Although it is possible to perform some of the steps using the Visual Studio wizards, \nI have set out the steps using the command-line tools to minimize errors. \nNOTE    If you have problems following the steps, you can download all three \nprojects from the GitHub repository for this book, at https://github.com/  \nmanningbooks/pro-asp.net-core-7 .\n37.2.1  Creating the shared project \nMake sure Visual Studio or Visual Studio Code is closed before you start. Open a new \nPowerShell command prompt and navigate to the Advanced  project folder, which is \nthe one that contains the Advanced.csproj  file, and run the commands shown in \nlisting 37.4.  \nListing 37.4    Preparing the project for Blazor \ndotnet new classlib -o ../DataModel -f net7.0\nMove-Item -Path @(""Models/Person.cs"", ""Models/Location.cs"",  \n    ""Models/Department.cs"") ../DataModel\nThese commands create a new project named DataModel  and move the data model \nclasses to the new project.\n37.2.2  Creating the Blazor WebAssembly project \nI usually prefer to start with an empty project and add the packages and configuration \nfiles that the application requires. Use the PowerShell command prompt to run the \ncommands shown in listing 37.5 from within the Advanced  project folder (the folder \nthat contains the Advanced.csproj  file). \nListing 37.5    Creating the Blazor WebAssembly project \ndotnet new blazorwasm -o ../BlazorWebAssembly -f net7.0\ndotnet add ../BlazorWebAssembly reference ../DataModel\nThese commands create a Blazor WebAssembly project named BlazorWebAssembly  \nand add a reference to the DataModel  project, which makes the Person , Department , \nand Location  classes available.",2426
457-37.2.4 Adding the solution references.pdf,457-37.2.4 Adding the solution references,,0
458-37.2.6 Completing the Blazor WebAssembly configuration.pdf,458-37.2.6 Completing the Blazor WebAssembly configuration,"1127 Setting Up Blazor WebAssembly\n37.2.3  Preparing the ASP .NET Core project\nUse the PowerShell command prompt to run the commands shown in listing 37.6 in \nthe Advanced  project folder.\nListing 37.6    Preparing the advanced project \ndotnet add reference ../DataModel ../BlazorWebAssembly  \ndotnet add package Microsoft.AspNetCore.Components.WebAssembly.Server  \n    --version 7.0.0\nThese commands create references to the other projects so that the data model classes \nand the components in the Blazor WebAssembly project can be used. \n37.2.4  Adding the solution references\nRun the command shown in listing 37.7 in the Advanced  folder to add references to \nthe new project to the solution file.\nListing 37.7    Adding solution references \ndotnet sln add ../DataModel ../BlazorWebAssembly\n37.2.5  Opening the projects \nOnce you have set up all three projects, start Visual Studio or Visual Studio Code. If \nyou are using Visual Studio, open the Advanced.sln  file in the Advanced  folder. All \nthree projects are open for editing, as shown in figure 37.2. If you are using Visual \nStudio Code, open the folder that contains all three projects, as shown in figure 37.2.\nFigure 37.2    \nOpening the \nthree projects\n1128 chapter  37 Using Blazor WebAssembly \n37.2.6  Completing the Blazor WebAssembly configuration\nThe next step is to configure the ASP.NET Core project so that it can deliver the con-\ntents of the Blazor WebAssembly project to clients. Add the statements shown in listing \n37.8 to the Program.cs  file in the Advanced  folder.  \nCAUTION    It is important to pay close attention to which files you are editing. \nFiles with the same name exist in multiple projects, and if you don’t follow the \nexamples closely, you won’t end up with a working application. Future versions of \nBlazor may be easier to work with, but for the moment, the details are important. \nListing 37.8    Configuring the application in the Program.cs file in the Advanced project\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddSingleton<Advanced.Services.ToggleService>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");\napp.UseBlazorFrameworkFiles(""/webassembly"");\napp.MapFallbackToFile(""/webassembly/{*path:nonfile}"",\n     ""/webassembly/index.html"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThese statements configure the ASP.NET Core request pipeline so that requests for  \n/webassembly  are handled by Blazor WebAssembly using the contents of the Blazor-\nWebAssembly  project.\n 1129 Setting Up Blazor WebAssembly\nsetting  the base url\nThe next step is to modify the HTML file that will be used to respond to requests for \nthe /webassembly  URL. Apply the change shown in listing 37.9 to the index.html  \nfile in the wwwroot  folder of the BlazorWebAssembly  folder.  \nCAUTION    Make sure there are forward-slash ( /) characters before and after \nwebassembly  in the href  attribute of the base  element. If you omit either char-\nacter, then Blazor WebAssembly will not work.\nListing 37.9    Setting the URL in the index.html file in the wwwroot folder of the \nBlazorWebAssembly project\n<!DOCTYPE html>\n<html lang=""en"">\n<head>\n    <meta charset=""utf-8"" />\n    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0,\n          maximum-scale=1.0, user-scalable=no"" />\n    <title>BlazorWebAssembly</title>\n    <base href=""/webassembly/"" />\n    <link href=""css/bootstrap/bootstrap.min.css"" rel=""stylesheet"" />\n    <link href=""css/app.css"" rel=""stylesheet"" />\n    <link rel=""icon"" type=""image/png"" href=""favicon.png"" />\n    <link href=""BlazorWebAssembly.styles.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div id=""app"">\n        <svg class=""loading-progress"">\n            <circle r=""40%"" cx=""50%"" cy=""50%"" />\n            <circle r=""40%"" cx=""50%"" cy=""50%"" />\n        </svg>\n        <div class=""loading-progress-text""></div>\n    </div>\n    <div id=""blazor-error-ui"">\n        An unhandled error has occurred.\n        <a href="""" class=""reload"">Reload</a>\n        <a class=""dismiss"">  </a>\n    </div>\n    <script src=""_framework/blazor.webassembly.js""></script>\n</body>\nThe base  element sets the URL from which all relative URLs in the document are \ndefined and is required for the correct operation of the Blazor WebAssembly routing \nsystem.\nsetting  the static  web asset  base path\nIf you are using Visual Studio, right-click the BlazorWebAssembly project in the Solu-\ntion Explorer, select Edit Project File from the pop-up menu, and add the configu-\nration element shown in listing 37.10. If you are using Visual Studio Code, open the",5333
459-37.3 Creating a Blazor WebAssembly component.pdf,459-37.3 Creating a Blazor WebAssembly component,"1130 chapter  37 Using Blazor WebAssembly \nBlazorWebAssembly.csproj  file in the BlazorWebAssembly  folder and add the con-\nfiguration element shown in listing 37.10.\nListing 37.10    Adding an element in the BlazorWebAssembly.csproj file in the \nBlazorWebAssembly folder\n...\n<PropertyGroup>\n    <TargetFramework>net6.0</TargetFramework>\n    <Nullable>enable</Nullable>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <StaticWebAssetBasePath>/webassembly/</StaticWebAssetBasePath>\n</PropertyGroup>\n...\nThe element tag name is StaticWebAssetBasePath , and the content is /webassem-\nbly/ , which starts and ends with a / character.\nCAUTION     Make sure there are forward-slash ( /) characters before and after \nwebassembly  in the StaticWebAssetBasePath  attribute of the base  element. \nIf you omit either character, then Blazor WebAssembly will not work.\n37.2.7  Testing the placeholder components \nStart ASP.NET Core by selecting Start Without Debugging or Run Without Debugging \nfrom the Debug menu. If you prefer to use the command prompt, run the command \nshown in listing 37.11 in the Advanced  project folder.  \nListing 37.11    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/webassembly, and you will see the \nplaceholder content added by the template used to create the BlazorWebAssembly  \nproject.\nUsing the PowerShell command prompt, run the following commands from within \nthe Advanced  project folder. Click the Counter and Fetch Data links, and you will see \ndifferent content displayed, as shown in figure 37.3.\nFigure 37.3    The Blazor WebAssembly placeholder content",1658
460-37.3.1 Importing the data model namespace.pdf,460-37.3.1 Importing the data model namespace,,0
461-37.3.2 Creating a component.pdf,461-37.3.2 Creating a component,"1131 Creating a Blazor WebAssembly component\n37.3 Creating a Blazor WebAssembly component\nBlazor WebAssembly uses the same approach as Blazor Server, relying on components \nas building blocks for applications, connected through the routing system, and dis-\nplaying common content through layouts. In this section, I show how to create a Razor \nComponent that works with Blazor WebAssembly, and then I’ll re-create the simple \nforms application from chapter 36.\n37.3.1  Importing the data model namespace \nThe components I will create in this chapter all use the classes in the shared Data-\nModel  project. Rather than add @using  expressions to each component, add the \nnamespace for the data model classes to the _Imports.razor  file in the root folder of \nthe BlazorWebAssembly  project, as shown in listing 37.12.\nListing 37.12    Adding a namespace in the _Imports.razor file in the BlazorWebAssembly \nproject \n@using System.Net.Http\n@using System.Net.Http.Json\n@using Microsoft.AspNetCore.Components.Forms\n@using Microsoft.AspNetCore.Components.Routing\n@using Microsoft.AspNetCore.Components.Web\n@using Microsoft.AspNetCore.Components.Web.Virtualization\n@using Microsoft.AspNetCore.Components.WebAssembly.Http\n@using Microsoft.JSInterop\n@using BlazorWebAssembly\n@using BlazorWebAssembly.Shared\n@using Advanced.Models\nNotice that although I moved the model classes to the DataModel  project, I have spec-\nified the Advanced.Models  namespace. This is because the class files I moved all have \nnamespace  declarations that specify Advanced.Models , which means that moving the \nfiles hasn’t changed the namespace in which the classes exist.\n37.3.2  Creating a component\nIn earlier chapters, I defined my Razor Components in a Blazor  folder to keep the \nnew content separate from the other parts of ASP.NET Core. There is only Blazor \ncontent in the BlazorWebAssembly  project, so I am going to follow the convention \nadopted by the project template and use the Pages  and Shared  folders.  \nAdd a Razor Component named List.razor  to the Pages  folder of the Blazor-\nWebAssembly  project and add the content shown in listing 37.13.\nListing 37.13    The contents of the List.razor File in the Pages folder of the \nBlazorWebAssembly project\n@page ""/forms""\n@page ""/forms/list""\n<h5 class=""bg-primary text-white text-center p-2"">\n1132 chapter  37 Using Blazor WebAssembly \n    People (WebAssembly)\n</h5>\n<table class=""table table-sm table-striped table-bordered"">\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Name</th>\n            <th>Dept</th>\n            <th>Location</th>\n            <th></th>\n        </tr>\n    </thead>\n    <tbody>\n        @if (People.Count() == 0) {\n            <tr>\n                <th colspan=""5"" class=""p-4 text-center"">\n                    Loading Data...\n                </th>\n            </tr>\n        } else {\n            @foreach (Person p in People) {\n                <tr>\n                    <td>@p.PersonId</td>\n                    <td>@p.Surname, @p.Firstname</td>\n                    <td>@p.Department?.Name</td>\n                    <td>@p.Location?.City</td>\n                    <td class=""text-center"">\n                        <NavLink class=""btn btn-sm btn-info""\n                         href=""@GetDetailsUrl(p.PersonId)"">\n                            Details\n                        </NavLink>\n                        <NavLink class=""btn btn-sm btn-warning""\n                         href=""@GetEditUrl(p.PersonId)"">\n                            Edit\n                        </NavLink>\n                        <button class=""btn btn-sm btn-danger""\n                        @onclick=""@(() => HandleDelete(p))"">\n                            Delete\n                        </button>\n                    </td>\n                </tr>\n            }\n        }\n    </tbody>\n</table>\n<NavLink class=""btn btn-primary"" href=""forms/create"">Create</NavLink>\n@code {\n    [Inject]\n    public HttpClient? Http { get; set; }\n    public Person[] People { get; set; } = Array.Empty<Person>();\n 1133 Creating a Blazor WebAssembly component\n    protected async override Task OnInitializedAsync() {\n        await UpdateData();\n    }\n    private async Task UpdateData() {\n        if (Http != null) {\n            People = await Http.GetFromJsonAsync<Person[]>(""/api/people"")\n                ?? Array.Empty<Person>();\n        }\n    }\n    string GetEditUrl(long id) => $""forms/edit/{id}"";\n    string GetDetailsUrl(long id) => $""forms/details/{id}"";\n    public async Task HandleDelete(Person p) {\n        if (Http != null) {\n            HttpResponseMessage resp =\n                await Http.DeleteAsync($""/api/people/{p.PersonId}"");\n            if (resp.IsSuccessStatusCode) {\n                await UpdateData();\n            }\n        }\n    }\n}\nIf you compare this component with the Blazor Server equivalent from chapter 36, \nyou will see that they are largely the same. Both types of Blazor use the same set of core \nfeatures, which is why the content uses the same Razor directives, handles events with \nthe @onclick  attributes, and uses the same @code  section for C# statements. A Blazor \nWebAssembly component is compiled into a C# class, just like its Blazor Server coun-\nterpart. The key difference is, of course, that the C# class that is generated is executed \nin the browser—and that’s the reason for the differences from the component in chap-\nter 36. \nnavigating  in a blazor  webassembly  component\nNotice that the URLs that are used for navigation are expressed without a leading for-\nward-slash character, like this:\n...\n<NavLink class=""btn btn-primary"" href=""forms/create"" >Create</NavLink>\n...\nThe root URL for the application was specified using the base  element in listing 37.13, \nand using relative URLs ensures that navigation is performed relative to the root. \nIn this case, the relative forms/create  URL is combined with the /webassembly/  \nroot specified by the base  element, and navigation will be to /webassembly/forms/  \ncreate . Including a leading forward slash would navigate to /forms/create  instead, \nwhich is outside the set of URLs that are being managed by the Blazor WebAssembly \npart of the application. This change is required only for navigation URLs. URLs speci-\nfied with the @page  directive, for example, are not affected.  \n1134 chapter  37 Using Blazor WebAssembly \ngetting  data in a blazor  webassembly  component  \nThe biggest change is that Blazor WebAssembly can’t use Entity Framework Core. \nAlthough the runtime may be able to execute the Entity Framework Core classes, the \nbrowser restricts WebAssembly applications to HTTP requests, preventing the use of \nSQL. To get data, Blazor WebAssembly applications consume web services, which is \nwhy I added the API controller to the Advanced project at the start of the chapter. \nAs part of the Blazor WebAssembly application startup, a service is created for the \nHttpClient  class, which components can receive using the standard dependency \ninjection features. The List  component receives an HttpClient  component through \na property that has been decorated with the Inject  attribute, like this:  \n...\n[Inject]\npublic HttpClient? Http { get; set; }\n...\nThe HttpClient  class provides the methods described in table 37.2 to send HTTP \nrequests.\nTable 37.2    The methods defined by the HttpClient class\nName Description\nGetAsync(url) This method sends an HTTP GET request.\nPostAsync(url, data) This method sends an HTTP POST request.\nPutAsync(url, data) This method sends an HTTP PUT request.\nPatchAync(url, data) This method sends an HTTP PATCH request.\nDeleteAsync(url) This method sends an HTTP DELETE request.\nSendAsync(request) This method sends an HTTP, configured using \nan HttpRequestMessage  object.\nThe methods in table 37.2 return a Task<HttpResponseMessage>  result, which \ndescribes the response received from the HTTP server to the asynchronous request. \nTable 37.3 shows the most useful HttpResponseMessage  properties.\nTable 37.3    Useful HttpClient properties\nName Description\nContent This property returns the content returned by \nthe server.\nHttpResponseHeaders This property returns the response headers.\nStatusCode This property returns the response status \ncode.\nIsSuccessStatusCode This property returns true  if the response sta-\ntus code is between 200 and 299, indicating a \nsuccessful request.\n 1135 Creating a Blazor WebAssembly component\nThe List  component uses the DeleteAsync  methods to ask the web service to delete \nobjects when the user clicks a Delete button.\n...\npublic async Task HandleDelete(Person p) {\n    if (Http != null) {\n        HttpResponseMessage resp =\n            await Http. DeleteAsync ($""/api/people/{p.PersonId}"");\n        if (resp.IsSuccessStatusCode) {\n            await UpdateData();\n        }\n    }\n...\nThese methods are useful when you don’t need to work with the data the web service \nsends back, such as in this situation where I check to see only if the DELETE request \nhas been successful. Notice that I specify the path for the request URL only when using \nthe HttpClient  service because the web service is available using the same scheme, \nhost, and port as the application. \nFor operations where the web service returns data, the extension methods for the \nHttpClient  class described in table 37.4 are more useful. These methods serialize data \ninto JSON so it can be sent to the server and parse JSON responses into C# objects. For \nrequests that return no result, the generic type argument can be omitted.\nTable 37.4    The HttpClient extension methods \nName Description\nGetFromJsonAsync<T>(url) This method sends an HTTP GET \nrequest and parses the response to \ntype T.\nPostJsonAsync<T>(url, data) This method sends an HTTP POST \nrequest with the serialized data \nvalue of T.\nPutJsonAsync<T>(url, data) This method sends an HTTP PUT \nrequest with the serialized data \nvalue of T.\nThe List  component uses the GetJsonAsync<T>  method to request data from the \nweb service.\n...\nprivate async Task UpdateData() {\n    if (Http != null) {\n        People = await Http. GetFromJsonAsync <Person[]>(""/api/people"") \n            ?? Array.Empty<Person>();\n    }\n} \n...\nSetting the generic type argument to Person[]  tells HttpClient  to parse the response \ninto an array of Person  objects.",10504
462-37.4 Completing the Blazor WebAssembly Form application.pdf,462-37.4 Completing the Blazor WebAssembly Form application,"1136 chapter  37 Using Blazor WebAssembly \nNOTE    The HttpClient  class doesn’t present any scope or lifecycle issues and \nsends requests only when one of the methods described in table 37.2 or table \n37.4 is invoked. Some thought is required, however, about when to request new \ndata. In this example, I requery the web service after an object has been deleted, \nrather than simply remove the object from the data that was requested when the \ncomponent was initialized. This may not be suitable for all applications because \nit will reflect any changes to the database that have been made by other users. \n37.3.3  Creating a layout\nThe template used to create the Blazor WebAssembly project includes a layout that \npresents the navigation features for the placeholder content. I don’t want these naviga-\ntion features, so the first step is to create a new layout. Add a Razor Component named \nEmptyLayout.razor  to the Shared  folder of the BlazorWebAssembly  project with \nthe content shown in listing 37.14.  \nListing 37.14    The EmptyLayout.razor file in the Shared folder of the  \nBlazorWebAssembly project\n@inherits LayoutComponentBase\n<div class=""m-2"">\n    @Body\n</div>\nI could apply the new layout with @layout  expressions, as I did in chapter 36, but I am \ngoing to use this layout as the default by changing the routing configuration, which is \ndefined in the App.razor  file in the BlazorWebAssembly  project, as shown in listing \n37.15. \nListing 37.15   Applying the layout in the App.razor file in the BlazorWebAssembly project \n<Router AppAssembly=""@typeof(App).Assembly"">\n    <Found Context=""routeData"">\n        <RouteView RouteData=""@routeData"" \n            DefaultLayout=""@typeof(EmptyLayout)"" />\n        <FocusOnNavigate RouteData=""@routeData"" Selector=""h1"" />\n    </Found>\n    <NotFound>\n        <PageTitle>Not found</PageTitle>\n        <LayoutView Layout=""@typeof(EmptyLayout)"">\n            <p role=""alert"">Sorry, there's nothing at this address.</p>\n        </LayoutView>\n    </NotFound>\n</Router>\nChapter 35 describes the Router , RouteView , Found , and NotFound  components. \n 1137 Creating a Blazor WebAssembly component\n37.3.4  Defining CSS styles\nThe template created the Blazor WebAssembly project with its own copy of the \nBootstrap CSS framework and with an additional stylesheet that combines the styles \nrequired to configure the Blazor WebAssembly error and validation elements and \nmanage the layout of the application. Replace the link  elements in the HTML file \nas shown in listing 37.16 and apply styles directly to the error  element. This has the \neffect of removing the styles used by the Microsoft layout and using the Bootstrap CSS \nstylesheet that was added to the Advanced project.  \nListing 37.16    Modifying the index.html file in the wwwroot folder in the \nBlazorWebAssembly project \n<!DOCTYPE html>\n<html lang=""en"">\n<head>\n    <meta charset=""utf-8"" />\n    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0,\n          maximum-scale=1.0, user-scalable=no"" />\n    <title>BlazorWebAssembly</title>\n    <base href=""/webassembly/"" />\n    <!--<link href=""css/bootstrap/bootstrap.min.css"" rel=""stylesheet"" />-->\n    <!--<link href=""css/app.css"" rel=""stylesheet"" />-->\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <link rel=""icon"" type=""image/png"" href=""favicon.png"" />\n    <link href=""BlazorWebAssembly.styles.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div id=""app"">\n        <svg class=""loading-progress"">\n            <circle r=""40%"" cx=""50%"" cy=""50%"" />\n            <circle r=""40%"" cx=""50%"" cy=""50%"" />\n        </svg>\n        <div class=""loading-progress-text""></div>\n    </div>\n    <div id=""blazor-error-ui""\n         class=""text-center bg-danger h6 text-white p-2 fixed-top w-100""\n         style=""display:none"">\n        An unhandled error has occurred.\n        <a href="""" class=""reload"">Reload</a>\n        <a class=""dismiss"">  </a>\n    </div>\n    <script src=""_framework/blazor.webassembly.js""></script>\n</body>\n</html> \nTo see the new component, restart ASP.NET Core and request http://localhost:5000/\nwebassembly/forms, which will produce the response shown in figure 37.4.",4259
463-37.4.2 Creating the editor component.pdf,463-37.4.2 Creating the editor component,"1138 chapter  37 Using Blazor WebAssembly \nFigure 37.4.   \nA Blazor \nWebAssembly \ncomponent\nBlazor WebAssembly components follow the standard Blazor lifecycle, and the compo-\nnent displays the data it receives from the web service. \n37.4 Completing the Blazor WebAssembly Form application \nOnly the Delete button displayed by the List  component works currently. In the sec-\ntions that follow, I complete the Blazor WebAssembly form application by creating \nadditional components. \n37.4.1  Creating the details component \nAdd a Razor Component named Details.razor  to the Pages  folder of the Blazor-\nWebAssembly  project with the content shown in listing 37.17.\nListing 37.17    The contents of the Details.razor file in the Pages folder of the \nBlazorWebAssembly Project \n@page ""/forms/details/{id:long}""\n<h4 class=""bg-info text-center text-white p-2"">Details (WebAssembly)</h4>\n<div class=""form-group"">\n    <label>ID</label>\n    <input class=""form-control"" value=""@PersonData.PersonId"" disabled />\n</div>\n<div class=""form-group"">\n    <label>Firstname</label>\n    <input class=""form-control"" value=""@PersonData.Firstname"" disabled />\n</div>\n<div class=""form-group"">\n    <label>Surname</label>\n    <input class=""form-control"" value=""@PersonData.Surname"" disabled />\n</div>\n<div class=""form-group"">\n    <label>Department</label>\n 1139 Completing the Blazor WebAssembly Form application \n    <input class=""form-control"" value=""@PersonData.Department?.Name"" \n        disabled />\n</div>\n<div class=""form-group"">\n    <label>Location</label>\n    <input class=""form-control""\n           value=""@($""{PersonData.Location?.City}, "" \n                + PersonData.Location?.State)""\n           disabled />\n</div>\n<div class=""text-center p-2"">\n    <NavLink class=""btn btn-info"" href=""@EditUrl"">Edit</NavLink>\n    <NavLink class=""btn btn-secondary"" href=""forms"">Back</NavLink>\n</div>\n@code {\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Inject]\n    public HttpClient? Http { get; set; }\n    [Parameter]\n    public long Id { get; set; }\n    public Person PersonData { get; set; } = new Person();\n    protected async override Task OnParametersSetAsync() {\n        if (Http != null) {\n            PersonData = await Http.GetFromJsonAsync<Person>(\n                $""/api/people/{Id}"")\n                    ?? new();\n        }\n    }\n    public string EditUrl => $""forms/edit/{Id}"";\n} \nThe Details  component has only two differences from its Blazor Server counterpart, \nfollowing the pattern established by the List  component: the data is obtained through \nthe HttpClient  service, and navigation targets are expressed using relative URLs. In \nall other regards, such as obtaining parameters from routing data, Blazor WebAssem-\nbly works just the same way as Blazor Server.\n37.4.2  Creating the editor component \nTo complete the forms application, add a Razor Component named Editor.razor  to \nthe Pages  folder of the BlazorWebAssembly  project with the content shown in listing \n37.18.\n1140 chapter  37 Using Blazor WebAssembly \nListing 37.18    The contents of the Editor.razor file in the Pages folder of the \nBlazorWebAssembly Project \n@page ""/forms/edit/{id:long}""\n@page ""/forms/create""\n<link href=""/blazorValidation.css"" rel=""stylesheet"" />\n<h4 class=""bg-@Theme text-center text-white p-2"">@Mode (WebAssembly)</h4>\n<EditForm Model=""PersonData"" OnValidSubmit=""HandleValidSubmit"">\n    <DataAnnotationsValidator />\n    @if (Mode == ""Edit"") {\n        <div class=""form-group"">\n            <label>ID</label>\n            <InputNumber class=""form-control""\n                     @bind-Value=""PersonData.PersonId"" readonly />\n        </div>\n    }\n    <div class=""form-group"">\n        <label>Firstname</label>\n        <ValidationMessage For=""@(() => PersonData.Firstname)"" />\n        <InputText class=""form-control"" \n            @bind-Value=""PersonData.Firstname"" />\n    </div>\n    <div class=""form-group"">\n        <label>Surname</label>\n        <ValidationMessage For=""@(() => PersonData.Surname)"" />\n        <InputText class=""form-control"" \n            @bind-Value=""PersonData.Surname"" />\n    </div>\n    <div class=""form-group"">\n        <label>Department</label>\n        <ValidationMessage For=""@(() => PersonData.DepartmentId)"" />\n        <select @bind=""PersonData.DepartmentId"" class=""form-control"">\n            <option selected disabled value=""0"">\n                Choose a Department\n            </option>\n            @foreach (var kvp in Departments) {\n                <option value=""@kvp.Value"">@kvp.Key</option>\n            }\n        </select>\n    </div>\n    <div class=""form-group"">\n        <label>Location</label>\n        <ValidationMessage For=""@(() => PersonData.LocationId)"" />\n        <select @bind=""PersonData.LocationId"" class=""form-control"">\n            <option selected disabled value=""0"">Choose a Location</option>\n            @foreach (var kvp in Locations) {\n                <option value=""@kvp.Value"">@kvp.Key</option>\n            }\n        </select>\n    </div>\n    <div class=""text-center p-2"">\n        <button type=""submit"" class=""btn btn-@Theme"">Save</button>\n 1141 Completing the Blazor WebAssembly Form application \n        <NavLink class=""btn btn-secondary"" href=""forms"">Back</NavLink>\n    </div>\n</EditForm>\n@code {\n    [Inject]\n    public HttpClient? Http { get; set; }\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    [Parameter]\n    public long Id { get; set; }\n    public Person PersonData { get; set; } = new Person();\n    public IDictionary<string, long> Departments { get; set; }\n        = new Dictionary<string, long>();\n    public IDictionary<string, long> Locations { get; set; }\n        = new Dictionary<string, long>();\n    protected async override Task OnParametersSetAsync() {\n        if (Http != null) {\n            if (Mode == ""Edit"") {\n                PersonData = await Http.GetFromJsonAsync<Person>(\n                        $""/api/people/{Id}"")\n                    ?? new();\n            }\n            var depts = await Http.GetFromJsonAsync<Department[]>(\n                    ""/api/departments"");\n            Departments = (depts ?? Array.Empty<Department>())\n                .ToDictionary(d => d.Name, d => d.Departmentid);\n            var locs = await Http.GetFromJsonAsync<Location[]>(\n                ""/api/locations"");\n            Locations = (locs ?? Array.Empty<Location>())\n                .ToDictionary(l => $""{l.City}, {l.State}"", \n                    l => l.LocationId);\n        }\n    }\n    public string Theme => Id == 0 ? ""primary"" : ""warning"";\n    public string Mode => Id == 0 ? ""Create"" : ""Edit"";\n    public async Task HandleValidSubmit() {\n        if (Http != null) {\n            if (Mode == ""Create"") {\n                await Http.PostAsJsonAsync(""/api/people"", PersonData);\n            } else {\n                await Http.PutAsJsonAsync(""/api/people"", PersonData);\n            }\n            NavManager?.NavigateTo(""forms"");\n        }\n    }\n}\n1142 chapter  37 Using Blazor WebAssembly \nThis component uses the Blazor form features described in chapter 36 but uses HTTP \nrequests to read and write data to the web service created at the start of the chapter. \nThe GetFromJsonAsync<T>  method is used to read data from the web service, and \nthe PostAsJsonAsync  and PutAsJsonAsync  methods are used to send POST or PUT \nrequests when the user submits the form.\nNotice that I have not used the custom select  component or validation compo-\nnents I created in chapter 36. Sharing components between projects—especially when \nBlazor WebAssembly is introduced after development has started—is awkward. I expect \nthe process to improve in future releases, but for this chapter, I have simply done with-\nout the features. As a consequence, the select  elements do not trigger validation when \na value is selected, the submit button isn’t automatically disabled, and there are no \nrestrictions on the combination of department and location.\nRestart ASP.NET Core and request http://localhost:5000/webassembly/forms, and \nyou will see the Blazor WebAssembly version of the form application. Click the Details \nbutton for the first item in the table, and you will see the fields for the selected object. \nClick the Edit button, and you will be presented with an editable form. Make a change \nand click the Save button, and the changes will be sent to the web service and displayed \nin the data table, as shown in figure 37.5.\nFigure 37.5    The completed Blazor WebAssembly form application\nSummary\n¡ Blazor WebAssembly creates client-side applications that do not need to main-\ntain a persistent connection to the ASP.NET Core server.\n¡ Creating an application with WebAssembly builds on the features described in \nearlier chapters for Blazor Server.\n¡ Data access in a WebAssembly application must be performed through the  \nHttpClient  object received via dependency injection.",9057
464-38.2.3 Creating and applying the Identity database migration.pdf,464-38.2.3 Creating and applying the Identity database migration,"114338Using ASP.NET  \nCore Identity\nThis chapter covers\n¡ Setting up ASP.NET Core Identity in an ASP.NET  \n Core projec t\n¡ Creating the ASP.NET Core Identity database\n¡ Managing user accounts and roles\nASP.NET Core Identity is an API from Microsoft to manage users in ASP.NET Core \napplications and includes support for integrating authentication and authorization \ninto the request pipeline.\nASP.NET Core Identity is a toolkit with which you create the authorization and \nauthentication features an application requires. There are endless integration \noptions for features such as two-factor authentication, federation, single sign-on, \nand account self-service. There are options that are useful only in large corporate \nenvironments or when using cloud-hosted user management. \nASP.NET Core Identity has evolved into its own framework and is too large for me \nto cover in detail in this book. Instead, I have focused on the parts of the Identity API \nthat intersect with web application development, much as I have done with Entity \nFramework Core. In this chapter, I show you how to add ASP.NET Core Identity to a \nproject and explain how to consume the ASP.NET Core Identity API to create tools \nto perform basic user and role management. In chapter 39, I show you how to use \nASP.NET Core Identity to authenticate users and perform authorization. Table 38.1 \nputs ASP.NET Core Identity in context.\n1144 chapter  38 Using ASP.NET Core Identity \nTable 38.1    Putting ASP .NET Core Identity in context\nQuestion Answer\nWhat is it? ASP.NET Core Identity is an API for managing users.\nWhy is it useful? Most applications have some features that should not be \navailable to all users. ASP.NET Core Identity provides fea-\ntures to allow users to authenticate themselves and gain \naccess to restricted features.\nHow is it used? ASP.NET Core Identity is added to projects as a package \nand stores its data in a database using Entity Framework \nCore. Management of users is performed through a \nwell-defined API, and its features are applied as attri -\nbutes, as I describe in chapter 39.\nAre there any pitfalls or \nlimitations?ASP.NET Core Identity is complex and provides support for \na wide range of authentication, authorization, and man-\nagement models. It can be difficult to understand all the \noptions, and documentation can be sparse. \nAre there any \nalternatives?There is no sensible alternative to ASP.NET Core Identity if \na project needs to restrict access to features. \nTable 38.2 provides a guide to the chapter.\nTable 38.2    Chapter guide\nProblem Solution Listing\nPreparing the application \nfor IdentityCreate the context class and use it to prepare \na migration that is applied to the database.4–7\nManaging user accounts Use the UserManager<T>  class. 8–12, \n15, 16\nSetting a username and \npassword policyUse the options pattern to configure Identity. 13, 14\nManaging roles Use the RoleManager<T>  class to manage \nthe roles and use the UserManager<T>  \nclass to assign users to roles.17–20\n38.1 Preparing for this chapter\nThis chapter uses the Advanced, DataModel, and BlazorWebAssembly projects from \nchapter 37. If you are using Visual Studio, open the Advanced.sln  file you created in \nthe previous chapter to open all three projects. If you are using Visual Studio Code, \nopen the folder that contains the three projects.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\n 1145 Preparing the project for ASP.NET Core Identity  \nOpen a new PowerShell command prompt, navigate to the folder that contains the \nAdvanced.csproj  file, and run the command shown in listing 38.1 to drop the \ndatabase.\nListing 38.1    Dropping the database\ndotnet ef database drop --force\nUse the PowerShell command prompt to run the command shown in listing 38.2. \nListing 38.2    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000, which will produce the response \nshown in figure 38.1.\nFigure 38.1    \nRunning the \nexample \napplication\n38.2 Preparing the project for ASP .NET Core Identity  \nThe process for setting up ASP.NET Core Identity requires adding a package to the \nproject, configuring the application, and preparing the database. To get started, use \na PowerShell command prompt to run the command shown in listing 38.3 in the \nAdvanced  project folder, which installs the ASP.NET Core Identity package. If you are \nusing Visual Studio, you can install the package by selecting Project > Manage NuGet \nPackages.  \nListing 38.3    Installing ASP .NET Core Identity packages\ndotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore  \n    --version 7.0.0\n1146 chapter  38 Using ASP.NET Core Identity \n38.2.1  Preparing the ASP .NET Core Identity database\nASP.NET Identity requires a database, which is managed through Entity Framework \nCore. To create the Entity Framework Core context class that will provide access to the \nIdentity data, add a class file named IdentityContext.cs  to the Advanced/Models  \nfolder with the code shown in listing 38.4. \nListing 38.4    The IdentityContext.cs File in the Models Folder of the Advanced Project \nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Identity.EntityFrameworkCore;\nusing Microsoft.EntityFrameworkCore;\nnamespace Advanced.Models {\n    public class IdentityContext: IdentityDbContext<IdentityUser> {\n        public IdentityContext(DbContextOptions<IdentityContext> options)\n            : base(options) { }\n    }\n}\nThe ASP.NET Core Identity package includes the IdentityDbContext<T>  class, which \nis used to create an Entity Framework Core context class. The generic type argument T \nis used to specify the class that will represent users in the database. You can create cus-\ntom user classes, but I have used the basic class, called IdentityUser , which provides \nthe core Identity features.\nNOTE     Don’t worry if the classes used in listing 38.4 don’t make sense. If you \nare unfamiliar with Entity Framework Core, then I suggest you treat the class as \na black box. Changes are rarely required once the building blocks for ASP.NET \nCore Identity have been set up, and you can copy the files from this chapter into \nyour own projects.\nconfiguring  the database  connection  string  \nA connection string is required to tell ASP.NET Core Identity where it should store its \ndata. In listing 38.5, I added a connection string to the appsettings.json  file, along-\nside the one used for the application data.\nListing 38.5    Adding a connection in the appsettings.json file in the Advanced project\n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning"",\n      ""Microsoft.EntityFrameworkCore"": ""Information""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""ConnectionStrings"": {\n 1147 Preparing the project for ASP.NET Core Identity  \n    ""PeopleConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=People; \n‰MultipleActiveResultSets=True"",\n    ""IdentityConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=Identity \n‰;MultipleActiveResultSets=True""\n  }\n}\nThe connection string specifies a LocalDB database named Identity . \nNOTE    The width of the printed page doesn’t allow for sensible formatting of the \nconnection string, which must appear in a single unbroken line. When you add \nthe connection string to your own project, make sure that it is on a single line. \n38.2.2  Configuring the application \nThe next step is to configure ASP.NET Core so the Identity database context is set up as \na service, as shown in listing 38.6.  \nListing 38.6    Configuring identity in the Program.cs file in the Advanced project \nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Identity;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddSingleton<Advanced.Services.ToggleService>();\nbuilder.Services.AddDbContext<IdentityContext>(opts =>\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<IdentityContext>();\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");",8984
465-38.3 Creating user management tools.pdf,465-38.3 Creating user management tools,"1148 chapter  38 Using ASP.NET Core Identity \napp.UseBlazorFrameworkFiles(""/webassembly"");\napp.MapFallbackToFile(""/webassembly/{*path:nonfile}"", \n    ""/webassembly/index.html"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\n38.2.3  Creating and applying the Identity database migration \nThe remaining step is to create the Entity Framework Core database migration and \napply it to create the database. Open a new PowerShell window, navigate to the \nAdvanced  project folder, and run the commands shown in listing 38.7.  \nListing 38.7    Creating and applying the database migration \ndotnet ef migrations add --context IdentityContext Initial\ndotnet ef database update --context IdentityContext\nAs I explained in earlier chapters, Entity Framework Core manages changes to data-\nbase schemas through a feature called migrations . Now that there are two database con-\ntext classes in the project, the Entity Framework Core tools require the --context  \nargument to determine which context class is being used. The commands in listing \n38.7 create a migration that contains the ASP.NET Core Identity schema and apply it \nto the database.  \nResetting the ASP .NET Core Identity database\nIf you need to reset the database, run the dotnet ef database drop --force \n--context IdentityContext  command in the Advanced  folder and then run the \ndotnet ef database update --context IdentityContext  command. This \nwill delete the existing database and create a new—and empty—replacement. Do not use \nthese commands on production systems because you will delete user credentials. If you \nneed to reset the main database, then run the dotnet ef database drop --force \n--context DataContext  command, followed by dotnet ef database update \n--context DataContext .\n38.3 Creating user management tools\nIn this section, I am going to create the tools that manage users through ASP.NET \nCore Identity. Users are managed through the UserManager<T>  class, where T is the \nclass chosen to represent users in the database. When I created the Entity Framework \nCore context class, I specified IdentityUser  as the class to represent users in the data-\nbase. This is the built-in class that is provided by ASP.NET Core Identity, and it pro-\nvides the core features that are required by most applications. table 38.3 describes the \nmost useful IdentityUser  properties. (There are additional properties defined by the \n 1149 Creating user management tools\nIdentityUser  class, but these are the ones required by most applications and are the \nones I use in this book.)  \nScaffolding the Identity management tools\nMicrosoft provides a tool that will generate a set of Razor Pages for user management. \nThe tool adds generic content—known as scaffolding —from templates to a project, which \nyou then tailor to the application. I am not a fan of scaffolding or templates, and this is \nnot an exception. The Microsoft Identity templates are well thought out, but they are of \nlimited use because they focus on self-management, allowing users to create accounts, \nchange passwords, and so on, without administrator intervention. You can adapt the \ntemplates to restrict the range of tasks that users perform, but the premise behind the \nfeatures remains the same.  \nIf you are writing the type of application where users manage their own credentials, \nthen the scaffolding option may be worth considering and is described at https://   docs.  \nmicrosoft.com/en-us/aspnet/core/security/authentication/scaffold-identity . For all other \nap proa ches, the user management API provided by ASP.NET Core Identity should be used.\nTable 38.3    Useful IdentityUser properties\nName Description\nId This property contains the unique ID for the user.\nUserName This property returns the user’s username.\nEmail This property contains the user’s e-mail address.\nTable 38.4 describes the UserManagement<T>  members I use in this section to manage \nusers. \nTable 38.4    Useful UserManager<T> members \nName Description\nUsers This property returns a sequence con -\ntaining the users stored in the database.\nFindByIdAsync(id) This method queries the database for the \nuser object with the specified ID.\nCreateAsync(user, password) This method stores a new user in the \ndatabase using the specified password.\nUpdateAsync(user) This method modifies an existing user in \nthe database.\nDeleteAsync(user) This method removes the specified user \nfrom the database.",4576
466-38.3.3 Creating users.pdf,466-38.3.3 Creating users,"1150 chapter  38 Using ASP.NET Core Identity \n38.3.1  Preparing for user management tools\nIn preparation for creating the management tools, add the expressions shown in listing \n38.8 to the _ViewImports.cshtml  file in the Pages  folder of the Advanced project.\nListing 38.8    Adding expressions in the _ViewImports.cshtml file in the Pages folder \nof the Advanced project \n@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers\n@using Advanced.Models\n@using Microsoft.AspNetCore.Mvc.RazorPages\n@using Microsoft.EntityFrameworkCore\n@using System.ComponentModel.DataAnnotations\n@using Microsoft.AspNetCore.Identity\n@using Advanced.Pages\nNext, create the Pages/Users  folder in the Advanced project and add to it a Razor \nLayout named _Layout.cshtml  to the Pages/Users  folder with the content shown in \nlisting 38.9.\nListing 38.9    The _Layout.cshtml file in the Pages/Users folder in the Advanced project\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Identity</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""m-2"">\n        <h5 class=""bg-info text-white text-center p-2"">\n            User Administration\n        </h5>\n        @RenderBody()\n    </div>\n</body>\n</html>\nAdd a class file named AdminPageModel.cs  to the Pages  folder and use it to define \nthe class shown in listing 38.10. \nListing 38.10    The AdminPageModel.cs file in the Pages folder in the Advanced project\nusing Microsoft.AspNetCore.Mvc.RazorPages;\nnamespace Advanced.Pages {\n    public class AdminPageModel : PageModel {\n    }\n}\nThis class will be the base for the page model classes defined in this section. As you \nwill see in chapter 39, a common base class is useful when it comes to securing the \napplication.\n 1151 Creating user management tools\n38.3.2  Enumerating user accounts\nAlthough the database is currently empty, I am going to start by creating a Razor Page \nthat will enumerate user accounts. Add a Razor Page named List.cshtml  to the \nPages/Users  folder in the Advanced project with the content shown in listing 38.11.  \nListing 38.11    The contents of the List.cshtml file in the Pages/Users folder in the \nAdvanced project \n@page\n@model ListModel\n<table class=""table table-sm table-bordered"">\n    <tr><th>ID</th><th>Name</th><th>Email</th><th></th></tr>\n    @if (Model.Users.Count() == 0) {\n        <tr><td colspan=""4"" class=""text-center"">No User Accounts</td></tr>\n    } else {\n        foreach (IdentityUser user in Model.Users) {\n            <tr>\n                <td>@user.Id</td>\n                <td>@user.UserName</td>\n                <td>@user.Email</td>\n                <td class=""text-center"">\n                    <form asp-page=""List"" method=""post"">\n                        <input type=""hidden"" name=""Id"" value=""@user.Id"" />\n                        <a class=""btn btn-sm btn-warning"" \n                            asp-page=""Editor"" asp-route-id=""@user.Id"" \n                            asp-route-mode=""edit"">\n                                Edit\n                        </a>\n                        <button type=""submit"" \n                                class=""btn btn-sm btn-danger"">\n                            Delete\n                        </button>\n                    </form>\n                </td>\n            </tr>\n        }\n    }\n</table>\n<a class=""btn btn-primary"" asp-page=""create"">Create</a>\n@functions {\n    public class ListModel : AdminPageModel {\n        public UserManager<IdentityUser> UserManager;\n        public ListModel(UserManager<IdentityUser> userManager) {\n            UserManager = userManager;\n        }\n        public IEnumerable<IdentityUser> Users { get; set; }\n            = Enumerable.Empty<IdentityUser>();\n1152 chapter  38 Using ASP.NET Core Identity \n        public void OnGet() {\n            Users = UserManager.Users;\n        }\n    }\n}\nThe UserManager<IdentityUser>  class is set up as a service so that it can be consumed \nvia dependency injection. The Users  property returns a collection of Identity  User  \nobjects, which can be used to enumerate the user accounts. This Razor Page displays \nthe users in a table, with buttons that allow each user to be edited or deleted, although \nthis won’t be visible initially because a placeholder message is shown when there are no \nuser objects to display. There is a button that navigates to a Razor Page named Create , \nwhich I define in the next section.\nRestart ASP.NET and request http://localhost:5000/users/list to see the (currently \nempty) data table, which is shown in figure 38.2.\nFigure 38.2    \nEnumerating \nusers\n38.3.3  Creating users\nAdd a Razor Page named Create.cshtml  to the Pages/Users  folder with the content \nshown in listing 38.12.  \nListing 38.12    The Create.cshtml file in the Pages/Users folder of the Advanced project \n@page\n@model CreateModel\n<h5 class=""bg-primary text-white text-center p-2"">Create User</h5>\n<form method=""post"">\n    <div asp-validation-summary=""All"" class=""text-danger""></div>\n    <div class=""form-group"">\n        <label>User Name</label>\n        <input name=""UserName"" class=""form-control""\n               value=""@Model.UserName"" />\n    </div>\n    <div class=""form-group"">\n        <label>Email</label>\n        <input name=""Email"" class=""form-control""\n               value=""@Model.Email"" />\n    </div>\n    <div class=""form-group"">\n 1153 Creating user management tools\n        <label>Password</label>\n        <input name=""Password"" class=""form-control""\n               value=""@Model.Password"" />\n    </div>\n    <div class=""py-2"">\n        <button type=""submit"" class=""btn btn-primary"">Submit</button>\n        <a class=""btn btn-secondary"" asp-page=""list"">Back</a>\n    </div>\n</form>\n@functions {\n    public class CreateModel : AdminPageModel {\n        public UserManager<IdentityUser> UserManager;\n        public CreateModel(UserManager<IdentityUser> usrManager) {\n            UserManager = usrManager;\n        }\n        [BindProperty]\n        public string UserName { get; set; } = string.Empty;\n        [BindProperty]\n        [EmailAddress]\n        public string Email { get; set; } = string.Empty;\n        [BindProperty]\n        public string Password { get; set; } = string.Empty;\n        public async Task<IActionResult> OnPostAsync() {\n            if (ModelState.IsValid) {\n                IdentityUser user =\n                    new IdentityUser { \n                        UserName = UserName, \n                        Email = Email \n                    };\n                IdentityResult result =\n                    await UserManager.CreateAsync(user, Password);\n                if (result.Succeeded) {\n                    return RedirectToPage(""List"");\n                }\n                foreach (IdentityError err in result.Errors) {\n                    ModelState.AddModelError("""", err.Description);\n                }\n            }\n            return Page();\n        }\n    }\n}\nEven though ASP.NET Core Identity data is stored using Entity Framework Core, you \ndon’t work directly with the database context class. Instead, data is managed through \nthe methods provided by the UserManager<T>  class. New users are created using the \nCreateAsync  method, which accepts an IdentityUser  object and a password string \nas arguments.\n1154 chapter  38 Using ASP.NET Core Identity \nThis Razor Page defines three properties that are subject to model binding. The \nUserName  and Email  properties are used to configure the IdentityUser  object, which \nis combined with the value bound to the Password  property to call the CreateAsync  \nmethod. These properties are configured with validation attributes, and values will be \nrequired because the property types are non-nullable.\nThe result of the CreateAsync  method is a Task<IdentityResult>  object, which \nindicates the outcome of the create operation, using the properties described in table \n38.5.  \nTable 38.5    The properties defined by the IdentityResult class\nName Description\nSucceeded Returns true  if the operation succeeded.\nErrors Returns a sequence of IdentityError  objects that \ndescribe the errors encountered while attempting the \noperation. Each IdentityError  object provides a \nDescription  property that summarizes the problem.\nI inspect the Succeeded  property to determine whether a new user has been created \nin the database. If the Succeeded  property is true , then the client is redirected to the \nList  page so that the list of users is displayed, reflecting the new addition.\n...\nif (result.Succeeded) {\n    return RedirectToPage(""List"");\n}\nforeach (IdentityError err in result.Errors) {\n    ModelState.AddModelError("""", err.Description);\n}\n...\nIf the Succeeded  property is false , then the sequence of IdentityError  objects pro-\nvided by the Errors  property is enumerated, with the Description  property used to \ncreate a model-level validation error using the ModelState.AddModelError  method.\nTo test the ability to create a new user account, restart ASP.NET Core and request \nhttp://localhost:5000/users/list. Click the Create button and fill in the form with the \nvalues shown in table 38.6. \nTIP    There are domains reserved for testing, including example.com . You can \nsee a complete list at https://tools.ietf.org/html/rfc2606 .\nTable 38.6    The values for creating an example user\nField Description\nName Joe\nEmail joe@example.com\nPassword Secret123$\n 1155 Creating user management tools\nOnce you have entered the values, click the Submit button. ASP.NET Core Identity will \ncreate the user in the database, and the browser will be redirected, as shown in figure \n38.3. (You will see a different ID value because IDs are randomly generated for each \nuser.)\nNOTE     I used a regular input  element for the Password  field to make it easier \nto follow the examples in this chapter. For real projects, it is a good idea to set \nthe input  element’s type  attribute to password  so that the characters entered \ncannot be seen.\nFigure 38.3    Creating a new user  \nClick the Create button again and enter the same details into the form, using the \nvalues in table 38.6. This time you will see an error reported through the model \nvalidation summary when you click the Create button, as shown in figure 38.4. This \nis an example of an error returned through the IdentityResult  object produced by \nthe CreateAsync  method.\nFigure 38.4    \nAn error when \ncreating a new \nuser\nvalidating  passwords\nOne of the most common requirements, especially for corporate applications, is to \nenforce a password policy. You can see the default policy by navigating to http://\nlocalhost:5000/Users/Create and filling out the form with the data shown in table \n38.7.  \n1156 chapter  38 Using ASP.NET Core Identity \nTable 38.7    The values for creating an example user\nField Description\nName Alice\nEmail alice@example.com\nPassword secret\nWhen you submit the form, ASP.NET Core Identity checks the candidate password and \ngenerates errors if it doesn’t match the password, as shown in figure 38.5.\nFigure 38.5    \nPassword \nvalidation \nerrors\nThe password validation rules are configured using the options pattern, as shown in \nlisting 38.13.\nListing 38.13    Configuring validation in the Program.cs file in the Advanced project\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Identity;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddSingleton<Advanced.Services.ToggleService>();\nbuilder.Services.AddDbContext<IdentityContext>(opts =>\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<IdentityContext>();\n 1157 Creating user management tools\nbuilder.Services.Configure<IdentityOptions>(opts => {\n    opts.Password.RequiredLength = 6;\n    opts.Password.RequireNonAlphanumeric = false;\n    opts.Password.RequireLowercase = false;\n    opts.Password.RequireUppercase = false;\n    opts.Password.RequireDigit = false;\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");\napp.UseBlazorFrameworkFiles(""/webassembly"");\napp.MapFallbackToFile(""/webassembly/{*path:nonfile}"",\n     ""/webassembly/index.html"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nASP.NET Core Identity is configured using the IdentityOptions  class, whose Password  \nproperty returns a PasswordOptions  class that configures password validation using the \nproperties described in table 38.8.  \nTable 38.8    The PasswordOptions properties\nName Description\nRequiredLength This int property is used to specify the mini-\nmum length for passwords.\nRequireNonAlphanumeric Setting this bool  property to true  requires \npasswords to contain at least one character \nthat is not a letter or a digit.\nRequireLowercase Setting this bool  property to true  requires \npasswords to contain at least one lowercase \ncharacter.\nRequireUppercase Setting this bool  property to true  requires \npasswords to contain at least one uppercase \ncharacter.\nRequireDigit Setting this bool  property to true  requires \npasswords to contain at least one numeric \ncharacter.\nIn the listing, I specified that passwords must have a minimum length of six characters \nand disabled the other constraints. This isn’t something that you should do without \n1158 chapter  38 Using ASP.NET Core Identity \ncareful consideration in a real project, but it allows for an effective demonstration. \nRestart ASP.NET Core, request http://localhost:5000/users/create, and fill out the \nform using the details from table 38.7. When you click the Submit button, the pass-\nword will be accepted by the new validation rules, and a new user will be created, as \nshown in figure 38.6.\nFigure 38.6    Changing the password validation rules\nvalidating  user details\nValidation is also performed on usernames and e-mail addresses when accounts are \ncreated. To see how validation is applied, request http://localhost:5000/users/create \nand fill out the form using the values shown in table 38.9.  \nTable 38.9    The values for creating an example user\nField Description\nName Bob!\nEmail alice@example.com\nPassword secret\nClick the Submit button, and you will see the error message shown in figure 38.7.\nFigure 38.7     \nA user details \nvalidation error\n 1159 Creating user management tools\nValidation can be configured with the options pattern, using the User  property defined \nby the IdentityOptions  class. This class returns a UserOptions  class, whose proper-\nties are described in table 38.10.  \nTable 38.10    The UserOptions properties\nName Description\nAllowedUserNameCharacters This string  property contains all the legal char-\nacters that can be used in a username. The default \nvalue specifies a–z, A–Z, and 0–9 and the hyphen, \nperiod, underscore, and @ characters. This property \nis not a regular expression, and every legal character \nmust be specified explicitly in the string.\nRequireUniqueEmail Setting this bool  property to true  requires new \naccounts to specify e-mail addresses that have not \nbeen used previously.\nIn listing 38.14, I have changed the configuration of the application so that unique \ne-mail addresses are required and so that only lowercase alphabetic characters are \nallowed in usernames.\nListing 38.14    Changing validation in the Program.cs file in the Advanced project\n...\nbuilder.Services.Configure<IdentityOptions>(opts => {\n    opts.Password.RequiredLength = 6;\n    opts.Password.RequireNonAlphanumeric = false;\n    opts.Password.RequireLowercase = false;\n    opts.Password.RequireUppercase = false;\n    opts.Password.RequireDigit = false;\n    opts.User.RequireUniqueEmail = true;\n    opts.User.AllowedUserNameCharacters = ""abcdefghijklmnopqrstuvwxyz"";\n});\n...\nRestart ASP.NET Core, request http://localhost:5000/users/create, and fill out the \nform with the values in table 38.9. Click the Submit button, and you will see that the \ne-mail address now causes an error. The username still contains illegal characters and \nis also flagged as an error, as shown in figure 38.8.\nFigure 38.8    \nValidating user \ndetail",16993
467-38.3.4 Editing users.pdf,467-38.3.4 Editing users,"1160 chapter  38 Using ASP.NET Core Identity \n38.3.4  Editing users\nTo add support for editing users, add a Razor Page named Editor.cshtml  to the \nPages/Users  folder of the Advanced project with the content shown in listing 38.15.  \nListing 38.15    The Editor.cshtml file in the Pages/Users folder of the Advanced project \n@page ""{id}""\n@model EditorModel\n<h5 class=""bg-warning text-white text-center p-2"">Edit User</h5>\n<form method=""post"">\n    <div asp-validation-summary=""All"" class=""text-danger""></div>\n    <div class=""form-group"">\n        <label>ID</label>\n        <input name=""Id"" class=""form-control"" value=""@Model.Id"" \n            disabled />\n        <input name=""Id"" type=""hidden"" value=""@Model.Id"" />\n    </div>\n    <div class=""form-group"">\n        <label>User Name</label>\n        <input name=""UserName"" class=""form-control"" \n            value=""@Model.UserName"" />\n    </div>\n    <div class=""form-group"">\n        <label>Email</label>\n        <input name=""Email"" class=""form-control"" value=""@Model.Email"" />\n    </div>\n    <div class=""form-group"">\n        <label>New Password</label>\n        <input name=""Password"" class=""form-control"" \n            value=""@Model.Password"" />\n    </div>\n    <div class=""py-2"">\n        <button type=""submit"" class=""btn btn-warning"">Submit</button>\n        <a class=""btn btn-secondary"" asp-page=""list"">Back</a>\n    </div>\n</form>\n@functions {\n    public class EditorModel : AdminPageModel {\n        public UserManager<IdentityUser> UserManager;\n        public EditorModel(UserManager<IdentityUser> usrManager) {\n            UserManager = usrManager;\n        }\n        [BindProperty]\n        public string Id { get; set; } = string.Empty;\n        [BindProperty]\n        public string UserName { get; set; } = string.Empty;\n        [BindProperty]\n 1161 Creating user management tools\n        [EmailAddress]\n        public string Email { get; set; } = string.Empty;\n        [BindProperty]\n        public string? Password { get; set; }\n        public async Task OnGetAsync(string id) {\n            IdentityUser? user = await UserManager.FindByIdAsync(id);\n            if (user != null) {\n                Id = user.Id; \n                UserName = user.UserName ?? string.Empty; \n                Email = user.Email ?? string.Empty;\n            }\n        }\n        public async Task<IActionResult> OnPostAsync() {\n            if (ModelState.IsValid) {\n                IdentityUser? user = await UserManager.FindByIdAsync(Id);\n                if (user != null) {\n                    user.UserName = UserName;\n                    user.Email = Email;\n                \n                    IdentityResult result = \n                        await UserManager.UpdateAsync(user);\n                    if (result.Succeeded \n                            && !String.IsNullOrEmpty(Password)) {\n                        await UserManager.RemovePasswordAsync(user);\n                        result = await UserManager.AddPasswordAsync(user, \n                            Password);\n                    }\n                    if (result.Succeeded) {\n                        return RedirectToPage(""List"");\n                    }\n                    foreach (IdentityError err in result.Errors) {\n                        ModelState.AddModelError("""", err.Description);\n                    }\n                }\n            }\n            return Page();\n        }\n    }\n}\nThe Editor  page uses the UserManager<T>.FindByIdAsync  method to locate the \nuser, querying the database with the id value received through the routing system and \nreceived as an argument to the OnGetAsync  method. The values from the Identity -\nUser  object returned by the query are used to populate the properties that are dis-\nplayed by the view part of the page, ensuring that the values are not lost if the page is \nredisplayed due to validation errors.\nWhen the user submits the form, the FindByIdAsync  method is used to query the \ndatabase for the IdentityUser  object, which is updated with the UserName  and Email  \nvalues provided in the form. Passwords require a different approach and must be \nremoved from the user object before a new password is assigned, like this:",4256
468-38.4 Creating role management tools.pdf,468-38.4 Creating role management tools,"1162 chapter  38 Using ASP.NET Core Identity \n...\nawait UserManager. RemovePasswordAsync (user);\nresult = await UserManager. AddPasswordAsync (user, Password);\n...\nThe Editor  page changes the password only if the form contains a Password  value \nand if the updates for the UserName and Email fields have been successful. Errors \nfrom ASP.NET Core Identity are presented as validation messages, and the browser is \nredirected to the List  page after a successful update. Request http://localhost:5000/\nUsers/List, click the Edit button for Joe, and change the UserName field to bob, with \nall lowercase characters. Click the Submit button, and you will see the change reflected \nin the list of users, as shown in figure 38.9.\nNOTE    You will see an error if you click the Edit button for the Alice account \nand click Submit without making changes. This is because the account was cre-\nated before the validation policy was changed. ASP.NET Core Identity applies \nvalidation checks for updates, leading to the odd situation where the data in the \ndatabase can be read—and used—but cannot be updated.\nFigure 38.9   \nEditing a user\n38.3.5  Deleting users\nThe last feature I need for my basic user management application is the ability to \ndelete users, as shown in listing 38.16.  \nListing 38.16    Deleting users in the List.cshtml file in the Pages/Users folder in the \nAdvanced project \n...\n@functions {\n    public class ListModel : AdminPageModel {\n        public UserManager<IdentityUser> UserManager;\n        public ListModel(UserManager<IdentityUser> userManager) {\n            UserManager = userManager;\n 1163 Creating role management tools\n        }\n        public IEnumerable<IdentityUser> Users { get; set; }\n            = Enumerable.Empty<IdentityUser>();\n        public void OnGet() {\n            Users = UserManager.Users;\n        }\n        public async Task<IActionResult> OnPostAsync(string id) {\n            IdentityUser? user = await UserManager.FindByIdAsync(id);\n            if (user != null) {\n                await UserManager.DeleteAsync(user);\n            }\n            return RedirectToPage();\n        }\n    }\n}\n...\nThe List  page already displays a Delete button for each user in the data table, which \nsubmits a POST request containing the Id value for the IdentityUser  object to be \nremoved. The OnPostAsync  method receives the Id value and uses it to query Iden-\ntity using the FindByIdAsync  method, passing the object that is returned to the  \nDeleteAsync  method, which deletes it from the database. To check the delete func-\ntionality, request http://localhost:5000/Users/List and click Delete for the Alice  \naccount. The user object will be removed, as shown in figure 38.10.\nFigure 38.10    Deleting a user \n38.4 Creating role management tools\nSome applications enforce only two levels of authorization: authenticated users are \nallowed access to all the application’s features, while unauthenticated users have less—\nor no—access. The SportsStore application in part 1 followed this approach: there \nwas one user, and once authenticated, they had access to all the application’s features, \nincluding administration tools, while unauthenticated users were restricted to the pub-\nlic store features.\nASP.NET Core Identity supports roles for applications that require more granular \nauthorization. Users are assigned to one or more roles, and their membership of those \nroles determines which features are accessible. In the sections that follow, I show you \nhow to build tools to create and manage roles.\n1164 chapter  38 Using ASP.NET Core Identity \nRoles are managed through the RoleManager<T>  class, where T is the representa-\ntion of roles in the database. When I configured ASP.NET Core Identity at the start of \nthe chapter, I selected IdentityRole , which is the built-in class that Identity provides \nto describe a role, which means that I will be using the RoleManager<IdentityRole>  \nclass in these examples. The RoleManager<T>  class defines the methods and properties \nshown in table 38.11 that allow roles to be created and managed.  \nTable 38.11    The members defined by the RoleManager<T> class\nName Description\nCreateAsync(role) Creates a new role\nDeleteAsync(role) Deletes the specified role\nFindByIdAsync(id) Finds a role by its ID\nFindByNameAsync(name) Finds a role by its name\nRoleExistsAsync(name) Returns true  if a role with the specified name \nexists\nUpdateAsync(role) Stores changes to the specified role\nRoles Returns an enumeration of the roles that have \nbeen defined\nTable 38.12 describes the key properties defined by the IdentityRole  class.\nTable 38.12    Useful IdentityRole properties\nName Description\nId This property contains the unique ID for the role.\nName This property returns the role name.\nAlthough roles are managed through the RoleManager<T>  class, membership of roles \nis managed through the methods provided by UserManager<T>  described in table \n38.13.  \nTable 38.13    The UserManager<T> methods for managing role membership\nName Description\nAddToRoleAsync(user, role) This method adds a user to a role.\nRemoveFromRoleAsync(user, role) This method removes a user from a role.\nGetRolesAsync(user) This method returns the roles for which the \nuser is a member.\nGetUsersInRoleAsync(role) This method returns users who are members \nof the specified role.\nIsInRoleAsync(user, role) This method returns true  if the user is a \nmember of the specified role.",5537
469-38.4.1 Preparing for role management tools.pdf,469-38.4.1 Preparing for role management tools,,0
470-38.4.2 Enumerating and deleting roles.pdf,470-38.4.2 Enumerating and deleting roles,"1165 Creating role management tools\n38.4.1  Preparing for role management tools\nTo prepare for the role management tools, create the Pages/Roles  folder in the \nAdvanced project and add to it a Razor Layout named _Layout.cshtml  with the con-\ntent shown in listing 38.17.\nListing 38.17    The _Layout.cshtml file in the Pages/Roles folder in the Advanced project \n<!DOCTYPE html>\n<html>\n<head>\n    <title>Identity</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>\n    <div class=""m-2"">\n        <h5 class=""bg-secondary text-white text-center p-2"">\n            Role Administration\n        </h5>\n        @RenderBody()\n    </div>\n</body>\n</html>\nThis layout will ensure there is an obvious difference between the user and role man-\nagement tools. \n38.4.2  Enumerating and deleting roles\nAdd a Razor Page named List.cshtml  to the Pages/Roles  folder in the Advanced \nproject with the content shown in listing 38.18.  \nListing 38.18    The List.cshtml file in the Pages/Roles folder in the Advanced project \n@page\n@model ListModel\n<table class=""table table-sm table-bordered"">\n    <tr><th>ID</th><th>Name</th><th>Members</th><th></th></tr>\n    @if (Model.Roles.Count() == 0) {\n        <tr><td colspan=""4"" class=""text-center"">No Roles</td></tr>\n    } else {\n        foreach (IdentityRole role in Model.Roles) {\n            <tr>\n                <td>@role.Id</td>\n                <td>@role.Name</td>\n                <td>@(await Model.GetMembersString(role.Name))</td>\n                <td class=""text-center"">\n                    <form asp-page=""List"" method=""post"">\n                        <input type=""hidden"" name=""Id"" value=""@role.Id"" />\n                        <a class=""btn btn-sm btn-warning"" \n                            asp-page=""Editor""\n                            asp-route-id=""@role.Id"" \n                            asp-route-mode=""edit"">Edit</a>\n1166 chapter  38 Using ASP.NET Core Identity \n                        <button type=""submit"" \n                                class=""btn btn-sm btn-danger"">\n                            Delete\n                        </button>\n                    </form>\n                </td>\n            </tr>\n        }\n    }\n</table>\n<a class=""btn btn-primary"" asp-page=""create"">Create</a>\n@functions {\n    public class ListModel : AdminPageModel {\n        public UserManager<IdentityUser> UserManager;\n        public RoleManager<IdentityRole> RoleManager;\n        public ListModel(UserManager<IdentityUser> userManager,\n                RoleManager<IdentityRole> roleManager) {\n            UserManager = userManager;\n            RoleManager = roleManager;\n        }\n        public IEnumerable<IdentityRole> Roles { get; set; }\n            = Enumerable.Empty<IdentityRole>();\n        public void OnGet() {\n            Roles = RoleManager.Roles;\n        }\n        public async Task<string> GetMembersString(string? role) {\n        IEnumerable<IdentityUser> users\n                = (await UserManager.GetUsersInRoleAsync(role!));\n            string result = users.Count() == 0\n                ? ""No members""\n                : string.Join("", "", \n                    users.Take(3).Select(u => u.UserName).ToArray());\n            return users.Count() > 3 \n                ? $""{result}, (plus others)"" : result;\n        }\n        public async Task<IActionResult> OnPostAsync(string id) {\n            IdentityRole? role = await RoleManager.FindByIdAsync(id);\n            if (role != null) {\n                await RoleManager.DeleteAsync(role);\n            }\n            return RedirectToPage();\n        }\n    }\n}\nThe roles are enumerated, along with the names of up to three of the role members \nor a placeholder message if there are no members. There is also a Create button, and",3845
471-38.4.4 Assigning role membership.pdf,471-38.4.4 Assigning role membership,"1167 Creating role management tools\neach role is presented with Edit and Delete buttons, following the same pattern I used \nfor the user management tools.\nThe Delete button sends a POST request back to the Razor Page. The OnPostAsync  \nmethod uses the FindByIdAsync  method to retrieve the role object, which is passed to \nthe DeleteAsync  method to remove it from the database. \n38.4.3  Creating roles\nAdd a Razor Page named Create.cshtml  in the Pages/Roles  folder in the Advanced \nproject with the contents shown in listing 38.19.  \nListing 38.19    The Create.cshtml file in the Pages/Roles folder in the Advanced project\n@page\n@model CreateModel\n<h5 class=""bg-primary text-white text-center p-2"">Create Role</h5>\n<form method=""post"">\n    <div asp-validation-summary=""All"" class=""text-danger""></div>\n    <div class=""form-group"">\n        <label>Role Name</label>\n        <input name=""Name"" class=""form-control"" value=""@Model.Name"" />\n    </div>\n    <div class=""py-2"">\n        <button type=""submit"" class=""btn btn-primary"">Submit</button>\n        <a class=""btn btn-secondary"" asp-page=""list"">Back</a>\n    </div>\n</form>\n@functions {\n    public class CreateModel : AdminPageModel {\n        public RoleManager<IdentityRole> RoleManager;\n        public CreateModel(UserManager<IdentityUser> userManager,\n                RoleManager<IdentityRole> roleManager) {\n            RoleManager = roleManager;\n        }\n        [BindProperty]\n        public string Name { get; set; } = string.Empty;\n        public async Task<IActionResult> OnPostAsync() {\n            if (ModelState.IsValid) {\n                IdentityRole role = \n                    new IdentityRole { Name = Name };\n                IdentityResult result = \n                    await RoleManager.CreateAsync(role);\n                if (result.Succeeded) {\n                    return RedirectToPage(""List"");\n                }\n                foreach (IdentityError err in result.Errors) {\n                    ModelState.AddModelError("""", err.Description);\n1168 chapter  38 Using ASP.NET Core Identity \n                }\n            }\n            return Page();\n        }\n    }\n}\nThe user is presented with a form containing an input  element to specify the name \nof the new role. When the form is submitted, the OnPostAsync  method creates a new \nIdentityRole  object and passes it to the CreateAsync  method.\n38.4.4  Assigning role membership\nTo add support for managing role memberships, add a Razor Page named Editor \n.cshtml  to the Pages/Roles  folder in the Advanced project, with the content shown \nin listing 38.20.  \nListing 38.20    The Editor.cshtml file in the Pages/Roles folder in the Advanced project \n@page ""{id}""\n@model EditorModel\n<h5 class=""bg-primary text-white text-center p-2"">\n    Edit Role: @Model.Role?.Name\n</h5>\n<form method=""post"">\n    <input type=""hidden"" name=""rolename"" value=""@Model.Role?.Name"" />\n    <div asp-validation-summary=""All"" class=""text-danger""></div>\n    <h5 class=""bg-secondary text-white p-2"">Members</h5>\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>User</th><th>Email</th><th></th></tr></thead>\n        <tbody>\n            @if ((await Model.Members()).Count() == 0) {\n                <tr>\n                    <td colspan=""3"" class=""text-center"">No members</td>\n                </tr>\n            }\n            @foreach (IdentityUser user in await Model.Members()) {\n                <tr>\n                    <td>@user.UserName</td>\n                    <td>@user.Email</td>\n                    <td>\n                        <button asp-route-userid=""@user.Id""\n                            class=""btn btn-primary btn-sm"" type=""submit"">\n                            Change\n                        </button>\n                    </td>\n                </tr>\n            }\n        </tbody>\n    </table>\n    <h5 class=""bg-secondary text-white p-2"">Non-Members</h5>\n 1169 Creating role management tools\n    <table class=""table table-sm table-striped table-bordered"">\n        <thead><tr><th>User</th><th>Email</th><th></th></tr></thead>\n        <tbody>\n            @if ((await Model.NonMembers()).Count() == 0) {\n                <tr>\n                    <td colspan=""3"" class=""text-center"">\n                        No non-members\n                    </td>\n                </tr>\n            }\n            @foreach (IdentityUser user in await Model.NonMembers()) {\n                <tr>\n                    <td>@user.UserName</td>\n                    <td>@user.Email</td>\n                    <td>\n                        <button asp-route-userid=""@user.Id""\n                            class=""btn btn-primary btn-sm"" type=""submit"">\n                            Change\n                        </button>\n                    </td>\n                </tr>\n            }\n        </tbody>\n    </table>\n</form>\n<a class=""btn btn-secondary"" asp-page=""list"">Back</a>\n@functions {\n    public class EditorModel : AdminPageModel {\n        public UserManager<IdentityUser> UserManager;\n        public RoleManager<IdentityRole> RoleManager;\n        public EditorModel(UserManager<IdentityUser> userManager,\n                RoleManager<IdentityRole> roleManager) {\n            UserManager = userManager;\n            RoleManager = roleManager;\n        }\n        public IdentityRole? Role { get; set; } = new();\n        public Task<IList<IdentityUser>> Members() {\n            if (Role?.Name != null) {\n                return UserManager.GetUsersInRoleAsync(Role.Name);\n            }\n            \n            return Task.FromResult(new List<IdentityUser>() \n                as IList<IdentityUser>);\n        }\n        public async Task<IEnumerable<IdentityUser>> NonMembers() =>\n                UserManager.Users.ToList().Except(await Members());\n        public async Task OnGetAsync(string id) {\n1170 chapter  38 Using ASP.NET Core Identity \n            Role = await RoleManager.FindByIdAsync(id);\n        }\n        public async Task<IActionResult> OnPostAsync(string userid,\n                string rolename) {\n            Role = await RoleManager.FindByNameAsync(rolename);\n            IdentityUser? user = await UserManager.FindByIdAsync(userid);\n            if (user != null) {\n                IdentityResult result;\n                if (await UserManager.IsInRoleAsync(user, rolename)) {\n                    result = await UserManager.RemoveFromRoleAsync(user, \n                        rolename);\n                } else {\n                    result = \n                        await UserManager.AddToRoleAsync(user, rolename);\n                }\n                if (result.Succeeded) {\n                    return RedirectToPage();\n                } else {\n                    foreach (IdentityError err in result.Errors) {\n                        ModelState.AddModelError("""", err.Description);\n                    }\n                    return Page();\n                }\n            }\n            return Page();\n        }\n    }\n}\nThe user is presented with a table showing the users who are members of the role and \nwith a table showing nonmembers. Each row contains a Change button that submits \nthe form. The OnPostAsync  method uses the UserManager.FindByIdAsync  method \nto retrieve the user object from the database. The IsInRoleAsync  method is used to \ndetermine whether the user is a member of the role, and the AddToRoleAsync  and \nRemoveFromRoleAsync  methods are used to add and remove the user, respectively.\nRestart ASP.NET Core and request http://localhost:5000/roles/list. The list will \nbe empty because there are no roles in the database. Click the Create button, enter \nAdmins into the text field, and click the Submit button to create a new role. Once the \nrole has been created, click the Edit button, and you will see the list of users who can be \nadded to the role. Clicking the Change button will move the user in and out of the role. \nClick back, and the list will be updated to show the users who are members of the role, \nas shown in figure 38.11.\nCAUTION    ASP.NET Core Identity revalidates user details when changing role \nassignments, which will result in an error if you try to modify a user whose details \ndo not match the current restrictions, which happens when restrictions are intro-\nduced after the application has been deployed and the database is already pop-\nulated with users created under the old roles. It is for this reason that the Razor \nPage in listing 38.20 checks the result from the operations to add or remove \nusers from a role and displays any errors as validation messages. \n 1171 Creating role management tools\nFigure 38.11    Managing roles\nSummary\n¡ The ASP.NET Core Identity framework is used to authenticate users.\n¡ User data can be stored in an relational database, but there are other authenti-\ncation mechanisms available, although some of them can be complex to set up.\n¡ User identities are managed and authenticated using the UserManager<T>  class, \nwhere T is the class used to represent users in the application.\n¡ Roles are managed and applied using the RoleManager<T>  class, where T is the \nclass used to represent roles in the application. \n¡ Account administration tools can be created using the standard ASP.NET Core \nfeatures.",9407
472-39.2.1 Creating the login feature.pdf,472-39.2.1 Creating the login feature,"117239Applying ASP.NET  \nCore Identity\nThis chapter covers\n¡ Authenticating users with ASP.NET Core Identity \n¡ Implementing and enforcing an authorization  \n policy\n¡ Using bearer tokens instead of authentication  \n cookies for web services or JavaScript clients\nIn this chapter, I explain how ASP.NET Core Identity is applied to authenticate \nusers and authorize access to application features. I create the features required for \nusers to establish their identity, explain how access to endpoints can be controlled, \nand demonstrate the security features that Blazor provides. I also show two different \nways to authenticate web service clients. Table 39.1 provides a guide to the chapter. \n 1173 Preparing for this chapter\nTable 39.1    Chapter guide\nProblem Solution Listing\nAuthenticating \nusersUse the SignInManager<T>  \nclass to validate the creden-\ntials users provide and use the \nbuilt-in middleware to trigger \nauthentication. 3–8\nRestricting access \nto endpointsUse the Authorize  attribute and \nthe built-in middleware to control \naccess.9–13\nRestricting \naccess to Blazor \ncomponentsUse the Authorize  attribute and \nthe built-in Razor Components to \ncontrol access.14–17\nRestricting access \nto web servicesUse cookie authentication or \nbearer tokens.18–30\n39.1 Preparing for this chapter\nThis chapter uses the projects from chapter 38. To prepare for this chapter, I am going \nto reset both the application data and ASP.NET Core Identity databases and create \nnew users and roles. Open a new command prompt and run the commands shown in \nlisting 39.1 in the Advanced  project folder, which contains the Advanced.csproj  file. \nThese commands remove the existing databases and re-create them.\nTIP    You can download the example project for this chapter—and for all the \nother chapters in this book—from https://github.com/manningbooks/pro-asp \n.net-core-7 . See chapter 1 for how to get help if you have problems running the \nexamples.\nListing 39.1    Re-creating the project databases\ndotnet ef database drop --force --context DataContext\ndotnet ef database drop --force --context IdentityContext\ndotnet ef database update --context DataContext\ndotnet ef database update --context IdentityContext\nNow that the application contains multiple database context classes, the Entity Frame-\nwork Core commands require the --context  argument to select the context that a \ncommand applies to. Use the PowerShell command prompt to run the command \nshown in listing 39.2. \nListing 39.2    Running the example application \ndotnet run\nUse a browser to request http://localhost:5000/controllers, which will produce the \nresponse shown in figure 39.1. \n1174 chapter  39 Applying ASP.NET Core Identity \nFigure 39.1    \nRunning the \nexample \napplication\nThe main application database is automatically reseeded when the application starts. \nThere is no seed data for the ASP.NET Core Identity database. Request http://\nlocalhost:5000/users/list and http://localhost:5000/roles/list, and you will see the \nresponses in figure 39.2, which show the database is empty.\nFigure 39.2    The empty ASP .NET Core Identity database\n39.2 Authenticating users\nIn the sections that follow, I show you how to add authentication features to the exam-\nple project so that users can present their credentials and establish their identity to the \napplication.  \nAuthentication vs. authorization \nIt is important to understand the difference between authentication and authorization \nwhen working with ASP.NET Core Identity. Authentication , often referred to as AuthN , is \nthe process of establishing the identity of a user, which the user does by presenting their \ncredentials to the application. In the case of the example application, those credentials \nare a username and a password. The username is public information, but the password \n 1175 Authenticating users\n(continued)\nis known only by the user, and when the correct password is presented, the application is \nable to authenticate the user.  \nAuthorization , often referred to as AuthZ , is the process of granting access to application \nfeatures based on a user’s identity. Authorization can be performed only when a user \nhas been authenticated because an application has to know the identity of a user before \ndeciding whether they are entitled to use a specific feature.\n39.2.1  Creating the login feature\nTo enforce a security policy, the application must allow users to authenticate them-\nselves, which is done using the ASP.NET Core Identity API. Create the Pages/Account  \nfolder and add to it a Razor layout named _Layout.cshtml  with the content shown in \nlisting 39.3. This layout will provide common content for authentication features.  \nListing 39.3    The _Layout.cshtml file in the Pages/Account folder in the Advanced \nproject \n<!DOCTYPE html>\n<html>\n<head>\n    <title>Identity</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n</head>\n<body>    \n    <div class=""m-2"">\n        @RenderBody()\n    </div>\n</body>\n</html>\nAdd a Razor Page named Login.cshtml  to the Pages/Account  folder in the Advanced \nproject with the content shown in listing 39.4.\nListing 39.4    The Login.cshtml file in the Pages/Account folder of the Advanced project \n@page\n@model LoginModel\n<div class=""bg-primary text-center text-white p-2""><h4>Log In</h4></div>\n<div class=""m-1 text-danger"" asp-validation-summary=""All""></div>\n<form method=""post"">\n    <input type=""hidden"" name=""returnUrl"" value=""@Model.ReturnUrl"" />\n    <div class=""form-group"">\n        <label>UserName</label>\n        <input class=""form-control"" asp-for=""UserName"" />\n    </div>\n    <div class=""form-group"">\n1176 chapter  39 Applying ASP.NET Core Identity \n        <label>Password</label>\n        <input asp-for=""Password"" type=""password"" class=""form-control"" />\n    </div>\n    <button class=""btn btn-primary mt-2"" type=""submit"">Log In</button>\n</form>\n@functions {\n    public class LoginModel : PageModel {\n        private SignInManager<IdentityUser> signInManager;\n        public LoginModel(SignInManager<IdentityUser> signinMgr) {\n            signInManager = signinMgr;\n        }\n        [BindProperty]\n        public string UserName { get; set; } = string.Empty;\n        [BindProperty]\n        public string Password { get; set; } = string.Empty;\n        [BindProperty(SupportsGet = true)]\n        public string? ReturnUrl { get; set; }\n        public async Task<IActionResult> OnPostAsync() {\n            if (ModelState.IsValid) {\n                Microsoft.AspNetCore.Identity.SignInResult result =\n                    await signInManager.PasswordSignInAsync(UserName, \n                        Password, false, false);\n                if (result.Succeeded) {\n                    return Redirect(ReturnUrl ?? ""/"");\n                }\n                ModelState.AddModelError("""", \n                    ""Invalid username or password"");\n            }\n            return Page();\n        }\n    }\n}\nASP.NET Core Identity provides the SigninManager<T>  class to manage logins, where \nthe generic type argument T is the class that represents users in the application, which \nis IdentityUser  for the example application. Table 39.2 describes the Signin-\nManager<T>  members I use in this chapter.  \nTable 39.2    Useful SigninManager<T> members\nName Description\nPasswordSignInAsync(name, \npassword, persist, lockout)This method attempts authentication using the specified \nusername and password. The  persist  argument deter-\nmines whether a successful authentication produces \na cookie that persists after the browser is closed. The \nlockout  argument determines whether the account \nshould be locked if authentication fails.\nSignOutAsync() This method signs out the user.",7869
473-39.2.4 Testing the authentication feature.pdf,473-39.2.4 Testing the authentication feature,"1177 Authenticating users\nThe Razor Page presents the user with a form that collects a username and a password, \nwhich are used to perform authentication with the PasswordSignInAsync  method, \nlike this:\n...\nMicrosoft.AspNetCore.Identity.SignInResult result =\n    await signInManager. PasswordSignInAsync (UserName,  \n        Password, false, false);\n...\nThe result from the PasswordSignInAsync  methods is a SignInResult  object, which \ndefines a Suceeded  property that is true  if the authentication is successful. (There is \nalso a SignInResult  class defined in the Microsoft.AspNetCore.Mvc  namespace, \nwhich is why I used a fully qualified class name in the listing.)\nAuthentication in an ASP.NET Core application is usually triggered when the user \ntries to access an endpoint that requires authorization, and it is convention to return \nthe user to that endpoint if authentication is successful, which is why the Login  page \ndefines a ReturnUrl  property that is used in a redirection if the user has provided valid \ncredentials.\n...\nif (result.Succeeded) {\n    return Redirect( ReturnUrl  ?? ""/"");\n}\n...\nIf the user hasn’t provided valid credentials, then a validation message is shown, and \nthe page is redisplayed.\nProtecting the authentication cookie\nThe authentication cookie contains the user’s identity, and ASP.NET Core trusts that \nrequests containing the cookie originate from the authenticated user. This means you \nshould use HTTPS for production applications that use ASP.NET Core Identity to prevent \nthe cookie from being intercepted by an intermediary. See part 2 for details of enabling \nHTTPS in ASP.NET Core.\n39.2.2  Inspecting the ASP .NET Core Identity cookie\nWhen a user is authenticated, a cookie is added to the response so that subsequent \nrequests can be identified as being already authenticated. Add a Razor Page named \nDetails.cshtml  to the Pages/Account  folder of the Advanced project with the con-\ntent shown in listing 39.5, which displays the cookie when it is present.  \nListing 39.5    The Details.cshtml file in the Pages/Account folder of the Advanced folder\n@page\n@model DetailsModel\n<table class=""table table-sm table-bordered"">\n    <tbody>\n1178 chapter  39 Applying ASP.NET Core Identity \n        @if (Model.Cookie == null) {\n            <tr><th class=""text-center"">No Identity Cookie</th></tr>\n        } else {\n            <tr>\n                <th>Cookie</th>\n                <td class=""text-break"">@Model.Cookie</td>\n            </tr>\n        }\n    </tbody>    \n</table>\n@functions {\n    public class DetailsModel : PageModel {\n        public string? Cookie { get; set; }\n        public void OnGet() {\n            Cookie = Request.Cookies["".AspNetCore.Identity.Application""];\n        }\n    }\n}\nThe name used for the ASP.NET Core Identity cookie is .AspNetCore.Identity \n.Application , and this page retrieves the cookie from the request and displays its \nvalue or a placeholder message if there is no cookie.\n39.2.3  Creating a Sign-Out page \nIt is important to give users the ability to sign out so they can explicitly delete the \ncookie, especially if public machines may be used to access the application. Add a \nRazor Page named Logout.cshtml  to the Pages/Account  folder of the Advanced  \nfolder with the content shown in listing 39.6.  \nListing 39.6    The Logout.cshtml file in the Pages/Account folder in the Advanced project \n@page\n@model LogoutModel\n<div class=""bg-primary text-center text-white p-2""><h4>Log Out</h4></div>\n<div class=""m-2"">\n    <h6>You are logged out</h6>\n    <a asp-page=""Login"" class=""btn btn-secondary"">OK</a>\n</div>\n@functions {\n    public class LogoutModel : PageModel {\n        private SignInManager<IdentityUser> signInManager;\n        public LogoutModel(SignInManager<IdentityUser> signInMgr) {\n            signInManager = signInMgr;\n        }\n        public async Task OnGetAsync() {",3957
474-39.2.5 Enabling the Identity authentication middleware.pdf,474-39.2.5 Enabling the Identity authentication middleware,"1179 Authenticating users\n            await signInManager.SignOutAsync();\n        }\n    }\n}\nThis page calls the SignOutAsync  method described in table 39.2 to sign the applica-\ntion out of the application. The ASP.NET Core Identity cookie will be deleted so that \nthe browser will not include it in future requests (and invalidated the cookie so that \nrequests will not be treated as authenticated even if the cookie is used again anyway).\n39.2.4  Testing the authentication feature \nRestart ASP.NET Core and request http://localhost:5000/users/list. Click the Create \nbutton and fill out the form using the data shown in table 39.3. Click the Submit but-\nton to submit the form and create the user account.\nTable 39.3    The data values to create a user\nField Description\nUserName bob\nEmail bob@example.com\nPassword secret\nNavigate to http://localhost:5000/account/login and authenticate using the user-\nname and password from table 39.3. No return URL has been specified, and you will \nbe redirected to the root URL once you have been authenticated. Request http://\nlocalhost:5000/account/details, and you will see the ASP.NET Core Identity cookie. \nRequest http://localhost:5000/account/logout to log out of the application and \nreturn to http://localhost:5000/account/details to confirm that the cookie has been \ndeleted, as shown in figure 39.3.\nFigure 39.3    Authenticating a user\n39.2.5  Enabling the Identity authentication middleware \nASP.NET Core Identity provides a middleware component that detects the cookie \ncreated by the SignInManager<T>  class and populates the HttpContext  object with \ndetails of the authenticated user. This provides endpoints with details about the user \n1180 chapter  39 Applying ASP.NET Core Identity \nwithout needing to be aware of the authentication process or having to deal directly \nwith the cookie created by the authentication process. Listing 39.7 adds the authenti-\ncation middleware to the example application’s request pipeline.\nListing 39.7    Enabling middleware in the Program.cs file in the Advanced folder\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Identity;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddSingleton<Advanced.Services.ToggleService>();\nbuilder.Services.AddDbContext<IdentityContext>(opts =>\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<IdentityContext>();\nbuilder.Services.Configure<IdentityOptions>(opts => {\n    opts.Password.RequiredLength = 6;\n    opts.Password.RequireNonAlphanumeric = false;\n    opts.Password.RequireLowercase = false;\n    opts.Password.RequireUppercase = false;\n    opts.Password.RequireDigit = false;\n    opts.User.RequireUniqueEmail = true;\n    opts.User.AllowedUserNameCharacters = ""abcdefghijklmnopqrstuvwxyz"";\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseAuthentication();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");\napp.UseBlazorFrameworkFiles(""/webassembly"");\napp.MapFallbackToFile(""/webassembly/{*path:nonfile}"", \n    ""/webassembly/index.html"");\n 1181 Authenticating users\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\napp.Run();\nThe middleware sets the value of the HttpContext.User  property to a Claims-\nPrincipal  object. Claims  are pieces of information about a user and details of the \nsource of that information, providing a general-purpose approach to describing the \ninformation known about a user. \nThe ClaimsPrincipal  class is part of .NET Core and isn’t directly useful in most \nASP.NET Core applications, but there are two nested properties that are useful in most \napplications, as described in table 39.4.  \nTable 39.4    Useful Nested ClaimsPrincipal Properties\nName Description\nClaimsPrincipal.Identity.Name This property returns the username, \nwhich will be null  if there is no user \nassociated with the request.\nClaimsPrincipal.Identity.\nIsAuthenticatedThis property returns true  if the user \nassociated with the request has been \nauthenticated.\nThe username provided through the ClaimsPrincipal  object can be used to obtain \nthe ASP.NET Core Identity user object, as shown in listing 39.8.\nListing 39.8    User details in the Details.cshtml file in the Pages/Account folder of the \nAdvanced project\n@page\n@model DetailsModel\n<table class=""table table-sm table-bordered"">\n    <tbody>\n        @if (Model.IdentityUser == null) {\n            <tr><th class=""text-center"">No User</th></tr>\n        } else {\n            <tr><th>Name</th><td>@Model.IdentityUser.UserName</td></tr>\n            <tr><th>Email</th><td>@Model.IdentityUser.Email</td></tr>\n        }\n    </tbody>    \n</table>\n@functions {\n    public class DetailsModel : PageModel {\n        private UserManager<IdentityUser> userManager;\n        public DetailsModel(UserManager<IdentityUser> manager) {\n            userManager = manager;\n        }\n1182 chapter  39 Applying ASP.NET Core Identity \n        public IdentityUser? IdentityUser { get; set; }\n        public async Task OnGetAsync() {\n            if (User.Identity != null \n                    && User.Identity.Name != null\n                    && User.Identity.IsAuthenticated) {\n                IdentityUser = await \n                    userManager.FindByNameAsync(User.Identity.Name);\n            }\n        }\n    }\n}\nThe HttpContext.User  property can be accessed through the User  convenience \nproperty defined by the PageModel  and ControllerBase  classes. This Razor Page \nconfirms that there is an authenticated user associated with the request and gets the \nIdentityUser  object that describes the user.\nRestart ASP.NET Core, request http://localhost:5000/account/login, and authen-\nticate using the details in table 39.3. Request http://localhost:5000/account/details, \nand you will see how the ASP.NET Core Identity middleware enabled in listing 39.7 has \nprocessed the cookie to associate user details with the request, as shown in figure 39.4.\nConsidering two-factor authentication\nI have performed single-factor authentication in this chapter, which is where the user \nauthenticates using a single piece of information known to them in advance: the \npassword.  \nASP.NET Core Identity also supports two-factor authentication, where the user needs \nsomething extra, usually something that is given to the user at the moment they want \nto authenticate. The most common examples are a value from a hardware token or \nsmartphone app or an authentication code that is sent as an email or text message. \n(Strictly speaking, the two factors can be anything, including fingerprints, iris scans, \nand voice recognition, although these are options that are rarely required for most web \napplications.) \nSecurity is increased because an attacker needs to know the user’s password and have \naccess to whatever provides the second factor, such as an e-mail account or cell phone.\nI don’t show two-factor authentication in the book for two reasons. The first is that it \nrequires a lot of preparatory work, such as setting up the infrastructure that distributes \nthe second-factor e-mails and texts and implementing the validation logic, all of which is \nbeyond the scope of this book. \nThe second reason is that two-factor authentication forces the user to remember to jump \nthrough an additional hoop to authenticate, such as remembering their phone or keep-\ning a security token nearby, something that isn’t always appropriate for web applications. \nI carried a hardware token of one sort or another for more than a decade in various jobs, \nand I lost count of the number of times that I couldn’t log in to an employer’s system \nbecause I left the token at home. If you are considering two-factor authentication, then \nI recommend using one of the many hosted providers that will take care of distributing \nand managing the second factors for you.",8617
475-39.3 Authorizing access to endpoints.pdf,475-39.3 Authorizing access to endpoints,,0
476-39.3.2 Enabling the authorization middleware.pdf,476-39.3.2 Enabling the authorization middleware,"1183 Authorizing access to endpoints\nFigure 39.4    \nGetting details of an \nauthenticated user\n39.3 Authorizing access to endpoints\nOnce an application has an authentication feature, user identities can be used \nto restrict access to endpoints. In the sections that follow, I explain the process for \nenabling authorization and demonstrate how an authorization policy can be defined.  \n39.3.1  Applying the authorization attribute \nThe Authorize  attribute is used to restrict access to an endpoint and can be applied \nto individual action or page handler methods or to controller or page model classes, in \nwhich case the policy applies to all the methods defined by the class. I want to restrict \naccess to the user and role administration tools created in chapter 38. When there \nare multiple Razor Pages or controllers for which the same authorization policy is \nrequired, it is a good idea to define a common base class to which the Authorize  attri-\nbute can be applied because it ensures that you won’t accidentally omit the attribute \nand allow unauthorized access. It is for this reason that I defined the AdminPageModel  \nclass and used it as the base for all the administration tool page models in chapter 38. \nListing 39.9 applies the Authorize  attribute to the AdminPageModel  class to create the \nauthorization policy.  \nListing 39.9    Applying an attribute in the AdminPageModel.cs file in the Pages folder \nin the Advanced project \nusing Microsoft.AspNetCore.Mvc.RazorPages;\nusing Microsoft.AspNetCore.Authorization;\nnamespace Advanced.Pages {\n    [Authorize(Roles=""Admins"")]\n    public class AdminPageModel : PageModel {\n    }\n}\nThe Authorize  attribute can be applied without arguments, which restricts access to \nany authenticated user. The Roles  argument is used to further restrict access to users",1851
477-39.3.4 Creating the seed data.pdf,477-39.3.4 Creating the seed data,"1184 chapter  39 Applying ASP.NET Core Identity \nwho are members of specific roles, which are expressed as a comma-separated list. The \nattribute in this listing restricts access to users assigned to the Admins  role. The authori-\nzation restrictions are inherited, which means that applying the attribute to the base class \nrestricts access to all the Razor Pages created to manage users and roles in chapter 38.\nNOTE    If you want to restrict access to most, but not all, of the action methods in \na controller, then you can apply the Authorize  attribute to the controller class \nand the AllowAnonymous  attribute to just the action methods for which unau-\nthenticated access is required.\n39.3.2  Enabling the authorization middleware \nThe authorization policy is enforced by a middleware component, which must be \nadded to the application’s request pipeline, as shown in listing 39.10.  \nListing 39.10    Adding middleware in the Program.cs file in the Advanced project \n...\napp.UseStaticFiles();\napp.UseAuthentication();\napp.UseAuthorization();\napp.MapControllers();\n...\nThe UseAuthorization  method must be called between the UseRouting  and \nUseEndpoints  methods and after the UseAuthentication  method has been called. \nThis ensures that the authorization component can access the user data and inspect \nthe authorization policy after the endpoint has been selected but before the request is \nhandled. \n39.3.3  Creating the access denied endpoint \nThe application must deal with two different types of authorization failure. If no user \nhas been authenticated when a restricted endpoint is requested, then the authoriza-\ntion middleware will return a challenge response, which will trigger a redirection to \nthe login page so the user can present their credentials and prove they should be able \nto access the endpoint. \nBut if an authenticated user requests a restricted endpoint and doesn’t pass the \nauthorization checks, then an access denied response is generated so the application \ncan display a suitable warning to the user. Add a Razor Page named AccessDenied \n.cshtml  to the Pages/Account  folder of the Advanced  folder with the content shown \nin listing 39.11.  \n 1185 Authorizing access to endpoints\nListing 39.11    The AccessDenied.cshtml file in the Pages/Account folder of the \nAdvanced project \n@page\n<h4 class=""bg-danger text-white text-center p-2"">Access Denied</h4>\n<div class=""m-2"">\n    <h6>You are not authorized for this URL</h6>\n    <a class=""btn btn-outline-danger"" href=""/"">OK</a>\n    <a class=""btn btn-outline-secondary"" asp-page=""Logout"">Logout</a>\n</div>\nThis page displays a warning message to the user, with a button that navigates to the \nroot URL. There is typically little the user can do to resolve authorization failures \nwithout administrative intervention, and my preference is to keep the access denied \nresponse as simple as possible. \n39.3.4  Creating the seed data\nIn listing 39.9, I restricted access to the user and role administration tools so they can \nbe accessed only by users in the Admin  role. There is no such role in the database, \nwhich creates a problem: I am locked out of the administration tools because there is \nno authorized account that will let me create the role.\nI could have created an administration user and role before applying the Authorize  \nattribute, but that complicates deploying the application, when making code changes \nshould be avoided. Instead, I am going to create seed data for ASP.NET Core Identity to \nensure there will always be at least one account that can be used to access the user and \nrole management tools. Add a class file named IdentitySeedData.cs  to the Models  \nfolder in the Advanced project and use it to define the class shown in listing 39.12.  \nListing 39.12    The IdentitySeedData.cs file in the Models folder of the Advanced project \nusing Microsoft.AspNetCore.Identity;\nnamespace Advanced.Models {\n    public class IdentitySeedData {\n        public static void CreateAdminAccount(\n                IServiceProvider serviceProvider,\n                IConfiguration configuration) {\n            CreateAdminAccountAsync(serviceProvider, configuration)\n                .Wait();\n        }\n        public static async Task CreateAdminAccountAsync(IServiceProvider\n                serviceProvider, IConfiguration configuration) {\n            serviceProvider = \n                serviceProvider.CreateScope().ServiceProvider;\n1186 chapter  39 Applying ASP.NET Core Identity \n            UserManager<IdentityUser> userManager = serviceProvider\n                .GetRequiredService<UserManager<IdentityUser>>();\n            RoleManager<IdentityRole> roleManager = serviceProvider\n                .GetRequiredService<RoleManager<IdentityRole>>();\n            string username = configuration[""Data:AdminUser:Name""] \n                ?? ""admin"";\n            string email = configuration[""Data:AdminUser:Email""] \n                ?? ""admin@example.com"";\n            string password = configuration[""Data:AdminUser:Password""] \n                ?? ""secret"";\n            string role = configuration[""Data:AdminUser:Role""] \n                ?? ""Admins"";\n            if (await userManager.FindByNameAsync(username) == null) {\n                if (await roleManager.FindByNameAsync(role) == null) {\n                    await roleManager.CreateAsync(new IdentityRole(role));\n                }\n                IdentityUser user = new IdentityUser {\n                    UserName = username,\n                    Email = email\n                };\n                IdentityResult result = await userManager\n                    .CreateAsync(user, password);\n                if (result.Succeeded) {\n                    await userManager.AddToRoleAsync(user, role);\n                }\n            }\n        }\n    }\n}\nThe UserManager<T>  and RoleManager<T>  services are scoped, which means I need \nto create a new scope before requesting the services since the seeding will be done \nwhen the application starts. The seeding code creates a user account that is assigned to \na role. The values for the seed data are read from the application’s configuration with \nfallback values, making it easy to configure the seeded account without needing a code \nchange. Listing 39.13 adds a statement to the Program.cs  file so that the database is \nseeded when the application starts.\nCAUTION    Putting passwords in code files or plain-text configuration files \nmeans you must make it part of your deployment process to change the default \naccount’s password when you deploy the application and initialize a new data-\nbase for the first time. You can also use the user secrets feature to keep sensitive \ndata outside of the project.",6815
478-39.4 Authorizing access to Blazor applications.pdf,478-39.4 Authorizing access to Blazor applications,"1187 Authorizing access to endpoints\nListing 39.13    Seeding identity in the Program.cs file in the Advanced project \n...\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\nIdentitySeedData.CreateAdminAccount(app.Services, app.Configuration);\napp.Run();\n...\n39.3.5  Testing the authentication sequence\nRestart ASP.NET Core and request http://localhost:5000/account/logout to ensure \nthat no user is logged in to the application. Without logging in, request http://  \nlocalhost:5000/users/list. The endpoint that will be selected to handle the request \nrequires authentication, and the login prompt will be shown since there is no authen-\nticated user associated with the request. Authenticate with the username bob and the \npassword secret . This user doesn’t have access to the restricted endpoint, and the \naccess denied response will be shown, as illustrated by figure 39.5.\nFigure 39.5     \nA user without \nauthorization\nClick the Logout button and request http://localhost:5000/users/list again, which \nwill lead to the login prompt being displayed. Authenticate with the username admin  \nand the password secret . This is the user account created by the seed data and that is \na member of the role specified by the Authorize  attribute. The user passes the autho-\nrization check, and the requested Razor Page is displayed, as shown in figure 39.6.\nFigure 39.6.   \nA user with \nauthorization\n1188 chapter  39 Applying ASP.NET Core Identity \nChanging the authorization URLs\nThe /Account/Login  and /Account/AccessDenied  URLs are the defaults used by \nASP.NET Core authorization files. These can be changed in the Program.cs  file using \nthe options pattern, like this:  \n...\nbuilder.Services.Configure<CookieAuthenticationOptions>(\n       IdentityConstants.ApplicationScheme,\n    opts => {\n        opts.LoginPath = ""/Authenticate"";\n        opts.AccessDeniedPath = ""/NotAllowed"";\n    });\n...\nConfiguration is performed using the CookieAuthenticationOptions  class, defined \nin the Microsoft.AspNetCore.Authentication.Cookies  namespace. The \nLogin Path  property is used to specify the path to which browsers will be redirected \nwhen an unauthenticated user attempts to access a restricted endpoint. The Access-\nDeniedPath  property is used to specify the path when an authenticated user attempts \nto access a restricted endpoint and does not have authorization. \n39.4 Authorizing access to Blazor applications\nThe simplest way to protect Blazor applications is to restrict access to the action method \nor Razor Page that acts as the entry point. In listing 39.14, I added the Authorize  attri-\nbute to the page model class for the _Host  page, which is the entry point for the Blazor \napplication in the example project.  \nUnderstanding OAuth and IDENTITYSERVER\nIf you read the Microsoft documentation, you will be left with the impression that you \nneed to use a third-party server called IdentityServer  (https://duendesoftware \n.com ) to authenticate web services.  \nIdentityServer  is a high-quality open-source package that provides authentication \nand authorization services, with paid-for options for add-ons and support. Identity-\nServer  provides support for OAuth , which is a standard for managing authentication \nand authorization and provides packages for a range of client-side frameworks.\nWhat the Microsoft documentation is saying—albeit awkwardly—is that Microsoft has \nused IdentityServer  in the project templates that include authentication for web \nservices. If you create an Angular or React project using an ASP.NET Core template pro-\nvided by Microsoft, you will find that the authentication has been implemented using \nIdentityServer .\nAuthentication is complex, and IdentityServer  can be difficult to set up correctly. \nI like IdentityServer , but it is not essential and is not required by most projects. \nIdentityServer  may be useful if your project needs to support complex authentica-\ntion scenarios, but my advice is not to rush into using third-party authentication servers \nuntil they are essential.\n 1189 Authorizing access to Blazor applications\nListing 39.14    Applying an attribute in the _Host.cshtml file in the Pages folder of the \nAdvanced project \n@page ""/""\n@{ Layout = null; }\n@model HostModel\n@using Microsoft.AspNetCore.Authorization\n<!DOCTYPE html>\n<html>\n<head>\n    <title>@ViewBag.Title</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <base href=""~/"" />  \n</head>\n<body>    \n    <div class=""m-2"">\n        <component type=""typeof(Advanced.Blazor.Routed)"" \n            render-mode=""Server"" />\n    </div>\n    <script src=""_framework/blazor.server.js""></script>\n    <script src=""~/interop.js""></script>\n</body>\n</html>\n@functions {\n    [Authorize]\n    public class HostModel : PageModel { }\n}\nThis has the effect of preventing unauthenticated users from accessing the Blazor \napplication. Request http://localhost:5000/account/logout to ensure the browser \ndoesn’t have an authentication cookie and then request http://localhost:5000. This \nrequest will be handled by the _Host  page, but the authorization middleware will trig-\nger the redirection to the login prompt. Authenticate with the username bob and the \npassword secret , and you will be granted access to the Blazor application, as shown in \nfigure 39.7.\nFigure 39.7    Restricting access to the Blazor endpoint",5545
479-39.4.1 Performing authorization in Blazor components.pdf,479-39.4.1 Performing authorization in Blazor components,"1190 chapter  39 Applying ASP.NET Core Identity \n39.4.1  Performing authorization in Blazor components \nRestricting access to the endpoint is an effective technique, but it applies the same \nlevel of authorization to all the Blazor functionality. For applications that require more \ngranular restrictions, Blazor provides the AuthorizeRouteView  component, which \nallows different content to be displayed for authorized and unauthorized when com-\nponents are managed using URL routing. Listing 39.15 adds the AuthorizeRoute-\nView  to the routing component in the example application.  \nListing 39.15    Adding a component in the Routed.razor file in the Blazor folder of the \nAdvanced project \n@using Microsoft.AspNetCore.Components.Authorization\n<Router AppAssembly=""typeof(Program).Assembly"">\n    <Found>\n        <AuthorizeRouteView RouteData=""@context"" \n                DefaultLayout=""typeof(NavLayout)"">\n           <NotAuthorized Context=""authContext"">\n                <h4 class=""bg-danger text-white text-center p-2"">\n                    Not Authorized\n                </h4>\n                <div class=""text-center"">\n                    You may need to log in as a different user\n                </div>\n            </NotAuthorized>\n        </AuthorizeRouteView>\n    </Found>\n    <NotFound>\n        <h4 class=""bg-danger text-white text-center p-2"">\n            No Matching Route Found\n        </h4>\n    </NotFound>\n</Router>\nThe NotAuthorized  section is used to define the content that will be presented to \nusers when they attempt to access a restricted resource. To demonstrate this feature, I \nam going to restrict access to the DepartmentList  component to users assigned to the \nAdmins  role, as shown in listing 39.16.\nListing 39.16    Restricting access in the DepartmentList.cshtml file in the Blazor \nfolder in the Advanced project \n@page ""/departments""\n@page ""/depts""\n@using Microsoft.AspNetCore.Authorization\n@attribute [Authorize(Roles = ""Admins"")]\n<CascadingValue Name=""BgTheme"" Value=""Theme"" IsFixed=""false"">\n    <TableTemplate RowType=""Department"" RowData=""Departments""\n                   Highlight=""@(d => d.Name)""\n                   SortDirection=""@(d => d.Name)"">\n 1191 Authorizing access to Blazor applications\n        <Header>\n        <tr>\n            <th>ID</th><th>Name</th><th>People</th><th>Locations</th>\n        </tr>\n        </Header>\n        <RowTemplate Context=""d"">\n            <td>@d.Departmentid</td>\n            <td>@d.Name</td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p => p.Surname)))\n            </td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p =>\n                    p.Location!.City).Distinct()))\n            </td>\n        </RowTemplate>\n    </TableTemplate>\n</CascadingValue>\n<SelectFilter Title=""@(""Theme"")"" Values=""Themes""\n              @bind-SelectedValue=""Theme"" />\n<button class=""btn btn-primary"" @onclick=""HandleClick"">People</button>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Department>? Departments => Context?.Departments?\n        .Include(d => d.People!).ThenInclude(p => p.Location!);\n    public string Theme { get; set; } = ""info"";\n    public string[] Themes = \n        new string[] { ""primary"", ""info"", ""success"" };\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    public void HandleClick() => NavManager?.NavigateTo(""/people"");\n}\nI have used the @attribute  directive to apply the Authorize  attribute to the com-\nponent. Restart ASP.NET Core and request http://localhost:5000/account/logout \nto remove the authentication cookie and then request http://localhost:5000. When \nprompted, authenticate with the username bob and the password secret . You will see \nthe Blazor application, but when you click the Departments button, you will see the \nauthorization content defined in listing 39.15, as shown in figure 39.8. Log out again \nand log in as admin  with the password secret , and you will be able to use the restricted \ncomponent.",4110
480-39.4.2 Displaying content to authorized users.pdf,480-39.4.2 Displaying content to authorized users,"1192 chapter  39 Applying ASP.NET Core Identity \nFigure 39.8     \nUsing authorization in \na Blazor application\n39.4.2  Displaying content to authorized users\nThe AuthorizeView  component is used to restrict access to sections of content ren-\ndered by a component. In listing 39.17, I have changed the authorization for the \nDepartmentList  component so that any authenticated user can access the page and \nuse the AuthorizeView  component so that the contents of the Locations  column in \nthe table is shown only to users assigned to the Admins  group.  \nListing 39.17    Selective content in the DepartmentList.razor file in the Blazor folder in \nthe Advanced project\n@page ""/departments""\n@page ""/depts""\n@using Microsoft.AspNetCore.Authorization\n@using Microsoft.AspNetCore.Components.Authorization\n@attribute [Authorize]\n<CascadingValue Name=""BgTheme"" Value=""Theme"" IsFixed=""false"">\n    <TableTemplate RowType=""Department"" RowData=""Departments""\n                   Highlight=""@(d => d.Name)""\n                   SortDirection=""@(d => d.Name)"">\n        <Header>\n        <tr>\n            <th>ID</th><th>Name</th><th>People</th><th>Locations</th>\n        </tr>\n        </Header>\n        <RowTemplate Context=""d"">\n            <td>@d.Departmentid</td>\n            <td>@d.Name</td>\n            <td>\n                @(String.Join("", "", d.People!.Select(p => p.Surname)))\n            </td>\n            <td>\n                <AuthorizeView Roles=""Admins"">\n                    <Authorized>\n                        @(String.Join("", "",d.People!\n                            .Select(p => p.Location!.City).Distinct()))\n                    </Authorized>\n                    <NotAuthorized>\n                        (Not authorized)\n                    </NotAuthorized>\n                </AuthorizeView>\n            </td>\n 1193 Authorizing access to Blazor applications\n        </RowTemplate>\n    </TableTemplate>\n</CascadingValue>\n<SelectFilter Title=""@(""Theme"")"" Values=""Themes""\n              @bind-SelectedValue=""Theme"" />\n<button class=""btn btn-primary"" @onclick=""HandleClick"">People</button>\n@code {\n    [Inject]\n    public DataContext? Context { get; set; }\n    public IEnumerable<Department>? Departments => Context?.Departments?\n        .Include(d => d.People!).ThenInclude(p => p.Location!);\n    public string Theme { get; set; } = ""info"";\n    public string[] Themes = \n        new string[] { ""primary"", ""info"", ""success"" };\n    [Inject]\n    public NavigationManager? NavManager { get; set; }\n    public void HandleClick() => NavManager?.NavigateTo(""/people"");\n}\nThe AuthorizeView  component is configured with the Roles  property, which accepts \na comma-separated list of authorized roles. The Authorized  section contains the con-\ntent that will be shown to authorized users. The NotAuthorized  section contains the \ncontent that will be shown to unauthorized users. \nTIP    You can omit the NotAuthorized  section if you don’t need to show content \nto unauthorized users.\nRestart ASP.NET Core and authenticate as bob, with password secret , before request-\ning http://localhost:5000/depts. This user is not authorized to see the contents of the \nLocations  column, as shown in figure 39.9. Authenticate as admin , with password \nsecret , and request http://localhost:5000/depts again. This time the user is a mem-\nber of the Admins  role and passes the authorization checks, also shown in figure 39.9.\nFigure 39.9    \nSelectively \ndisplaying \ncontent \nbased on \nauthorization",3546
481-39.5 Authenticating and authorizing web services.pdf,481-39.5 Authenticating and authorizing web services,"1194 chapter  39 Applying ASP.NET Core Identity \n39.5 Authenticating and authorizing web services\nThe authorization process in the previous section relies on being able to redirect the \nclient to a URL that allows the user to enter their credentials. A different approach \nis required when adding authentication and authorization to a web service because \nthere is no option to present the user with an HTML form to collect their creden-\ntials. The first step in adding support for web services authentication is to disable the \nredirections so that the client will receive HTTP error responses when attempting to \nrequest an endpoint that requires authentication. Add a class file named Cookie-\nAuthenticationExtensions.cs  to the Advanced  folder and use it to define the \nextension method shown in listing 39.18.  \nListing 39.18    The CookieAuthenticationExtensions.cs file in the Advanced folder\nusing System.Linq.Expressions;\nnamespace Microsoft.AspNetCore.Authentication.Cookies {\n    public static class CookieAuthenticationExtensions {\n        public static void DisableRedirectForPath(\n            this CookieAuthenticationEvents events,\n            Expression<Func<CookieAuthenticationEvents,\n                Func<RedirectContext<CookieAuthenticationOptions>, \n                Task>>> expr,\n            string path, int statuscode) {\n            string propertyName \n                = ((MemberExpression)expr.Body).Member.Name;\n            var oldHandler = expr.Compile().Invoke(events);\n            Func<RedirectContext<CookieAuthenticationOptions>, Task> \n                newHandler = context => {\n                    if (context.Request.Path.StartsWithSegments(path)) {\n                        context.Response.StatusCode = statuscode;\n                    } else {\n                        oldHandler(context);\n                    }\n                    return Task.CompletedTask;\n                };\n            typeof(CookieAuthenticationEvents).GetProperty(propertyName)?\n                .SetValue(events, newHandler);\n        }\n    }\n}\nThis code is hard to follow. ASP.NET Core provides the CookieAuthentication -\nOptions  class, which is used to configure cookie-based authentication. The Cookie -\nAuthenticationOptions.Events  property returns a CookieAuthentication  Events  \nobject, which is used to set the handlers for the events triggered by the authentication \nsystem, including the redirections that occur when the user requests unauthorized \ncontent. The extension methods in listing 39.18 replaces the default handler for \n 1195 Authenticating and authorizing web services\nan event with one that performs redirection only if the request doesn’t start with \na specified path string. Listing 39.19 uses the extension method to replace the  \nOn  RedirectToLogin  and OnRedirectToAccessDenied  handlers so that redirections \nare not performed when the request path starts with /api .\nListing 39.19    Preventing redirection in the Program.cs file in the Advanced folder\nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Authentication.Cookies;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddSingleton<Advanced.Services.ToggleService>();\nbuilder.Services.AddDbContext<IdentityContext>(opts =>\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<IdentityContext>();\nbuilder.Services.Configure<IdentityOptions>(opts => {\n    opts.Password.RequiredLength = 6;\n    opts.Password.RequireNonAlphanumeric = false;\n    opts.Password.RequireLowercase = false;\n    opts.Password.RequireUppercase = false;\n    opts.Password.RequireDigit = false;\n    opts.User.RequireUniqueEmail = true;\n    opts.User.AllowedUserNameCharacters = ""abcdefghijklmnopqrstuvwxyz"";\n});\nbuilder.Services.AddAuthentication(opts => {\n    opts.DefaultScheme =\n        CookieAuthenticationDefaults.AuthenticationScheme;\n    opts.DefaultChallengeScheme =\n         CookieAuthenticationDefaults.AuthenticationScheme;\n}).AddCookie(opts => {\n    opts.Events.DisableRedirectForPath(e => e.OnRedirectToLogin,\n         ""/api"", StatusCodes.Status401Unauthorized);\n    opts.Events.DisableRedirectForPath(e => e.OnRedirectToAccessDenied,\n        ""/api"", StatusCodes.Status403Forbidden);\n});",4790
482-39.5.1 Building a simple JavaScript client.pdf,482-39.5.1 Building a simple JavaScript client,"1196 chapter  39 Applying ASP.NET Core Identity \nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseAuthentication();\napp.UseAuthorization();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");\napp.UseBlazorFrameworkFiles(""/webassembly"");\napp.MapFallbackToFile(""/webassembly/{*path:nonfile}"",\n    ""/webassembly/index.html"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\nIdentitySeedData.CreateAdminAccount(app.Services, app.Configuration);\napp.Run();\nThe AddAuthentication  method is used to select cookie-based authentication and is \nchained with the AddCookie  method to replace the event handlers that would other-\nwise trigger redirections.  \n39.5.1  Building a simple JavaScript client \nTo demonstrate how to perform authentication with web services, I am going to create \na simple JavaScript client that will consume data from the Data  controller in the exam-\nple project. \nTIP    You don’t have to be familiar with JavaScript to follow the examples in this \npart of the chapter. It is the server-side code that is important and the way it sup-\nports authentication by the client so that it can access the web service.\nAdd an HTML Page called webclient.html  to the wwwroot  folder of the Advanced  \nproject with the elements shown in listing 39.20.\nListing 39.20    The contents of the webclient.html file in the wwwroot folder of the \nAdvanced project \n<!DOCTYPE html>\n<html>\n<head>\n    <title>Web Service Authentication</title>\n    <link href=""/lib/bootstrap/css/bootstrap.min.css"" rel=""stylesheet"" />\n    <script type=""text/javascript"" src=""webclient.js""></script>\n</head>\n<body>    \n 1197 Authenticating and authorizing web services\n    <div id=""controls"" class=""m-2""></div>\n    <div id=""data"" class=""m-2 p-2"">\n        No data\n    </div>\n</body>\n</html>\nAdd a JavaScript file named webclient.js  to the wwwroot  of the Advanced project \nwith the content shown in listing 39.21.\nListing 39.21    The webclient.js file in the wwwroot folder of the Advanced project \nconst username = ""bob"";\nconst password = ""secret"";\nwindow.addEventListener(""DOMContentLoaded"", () => {\n    const controlDiv = document.getElementById(""controls"");\n    createButton(controlDiv, ""Get Data"", getData);\n    createButton(controlDiv, ""Log In"", login);\n    createButton(controlDiv, ""Log Out"", logout);\n});\nfunction login() {\n    // do nothing\n}\nfunction logout() {\n    // do nothing\n}\nasync function getData() {\n    let response = await fetch(""/api/people"");\n    if (response.ok) {\n        let jsonData = await response.json();\n        displayData(...jsonData.map(item => `${item.surname}, \n            ${item.firstname}`));\n    } else {\n        displayData(`Error: ${response.status}: ${response.statusText}`);\n    }\n}\nfunction displayData(...items) {\n    const dataDiv = document.getElementById(""data"");\n    dataDiv.innerHTML = """";\n    items.forEach(item => {\n        const itemDiv = document.createElement(""div"");\n        itemDiv.innerText = item;\n        itemDiv.style.wordWrap = ""break-word"";\n        dataDiv.appendChild(itemDiv);\n    })\n}\nfunction createButton(parent, label, handler) {\n    const button = document.createElement(""button"");\n    button.classList.add(""btn"", ""btn-primary"",  ""m-2"");",3502
483-39.5.3 Using cookie authentication.pdf,483-39.5.3 Using cookie authentication,"1198 chapter  39 Applying ASP.NET Core Identity \n    button.innerText = label;\n    button.onclick = handler;\n    parent.appendChild(button);\n}\nThis code presents the user with Get Data and Log In and Log Out buttons. Clicking \nthe Get Data button sends an HTTP request using the Fetch API, processes the JSON \nresult, and displays a list of names. The other buttons do nothing, but I’ll use them in \nlater examples to authenticate with the ASP.NET Core application using the hardwired \ncredentials in the JavaScript code.\nCAUTION    This is just a simple client to demonstrate server-side authentication \nfeatures. If you need to write a JavaScript client, then consider a framework such \nas Angular or React. Regardless of how you build your clients, do not include \nhardwired credentials in the JavaScript files.\nRequest http://localhost:5000/webclient.html and click the Get Data button. The \nJavaScript client will send an HTTP request to the Data  controller and display the \nresults, as shown in figure 39.10.\nFigure 39.10    \nA simple web \nclient\n39.5.2  Restricting access to the web service \nThe standard authorization features are used to restrict access to web service end-\npoints, and in listing 39.22, I have applied the Authorize  attribute to the Data-\nController  class.  \nListing 39.22    Applying an attribute in the DataController.cs file in the Controllers \nfolder of the Advanced project \nusing Advanced.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Authorization;\nnamespace Advanced.Controllers {\n    [ApiController]\n 1199 Authenticating and authorizing web services\n    [Route(""/api/people"")]\n    [Authorize]\n    public class DataController : ControllerBase {\n        private DataContext context;\n        // ...methods omitted for brevity...\n    }\n}\nRestart ASP.NET Core and request http://localhost:5000/account/logout to ensure \nthat the JavaScript client doesn’t use an authentication cookie from a previous exam-\nple. Request http://localhost:5000/webclient.html to load the JavaScript client and \nclick the Get Data button to send the HTTP request. The server will respond with a 401 \nUnauthorized  response, as shown in figure 39.11.\nFigure 39.11     \nAn unauthorized \nrequest\n39.5.3  Using cookie authentication \nThe simplest way to implement authentication is to rely on the standard ASP.NET \nCore cookies demonstrated in previous sections. Add a class file named ApiAccount -\nController.cs  to the Controllers  folder of the Advanced  project and use it to \ndefine the controller shown in listing 39.23.  \nListing 39.23    The ApiAccountController.cs file in the Controllers folder of the \nAdvanced project \nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Mvc;\nnamespace Advanced.Controllers {\n    [ApiController]\n    [Route(""/api/account"")]\n    public class ApiAccountController : ControllerBase {\n        private SignInManager<IdentityUser> signinManager;\n        public ApiAccountController(SignInManager<IdentityUser> mgr) {\n            signinManager = mgr;\n        }\n        [HttpPost(""login"")]\n        public async Task<IActionResult> Login([FromBody] \n1200 chapter  39 Applying ASP.NET Core Identity \n                Credentials creds) {\n            Microsoft.AspNetCore.Identity.SignInResult result\n                = await signinManager.PasswordSignInAsync(creds.Username,\n                     creds.Password, false, false);\n            if (result.Succeeded) {\n                return Ok();\n            }\n            return Unauthorized();\n        }\n        [HttpPost(""logout"")]\n        public async Task<IActionResult> Logout() {\n            await signinManager.SignOutAsync();\n            return Ok();\n        }\n        public class Credentials {\n            public string Username { get; set; } = string.Empty;\n            public string Password { get; set; } = string.Empty;\n        }\n    }\n}\nThis web service controller defines actions that allow clients to log in and log out. The \nresponse for a successful authentication request will contain a cookie that the browser \nwill automatically include in requests made by the JavaScript client.\nListing 39.24 adds support to the simple JavaScript client for authenticating using \nthe action methods defined in listing 39.23.\nListing 39.24    Adding authentication in the webclient.js file in the wwwroot folder of \nthe Advanced project \nconst username = ""bob"";\nconst password = ""secret"";\nwindow.addEventListener(""DOMContentLoaded"", () => {\n    const controlDiv = document.getElementById(""controls"");\n    createButton(controlDiv, ""Get Data"", getData);\n    createButton(controlDiv, ""Log In"", login);\n    createButton(controlDiv, ""Log Out"", logout);\n});\nasync function login() {\n    let response = await fetch(""/api/account/login"", {\n        method: ""POST"",\n        headers: { ""Content-Type"": ""application/json"" },\n        body: JSON.stringify({ username: username, password: password })\n    });\n    if (response.ok) {\n        displayData(""Logged in"");\n    } else {\n        displayData('Error: ${response.status}: ${response.statusText}');\n 1201 Authenticating and authorizing web services\n    }\n}\nasync function logout() {\n    let response = await fetch(""/api/account/logout"", {\n        method: ""POST""\n    });\n    if (response.ok) {\n        displayData(""Logged out"");\n    } else {\n        displayData('Error: ${response.status}: ${response.statusText}');\n    }\n}\nasync function getData() {\n    let response = await fetch(""/api/people"");\n    if (response.ok) {\n        let jsonData = await response.json();\n        displayData(...jsonData.map(item => `${item.surname}, \n            ${item.firstname}`));\n    } else {\n        displayData(`Error: ${response.status}: ${response.statusText}`);\n    }\n}\nfunction displayData(...items) {\n    const dataDiv = document.getElementById(""data"");\n    dataDiv.innerHTML = """";\n    items.forEach(item => {\n        const itemDiv = document.createElement(""div"");\n        itemDiv.innerText = item;\n        itemDiv.style.wordWrap = ""break-word"";\n        dataDiv.appendChild(itemDiv);\n    })\n}\nfunction createButton(parent, label, handler) {\n    const button = document.createElement(""button"");\n    button.classList.add(""btn"", ""btn-primary"",  ""m-2"");\n    button.innerText = label;\n    button.onclick = handler;\n    parent.appendChild(button);\n}\nRestart ASP.NET Core, request http://localhost:5000/webclient.html, and click the \nLogin In button. Wait for the message confirming authentication and then click the \nGet Data button. The browser includes the authentication cookie, and the request \npasses the authorization checks. Click the Log Out button and then click Get Data \nagain. No cookie is used, and the request fails. Figure 39.12 shows both requests.",6908
484-39.5.5 Creating tokens.pdf,484-39.5.5 Creating tokens,"1202 chapter  39 Applying ASP.NET Core Identity \nFigure 39.12    Using cookie authentication  \n39.5.4  Using bearer token authentication \nNot all web services will be able to rely on cookies because not all clients can use then. \nAn alternative is to use a bearer token, which is a string that clients are given and is \nincluded in the requests they send to the web service. Clients don’t understand the \nmeaning of the token—which is said to be opaque —and just use whatever token the \nserver provides.\nI am going to demonstrate authentication using a JSON Web Token (JWT), which \nprovides the client with an encrypted token that contains the authenticated username. \nThe client is unable to decrypt or modify the token, but when it is included in a request, \nthe ASP.NET Core server decrypts the token and uses the name it contains as the iden-\ntity of the user. The JWT format is described in detail at https://tools.ietf.org/html/\nrfc7519 . \nCAUTION    ASP.NET Core will trust that any request that includes the token orig-\ninates from the authenticated user. Just as when using cookies, production appli-\ncations should use HTTPS to prevent tokens from being intercepted and reused.\nOpen a new PowerShell command prompt, navigate to the Advanced  project folder, \nand run the commands shown in listing 39.25 to add the packages for JWT to the \nproject.\nListing 39.25    Installing the NuGet package \ndotnet add package System.IdentityModel.Tokens.Jwt --version 6.25.0\ndotnet add package Microsoft.AspNetCore.Authentication.JwtBearer  \n    --version 7.0.0 \nJWT requires a key that is used to encrypt and decrypt tokens. Add the configuration \nsetting shown in listing 39.26 to the appsettings.json  file. If you use JWT in a real \napplication, ensure you change the key or use a secret to store the key outside of the \nproject.\n 1203 Authenticating and authorizing web services\nListing 39.26    Adding a setting in the appsettings.json file in the Advanced project \n{\n  ""Logging"": {\n    ""LogLevel"": {\n      ""Default"": ""Information"",\n      ""Microsoft.AspNetCore"": ""Warning"",\n      ""Microsoft.EntityFrameworkCore"": ""Information""\n    }\n  },\n  ""AllowedHosts"": ""*"",\n  ""ConnectionStrings"": {\n    ""PeopleConnection"": ""Server=(localdb)\\MSSQLLocalDB;...\nDatabase=People;MultipleActiveResultSets=True"",\n    ""IdentityConnection"": ""Server=(localdb)\\MSSQLLocalDB;Database=Identity \n‰;MultipleActiveResultSets=True""\n  },\n  ""jwtSecret"": ""jwt_secret""\n}\n39.5.5  Creating tokens\nThe client will send an HTTP request that contains user credentials and will receive a \nJWT in response. Listing 39.27 adds an action method to the ApiAccount  controller \nthat receives the credentials, validates them, and generates tokens.\nListing 39.27    Generating tokens in the ApiAccountController.cs file in the Controllers \nfolder of the Advanced project\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.IdentityModel.Tokens;\nusing System.IdentityModel.Tokens.Jwt;\nusing System.Text;\nusing System.Security.Claims;\nnamespace Advanced.Controllers {\n    [ApiController]\n    [Route(""/api/account"")]\n    public class ApiAccountController : ControllerBase {\n        private SignInManager<IdentityUser> signinManager;\n        private UserManager<IdentityUser> userManager;\n        private IConfiguration configuration;\n        public ApiAccountController(SignInManager<IdentityUser> mgr,\n                 UserManager<IdentityUser> usermgr, \n                 IConfiguration config) {\n            signinManager = mgr;\n            userManager = usermgr;\n            configuration = config;\n        }\n        [HttpPost(""login"")]\n1204 chapter  39 Applying ASP.NET Core Identity \n        public async Task<IActionResult> Login(\n                [FromBody] Credentials creds) {\n            Microsoft.AspNetCore.Identity.SignInResult result\n                = await signinManager.PasswordSignInAsync(creds.Username,\n                    creds.Password, false, false);\n            if (result.Succeeded) {\n                return Ok();\n            }\n            return Unauthorized();\n        }\n        [HttpPost(""logout"")]\n        public async Task<IActionResult> Logout() {\n            await signinManager.SignOutAsync();\n            return Ok();\n        }\n        [HttpPost(""token"")]\n        public async Task<IActionResult> Token(\n                [FromBody] Credentials creds) {\n            if (await CheckPassword(creds)) {\n                JwtSecurityTokenHandler handler =\n                    new JwtSecurityTokenHandler();\n                byte[] secret = \n                    Encoding.ASCII.GetBytes(configuration[""jwtSecret""]!);\n                SecurityTokenDescriptor descriptor = \n                    new SecurityTokenDescriptor {\n                        Subject = new ClaimsIdentity(new Claim[] {\n                            new Claim(ClaimTypes.Name, creds.Username)\n                        }),\n                        Expires = DateTime.UtcNow.AddHours(24),\n                        SigningCredentials = new SigningCredentials(\n                            new SymmetricSecurityKey(secret),\n                                SecurityAlgorithms.HmacSha256Signature)\n                    };\n                SecurityToken token = handler.CreateToken(descriptor);\n                return Ok(new {\n                    success = true,\n                    token = handler.WriteToken(token)\n                });\n            }\n            return Unauthorized();\n        }\n        private async Task<bool> CheckPassword(Credentials creds) {\n            IdentityUser? user \n                = await userManager.FindByNameAsync(creds.Username);\n            if (user != null) {\n                return (await signinManager.CheckPasswordSignInAsync(user,\n                    creds.Password, true)).Succeeded;\n            }\n            return false;\n        }\n        public class Credentials {\n 1205 Authenticating and authorizing web services\n            public string Username { get; set; } = string.Empty;\n            public string Password { get; set; } = string.Empty;\n        }\n    }\n}\nWhen the Token  action method is invoked, it passes the credentials to the Check-\nPassword  method, which enumerates the IPasswordValidator<T>  objects to invoke \nthe ValidateAsync  method on each of them. If the password is validated by any of the \nvalidators, then the Token method creates a token.\nThe JWT specification defines a general-purpose token that can be used more \nbroadly than identifying users in HTTP requests, and many of the options that are avail-\nable are not required for this example. The token that is created in listing 39.27 con-\ntains a payload like this:\n...\n{\n  ""unique_name"": ""bob"",\n  ""nbf"": 1579765454,\n  ""exp"": 1579851854,\n  ""iat"": 1579765454\n}\n...\nThe unique_name  property contains the name of the user and is used to authenticate \nrequests that contain the token. The other payload properties are timestamps, which I \ndo not use.\nThe payload is encrypted using the key defined in listing 39.27 and returned to the \nclient as a JSON-encoded response that looks like this:\n...\n{\n    ""success"":true,\n    ""token"":""eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...""\n}\n...\nI have shown just the first part of the token because they are long strings and it is the \nstructure of the response that is important. The client receives the token and includes \nit in future requests using the Authorization  header, like this:\n...\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\n...\nThe server receives the token, decrypts it using the key, and authenticates the request \nusing the value of the unique_name  property from the token payload. No further vali-\ndation is performed, and requests with a valid token will be authenticated using what-\never username is contained in the payload.",7948
485-39.5.6 Authenticating with tokens.pdf,485-39.5.6 Authenticating with tokens,"1206 chapter  39 Applying ASP.NET Core Identity \n39.5.6  Authenticating with tokens \nThe next step is to configure the application to receive and validate the tokens, as \nshown in listing 39.28.\nListing 39.28    Authenticating tokens in the Program.cs file in the Advanced project \nusing Microsoft.EntityFrameworkCore;\nusing Advanced.Models;\nusing Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Authentication.Cookies;\nusing Microsoft.IdentityModel.Tokens;\nusing System.Text;\nusing System.Security.Claims;\nusing Microsoft.AspNetCore.Authentication.JwtBearer;\nvar builder = WebApplication.CreateBuilder(args);\nbuilder.Services.AddControllersWithViews();\nbuilder.Services.AddRazorPages();\nbuilder.Services.AddServerSideBlazor();\nbuilder.Services.AddDbContext<DataContext>(opts => {\n    opts.UseSqlServer(\n        builder.Configuration[""ConnectionStrings:PeopleConnection""]);\n    opts.EnableSensitiveDataLogging(true);\n});\nbuilder.Services.AddSingleton<Advanced.Services.ToggleService>();\nbuilder.Services.AddDbContext<IdentityContext>(opts =>\n    opts.UseSqlServer(builder.Configuration[\n        ""ConnectionStrings:IdentityConnection""]));\nbuilder.Services.AddIdentity<IdentityUser, IdentityRole>()\n    .AddEntityFrameworkStores<IdentityContext>();\nbuilder.Services.Configure<IdentityOptions>(opts => {\n    opts.Password.RequiredLength = 6;\n    opts.Password.RequireNonAlphanumeric = false;\n    opts.Password.RequireLowercase = false;\n    opts.Password.RequireUppercase = false;\n    opts.Password.RequireDigit = false;\n    opts.User.RequireUniqueEmail = true;\n    opts.User.AllowedUserNameCharacters = ""abcdefghijklmnopqrstuvwxyz"";\n});\nbuilder.Services.AddAuthentication(opts => {\n    opts.DefaultScheme =\n        CookieAuthenticationDefaults.AuthenticationScheme;\n    opts.DefaultChallengeScheme =\n         CookieAuthenticationDefaults.AuthenticationScheme;\n}).AddCookie(opts => {\n    opts.Events.DisableRedirectForPath(e => e.OnRedirectToLogin,\n         ""/api"", StatusCodes.Status401Unauthorized);\n    opts.Events.DisableRedirectForPath(e => e.OnRedirectToAccessDenied,\n 1207 Authenticating and authorizing web services\n        ""/api"", StatusCodes.Status403Forbidden);\n}).AddJwtBearer(opts => {\n    opts.RequireHttpsMetadata = false;\n    opts.SaveToken = true;\n    opts.TokenValidationParameters = new TokenValidationParameters {\n        ValidateIssuerSigningKey = true,\n        IssuerSigningKey = new SymmetricSecurityKey(\n            Encoding.ASCII.GetBytes(builder.Configuration[""jwtSecret""]!)),\n        ValidateAudience = false,\n        ValidateIssuer = false\n    };\n    opts.Events = new JwtBearerEvents {\n        OnTokenValidated = async ctx => {\n            var usrmgr = ctx.HttpContext.RequestServices\n                .GetRequiredService<UserManager<IdentityUser>>();\n            var signinmgr = ctx.HttpContext.RequestServices\n                .GetRequiredService<SignInManager<IdentityUser>>();\n            string? username =\n                ctx.Principal?.FindFirst(ClaimTypes.Name)?.Value;\n            if (username != null) {\n                IdentityUser? idUser = \n                    await usrmgr.FindByNameAsync(username);\n                if (idUser != null) {\n                    ctx.Principal =\n                        await signinmgr.CreateUserPrincipalAsync(idUser);\n                }\n            }\n        }\n    };\n});\nvar app = builder.Build();\napp.UseStaticFiles();\napp.UseAuthentication();\napp.UseAuthorization();\napp.MapControllers();\napp.MapControllerRoute(""controllers"",\n    ""controllers/{controller=Home}/{action=Index}/{id?}"");\napp.MapRazorPages();\napp.MapBlazorHub();\napp.MapFallbackToPage(""/_Host"");\napp.UseBlazorFrameworkFiles(""/webassembly"");\napp.MapFallbackToFile(""/webassembly/{*path:nonfile}"",\n    ""/webassembly/index.html"");\nvar context = app.Services.CreateScope().ServiceProvider\n    .GetRequiredService<DataContext>();\nSeedData.SeedDatabase(context);\nIdentitySeedData.CreateAdminAccount(app.Services, app.Configuration);\napp.Run();",4073
486-39.5.7 Restricting access with tokens.pdf,486-39.5.7 Restricting access with tokens,,0
487-39.5.8 Using tokens to request data.pdf,487-39.5.8 Using tokens to request data,"1208 chapter  39 Applying ASP.NET Core Identity \nThe AddJwtBearer  adds support for JWT to the authentication system and provides \nthe settings required to decrypt tokens. I have added a handler for the OnToken-\nValidated  event, which is triggered when a token is validated so that I can query the \nuser database and associate the IdentityUser  object with the request. This acts as a \nbridge between the JWT tokens and the ASP.NET Core Identity data, ensuring that \nfeatures like role-based authorization work seamlessly.\n39.5.7  Restricting access with tokens \nTo allow a restricted endpoint to be accessed with tokens, I have modified the Authorize  \nattribute applied to the Data  controller, as shown in listing 39.29.  \nListing 39.29    Enabling tokens in the DataController.cs file in the Controllers folder of \nthe Advanced project \nusing Advanced.Models;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Authorization;\nnamespace Advanced.Controllers {\n    [ApiController]\n    [Route(""/api/people"")]\n    [Authorize(AuthenticationSchemes = ""Identity.Application, Bearer"")]\n    public class DataController : ControllerBase {\n        private DataContext context;\n        // ...methods omitted for brevity...\n    }\n}\nThe AuthenticationSchemes  argument is used to specify the types of authentication \nthat can be used to authorize access to the controller. In this case, I have specified that \nthe default cookie authentication and the new bearer tokens can be used.\n39.5.8  Using tokens to request data \nThe final step is to update the JavaScript client so that it obtains a token and includes it \nin requests for data, as shown in listing 39.30.\nListing 39.30    Using tokens in the webclient.js file in the wwwroot folder of the \nAdvanced project \nconst username = ""bob"";\nconst password = ""secret"";\nlet token;\nwindow.addEventListener(""DOMContentLoaded"", () => {\n    const controlDiv = document.getElementById(""controls"");\n    createButton(controlDiv, ""Get Data"", getData);\n    createButton(controlDiv, ""Log In"", login);\n 1209 Authenticating and authorizing web services\n    createButton(controlDiv, ""Log Out"", logout);\n});\nasync function login() {\n    let response = await fetch(""/api/account/token"", {\n        method: ""POST"",\n        headers: { ""Content-Type"": ""application/json"" },\n        body: JSON.stringify({ username: username, password: password })\n    });\n    if (response.ok) {\n        token = (await response.json()).token;\n        displayData(""Logged in"", token);\n    } else {\n        displayData(`Error: ${response.status}: ${response.statusText}`);\n    }\n}\nasync function logout() {\n    token = """";\n    displayData(""Logged out"");\n}\nasync function getData() {\n    let response = await fetch(""/api/people"", {\n        headers: { ""Authorization"": 'Bearer ${token}' }\n    });\n    if (response.ok) {\n        let jsonData = await response.json();\n        displayData(...jsonData.map(item => \n            `${item.surname}, ${item.firstname}`));\n    } else {\n        displayData(`Error: ${response.status}: ${response.statusText}`);\n    }\n}\nfunction displayData(...items) {\n    const dataDiv = document.getElementById(""data"");\n    dataDiv.innerHTML = """";\n    items.forEach(item => {\n        const itemDiv = document.createElement(""div"");\n        itemDiv.innerText = item;\n        itemDiv.style.wordWrap = ""break-word"";\n        dataDiv.appendChild(itemDiv);\n    })\n}\nfunction createButton(parent, label, handler) {\n    const button = document.createElement(""button"");\n    button.classList.add(""btn"", ""btn-primary"",  ""m-2"");\n    button.innerText = label;\n    button.onclick = handler;\n    parent.appendChild(button);\n}\n1210 chapter  39 Applying ASP.NET Core Identity \nThe client receives the authentication response and assigns the token so it can be used \nby the GetData  method, which sets the Authorization  header. Notice that no logout \nrequest is required, and the variable used to store the token is simply reset when the \nuser clicks the Log Out button.\nCAUTION    It is easy to end up authenticating with a cookie when attempting to \ntest tokens. Make sure you clear your browser cookies before testing this feature \nto ensure that cookies from previous tests are not used.\nRestart ASP.NET Core and request http://localhost:5000/webclient.html. Click the \nLog In button, and a token will be generated and displayed. Click the Get Data button, \nand the token will be sent to the server and used to authenticate the user, producing \nthe results shown in figure 39.13.\nFigure 39.13    Using a token for authentication \nSummary\n¡ User credentials are validated using the SignInManager  service and successful \nauthentications usually generate a cookie that will be included in subsequent \nrequests. \n¡ Identity supports alternatives to cookies, including bearer tokens for use with \nweb services and JavaScript clients.\n¡ Access controls are applied to ensure that only authorized users can request \nrestricted actions, pages, or components. Authorization policies are specified \nusing attributes.",5170
488-index.pdf,488-index,"1211index\nA\nAction methods  500\nAction Results  514\n redirection  514\n sending files  514\n status codes  514\nActivatorUtilities class\n resolving services  362\nAngular  3\nappsettings.Development.json File  388\nappsettings.json File  387\nArrays\n model binding  816\nASP.NET Core\n application frameworks  3\n Blazor  4\n MVC framework  3\n Razor Pages  4\n architecture  1\n gRPC  5\n platform  5\n SignalR  5\n utility frameworks\n ASP.NET Core Identity  5\n Entity Framework Core  5\nASP.NET Core Identity  5\n access denied endpoint  1184\n application configuration  1147 authentication  1174\n authentication cookie  1177\n authentication middleware  1180\n authentication vs authorization  1175\n authN  1175\n authorization  1183\n Authorize attribute  1183\n endpoints  1183\n web services  1194\n authorization middleware  1184\n Authorize attribute  1198\n AuthenticationSchemes argument  1208\n Roles argument  1183\n authZ  1175\n Blazor applications  1188\n changing passwords  1161\n ClaimsPrincipal class  1181\n creating\n roles  1167\n users  1152\n database\n configuration\n migration  1148\n reset  1148\n deleting\n roles  1165\n users  1162\n disabling redirection  1196\n1212\nindex\n editing\n roles  1168\n users  1160\n Entity Framework Core  1148\n enumerating\n roles  1165\n users  1151, 1157\n IdentityResult class  1154\n IdentityRole class  1164\n Identity Server  1188\n IdentityUser class  1149\n importance of HTTPS  1177\n logging in  1175\n logging out  1175, 1178\n management tools  1149\n OAuth  1188\n options pattern  1157\n package, adding  1145\n PasswordOptions class  1157\n password validation  1155\n redirection URLs  1188\n RoleManager<T> class  1164\n role membership  1168\n scaffolding  1149\n seed data  1185\n service configuration  1147\n SignInManager<T> class  1176\n two-factor authentication  1182\n UserManager<T> class  1149, 1164\n UserOptions class  1159\n validating user details  1158\n web services  1194\n bearer tokens  1202\n cookie authentication  1199\n JSON Web Token  1202\nB\nBlazor  4, 977\n advantages  978\n application errors\n element ID  1035\n error boundaries  1036\n architecture  977\n attributes\n parameters  992\n attribute splatting  1010\n authorization  1188\n AuthorizeRouteView component  1190\n AuthorizeView component  1192\n bindings  983, 994\n configuring  996 DateTime bindings  997\n defining  996\n Blazor Server  4\n Blazor WebAssembly  4\n cascading parameters  1028\n client-side code  979\n component\n applying  983\n attributes  1008\n bulk attributes  1009\n cascading parameters  1028\n child content  1017\n @ChildContent expression  1017\n code section  982\n combining  1006\n configuration  1008\n content section  982\n creating  981\n custom bindings  1012, 1015\n custom events  1012\n generic templates  1022\n @key expression  1018\n restricting element reuse  1018\n templates  1019\n components\n code-only components  1002\n custom form components  1088\n DataAnnotationsValidator component  1092\n element references  1073\n forms  1085\n InvokeAsync method  1066\n invoking from other code  1065\n JavaScript  1070\n DotNetObjectReference class  1078\n InvokeAsync method  1072\n InvokeVoidAsync method  1072\n LayoutView component  1056\n partial classes  1000\n StateHasChanged method  1066\n ValidationMessage component  1092\n ValidationSummary component  1092\n component tag helper  983\n connection errors  1031\n element classes  1032\n element ID  1032\n testing with Fiddler  1033\n data validation\n components  1092\n element classes  1092\n disadvantages  978\n EditForm component  1085\n 1213\nindex\n enabling  979\n Entity Framework Core\n dependency injection scopes  1098\n repeated queries  1103\n errors  1031\n events\n attributes  986\n default actions  992\n event types  986\n handler methods names  989\n handler parameters  988\n inline expressions  991\n parameters  992\n propagation  992\n form features  1085\n forms\n EditContext features  1115\nforms\n CRUD operations  1109\n HTTP connection  977\n hub 979\n imports file, creating  980\n InputCheckbox component  1085\n InputDate component  1085\n InputNumber component  1085\n InputTextArea component  1085\n InputText component  1085\n JavaScript file  979\n @layout expression  1056\n layouts  1056\n lifecycle  1057\n methods  1057\n Parameter attribute  1008, 1009\n @ref expression  1062\n rendering modes  983\n retaining references\n @ref expression  1062\n routing  1044\n configuring fallback  1046\n default route  1049\n layouts  1055, 1056\n MapFallbackToPage method  1047\n navigation  1050\n NavigationManager service  1051\n NavLink component  1050, 1055\n @page directive  1047\n receiving route data  1053\n Router component  1044\n RouteView component  1044\n WebAssembly\n base element  1129\n base URL  1129 components  1131\n CSS styles  1137\n HttpClient service  1134\n layout  1136\n navigation URLs  1133\n placeholder components  1130\n setup  1126, 1128\n shared code  1126\nBlazor Server  977\nBlazor WebAssembly  1126\nBootstrap CSS framework  967\nC\nC#\n anonymous types  107\n asynchronous methods  111\n asynchronous enumerable  114\n async keyword  112\n await keyword  112\n tasks  111\n collection initializers  90\n extension methods  95\n interfaces  97\n global using statements  79\n implicit usings  79\n index initializers  92\n interfaces\n default implementations  109\n extension methods  97\n lambda expressions  100\n expression forms  105\n functions  102\n methods  105\n properties  105\n nameof expressions  117\n null state analysis  82\n object initializers  90\n pattern matching  94\n switch statements  94\n Program.cs file  79\n top-level statements  79\n type inference\n var keyword  107\n var keyword  107\nCaching  452\nCircular references  534\nClient-Side packages  411\nCollections\n model binding  820\nCommands\ndotenet list package  68\n1214\nindex\n dotnet add package  68, 292\n dotnet ef  469, 485, 963\n dotnet ef command  69\n dotnet ef database  473\n dotnet ef migrations  473, 489, 967\n dotnet new  59, 65\n dotnet new globaljson  61\n dotnet new sln  61\n dotnet new web  61\n dotnet remove package  69\n dotnet run  66\n dotnet sln  61\n dotnet sql cache create  458\n dotnet test  128\n Invoke-RestMethod  498\n libman  69\n libman init  70\n libman install  70\n sqlcmd  458\nConfiguration  387\n appsettings.json File  387\n ASPNETCORE_ENVIRONMENT  393\n command-line arguments  475\n determining the environment  397\n environment-specific configuration  388, 392\n IConfiguration interface  388\n IsDevelopment method  397\n IsProduction method  397\n IsStaging method  397\n launch.json File  393\n launchSettings.json File  392\n listing secrets  399\n User Secrets  398\n reading secrets  399\n storing secrets  398\n using in middleware components  388\nContainers, creating  274\nContent Delivery Networks  741\nContent Negotiation  542\nControllers  498\nCookies  420\n CookieOptions class  421\n IsEssential property  424\n ITrackingConsentFeature interface  424\n sessions  426\n tracking cookies  422\n requiring consent  423\n UseCookiePolicy method  424\nCross-origin requests\n enabling  510D\nData Validation\n attributes  519\n Range  520\n Required  520\n ModelState property  520\nDebugging  71\nDependency Injection  289, 357\n ActivatorUtilities class  362\n CreateInstance method  363\n GetServiceOrCreateInstance method  363\n AddScoped method  365, 370\n AddSingleton method  358, 365\n AddTransient method  365\n controllers  504\n CreateScope method  370\n dependency chains  374\n Entity Framework Core scopes  1098\n exceptions  371\n factory functions  377\n filters  891, 915\n FromServices attribute  505\n GetRequiredService method  361\n GetService method  361\n HttpContext object  369\n RequestServices property  371\n IServiceProvider interface\n extension methods  361\n middleware\n constructor parameter  359\n middleware\n HttpContext object  360\n options pattern  306, 390\n root scope exceptions  371\n singleton services  364\n transient services  365\n service lifecycles  364, 365\n AddTransient method  365\n methods  365\n scoped services  369\n service location  352, 353\n services in Program.cs file  376\n services with multiple implementations  379\nsingleton pattern  354\n tight coupling  352\n type brokers  355\n unbound types  381\n whether to use  352\nDesign patterns  4\nDictionaries\n model binding  820\nDocker  274\n 1215\nindex\nE\nEndpoints\n controllers  23\nEntity Framework Core  5\n AddDbContext<T> method  471, 488, 966\n applying programmatically  474\n SaveChangesAsync method  476\n SaveChanges method  474\n ASP.NET Core Identity  1148\n changing primary keys  938\n Column attribute  487\n connection strings  472, 489, 967\n multiple active result sets  472\n context class  471, 487, 964\n creating related data  948\n creating services  471, 488, 966\n data model classes  470, 485\n global tools\n installing  469\n LINQ queries  476\n translation to SQL  477\n logging sensitive data  478\n migrations\n applying  473\n creating  473, 489, 967\n NuGet packages, installing  470, 485, 963\n Related data  533\n circular references  534\n Include method  534\n projecting new objects  535\n related data properties, resetting  934\n seeding data  473, 487, 965\n SQL types  487\n Column attribute  487\n storing data\n migrations\nErrata, reporting  7\nError boundaries  1036\nExceptions\n developer exception page  441\n HTML error responses  443\n status code responses  444\nF\nFiles\n sending using action results  514\nFilters  880\n action filters  885, 894\n context objects  895\n attributes  886 authorization filters  885, 887\n dependency injection  891, 915\n exception filters  885, 908\n context objects  909\n execution order  885\n filter attributes  886\n FilterContext class  887\n filter factories  913\n filter interfaces  886\n global filters  916\n IActionFilter interface  894\n IAlwaysRunResultFilter interface  903\n IAsyncActionFilter interface  894\n IAsyncAlwaysRunResultFilter interface  903\n IAsyncAuthorizationFilter interface  887\n IAsyncExceptionFilter interface  908\n IAsyncPageFilter interface  899\n IAsyncResourceFilter interface  890\n IAsyncResultFilter interface  903\n IAuthorizationFilter interface  887\n IExceptionFilter interface  908\n IFilterFactory interface  913\n interfaces  886\n IOrderedFilter interface  918\n IPageFilter interface  899\n IResourceFilter interface  890\n IResultFilter interface  903\n lifecycle  911\n reusing filters  913\n using scopes  915\n ordering  918\n page filters  885, 899\n context objects  899\n RequireHttps  882\n resource filters  885, 890\n context classes  890\n result filters  885, 903\n always-run filters  905\n context objects  904\n reusing filters  913\n ServiceFilter attribute  916\n short-circuiting  886\n types of filter  885\n using  882\nForms  928\n Blazor form features  1085\n button elements\n asp-action attribute  766\n asp-controller attribute  766\n asp-page attribute  766\n creating data  933, 945\n1216\nindex\n creating related data  948\n separate request  953\n single request  948\n CSRF protection  787\n AutoValidateAntiForgeryToken attribute  789\n controllers  789\n IgnoreAntiForgeryToken attribute  790\n JavaScript clients  790\n configuring  791\n Razor Pages  790\n security token  788\n ValidateAntiForgeryToken attribute  790\n deleting data  939, 947\n editing data  936, 946\n form elements\n asp-action attribute  764\n asp-* attributes  764\n asp-controller attribute  764\n asp-page attribute  765\n target  764\n input elements\n asp-for attribute  767\n Column attribute  772\n DisplayFormat attribute  773\n formatting values  771\n id attribute  768\n name attribute  768\n related data  775\n type attribute  769\n value attribute  768\n label elements\n asp-for attribute  779\n for attribute  779\n Post/Redirect/Get pattern  759\n #pragma warning  777\n primary keys, invariant  938\n reading data  931, 945\n resetting related data  934\n select elements\n asp-for attribute  781\n asp-items attribute  781, 783\n SelectList class  783\n SelectListItem class  783\n tag helpers  759\n form elements  764\n textarea elements\n asp-for attribute  785\nG\nGeneral Data Protection Regulation  422\nGlobbing selectors  735GraphQL  495\ngRPC  5, 495\nH\nHost header\n request filtering  446\nHTML Forms  759\nHTML, Safe Encoding  626\nHttpContext class\n useful members  294\nHttpRequest class\n useful members  294\nHttpResponse class\n useful members  295\nHTTPS  431\n configuring  431\n detecting HTTPS requests  433\n development certificates  432, 878\n enabling  431\n HTTP Strict Transport Security  435\n redirection from HTTP  434\n configuration  434\n SSL 431\n TLS 431\nHTTP status codes  444\nJ\njQuery\n client-side validation packages  866\ninstalling package  729\nJSON\n JsonIgnore attribute  524\n JsonIgnoreCondition enum  524\n serializer configuration  524\n web services  495\nJSON.NET Serializer  537\nJSON Patch  536\nL\nLibrary Manager  411\nLists\n model binding  820\nLocalDB  15, 17\nLogging  401\n ILogger<T> interface\n extension methods  403\n LoggerMessage attribute  405\n logging providers  401\n console provider  401\n Debug provider  401\n 1217\nindex\n EventSource provider  401\n list 401\n log levels  403, 407\n SQL queries  477\nM\nMiddleware\n branching  302\n built-in middleware  289\n context objects  294\n cookies  420\n creating  293\n using classes  297\n exception handling  441\n Host header filtering  447\n HTTPS  431\n Map method  302\n Map When method  303\n next function  296\n request pipeline  288\n response caching  461\n response compression\n UseResponseCompression method  463\n return path  299\n Run middleware  305\n sessions  426\n short-circuiting  300\n static files  412\n terminal middleware  304\n URL routing  316\n Use method  294\n UseMiddleware method  298\nMinimal API  497\nModel Binding  506\n arrays  816\n specifying indices  818\n BindNever attribute  808\n BindProperties attribute  808\n BindProperty attribute  807\n GET requests  808\n collections  816\n arrays  816\n collections of complex types  822\n dictionaries  820\n key/value pairs  820\n lists 820\n sequences  820\n sets 820\n simple collections  820\n complex types  805\n binding to a property  807 nested types  809\n property binding  807\n selectively binding properties  813, 815\n default values  802\n nullable parameters  804\n FromBody attribute  507, 824, 829\n FromForm attribute  824\n FromHeader attribute  824, 827\n FromQuery attribute  824\n FromRoute attribute  824\n FromService attribute  825\n manual binding  830\n TryUpdateModelAsync method  831\n nested types  809\n over binding  512\n Razor Pages  800\n search locations  798\n selecting a source  824\n simple types  799\n default values  802\n source, selecting  824\n TryUpdateModelAsync method  831\n understanding  797\nModel expression\n null conditional operator  777\nModel Validation\n AddModelError method  838\n client-side validation\n extending  869\n JavaScript packages  866\n explicit validation  838\n GetValidationState method  838\n IsValid property  838\n metadata validation  857\n mismatched model types  935\n model state dictionary  838\n new view model objects  935\n Razor Pages  854\n remote validation  869\n understanding  837\n validating checkboxes  860\n validation attributes  857\n Compare attribute  858\n custom attributes  861\n Range attribute  858\n RegularExpression attribute  858\n Required attribute  858\n StringLength attribute  858\n validation messages  839\n attributes  839\n configuring  847\n element highlighting  840\n1218\nindex\n model-level messages  851\n property-level messages  850\n tag helper  841\n ValidationSummary values  842\n validation states  844\n web services controllers  860\nModel-View-Controller Pattern  499\nMVC Framework\n action results  514\n actions  500\n ControllerBase class  501\n controllers\n defining  501\n ModelState property  520\n Controllers  498\n enabling  499\n MVC pattern  499\n NonController attribute  501\n pattern  3\n Razor  561\n separation of concerns  3\n Views  561\nN\n.NET SDK\n installing  16, 17\n versions\n Listing  16, 17\nNuGet  292\nO\nOpenAPI  553\nOptions pattern  306, 390\nP\nPages\n model expressions  712\nPATCH method  536\nPlatform\n client-side packages  411\n configuration  387\n Cookies  420\n distributed cache  427\n exceptions  441\n Host header  446\n HTTPS”  431\n Logging  401\n middleware  288\n options pattern  306, 390\n request features  424 request pipeline  288\n branching  302\n return path  299\n services  289\n sessions  426\n static content  411\n understanding  288\nProject\n appsettings.json File  387\n launch.json File  393\n launchSettings.json File  392\n request pipeline\n short-circuiting  300\nProjects\n adding items  63\n adding packages  292\n appsettings files  290\n building projects  64\n client-side packages  69\n compiling projects  64\n creating\n dotnet new command  20\n creating projects  61\n csproj project file  290, 292\n debugging  71\n Empty template  289\n global.json file  290\n launchSettings.json file  290\n LibMan  69\n managing packages\n client-side packages  69\n tool packages  69\nmanaging packages  68\n opening  20, 21, 62\n scaffolding  64\n templates  60\n limitations  60\n tool packages  69\nR\nRazor  5, 25\nRazor Component  981\nRazor Pages  4\n action results\n Page method, implied  647\n redirections  650\n actions results  647\n code-behind classes  644\n common base classes  944\n configuration  633\n creating  634\n 1219\nindex\n dependency injection  660\n generated class  637\n HTTP methods  651\n @inject directive  660\n layouts  656\n model Validation  854\n multiple handler methods  942\n @page directive  641\n page model  636, 644\n base class  644\n code-behind class  644\n generating URLs  734\n handler parameter/variable  653\n multiple handler methods  653\n multiple HTTP methods  651\n properties  644\n Url property  734\n page view  637\n partial views  658\n search path  658\n sharing with MVC Framework  658\n registering tag helpers  698\n routing  639\n conventions  642\n default URL  640\n defining a route  641\n routing convention  636\n runtime compilation  633\n view components, using  670\nReact  3\nRedis  456\nRepository pattern\n using  148\nResponse compressions  463\nRESTFul web services  494\nRouting  5, 25, 315, 316\n ambiguous routes\n avoiding  342\n ordering  343\n applying middleware  316\n areas  329\n convention routing  565, 568\n defining endpoints  317\n Map methods  317\n endpoints\n RequestDelegate  317\n endpoint selection  345\n GetEndpoint method  346\n fallback routes  340\n generating URLs  326\n LinkGenerator class  328\n HttpContext.RouteValues property  322 IEndpointRouteBuilder methods  317\n MapControllerRoute method  565\n MapDefaultControllerRoute method  567\n Razor Pages  636\n route selection  324\n URL patterns  321\n catch-all segments  334\n complex patterns  330\n constraints  336\n combining  338\n custom  341\n default values  331\n optional segments  333\n regular expressions  339\n RouteValuesDictionary class  322\n segments  321\n segment variables  322\n WithMetadata method  327\nS\nScaffolding  64\nServices\n AddDistributedSqlServerCache\nAddDistributedMemoryCache method  456\n application lifetime service  475\n caching  452\nAddDistributedMemoryCache method  456\nAddStackExchangeRedisCahce method  456\n database preparation  458\n data cache  454\n DistributedCacheEntryOptions class  455\n distributed caching  458\n IDistributedCache implementations  456\n IDistributedCache interface  455\n memory cache options  457\n NuGet package  459\n persistent caching  458\n SQL Server cache options  460\n response caching  461\n AddResponseCaching method  462\n Cache-Control header  463\n UseResponseCaching method  462\n Vary header  463\nSessions  426\n configuration  427\n data cache  427\n AddDistributedMemoryCache method  427\n ISession interface  429\n session data  429\n committing changes  430\nSignalR  5\n1220\nindex\nSingle Page Applications\n Angular  3\n React  3\nSingleton pattern  354\nSolutions  61\nSource maps  737\nSportsStore  139\n administration  238\n Blazor Server  240\n cart 194, 212\n checkout  224\n client-side packages  169\n connection strings  146\n creating projects  139\n data model  144\n deployment  274\n Entity Framework Core  146\n filtering categories  176\n migrations  151\n navigation menu  184\n page counts, fixing  191\n pagination  157\n repository pattern  148\n security  261\n sessions  199, 212\n tag helpers  160\n Unit Testing  139\n validation  234\nSQL Server\n LocalDB  15, 17\nStartup Class\n enabling MVC  499\nStatic Content  411\n Library Manager  415\n initializing project  415\n installing  415\n installing packages  967\n middleware  412\n configuration options  413\n wwwroot folder  411\nStatus code responses  444\nT\nTag Helper Components  721\nTag Helpers\n anchor elements  731\n Razor Pages  733\n attributes\n HtmlAttributeName attribute  697\n naming convention  696\n Blazor  983 built-in helpers\n enabling  731\n Cache busting  740\n caching content  748\n cache expiry  750\n distributed caching  750\n variations  752\n context data  696, 710\n TagHelperContext class  696\n ViewContext attribute  711\n coordination  718\n Items collection  718\n creating  695\n CSS stylesheets  743\n enabling  731\n environment element  753\n forms  759\n globbing  735\n HtmlAttributeNotBound attribute  711\n HtmlTargetElement attribute  700\n properties  700\n images  746\n img elements  746\n JavaScript files  735\n link elements  743\n content delivery networks  745\n model expressions  712\n output  697\n ProcessAsync method  696\n Process method  695\n property naming convention  696\n registering  698\n scope\n increasing  701\n restricting  700\n script elements  735\n cache busting  740\n content delivery networks  741\n selecting  735\n short-hand elements  703\n suppressing output  720\n TagBuilder class  706\n TagHelper base class  695\n tag helper components  721\n creating  721\n expanding selection  723\n TagHelperComponent class  721\n TagHelperComponentTagHelper class  723\n TagHelperContext class\n properties  696\n TagHelperOutput class\n 1221\nindex\n properties  697\n validation messages  841\n view components  669\n ViewContext attribute  711\n _ViewImports.cshtml file  698\nTemp data  604\nType broker pattern  355\nU\nUnit testing\n Assert methods  126\n creating the test project  124\n Fact attribute  126\n isolating components  130\n mocking  135\n Moq package  135\n MSTest  124\n NUnit  124\n project templates  124\n running tests  127, 128\n writing tests  125\n XUnit  124\nUnit Testing  139\nURL Routing  316\nUser Secrets  398\nV\nView Components  667\n applying\n Component.InvokeAsync expression  668\n custom HTML element  669\n Razor Pages  670\n tag helper  669\n vc element  669\n context data  678\n parent view  679\n creating  667\n hybrid classes\n controllers  688\n Razor Pages  685\n ViewComponent attribute  685\n ViewComponentContext attribute  685\n Invoke method  667\n parent views  679\n results  671\n HTML fragments  675\n partial views  672\n ViewComponent attribute  685\n ViewComponent class  667\n context data  678 properties  678\n views  672\n search locations  674\nViews  25\n AddControllersWithViews method  565\n AddRazorRuntimeCompilation method  565\n content encoding\n disable  627\n content-encoding  626\n CSHTML files  569\n directives  587\n @addTagHelper  587\n @attribute  587\n @functions  587\n @implements  587\n @inherits  587\n @inject  587, 660\n @model  587\n @namespace  587\n @page  587\n @section  587, 616\n @using  583, 587\n expressions\n @ 588\n attribute values  590\n @await  588\n code blocks  588\n conditional expressions\n if expressions  591\n select expressions  592\n element content  589\n @foreach  588\n @if 588\n @Model  588\n sequences\n foreach expressions  594\n @switch  588\n @try  588\n generated classes  575\n generating URLs  734\n Url property  734\n HTML content-encoding  626\n IntelliSense support  580\n JSON content-encoding  628\n layouts  607\n configuring  609\n disabling  614\n optional sections  618\n overriding the default layout  612\n RenderSection method  616\n section expressions  616\n1222\nindex\n sections  615\n selecting a layout  608\n selecting programmatically  613\n @model expressions  579\n model expressions  712\n @Model expressions  570\n partial views  622\n partial element  623\n RazorPage<T> class  576\n additional properties  578\n RazorPage<T> properties  576\n Razor syntax  587\n recompilation  570\n registering tag helpers  698\n search path  568\n selecting by name  571\n shared views  573\n temp data  604\n keep method  606\n peek method  606\n TempData attribute  606\n TempData property  605\n templated delegates  625\n view bag  602\n view components  672\n view import file  622\n view imports file\n _ViewImports.cshtml file  581\n view model object  570\n View model type\n @model expressions  578\n view start files  611\nVisual Studio\n installing  14\n LocalDB  15\n workloads  15\nVisual Studio Code\n installing  16\n LocalDB  17\nW\nWeb Pages  3\nWeb services\n authentication  1194\n authorization  1194\nWeb Services  3, 494\n action methods\n results  503 action results  514\n actions\n HTTP method attributes  502\n ApiController attribute  521\n Content Formatting  540\n custom formatters  543\n default policy  540\n JSON formatting  543\n Restricting Formats  549\n XML formatting  543\n Content Negotiation  542\n Accept header  542\n Consumes attribute  549\n Respecting Accept header  545\n Using the URL  548\n controllers  498\n asynchronous actions  511\n attributes  501\n ControllerBase class  501\n creating  500\n dependency injection  504\n FromServices attribute  505\n model binding  506\n services  504\n CORS  510\n data validation  519\n GraphQL  495\n gRPC  495\n HTTP PATCH method  536\n JSON Patch  536\n JSON  495\n JSON Patch  536, 538\n JSON.NET Serializer  537\n JsonPatchDocument<T> class  539\n NuGet package  537\n specification  536\n model validation  860\n null properties  523\n OpenAPI  553\n API Analyzer  557\n conflicts  553\n Nuget Package  554\n ProducesResponseType attribute  559\n Related data  533\n remote model validation  869\n REST  494\n routing  501\n URLs and HTTP Methods  495\n Adam Freeman\nISBN-13: 978-1-63343-782-1\nASP .NET C ore 7 gives you everything you need to cre-\nate awesome web apps in C#. Th is powerful framework \nhandles anything you throw at it, from high-volume \nHTTP  requests and  REST ful web services, to effi   cient \nHTML  and CSS round trips and WebAssembly for rich \nuser interactions.\nPro ASP.NET Core 7  is the industry-leading guide to building \nweb applications with ASP .NET C ore. In it, you’ll build a \nrealistic online store as you learn about web services, authenti-cation and authorization, container deployment, and more. Author Adam Freeman’s comfortable style mentors you through advanced topics like \nREST ful web services, Razor \nPages for HTML  responses, and data access with Entity \nFramework Core. Engaging hands-on examples show you \nhow each tool works in action.  \nWhat’s Inside\n● Th e ASP .NET  Core request pipeline\n● REST ful web services with MVC  controllers\n● Rich interactive applications with Blazor\n● Authenticate requests using ASP .NET  Core Identity\nFor web developers experienced with C# and the basics of \n.NET .\nAdam Freeman  has written over a dozen bestselling books on \nsoftware development. He has held numerous senior IT \npositions, most recently as CTO  and COO  of a global bank.\nTh e technical editor on this book is Fabio Claudio \nFerracchiati.\nFor print book owners, all ebook formats are free:\nhttps:/ /www.manning.com/freebook\nPro ASP.NET Core 7 Tenth EditionDEVELOPMENT\nMANNING“A masterpiece that exceeds \nall expectations. My ultimate \nguide for the world of \nASP .NET C ore.”—Juan Luis Barreda\nSenior Software Developer, \nPearson.com \n“Go from scratch all the \nway into ASP .NET C ore. \n Th e complete guide.”—Ernesto Cardenas Cangahuala, \nMicrosoft MVP and Technical \nArchitect at Interbank  \n“Th is tome has been helping \ndevelopers learn ASP .NET  for \nyears and this edition builds \nupon that success.”—Jeff  rey Smith\nIT Engineering Manager, TJ Maxx\n“A complete tour of the \n  ASP .NET C ore framework.”—David Paccoud\nSolution Architect, Clario\nSee first page",28661
